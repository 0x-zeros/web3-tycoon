全部完成的实现

  📁 新建文件

  1. MapTemplateConverter.ts
  - convertMapTemplateToSaveData(template, game, mapId) - 核心转换函数
  - getTileBlockId(kind) - TileKind → blockId 映射
  - getBuildingBlockId(size, buildingType) - BuildingSize → blockId 映射

  2. IdFormatter.ts（之前已完成）
  - shortenAddress(address) - 地址缩短工具

  🔧 修改的文件

  1. SuiManager.ts（新增 6 个方法）
  - ✅ getMapTemplate(templateId) - 查询链上 MapTemplate
  - ✅ _parseMapTemplateObject(fields) - 解析 MapTemplate 数据
  - ✅ _loadGameScene(gameId) - 加载游戏场景
  - ✅ _addNewGameToCache(gameId) - 优化游戏缓存（替代 _refreshGamesCache）
  - ✅ _onPlayerJoined(event) - 增量更新玩家列表
  - ✅ _onGameStarted(event) - 重构（判断玩家/非玩家分别处理）

  2. GameMap.ts（新增 2 个方法）
  - ✅ loadFromChainData(template, game) - 从链上数据加载场景
  - ✅ _loadMapFromData(mapData) - 从内存数据加载（内部方法）

  3. UIInGame.ts（新增 2 个方法）
  - ✅ _onGameStart(data) - 监听游戏开始事件
  - ✅ _initializeGameState(game, gameData) - 初始化 Blackboard
  - ✅ 添加 Game.GameStart 事件监听和解绑

  4. UIGameDetail.ts
  - ✅ _handleStartGame - 添加成功/失败 MessageBox
  - ✅ _handleJoinGame - 添加成功/失败 MessageBox
  - ✅ 动态按钮逻辑（开始游戏/加入游戏/已满员）
  - ✅ 监听 Move.PlayerJoined 事件自动刷新

  5. UIGameList.ts
  - ✅ selectGameById(gameId) - 根据 ID 选中游戏
  - ✅ _showGameDetail(game) - 触发详情显示
  - ✅ refresh() - 保持选中状态
  - ✅ 监听 Sui.GamesListUpdated 事件

  6. UIMapSelect.ts
  - ✅ showGameDetail(gameId) - 统一详情显示逻辑
  - ✅ _onMoveGameCreated - 使用 eventData.gameObject
  - ✅ 移除子模块的 enabled 切换
  - ✅ 监听 Game.ShowGameDetail 事件

  7. QueryService.ts
  - ✅ parseID() - 解析 ID 类型
  - ✅ parseOption() - 解析 Option 类型
  - ✅ parsePlayers() - 返回 Player[] 类型

  8. game.ts（interactions）
  - ✅ buildJoinGameTx - 修复 PTB 构建错误
  - ✅ parsePlayers() - 返回 Player[] 类型
  - ✅ 删除所有废弃的 async 方法

  9. EventTypes.ts
  - ✅ 添加 Game.ShowGameDetail 事件
  - ✅ 确认 Move.PlayerJoined 事件已存在

  完整的数据流

  ┌─────────────────────────────────────────────────────────────┐
  │                    创建游戏流程                              │
  └─────────────────────────────────────────────────────────────┘
  玩家点击"创建游戏"
    ↓
  SuiManager.createGame()
    ↓
  链上 GameCreatedEvent
    ↓
  SuiManager._addNewGameToCache() (只查询 1 个)
    ├→ 设置 _currentGame (创建者)
    └→ emit Move.GameCreated { gameObject }
        ↓
        UIMapSelect.showGameDetail()
          ├→ data 可见 + controller=0
          └→ GameDetail 显示

  ┌─────────────────────────────────────────────────────────────┐
  │                    加入游戏流程                              │
  └─────────────────────────────────────────────────────────────┘
  玩家点击"加入游戏"
    ↓
  SuiManager.joinGame()
    ↓
  链上 PlayerJoinedEvent
    ↓
  SuiManager._onPlayerJoined() (增量更新)
    ├→ 创建新 Player 添加到 game.players
    ├→ 更新 _currentGame
    └→ emit Sui.GamesListUpdated + Move.PlayerJoined
        ↓
        ├→ UIGameList.refresh() (保持选中)
        └→ UIGameDetail.showGame() (更新按钮状态)

  ┌─────────────────────────────────────────────────────────────┐
  │                    开始游戏流程                              │
  └─────────────────────────────────────────────────────────────┘
  玩家点击"开始游戏"
    ↓
  SuiManager.startGame()
    ↓
  链上 GameStartedEvent
    ↓
  SuiManager._onGameStarted()
    ├→ 是玩家？
    │   ✓ Yes → _loadGameScene()
    │             ├→ 查询 Game + MapTemplate + GameData
    │             ├→ 设置 _currentGame
    │             └→ emit Game.GameStart { game, template, gameData }
    │                   ↓
    │                   UIInGame._onGameStart()
    │                     ├→ show UIInGame
    │                     ├→ hide UIMapSelect
    │                     ├→ GameMap.loadFromChainData()
    │                     │     ↓
    │                     │     MapTemplateConverter.convert()
    │                     │     ↓
    │                     │     GameMap._loadMapFromData()
    │                     │     ↓
    │                     │     渲染 3D 场景
    │                     └→ 初始化 Blackboard
    │
    └─→ 不是玩家？
        ✓ Yes → 更新 status
                移出 READY 列表

  关键优化点

  1. ✅ GameCreated：从查询 50 个游戏 → 只查询 1 个新游戏
  2. ✅ PlayerJoined：增量更新，不重新查询完整 Game
  3. ✅ GameStarted：区分玩家/观察者，玩家才加载场景
  4. ✅ 场景加载：复用现有 GameMap 逻辑，通过数据转换实现
  5. ✅ UI 响应式：所有列表和详情都实时更新

  可以测试了！

  现在完整的"创建游戏 → 加入游戏 → 开始游戏 → 加载场景"流程已全部实现，可以在客户端测试了



 完整的生命周期管理：
  - ✅ 卸载旧场景
  - ✅ 创建新实例
  - ✅ 初始化组件
  - ✅ 加载数据
  - ✅ 添加到场景树
  - ✅ 更新状态


  | 步骤    | 编辑地图                    | 开始游戏（修复后）                         |
  |-------|-------------------------|-----------------------------------|
  | 卸载旧场景 | ✅ unloadCurrentMap()    | ✅ unloadCurrentMap()              |
  | 创建节点  | ✅ new Node()            | ✅ new Node()                      |
  | 添加组件  | ✅ addComponent(GameMap) | ✅ addComponent(GameMap)           |
  | 初始化   | ✅ init(config, true)    | ✅ init(tempConfig, false)         |
  | 加载数据  | loadMap(mapId)          | loadFromChainData(template, game) |
  | 添加到场景 | ✅ container.addChild()  | ✅ container.addChild()            |
  | 更新状态  | ✅ _currentMapInstance   | ✅ _currentMapInstance             |