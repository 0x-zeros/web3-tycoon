System.register("chunks:///_virtual/Actor.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,o,i,n,r,a,s,l,u,c,m,d,h,f,p,g,b,_,v,y,P;return{setters:[function(e){t=e.applyDecoratedDescriptor,o=e.inheritsLoose,i=e.initializerDefineProperty,n=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose,a=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){l=e.cclegacy,u=e._decorator,c=e.Node,m=e.Animation,d=e.MeshRenderer,h=e.AudioSource,f=e.resources,p=e.Prefab,g=e.tween,b=e.Label,_=e.Vec3,v=e.Component,y=e.instantiate,P=e.ParticleSystem}],execute:function(){var A,C,w,R,M,S,x,k,E,I,T,L,N,B,D;l._RF.push({},"a705adAZV5OD7ELIGCJHJN4","Actor",void 0);var z=u.ccclass,O=u.property;e("Actor",(A=z("Actor"),C=O({displayName:"模型根节点",type:c,tooltip:"用于放置3D模型或2D精灵的根节点"}),w=O({displayName:"特效根节点",type:c,tooltip:"用于播放各种特效的根节点"}),R=O({displayName:"UI根节点",type:c,tooltip:"用于显示血条、名称等UI元素的根节点"}),M=O({displayName:"移动速度",tooltip:"移动动画的基础速度"}),S=O({displayName:"启用阴影",tooltip:"是否启用角色阴影效果"}),x=O({displayName:"启用音效",tooltip:"是否播放角色相关音效"}),A((I=t((E=function(e){function t(){for(var t,o=arguments.length,r=new Array(o),a=0;a<o;a++)r[a]=arguments[a];return t=e.call.apply(e,[this].concat(r))||this,i(t,"modelRoot",I,n(t)),i(t,"effectRoot",T,n(t)),i(t,"uiRoot",L,n(t)),i(t,"moveSpeed",N,n(t)),i(t,"enableShadow",B,n(t)),i(t,"enableAudio",D,n(t)),t.m_animator=null,t.m_meshRenderer=null,t.m_audioSource=null,t.m_nameLabel=null,t.m_role=null,t.m_currentModel=null,t.m_activeEffects=new Map,t.m_moveConfig={type:"smooth",duration:.5,heightOffset:.5,easing:"sineInOut"},t.m_animationConfigs=new Map,t.m_moveTween=null,t.m_isMoving=!1,t.m_buildingPrefab=null,t.m_buildingConfig=null,t}o(t,e);var l=t.prototype;return l.onLoad=function(){this.initializeComponents(),this.setupAnimationConfigs()},l.start=function(){this.updateDisplay()},l.onDestroy=function(){this.cleanup()},l.initializeComponents=function(){this.modelRoot||(this.modelRoot=new c("ModelRoot"),this.modelRoot.parent=this.node),this.effectRoot||(this.effectRoot=new c("EffectRoot"),this.effectRoot.parent=this.node),this.uiRoot||(this.uiRoot=new c("UIRoot"),this.uiRoot.parent=this.node),this.m_animator=this.getComponentInChildren(m),this.m_meshRenderer=this.getComponentInChildren(d),this.m_audioSource=this.getComponent(h),this.enableAudio&&!this.m_audioSource&&(this.m_audioSource=this.node.addComponent(h)),console.log("[Actor] 组件初始化完成")},l.setupAnimationConfigs=function(){this.m_animationConfigs.set("idle",{name:"idle",duration:2,loop:!0,speed:1}),this.m_animationConfigs.set("move",{name:"move",duration:1,loop:!0,speed:1}),this.m_animationConfigs.set("jump",{name:"jump",duration:.5,loop:!1,speed:1}),this.m_animationConfigs.set("celebrate",{name:"celebrate",duration:2,loop:!1,speed:1}),this.m_animationConfigs.set("defeat",{name:"defeat",duration:1.5,loop:!1,speed:1})},l.bindRole=function(e){this.m_role&&this.unbindRole(),this.m_role=e,this.m_role&&(this.m_role.on("state-changed",this.onRoleStateChanged,this),this.m_role.on("attribute-changed",this.onRoleAttributeChanged,this),this.m_role.on("tile-changed",this.onRoleTileChanged,this)),this.loadRoleModel(),this.updateDisplay(),console.log("[Actor] 绑定角色: "+(null==e?void 0:e.getName()))},l.unbindRole=function(){this.m_role&&(this.m_role.off("state-changed",this.onRoleStateChanged,this),this.m_role.off("attribute-changed",this.onRoleAttributeChanged,this),this.m_role.off("tile-changed",this.onRoleTileChanged,this),this.m_role=null),console.log("[Actor] 角色解绑")},l.loadRoleModel=function(){var e=a(s().mark((function e(){var t,o;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.m_role&&this.modelRoot){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,t=this.getModelPath(this.m_role.getTypeId()),e.next=6,this.loadPrefabAsync(t);case 6:(o=e.sent)&&(this.m_currentModel&&this.m_currentModel.isValid&&this.m_currentModel.destroy(),this.m_currentModel=y(o),this.m_currentModel.parent=this.modelRoot,this.m_currentModel.setPosition(_.ZERO),this.m_animator=this.m_currentModel.getComponent(m)||this.m_currentModel.getComponentInChildren(m),this.m_meshRenderer=this.m_currentModel.getComponent(d)||this.m_currentModel.getComponentInChildren(d),this.playAnimation("idle"),console.log("[Actor] 模型加载完成: "+t)),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),console.error("[Actor] 模型加载失败: "+e.t0);case 13:case"end":return e.stop()}}),e,this,[[2,10]])})));return function(){return e.apply(this,arguments)}}(),l.getModelPath=function(e){return"models/role/type_"+e},l.loadPrefabAsync=function(e){return new Promise((function(t){f.load(e,p,(function(o,i){o?(console.error("[Actor] 预制件加载失败: "+e,o),t(null)):t(i)}))}))},l.updatePosition=function(e){this.node.setWorldPosition(e)},l.moveToTile=function(){var e=a(s().mark((function e(t){var o;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.m_isMoving){e.next=3;break}return console.warn("[Actor] 正在移动中，忽略新的移动请求"),e.abrupt("return");case 3:if(this.m_isMoving=!0,e.prev=4,this.playAnimation("move"),!(o=t.targetPosition)){e.next=10;break}return e.next=10,this.executeMove(o,t);case 10:this.playAnimation("idle");case 11:return e.prev=11,this.m_isMoving=!1,e.finish(11);case 14:case"end":return e.stop()}}),e,this,[[4,,11,14]])})));return function(t){return e.apply(this,arguments)}}(),l.executeMove=function(e,t){var o=this;return new Promise((function(i){var n=t.duration||o.m_moveConfig.duration;switch(o.m_moveTween&&o.m_moveTween.stop(),o.m_moveConfig.type){case"teleport":o.node.setWorldPosition(e),i();break;case"bounce":o.executeBounceMove(e,n,i);break;default:o.m_moveTween=g(o.node).to(n,{worldPosition:e},{easing:o.m_moveConfig.easing}).call((function(){return i()})).start()}}))},l.executeBounceMove=function(e,t,o){var i=this.node.worldPosition.clone().clone().add(e).multiplyScalar(.5);i.y+=this.m_moveConfig.heightOffset,this.m_moveTween=g(this.node).to(.5*t,{worldPosition:i}).to(.5*t,{worldPosition:e}).call((function(){return o()})).start()},l.playAnimation=function(e,t){if(this.m_animator){var o=this.m_animator.getState(e);if(o){var i=this.m_animationConfigs.get(e);i&&(o.speed=i.speed,o.wrapMode=(void 0!==t?t:i.loop)?m.WrapMode.Loop:m.WrapMode.Normal),this.m_animator.play(e),console.log("[Actor] 播放动画: "+e)}else console.warn("[Actor] 动画不存在: "+e)}else console.warn("[Actor] 动画组件不存在，无法播放动画: "+e)},l.stopAnimation=function(e){this.m_animator&&(e?this.m_animator.stop(e):this.m_animator.stop())},l.addAnimationConfig=function(e,t){this.m_animationConfigs.set(e,t)},l.playEffect=function(){var e=a(s().mark((function e(t,o){var i,n,r,a,l,u=this;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.effectRoot){e.next=3;break}return console.warn("[Actor] 特效根节点不存在"),e.abrupt("return");case 3:return e.prev=3,i="effects/"+t,e.next=7,this.loadPrefabAsync(i);case 7:(n=e.sent)&&((r=y(n)).parent=this.effectRoot,this.m_activeEffects.set(t,r),(a=r.getComponent(P))&&a.play(),l=o||2,this.scheduleOnce((function(){u.stopEffect(t)}),l),console.log("[Actor] 播放特效: "+t)),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(3),console.error("[Actor] 特效播放失败: "+t,e.t0);case 14:case"end":return e.stop()}}),e,this,[[3,11]])})));return function(t,o){return e.apply(this,arguments)}}(),l.stopEffect=function(e){var t=this.m_activeEffects.get(e);t&&t.isValid&&(t.destroy(),this.m_activeEffects.delete(e),console.log("[Actor] 停止特效: "+e))},l.stopAllEffects=function(){for(var e,t=r(this.m_activeEffects);!(e=t()).done;){var o=e.value,i=(o[0],o[1]);i&&i.isValid&&i.destroy()}this.m_activeEffects.clear(),console.log("[Actor] 停止所有特效")},l.setMaterialColor=function(e){this.m_meshRenderer&&this.m_meshRenderer.material&&this.m_meshRenderer.material.setProperty("albedo",e)},l.setOpacity=function(e){if(this.m_meshRenderer&&this.m_meshRenderer.material){var t=this.m_meshRenderer.material.getProperty("albedo");t.a=Math.max(0,Math.min(1,e)),this.m_meshRenderer.material.setProperty("albedo",t)}},l.playAudio=function(e){var t=this;if(this.enableAudio&&this.m_audioSource){var o="audio/"+e;f.load(o,(function(e,i){e?console.error("[Actor] 音频加载失败: "+o,e):(t.m_audioSource.clip=i,t.m_audioSource.play())}))}},l.updateDisplay=function(){this.m_role&&(this.updateNameDisplay(),this.updateUIElements())},l.updateNameDisplay=function(){if(this.uiRoot&&this.m_role){if(!this.m_nameLabel){var e=new c("NameLabel");e.parent=this.uiRoot,e.setPosition(0,2,0),this.m_nameLabel=e.addComponent(b)}this.m_nameLabel.string=this.m_role.getName()}},l.updateUIElements=function(){},l.onRoleStateChanged=function(e){var t=e.oldState,o=e.newState;switch(o){case"idle":this.playAnimation("idle");break;case"moving":this.playAnimation("move");break;case"winner":this.playAnimation("celebrate"),this.playEffect("victory",5)}console.log("[Actor] 角色状态变化: "+t+" -> "+o)},l.onRoleAttributeChanged=function(e){var t=e.attribute,o=e.oldValue,i=e.newValue;0===t&&i>o?this.playEffect("money_gain",2):1===t&&i<o&&this.playEffect("damage",1),this.updateDisplay()},l.onRoleTileChanged=function(e){var t=e.oldTileId,o=e.newTileId;console.log("[Actor] 角色位置变化: "+t+" -> "+o)},l.cleanup=function(){this.stopAnimation(),this.m_moveTween&&(this.m_moveTween.stop(),this.m_moveTween=null),this.stopAllEffects(),this.unbindRole(),this.m_currentModel&&this.m_currentModel.isValid&&(this.m_currentModel.destroy(),this.m_currentModel=null),this.m_buildingPrefab&&(this.m_buildingPrefab.destroy(),this.m_buildingPrefab=null),console.log("[Actor] 清理完成")},t.createBuildingActor=function(e){var o=new c("BuildingActor"),i=o.addComponent(t);i.m_buildingConfig=e;var n=e.getActorPosition();return o.setWorldPosition(n),i.loadBuildingPrefab(),console.log("[Actor] Building Actor 创建: buildingId="+e.buildingId+", owner="+e.owner+", originalOwner="+e.originalOwner+", level="+e.level),o},l.loadBuildingPrefab=function(){var e=a(s().mark((function e(){var t,o=this;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.m_buildingConfig){e.next=2;break}return e.abrupt("return");case 2:if(!this.m_buildingConfig.shouldShowPrefab||this.m_buildingConfig.shouldShowPrefab()){e.next=5;break}return this.m_buildingPrefab&&(this.m_buildingPrefab.destroy(),this.m_buildingPrefab=null),e.abrupt("return");case 5:if(t=this.m_buildingConfig.getPrefabPath()){e.next=8;break}return e.abrupt("return");case 8:return e.abrupt("return",new Promise((function(e){f.load(t,p,(function(i,n){if(i)return console.warn("[Actor] Building prefab 加载失败: "+t,i),void e();o.m_buildingPrefab&&o.m_buildingPrefab.destroy(),o.m_buildingPrefab=y(n),o.m_buildingPrefab.parent=o.modelRoot||o.node,o.m_buildingPrefab.name="Prefab",o.m_buildingPrefab.setPosition(0,0,0);var r=o.m_buildingConfig.getLevelScale(),a=o.m_buildingConfig.getLevelColorFactor();o.m_buildingPrefab.setScale(r,r,r),o.applyColorFactor(o.m_buildingPrefab,a),console.log("[Actor] Building prefab 加载完成: "+t+", scale="+r+", colorFactor="+a),e()}))})));case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),l.updateBuildingRender=function(e){var t,o=null==(t=this.m_buildingConfig)?void 0:t.getPrefabPath();this.m_buildingConfig=e;var i=e.getPrefabPath();if(i){if(i!==o)this.loadBuildingPrefab();else if(this.m_buildingPrefab){var n=e.getLevelScale(),r=e.getLevelColorFactor();g(this.m_buildingPrefab).to(.3,{scale:new _(n,n,n)},{easing:"backOut"}).start(),this.applyColorFactor(this.m_buildingPrefab,r),console.log("[Actor] Building render 更新: scale="+n+", colorFactor="+r)}}else this.m_buildingPrefab&&(this.m_buildingPrefab.destroy(),this.m_buildingPrefab=null)},l.applyColorFactor=function(e,t){e.walk((function(e){var o=e.getComponent(d);if(o&&o.material){var i=o.material.getProperty("albedo");i&&(i.r=Math.min(255,Math.floor(i.r*t)),i.g=Math.min(255,Math.floor(i.g*t)),i.b=Math.min(255,Math.floor(i.b*t)),o.material.setProperty("albedo",i))}}))},l.debugInfo=function(){var e;return"[Actor] "+["绑定角色: "+((null==(e=this.m_role)?void 0:e.getName())||"无"),"移动状态: "+(this.m_isMoving?"移动中":"静止"),"活跃特效: "+this.m_activeEffects.size,"动画组件: "+(this.m_animator?"存在":"无"),"音频组件: "+(this.m_audioSource?"存在":"无")].join(", ")},t}(v)).prototype,"modelRoot",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T=t(E.prototype,"effectRoot",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L=t(E.prototype,"uiRoot",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=t(E.prototype,"moveSpeed",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),B=t(E.prototype,"enableShadow",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),D=t(E.prototype,"enableAudio",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k=E))||k));l._RF.pop()}}}));

System.register("chunks:///_virtual/ActorConfig.ts",["cc","./ActorTypes.ts"],(function(e){var i,a;return{setters:[function(e){i=e.cclegacy},function(e){a=e.ActorType}],execute:function(){i._RF.push({},"a1237AjnH5EaK3Q/vnzLPFl","ActorConfig",void 0);var l=[{id:"web3:land_god",type:a.NPC,name:"土地神",textures:{default:"web3/actors/land_god",animations:{idle:["land_god_idle_1","land_god_idle_2"],walk:["land_god_walk_1","land_god_walk_2"]}},size:{width:1,height:1.5,scale:1},animations:{canJump:!0,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:wealth_god",type:a.NPC,name:"财神",textures:{default:"web3/actors/wealth_god",animations:{idle:["wealth_god_idle_1","wealth_god_idle_2"]}},size:{width:1,height:1.5,scale:1},animations:{canJump:!0,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:fortune_god",type:a.NPC,name:"福神",textures:{default:"web3/actors/fortune_god",animations:{idle:["fortune_god_idle_1","fortune_god_idle_2"]}},size:{width:1,height:1.5,scale:1},animations:{canJump:!0,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:dog",type:a.NPC,name:"狗狗",textures:{default:"web3/actors/dog",animations:{idle:["dog_idle_1","dog_idle_2"],walk:["dog_walk_1","dog_walk_2","dog_walk_3","dog_walk_4"]}},size:{width:.8,height:.6,scale:.8},animations:{canJump:!0,canSay:!1,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:poverty_god",type:a.NPC,name:"穷神",textures:{default:"web3/actors/poverty_god",animations:{idle:["poverty_god_idle_1","poverty_god_idle_2"]}},size:{width:1,height:1.5,scale:1},animations:{canJump:!1,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:roadblock",type:a.OBJECT,name:"路障",textures:{default:"web3/actors/roadblock"},size:{width:1,height:.8,scale:1},animations:{canJump:!1,canSay:!1,canMove:!1,canShake:!0},billboardMode:"off"},{id:"web3:bomb",type:a.OBJECT,name:"炸弹",textures:{default:"web3/actors/bomb"},size:{width:.6,height:.6,scale:1},animations:{canJump:!1,canSay:!1,canMove:!1,canShake:!0,canFloat:!0},billboardMode:"yAxis"}],t=[{id:"web3:building_1x1",type:a.BUILDING,name:"小型建筑",textures:{levels:["web3/buildings/lv0","web3/buildings/lv1","web3/buildings/lv2","web3/buildings/lv3","web3/buildings/lv4","web3/buildings/lv5"]},size:{width:1,height:1,scale:1},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:0},{id:"web3:building_2x2",type:a.BUILDING,name:"大型建筑",textures:{levels:["web3/buildings/lv0"]},size:{width:1,height:1,scale:2},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:0},{id:"web3:temple",type:a.BUILDING,name:"土地庙",textures:{levels:["web3/buildings/temple_lv1","web3/buildings/temple_lv2","web3/buildings/temple_lv3","web3/buildings/temple_lv4","web3/buildings/temple_lv5"]},size:{width:1,height:1,scale:2},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:1},{id:"web3:research",type:a.BUILDING,name:"研究所",textures:{levels:["web3/buildings/research_lv1","web3/buildings/research_lv2","web3/buildings/research_lv3","web3/buildings/research_lv4","web3/buildings/research_lv5"]},size:{width:1,height:1,scale:2},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:1},{id:"web3:oil_company",type:a.BUILDING,name:"石油公司",textures:{levels:["web3/buildings/oil_company_lv1","web3/buildings/oil_company_lv2","web3/buildings/oil_company_lv3","web3/buildings/oil_company_lv4","web3/buildings/oil_company_lv5"]},size:{width:1,height:1,scale:2},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:1},{id:"web3:commercial",type:a.BUILDING,name:"商业中心",textures:{levels:["web3/buildings/commercial_lv1","web3/buildings/commercial_lv2","web3/buildings/commercial_lv3","web3/buildings/commercial_lv4","web3/buildings/commercial_lv5"]},size:{width:1,height:1,scale:2},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:1},{id:"web3:hotel",type:a.BUILDING,name:"大饭店",textures:{levels:["web3/buildings/hotel_lv1","web3/buildings/hotel_lv2","web3/buildings/hotel_lv3","web3/buildings/hotel_lv4","web3/buildings/hotel_lv5"]},size:{width:1,height:1,scale:2},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:1},{id:"web3:property_small",type:a.BUILDING,name:"小型房屋",textures:{levels:["web3/buildings/property_small_lv1","web3/buildings/property_small_lv2","web3/buildings/property_small_lv3","web3/buildings/property_small_lv4","web3/buildings/property_small_lv5"]},size:{width:1,height:1,scale:1},animations:{canUpgrade:!0,canShake:!0},billboardMode:"off",defaultLevel:1}],n=[{id:"web3:player_0",type:a.PLAYER,name:"玩家1",textures:{default:"web3/actors/player_0",animations:{idle:["player_0_idle_1","player_0_idle_2"],walk:["player_0_walk_1","player_0_walk_2","player_0_walk_3","player_0_walk_4"],jump:["player_0_jump_1","player_0_jump_2"]}},size:{width:1,height:1.5,scale:2},animations:{canJump:!0,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:player_1",type:a.PLAYER,name:"玩家2",textures:{default:"web3/actors/player_1",animations:{idle:["player_1_idle_1","player_1_idle_2"],walk:["player_1_walk_1","player_1_walk_2","player_1_walk_3","player_1_walk_4"],jump:["player_1_jump_1","player_1_jump_2"]}},size:{width:1,height:1.5,scale:2},animations:{canJump:!0,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:player_2",type:a.PLAYER,name:"玩家3",textures:{default:"web3/actors/player_2",animations:{idle:["player_2_idle_1","player_2_idle_2"],walk:["player_2_walk_1","player_2_walk_2","player_2_walk_3","player_2_walk_4"],jump:["player_2_jump_1","player_2_jump_2"]}},size:{width:1,height:1.5,scale:2},animations:{canJump:!0,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"},{id:"web3:player_3",type:a.PLAYER,name:"玩家4",textures:{default:"web3/actors/player_3",animations:{idle:["player_3_idle_1","player_3_idle_2"],walk:["player_3_walk_1","player_3_walk_2","player_3_walk_3","player_3_walk_4"],jump:["player_3_jump_1","player_3_jump_2"]}},size:{width:1,height:1.5,scale:2},animations:{canJump:!0,canSay:!0,canMove:!0,canShake:!0},billboardMode:"yAxis"}],o=e("ActorConfigManager",function(){function e(){}return e.initialize=function(){var e=this;this.initialized||([].concat(l,t,n).forEach((function(i){e.configs.set(i.id,i)})),this.initialized=!0,console.log("[ActorConfigManager] Loaded "+this.configs.size+" actor configs"))},e.getConfig=function(e){return this.initialized||this.initialize(),this.configs.get(e)||null},e.getNPCConfigs=function(){return this.initialized||this.initialize(),Array.from(this.configs.values()).filter((function(e){return e.type===a.NPC}))},e.getBuildingConfigs=function(){return this.initialized||this.initialize(),Array.from(this.configs.values()).filter((function(e){return e.type===a.BUILDING}))},e.getObjectConfigs=function(){return this.initialized||this.initialize(),Array.from(this.configs.values()).filter((function(e){return e.type===a.OBJECT}))},e.isBuilding=function(e){var i=this.getConfig(e);return!!i&&i.type===a.BUILDING},e.isNPC=function(e){var i=this.getConfig(e);return!!i&&i.type===a.NPC},e.getPlayerConfigs=function(){return this.initialized||this.initialize(),Array.from(this.configs.values()).filter((function(e){return e.type===a.PLAYER}))},e.isPlayer=function(e){var i=this.getConfig(e);return!!i&&i.type===a.PLAYER},e.getMaxLevel=function(e){var i=this.getConfig(e);return i&&i.textures.levels?i.textures.levels.length-1:0},e}());o.configs=new Map,o.initialized=!1,i._RF.pop()}}}));

System.register("chunks:///_virtual/ActorFactory.ts",["cc","./Actor.ts"],(function(t){var r,e;return{setters:[function(t){r=t.cclegacy},function(t){e=t.Actor}],execute:function(){r._RF.push({},"48133GPREpJMIeq6s2mQMHp","ActorFactory",void 0);t("ActorFactory",function(){function t(){}return t.createForBuilding=function(t){return e.createBuildingActor(t)},t.createForNPC=function(t){return console.warn("[ActorFactory] createForNPC not implemented yet"),null},t.createForPlayer=function(t){return console.warn("[ActorFactory] createForPlayer not implemented yet"),null},t.updateRender=function(t,r){var n=t.getComponent(e);n?n.updateBuildingRender(r):console.warn("[ActorFactory] No Actor component found")},t}());r._RF.pop()}}}));

System.register("chunks:///_virtual/ActorTypes.ts",["cc"],(function(t){var e;return{setters:[function(t){e=t.cclegacy}],execute:function(){e._RF.push({},"e8e0bdI7x1M7JftLx4dQBnT","ActorTypes",void 0);t("ActorType",function(t){return t[t.NPC=0]="NPC",t[t.PLAYER=1]="PLAYER",t[t.BUILDING=2]="BUILDING",t[t.OBJECT=3]="OBJECT",t}({}));e._RF.pop()}}}));

System.register("chunks:///_virtual/admin.ts",["cc"],(function(){var t;return{setters:[function(n){t=n.cclegacy}],execute:function(){t._RF.push({},"4f9b9tv5rlAQoCZ7dksRuqn","admin",void 0),t._RF.pop()}}}));

System.register("chunks:///_virtual/aggregated.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var a,t;return{setters:[function(e){a=e.createForOfIteratorHelperLoose},function(e){t=e.cclegacy}],execute:function(){e({analyzePath:function(e){for(var t,r,n=[e.from],o=[],s=[],c=a(e.steps);!(r=c()).done;){var u=r.value;n.push(u.to_tile),u.npc_event&&o.push(u.npc_event),s.push.apply(s,u.pass_draws),u.stop_effect&&(t=u.stop_effect,s.push.apply(s,u.stop_effect.card_gains))}return{tiles:n,npcs:o,cards:s,finalStop:t}},calculateTotalCashChange:function(e,t){for(var r,n=0n,o=a(e);!(r=o()).done;){var s=r.value;s.player===t&&(s.is_debit?n-=s.amount:n+=s.amount)}return n},getAffectedPlayers:function(e){var t=new Set;t.add(e.player);for(var r,n=a(e.cash_changes);!(r=n()).done;){var o=r.value;t.add(o.player)}if("buff_changes"in e)for(var s,c=a(e.buff_changes);!(s=c()).done;){var u=s.value;t.add(u.target)}return Array.from(t)}}),t._RF.push({},"62345W6tv5NC71c1dgDaItZ","aggregated",void 0);e("CASH_REASON_TEXT",{1:"过路费",2:"购买地产",3:"升级地产",4:"获得奖金",5:"支付罚款",6:"卡牌效果"}),e("NPC_ACTION_TEXT",{1:"生成",2:"移除",3:"触发"}),e("NPC_RESULT_TEXT",{0:"无效果",1:"送往医院",2:"路障阻挡"}),e("STOP_TYPE_TEXT",{0:"无停留效果",1:"支付过路费",2:"免租通过",3:"送往医院",5:"获得奖金",6:"支付罚款",7:"卡片停留",8:"可购买地产"});t._RF.pop()}}}));

System.register("chunks:///_virtual/AOCalculator.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelBlock.ts"],(function(a){var e,t,l,n;return{setters:[function(a){e=a.createForOfIteratorHelperLoose},function(a){t=a.cclegacy,l=a.Vec3},function(a){n=a.BlockRegistry}],execute:function(){t._RF.push({},"3fdbaCS5/tGp4sDY4ozn+uZ","AOCalculator",void 0);a("AOCalculator",function(){function a(){}return a.calculateFaceAO=function(a,e,t){for(var l=[],n=0;n<4;n++){var r=a[n],o=this.calculateVertexAO(r,e,t);l.push(o)}return l},a.calculateVertexAO=function(a,t,l){for(var r,o=this.getAdjacentPositions(a,t),c=0,i=o.length,u=e(o);!(r=u()).done;){var s=r.value,f=l(Math.floor(s.x),Math.floor(s.y),Math.floor(s.z));f&&"minecraft:air"!==f&&!n.isTransparent(f)&&c++}var h=1-.7*(c/i);return Math.max(.3,h)},a.getAdjacentPositions=function(a,e){for(var t=[],n=e.clone().normalize(),r=this.getTangentVector(n),o=l.cross(new l,n,r).normalize(),c=.6,i=0,u=[r.clone().multiplyScalar(c),r.clone().multiplyScalar(-.6),o.clone().multiplyScalar(c),o.clone().multiplyScalar(-.6),l.add(new l,r,o).normalize().multiplyScalar(c),l.add(new l,r,o.clone().multiplyScalar(-1)).normalize().multiplyScalar(c),l.add(new l,r.clone().multiplyScalar(-1),o).normalize().multiplyScalar(c),l.add(new l,r.clone().multiplyScalar(-1),o.clone().multiplyScalar(-1)).normalize().multiplyScalar(c)];i<u.length;i++){var s=u[i],f=l.add(new l,a,s);t.push(f)}return t},a.getTangentVector=function(a){return(Math.abs(a.x)>Math.abs(a.y)?new l(-a.z,0,a.x):new l(0,-a.z,a.y)).normalize()},a.calculateSimpleAO=function(a,e,t){for(var r=[new l(1,0,0),new l(-1,0,0),new l(0,1,0),new l(0,-1,0),new l(0,0,1),new l(0,0,-1)],o=0,c=0,i=r;c<i.length;c++){var u=i[c],s=l.add(new l,a,u),f=t(Math.floor(s.x),Math.floor(s.y),Math.floor(s.z));f&&"minecraft:air"!==f&&!n.isTransparent(f)&&o++}var h=o/r.length;return Math.max(.4,1-.6*h)},a.calculateBatchAO=function(a,t){for(var l,n=[],r=e(a);!(l=r()).done;){var o=l.value,c=this.calculateFaceAO(o.positions,o.normal,t);n.push(c)}return n},a.getAODebugInfo=function(a,t,l){for(var r,o=this.getAdjacentPositions(a,t),c=[],i=e(o);!(r=i()).done;){var u=r.value,s=l(Math.floor(u.x),Math.floor(u.y),Math.floor(u.z));s&&"minecraft:air"!==s&&!n.isTransparent(s)&&c.push({pos:u.clone(),blockId:s})}var f=this.calculateVertexAO(a,t,l);return{vertexPos:a.clone(),aoValue:f,occludingBlocks:c,totalChecked:o.length}},a}());t._RF.pop()}}}));

System.register("chunks:///_virtual/assets.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(t){var e,s;return{setters:[function(t){e=t.createClass},function(t){s=t.cclegacy}],execute:function(){s._RF.push({},"fb50f454lZOk5S6MENIoM37","assets",void 0);t("PlayerAssets",function(){function t(t,e,s,i){void 0===t&&(t=0n),void 0===e&&(e=[]),void 0===s&&(s=[]),void 0===i&&(i={}),this._suiBalance=void 0,this._seats=void 0,this._mapTemplateNFTs=void 0,this._defiAssets=void 0,this._timestamp=void 0,this._suiBalance=t,this._seats=e,this._mapTemplateNFTs=s,this._defiAssets=i,this._timestamp=Date.now()}var s=t.prototype;return s.setSuiBalance=function(t){this._suiBalance=t,this._timestamp=Date.now()},s.setSeats=function(t){this._seats=t,this._timestamp=Date.now()},s.findSeatByGame=function(t){return this._seats.find((function(e){return e.game_id===t}))||null},s.findSeatByPlayerIndex=function(t,e){return this._seats.find((function(s){return s.game_id===t&&s.player_index===e}))||null},s.getSeatCount=function(){return this._seats.length},s.hasSeatForGame=function(t){return this._seats.some((function(e){return e.game_id===t}))},s.debugInfo=function(){return["SUI: "+this._suiBalance.toString(),"Seats: "+this._seats.length,"Templates: "+this._mapTemplateNFTs.length,"Age: "+(Date.now()-this._timestamp)+"ms"].join(", ")},e(t,[{key:"suiBalance",get:function(){return this._suiBalance}},{key:"seats",get:function(){return this._seats}},{key:"mapTemplateNFTs",get:function(){return this._mapTemplateNFTs}},{key:"defiAssets",get:function(){return this._defiAssets}},{key:"timestamp",get:function(){return this._timestamp}}]),t}());s._RF.pop()}}}));

System.register("chunks:///_virtual/AssetService.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r,n,a;return{setters:[function(e){t=e.asyncToGenerator,r=e.regeneratorRuntime,n=e.createForOfIteratorHelperLoose},function(e){a=e.cclegacy}],execute:function(){a._RF.push({},"5fec1MaH05NzIYae0gtw62N","AssetService",void 0);e("AssetService",function(){function e(e,t){this.client=e,this.packageId=t}var a=e.prototype;return a.getSuiBalance=function(){var e=t(r().mark((function e(t){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.client.getBalance({owner:t,coinType:"0x2::sui::SUI"});case 3:return n=e.sent,e.abrupt("return",BigInt(n.totalBalance));case 7:return e.prev=7,e.t0=e.catch(0),console.error("[AssetService] Failed to get SUI balance:",e.t0),e.abrupt("return",0n);case 11:case"end":return e.stop()}}),e,this,[[0,7]])})));return function(t){return e.apply(this,arguments)}}(),a.getAllCoins=function(){var e=t(r().mark((function e(t,n){var a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n="0x2::sui::SUI"),e.prev=1,e.next=4,this.client.getAllCoins({owner:t,coinType:n});case 4:return a=e.sent,e.abrupt("return",a.data.map((function(e){return{objectId:e.coinObjectId,coinType:e.coinType,balance:BigInt(e.balance),version:e.version}})));case 8:return e.prev=8,e.t0=e.catch(1),console.error("[AssetService] Failed to get all coins:",e.t0),e.abrupt("return",[]);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}(),a.getPlayerSeats=function(){var e=t(r().mark((function e(t){var a,s,c,u,o,i;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.client.getOwnedObjects({owner:t,filter:{StructType:this.packageId+"::game::Seat"},options:{showContent:!0,showType:!0}});case 3:for(a=e.sent,s=[],c=n(a.data);!(u=c()).done;)o=u.value,(i=this._parseSeat(o))&&s.push(i);return console.log("[AssetService] Found "+s.length+" Seats for "+t),e.abrupt("return",s);case 10:return e.prev=10,e.t0=e.catch(0),console.error("[AssetService] Failed to get seats:",e.t0),e.abrupt("return",[]);case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(t){return e.apply(this,arguments)}}(),a.getMapTemplateNFTs=function(){var e=t(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[AssetService] Map Template NFTs query not implemented yet"),e.abrupt("return",[]);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a.getDeFiAssets=function(){var e=t(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[AssetService] DeFi assets query not implemented yet"),e.abrupt("return",{bucketAssets:void 0,scallopAssets:void 0,naviAssets:void 0});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a._getBucketAssets=function(){var e=t(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a._getScallopAssets=function(){var e=t(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a._getNaviAssets=function(){var e=t(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a._parseSeat=function(e){var t;if("moveObject"!==(null==(t=e.data)||null==(t=t.content)?void 0:t.dataType))return null;try{var r=e.data.content.fields;return{id:e.data.objectId,game_id:r.game_id||"",player:r.player||"",player_index:Number(r.player_index)||0}}catch(e){return console.error("[AssetService] Failed to parse Seat:",e),null}},e.formatSuiAmount=function(e,t){return void 0===t&&(t=4),(Number(e)/1e9).toFixed(t)},e.shortenAddress=function(e){return!e||e.length<10?e:e.slice(0,6)+"..."+e.slice(-4)},e}());a._RF.pop()}}}));

System.register("chunks:///_virtual/BankruptHandler.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Blackboard.ts","./IdFormatter.ts"],(function(e,n){var r,t,a,o,u;return{setters:[function(e){r=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){a=e.cclegacy},function(e){o=e.Blackboard},function(e){u=e.IdFormatter}],execute:function(){a._RF.push({},"2e265i8TY1P7oKktVKtz/4u","BankruptHandler",void 0);var c=e("BankruptHandler",function(){function e(){console.log("[BankruptHandler] Handler 创建")}e.getInstance=function(){return e._instance||(e._instance=new e),e._instance};var a=e.prototype;return a.initialize=function(){console.log("[BankruptHandler] 初始化事件监听")},a.handleEvent=function(){var e=r(t().mark((function e(r){var a,c,l,s,i,d,p,k,g,f;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[BankruptHandler] 收到 BankruptEvent",r),a=r.data,e.prev=2,s=o.instance.get("currentGameSession")){e.next=7;break}return console.warn("[BankruptHandler] GameSession not found"),e.abrupt("return");case 7:if(a.game===s.getGameId()){e.next=10;break}return console.warn("[BankruptHandler] Event game mismatch, ignoring",{eventGame:a.game,currentGame:s.getGameId()}),e.abrupt("return");case 10:if(i=s.getPlayerByAddress(a.player)){e.next=14;break}return console.warn("[BankruptHandler] Player not found",a.player),e.abrupt("return");case 14:return i.setBankrupt(!0),console.log("[BankruptHandler] 玩家破产状态已更新",{player:u.shortenAddress(a.player),debt:a.debt,creditor:a.creditor}),d="玩家 "+(i.getPlayerIndex()+1),p=a.creditor?"玩家 "+(null!=(c=null==(l=s.getPlayerByAddress(a.creditor))?void 0:l.getPlayerIndex())?c:"?"):"银行",e.next=20,n.import("./UIManager.ts");case 20:if(k=e.sent,g=k.UIManager,!(f=null==g?void 0:g.instance)){e.next=27;break}return e.next=26,f.showUI("Bankruptcy",{playerName:d,creditorName:p,debt:a.debt});case 26:setTimeout((function(){f.hideUI("Bankruptcy")}),5e3);case 27:console.log("[BankruptHandler] BankruptEvent 处理完成"),e.next=33;break;case 30:e.prev=30,e.t0=e.catch(2),console.error("[BankruptHandler] 处理事件失败",e.t0);case 33:case"end":return e.stop()}}),e,null,[[2,30]])})));return function(n){return e.apply(this,arguments)}}(),a.destroy=function(){console.log("[BankruptHandler] Handler 销毁"),e._instance=null},e}());c._instance=null;e("bankruptHandler",{get instance(){return c.getInstance()}});a._RF.pop()}}}));

System.register("chunks:///_virtual/BaseCameraController.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,n,o,i,s,a,r,u,h,l,c,p;return{setters:[function(e){t=e.applyDecoratedDescriptor,n=e.inheritsLoose,o=e.initializerDefineProperty,i=e.assertThisInitialized},function(e){s=e.cclegacy,a=e._decorator,r=e.Camera,u=e.Vec3,h=e.find,l=e.input,c=e.Input,p=e.Component}],execute:function(){var f,g,m,d,y,E,C,_,b;s._RF.push({},"83197Y0qt9L/akPem1FEwhW","BaseCameraController",void 0);var M=a.ccclass,v=a.property;e("BaseCameraController",(f=M("BaseCameraController"),g=v({displayName:"启用输入控制",tooltip:"是否启用键盘和鼠标输入"}),m=v({displayName:"启用调试模式",tooltip:"是否输出调试信息"}),d=v({type:r,displayName:"相机组件",tooltip:"相机组件引用"}),f((C=t((E=function(e){function t(){for(var t,n=arguments.length,s=new Array(n),a=0;a<n;a++)s[a]=arguments[a];return t=e.call.apply(e,[this].concat(s))||this,o(t,"enableInputControl",C,i(t)),o(t,"debugMode",_,i(t)),o(t,"camera",b,i(t)),t._keyStates=new Map,t._mouseDown=!1,t._lastMousePosition=new u,t._isEnabled=!0,t}n(t,e);var s=t.prototype;return s.onLoad=function(){this._setupCamera(),this._setupInput(),this.debugLog("BaseCameraController onLoad")},s.start=function(){this.onCameraStart()},s.onEnable=function(){this.enableInputControl&&this._registerInputEvents(),this.onCameraEnable()},s.onDisable=function(){this.enableInputControl&&this._unregisterInputEvents(),this.onCameraDisable()},s.onDestroy=function(){this._unregisterInputEvents(),this.onCameraDestroy()},s.update=function(e){this._isEnabled&&this.onCameraUpdate(e)},s.getCamera=function(){return this.camera},s.setEnabled=function(e){this._isEnabled=e,this.enabled=e,e?this.onCameraEnable():this.onCameraDisable()},s.getCameraState=function(){var e=this.node.getPosition(),t=this.node.getRotation(),n=new u;return t.getEulerAngles(n),{enabled:this._isEnabled,position:e.clone(),rotation:n,lastUpdateTime:Date.now()}},s.resetToDefault=function(){this.onResetToDefault()},s.onKeyDown=function(e){this._keyStates.set(e.keyCode,!0),this.debugLog("Key down: "+e.keyCode)},s.onKeyUp=function(e){this._keyStates.set(e.keyCode,!1),this.debugLog("Key up: "+e.keyCode)},s.onMouseDown=function(e){this._mouseDown=!0,this._lastMousePosition.set(e.getLocationX(),e.getLocationY(),0),this.debugLog("Mouse down: "+e.getButton())},s.onMouseUp=function(e){this._mouseDown=!1,this.debugLog("Mouse up: "+e.getButton())},s.onMouseMove=function(e){if(this._mouseDown){var t=new u(e.getLocationX(),e.getLocationY(),0),n=u.subtract(new u,t,this._lastMousePosition);this._lastMousePosition.set(t),this.onMouseDrag(n)}},s.onMouseDrag=function(e){},s.onMouseWheel=function(e){},s.isKeyPressed=function(e){return this._keyStates.get(e)||!1},s.debugLog=function(e){this.debugMode&&console.log("["+this.constructor.name+"] "+e)},s.getCameraForward=function(){var e=this.node.getRotation(),t=new u(0,0,-1);return u.transformQuat(t,t,e),t},s.getCameraRight=function(){var e=this.node.getRotation(),t=new u(1,0,0);return u.transformQuat(t,t,e),t},s.getCameraUp=function(){var e=this.node.getRotation(),t=new u(0,1,0);return u.transformQuat(t,t,e),t},s._setupCamera=function(){if(!this.camera&&(this.camera=this.getComponent(r),!this.camera)){var e=h("Main Camera")||h("MainCamera")||h("Camera");e&&(this.camera=e.getComponent(r))}this.camera||console.warn("["+this.constructor.name+"] 无法找到Camera组件")},s._setupInput=function(){this.enableInputControl&&this.debugLog("Input control enabled")},s._registerInputEvents=function(){l.on(c.EventType.KEY_DOWN,this.onKeyDown,this),l.on(c.EventType.KEY_UP,this.onKeyUp,this),l.on(c.EventType.MOUSE_DOWN,this.onMouseDown,this),l.on(c.EventType.MOUSE_UP,this.onMouseUp,this),l.on(c.EventType.MOUSE_MOVE,this.onMouseMove,this),l.on(c.EventType.MOUSE_WHEEL,this.onMouseWheel,this)},s._unregisterInputEvents=function(){l.off(c.EventType.KEY_DOWN,this.onKeyDown,this),l.off(c.EventType.KEY_UP,this.onKeyUp,this),l.off(c.EventType.MOUSE_DOWN,this.onMouseDown,this),l.off(c.EventType.MOUSE_UP,this.onMouseUp,this),l.off(c.EventType.MOUSE_MOVE,this.onMouseMove,this),l.off(c.EventType.MOUSE_WHEEL,this.onMouseWheel,this)},t}(p)).prototype,"enableInputControl",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_=t(E.prototype,"debugMode",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b=t(E.prototype,"camera",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y=E))||y));s._RF.pop()}}}));

System.register("chunks:///_virtual/BFSPathfinder.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){r=e.cclegacy}],execute:function(){r._RF.push({},"b3139KKXgFPGrwv5ZhQC5dF","BFSPathfinder",void 0);e("BFSPathfinder",function(){function e(e){this.graph=void 0,this.graph=e}var r=e.prototype;return r.search=function(e,r){var a=new Map,n=new Map,s=new Map,i=new Map,o=[],c=new Set;for(o.push({tile:e,distance:0}),c.add(e),s.set(e,0),a.set(0,[e]);o.length>0;){var h=o.shift(),l=h.tile,u=h.distance;if(!(u>=r))for(var f,g=this.graph.getNeighbors(l),p=t(g);!(f=p()).done;){var d=f.value;if(!c.has(d)){c.add(d),n.set(d,l),s.set(d,u+1),a.has(u+1)||a.set(u+1,[]),a.get(u+1).push(d);var v=i.get(l)||[l];i.set(d,[].concat(v,[d])),o.push({tile:d,distance:u+1})}}}return{reachableTiles:a,parents:n,distances:s,pathTree:i}},r.findPath=function(e,t,r){var a=this.search(e,r),n=a.distances.get(t);if(void 0===n||n>r)return null;var s=a.pathTree.get(t)||[];return 0===s.length&&t!==e?null:t===e?{target:t,path:[e],distance:0}:{target:t,path:s,distance:n}},r.getReachableTiles=function(e,t){for(var r=this.search(e,t),a=[],n=0;n<=t;n++){var s=r.reachableTiles.get(n)||[];a.push.apply(a,s)}return a},r.getTilesAtExactDistance=function(e,t){return this.search(e,t).reachableTiles.get(t)||[]},r.reconstructPath=function(e,t,r){for(var a=[],n=t;n!==e;){a.unshift(n);var s=r.get(n);if(void 0===s)return[];n=s}return a.unshift(e),a},r.debugPrintResult=function(e){console.log("[BFSPathfinder] Search result:");for(var r,a=t(e.reachableTiles);!(r=a()).done;){var n=r.value,s=n[0],i=n[1];console.log("  Distance "+s+": ["+i.join(", ")+"]")}console.log("  Path tree:");for(var o,c=t(e.pathTree);!(o=c()).done;){var h=o.value,l=h[0],u=h[1];console.log("    To "+l+": ["+u.join(" -> ")+"]")}},e}());r._RF.pop()}}}));

System.register("chunks:///_virtual/Blackboard.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(t){var e,a,r,i,n,s;return{setters:[function(t){e=t.inheritsLoose,a=t.createForOfIteratorHelperLoose,r=t.createClass},function(t){i=t.cclegacy,n=t.error,s=t.EventTarget}],execute:function(){i._RF.push({},"74ea1Y8aTBG24GMAYD0nH76","Blackboard",void 0),t("Blackboard",function(t){function i(){var e;return(e=t.call(this)||this)._data=new Map,e._debug=!1,e}e(i,t);var s=i.prototype;return s.setDebug=function(t){this._debug=t},s.set=function(t,e){var a=this._data.get(t),r=a?a.value:void 0;if(!this._isEqual(r,e)){var i={value:e,watchers:a?a.watchers:[],type:typeof e};this._data.set(t,i),this._notifyWatchers(t,e,r),this.emit(t,e,r),this._debug&&console.log("[Blackboard] Set: "+t+" = "+JSON.stringify(e)+" (was: "+JSON.stringify(r)+")")}},s.get=function(t,e){var a=this._data.get(t);return a?a.value:e},s.has=function(t){return this._data.has(t)},s.delete=function(t){var e=this,a=this._data.get(t);if(!a)return!1;var r=a.value;return a.watchers.forEach((function(t){t.target&&e.targetOff(t.target)})),this._data.delete(t),this.emit(t+"_deleted",r),this._debug&&console.log("[Blackboard] Deleted: "+t),!0},s.watch=function(t,e,a){this.addWatcher(t,{watcher:e,target:a,immediate:!1,deep:!1})},s.watchImmediate=function(t,e,a){this.addWatcher(t,{watcher:e,target:a,immediate:!0,deep:!1})},s.watchDeep=function(t,e,a){this.addWatcher(t,{watcher:e,target:a,immediate:!1,deep:!0})},s.addWatcher=function(t,e){var a=this._data.get(t);if(a||(a={value:void 0,watchers:[],type:"undefined"},this._data.set(t,a)),a.watchers.push(e),this.on(t,e.watcher,e.target),e.immediate&&void 0!==a.value)try{e.watcher(a.value,void 0,t)}catch(e){n("[Blackboard] Error in immediate watcher for "+t+":",e)}this._debug&&console.log("[Blackboard] Added watcher for: "+t,{hasTarget:!!e.target,immediate:e.immediate})},s.unwatch=function(t,e,a){var r=this._data.get(t);r&&(e?(r.watchers=r.watchers.filter((function(t){return t.watcher!==e||t.target!==a})),this.off(t,e,a)):a?(r.watchers=r.watchers.filter((function(t){return t.target!==a})),this.targetOff(a)):(r.watchers=[],this.off(t)),this._debug&&console.log("[Blackboard] Removed watcher for: "+t,{hasWatcher:!!e,hasTarget:!!a}))},s.unwatchTarget=function(t){for(var e,r=a(this._data);!(e=r()).done;){var i=e.value,n=(i[0],i[1]);n.watchers=n.watchers.filter((function(e){return e.target!==t}))}this.targetOff(t),this._debug&&console.log("[Blackboard] Removed all watchers for target:",t)},s.keys=function(){return Array.from(this._data.keys())},s.getAll=function(){for(var t,e={},r=a(this._data);!(t=r()).done;){var i=t.value,n=i[0],s=i[1];e[n]=s.value}return e},s.setBatch=function(t){for(var e in t)t.hasOwnProperty(e)&&this.set(e,t[e])},s.clear=function(){for(var t=0,e=Array.from(this._data.keys());t<e.length;t++){var a=e[t];this.delete(a)}this._debug&&console.log("[Blackboard] Cleared all data")},s.getDebugInfo=function(){for(var t,e={totalKeys:this._data.size,data:{},watchers:{}},r=a(this._data);!(t=r()).done;){var i=t.value,n=i[0],s=i[1];e.data[n]={value:s.value,type:s.type},e.watchers[n]=s.watchers.length}return e},s.destroy=function(){this.clear(),i._instance=null,this._debug&&console.log("[Blackboard] Destroyed")},s._notifyWatchers=function(t,e,r){var i=this._data.get(t);if(i)for(var s,o=a(i.watchers);!(s=o()).done;){var c=s.value;try{c.watcher(e,r,t)}catch(e){n("[Blackboard] Error in watcher for "+t+":",e)}}},s._isEqual=function(t,e){if(t===e)return!0;if(null==t||null==e)return t===e;if(typeof t!=typeof e)return!1;if("object"==typeof t){var a=Object.keys(t),r=Object.keys(e);if(a.length!==r.length)return!1;for(var i=0,n=a;i<n.length;i++){var s=n[i];if(!this._isEqual(t[s],e[s]))return!1}return!0}return!1},r(i,null,[{key:"instance",get:function(){return this._instance||(this._instance=new i),this._instance}}]),i}(s))._instance=null,i._RF.pop()}}}));

System.register("chunks:///_virtual/BlockOverlayManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./OverlayTypes.ts"],(function(e){var r,t,n,a,o,l,s,c,i,u,y,f,v,h,d;return{setters:[function(e){r=e.createForOfIteratorHelperLoose,t=e.asyncToGenerator,n=e.regeneratorRuntime},function(e){a=e.cclegacy,o=e.Vec3,l=e.Vec2,s=e.utils,c=e.gfx,i=e.MeshRenderer,u=e.resources,y=e.EffectAsset,f=e.Material,v=e.Color,h=e.Node},function(e){d=e.OverlayFace}],execute:function(){a._RF.push({},"fa911GBnCRENZxTsVarSpZm","BlockOverlayManager",void 0);var g=e("BlockOverlayManager",function(){function e(){}return e.getOverlayEffect=function(){var e=t(n().mark((function e(){var r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._cachedEffect){e.next=2;break}return e.abrupt("return",this._cachedEffect);case 2:if(!this._loadingEffectPromise){e.next=4;break}return e.abrupt("return",this._loadingEffectPromise);case 4:return this._loadingEffectPromise=this.loadAsset("voxel/shaders/voxel-overlay-tile",y),e.next=7,this._loadingEffectPromise;case 7:return r=e.sent,this._cachedEffect=r,this._loadingEffectPromise=null,e.abrupt("return",r);case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e.createOverlay=function(){var e=t(n().mark((function e(r,t){var a,o,l,s,c,u,y,g,w;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.layerIndex||0,(o=new h("Overlay_"+a)).setParent(r),o.setPosition(0,0,0),l=t.faces||[d.UP],s=t.inflate||.001,c=this.createOverlayMesh(l,s)){e.next=11;break}return o.destroy(),console.error("[BlockOverlayManager] Failed to create overlay mesh"),e.abrupt("return",null);case 11:if((u=o.addComponent(i)).mesh=c,o.setPosition(0,0,0),!this.DEBUG_NO_MATERIAL){e.next=18;break}return console.warn("[BlockOverlayManager] DEBUG_NO_MATERIAL 开启：不绑定材质用于可见性测试"),console.log("[BlockOverlayManager] Created overlay layer "+a+" (debug no material)"),e.abrupt("return",o);case 18:return e.prev=18,e.next=21,this.getOverlayEffect();case 21:if(g=e.sent){e.next=26;break}return console.error("[BlockOverlayManager] Failed to load voxel-overlay shader"),o.destroy(),e.abrupt("return",null);case 26:return(w=new f).initialize({effectAsset:g,technique:null!=(y=t.techniqueIndex)?y:1}),w.setProperty("mainTexture",t.texture),t.color?w.setProperty("mainColor",t.color):w.setProperty("mainColor",v.WHITE),u.setMaterial(w,0),e.abrupt("return",o);case 34:return e.prev=34,e.t0=e.catch(18),console.error("[BlockOverlayManager] Failed to create overlay material:",e.t0),o.destroy(),e.abrupt("return",null);case 39:case"end":return e.stop()}}),e,this,[[18,34]])})));return function(r,t){return e.apply(this,arguments)}}(),e.createOverlayMesh=function(e,t){for(var n,a=[],l=[],s=[],c=[],i=[],u=0,y=new o(-.5,-.5,-.5),f=new o(.5,.5,.5),v=r(e);!(n=v()).done;){for(var h=n.value,d=this.getFaceVertices(h,y,f,t),g=this.getFaceNormal(h),w=this.getFaceUVs(h),x=0;x<4;x++)a.push(d[x].x,d[x].y,d[x].z),l.push(g.x,g.y,g.z),s.push(w[x].x,w[x].y),c.push(1,1,1,1);var p=u;i.push(p,p+1,p+2,p,p+2,p+3),u+=4}return this.createCocosMesh(a,l,s,c,i)},e.getFaceVertices=function(e,r,t,n){var a;switch(e){case d.UP:a=[new o(t.x,t.y,r.z),new o(r.x,t.y,r.z),new o(r.x,t.y,t.z),new o(t.x,t.y,t.z)];break;case d.DOWN:a=[new o(r.x,r.y,t.z),new o(r.x,r.y,r.z),new o(t.x,r.y,r.z),new o(t.x,r.y,t.z)];break;case d.NORTH:a=[new o(t.x,r.y,r.z),new o(r.x,r.y,r.z),new o(r.x,t.y,r.z),new o(t.x,t.y,r.z)];break;case d.SOUTH:a=[new o(r.x,r.y,t.z),new o(t.x,r.y,t.z),new o(t.x,t.y,t.z),new o(r.x,t.y,t.z)];break;case d.WEST:a=[new o(r.x,r.y,r.z),new o(r.x,r.y,t.z),new o(r.x,t.y,t.z),new o(r.x,t.y,r.z)];break;case d.EAST:a=[new o(t.x,r.y,t.z),new o(t.x,r.y,r.z),new o(t.x,t.y,r.z),new o(t.x,t.y,t.z)];break;default:a=[]}var l=this.getFaceNormal(e);return a.map((function(e){return new o(e.x+l.x*n,e.y+l.y*n,e.z+l.z*n)}))},e.getFaceNormal=function(e){switch(e){case d.NORTH:return new o(0,0,-1);case d.SOUTH:return new o(0,0,1);case d.WEST:return new o(-1,0,0);case d.EAST:return new o(1,0,0);case d.UP:return new o(0,1,0);case d.DOWN:return new o(0,-1,0);default:return new o(0,1,0)}},e.getFaceUVs=function(e){return[new l(1,0),new l(0,0),new l(0,1),new l(1,1)]},e.createCocosMesh=function(e,r,t,n,a){try{return s.MeshUtils.createMesh({positions:e,normals:r,uvs:t,colors:n,indices:a,primitiveMode:c.PrimitiveMode.TRIANGLE_LIST})}catch(e){return console.error("[BlockOverlayManager] Failed to create mesh:",e),null}},e.updateOverlayTexture=function(e,r){var t=e.getComponent(i);if(t){var n=t.getMaterial(0);if(n&&(n.setProperty("mainTexture",r),console.log("[BlockOverlayManager] Overlay texture updated"),this.DEBUG_LOG)){var a=null==r?void 0:r.image;console.log("[BlockOverlayManager] New texture info:",{name:(null==r?void 0:r._uuid)||(null==r?void 0:r.name),width:null==r?void 0:r.width,height:null==r?void 0:r.height,hasImage:!!a,imageSize:a?{width:a.width,height:a.height}:null})}}else console.warn("[BlockOverlayManager] MeshRenderer not found on overlay node")},e.updateOverlayColor=function(e,r){var t=e.getComponent(i);if(t){var n=t.getMaterial(0);if(n){var a=[r.r/255,r.g/255,r.b/255,r.a/255];n.setProperty("mainColor",a)}}},e.removeOverlay=function(e,r){var t=e.getChildByName("Overlay_"+r);t&&t.isValid&&(t.destroy(),console.log("[BlockOverlayManager] Removed overlay layer "+r))},e.getOverlay=function(e,r){return e.getChildByName("Overlay_"+r)},e.hasOverlay=function(e,r){return null!==this.getOverlay(e,r)},e.loadAsset=function(e,r){return new Promise((function(t){u.load(e,r,(function(r,n){r?(console.error("[BlockOverlayManager] Failed to load "+e+":",r),t(null)):t(n)}))}))},e}());g._cachedEffect=null,g._loadingEffectPromise=null,g.DEBUG_NO_MATERIAL=!1,g.DEBUG_LOG=!0,a._RF.pop()}}}));

System.register("chunks:///_virtual/BlockParser.ts",["./rollupPluginModLoBabelHelpers.js","cc","./utils.ts","./ResourceLoader.ts","./TemplateProcessor.ts"],(function(e){var t,r,n,s,a,o,i,u,c,l;return{setters:[function(e){t=e.asyncToGenerator,r=e.regeneratorRuntime,n=e.extends},function(e){s=e.cclegacy},function(e){a=e.pickDefaultVariant,o=e.parseNamespacedId,i=e.buildResourcePath,u=e.parseModelOrTexRef},function(e){c=e.ResourceLoader},function(e){l=e.TemplateProcessor}],execute:function(){s._RF.push({},"a5237hZnZxCjYoRpE+NYVE+","BlockParser",void 0);e("BlockParser",function(){function e(e){this.loader=void 0,this.options=void 0,this.options={rootDir:(null==e?void 0:e.rootDir)||"voxel/resource_pack",searchRoots:(null==e?void 0:e.searchRoots)||[],defaultNamespace:(null==e?void 0:e.defaultNamespace)||"minecraft"},0===this.options.searchRoots.length&&(this.options.searchRoots=[this.options.rootDir]),this.loader=new c(this.options.rootDir,this.options.searchRoots)}var s=e.prototype;return s.parseBlock=function(){var e=t(r().mark((function e(t){var n,s,i,u,c,p,h,f,k,d,b,x,m,v,y,w;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o(t,this.options.defaultNamespace),s=n.path,e.next=4,this.loadBlockState(n);case 4:return i=e.sent,u="minecraft:block/cube_all",c=0,null!=i&&i.json&&(p=a(i.json.variants))&&(u=p.variant.model||u,c=p.variant.y||0),e.next=10,this.resolveModelChain(u,n.ns);case 10:return h=e.sent,f=h.modelChain,k=h.texturesDict,e.next=14,this.resolveTextures(k,n.ns);case 14:for(v in d=e.sent,b=l.detectTemplate(f),x=l.synthesizeElementsByTemplate(b,d,f),m=[],d)d.hasOwnProperty(v)&&m.push(d[v]);return y={blockstate:null==i?void 0:i.json,models:f,texturesDict:k,resolvedTextures:d},w={id:n,shortId:s,rotationY:c,modelTemplate:b,elements:x,textures:m,debug:{blockstatePath:null==i?void 0:i.rel,modelChainPaths:f.map((function(e){return e.rel})),combinedJson:y}},e.abrupt("return",w);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),s.loadBlockState=function(){var e=t(r().mark((function e(t){var n,s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i(t.ns,"blockstates",null,t.path),e.next=3,this.loader.loadJsonFromRoots(n);case 3:if(!(s=e.sent)){e.next=6;break}return e.abrupt("return",{json:s.json,rel:s.rel});case 6:return console.warn("[BlockParser] BlockState 未找到: "+t.ns+":"+t.path),e.abrupt("return",null);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),s.resolveModelChain=function(){var e=t(r().mark((function e(t,n){var s,a,o,c,p,h,f,k,d;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=[],a={},o=new Set,c=n,p=t;case 5:if(!p){e.next=34;break}if(!o.has(p)){e.next=9;break}return console.warn("[BlockParser] 检测到循环引用: "+p),e.abrupt("break",34);case 9:if(o.add(p),!(h=u(p,c)).builtin){e.next=21;break}if(s.push({rel:"builtin:"+h.name,ns:"builtin",json:{parent:"builtin/"+h.name}}),!(f=l.resolveBuiltin(h.name))){e.next=20;break}return p=f,c="minecraft",e.abrupt("continue",5);case 20:return e.abrupt("break",34);case 21:return k=i(h.ns,"models",h.domain||"block",h.name),e.next=24,this.loader.loadJsonFromRoots(k);case 24:if(d=e.sent){e.next=28;break}return console.warn("[BlockParser] 模型未找到: "+k),e.abrupt("break",34);case 28:s.push({rel:k,ns:h.ns,json:d.json}),d.json.textures&&Object.assign(a,d.json.textures),p=d.json.parent,c=h.ns,e.next=5;break;case 34:return e.abrupt("return",{modelChain:s,texturesDict:a});case 35:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),s.resolveTextures=function(){var e=t(r().mark((function e(t,s){var a,o,i,u,c,l,p,h,f,k,d;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a={},o=10,e.t0=r().keys(t);case 3:if((e.t1=e.t0()).done){e.next=16;break}if(i=e.t1.value,t.hasOwnProperty(i)){e.next=7;break}return e.abrupt("continue",3);case 7:if((u=t[i]).startsWith("#")){e.next=14;break}return e.next=11,this.resolveTextureRef(u,s);case 11:(c=e.sent).key=i,a[i]=c;case 14:e.next=3;break;case 16:l=0;case 17:if(!(l<o)){e.next=46;break}p=!1,e.t2=r().keys(t);case 20:if((e.t3=e.t2()).done){e.next=41;break}if(h=e.t3.value,t.hasOwnProperty(h)){e.next=24;break}return e.abrupt("continue",20);case 24:if(!(f=t[h]).startsWith("#")){e.next=39;break}if(k=f.substring(1),!a[k]){e.next=31;break}a[h]=n({},a[k],{key:h}),e.next=39;break;case 31:if(!t[k]||t[k].startsWith("#")){e.next=38;break}return e.next=34,this.resolveTextureRef(t[k],s);case 34:d=e.sent,a[h]=n({},d,{key:h}),e.next=39;break;case 38:p=!0;case 39:e.next=20;break;case 41:if(p){e.next=43;break}return e.abrupt("break",46);case 43:l++,e.next=17;break;case 46:return e.abrupt("return",a);case 47:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),s.resolveTextureRef=function(){var e=t(r().mark((function e(t,n){var s,a,o,i,c,l;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=u(t,n),a=s.ns||n,o=s.domain||"block",i=s.name,c="assets/"+a+"/textures/"+o+"/"+i+".png",e.next=7,this.loader.checkResourceExists(c);case 7:return l=e.sent,e.abrupt("return",{key:"",id:a+":"+o+"/"+i,ns:a,domain:o,name:i,rel:c,missing:!l,source:l?"resourcepack":"unknown"});case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),s.clearCache=function(){this.loader.clearCache()},s.getCacheStats=function(){return this.loader.getCacheStats()},e}());s._RF.pop()}}}));

System.register("chunks:///_virtual/BuildingDecisionHandler.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Blackboard.ts","./UINotification.ts"],(function(n){var e,i,t,r,o;return{setters:[function(n){e=n.asyncToGenerator,i=n.regeneratorRuntime},function(n){t=n.cclegacy},function(n){r=n.Blackboard},function(n){o=n.UINotification}],execute:function(){t._RF.push({},"3268a4YtdBE77RyU7vwGJLS","BuildingDecisionHandler",void 0);var l=n("BuildingDecisionHandler",function(){function n(){console.log("[BuildingDecisionHandler] Handler 创建")}n.getInstance=function(){return n._instance||(n._instance=new n),n._instance};var t=n.prototype;return t.initialize=function(){console.log("[BuildingDecisionHandler] 初始化事件监听")},t.handleEvent=function(){var n=e(i().mark((function n(e){var t,l,a,d,u,c,s,g,p,B;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(console.log("[BuildingDecisionHandler] 收到 BuildingDecisionEvent",e),t=e.data,n.prev=2,l=r.instance.get("currentGameSession")){n.next=7;break}return console.warn("[BuildingDecisionHandler] GameSession not found"),n.abrupt("return");case 7:if(t.game===l.getGameId()){n.next=10;break}return console.warn("[BuildingDecisionHandler] Event game mismatch, ignoring",{eventGame:t.game,currentGame:l.getGameId()}),n.abrupt("return");case 10:if(!t.auto_decision){n.next=16;break}if(t.decision){n.next=14;break}return console.warn("[BuildingDecisionHandler] Auto-decision event with null decision, ignoring"),n.abrupt("return");case 14:return console.log("[BuildingDecisionHandler] Auto-decision event ignored (handled by RollAndStepHandler)",{buildingId:t.decision.building_id,player:t.player,amount:t.decision.amount.toString(),decisionType:t.decision.decision_type,newLevel:t.decision.new_level}),n.abrupt("return");case 16:if(a=t.decision){n.next=20;break}return console.error("[BuildingDecisionHandler] Missing decision data in BuildingDecisionEvent"),n.abrupt("return");case 20:return l.setRound(t.round),n.next=23,l.advance_turn(t.turn);case 23:if(console.log("[BuildingDecisionHandler] Turn 已更新",{round:t.round,turn:t.turn}),d=l.getPlayerByAddress(t.player)){n.next=28;break}return console.warn("[BuildingDecisionHandler] Player not found",t.player),n.abrupt("return");case 28:u=BigInt(a.amount),c=d.getCash()-u,d.setCash(c),(s=l.getMyPlayer())&&d===s&&(o.info("-"+u,void 0,2e3,"center"),console.log("[BuildingDecisionHandler] 显示现金变动: -",u.toString())),console.log("[BuildingDecisionHandler] 玩家现金已更新",{player:d.getPlayerIndex(),oldCash:d.getCash().toString(),newCash:c.toString(),amount:u.toString()}),l.updateBuilding(a.building_id,d.getPlayerIndex(),a.new_level,a.building_type),console.log("[BuildingDecisionHandler] 建筑已更新",{buildingId:a.building_id,owner:d.getPlayerIndex(),level:a.new_level,buildingType:a.building_type}),g=1===a.decision_type?"购买":"升级",p=l.getBuildingByIndex(a.building_id),B=(null==p?void 0:p.getBuildingTypeName())||"建筑"+a.building_id,o.success("玩家"+(d.getPlayerIndex()+1)+g+"了"+B+"，花费"+u.toString()),console.log("[BuildingDecisionHandler] BuildingDecisionEvent 处理完成"),n.next=47;break;case 43:n.prev=43,n.t0=n.catch(2),console.error("[BuildingDecisionHandler] 处理事件失败",n.t0),o.error("建筑决策处理失败: "+(n.t0.message||n.t0));case 47:case"end":return n.stop()}}),n,null,[[2,43]])})));return function(e){return n.apply(this,arguments)}}(),t.destroy=function(){console.log("[BuildingDecisionHandler] Handler 销毁"),n._instance=null},n}());l._instance=null;n("buildingDecisionHandler",{get instance(){return l.getInstance()}});t._RF.pop()}}}));

System.register("chunks:///_virtual/CameraConfig.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(i){var t,e,o,n,r;return{setters:[function(i){t=i.applyDecoratedDescriptor,e=i.initializerDefineProperty},function(i){o=i.cclegacy,n=i._decorator,r=i.Vec3}],execute:function(){var a,l,u,p,s,c,m,b,f,h,g,y,d,w,z,N,D,C,v,O,S,_,x,H,M,R,T,A,F,I,V,B,E,P,Z,q,G,L,j,k,K,U,W,J,Q,X,Y,$,ii,ti,ei,oi,ni,ri,ai,li,ui,pi,si,ci,mi,bi,fi;o._RF.push({},"1ff2cm+VDZKBbmu3V4G2nPw","CameraConfig",void 0);var hi,gi=n.ccclass,yi=n.property,di=(i("CameraMode",function(i){return i.NONE="none",i.ISOMETRIC="isometric",i.TOP_DOWN="top_down",i}({})),i("IsometricConfig",(a=gi("IsometricConfig"),l=yi({displayName:"相机距离",tooltip:"相机距离目标点的距离"}),u=yi({displayName:"相机高度",tooltip:"相机高度偏移"}),p=yi({displayName:"俯视角度",tooltip:"俯视角度（度数）"}),s=yi({displayName:"视野角度",tooltip:"相机FOV"}),c=yi({displayName:"水平旋转角度",tooltip:"水平旋转角度（用于调整观察方向）"}),m=yi({displayName:"允许鼠标旋转",tooltip:"是否允许鼠标拖拽旋转"}),b=yi({displayName:"旋转速度",tooltip:"鼠标拖拽旋转速度"}),a((g=t((h=function(){e(this,"distance",g,this),e(this,"height",y,this),e(this,"angle",d,this),e(this,"fov",w,this),e(this,"yawAngle",z,this),e(this,"allowRotation",N,this),e(this,"rotationSpeed",D,this)}).prototype,"distance",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 25}}),y=t(h.prototype,"height",[u],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d=t(h.prototype,"angle",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-45}}),w=t(h.prototype,"fov",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),z=t(h.prototype,"yawAngle",[c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-45}}),N=t(h.prototype,"allowRotation",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),D=t(h.prototype,"rotationSpeed",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),f=h))||f))),wi=i("TopDownConfig",(C=gi("TopDownConfig"),v=yi({displayName:"相机高度",tooltip:"俯视相机高度"}),O=yi({displayName:"视野角度",tooltip:"相机FOV"}),S=yi({displayName:"允许缩放",tooltip:"是否允许滚轮缩放"}),_=yi({displayName:"最小高度",tooltip:"缩放最小高度限制"}),x=yi({displayName:"最大高度",tooltip:"缩放最大高度限制"}),H=yi({displayName:"缩放速度",tooltip:"滚轮缩放速度"}),C((T=t((R=function(){e(this,"height",T,this),e(this,"fov",A,this),e(this,"allowZoom",F,this),e(this,"minHeight",I,this),e(this,"maxHeight",V,this),e(this,"zoomSpeed",B,this)}).prototype,"height",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),A=t(R.prototype,"fov",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),F=t(R.prototype,"allowZoom",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I=t(R.prototype,"minHeight",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 15}}),V=t(R.prototype,"maxHeight",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),B=t(R.prototype,"zoomSpeed",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),M=R))||M)),zi=i("CameraBounds",(E=gi("CameraBounds"),P=yi({displayName:"最小位置",tooltip:"相机移动的最小位置限制"}),Z=yi({displayName:"最大位置",tooltip:"相机移动的最大位置限制"}),q=yi({displayName:"启用边界限制",tooltip:"是否启用边界限制"}),E((j=t((L=function(){e(this,"min",j,this),e(this,"max",k,this),e(this,"enabled",K,this)}).prototype,"min",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r(-50,0,-50)}}),k=t(L.prototype,"max",[Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r(50,100,50)}}),K=t(L.prototype,"enabled",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),G=L))||G)),Ni=i("TransitionConfig",(U=gi("TransitionConfig"),W=yi({displayName:"位置过渡时间",tooltip:"位置过渡持续时间（秒）"}),J=yi({displayName:"旋转过渡时间",tooltip:"旋转过渡持续时间（秒）"}),Q=yi({displayName:"缓动类型",tooltip:"缓动类型"}),U(($=t((Y=function(){e(this,"positionDuration",$,this),e(this,"rotationDuration",ii,this),e(this,"easing",ti,this)}).prototype,"positionDuration",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ii=t(Y.prototype,"rotationDuration",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.8}}),ti=t(Y.prototype,"easing",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"quartOut"}}),X=Y))||X)),Di=i("CameraConfig",(ei=gi("CameraConfig"),oi=yi({type:di,displayName:"等距视角配置",tooltip:"等距视角模式的相关参数"}),ni=yi({type:wi,displayName:"俯视视角配置",tooltip:"俯视视角模式的相关参数"}),ri=yi({type:zi,displayName:"边界限制配置",tooltip:"相机移动边界限制的相关参数"}),ai=yi({type:Ni,displayName:"过渡动画配置",tooltip:"相机切换过渡动画的相关参数"}),li=yi({displayName:"调试模式",tooltip:"是否启用调试模式显示"}),ei((si=t((pi=function(){e(this,"isometric",si,this),e(this,"topDown",ci,this),e(this,"bounds",mi,this),e(this,"transition",bi,this),e(this,"debugMode",fi,this)}).prototype,"isometric",[oi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di}}),ci=t(pi.prototype,"topDown",[ni],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wi}}),mi=t(pi.prototype,"bounds",[ri],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),bi=t(pi.prototype,"transition",[ai],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),fi=t(pi.prototype,"debugMode",[li],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ui=pi))||ui));i("DEFAULT_CAMERA_CONFIG",((hi=new Di).isometric.distance=25,hi.isometric.height=0,hi.isometric.angle=-45,hi.isometric.fov=45,hi.isometric.yawAngle=-45,hi.isometric.allowRotation=!0,hi.isometric.rotationSpeed=2,hi.topDown.height=30,hi.topDown.fov=60,hi.topDown.allowZoom=!0,hi.topDown.minHeight=15,hi.topDown.maxHeight=50,hi.topDown.zoomSpeed=5,hi.bounds.min=new r(-50,0,-50),hi.bounds.max=new r(50,100,50),hi.bounds.enabled=!1,hi.transition.positionDuration=1,hi.transition.rotationDuration=.8,hi.transition.easing="quartOut",hi.debugMode=!0,hi));o._RF.pop()}}}));

System.register("chunks:///_virtual/CameraController.ts",["./rollupPluginModLoBabelHelpers.js","cc","./CameraConfig.ts","./BaseCameraController.ts","./EventBus.ts","./EventTypes.ts"],(function(t){var e,i,n,o,s,a,r,u,h,c,l,g,_,f,d,p,m,M,w,y,D,T,b;return{setters:[function(t){e=t.applyDecoratedDescriptor,i=t.inheritsLoose,n=t.initializerDefineProperty,o=t.assertThisInitialized,s=t.createClass},function(t){a=t.cclegacy,r=t._decorator,u=t.Vec3,h=t.Quat,c=t.director,l=t.tween,g=t.input,_=t.Input,f=t.KeyCode},function(t){d=t.IsometricConfig,p=t.TopDownConfig,m=t.TransitionConfig,M=t.CameraBounds,w=t.CameraMode,y=t.CameraConfig},function(t){D=t.BaseCameraController},function(t){T=t.EventBus},function(t){b=t.EventTypes}],execute:function(){var C,I,O,v,S,k,E,R,A,L,x,P,F,Y,K,N,z,W;a._RF.push({},"8b428FfN7JCR4ldT//dm3Od","CameraController",void 0);var U=r.ccclass,B=r.property,q=t("CameraController",(C=U("CameraController"),I=B({type:d,displayName:"等距视角配置"}),O=B({type:p,displayName:"俯视视角配置"}),v=B({type:m,displayName:"过渡动画配置"}),S=B({type:M,displayName:"边界限制配置"}),k=B({displayName:"调试模式",tooltip:"是否启用调试模式显示"}),E=B({displayName:"自动查找相机",tooltip:"是否自动查找Main Camera节点"}),R=B({displayName:"启用右键拖拽旋转",tooltip:"是否允许右键拖拽旋转相机（默认关闭）"}),C(((W=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];return e=t.call.apply(t,[this].concat(s))||this,n(e,"isometricConfig",x,o(e)),n(e,"topDownConfig",P,o(e)),n(e,"transitionConfig",F,o(e)),n(e,"boundsConfig",Y,o(e)),n(e,"debugMode",K,o(e)),n(e,"autoFindCamera",N,o(e)),n(e,"enableRightDragRotate",z,o(e)),e._config=null,e._currentMode=w.NONE,e._targetPosition=new u,e._targetRotation=new h,e._isTransitioning=!1,e._lookAtTarget=new u(0,0,0),e._runtimeYawOffset=0,e._runtimeDistanceOffset=0,e._runtimeHeightOffset=0,e._keyStates={w:!1,a:!1,s:!1,d:!1},e._mouseDragState={isDragging:!1,lastMousePos:new u(0,0,0),dragButton:-1},e._positionTween=null,e._rotationTween=null,e}i(e,t),e.getInstance=function(){return e._instance},e.getMainCamera=function(){var t=e.getInstance();return t?t.getMainCamera():null};var a=e.prototype;return a.onLoad=function(){if(null!==e._instance)return console.warn("[CameraController] 多个CameraController实例，销毁重复实例"),void this.destroy();e._instance=this,c.addPersistRootNode(this.node),t.prototype.onLoad.call(this)},a.onCameraStart=function(){this.setMode(w.ISOMETRIC),this._setupEventListeners(),this.debugLog("已设置为默认模式: "+this._currentMode)},a.onCameraEnable=function(){this.debugLog("主相机控制器已启用")},a.onCameraDisable=function(){this.debugLog("主相机控制器已禁用")},a.onCameraUpdate=function(t){this.camera&&(this.enableInputControl&&this._handleInput(t),this.config.debugMode&&this._updateDebugInfo())},a.onCameraDestroy=function(){e._instance===this&&(e._instance=null),this._stopAllTweens(),this._removeEventListeners()},a.onResetToDefault=function(){this.setMode(w.ISOMETRIC,!0),this._lookAtTarget.set(0,0,0),this._stopAllTweens()},a.getCamera=function(){return this.camera},a.getMainCamera=function(){return this.camera},a.setMode=function(t,e){if(void 0===e&&(e=!1),this._currentMode!==t||e){var i=this._currentMode;this._currentMode=t,this._runtimeYawOffset=0,this._runtimeDistanceOffset=0,this._runtimeHeightOffset=0,this.debugLog("切换相机模式: "+i+" -> "+t),this._applyModeSettings(t,e),T.emit(b.System.CameraModeChanged,{oldMode:i,newMode:t})}},a.setLookAtTarget=function(t,e){var i=this;void 0===e&&(e=!1),this.debugLog("设置相机注视目标: ("+t.x.toFixed(2)+", "+t.y.toFixed(2)+", "+t.z.toFixed(2)+"), smooth: "+e),e?l(this._lookAtTarget).to(.5,t,{easing:"sineInOut",onUpdate:function(){i._currentMode===w.ISOMETRIC?i._applyIsometricMode(!0):i._currentMode===w.TOP_DOWN&&i._applyTopDownMode(!0)}}).start():(this._lookAtTarget.set(t),this._currentMode===w.ISOMETRIC?this._applyIsometricMode(!0):this._currentMode===w.TOP_DOWN&&this._applyTopDownMode(!0))},a.lookAt=function(t,e){void 0===e&&(e=!1),this._lookAtTarget.set(t),e?this._applyLookAt():this._transitionToLookAt()},a.moveTo=function(t,e){var i=this,n=e||this.config.transition.positionDuration;this._stopPositionTween(),this._positionTween=l(this.node.position).to(n,t,{easing:this._getEasingFunction()}).call((function(){i._positionTween=null})).start(),this._isTransitioning=!0},a.getCameraState=function(){var t=this.node.getPosition(),e=this.node.getRotation(),i=new u;return e.getEulerAngles(i),{currentMode:this._currentMode,position:t.clone(),rotation:i,target:this._lookAtTarget.clone(),isTransitioning:this._isTransitioning,lastUpdateTime:Date.now()}},a._setupEventListeners=function(){this.enableInputControl&&(g.on(_.EventType.KEY_DOWN,this.onKeyDown,this),g.on(_.EventType.KEY_UP,this.onKeyUp,this),T.on(b.Input3D.MouseDown,this.onMouseDown,this),T.on(b.Input3D.MouseUp,this.onMouseUp,this),T.on(b.Input3D.MouseMove,this.onMouseMove,this),T.on(b.Input3D.MouseWheel,this.onMouseWheel,this))},a._removeEventListeners=function(){this.enableInputControl&&(g.off(_.EventType.KEY_DOWN,this.onKeyDown,this),g.off(_.EventType.KEY_UP,this.onKeyUp,this),T.off(b.Input3D.MouseDown,this.onMouseDown,this),T.off(b.Input3D.MouseUp,this.onMouseUp,this),T.off(b.Input3D.MouseMove,this.onMouseMove,this),T.off(b.Input3D.MouseWheel,this.onMouseWheel,this))},a._applyModeSettings=function(t,e){switch(t){case w.ISOMETRIC:this._applyIsometricMode(e);break;case w.TOP_DOWN:this._applyTopDownMode(e)}},a._applyIsometricMode=function(t){var e=this.config.isometric,i=new u(e.angle,e.yawAngle+this._runtimeYawOffset,0),n=new h;h.fromEuler(n,i.x,i.y,i.z);var o=new u(0,0,-1),s=new u;u.transformQuat(s,o,n);var a=new u,r=e.distance+this._runtimeDistanceOffset;u.multiplyScalar(a,s,r),a.y+=e.height;var c=new u;c=u.subtract(c,this._lookAtTarget,a),this.camera&&(this.camera.fov=e.fov),t?(this.node.setPosition(c),this.node.setRotationFromEuler(i)):this._transitionToPositionAndRotation(c,i)},a._applyTopDownMode=function(t){var e=this.config.topDown,i=e.height+this._runtimeHeightOffset,n=new u(this._lookAtTarget.x,this._lookAtTarget.y+i,this._lookAtTarget.z),o=new u(-90,0,0);this.camera&&(this.camera.fov=e.fov),t?(this.node.setPosition(n),this.node.setRotationFromEuler(o)):this._transitionToPositionAndRotation(n,o)},a._transitionToPositionAndRotation=function(t,e){var i=this;this._stopAllTweens(),this._isTransitioning=!0,this._positionTween=l(this.node.position).to(this.config.transition.positionDuration,t,{easing:this._getEasingFunction()}).call((function(){i._positionTween=null,i._checkTransitionComplete()})).start();var n=new u;this.node.rotation.getEulerAngles(n),this._rotationTween=l(n).to(this.config.transition.rotationDuration,e,{easing:this._getEasingFunction(),onUpdate:function(){i.node.setRotationFromEuler(n.x,n.y,n.z)}}).call((function(){i._rotationTween=null,i._checkTransitionComplete()})).start()},a._transitionToLookAt=function(){this._applyModeSettings(this._currentMode,!1)},a._applyLookAt=function(){this._applyModeSettings(this._currentMode,!0)},a._checkTransitionComplete=function(){this._positionTween||this._rotationTween||(this._isTransitioning=!1)},a._stopAllTweens=function(){this._stopPositionTween(),this._stopRotationTween()},a._stopPositionTween=function(){this._positionTween&&(this._positionTween.stop(),this._positionTween=null)},a._stopRotationTween=function(){this._rotationTween&&(this._rotationTween.stop(),this._rotationTween=null)},a._getEasingFunction=function(){var t,e=(this.config.transition.easing||"").trim();if(new Set(["linear","quadIn","quadOut","quadInOut","cubicIn","cubicOut","cubicInOut","quartIn","quartOut","quartInOut","quintIn","quintOut","quintInOut","sineIn","sineOut","sineInOut","expoIn","expoOut","expoInOut","circIn","circOut","circInOut","elasticIn","elasticOut","elasticInOut","backIn","backOut","backInOut","bounceIn","bounceOut","bounceInOut"]).has(e))return e;return null!=(t={linear:"linear",ease:"sineInOut","ease-in":"sineIn","ease-out":"sineOut","ease-in-out":"sineInOut",easein:"sineIn",easeout:"sineOut",easeinout:"sineInOut"}[e])?t:"quartOut"},a._handleInput=function(t){if(this.enableInputControl){var e=!1,i=new u(0,0,0);if(this._keyStates.w&&(i.z-=1),this._keyStates.s&&(i.z+=1),this._keyStates.a&&(i.x-=1),this._keyStates.d&&(i.x+=1),i.lengthSqr()>0){var n=this.node.eulerAngles.y,o=new h;h.fromEuler(o,0,n,0);var s=new u;u.transformQuat(s,i,o),s.normalize(),u.multiplyScalar(s,s,15*t),u.add(this._lookAtTarget,this._lookAtTarget,s),e=!0}e&&this._applyModeSettings(this._currentMode,!0)}},a.onKeyDown=function(t){switch(t.keyCode){case f.KEY_W:this._keyStates.w=!0;break;case f.KEY_A:this._keyStates.a=!0;break;case f.KEY_S:this._keyStates.s=!0;break;case f.KEY_D:this._keyStates.d=!0}switch(t.keyCode){case f.F1:this.setMode(w.ISOMETRIC);break;case f.F2:this.setMode(w.TOP_DOWN)}},a.onKeyUp=function(t){switch(t.keyCode){case f.KEY_W:this._keyStates.w=!1;break;case f.KEY_A:this._keyStates.a=!1;break;case f.KEY_S:this._keyStates.s=!1;break;case f.KEY_D:this._keyStates.d=!1}},a.onMouseDown=function(t){1===t.button?(this._mouseDragState.isDragging=!0,this._mouseDragState.dragButton=1,this._mouseDragState.lastMousePos.set(t.screenX,t.screenY,0),this.debugLog("中键按下，开始拖拽移动")):2===t.button&&this.enableRightDragRotate&&(this._mouseDragState.isDragging=!0,this._mouseDragState.dragButton=2,this._mouseDragState.lastMousePos.set(t.screenX,t.screenY,0),this.debugLog("右键按下，开始拖拽旋转"))},a.onMouseDrag=function(t){this.enableRightDragRotate&&this._currentMode===w.ISOMETRIC&&this.config.isometric.allowRotation&&(this._runtimeYawOffset+=t.x*this.config.isometric.rotationSpeed*.1,this._applyModeSettings(this._currentMode,!0))},a.onMouseUp=function(t){this._mouseDragState.isDragging&&(this.debugLog("鼠标松开，结束拖拽 (按钮: "+this._mouseDragState.dragButton+")"),this._mouseDragState.isDragging=!1,this._mouseDragState.dragButton=-1)},a.onMouseMove=function(t){if(this._mouseDragState.isDragging){var e=new u(t.screenX,t.screenY,0),i=new u;u.subtract(i,e,this._mouseDragState.lastMousePos),1===this._mouseDragState.dragButton?this._handleMouseDragMovement(i):2===this._mouseDragState.dragButton&&this.enableRightDragRotate&&this._handleMouseDragRotation(i),this._mouseDragState.lastMousePos.set(e)}},a.onMouseWheel=function(t){var e=t.scrollDelta;if(e){var i=e.y;this.debugLog("鼠标滚轮事件: scrollY="+i+", 当前模式="+this._currentMode);var n=.1*Math.max(-1,Math.min(1,i));if(this.debugLog("限制后的 scrollY: "+n),this._currentMode===w.TOP_DOWN&&this.config.topDown.allowZoom){var o=this.config.topDown,s=this._runtimeHeightOffset-n*o.zoomSpeed,a=o.height+s;this.debugLog("俯视模式缩放: 当前高度偏移="+this._runtimeHeightOffset+", 新高度偏移="+s+", 实际高度="+a),a>=o.minHeight&&a<=o.maxHeight?(this._runtimeHeightOffset=s,this._applyModeSettings(this._currentMode,!0),this.debugLog("俯视模式缩放成功: 新高度="+a)):this.debugLog("俯视模式缩放被限制: 高度="+a+" 超出范围 ["+o.minHeight+", "+o.maxHeight+"]")}else if(this._currentMode===w.ISOMETRIC){var r=this.config.isometric,u=this._runtimeDistanceOffset-5*n,h=r.distance+u;this.debugLog("等距模式缩放: 当前距离偏移="+this._runtimeDistanceOffset+", 新距离偏移="+u+", 实际距离="+h);h>=5&&h<=50?(this._runtimeDistanceOffset=u,this._applyModeSettings(this._currentMode,!0),this.debugLog("等距模式缩放成功: 新距离="+h)):this.debugLog("等距模式缩放被限制: 距离="+h+" 超出范围 [5, 50]")}else this.debugLog("当前模式不支持缩放: 模式="+this._currentMode+", 俯视模式允许缩放="+this.config.topDown.allowZoom)}else console.warn("[CameraController] 鼠标滚轮事件缺少 scrollDelta 数据")},a._updateDebugInfo=function(){},a._handleMouseDragMovement=function(t){var e=.1;(this._currentMode===w.ISOMETRIC||this._currentMode===w.TOP_DOWN)&&(e=.05);var i=new u(-t.x*e,0,t.y*e);if(this.debugLog("鼠标拖拽移动: deltaPos=("+t.x.toFixed(2)+", "+t.y.toFixed(2)+"), moveVector=("+i.x.toFixed(2)+", "+i.y.toFixed(2)+", "+i.z.toFixed(2)+")"),i.lengthSqr()>0){var n=this.node.eulerAngles.y,o=new h;h.fromEuler(o,0,n,0);var s=new u;u.transformQuat(s,i,o),u.add(this._lookAtTarget,this._lookAtTarget,s),this._applyModeSettings(this._currentMode,!0)}},a._handleMouseDragRotation=function(t){if(this.enableRightDragRotate&&this._currentMode===w.ISOMETRIC&&this.config.isometric.allowRotation){var e=.02*this.config.isometric.rotationSpeed;this._runtimeYawOffset+=t.x*e,this._applyModeSettings(this._currentMode,!0),this.debugLog("鼠标拖拽旋转: deltaX="+t.x.toFixed(2)+", 新Yaw偏移="+this._runtimeYawOffset.toFixed(2))}},s(e,[{key:"config",get:function(){return this._config||(this._config=new y,this._config.isometric=this.isometricConfig,this._config.topDown=this.topDownConfig,this._config.bounds=this.boundsConfig,this._config.transition=this.transitionConfig,this._config.debugMode=this.debugMode),this._config}}]),e}(D))._instance=null,x=e((L=W).prototype,"isometricConfig",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),P=e(L.prototype,"topDownConfig",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),F=e(L.prototype,"transitionConfig",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new m}}),Y=e(L.prototype,"boundsConfig",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new M}}),K=e(L.prototype,"debugMode",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N=e(L.prototype,"autoFindCamera",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),z=e(L.prototype,"enableRightDragRotate",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A=L))||A));t("cameraController",{get instance(){return q.getInstance()},getMainCamera:function(){return q.getMainCamera()}});a._RF.pop()}}}));

System.register("chunks:///_virtual/CameraDebugger.ts",["./rollupPluginModLoBabelHelpers.js","cc","./CameraController.ts","./CameraConfig.ts","./CameraManager.ts","./VoxelCameraConfig.ts","./EventBus.ts","./EventTypes.ts"],(function(e){var a,t,n,r,o,i,s,l,u,c,g,h,m,d,b,C,_,f,p,M,D,y,T,w,I;return{setters:[function(e){a=e.applyDecoratedDescriptor,t=e.inheritsLoose,n=e.initializerDefineProperty,r=e.assertThisInitialized,o=e.asyncToGenerator,i=e.regeneratorRuntime},function(e){s=e.cclegacy,l=e._decorator,u=e.input,c=e.Input,g=e.director,h=e.Node,m=e.UITransform,d=e.Label,b=e.Color,C=e.Vec3,_=e.KeyCode,f=e.Component},function(e){p=e.CameraController},function(e){M=e.CameraMode},function(e){D=e.CameraManager,y=e.CameraControllerType},function(e){T=e.VoxelCameraMode},function(e){w=e.EventBus},function(e){I=e.EventTypes}],execute:function(){var P,v,N,x,L,E,G,A,O,F,S,K,V;s._RF.push({},"5bb123zfhlOwK9kJ437qXFz","CameraDebugger",void 0);var W=l.ccclass,k=l.property;e("CameraDebugger",(P=W("CameraDebugger"),v=k({displayName:"启用调试显示",tooltip:"是否显示调试信息"}),N=k({displayName:"启用键盘切换",tooltip:"是否允许通过键盘快捷键切换相机"}),x=k({displayName:"启用相机演示",tooltip:"是否启用自动相机切换演示"}),L=k({displayName:"调试信息位置",tooltip:"调试信息显示位置"}),E=k({displayName:"更新频率(秒)",tooltip:"调试信息更新频率"}),P((O=a((A=function(e){function a(){for(var a,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];return a=e.call.apply(e,[this].concat(o))||this,n(a,"enableDebugDisplay",O,r(a)),n(a,"enableKeyboardSwitching",F,r(a)),n(a,"enableCameraDemo",S,r(a)),n(a,"debugPosition",K,r(a)),n(a,"updateInterval",V,r(a)),a._debugPanel=null,a._debugLabel=null,a._updateTimer=0,a._cameraController=null,a._cameraManager=null,a}t(a,e);var s=a.prototype;return s.onLoad=function(){this.enableDebugDisplay&&this._createDebugUI()},s.start=function(){var e=this;this._cameraController=p.getInstance(),this._cameraManager=D.getInstance(),this._cameraManager?(w.on(I.System.CameraModeChanged,this._onCameraModeChanged,this),console.log("[CameraDebugger] 相机调试器初始化完成"),this.enableCameraDemo&&this.scheduleOnce((function(){e.demonstrateCameraSwitching()}),2)):console.warn("[CameraDebugger] 无法找到CameraManager实例")},s.onEnable=function(){this.enableKeyboardSwitching&&u.on(c.EventType.KEY_DOWN,this.onKeyDown,this)},s.onDisable=function(){u.off(c.EventType.KEY_DOWN,this.onKeyDown,this)},s.update=function(e){this.enableDebugDisplay&&this._debugLabel&&this._cameraManager&&(this._updateTimer+=e,this._updateTimer>=this.updateInterval&&(this._updateDebugInfo(),this._updateTimer=0))},s.onDestroy=function(){this._debugPanel&&this._debugPanel.destroy(),w.off(I.System.CameraModeChanged,this._onCameraModeChanged,this)},s.toggleDebugDisplay=function(){this.enableDebugDisplay=!this.enableDebugDisplay,this._debugPanel&&(this._debugPanel.active=this.enableDebugDisplay)},s.setDebugPosition=function(e){this.debugPosition=e,this._updateDebugPanelPosition()},s.switchToMainGameCamera=function(e){(void 0===e&&(e=M.ISOMETRIC),this._cameraManager)&&(this._cameraManager.switchToController(y.MAIN_GAME)&&(this._cameraManager.setMainGameCameraMode(e),console.log("[CameraDebugger] 切换到主游戏相机 - "+e)))},s.switchToVoxelCamera=function(e){(void 0===e&&(e=T.WALKING),this._cameraManager)&&(this._cameraManager.switchToController(y.VOXEL_WORLD)&&(this._cameraManager.setVoxelCameraMode(e),console.log("[CameraDebugger] 切换到体素相机 - "+e)))},s.toggleCameraController=function(){this._cameraManager&&(this._cameraManager.getActiveControllerType()===y.MAIN_GAME?this.switchToVoxelCamera():this.switchToMainGameCamera())},s.switchCameraForGameScene=function(e){this._cameraManager&&(this._cameraManager.switchCameraByGameMode(e)&&console.log("[CameraDebugger] 为 "+e+" 场景切换相机成功"))},s.getCurrentCameraInfo=function(){if(this._cameraManager){var e=this._cameraManager.getActiveController(),a=this._cameraManager.getActiveControllerType(),t=this._cameraManager.getRegisteredControllerTypes();console.log("[CameraDebugger] 当前相机信息:"),console.log("  - 活跃控制器类型: "+a),console.log("  - 活跃控制器: "+(e?"存在":"不存在")),console.log("  - 已注册控制器: ["+t.join(", ")+"]")}},s.demonstrateCameraSwitching=function(){var e=o(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._cameraManager){e.next=2;break}return e.abrupt("return");case 2:return console.log("[CameraDebugger] 开始相机切换演示..."),this.switchToMainGameCamera(M.ISOMETRIC),e.next=6,this.delay(2e3);case 6:return this.switchToMainGameCamera(M.TOP_DOWN),e.next=9,this.delay(2e3);case 9:return this.switchToVoxelCamera(T.WALKING),e.next=12,this.delay(2e3);case 12:return this.switchToVoxelCamera(T.FLYING),e.next=15,this.delay(2e3);case 15:console.log("[CameraDebugger] 相机切换演示完成");case 16:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),s._createDebugUI=function(){var e=g.getScene();if(e){var a=e.getChildByName("Canvas");if(a){this._debugPanel=new h("CameraDebugPanel"),this._debugPanel.addComponent(m);var t=new h("DebugLabel");t.addComponent(m),this._debugLabel=t.addComponent(d),this._debugLabel.string="相机调试信息",this._debugLabel.fontSize=12,this._debugLabel.color=b.WHITE,this._debugLabel.overflow=d.Overflow.NONE,this._debugPanel.layer=a.layer,t.layer=a.layer,this._debugPanel.addChild(t),a.addChild(this._debugPanel),this._updateDebugPanelPosition(),console.log("[CameraDebugger] 调试UI创建完成")}else console.warn("[CameraDebugger] 无法找到Canvas节点")}},s._updateDebugPanelPosition=function(){if(this._debugPanel){var e=this._debugPanel.getComponent(m);if(e)switch(this.debugPosition){case"top-left":e.setAnchorPoint(0,1),this._debugPanel.setPosition(-400,300,0);break;case"top-right":e.setAnchorPoint(1,1),this._debugPanel.setPosition(400,300,0);break;case"bottom-left":e.setAnchorPoint(0,0),this._debugPanel.setPosition(-400,-300,0);break;case"bottom-right":e.setAnchorPoint(1,0),this._debugPanel.setPosition(400,-300,0)}}},s._updateDebugInfo=function(){if(this._cameraManager&&this._debugLabel){var e=this._cameraManager.getActiveController(),a=this._cameraManager.getActiveControllerType(),t=this._cameraManager.getMainCamera(),n="=== 相机调试信息 ===\n";if(n+="控制器类型: "+this._getControllerTypeName(a)+"\n",t){var r=t.node.getWorldPosition(),o=t.node.getWorldRotation(),i=new C;o.getEulerAngles(i),n+="位置: ("+r.x.toFixed(2)+", "+r.y.toFixed(2)+", "+r.z.toFixed(2)+")\n",n+="旋转: ("+(180*i.x/Math.PI).toFixed(1)+"°, "+(180*i.y/Math.PI).toFixed(1)+"°, "+(180*i.z/Math.PI).toFixed(1)+"°)\n",n+="FOV: "+t.fov.toFixed(1)+"°\n"}if(a===y.MAIN_GAME&&this._cameraController){var s=this._cameraController.getCameraState();n+="主游戏模式: "+this._getCameraModeName(s.currentMode)+"\n",s.target&&(n+="目标: ("+s.target.x.toFixed(2)+", "+s.target.y.toFixed(2)+", "+s.target.z.toFixed(2)+")\n"),n+="过渡中: "+(s.isTransitioning?"是":"否")+"\n"}else if(a===y.VOXEL_WORLD){var l=e;l&&l.getCurrentMode&&(n+="体素模式: "+this._getVoxelModeName(l.getCurrentMode())+"\n")}n+="\n=== 快捷键 ===\n",n+="1: 主游戏-等距视角\n",n+="2: 主游戏-俯视图\n",n+="3: 主游戏-第三人称\n",n+="4: 体素-行走模式\n",n+="5: 体素-飞行模式\n",n+="M: 切换控制器\n",n+="D: 演示切换",this._debugLabel.string=n}},s.onKeyDown=function(e){if(this._cameraManager)switch(e.keyCode){case _.DIGIT_1:this.switchToMainGameCamera(M.ISOMETRIC);break;case _.DIGIT_2:this.switchToMainGameCamera(M.TOP_DOWN);break;case _.DIGIT_4:this.switchToVoxelCamera(T.WALKING);break;case _.DIGIT_5:this.switchToVoxelCamera(T.FLYING);break;case _.KEY_M:this.toggleCameraController();break;case _.KEY_D:this.enableCameraDemo&&this.demonstrateCameraSwitching()}},s.delay=function(e){return new Promise((function(a){return setTimeout(a,e)}))},s._getControllerTypeName=function(e){switch(e){case y.MAIN_GAME:return"主游戏相机";case y.VOXEL_WORLD:return"体素相机";default:return"未知类型"}},s._getCameraModeName=function(e){switch(e){case M.ISOMETRIC:return"等距视角";case M.TOP_DOWN:return"俯视视角";default:return"未知模式"}},s._getVoxelModeName=function(e){switch(e){case T.WALKING:return"行走模式";case T.FLYING:return"飞行模式";default:return"未知模式"}},s._onCameraModeChanged=function(e){console.log("[CameraDebugger] 相机控制器变化: "+this._getControllerTypeName(e.controllerType)),this._updateDebugInfo()},a}(f)).prototype,"enableDebugDisplay",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),F=a(A.prototype,"enableKeyboardSwitching",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S=a(A.prototype,"enableCameraDemo",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K=a(A.prototype,"debugPosition",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"top-left"}}),V=a(A.prototype,"updateInterval",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),G=A))||G));s._RF.pop()}}}));

System.register("chunks:///_virtual/CameraManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./CameraController.ts","./VoxelCameraController.ts","./EventBus.ts","./EventTypes.ts"],(function(e){var t,n,r,o,a,i,s,l,c,u,m,C,g,h;return{setters:[function(e){t=e.applyDecoratedDescriptor,n=e.inheritsLoose,r=e.initializerDefineProperty,o=e.assertThisInitialized},function(e){a=e.cclegacy,i=e._decorator,s=e.Node,l=e.director,c=e.Camera,u=e.Component},function(e){m=e.CameraController},function(e){C=e.VoxelCameraController},function(e){g=e.EventBus},function(e){h=e.EventTypes}],execute:function(){var _,d,f,M,p,v,y,E;a._RF.push({},"cac15mSkTZJGJQhCuXQHUMc","CameraManager",void 0);var T=i.ccclass,L=i.property,b=e("CameraControllerType",function(e){return e.MAIN_GAME="main_game",e.VOXEL_WORLD="voxel_world",e.CUSTOM="custom",e}({})),G=e("CameraManager",(_=T("CameraManager"),d=L({displayName:"相机管理器配置",tooltip:"相机管理器的配置参数"}),f=L({type:s,displayName:"主相机节点",tooltip:"主相机所在的节点"}),_(((E=function(e){function t(){for(var t,n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return t=e.call.apply(e,[this].concat(a))||this,r(t,"config",v,o(t)),r(t,"mainCameraNode",y,o(t)),t._controllers=new Map,t._activeController=null,t._activeControllerType=b.MAIN_GAME,t._mainCamera=null,t}n(t,e),t.getInstance=function(){return t._instance},t.getMainCamera=function(){var e=t.getInstance();return e?e.getMainCamera():null};var a=t.prototype;return a.onLoad=function(){if(null!==t._instance)return console.warn("[CameraManager] 多个CameraManager实例，销毁重复实例"),void this.destroy();t._instance=this,l.addPersistRootNode(this.node),this._setupMainCamera(),this._registerDefaultControllers(),console.log("[CameraManager] 相机管理器初始化完成")},a.start=function(){this.switchToController(this.config.defaultControllerType),this._setupEventListeners(),console.log("[CameraManager] 当前相机控制器: "+this._activeControllerType)},a.onDestroy=function(){t._instance===this&&(t._instance=null),this._controllers.clear(),this._removeEventListeners()},a.getMainCamera=function(){return this._mainCamera},a.registerController=function(e,t){this._controllers.set(e,t),this.debugLog("注册相机控制器: "+e)},a.unregisterController=function(e){this._controllers.has(e)&&(this._controllers.delete(e),this.debugLog("取消注册相机控制器: "+e))},a.switchToController=function(e){var t=this._controllers.get(e);return t?(this._activeController===t||(this._activeController&&this._activeController.setEnabled(!1),this._activeController=t,this._activeControllerType=e,this._activeController.setEnabled(!0),this.debugLog("切换到相机控制器: "+e),g.emit(h.System.CameraModeChanged,{controllerType:e,controller:t})),!0):(console.error("[CameraManager] 相机控制器不存在: "+e),!1)},a.getActiveController=function(){return this._activeController},a.getActiveControllerType=function(){return this._activeControllerType},a.switchCameraByGameMode=function(e){var t;switch(e){case"voxel":case"minecraft":case"block_building":t=b.VOXEL_WORLD;break;case"monopoly":case"board_game":case"strategy":default:t=b.MAIN_GAME}return this.switchToController(t)},a.setMainGameCameraMode=function(e){var t=this._controllers.get(b.MAIN_GAME);t&&t.setMode&&t.setMode(e)},a.setVoxelCameraMode=function(e){var t=this._controllers.get(b.VOXEL_WORLD);t&&t.setMode&&t.setMode(e)},a.getRegisteredControllerTypes=function(){return Array.from(this._controllers.keys())},a._setupMainCamera=function(){if(this.mainCameraNode&&(this._mainCamera=this.mainCameraNode.getComponent(c)),!this._mainCamera){var e,t=null==(e=this.node.scene)?void 0:e.getChildByName("Main Camera");t&&(this._mainCamera=t.getComponent(c))}this._mainCamera?console.log("[CameraManager] 主相机设置完成"):console.error("[CameraManager] 无法找到主相机！")},a._registerDefaultControllers=function(){var e=l.getScene();if(e){var t=e.getComponentInChildren(m);t&&this.registerController(b.MAIN_GAME,t);var n=e.getComponentInChildren(C);n&&this.registerController(b.VOXEL_WORLD,n)}},a._setupEventListeners=function(){g.on(h.Game.GameStart,this._onGameModeChange,this)},a._removeEventListeners=function(){g.off(h.Game.GameStart,this._onGameModeChange,this)},a._onGameModeChange=function(e){this.config.autoSwitchCamera&&e.mode&&this.switchCameraByGameMode(e.mode)},a.debugLog=function(e){this.config.debugMode&&console.log("[CameraManager] "+e)},t}(u))._instance=null,v=t((p=E).prototype,"config",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{defaultControllerType:b.MAIN_GAME,autoSwitchCamera:!0,debugMode:!0,transitionDuration:1}}}),y=t(p.prototype,"mainCameraNode",[f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=p))||M));e("cameraManager",{get instance(){return G.getInstance()},getMainCamera:function(){return G.getMainCamera()},switchToMainGameCamera:function(){var e=G.getInstance();return!!e&&e.switchToController(b.MAIN_GAME)},switchToVoxelCamera:function(){var e=G.getInstance();return!!e&&e.switchToController(b.VOXEL_WORLD)}});a._RF.pop()}}}));

System.register("chunks:///_virtual/Card.ts",["cc"],(function(t){var e;return{setters:[function(t){e=t.cclegacy}],execute:function(){e._RF.push({},"0c7c4EDJp1HU76sqNWrNwKD","Card",void 0);var r=t("CardTargetType",function(t){return t[t.NONE=0]="NONE",t[t.PLAYER=1]="PLAYER",t[t.TILE=2]="TILE",t[t.PLAYER_OR_TILE=3]="PLAYER_OR_TILE",t}({})),i=t("CardRarity",function(t){return t[t.COMMON=0]="COMMON",t[t.RARE=1]="RARE",t[t.EPIC=2]="EPIC",t[t.LEGENDARY=3]="LEGENDARY",t}({}));t("Card",function(){function t(t,e,r,i,n,a){this.kind=void 0,this.name=void 0,this.description=void 0,this.targetType=void 0,this.value=void 0,this.rarity=void 0,this.kind=t,this.name=e,this.description=r,this.targetType=i,this.value=n,this.rarity=a}t.loadFromFields=function(e){return new t(Number(e.kind),this.decodeString(e.name),this.decodeString(e.description),Number(e.target_type),BigInt(e.value||0),Number(e.rarity))},t.decodeString=function(t){if("string"==typeof t)return t;if(Array.isArray(t))try{return String.fromCharCode.apply(String,t)}catch(e){return console.warn("[Card] Failed to decode string from bytes:",t),""}return""};var e=t.prototype;return e.needsTarget=function(){return this.targetType!==r.NONE},e.needsPlayerTarget=function(){return this.targetType===r.PLAYER||this.targetType===r.PLAYER_OR_TILE},e.needsTileTarget=function(){return this.targetType===r.TILE||this.targetType===r.PLAYER_OR_TILE},e.getTargetTypeName=function(){switch(this.targetType){case r.NONE:return"无目标";case r.PLAYER:return"玩家";case r.TILE:return"地块";case r.PLAYER_OR_TILE:return"玩家或地块";default:return"未知"}},e.getRarityName=function(){switch(this.rarity){case i.COMMON:return"普通";case i.RARE:return"稀有";case i.EPIC:return"史诗";case i.LEGENDARY:return"传说";default:return"未知"}},e.getRarityColor=function(){switch(this.rarity){case i.COMMON:return"#FFFFFF";case i.RARE:return"#0070DD";case i.EPIC:return"#A335EE";case i.LEGENDARY:return"#FF8000";default:return"#CCCCCC"}},e.toString=function(){return"[Card] "+this.name+" ("+this.kind+") - "+this.description+" ["+this.getRarityName()+"]"},e.debugInfo=function(){return JSON.stringify({kind:this.kind,name:this.name,description:this.description,targetType:this.getTargetTypeName(),value:this.value.toString(),rarity:this.getRarityName()},null,2)},t}());e._RF.pop()}}}));

System.register("chunks:///_virtual/Card2.ts",["./rollupPluginModLoBabelHelpers.js","cc","./CardConfig.ts"],(function(t){var n,i,r;return{setters:[function(t){n=t.createClass},function(t){i=t.cclegacy},function(t){r=t.CardConfigManager}],execute:function(){i._RF.push({},"7201fL+5W9GIq/jbBPiw+5q","Card",void 0);t("Card",function(){function t(t,n){this.kind=void 0,this.count=void 0,this.config=void 0,this.kind=t,this.count=n,this.config=r.getConfig(t)}t.fromEntry=function(n,i){return new t(n,i)};var i=t.prototype;return i.needsTarget=function(){return 0!==this.targetType},i.getRarityName=function(){return["n","\0\t","��"][this.rarity]||"*�"},n(t,[{key:"name",get:function(){var t;return(null==(t=this.config)?void 0:t.name)||"*�aL("+this.kind+")"}},{key:"description",get:function(){var t;return(null==(t=this.config)?void 0:t.description)||""}},{key:"iconPath",get:function(){var t;return(null==(t=this.config)?void 0:t.iconPath)||"web3/cards/default"}},{key:"rarity",get:function(){var t;return(null==(t=this.config)?void 0:t.rarity)||0}},{key:"targetType",get:function(){var t;return(null==(t=this.config)?void 0:t.targetType)||0}}]),t}());i._RF.pop()}}}));

System.register("chunks:///_virtual/CardConfig.ts",["cc"],(function(i){var e;return{setters:[function(i){e=i.cclegacy}],execute:function(){e._RF.push({},"9dda162L9ZEY6SIyyoiR2SK","CardConfig",void 0);var t=[{kind:0,name:"遥控骰子",description:"控制下一次骰子点数",targetType:0,value:3,rarity:0,iconPath:"web3/cards/move_ctrl"},{kind:1,name:"路障卡",description:"在地块上放置路障",targetType:2,value:0,rarity:0,iconPath:"web3/cards/barrier"},{kind:2,name:"炸弹卡",description:"在地块上放置炸弹",targetType:2,value:0,rarity:1,iconPath:"web3/cards/bomb"},{kind:3,name:"免租卡",description:"本回合避免支付租金",targetType:0,value:1,rarity:1,iconPath:"web3/cards/rent_free"},{kind:4,name:"冰冻卡",description:"冻结一个玩家一回合",targetType:1,value:1,rarity:2,iconPath:"web3/cards/freeze"},{kind:5,name:"恶犬卡",description:"在地块上放置恶犬",targetType:2,value:0,rarity:1,iconPath:"web3/cards/dog"},{kind:6,name:"净化卡",description:"移除地块上的NPC",targetType:2,value:0,rarity:0,iconPath:"web3/cards/cleanse"},{kind:7,name:"转向卡",description:"改变移动方向",targetType:0,value:0,rarity:0,iconPath:"web3/cards/turn"}],n=i("CardConfigManager",function(){function i(){}return i.initialize=function(){var i=this;this.initialized||(t.forEach((function(e){i.configs.set(e.kind,e)})),this.initialized=!0)},i.getConfig=function(i){return this.initialized||this.initialize(),this.configs.get(i)||null},i.getAllConfigs=function(){return this.initialized||this.initialize(),Array.from(this.configs.values())},i}());n.configs=new Map,n.initialized=!1,e._RF.pop()}}}));

System.register("chunks:///_virtual/CardManager.ts",["cc"],(function(){var e;return{setters:[function(r){e=r.cclegacy}],execute:function(){e._RF.push({},"c5503mamblD0ZasuSyHErx+","CardManager",void 0),e._RF.pop()}}}));

System.register("chunks:///_virtual/CardRegistry.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Card.ts"],(function(r){var t,e,n,i;return{setters:[function(r){t=r.createForOfIteratorHelperLoose},function(r){e=r.cclegacy},function(r){n=r.CardRarity,i=r.Card}],execute:function(){e._RF.push({},"d1e9e8dHGRPqK7oJCMx5mNM","CardRegistry",void 0);r("CardRegistry",function(){function r(r,t){this.id=void 0,this.cards=void 0,this.id=r,this.cards=t}r.loadFromFields=function(e){var n;console.log("[CardRegistry] 从 fields 加载数据",e);for(var s,a=(null==(n=e.id)?void 0:n.id)||e.id||"",o=e.cards||[],d=[],c=t(o);!(s=c()).done;){var l=s.value;try{var u=l.fields||l,g=i.loadFromFields(u);d.push(g)}catch(r){console.error("[CardRegistry] Failed to load card:",r)}}return console.log("[CardRegistry] 加载了 "+d.length+" 张卡牌"),new r(a,d)};var e=r.prototype;return e.getCard=function(r){return r>=0&&r<this.cards.length?this.cards[r]:null},e.hasCard=function(r){return r>=0&&r<this.cards.length},e.getAllCards=function(){return[].concat(this.cards)},e.getCardsByRarity=function(r){return this.cards.filter((function(t){return t.rarity===r}))},e.getCardsNeedingTarget=function(){return this.cards.filter((function(r){return r.needsTarget()}))},e.getCardCount=function(){return this.cards.length},e.searchCardByName=function(r){var t=r.toLowerCase();return this.cards.filter((function(r){return r.name.toLowerCase().includes(t)}))},e.printAllCards=function(){console.log("[CardRegistry] 共 "+this.cards.length+" 张卡牌:"),this.cards.forEach((function(r,t){console.log("  ["+t+"] "+r.toString())}))},e.debugInfo=function(){return JSON.stringify({id:this.id,cardCount:this.cards.length,cardsByRarity:{common:this.getCardsByRarity(n.COMMON).length,rare:this.getCardsByRarity(n.RARE).length,epic:this.getCardsByRarity(n.EPIC).length,legendary:this.getCardsByRarity(n.LEGENDARY).length}},null,2)},r}());e._RF.pop()}}}));

System.register("chunks:///_virtual/cards.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){r=e.cclegacy}],execute:function(){e({calculateCardDrop:function(e,r){if(0===e.length)return null;var n=e.reduce((function(e,t){return e+t.weight}),0);if(0===n)return null;for(var i,u=r%n,a=t(e);!(i=a()).done;){var c=i.value;if(u<c.weight)return c.kind;u-=c.weight}return e[e.length-1].kind},cardNeedsParam:function(e){return[0].includes(e)},cardNeedsTarget:function(e){return[1,2,4,5,6].includes(e)},getCardName:function(e){return{0:"遥控骰子",1:"路障卡",2:"炸弹卡",3:"免租卡",4:"冰冻卡",5:"恶犬卡",6:"机器娃娃",7:"转向卡"}[e]||"未知卡牌("+e+")"},validateCardParams:function(e,t){switch(e){case 0:return void 0!==t.dice_value&&t.dice_value>=1&&t.dice_value<=6;case 1:case 2:case 5:case 6:return void 0!==t.target_tile;case 4:return void 0!==t.target_player_idx;default:return!0}}}),r._RF.push({},"6813foywAtPlphgL43yrQ09","cards",void 0);e("CARD_EFFECTS",new Map([[0,{type:"movement",duration:0,description:"控制下次移动的骰子点数"}],[1,{type:"npc",duration:0,description:"在指定地块放置路障"}],[2,{type:"npc",duration:0,description:"在指定地块放置炸弹"}],[3,{type:"buff",duration:1,description:"下次经过地产免租金"}],[4,{type:"debuff",duration:2,description:"冻结目标玩家2回合"}],[5,{type:"npc",duration:0,description:"在指定地块放置恶犬"}],[6,{type:"buff",duration:0,description:"清除一段路上所有NPC"}],[7,{type:"movement",duration:0,description:"改变移动方向"}]]));r._RF.pop()}}}));

System.register("chunks:///_virtual/CompositeBlockRenderer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Web3BlockTypes.ts"],(function(e){var r,t,n,o,c,u,s,a,i,l,f;return{setters:[function(e){r=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){n=e.cclegacy,o=e.utils,c=e.gfx,u=e.MeshRenderer,s=e.Material,a=e.resources,i=e.EffectAsset,l=e.Texture2D},function(e){f=e.getWeb3BlockByBlockId}],execute:function(){n._RF.push({},"87401+W8SdPqru7O6EOQLAi","CompositeBlockRenderer",void 0);var d=e("CompositeBlockRenderer",function(){function e(){}return e.renderBlock=function(){var e=r(t().mark((function e(r,n,o){var c,s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===o&&(o=0),e.prev=1,f(n)){e.next=6;break}return console.warn("[CompositeBlockRenderer] Block not found: "+n),e.abrupt("return",!1);case 6:return c=this.createCubeMesh(),(s=r.addComponent(u)).mesh=c,e.next=11,this.createBlockMaterial(n,o);case 11:return(a=e.sent)&&(s.material=a),e.abrupt("return",!0);case 16:return e.prev=16,e.t0=e.catch(1),console.error("[CompositeBlockRenderer] Failed to render block "+n+":",e.t0),e.abrupt("return",!1);case 20:case"end":return e.stop()}}),e,this,[[1,16]])})));return function(r,t,n){return e.apply(this,arguments)}}(),e.createCubeMesh=function(){return o.createMesh({primitiveMode:c.PrimitiveMode.TRIANGLE_LIST,positions:this.getCubePositions(),normals:this.getCubeNormals(),uvs:this.getCubeUVs(),indices:this.getCubeIndices()})},e.getCubePositions=function(){return[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5]},e.getCubeNormals=function(){return[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]},e.getCubeUVs=function(){var e=[0,0,1,0,1,1,0,1];return[].concat(e,e,e,e,e,e)},e.getCubeIndices=function(){for(var e=[],r=0;r<6;r++){var t=4*r;e.push(t+0,t+1,t+2),e.push(t+0,t+2,t+3)}return e},e.createBlockMaterial=function(){var e=r(t().mark((function e(r,n){var o,c,u;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n=0),e.prev=1,e.next=4,this.getVoxelEffect();case 4:if(o=e.sent){e.next=8;break}return console.error("[CompositeBlockRenderer] Failed to load voxel shader"),e.abrupt("return",null);case 8:return e.next=10,this.loadBlockTexture(r);case 10:if(c=e.sent){e.next=14;break}return console.error("[CompositeBlockRenderer] Failed to load texture for "+r),e.abrupt("return",null);case 14:return(u=new s).initialize({effectAsset:o,technique:n}),u.setProperty("mainTexture",c),e.abrupt("return",u);case 20:return e.prev=20,e.t0=e.catch(1),console.error("[CompositeBlockRenderer] Failed to create material for "+r+":",e.t0),e.abrupt("return",null);case 24:case"end":return e.stop()}}),e,this,[[1,20]])})));return function(r,t){return e.apply(this,arguments)}}(),e.getVoxelEffect=function(){var e=r(t().mark((function e(){var r=this;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._cachedEffect){e.next=2;break}return e.abrupt("return",this._cachedEffect);case 2:return e.abrupt("return",new Promise((function(e){a.load("voxel/shaders/voxel-block",i,(function(t,n){if(t)return console.error("[CompositeBlockRenderer] Failed to load voxel shader:",t),void e(null);r._cachedEffect=n,e(n)}))})));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e.loadBlockTexture=function(){var e=r(t().mark((function e(r){var n=this;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._cachedTextures.has(r)){e.next=2;break}return e.abrupt("return",this._cachedTextures.get(r));case 2:return e.abrupt("return",new Promise((function(e){var t=r.split(":"),o=(t[0]||"web3")+"/blocks/"+(t[1]||"empty_land")+"/texture";a.load(o,l,(function(t,c){if(t)return console.error("[CompositeBlockRenderer] Failed to load texture "+o+":",t),void e(null);n._cachedTextures.set(r,c),e(c)}))})));case 3:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),e.clearCache=function(){this._cachedTextures.clear(),this._cachedEffect=null,console.log("[CompositeBlockRenderer] Cache cleared")},e}());d._cachedEffect=null,d._cachedTextures=new Map,n._RF.pop()}}}));

System.register("chunks:///_virtual/CompositeTypes.ts",["cc"],(function(){var e;return{setters:[function(t){e=t.cclegacy}],execute:function(){e._RF.push({},"f8a7emyj9NNAYyVu7xOWwA1","CompositeTypes",void 0),e._RF.pop()}}}));

System.register("chunks:///_virtual/CompositeVoxelActor.ts",["./rollupPluginModLoBabelHelpers.js","cc","./CompositeBlockRenderer.ts","./BlockOverlayManager.ts"],(function(e){var o,t,n,r,s,i,a,c,l,u,d,h;return{setters:[function(e){o=e.inheritsLoose,t=e.asyncToGenerator,n=e.regeneratorRuntime,r=e.createForOfIteratorHelperLoose},function(e){s=e.cclegacy,i=e._decorator,a=e.tween,c=e.Vec3,l=e.Component,u=e.Node},function(e){d=e.CompositeBlockRenderer},function(e){h=e.BlockOverlayManager}],execute:function(){var p;s._RF.push({},"0f6b4q9Wf1OkoFYAzgpEFj1","CompositeVoxelActor",void 0);var f=i.ccclass;i.property,e("CompositeVoxelActor",f("CompositeVoxelActor")(p=function(e){function s(){for(var o,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(o=e.call.apply(e,[this].concat(n))||this)._config=null,o._rootNode=null,o._blockNodes=[],o._overlayNodes=[],o._isRendered=!1,o._tweens=[],o}o(s,e);var i=s.prototype;return i.onLoad=function(){console.log("[CompositeVoxelActor] Component loaded")},i.onDestroy=function(){this.clear()},i.setConfig=function(){var e=t(n().mark((function e(o){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._config=o,e.next=3,this.rebuild();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(o){return e.apply(this,arguments)}}(),i.getConfig=function(){return this._config},i.rebuild=function(){var e=t(n().mark((function e(){var o,t,r,s;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._config){e.next=2;break}return e.abrupt("return",{success:!1,blockCount:0,error:"No config set"});case 2:console.log("[CompositeVoxelActor] Rebuilding with config:",this._config),e.prev=3,this.clear(),this._rootNode=new u("CompositeRoot"),this._rootNode.parent=this.node,this._config.basePosition&&this._rootNode.setPosition(this._config.basePosition),this._config.baseScale&&this._rootNode.setScale(this._config.baseScale),this._config.baseRotation&&this._rootNode.setRotationFromEuler(this._config.baseRotation),o=0,t=0;case 12:if(!(t<this._config.components.length)){e.next=23;break}if(!1!==(r=this._config.components[t]).visible){e.next=16;break}return e.abrupt("continue",20);case 16:return e.next=18,this.createBlockNode(r,t);case 18:(s=e.sent)&&(this._blockNodes.push(s),o++);case 20:t++,e.next=12;break;case 23:return this._isRendered=!0,console.log("[CompositeVoxelActor] Rebuilt: "+o+"/"+this._config.components.length+" blocks"),e.abrupt("return",{success:!0,blockCount:o});case 28:return e.prev=28,e.t0=e.catch(3),console.error("[CompositeVoxelActor] Rebuild failed:",e.t0),e.abrupt("return",{success:!1,blockCount:0,error:e.t0 instanceof Error?e.t0.message:String(e.t0)});case 32:case"end":return e.stop()}}),e,this,[[3,28]])})));return function(){return e.apply(this,arguments)}}(),i.createBlockNode=function(){var e=t(n().mark((function e(o,t){var s,i,a,c,l,p,f;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(i=new u("Block_"+t+"_"+o.blockId.replace(":","_"))).parent=this._rootNode,o.position&&i.setPosition(o.position),o.scale&&i.setScale(o.scale),o.rotation&&i.setRotationFromEuler(o.rotation),a=null!=(s=o.techniqueIndex)?s:0,e.next=9,d.renderBlock(i,o.blockId,a);case 9:if(e.sent){e.next=14;break}return console.warn("[CompositeVoxelActor] Failed to render block "+o.blockId),i.destroy(),e.abrupt("return",null);case 14:if(!(o.overlays&&o.overlays.length>0)){e.next=24;break}c=r(o.overlays);case 16:if((l=c()).done){e.next=24;break}return p=l.value,e.next=20,h.createOverlay(i,p);case 20:(f=e.sent)&&this._overlayNodes.push(f);case 22:e.next=16;break;case 24:return e.abrupt("return",i);case 27:return e.prev=27,e.t0=e.catch(0),console.error("[CompositeVoxelActor] Failed to create block node:",e.t0),e.abrupt("return",null);case 31:case"end":return e.stop()}}),e,this,[[0,27]])})));return function(o,t){return e.apply(this,arguments)}}(),i.clear=function(){this.stopAllAnimations(),this._overlayNodes.forEach((function(e){e&&e.isValid&&e.destroy()})),this._overlayNodes=[],this._blockNodes.forEach((function(e){e&&e.isValid&&e.destroy()})),this._blockNodes=[],this._rootNode&&this._rootNode.isValid&&(this._rootNode.destroy(),this._rootNode=null),this._isRendered=!1},i.isRendered=function(){return this._isRendered},i.getRootNode=function(){return this._rootNode},i.getBlockNodes=function(){return[].concat(this._blockNodes)},i.setBaseTransform=function(e,o,t){this._rootNode?(e&&this._rootNode.setPosition(e),o&&this._rootNode.setScale(o),t&&this._rootNode.setRotationFromEuler(t)):console.warn("[CompositeVoxelActor] Root node not created")},i.setVisible=function(e){this._rootNode&&(this._rootNode.active=e)},i.playFloatAnimation=function(e,o){void 0===e&&(e=.1),void 0===o&&(o=2);var t=this.node.position.clone(),n=a(this.node).repeatForever(a().to(o/2,{position:new c(t.x,t.y+e,t.z)},{easing:"sineInOut"}).to(o/2,{position:t},{easing:"sineInOut"})).start();this._tweens.push(n)},i.playBounceAnimation=function(e,o,t){void 0===e&&(e=.15),void 0===o&&(o=.8),void 0===t&&(t=0);var n=this.node.position.clone(),r=a(this.node).repeatForever(a().to(o/2,{position:new c(n.x,n.y+e,n.z)},{easing:"quadOut"}).to(o/2,{position:n},{easing:"quadIn"}).delay(t)).start();this._tweens.push(r)},i.playRotateAnimation=function(e,o){void 0===e&&(e=2),void 0===o&&(o="y");var t="x"===o?new c(360,0,0):"y"===o?new c(0,360,0):new c(0,0,360),n=a(this.node).repeatForever(a().by(e,{eulerAngles:t})).start();this._tweens.push(n)},i.playSwayAnimation=function(e,o){void 0===e&&(e=.05),void 0===o&&(o=1.6);var t=this.node.position.clone(),n=a(this.node).repeatForever(a().to(o/2,{position:new c(t.x-e,t.y,t.z)},{easing:"sineInOut"}).to(o/2,{position:new c(t.x+e,t.y,t.z)},{easing:"sineInOut"})).start();this._tweens.push(n)},i.playBreathAnimation=function(e,o){void 0===e&&(e=1.05),void 0===o&&(o=2);var t=this.node.scale.clone(),n=a(this.node).repeatForever(a().to(o/2,{scale:t.clone().multiplyScalar(e)},{easing:"sineInOut"}).to(o/2,{scale:t},{easing:"sineInOut"})).start();this._tweens.push(n)},i.stopAllAnimations=function(){this._tweens.forEach((function(e){e&&e.stop()})),this._tweens=[]},s}(l))||p);s._RF.pop()}}}));

System.register("chunks:///_virtual/ConfigLoader.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var n,t,r,s,i,a,o,c,u;return{setters:[function(e){n=e.inheritsLoose,t=e.createForOfIteratorHelperLoose,r=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){i=e.cclegacy,a=e._decorator,o=e.resources,c=e.JsonAsset,u=e.Component}],execute:function(){var f,g;i._RF.push({},"5d13agE/CZPH7lI9oVz6Cwi","ConfigLoader",void 0);var l=a.ccclass,h=e("ConfigType",function(e){return e.ROLES="roles",e.NPCS="npcs",e.PLAYERS="players",e.MAPS="maps",e.CARDS="cards",e}({})),d=e("ConfigLoader",l("ConfigLoader")(((g=function(e){function i(){for(var n,t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return(n=e.call.apply(e,[this].concat(r))||this).configInfos=new Map,n.configCache=new Map,n.loadingStates=new Map,n.loadQueue=[],n.initialized=!1,n}n(i,e),i.getInstance=function(){return i._instance};var a=i.prototype;return a.onLoad=function(){null===i._instance?(i._instance=this,this.initializeConfigInfos()):this.destroy()},a.onDestroy=function(){i._instance===this&&(i._instance=null)},a.initializeConfigInfos=function(){this.registerConfig(h.ROLES,"data/configs/roles",!0),this.registerConfig(h.NPCS,"data/configs/npcs",!0),this.registerConfig(h.PLAYERS,"data/configs/players",!1),this.registerConfig(h.MAPS,"data/configs/maps",!1),this.registerConfig(h.CARDS,"data/configs/cards",!1),this.initialized=!0},a.registerConfig=function(e,n,t,r){void 0===t&&(t=!1),this.configInfos.set(e,{type:e,path:n,required:t,version:r})},a.loadConfig=function(){var e=r(s().mark((function e(n,t){var r,i,a,o,c,u,f;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=!1),!this.loadingStates.get(n)){e.next=3;break}return e.abrupt("return",{success:!1,error:"配置文件 "+n+" 正在加载中"});case 3:if(t||!this.configCache.has(n)){e.next=5;break}return e.abrupt("return",{success:!0,data:this.configCache.get(n)});case 5:if(r=this.configInfos.get(n)){e.next=8;break}return e.abrupt("return",{success:!1,error:"未找到配置文件信息: "+n});case 8:return i=Date.now(),this.loadingStates.set(n,!0),e.prev=10,e.next=13,this.loadJsonAsset(r.path);case 13:if(a=e.sent,o=Date.now()-i,(c=this.validateConfigData(n,a)).success){e.next=18;break}return e.abrupt("return",{success:!1,error:c.error,loadTime:o});case 18:return this.configCache.set(n,a),console.log("配置文件加载成功: "+n+", 耗时: "+o+"ms"),e.abrupt("return",{success:!0,data:a,loadTime:o});case 23:return e.prev=23,e.t0=e.catch(10),u=Date.now()-i,f="加载配置文件失败: "+n+", 错误: "+e.t0,console.error(f),e.abrupt("return",{success:!1,error:f,loadTime:u});case 29:return e.prev=29,this.loadingStates.set(n,!1),e.finish(29);case 32:case"end":return e.stop()}}),e,this,[[10,23,29,32]])})));return function(n,t){return e.apply(this,arguments)}}(),a.loadConfigs=function(){var e=r(s().mark((function e(n,r){var i,a,o,c,u,f=this;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===r&&(r=!1),i=new Map,a=[],o=s().mark((function e(){var n,t;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=u.value,t=f.loadConfig(n,r).then((function(e){i.set(n,e)})),a.push(t);case 3:case"end":return e.stop()}}),e)})),c=t(n);case 5:if((u=c()).done){e.next=9;break}return e.delegateYield(o(),"t0",7);case 7:e.next=5;break;case 9:return e.next=11,Promise.all(a);case 11:return e.abrupt("return",i);case 12:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),a.loadRequiredConfigs=function(){var e=r(s().mark((function e(n){var r,i,a,o,c,u,f,g,l,h,d,p,C,v;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=!1),this.initialized){e.next=3;break}return e.abrupt("return",{success:!1,error:"配置加载器未初始化"});case 3:for(r=[],i=t(this.configInfos);!(a=i()).done;)o=a.value,c=o[0],o[1].required&&r.push(c);return u=Date.now(),e.next=8,this.loadConfigs(r,n);case 8:for(f=e.sent,g=Date.now()-u,l=[],h=t(f);!(d=h()).done;)p=d.value,C=p[0],(v=p[1]).success||l.push(C+": "+v.error);if(!(l.length>0)){e.next=14;break}return e.abrupt("return",{success:!1,error:"必需配置文件加载失败:\n"+l.join("\n"),loadTime:g});case 14:return console.log("所有必需配置文件加载成功, 总耗时: "+g+"ms"),e.abrupt("return",{success:!0,loadTime:g});case 16:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),a.getConfig=function(e){return this.configCache.get(e)||null},a.getAllConfigs=function(){return{roles:this.getConfig(h.ROLES),npcs:this.getConfig(h.NPCS),players:this.getConfig(h.PLAYERS),maps:this.getConfig(h.MAPS),cards:this.getConfig(h.CARDS)}},a.clearCache=function(e){e?this.configCache.delete(e):this.configCache.clear()},a.isConfigLoaded=function(e){return this.configCache.has(e)},a.getLoadingState=function(e){return this.loadingStates.get(e)||!1},a.reloadConfig=function(){var e=r(s().mark((function e(n){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.clearCache(n),e.next=3,this.loadConfig(n,!0);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),a.getStats=function(){for(var e,n=0,r=t(this.loadingStates.values());!(e=r()).done;){e.value&&n++}return{registered:this.configInfos.size,loaded:this.configCache.size,cached:this.configCache.size,loading:n}},a.loadJsonAsset=function(e){return new Promise((function(n,t){o.load(e,c,(function(e,r){e?t(e):n(r.json)}))}))},a.validateConfigData=function(e,n){if(!n)return{success:!1,error:"配置数据为空"};switch(e){case h.ROLES:case h.NPCS:case h.PLAYERS:if(!Array.isArray(n))return{success:!1,error:"配置数据应为数组格式: "+e}}switch(e){case h.ROLES:return this.validateRolesConfig(n)}return{success:!0}},a.validateRolesConfig=function(e){for(var n=0;n<e.length;n++){var t=e[n];if(!t.roleId||!t.roleType)return{success:!1,error:"角色配置数据不完整: 索引 "+n+", 缺少必需字段 roleId/roleType"}}return{success:!0}},i}(u))._instance=null,f=g))||f);e("configLoader",{get instance(){return d.getInstance()}});i._RF.pop()}}}));

System.register("chunks:///_virtual/constants.ts",["cc"],(function(E){var R;return{setters:[function(E){R=E.cclegacy}],execute:function(){E({getGameStatusText:function(E){switch(E){case L.READY:return"准备中";case L.ACTIVE:return"进行中";case L.ENDED:return"已结束";default:return"未知"}},isLargeBuilding:function(E){return E===O.SIZE_2X2},isLargeBuildingType:function(E){return E>=N.TEMPLE&&E<=N.HOTEL},isSmallBuilding:function(E){return E===O.SIZE_1X1}}),R._RF.push({},"60a74AbouJI8qOqltJoPhfU","constants",void 0);E("TileKind",function(E){return E[E.EMPTY=0]="EMPTY",E[E.LOTTERY=1]="LOTTERY",E[E.HOSPITAL=2]="HOSPITAL",E[E.CHANCE=3]="CHANCE",E[E.BONUS=4]="BONUS",E[E.FEE=5]="FEE",E[E.CARD=6]="CARD",E[E.NEWS=7]="NEWS",E}({}));var N=E("BuildingType",function(E){return E[E.NONE=0]="NONE",E[E.TEMPLE=20]="TEMPLE",E[E.RESEARCH=21]="RESEARCH",E[E.OIL=22]="OIL",E[E.COMMERCIAL=23]="COMMERCIAL",E[E.HOTEL=24]="HOTEL",E}({})),O=E("BuildingSize",function(E){return E[E.SIZE_1X1=1]="SIZE_1X1",E[E.SIZE_2X2=2]="SIZE_2X2",E}({})),L=(E("BuildingLevel",function(E){return E[E.LEVEL_0=0]="LEVEL_0",E[E.LEVEL_1=1]="LEVEL_1",E[E.LEVEL_2=2]="LEVEL_2",E[E.LEVEL_3=3]="LEVEL_3",E[E.LEVEL_4=4]="LEVEL_4",E[E.LEVEL_5=5]="LEVEL_5",E}({})),E("NpcKind",function(E){return E[E.NONE=0]="NONE",E[E.BARRIER=20]="BARRIER",E[E.BOMB=21]="BOMB",E[E.DOG=22]="DOG",E[E.LAND_GOD=23]="LAND_GOD",E[E.WEALTH_GOD=24]="WEALTH_GOD",E[E.FORTUNE_GOD=25]="FORTUNE_GOD",E[E.POOR_GOD=26]="POOR_GOD",E}({})),E("CardKind",function(E){return E[E.MOVE_CTRL=0]="MOVE_CTRL",E[E.BARRIER=1]="BARRIER",E[E.BOMB=2]="BOMB",E[E.RENT_FREE=3]="RENT_FREE",E[E.FREEZE=4]="FREEZE",E[E.DOG=5]="DOG",E[E.CLEANSE=6]="CLEANSE",E[E.TURN=7]="TURN",E}({})),E("BuffKind",function(E){return E[E.MOVE_CTRL=1]="MOVE_CTRL",E[E.FROZEN=2]="FROZEN",E[E.RENT_FREE=3]="RENT_FREE",E[E.LAND_BLESSING=4]="LAND_BLESSING",E[E.FORTUNE=5]="FORTUNE",E}({})),E("GamePhase",function(E){return E[E.ROLL=1]="ROLL",E[E.MOVE=2]="MOVE",E[E.SETTLE=3]="SETTLE",E[E.MANAGE=4]="MANAGE",E[E.EVENTS=5]="EVENTS",E[E.END=6]="END",E}({})),E("GameStatus",function(E){return E[E.READY=0]="READY",E[E.ACTIVE=1]="ACTIVE",E[E.ENDED=2]="ENDED",E}({})));E("PendingDecision",function(E){return E[E.NONE=0]="NONE",E[E.BUY_PROPERTY=1]="BUY_PROPERTY",E[E.UPGRADE_PROPERTY=2]="UPGRADE_PROPERTY",E[E.PAY_RENT=3]="PAY_RENT",E}({})),E("DecisionType",function(E){return E[E.NONE=0]="NONE",E[E.BUY_PROPERTY=1]="BUY_PROPERTY",E[E.UPGRADE_PROPERTY=2]="UPGRADE_PROPERTY",E[E.PAY_RENT=3]="PAY_RENT",E}({})),E("SkipReason",function(E){return E[E.HOSPITAL=2]="HOSPITAL",E}({})),E("NO_OWNER",255),E("NO_BUILDING",65535),E("INVALID_TILE_ID",65535),E("DEFAULT_MAX_PLAYERS",4),E("DEFAULT_MAX_ROUNDS",100),E("DEFAULT_HOSPITAL_TURNS",2),E("DEFAULT_BUILDING_PRICE_1X1",2000n),E("DEFAULT_BUILDING_PRICE_2X2",5000n),E("DEFAULT_TILE_BONUS_AMOUNT",2000n),E("DEFAULT_TILE_FEE_AMOUNT",2000n);E("NpcAction",function(E){return E[E.SPAWN=1]="SPAWN",E[E.REMOVE=2]="REMOVE",E[E.HIT=3]="HIT",E}({})),E("NpcResult",function(E){return E[E.NONE=0]="NONE",E[E.SEND_HOSPITAL=1]="SEND_HOSPITAL",E[E.BARRIER_STOP=2]="BARRIER_STOP",E}({})),E("StopType",function(E){return E[E.NONE=0]="NONE",E[E.BUILDING_TOLL=1]="BUILDING_TOLL",E[E.BUILDING_NO_RENT=2]="BUILDING_NO_RENT",E[E.HOSPITAL=3]="HOSPITAL",E[E.BONUS=5]="BONUS",E[E.FEE=6]="FEE",E[E.CARD_STOP=7]="CARD_STOP",E[E.BUILDING_UNOWNED=8]="BUILDING_UNOWNED",E}({})),E("CashReason",function(E){return E[E.TOLL=1]="TOLL",E[E.BUY=2]="BUY",E[E.UPGRADE=3]="UPGRADE",E[E.BONUS=4]="BONUS",E[E.FEE=5]="FEE",E[E.CARD=6]="CARD",E}({})),E("GameEndReason",function(E){return E[E.NORMAL=0]="NORMAL",E[E.MAX_ROUNDS=1]="MAX_ROUNDS",E[E.ONE_PLAYER_LEFT=2]="ONE_PLAYER_LEFT",E}({}));R._RF.pop()}}}));

System.register("chunks:///_virtual/CryptoUtils.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,o,n;return{setters:[function(e){t=e.asyncToGenerator,o=e.regeneratorRuntime},function(e){n=e.cclegacy}],execute:function(){e({decryptWithPassword:function(e,t){return s.apply(this,arguments)},encryptWithPassword:function(e,t){return l.apply(this,arguments)}}),n._RF.push({},"a5f81ksAc5M5IcdwibcQLy/","CryptoUtils",void 0);var r="undefined"!=typeof crypto&&void 0!==crypto.subtle;function l(){return(l=t(o().mark((function e(t,n){var l,s,c,p,i,a,y,g,u;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[CryptoUtils] Encrypt: START"),console.log("  Plaintext length:",t.length),console.log("  Environment:",r?"Browser (secure)":"Editor (base64)"),r){e.next=8;break}return console.warn("[CryptoUtils] Using Base64 encoding (NOT ENCRYPTED)"),l=btoa(unescape(encodeURIComponent(t))),console.log("[CryptoUtils] Encrypt: SUCCESS (base64)"),e.abrupt("return",l);case 8:return e.prev=8,s=new TextEncoder,console.log("[CryptoUtils] Encrypt: Step 1 - Importing password key"),e.next=13,crypto.subtle.importKey("raw",s.encode(n),"PBKDF2",!1,["deriveKey"]);case 13:return c=e.sent,console.log("  Password key imported"),console.log("[CryptoUtils] Encrypt: Step 2 - Deriving AES key"),p=crypto.getRandomValues(new Uint8Array(16)),console.log("  Salt length:",p.length),e.next=20,crypto.subtle.deriveKey({name:"PBKDF2",salt:p,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!1,["encrypt"]);case 20:return i=e.sent,console.log("  AES key derived"),console.log("[CryptoUtils] Encrypt: Step 3 - Encrypting"),a=crypto.getRandomValues(new Uint8Array(12)),console.log("  IV length:",a.length),e.next=27,crypto.subtle.encrypt({name:"AES-GCM",iv:a},i,s.encode(t));case 27:return y=e.sent,console.log("  Encrypted byteLength:",y.byteLength),console.log("[CryptoUtils] Encrypt: Step 4 - Combining data"),(g=new Uint8Array(p.length+a.length+y.byteLength)).set(p,0),g.set(a,p.length),g.set(new Uint8Array(y),p.length+a.length),console.log("  Combined length:",g.length),console.log("[CryptoUtils] Encrypt: Step 5 - Base64 encoding"),u=btoa(String.fromCharCode.apply(String,g)),console.log("  Result length:",u.length),console.log("[CryptoUtils] Encrypt: SUCCESS"),e.abrupt("return",u);case 42:throw e.prev=42,e.t0=e.catch(8),console.error("[CryptoUtils] Encrypt: FAILED"),console.error("  Error:",e.t0),e.t0;case 47:case"end":return e.stop()}}),e,null,[[8,42]])})))).apply(this,arguments)}function s(){return(s=t(o().mark((function e(t,n){var l,s,c,p,i,a,y,g,u,d,h;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[CryptoUtils] Decrypt: START"),console.log("  Ciphertext length:",t.length),console.log("  Environment:",r?"Browser (secure)":"Editor (base64)"),r){e.next=8;break}return console.warn("[CryptoUtils] Using Base64 decoding (NOT ENCRYPTED)"),l=decodeURIComponent(escape(atob(t))),console.log("[CryptoUtils] Decrypt: SUCCESS (base64)"),e.abrupt("return",l);case 8:return e.prev=8,s=new TextEncoder,c=new TextDecoder,console.log("[CryptoUtils] Decrypt: Step 1 - Base64 decoding"),p=Uint8Array.from(atob(t),(function(e){return e.charCodeAt(0)})),console.log("  Combined length:",p.length),console.log("[CryptoUtils] Decrypt: Step 2 - Separating data"),i=p.slice(0,16),a=p.slice(16,28),y=p.slice(28),console.log("  Salt length:",i.length),console.log("  IV length:",a.length),console.log("  Encrypted length:",y.length),console.log("[CryptoUtils] Decrypt: Step 3 - Importing password key"),e.next=24,crypto.subtle.importKey("raw",s.encode(n),"PBKDF2",!1,["deriveKey"]);case 24:return g=e.sent,console.log("  Password key imported"),console.log("[CryptoUtils] Decrypt: Step 4 - Deriving AES key"),e.next=29,crypto.subtle.deriveKey({name:"PBKDF2",salt:i,iterations:1e5,hash:"SHA-256"},g,{name:"AES-GCM",length:256},!1,["decrypt"]);case 29:return u=e.sent,console.log("  AES key derived"),console.log("[CryptoUtils] Decrypt: Step 5 - Decrypting"),e.next=34,crypto.subtle.decrypt({name:"AES-GCM",iv:a},u,y);case 34:return d=e.sent,console.log("  Decrypted byteLength:",d.byteLength),h=c.decode(d),console.log("  Result length:",h.length),console.log("[CryptoUtils] Decrypt: SUCCESS"),e.abrupt("return",h);case 42:throw e.prev=42,e.t0=e.catch(8),console.error("[CryptoUtils] Decrypt: FAILED"),console.error("  Error:",e.t0),e.t0;case 47:case"end":return e.stop()}}),e,null,[[8,42]])})))).apply(this,arguments)}r||(console.warn("[CryptoUtils] Web Crypto API not available (Cocos Editor environment)"),console.warn("[CryptoUtils] Falling back to Base64 encoding (DEV ONLY, NOT SECURE)")),n._RF.pop()}}}));

System.register("chunks:///_virtual/CubeCrossMesh.ts",["cc"],(function(n){var u,e,v,s;return{setters:[function(n){u=n.cclegacy,e=n.Vec3,v=n.utils,s=n.gfx}],execute:function(){function w(n,u){return u<=0?n:{u0:n.u0+u,u1:n.u1-u,v0:n.v0+u,v1:n.v1-u}}n({buildCubeMeshWithCrossUV:function(n){var u,i,t,o=null!=(u=null==n?void 0:n.size)?u:1,r=null!=(i=null==n?void 0:n.uvEpsilon)?i:0,l=null!=(t=null==n?void 0:n.layout)?t:{nx:{u0:0,u1:1/4,v0:1/3,v1:2/3},pz:{u0:1/4,u1:.5,v0:1/3,v1:2/3},px:{u0:.5,u1:3/4,v0:1/3,v1:2/3},nz:{u0:3/4,u1:1,v0:1/3,v1:2/3},py:{u0:1/4,u1:.5,v0:2/3,v1:1},ny:{u0:1/4,u1:.5,v0:0,v1:1/3}},p=o/2,c=w(l.nx,r),a=w(l.px,r),h=w(l.ny,r),y=w(l.py,r),x=w(l.nz,r),z=w(l.pz,r),f=[],d=[],C=[],M=[],m=0;function b(n,u,e){for(var v=[[e.u0,e.v0],[e.u1,e.v0],[e.u1,e.v1],[e.u0,e.v1]],s=0;s<4;s++){var w=n[s];f.push(w.x,w.y,w.z),d.push(u.x,u.y,u.z),C.push(v[s][0],v[s][1])}var i=m;M.push(i+0,i+1,i+2,i+0,i+2,i+3),m+=4}return b([new e(+p,-p,+p),new e(+p,-p,-p),new e(+p,+p,-p),new e(+p,+p,+p)],new e(1,0,0),a),b([new e(-p,-p,-p),new e(-p,-p,+p),new e(-p,+p,+p),new e(-p,+p,-p)],new e(-1,0,0),c),b([new e(-p,+p,+p),new e(+p,+p,+p),new e(+p,+p,-p),new e(-p,+p,-p)],new e(0,1,0),y),b([new e(-p,-p,-p),new e(+p,-p,-p),new e(+p,-p,+p),new e(-p,-p,+p)],new e(0,-1,0),h),b([new e(-p,-p,+p),new e(+p,-p,+p),new e(+p,+p,+p),new e(-p,+p,+p)],new e(0,0,1),z),b([new e(+p,-p,-p),new e(-p,-p,-p),new e(-p,+p,-p),new e(+p,+p,-p)],new e(0,0,-1),x),v.MeshUtils.createMesh({positions:f,normals:d,uvs:C,indices:M,minPos:new e(-p,-p,-p),maxPos:new e(+p,+p,+p),primitiveMode:s.PrimitiveMode.TRIANGLE_LIST})},getTestCrossLayout:function(){return{nx:{u0:0,u1:1/4,v0:1/3,v1:2/3},pz:{u0:1/4,u1:.5,v0:1/3,v1:2/3},px:{u0:.5,u1:3/4,v0:1/3,v1:2/3},nz:{u0:3/4,u1:1,v0:1/3,v1:2/3},py:{u0:1/4,u1:.5,v0:2/3,v1:1},ny:{u0:1/4,u1:.5,v0:0,v1:1/3}}}}),u._RF.push({},"6b979wz7+pL04QVGY3RSNuY","CubeCrossMesh",void 0),u._RF.pop()}}}));

System.register("chunks:///_virtual/CubeCrossRenderer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./CubeCrossMesh.ts"],(function(e){var t,r,s,n,i,a,o,u,l,h,c,p,f,d,m,b;return{setters:[function(e){t=e.applyDecoratedDescriptor,r=e.inheritsLoose,s=e.initializerDefineProperty,n=e.assertThisInitialized,i=e.asyncToGenerator,a=e.regeneratorRuntime},function(e){o=e.cclegacy,u=e._decorator,l=e.Texture2D,h=e.EffectAsset,c=e.CCFloat,p=e.resources,f=e.Material,d=e.Component,m=e.MeshRenderer},function(e){b=e.buildCubeMeshWithCrossUV}],execute:function(){var C,y,R,g,M,v,z,w,x,E,L,D,k,N,T;o._RF.push({},"49e11skDhFCN6oUa9bUYzQ+","CubeCrossRenderer",void 0);var U=u.ccclass,P=u.property;e("CubeCrossRenderer",(C=U("CubeCrossRenderer"),y=P({type:l,displayName:"横十字贴图",tooltip:"4x3格式的横十字布局贴图"}),R=P({type:h,displayName:"Shader效果",tooltip:"指向 unlit-cross.effect"}),g=P({type:c,displayName:"立方体边长",tooltip:"立方体的尺寸",min:.1,max:10}),M=P({type:c,displayName:"UV收缩",tooltip:"UV收缩防止贴图边缘采样溢出(0~0.01)",min:0,max:.01,step:.001}),v=P({displayName:"透明模式",tooltip:"是否使用透明渲染"}),z=P({displayName:"自动加载资源",tooltip:"如果没有指定资源，自动从默认路径加载"}),C((E=t((x=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return t=e.call.apply(e,[this].concat(i))||this,s(t,"atlas",E,n(t)),s(t,"effect",L,n(t)),s(t,"size",D,n(t)),s(t,"uvEpsilon",k,n(t)),s(t,"transparent",N,n(t)),s(t,"autoLoadResources",T,n(t)),t.meshRenderer=null,t.generatedMesh=null,t.material=null,t}r(t,e);var o=t.prototype;return o.start=function(){var e=i(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.meshRenderer=this.getComponent(m),this.meshRenderer||(this.meshRenderer=this.addComponent(m),console.log("[CubeCrossRenderer] 自动添加 MeshRenderer 组件")),!this.autoLoadResources){e.next=5;break}return e.next=5,this.tryLoadDefaultResources();case 5:this.generateCubeMesh(),this.applyMaterial();case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),o.tryLoadDefaultResources=function(){var e=i(a().mark((function e(){var t;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.effect){e.next=12;break}return e.prev=1,t="voxel/shaders/unlit-cross/unlit-cross",e.next=5,this.loadResource(t,h);case 5:this.effect=e.sent,console.log("[CubeCrossRenderer] 自动加载 effect 成功:",t),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),console.warn("[CubeCrossRenderer] 自动加载 effect 失败:",e.t0);case 12:!this.atlas&&this.autoLoadResources;case 13:case"end":return e.stop()}}),e,this,[[1,9]])})));return function(){return e.apply(this,arguments)}}(),o.loadResource=function(e,t){return new Promise((function(r,s){p.load(e,t,(function(e,t){e?s(e):r(t)}))}))},o.generateCubeMesh=function(){this.meshRenderer&&(this.generatedMesh=b({size:this.size,uvEpsilon:this.uvEpsilon}),this.meshRenderer.mesh=this.generatedMesh,console.log("[CubeCrossRenderer] 立方体网格生成完成"))},o.applyMaterial=function(){this.meshRenderer&&this.effect?(this.material=new f,this.material.initialize({effectAsset:this.effect,technique:this.transparent?1:0}),this.atlas?(this.material.setProperty("mainTexture",this.atlas),console.log("[CubeCrossRenderer] 贴图已应用")):console.warn("[CubeCrossRenderer] 未指定贴图，使用默认白色贴图"),this.meshRenderer.setMaterial(this.material,0),console.log("[CubeCrossRenderer] 材质应用完成")):console.warn("[CubeCrossRenderer] 缺少必要组件或资源")},o.refresh=function(){this.meshRenderer&&(this.generateCubeMesh(),this.applyMaterial())},o.setTexture=function(e){this.atlas=e,this.material&&this.material.setProperty("mainTexture",e)},o.setSize=function(e){this.size=e,this.generateCubeMesh()},o.setUVEpsilon=function(e){this.uvEpsilon=e,this.generateCubeMesh()},o.setCustomLayout=function(e){this.meshRenderer&&(this.generatedMesh=b({size:this.size,uvEpsilon:this.uvEpsilon,layout:e}),this.meshRenderer.mesh=this.generatedMesh)},o.onDestroy=function(){this.generatedMesh&&(this.generatedMesh.destroy(),this.generatedMesh=null),this.material&&(this.material.destroy(),this.material=null)},t}(d)).prototype,"atlas",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L=t(x.prototype,"effect",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=t(x.prototype,"size",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),k=t(x.prototype,"uvEpsilon",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),N=t(x.prototype,"transparent",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T=t(x.prototype,"autoLoadResources",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),w=x))||w));o._RF.pop()}}}));

System.register("chunks:///_virtual/cursor.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(r){var t,e;return{setters:[function(r){t=r.extends},function(r){e=r.cclegacy}],execute:function(){r("createEventCursor",(function(r){return new o(r?"sui_event_cursor_"+r:"sui_event_cursor")})),e._RF.push({},"9f569g+wbtPKpvCOHkeEYhT","cursor",void 0);var o=r("SuiEventCursor",function(){function r(r){void 0===r&&(r="sui_event_cursor"),this.cursor=void 0,this.storageKey=void 0,this.storageKey=r,this.cursor=this.loadCursor()}var e=r.prototype;return e.getCursor=function(){return t({},this.cursor)},e.updateCursor=function(r){this.cursor=t({},this.cursor,r),this.saveCursor()},e.updateEventSeq=function(r){r>this.cursor.eventSeq&&(this.cursor.eventSeq=r,this.saveCursor())},e.reset=function(){this.cursor={eventSeq:0,hasNextPage:!0},this.saveCursor()},e.loadCursor=function(){if("undefined"!=typeof window&&window.localStorage)try{var r=localStorage.getItem(this.storageKey);if(r)return JSON.parse(r)}catch(r){console.error("Failed to load cursor from storage:",r)}return{eventSeq:0,hasNextPage:!0}},e.saveCursor=function(){if("undefined"!=typeof window&&window.localStorage)try{localStorage.setItem(this.storageKey,JSON.stringify(this.cursor))}catch(r){console.error("Failed to save cursor to storage:",r)}},e.export=function(){return JSON.stringify(this.cursor)},e.import=function(r){try{this.cursor=JSON.parse(r),this.saveCursor()}catch(r){console.error("Failed to import cursor:",r)}},r}());e._RF.pop()}}}));

System.register("chunks:///_virtual/DataPollingService.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Blackboard.ts"],(function(e){var t,n,r,i,a;return{setters:[function(e){t=e.asyncToGenerator,n=e.regeneratorRuntime,r=e.createClass},function(e){i=e.cclegacy},function(e){a=e.Blackboard}],execute:function(){i._RF.push({},"d6df4IHTJlLCajX1aQPNCiJ","DataPollingService",void 0);e("DataPollingService",function(){function e(){this._timers=new Map,this._inFlight=new Map,this._running=!1}var i=e.prototype;return i.register=function(e){var r=this;console.log("[DataPolling] Registering task: "+e.key+", interval: "+e.interval+"ms"),this.unregister(e.key);var i=setInterval(t(n().mark((function t(){var i;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r._running){t.next=2;break}return t.abrupt("return");case 2:if(!r._inFlight.get(e.key)){t.next=5;break}return console.warn("[DataPolling] Task "+e.key+" still in flight, skipping"),t.abrupt("return");case 5:return r._inFlight.set(e.key,!0),t.prev=6,t.next=9,e.fetcher();case 9:i=t.sent,e.blackboardKey&&a.instance.set(e.blackboardKey,i),t.next=17;break;case 13:t.prev=13,t.t0=t.catch(6),console.error("[DataPolling] Error in task "+e.key+":",t.t0),e.onError&&e.onError(t.t0);case 17:return t.prev=17,r._inFlight.delete(e.key),t.finish(17);case 20:case"end":return t.stop()}}),t,null,[[6,13,17,20]])}))),e.interval);this._timers.set(e.key,i),console.log("[DataPolling] Task registered: "+e.key)},i.registerSimple=function(e,t,n,r){this.register({key:e,fetcher:t,interval:n,blackboardKey:r})},i.unregister=function(e){var t=this._timers.get(e);t&&(clearInterval(t),this._timers.delete(e),this._inFlight.delete(e),console.log("[DataPolling] Task unregistered: "+e))},i.start=function(){this._running?console.warn("[DataPolling] Already running"):(this._running=!0,console.log("[DataPolling] Started ("+this._timers.size+" tasks)"))},i.stop=function(){this._running&&(this._running=!1,console.log("[DataPolling] Stopped"))},i.clear=function(){this._running=!1,this._timers.forEach((function(e){return clearInterval(e)})),this._timers.clear(),console.log("[DataPolling] Cleared all tasks")},r(e,[{key:"isRunning",get:function(){return this._running}},{key:"taskCount",get:function(){return this._timers.size}}]),e}());i._RF.pop()}}}));

System.register("chunks:///_virtual/DecisionDialogHelper.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIMessage.ts","./UINotification.ts","./SuiManager.ts","./TransactionErrorHandler.ts"],(function(e){var n,t,r,i,a,c,o,u,s;return{setters:[function(e){n=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){r=e.cclegacy},function(e){i=e.UIMessage,a=e.MessageBoxIcon,c=e.MessageBoxType},function(e){o=e.UINotification},function(e){u=e.SuiManager},function(e){s=e.handleSuiTransactionError}],execute:function(){r._RF.push({},"c1d50xI2lpPV7K2wu4Z+M7G","DecisionDialogHelper",void 0);e("DecisionDialogHelper",function(){function e(){}return e.showBuyDialog=function(){var r=n(t().mark((function r(o,u){var s,l,p,g,f,d;return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(s=u.getMyPlayer()){r.next=4;break}return console.warn("[DecisionDialogHelper] My player not found"),r.abrupt("return");case 4:return l=Number(o.amount),p=Number(s.getCash()),g=p>=l,f=u.getBuildingByTileId(o.tileId),d=(null==f?void 0:f.getBuildingTypeName())||"建筑"+o.tileId,r.next=11,i.show({title:"购买建筑",message:d+"\n\n购买价格："+l+"\n当前现金："+p+(g?"":" (现金不足)")+"\n购买后余额："+(p-l),icon:a.NONE,componentType:c.STYLE1,buttons:{primary:{text:g?"购买":"购买 (现金不足)",disabled:!g,callback:function(){var r=n(t().mark((function n(){return t().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e._executeBuyBuilding(u);case 2:case"end":return n.stop()}}),n)})));return function(){return r.apply(this,arguments)}}()},secondary:{text:"跳过",visible:!0,callback:function(){var r=n(t().mark((function n(){return t().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e._executeSkipDecision(u);case 2:case"end":return n.stop()}}),n)})));return function(){return r.apply(this,arguments)}}()},close:{visible:!1}}});case 11:case"end":return r.stop()}}),r)})));return function(e,n){return r.apply(this,arguments)}}(),e.showUpgradeDialog=function(){var r=n(t().mark((function r(o,u,s){var l,p,g,f,d,x,v,y;return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(p=u.getMyPlayer()){r.next=4;break}return console.warn("[DecisionDialogHelper] My player not found"),r.abrupt("return");case 4:return g=Number(o.amount),f=Number(p.getCash()),d=f>=g,x=u.getBuildingByTileId(o.tileId),v=(null==x?void 0:x.getBuildingTypeName())||"建筑"+o.tileId,y=null!=(l=null!=s?s:null==x?void 0:x.level)?l:0,r.next=12,i.show({title:"升级建筑",message:v+"\n\n当前等级："+y+"\n升级价格："+g+"\n当前现金："+f+(d?"":" (现金不足)")+"\n升级后余额："+(f-g),icon:a.NONE,componentType:c.STYLE1,buttons:{primary:{text:d?"升级":"升级 (现金不足)",disabled:!d,callback:function(){var r=n(t().mark((function n(){return t().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e._executeUpgradeBuilding(u);case 2:case"end":return n.stop()}}),n)})));return function(){return r.apply(this,arguments)}}()},secondary:{text:"跳过",visible:!0,callback:function(){var r=n(t().mark((function n(){return t().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e._executeSkipDecision(u);case 2:case"end":return n.stop()}}),n)})));return function(){return r.apply(this,arguments)}}()},close:{visible:!1}}});case 12:case"end":return r.stop()}}),r)})));return function(e,n,t){return r.apply(this,arguments)}}(),e.showRentDialog=function(){var r=n(t().mark((function r(u,s,l){var p,g,f,d,x,v,y,m;return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(p=s.getMyPlayer()){r.next=4;break}return console.warn("[DecisionDialogHelper] My player not found"),r.abrupt("return");case 4:return g=Number(u.amount),f=Number(p.getCash()),d=f>=g,x=s.getBuildingByTileId(u.tileId),v=(null==x?void 0:x.getBuildingTypeName())||"建筑"+u.tileId,y=void 0!==l?"玩家 "+l:"未知",m=p.getCardCount(3)>0,r.next=13,i.show({title:"支付租金",message:v+"\n\n地产所有者："+y+"\n租金金额："+g+"\n当前现金："+f+"\n"+(m?"(持有免租卡)":""),icon:a.WARNING,componentType:c.STYLE1,buttons:{primary:{text:"使用免租卡",visible:m,callback:function(){var r=n(t().mark((function n(){return t().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e._executePayRent(s,!0);case 2:case"end":return n.stop()}}),n)})));return function(){return r.apply(this,arguments)}}()},secondary:{text:"支付现金",visible:!0,callback:function(){var r=n(t().mark((function n(){return t().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return d||o.error("现金不足，将破产"),n.next=3,e._executePayRent(s,!1);case 3:case"end":return n.stop()}}),n)})));return function(){return r.apply(this,arguments)}}()},btn_3:{text:"取消",visible:!0,callback:function(){o.info("已取消支付")}},close:{visible:!1}}});case 13:case"end":return r.stop()}}),r)})));return function(e,n,t){return r.apply(this,arguments)}}(),e._executeBuyBuilding=function(){var e=n(t().mark((function e(n){var r,i;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=u.instance,i=r.gameClient.game.buildBuyBuildingTx(n.getGameId(),n.getMySeat().id,n.getTemplateMapId()),e.next=5,r.signAndExecuteTransaction(i);case 5:o.success("建筑购买成功"),console.log("[DecisionDialogHelper] 建筑购买成功"),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("[DecisionDialogHelper] 购买建筑失败",e.t0),s(e.t0,{title:"购买建筑失败"});case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(n){return e.apply(this,arguments)}}(),e._executeUpgradeBuilding=function(){var e=n(t().mark((function e(n){var r,i;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=u.instance,i=r.gameClient.game.buildUpgradeBuildingTx(n.getGameId(),n.getMySeat().id,n.getTemplateMapId()),e.next=5,r.signAndExecuteTransaction(i);case 5:o.success("建筑升级成功"),console.log("[DecisionDialogHelper] 建筑升级成功"),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("[DecisionDialogHelper] 升级建筑失败",e.t0),s(e.t0,{title:"升级建筑失败"});case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(n){return e.apply(this,arguments)}}(),e._executePayRent=function(){var e=n(t().mark((function e(n,r){var i,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i=u.instance,a=r?i.gameClient.game.buildPayRentWithCardTx(n.getGameId(),n.getMySeat().id,n.getTemplateMapId()):i.gameClient.game.buildPayRentWithCashTx(n.getGameId(),n.getMySeat().id,n.getTemplateMapId()),e.next=5,i.signAndExecuteTransaction(a);case 5:o.success(r?"已使用免租卡":"租金支付成功"),console.log("[DecisionDialogHelper] 租金支付成功",{useRentFree:r}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("[DecisionDialogHelper] 支付租金失败",e.t0),s(e.t0,{title:"支付租金失败"});case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(n,t){return e.apply(this,arguments)}}(),e._executeSkipDecision=function(){var e=n(t().mark((function e(n){var r,i;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=u.instance,i=r.gameClient.game.buildSkipBuildingDecisionTx(n.getGameId(),n.getMySeat().id,n.getTemplateMapId()),e.next=5,r.signAndExecuteTransaction(i);case 5:o.info("已跳过"),console.log("[DecisionDialogHelper] 已跳过决策"),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("[DecisionDialogHelper] 跳过决策失败",e.t0),s(e.t0,{title:"跳过决策失败"});case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(n){return e.apply(this,arguments)}}(),e}());r._RF.pop()}}}));

System.register("chunks:///_virtual/DecisionSkippedHandler.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Blackboard.ts","./EventBus.ts","./EventTypes.ts","./UINotification.ts","./constants.ts"],(function(e){var n,i,r,t,o,a,c,s;return{setters:[function(e){n=e.asyncToGenerator,i=e.regeneratorRuntime},function(e){r=e.cclegacy},function(e){t=e.Blackboard},function(e){o=e.EventBus},function(e){a=e.EventTypes},function(e){c=e.UINotification},function(e){s=e.INVALID_TILE_ID}],execute:function(){r._RF.push({},"0c4c6bdB8NF5olORvAdVtLU","DecisionSkippedHandler",void 0);var d=e("DecisionSkippedHandler",function(){function e(){console.log("[DecisionSkippedHandler] Handler 创建")}e.getInstance=function(){return e._instance||(e._instance=new e),e._instance};var r=e.prototype;return r.initialize=function(){console.log("[DecisionSkippedHandler] 初始化事件监听")},r.handleEvent=function(){var e=n(i().mark((function e(n){var r,d,u,l,p,g,f,k;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[DecisionSkippedHandler] 收到 DecisionSkippedEvent",n),r=n.data,e.prev=2,d=t.instance.get("currentGameSession")){e.next=7;break}return console.warn("[DecisionSkippedHandler] GameSession not found"),e.abrupt("return");case 7:if(r.game===d.getGameId()){e.next=10;break}return console.warn("[DecisionSkippedHandler] Event game mismatch, ignoring",{eventGame:r.game,currentGame:d.getGameId()}),e.abrupt("return");case 10:return d.setRound(r.round),e.next=13,d.advance_turn(r.turn);case 13:if(console.log("[DecisionSkippedHandler] Turn 已更新",{round:r.round,turn:r.turn}),u=d.getPlayerByAddress(r.player)){e.next=18;break}return console.warn("[DecisionSkippedHandler] Player not found",r.player),e.abrupt("return");case 18:if(l=d.getTiles(),(p=l[r.tile_id])&&p.buildingId!==s){e.next=24;break}return c.info("玩家"+(u.getPlayerIndex()+1)+"放弃了决策"),console.log("[DecisionSkippedHandler] 无关联建筑信息"),e.abrupt("return");case 24:g=d.getBuildingByIndex(p.buildingId),f=(null==g?void 0:g.getBuildingTypeName())||"建筑"+p.buildingId,k=1===r.decision_type?"购买":"升级",c.info("玩家"+(u.getPlayerIndex()+1)+"放弃"+k+f),console.log("[DecisionSkippedHandler] DecisionSkippedEvent 处理完成",{player:u.getPlayerIndex(),decisionType:k,building:f}),e.next=35;break;case 31:e.prev=31,e.t0=e.catch(2),console.error("[DecisionSkippedHandler] 处理主逻辑失败",e.t0),c.error("跳过决策处理失败: "+(e.t0.message||e.t0));case 35:e.prev=35;try{o.emit(a.Game.TurnEnd,{round:r.round,turn:r.turn+1}),console.log("[DecisionSkippedHandler] 发射 TurnEnd 事件")}catch(e){console.error("[DecisionSkippedHandler] 发射事件失败",e)}return e.finish(35);case 38:case"end":return e.stop()}}),e,null,[[2,31,35,38]])})));return function(n){return e.apply(this,arguments)}}(),r.destroy=function(){console.log("[DecisionSkippedHandler] Handler 销毁"),e._instance=null},e}());d._instance=null;e("decisionSkippedHandler",{get instance(){return d.getInstance()}});r._RF.pop()}}}));

System.register("chunks:///_virtual/DiceController.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./EventTypes.ts","./Blackboard.ts"],(function(e){var i,t,o,n,s,r,l,c,a,u,d,h,p,f,g,N;return{setters:[function(e){i=e.createClass,t=e.asyncToGenerator,o=e.regeneratorRuntime},function(e){n=e.cclegacy,s=e._decorator,r=e.Quat,l=e.Vec3,c=e.tween,a=e.Tween,u=e.resources,d=e.Prefab,h=e.instantiate,p=e.director},function(e){f=e.EventBus},function(e){g=e.EventTypes},function(e){N=e.Blackboard}],execute:function(){var w,m;n._RF.push({},"9db52yA4aFAp6xVkTTb91Z4","DiceController",void 0);var v=s.ccclass,y=(s.property,{3:r.fromEuler(new r,-90,0,0),5:r.fromEuler(new r,0,0,0),6:r.fromEuler(new r,0,0,-90),1:r.fromEuler(new r,0,0,90),2:r.fromEuler(new r,180,0,0),4:r.fromEuler(new r,90,0,0)});e("DiceController",v("DiceController")(((m=function(){function e(){this.diceNode=null,this.dicePrefab=null,this.isRolling=!1,this.currentValue=1,this.hideTimer=null,this.isLooping=!1,this.loopTween=null,this.pendingCallback=null}var n=e.prototype;return n.initialize=function(){var e=t(o().mark((function e(){var i=this;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.dicePrefab){e.next=2;break}return e.abrupt("return");case 2:return e.abrupt("return",new Promise((function(e,t){u.load("prefabs/dice",d,(function(o,n){if(o)return console.error("[DiceController] 加载骰子预制体失败:",o),void t(o);i.dicePrefab=n,console.log("[DiceController] 骰子预制体加载成功"),e()}))})));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),n.getActivePlayerPosition=function(){var e=N.instance.get("currentGameSession");if(!e)return console.warn("[DiceController] GameSession 未找到，使用默认位置"),new l(0,8,0);var i=e.getActivePlayer();if(!i)return console.warn("[DiceController] 活跃玩家未找到，使用默认位置"),new l(0,8,0);var t=i.getPaperActor();if(!t||!t.node)return console.warn("[DiceController] 玩家节点未找到，使用默认位置"),new l(0,8,0);var o=t.node.getWorldPosition(),n=new l(o.x+1.5,o.y+1.5,o.z+1.5);return console.log("[DiceController] 骰子位置基于玩家:",{playerPos:{x:o.x,y:o.y,z:o.z},dicePos:{x:n.x,y:n.y,z:n.z}}),n},n.roll=function(){var e=t(o().mark((function e(i,t){var n,s,r=this;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isRolling){e.next=3;break}return console.warn("[DiceController] 骰子正在滚动中，请稍候"),e.abrupt("return");case 3:if(!(i<1||i>6)){e.next=6;break}return console.error("[DiceController] 无效的骰子值:",i),e.abrupt("return");case 6:return e.next=8,this.initialize();case 8:if(this.dicePrefab){e.next=11;break}return console.error("[DiceController] 骰子预制体未加载"),e.abrupt("return");case 11:this.isRolling=!0,this.currentValue=i,null!==this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.diceNode||(this.diceNode=h(this.dicePrefab),null==(n=p.getScene())||n.addChild(this.diceNode)),s=this.getActivePlayerPosition(),this.diceNode.setPosition(s),this.diceNode.active=!0,a.stopAllByTarget(this.diceNode),this.playRollAnimation(i,(function(){r.isRolling=!1,r.scheduleHide(),t&&t()}));case 20:case"end":return e.stop()}}),e,this)})));return function(i,t){return e.apply(this,arguments)}}(),n.playRollAnimation=function(e,i){var t=this;if(this.diceNode){var o=new r;r.fromEuler(o,360*Math.random(),360*Math.random(),360*Math.random()),this.diceNode.setRotation(o);var n=.75;c(this.diceNode).to(.3*n,{position:new l(this.diceNode.position.x,this.diceNode.position.y+3,this.diceNode.position.z)},{easing:"quadOut"}).by(.3*n,{eulerAngles:new l(720,540,360)}).to(.4*n,{position:new l(this.diceNode.position.x,this.diceNode.position.y-2.5,this.diceNode.position.z)},{easing:"quadIn"}).by(.4*n,{eulerAngles:new l(360,270,180)}).to(.125,{position:new l(this.diceNode.position.x,this.diceNode.position.y+1,this.diceNode.position.z)},{easing:"quadOut"}).to(.125,{position:new l(this.diceNode.position.x,this.diceNode.position.y-.5,this.diceNode.position.z)},{easing:"bounceOut"}).call((function(){if(t.diceNode){var o=y[e];c(t.diceNode).to(.15,{rotation:o},{easing:"quadInOut"}).call(i).start()}})).start()}},n.scheduleHide=function(){var e=this;null!==this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.hideTimer=setTimeout((function(){e.hide(),e.hideTimer=null}),3e3)},n.hide=function(){this.diceNode&&(this.diceNode.active=!1)},n.show=function(){this.diceNode&&(this.diceNode.active=!0)},n.getCurrentValue=function(){return this.currentValue},n.getIsRolling=function(){return this.isRolling},n.startRolling=function(){var e=t(o().mark((function e(i,t){var n,s;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isRolling&&!this.isLooping){e.next=3;break}return console.warn("[DiceController] 骰子正在滚动或循环中"),e.abrupt("return");case 3:return e.next=5,this.initialize();case 5:if(this.dicePrefab){e.next=8;break}return console.error("[DiceController] 骰子预制体未加载"),e.abrupt("return");case 8:this.isLooping=!0,this.pendingCallback=t,null!==this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null),this.diceNode||(this.diceNode=h(this.dicePrefab),null==(n=p.getScene())||n.addChild(this.diceNode)),s=this.getActivePlayerPosition(),this.diceNode.setPosition(s),this.diceNode.active=!0,a.stopAllByTarget(this.diceNode),console.log("[DiceController] 开始循环播放骰子动画，数量:",i),this._playLoopAnimation(),f.on(g.Dice.RollResult,this._onRollResult,this);case 19:case"end":return e.stop()}}),e,this)})));return function(i,t){return e.apply(this,arguments)}}(),n._playLoopAnimation=function(){if(this.diceNode){var e=new r;r.fromEuler(e,360*Math.random(),360*Math.random(),360*Math.random()),this.diceNode.setRotation(e),this.loopTween=c(this.diceNode).by(.5,{eulerAngles:new l(180,270,180)}).union().repeat(999).start(),console.log("[DiceController] 循环动画已开始")}},n._onRollResult=function(e){this.isLooping&&(console.log("[DiceController] 收到链上骰子值:",e.value),this._stopAtValue(e.value),f.off(g.Dice.RollResult,this._onRollResult,this))},n._stopAtValue=function(e){var i=this;if(this.diceNode){this.isLooping=!1,this.isRolling=!0,this.currentValue=e,this.loopTween&&(this.loopTween.stop(),this.loopTween=null),a.stopAllByTarget(this.diceNode),console.log("[DiceController] 停止循环，播放减速动画到值:",e);var t=y[e];c(this.diceNode).by(.12,{eulerAngles:new l(90,135,90)},{easing:"quadOut"}).to(.08,{position:new l(this.diceNode.position.x,this.diceNode.position.y+1,this.diceNode.position.z)},{easing:"quadOut"}).to(.08,{position:new l(this.diceNode.position.x,this.diceNode.position.y-.5,this.diceNode.position.z)},{easing:"bounceOut"}).to(.12,{rotation:t},{easing:"quadInOut"}).call((function(){i.isRolling=!1,i.scheduleHide(),i.pendingCallback&&(i.pendingCallback(),i.pendingCallback=null),console.log("[DiceController] 骰子动画完成，停在值:",e)})).start()}},n.stopRolling=function(){console.log("[DiceController] 停止骰子循环动画（交易失败）"),this.loopTween&&(this.loopTween.stop(),this.loopTween=null),f.off(g.Dice.RollResult,this._onRollResult,this),this.diceNode&&a.stopAllByTarget(this.diceNode),this.isRolling=!1,this.isLooping=!1,this.pendingCallback=null,this.hide(),console.log("[DiceController] 骰子已停止")},n.cleanup=function(){this.loopTween&&(this.loopTween.stop(),this.loopTween=null),f.off(g.Dice.RollResult,this._onRollResult,this),this.diceNode&&(a.stopAllByTarget(this.diceNode),this.diceNode.destroy(),this.diceNode=null),this.dicePrefab=null,this.isRolling=!1,this.isLooping=!1,this.pendingCallback=null,null!==this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null)},i(e,null,[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}())._instance=null,w=m))||w);n._RF.pop()}}}));

System.register("chunks:///_virtual/env.devnet.ts",["cc"],(function(e){var a;return{setters:[function(e){a=e.cclegacy}],execute:function(){a._RF.push({},"b5745JIouhK6IFyqRyzTv2Q","env.devnet",void 0);e("SuiEnvConfig",{packageId:"0x1b460bb7007f7188d677173fd0de401a41939495cd61831e9e16ac4ab303bb4f",upgradeCap:"0xd967cf01511be7190ba3e9e1a2f134b3e03badda51fe3e5c5be6b97ab457c8af",adminCap:"0x55a49e765c479ab34076e6c4802488d740ed6c50efc2697b6a42cda278fb2638",gameData:"0x212dd49b9f7f12b3c9408360648fb4f6fdbeb8a1ec2a74f5ce85f68143a3fd0f",network:"devnet"});a._RF.pop()}}}));

System.register("chunks:///_virtual/env.localnet.ts",["cc"],(function(e){var a;return{setters:[function(e){a=e.cclegacy}],execute:function(){a._RF.push({},"715baE/EwVMiJ+6a0N4Wmmp","env.localnet",void 0);e("SuiEnvConfig",{packageId:"0xf88e67197ba0a8f875e9f4493d4e256d90c83ae444f007b0d3feed09572ed507",upgradeCap:"0xd5fde970d8075a1cc844afec0c437a4be1269618ff902053d4a4d99223121d5a",adminCap:"0x19e42ebdc8aaca4bdea3db164942124bba4d2358d41fb83c4980d8f65e1523eb",gameData:"0xef9ff192c8cb1980785e1b87d7d5d507fd694ea8a5db53218bc1adde15528bc6",network:"localnet",signerType:"keypair"});a._RF.pop()}}}));

System.register("chunks:///_virtual/env.mainnet.ts",["cc"],(function(e){var n;return{setters:[function(e){n=e.cclegacy}],execute:function(){n._RF.push({},"f024d1QvDVPbIsGEZavlFPQ","env.mainnet",void 0);e("SuiEnvConfig",{packageId:"0x0000000000000000000000000000000000000000000000000000000000000000",upgradeCap:"0x0000000000000000000000000000000000000000000000000000000000000000",adminCap:"0x0000000000000000000000000000000000000000000000000000000000000000",gameData:"0x0000000000000000000000000000000000000000000000000000000000000000",network:"mainnet",signerType:"wallet"});n._RF.pop()}}}));

System.register("chunks:///_virtual/env.testnet.ts",["cc"],(function(e){var a;return{setters:[function(e){a=e.cclegacy}],execute:function(){a._RF.push({},"17f77SPycdPTZlJTKVOq0k2","env.testnet",void 0);e("SuiEnvConfig",{packageId:"0xf262542ca9fb36e2ccc6daeb1c7e909f6e64e7e9bf0ad52af5eb2a3994ea99bf",upgradeCap:"0x84bb59da051053988b0f85e1b533465a3fb91970ad6f9f6371ca52519ca44828",adminCap:"0xbc99357ff1ed60d6e59d8c4379693d8f10ca0596d74595246ecd55436bbce8de",gameData:"0x51d967b201c5a798c57fc264e5796182556346565101a7f7a2abc9a9ae4be5d9",network:"testnet"});a._RF.pop()}}}));

System.register("chunks:///_virtual/EventBus.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,n,r,i;return{setters:[function(e){t=e.createForOfIteratorHelperLoose,n=e.createClass},function(e){r=e.cclegacy,i=e.EventTarget}],execute:function(){r._RF.push({},"e8da5Ct/5hD35AH39OISWuI","EventBus",void 0);var s=function(){function e(){this._eventTarget=void 0,this._listenerMap=new Map,this._debug=!1,this._eventTarget=new i}var r=e.prototype;return r.setDebug=function(e){this._debug=e},r.on=function(e,t,n){this._eventTarget.on(e,t,n),this._addToListenerMap(e,{listener:t,target:n,once:!1}),this._debug&&console.log("[EventBus] On event: "+e)},r.once=function(e,t,n){this._eventTarget.once(e,t,n),this._addToListenerMap(e,{listener:t,target:n,once:!0}),this._debug&&console.log("[EventBus] Once event: "+e)},r.off=function(e,t,n){this._eventTarget.off(e,t,n),this._removeFromListenerMap(e,t,n),this._debug&&console.log("[EventBus] Off event: "+e)},r.emit=function(e,t){try{if(this._debug&&!e.startsWith("input3d_")){var n=this.getEventListenerCount(e);console.log("[EventBus] Emit event: "+e+", listeners: "+n,t)}this._eventTarget.emit(e,t)}catch(t){console.error("[EventBus] Error emitting event ["+e+"]:",t)}},r.offTarget=function(e){e&&(this._eventTarget.targetOff(e),this._removeTargetFromListenerMap(e),this._debug&&console.log("[EventBus] Off target:",e))},r.getEventListenerCount=function(e){var t=this._listenerMap.get(e);return t?t.length:0},r.hasEventListener=function(e,t,n){return this._eventTarget.hasEventListener(e,t,n)},r.clear=function(){var e=this;this._listenerMap.forEach((function(t,n){t.forEach((function(t){e._eventTarget.off(n,t.listener,t.target)}))})),this._listenerMap.clear(),this._debug&&console.log("[EventBus] Cleared all listeners")},r.getDebugInfo=function(){for(var e,n={totalEvents:this._listenerMap.size,debugMode:this._debug,events:{}},r=t(this._listenerMap);!(e=r()).done;){var i=e.value,s=i[0],o=i[1];n.events[s]={listenerCount:o.length,listeners:o.map((function(e){return{hasTarget:!!e.target,once:e.once,priority:e.priority}}))}}return n},r.destroy=function(){this.clear(),e._instance=null},r._addToListenerMap=function(e,t){var n=this._listenerMap.get(e);n||(n=[],this._listenerMap.set(e,n));for(var r=t.priority||0,i=n.length,s=0;s<n.length;s++)if((n[s].priority||0)<r){i=s;break}n.splice(i,0,t)},r._removeFromListenerMap=function(e,t,n){var r=this._listenerMap.get(e);if(r){if(t)for(var i=r.length-1;i>=0;i--)r[i].listener===t&&r[i].target===n&&r.splice(i,1);else for(var s=r.length-1;s>=0;s--)n&&r[s].target!==n||r.splice(s,1);0===r.length&&this._listenerMap.delete(e)}},r._removeTargetFromListenerMap=function(e){for(var n,r=t(this._listenerMap);!(n=r()).done;){for(var i=n.value,s=i[0],o=i[1],a=o.length-1;a>=0;a--)o[a].target===e&&o.splice(a,1);0===o.length&&this._listenerMap.delete(s)}},n(e,null,[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}();s._instance=null;e("EventBus",s.instance);r._RF.pop()}}}));

System.register("chunks:///_virtual/EventTypes.ts",["cc"],(function(e){var a;return{setters:[function(e){a=e.cclegacy}],execute:function(){a._RF.push({},"6d92dH+0rhPOK6VMAUOlcIG","EventTypes",void 0);e("EventTypes",{UI:{StartGame:"ui_start_game",OpenBag:"ui_open_bag",ShowPlayerInfo:"ui_show_player_info",ShowPropertyCard:"ui_show_property_card",ShowDice:"ui_show_dice",HideDice:"ui_hide_dice",ShowMainMenu:"ui_show_main_menu",ShowSettings:"ui_show_settings",ShowPauseMenu:"ui_show_pause_menu",ShowMapSelect:"ui_show_map_select",ManagerStateChange:"ui_manager_state_change",ButtonClick:"ui_button_click",PanelClose:"ui_panel_close",MapElementSelected:"ui_map_element_selected",ToggleMapElement:"ui_toggle_map_element",ScreenSizeChanged:"ui_screen_size_changed",CardFlyOut:"ui_card_fly_out",PlaySettingClosed:"ui_play_setting_closed",SuiConfigClosed:"ui_sui_config_closed"},Map:{AllBlocksCleared:"map_all_blocks_cleared",BlockPlaced:"map_block_placed",BlockRemoved:"map_block_removed",EditModeToggled:"map_edit_mode_toggled",EditModeChanged:"map_edit_mode_changed",NpcSpawned:"map_npc_spawned"},Game:{PlayerDead:"game_player_dead",EnemyKilled:"game_enemy_killed",GameStart:"game_start",GameEnd:"game_end",GameEnded:"game_ended",GameExit:"game_exit",GamePause:"game_pause",GameResume:"game_resume",LevelComplete:"game_level_complete",ScoreChange:"game_score_change",PlayerMove:"game_player_move",TurnStart:"game_turn_start",TurnEnd:"game_turn_end",RoundEnded:"game_round_ended",ShowGameDetail:"game_show_game_detail",SessionLoaded:"game_session_loaded",SessionReset:"game_session_reset",SessionDestroyed:"game_session_destroyed",StatusChanged:"game_status_changed",DecisionPending:"game_decision_pending",DecisionCleared:"game_decision_cleared",NPCSpawned:"game_npc_spawned",NPCRemoved:"game_npc_removed",MapSelected:"game_map_selected",MapLoaded:"game_map_loaded",MapUnloaded:"game_map_unloaded",MapLoadFailed:"game_map_load_failed",MapConfigUpdated:"game_map_config_updated",RequestMapChange:"game_request_map_change",GroundClicked:"game_ground_clicked",ActionPlaybackStart:"game_action_playback_start",ActionPlaybackPaused:"game_action_playback_paused",ActionPlaybackResumed:"game_action_playback_resumed",ActionPlaybackStopped:"game_action_playback_stopped",ActionPlaybackComplete:"game_action_playback_complete",ActionPlaybackError:"game_action_playback_error",ActionStepStart:"game_action_step_start",ActionStepComplete:"game_action_step_complete",CardDrawn:"game_card_drawn",NPCInteraction:"game_npc_interaction",TileStopEffect:"game_tile_stop_effect",RoundChanged:"game_round_changed",TurnChanged:"game_turn_changed",BuildingChanged:"game_building_changed"},Property:{Purchase:"property_purchase",Sell:"property_sell",Upgrade:"property_upgrade",CollectRent:"property_collect_rent",InfoUpdate:"property_info_update"},Player:{MoneyChange:"player_money_change",CashChange:"player_cash_change",PositionChange:"player_position_change",StatusChange:"player_status_change",GetItem:"player_get_item",UseItem:"player_use_item",LevelUp:"player_level_up",DiceRolled:"player_dice_rolled",Moved:"player_moved",CardChange:"player_card_change",CardRemoved:"player_card_removed",BuffAdded:"player_buff_added",BuffRemoved:"player_buff_removed",BuffsUpdated:"player_buffs_updated"},Card:{DrawCard:"card_draw",UseCard:"card_use",CardEffect:"card_effect",GetNewCard:"card_get_new"},Role:{Spawned:"role_spawned",Created:"role_created",Destroyed:"role_destroyed",AttributeChange:"role_attribute_change",StateChange:"role_state_change",PositionChange:"role_position_change",ActorBind:"role_actor_bind",ActorUnbind:"role_actor_unbind",Initialized:"role_initialized",Reset:"role_reset"},Skill:{Used:"skill_used",CooldownStart:"skill_cooldown_start",CooldownEnd:"skill_cooldown_end",EffectApplied:"skill_effect_applied",LevelUp:"skill_level_up",Learned:"skill_learned",Failed:"skill_failed",Interrupted:"skill_interrupted"},NPC:{Spawned:"npc_spawned",Triggered:"npc_triggered",EffectApplied:"npc_effect_applied",Expired:"npc_expired",Removed:"npc_removed",StateChange:"npc_state_change",Interact:"npc_interact"},Dice:{StartRoll:"dice_start_roll",RollResult:"dice_roll_result",RollComplete:"dice_roll_complete"},Audio:{PlaySFX:"audio_play_sfx",PlayBGM:"audio_play_bgm",StopSFX:"audio_stop_sfx",StopBGM:"audio_stop_bgm",VolumeChange:"audio_volume_change"},Network:{Connected:"network_connected",Disconnected:"network_disconnected",ConnectionError:"network_connection_error",MessageReceived:"network_message_received",MessageSent:"network_message_sent"},Blockchain:{WalletConnected:"blockchain_wallet_connected",WalletDisconnected:"blockchain_wallet_disconnected",TransactionConfirmed:"blockchain_transaction_confirmed",TransactionFailed:"blockchain_transaction_failed",BalanceUpdate:"blockchain_balance_update",NFTReceived:"blockchain_nft_received"},System:{AppBackground:"system_app_background",AppForeground:"system_app_foreground",MemoryWarning:"system_memory_warning",SettingsChange:"system_settings_change",LanguageChange:"system_language_change",CameraModeChanged:"system_camera_mode_changed"},SuiChain:{GameCreated:"sui_chain_game_created",GameStarted:"sui_chain_game_started",GameEnded:"sui_chain_game_ended",PlayerJoined:"sui_chain_player_joined",DiceRolled:"sui_chain_dice_rolled",PlayerMoved:"sui_chain_player_moved",PlayerBankrupt:"sui_chain_player_bankrupt",PropertyPurchased:"sui_chain_property_purchased",PropertyUpgraded:"sui_chain_property_upgraded",PropertyMortgaged:"sui_chain_property_mortgaged",PropertyRedeemed:"sui_chain_property_redeemed",RentPaid:"sui_chain_rent_paid",ChanceCardDrawn:"sui_chain_chance_card_drawn",CardEffectApplied:"sui_chain_card_effect_applied",MoneyTransfer:"sui_chain_money_transfer",TaxPaid:"sui_chain_tax_paid",SalaryCollected:"sui_chain_salary_collected",PropertyStaked:"sui_chain_property_staked",StakingRewardClaimed:"sui_chain_staking_reward_claimed",LoanTaken:"sui_chain_loan_taken",LoanRepaid:"sui_chain_loan_repaid",PropertyNFTMinted:"sui_chain_property_nft_minted",PropertyNFTTransferred:"sui_chain_property_nft_transferred",FreeParkingCollected:"sui_chain_free_parking_collected",EventIndexed:"sui_chain_event_indexed",IndexerError:"sui_chain_indexer_error",IndexerStarted:"sui_chain_indexer_started",IndexerStopped:"sui_chain_indexer_stopped"},Sui:{DataPreloaded:"sui_data_preloaded",GamesListUpdated:"sui_games_list_updated",MapTemplatesUpdated:"sui_map_templates_updated",NewGameCreated:"sui_new_game_created"},Move:{GameCreated:"move_game_created",PlayerJoined:"move_player_joined",GameStarted:"move_game_started",GameEnded:"move_game_ended",MapTemplatePublished:"move_map_template_published"},Input3D:{MouseDown:"input3d_mouse_down",MouseUp:"input3d_mouse_up",MouseMove:"input3d_mouse_move",MouseWheel:"input3d_mouse_wheel",TouchStart:"input3d_touch_start",TouchMove:"input3d_touch_move",TouchEnd:"input3d_touch_end",TouchCancel:"input3d_touch_cancel",RaycastHit:"input3d_raycast_hit",RaycastMiss:"input3d_raycast_miss"}});a._RF.pop()}}}));

System.register("chunks:///_virtual/FaucetUtils.ts",["./rollupPluginModLoBabelHelpers.js","cc","./loader.ts"],(function(e){var t,o,u,n;return{setters:[function(e){t=e.asyncToGenerator,o=e.regeneratorRuntime},function(e){u=e.cclegacy},function(e){n=e.loadSuiFaucet}],execute:function(){function s(){return(s=t(o().mark((function e(t,u){var s,c,r,a,l;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[Faucet] Requesting SUI from "+u+" faucet..."),console.log("  Recipient: "+t),e.prev=2,e.next=5,n();case 5:return s=e.sent,c=s.getFaucetHost,r=s.requestSuiFromFaucetV2,a=c(u),console.log("  Faucet host: "+a),e.next=12,r({host:a,recipient:t});case 12:return l=e.sent,console.log("[Faucet] ✓ Request successful"),console.log("  Result:",l),e.abrupt("return",!0);case 18:return e.prev=18,e.t0=e.catch(2),console.error("[Faucet] Request failed:",e.t0),"localnet"===u?(console.log("[Faucet] 提示：确保 sui-test-validator 正在运行"),console.log('  启动命令：RUST_LOG="off,sui_node=info" sui-test-validator --with-faucet'),console.log("  或：sui start --with-faucet")):"testnet"===u&&(console.log("[Faucet] 提示：Testnet faucet 可能有限流"),console.log("  建议使用 Web UI: https://faucet.sui.io")),e.abrupt("return",!1);case 23:case"end":return e.stop()}}),e,null,[[2,18]])})))).apply(this,arguments)}e("requestSuiFromFaucet",(function(e,t){return s.apply(this,arguments)})),u._RF.push({},"34a9afObFxN0psAsr1VvoT4","FaucetUtils",void 0),u._RF.pop()}}}));

System.register("chunks:///_virtual/game.ts",["cc","./constants.ts"],(function(n){var t,r;return{setters:[function(n){t=n.cclegacy},function(n){r=n.NO_OWNER}],execute:function(){function u(n){return n.in_hospital_turns>0}n({canAct:function(n){return!n.bankrupt&&!u(n)},getCardCount:function(n,t){return n.cards.get(t)||0},hasBuffActive:function(n,t,r){return n.buffs.some((function(n){return n.kind===t&&r<n.first_inactive_turn}))},hasOwner:function(n){return n.owner!==r},isInHospital:u}),t._RF.push({},"365b2LhBMNO5rXEcW4BexAs","game",void 0),t._RF.pop()}}}));

System.register("chunks:///_virtual/game2.ts",["./rollupPluginModLoBabelHelpers.js","cc","./loader.ts"],(function(e){var t,a,n,o;return{setters:[function(e){t=e.asyncToGenerator,a=e.regeneratorRuntime},function(e){n=e.cclegacy},function(e){o=e.loadSuiTransactions}],execute:function(){e("initGameInteraction",(function(){return c.apply(this,arguments)})),n._RF.push({},"d7570sllcBIZbnIEsM7bUVF","game",void 0);var r=null;function c(){return(c=t(a().mark((function e(){var t,n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=6;break}return e.next=3,o();case 3:t=e.sent,n=t.Transaction,r=n;case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}e("GameInteraction",function(){function e(e,t,a,n,o){void 0===n&&(n="0x8"),void 0===o&&(o="0x6"),this.client=e,this.packageId=t,this.gameDataId=a,this.randomObjectId=n,this.clockObjectId=o}var t=e.prototype;return t.buildCreateGameTx=function(e,t){var a=new r,n=[Number(e.starting_cash),e.price_rise_days,e.max_rounds];return console.log("[GameInteraction] buildCreateGameTx params:",n),console.log("  starting_cash:",e.starting_cash),a.moveCall({target:this.packageId+"::game::create_game",arguments:[a.object(this.gameDataId),a.object(e.template_map_id),a.pure.vector("u64",n)]}),a},t.buildJoinGameTx=function(e){var t=new r;return t.moveCall({target:this.packageId+"::game::join",arguments:[t.object(e),t.object(this.gameDataId)]}),t},t.buildStartGameTx=function(e,t){var a=new r;return a.moveCall({target:this.packageId+"::game::start",arguments:[a.object(e),a.object(this.gameDataId),a.object(t),a.object(this.randomObjectId),a.object(this.clockObjectId)]}),a},t.buildRollAndStepTx=function(e,t,a,n,o,c,i){void 0===o&&(o=!0),void 0===c&&(c=!0),void 0===i&&(i=!0);var u=new r;return u.moveCall({target:this.packageId+"::game::roll_and_step",arguments:[u.object(e),u.object(t),u.pure.vector("u16",n),u.pure.bool(o),u.pure.bool(c),u.pure.bool(i),u.object(this.gameDataId),u.object(a),u.object(this.randomObjectId),u.object(this.clockObjectId)]}),u},t.buildEndTurnTx=function(e,t,a){var n=new r;return n.moveCall({target:this.packageId+"::game::end_turn",arguments:[n.object(e),n.object(t),n.object(this.gameDataId),n.object(a),n.object(this.randomObjectId)]}),n},t.buildSkipBuildingDecisionTx=function(e,t,a){var n=new r;return n.moveCall({target:this.packageId+"::game::skip_building_decision",arguments:[n.object(e),n.object(t),n.object(this.gameDataId),n.object(a),n.object(this.randomObjectId)]}),n},t.buildDecideRentPaymentTx=function(e,t,a,n){var o=new r;return o.moveCall({target:this.packageId+"::game::decide_rent_payment",arguments:[o.object(e),o.object(t),o.pure.bool(n),o.object(this.gameDataId),o.object(a),o.object(this.randomObjectId)]}),o},t.buildBuyBuildingTx=function(e,t,a){var n=new r;return n.moveCall({target:this.packageId+"::game::buy_building",arguments:[n.object(e),n.object(t),n.object(this.gameDataId),n.object(a),n.object(this.randomObjectId)]}),n},t.buildUpgradeBuildingTx=function(e,t,a,n){var o=new r,c=null!=n?n:20;return o.moveCall({target:this.packageId+"::game::upgrade_building",arguments:[o.object(e),o.object(t),o.pure.u8(c),o.object(this.gameDataId),o.object(a),o.object(this.randomObjectId)]}),o},t.buildUseCardTx=function(e,t,a,n,o){var c=new r;return c.moveCall({target:this.packageId+"::game::use_card",arguments:[c.object(e),c.object(t),c.pure.u8(n),c.pure.vector("u16",o),c.object(this.gameDataId),c.object(a),c.object(this.randomObjectId)]}),c},t.buildSkipTurnTx=function(e,t,a){var n=new r;return n.moveCall({target:this.packageId+"::game::skip_turn",arguments:[n.object(e),n.object(t),n.object(this.gameDataId),n.object(a),n.object(this.randomObjectId)]}),n},e}());n._RF.pop()}}}));

System.register("chunks:///_virtual/GameBuilding.ts",["cc","./constants.ts"],(function(i){var e,t,n,r,s,u;return{setters:[function(i){e=i.cclegacy,t=i.Vec3},function(i){n=i.NO_OWNER,r=i.BuildingSize,s=i.BuildingType,u=i.INVALID_TILE_ID}],execute:function(){e._RF.push({},"1b76eVd8mRAprgNZ98cj8Qa","GameBuilding",void 0);i("GameBuilding",function(){function i(i,e,t,r,s,u,l,h,c,a,o,d,g){this.buildingId=void 0,this.x=void 0,this.y=void 0,this.size=void 0,this.price=void 0,this.chainPrevId=void 0,this.chainNextId=void 0,this.owner=void 0,this.level=void 0,this.buildingType=void 0,this.originalOwner=n,this.blockId=void 0,this.direction=void 0,this.entranceTileIds=void 0,this.buildingId=i,this.x=e,this.y=t,this.size=r,this.price=s,this.chainPrevId=u,this.chainNextId=l,this.owner=h,this.level=c,this.buildingType=a,this.blockId=o,this.direction=d,this.entranceTileIds=g,this.originalOwner=h}i.merge=function(e,t,n,r){var s=this.calculateEntranceTileIds(n,r),u=this.calculateDirection({x:e.x,y:e.y},s[0],r),l=this.getBuildingBlockId(e.size,t.building_type);return new i(n,e.x,e.y,e.size,e.price,e.chain_prev_id,e.chain_next_id,t.owner,t.level,t.building_type,l,u,s)};var e=i.prototype;return e.isOwned=function(){return this.owner!==n},e.getOwnerPlayer=function(i){var e=this;return this.isOwned()&&i.find((function(i){return i.getPlayerIndex()===e.owner}))||null},e.canUpgrade=function(){return this.isOwned()&&this.level<5},e.getNextUpgradeCost=function(i){return this.canUpgrade()?this.size===r.SIZE_1X1?i.getBuildingUpgradeCost(this.level):i.getLargeBuildingCost(this.level+1):0},e.calculateRent=function(i,e){if(!this.isOwned())return BigInt(0);var t=i.getRentMultiplier(this.level),n=this.price*BigInt(t)/BigInt(100);if(this.size===r.SIZE_1X1&&e.length>0){var s=Math.max.apply(Math,e),u=i.getTempleMultiplier(s);n=n*BigInt(u)/BigInt(100)}return n},e.isLargeBuilding=function(){return this.size===r.SIZE_2X2},e.hasBuildingType=function(){return this.buildingType!==s.NONE},e.getBuildingTypeName=function(){return function(i){switch(i){case s.NONE:return"无类型";case s.TEMPLE:return"土地庙";case s.RESEARCH:return"研究所";case s.OIL:return"石油公司";case s.COMMERCIAL:return"商业中心";case s.HOTEL:return"大饭店";default:return"未知("+i+")"}}(this.buildingType)},e.getPosition=function(){return{x:this.x,z:this.y}},e.getPrefabPath=function(){if(!this.shouldShowPrefab())return"";var i=this.owner;return i===n&&(i=this.originalOwner!==n?this.originalOwner:0),this.size===r.SIZE_1X1||0===this.level||this.buildingType===s.NONE?"prefabs/building/"+i:"prefabs/building/"+this.getBuildingTypePrefabName()},e.getBuildingTypePrefabName=function(){switch(this.buildingType){case s.TEMPLE:return"temple";case s.RESEARCH:return"research";case s.OIL:return"oil";case s.COMMERCIAL:return"commercial";case s.HOTEL:return"hotel";default:return"temple"}},e.getLevelScale=function(){return 1+.1*this.level},e.getLevelColorFactor=function(){return.8+.1*this.level},e.shouldShowPrefab=function(){return this.isOwned()||this.originalOwner!==n},e.getActorPosition=function(){return this.size===r.SIZE_1X1?new t(this.x+.5,.5,this.y+.5):new t(this.x+1,.5,this.y+1)},i.calculateEntranceTileIds=function(i,e){var t=[];return e.tiles_static.forEach((function(e,n){e.building_id===i&&t.push(n)})),0===t.length?(console.warn("[GameBuilding] Building "+i+" has no entrance tiles"),[u,u]):1===t.length?[t[0],u]:[t[0],t[1]]},i.calculateDirection=function(i,e,t){if(e===u)return 0;var n=t.tiles_static.get(e);if(!n)return 0;var r=n.x-i.x,s=n.y-i.y;return Math.abs(s)>Math.abs(r)?s>0?0:2:r>0?1:3},i.getBuildingBlockId=function(i,e){return i===r.SIZE_1X1?"web3:building_1x1":i===r.SIZE_2X2?"web3:building_2x2":(console.warn("[GameBuilding] Unknown building size: "+i),"web3:building_1x1")},e.debugInfo=function(){return JSON.stringify({buildingId:this.buildingId,position:{x:this.x,y:this.y},size:1===this.size?"1x1":"2x2",owner:this.owner!==n?this.owner:"none",level:this.level,buildingType:this.getBuildingTypeName(),price:this.price.toString(),direction:this.direction,entranceTileIds:this.entranceTileIds,chainPrev:this.chainPrevId!==u?this.chainPrevId:"none",chainNext:this.chainNextId!==u?this.chainNextId:"none"},null,2)},i}());e._RF.pop()}}}));

System.register("chunks:///_virtual/GameData.ts",["cc","./MapRegistry.ts","./CardRegistry.ts"],(function(t){var i,e,s;return{setters:[function(t){i=t.cclegacy},function(t){e=t.MapRegistry},function(t){s=t.CardRegistry}],execute:function(){i._RF.push({},"4460cRMOPBHjqPNoBZc0xsy","GameData",void 0);t("GameData",function(){function t(t,i,e,s,r,n,l,a,o,g){this.id=void 0,this.mapRegistry=void 0,this.cardRegistry=void 0,this.startingCash=void 0,this.rentMultipliers=void 0,this.templeMultipliers=void 0,this.buildingUpgradeCosts=void 0,this.largeBuildingCosts=void 0,this.npcSpawnWeights=void 0,this.mapSchemaVersion=void 0,this.id=t,this.mapRegistry=i,this.cardRegistry=e,this.startingCash=s,this.rentMultipliers=r,this.templeMultipliers=n,this.buildingUpgradeCosts=l,this.largeBuildingCosts=a,this.npcSpawnWeights=o,this.mapSchemaVersion=g}t.loadFromFields=function(i){var r,n,l;console.log("[GameData] 从 fields 加载数据",i);var a=(null==(r=i.id)?void 0:r.id)||i.id||"",o=e.loadFromFields((null==(n=i.map_registry)?void 0:n.fields)||i.map_registry),g=s.loadFromFields((null==(l=i.card_registry)?void 0:l.fields)||i.card_registry),u=BigInt(i.starting_cash||0),p=this.parseNumberArray(i.rent_multipliers),h=this.parseNumberArray(i.temple_multipliers),c=this.parseNumberArray(i.building_upgrade_costs),d=this.parseNumberArray(i.large_building_costs),m=this.parseNumberArray(i.npc_spawn_weights),C=Number(i.map_schema_version||1);return console.log("[GameData] 数据加载完成",{startingCash:u.toString(),mapTemplates:o.getTemplateCount(),cards:g.getCardCount(),mapSchemaVersion:C}),new t(a,o,g,u,p,h,c,d,m,C)},t.parseNumberArray=function(t){return Array.isArray(t)?t.map((function(t){return Number(t)})):[]};var i=t.prototype;return i.getRentMultiplier=function(t){return t>=0&&t<this.rentMultipliers.length?this.rentMultipliers[t]:100},i.getRentMultiplierActual=function(t){return this.getRentMultiplier(t)/100},i.getAllRentMultipliers=function(){return[].concat(this.rentMultipliers)},i.getTempleMultiplier=function(t){var i=t-1;return i>=0&&i<this.templeMultipliers.length?this.templeMultipliers[i]:100},i.getTempleMultiplierActual=function(t){return this.getTempleMultiplier(t)/100},i.getAllTempleMultipliers=function(){return[].concat(this.templeMultipliers)},i.getBuildingUpgradeCost=function(t){return t>=0&&t<this.buildingUpgradeCosts.length?this.buildingUpgradeCosts[t]:0},i.getLargeBuildingCost=function(t){var i=t-1;return i>=0&&i<this.largeBuildingCosts.length?this.largeBuildingCosts[i]:0},i.getAllBuildingUpgradeCosts=function(){return[].concat(this.buildingUpgradeCosts)},i.getAllLargeBuildingCosts=function(){return[].concat(this.largeBuildingCosts)},i.getNpcSpawnWeights=function(){return[].concat(this.npcSpawnWeights)},i.getNpcWeightAt=function(t){return t>=0&&t<this.npcSpawnWeights.length?this.npcSpawnWeights[t]:0},i.getId=function(){return this.id},i.getMapRegistry=function(){return this.mapRegistry},i.getCardRegistry=function(){return this.cardRegistry},i.getStartingCash=function(){return this.startingCash},i.getMapSchemaVersion=function(){return this.mapSchemaVersion},i.printConfig=function(){console.log("=== GameData 配置 ==="),console.log("ID: "+this.id),console.log("起始现金: "+this.startingCash.toString()),console.log("地图模板数: "+this.mapRegistry.getTemplateCount()),console.log("卡牌数: "+this.cardRegistry.getCardCount()),console.log("Schema 版本: "+this.mapSchemaVersion),console.log("租金倍率:",this.rentMultipliers.map((function(t,i){return"L"+i+"="+t/100}))),console.log("土地庙倍率:",this.templeMultipliers.map((function(t,i){return i+1+"级="+t/100}))),console.log("====================")},i.debugInfo=function(){return JSON.stringify({id:this.id,startingCash:this.startingCash.toString(),mapSchemaVersion:this.mapSchemaVersion,mapTemplateCount:this.mapRegistry.getTemplateCount(),cardCount:this.cardRegistry.getCardCount(),rentMultipliers:this.rentMultipliers,templeMultipliers:this.templeMultipliers,buildingUpgradeCosts:this.buildingUpgradeCosts,largeBuildingCosts:this.largeBuildingCosts,npcSpawnWeightsLength:this.npcSpawnWeights.length},null,2)},t}());i._RF.pop()}}}));

System.register("chunks:///_virtual/GameEndedHandler.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Blackboard.ts","./constants.ts","./IdFormatter.ts"],(function(e,n){var r,t,a,o,s,d;return{setters:[function(e){r=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){a=e.cclegacy},function(e){o=e.Blackboard},function(e){s=e.GameStatus},function(e){d=e.IdFormatter}],execute:function(){a._RF.push({},"99af0N/J5REqZvF5ZH5R1XL","GameEndedHandler",void 0);var u=e("GameEndedHandler",function(){function e(){console.log("[GameEndedHandler] Handler 创建")}e.getInstance=function(){return e._instance||(e._instance=new e),e._instance};var a=e.prototype;return a.initialize=function(){console.log("[GameEndedHandler] 初始化事件监听")},a.handleEvent=function(){var e=r(t().mark((function e(r){var a,u,c,i,l,m,g,E,f;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[GameEndedHandler] 收到 GameEndedEvent",r),a=r.data,e.prev=2,i=o.instance.get("currentGameSession")){e.next=7;break}return console.warn("[GameEndedHandler] GameSession not found"),e.abrupt("return");case 7:if(a.game===i.getGameId()){e.next=10;break}return console.warn("[GameEndedHandler] Event game mismatch, ignoring",{eventGame:a.game,currentGame:i.getGameId()}),e.abrupt("return");case 10:return i.setStatus(s.ENDED),i.setWinner(a.winner||null),console.log("[GameEndedHandler] 游戏状态已更新",{status:s.ENDED,winner:a.winner?d.shortenAddress(a.winner):"无",reason:a.reason,round:a.round,turn:a.turn_in_round}),l=a.winner?"玩家 "+(null!=(u=null==(c=i.getPlayerByAddress(a.winner))?void 0:c.getPlayerIndex())?u:"?")+" + 1":"无",m=this._getReasonText(a.reason),e.next=17,n.import("./UIManager.ts");case 17:if(g=e.sent,E=g.UIManager,!(f=null==E?void 0:E.instance)){e.next=23;break}return e.next=23,f.showUI("GameEnd",{winner:a.winner,winnerName:l,reason:a.reason,reasonText:m,round:a.round,turn:a.turn_in_round});case 23:console.log("[GameEndedHandler] GameEndedEvent 处理完成"),e.next=29;break;case 26:e.prev=26,e.t0=e.catch(2),console.error("[GameEndedHandler] 处理事件失败",e.t0);case 29:case"end":return e.stop()}}),e,this,[[2,26]])})));return function(n){return e.apply(this,arguments)}}(),a._getReasonText=function(e){switch(e){case 0:return"正常结束";case 1:return"达到最大回合数";case 2:return"只剩一个玩家";default:return"未知原因"}},a.destroy=function(){console.log("[GameEndedHandler] Handler 销毁"),e._instance=null},e}());u._instance=null;e("gameEndedHandler",{get instance(){return u.getInstance()}});a._RF.pop()}}}));

System.register("chunks:///_virtual/GameInitializer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ConfigLoader.ts","./RoleManager.ts","./UIManager.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./object-utils.ts","./MapManager.ts","./SuiManager.ts","./SuiEnvConfigManager.ts","./GameSession.ts","./tween.esm.js"],(function(e){var n,r,t,a,i,o,s,c,u,l,g,p,f,h,m,d,I,G,b,M,v,S,z,y;return{setters:[function(e){n=e.applyDecoratedDescriptor,r=e.inheritsLoose,t=e.initializerDefineProperty,a=e.assertThisInitialized,i=e.createForOfIteratorHelperLoose,o=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){c=e.cclegacy,u=e._decorator,l=e.Node,g=e.director,p=e.Component},function(e){f=e.ConfigLoader},function(e){h=e.RoleManager},function(e){m=e.UIManager},function(e){d=e.EventBus},function(e){I=e.EventTypes},function(e){G=e.Blackboard},function(e){b=e.fromEntries},function(e){M=e.MapManager},function(e){v=e.SuiManager},function(e){S=e.SuiEnvConfigManager},function(e){z=e.GameSession},function(e){y=e.update}],execute:function(){var N,w,L,E,k,T,_,x,A,P,D,C,R,O,F,B;c._RF.push({},"52a84aLjfVJOZk9Zg/GGAbO","GameInitializer",void 0);var Y=u.ccclass,U=u.property,j=e("InitializationPhase",function(e){return e.NONE="none",e.CONFIG_LOADING="config_loading",e.MANAGERS_INIT="managers_init",e.SYSTEMS_INIT="systems_init",e.GAME_READY="game_ready",e.FAILED="failed",e}({})),H=e("GameInitializer",(N=Y("GameInitializer"),w=U({displayName:"配置加载器节点",type:l,tooltip:"ConfigLoader组件所在节点"}),L=U({displayName:"角色管理器节点",type:l,tooltip:"RoleManager组件所在节点"}),E=U({displayName:"显示加载进度",tooltip:"是否在控制台显示加载进度"}),k=U({displayName:"启用性能监测",tooltip:"是否启用初始化性能监测"}),T=U({displayName:"地图容器节点",type:l,tooltip:"地图预制体将加载到此节点下"}),_=U({displayName:"地图管理器节点",type:l,tooltip:"MapManager组件所在节点"}),N(((B=function(e){function n(){for(var n,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=e.call.apply(e,[this].concat(i))||this,t(n,"configLoaderNode",P,a(n)),t(n,"roleManagerNode",D,a(n)),t(n,"showProgress",C,a(n)),t(n,"enableProfiling",R,a(n)),t(n,"mapContainer",O,a(n)),t(n,"mapManagerNode",F,a(n)),n.currentPhase=j.NONE,n.configLoader=null,n.roleManager=null,n.mapManager=null,n.gameSession=null,n.initStartTime=0,n.phaseStartTime=0,n.performanceLog=new Map,n}r(n,e),n.getInstance=function(){return n._instance};var c=n.prototype;return c.onLoad=function(){null===n._instance?(n._instance=this,g.addPersistRootNode(this.node)):this.destroy()},c.start=function(){var e=o(s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initializeGame();case 2:if(!(n=e.sent).success){e.next=9;break}return e.next=6,m.initializeGameUI();case 6:console.log("UI系统初始化完成，显示模式选择界面"),e.next=10;break;case 9:console.error("游戏初始化失败:",n.error);case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),c.onDestroy=function(){n._instance===this&&(n._instance=null)},c.update=function(e){y()},c.initializeGame=function(){var e=o(s().mark((function e(){var n,r;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("开始游戏初始化..."),this.initStartTime=Date.now(),e.prev=2,e.next=5,this.loadConfigurations();case 5:if((n=e.sent).success){e.next=8;break}return e.abrupt("return",this.handleInitializationError("配置加载失败",n.error));case 8:return e.next=10,this.initializeManagers();case 10:if((n=e.sent).success){e.next=13;break}return e.abrupt("return",this.handleInitializationError("管理器初始化失败",n.error));case 13:return e.next=15,this.initializeSystems();case 15:if((n=e.sent).success){e.next=18;break}return e.abrupt("return",this.handleInitializationError("系统初始化失败",n.error));case 18:return this.currentPhase=j.GAME_READY,r=Date.now()-this.initStartTime,console.log("游戏初始化完成! 总耗时: "+r+"ms"),this.logPerformanceData(),e.abrupt("return",{success:!0,phase:j.GAME_READY,loadTime:r,details:b(this.performanceLog)});case 25:return e.prev=25,e.t0=e.catch(2),e.abrupt("return",this.handleInitializationError("初始化过程中发生异常",e.t0.toString()));case 28:case"end":return e.stop()}}),e,this,[[2,25]])})));return function(){return e.apply(this,arguments)}}(),c.loadConfigurations=function(){var e=o(s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.enterPhase(j.CONFIG_LOADING,"加载配置文件..."),e.prev=1,this.configLoaderNode&&(this.configLoader=this.configLoaderNode.getComponent(f)),this.configLoader){e.next=5;break}return e.abrupt("return",{success:!1,phase:j.CONFIG_LOADING,error:"无法找到ConfigLoader组件"});case 5:return e.next=7,this.configLoader.loadRequiredConfigs();case 7:if((n=e.sent).success){e.next=10;break}return e.abrupt("return",{success:!1,phase:j.CONFIG_LOADING,error:n.error});case 10:return this.recordPhaseTime("配置加载"),e.abrupt("return",{success:!0,phase:j.CONFIG_LOADING,loadTime:n.loadTime});case 14:return e.prev=14,e.t0=e.catch(1),e.abrupt("return",{success:!1,phase:j.CONFIG_LOADING,error:"配置加载异常: "+e.t0});case 17:case"end":return e.stop()}}),e,this,[[1,14]])})));return function(){return e.apply(this,arguments)}}(),c.initializeManagers=function(){var e=o(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.enterPhase(j.MANAGERS_INIT,"初始化管理器..."),e.prev=1,this.roleManagerNode&&(this.roleManager=this.roleManagerNode.getComponent(h),this.roleManager&&console.log("角色管理器初始化完成")),this.mapManagerNode&&(this.mapManager=this.mapManagerNode.getComponent(M),this.mapManager&&console.log("地图管理器初始化完成")),this.gameSession=new z,console.log("GameSession 初始化完成"),this.recordPhaseTime("管理器初始化"),e.abrupt("return",{success:!0,phase:j.MANAGERS_INIT});case 10:return e.prev=10,e.t0=e.catch(1),e.abrupt("return",{success:!1,phase:j.MANAGERS_INIT,error:"管理器初始化异常: "+e.t0});case 13:case"end":return e.stop()}}),e,this,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),c.initializeSystems=function(){var e=o(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.enterPhase(j.SYSTEMS_INIT,"初始化游戏系统..."),e.prev=1,this.initializeEventSystem(),this.initializeSuiManager().catch((function(e){console.error("[GameInitializer] SuiManager initialization failed:",e)})),this.setupGlobalAccessors(),this.registerEventListeners(),this.recordPhaseTime("系统初始化"),e.abrupt("return",{success:!0,phase:j.SYSTEMS_INIT});case 10:return e.prev=10,e.t0=e.catch(1),e.abrupt("return",{success:!1,phase:j.SYSTEMS_INIT,error:"系统初始化异常: "+e.t0});case 13:case"end":return e.stop()}}),e,this,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),c.initializeSuiManager=function(){var e=o(s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[GameInitializer] Initializing SuiManager..."),e.prev=1,n=S.instance.loadAndGetConfig(),console.log("[GameInitializer] Using saved config:",{network:n.network,signerType:n.signerType}),e.next=6,v.instance.init(n,{debug:!0});case 6:console.log("[GameInitializer] SuiManager initialized successfully"),console.log("  Network:",n.network),console.log("  PackageID:",n.packageId),console.log("  GameDataID:",n.gameDataId),v.instance.startBackgroundSync().catch((function(e){console.error("[GameInitializer] Background sync failed:",e)})),console.log("[GameInitializer] Background data sync started"),e.next=18;break;case 14:throw e.prev=14,e.t0=e.catch(1),console.error("[GameInitializer] Failed to initialize SuiManager:",e.t0),e.t0;case 18:case"end":return e.stop()}}),e,null,[[1,14]])})));return function(){return e.apply(this,arguments)}}(),c.getCurrentPhase=function(){return this.currentPhase},c.isGameReady=function(){return this.currentPhase===j.GAME_READY},c.getConfigLoader=function(){return this.configLoader},c.getRoleManager=function(){return this.roleManager},c.reinitialize=function(){var e=o(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("重新初始化游戏..."),this.currentPhase=j.NONE,this.performanceLog.clear(),this.configLoader&&this.configLoader.clearCache(),e.next=6,this.initializeGame();case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),c.enterPhase=function(e,n){this.currentPhase=e,this.phaseStartTime=Date.now(),this.showProgress&&console.log("["+e.toUpperCase()+"] "+n)},c.recordPhaseTime=function(e){if(this.enableProfiling){var n=Date.now()-this.phaseStartTime;this.performanceLog.set(e,n)}},c.handleInitializationError=function(e,n){this.currentPhase=j.FAILED;var r=n?e+": "+n:e;return console.error("[INIT ERROR] "+r),{success:!1,phase:j.FAILED,error:r,loadTime:Date.now()-this.initStartTime}},c.initializeEventSystem=function(){console.log("事件系统初始化完成")},c.setupGlobalAccessors=function(){if("undefined"!=typeof window){var e=window;e.game||(e.game={}),e.game.roleManager=this.roleManager,e.game.configLoader=this.configLoader,e.game.mapManager=this.mapManager,e.game.initializer=this,e.game.session=this.gameSession,e.game.sui=v.instance,e.game.blackboard=G.instance,console.log("[GameInitializer] Global accessors set up"),console.log("  Available in console:"),console.log("    window.game.session    - GameSession"),console.log("    window.game.sui        - SuiManager"),console.log("    window.game.blackboard - Blackboard"),console.log("    window.game.mapManager - MapManager")}},c.registerEventListeners=function(){d.on(I.Move.GameStarted,this.onMoveGameStarted,this)},c.logPerformanceData=function(){if(this.enableProfiling&&this.performanceLog.size>0){console.log("=== 初始化性能数据 ===");for(var e,n=i(this.performanceLog);!(e=n()).done;){var r=e.value,t=r[0],a=r[1];console.log(t+": "+a+"ms")}console.log("=====================")}},c.onMoveGameStarted=function(){var e=o(s().mark((function e(n){var r,t,a;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[GameInitializer] Move GameStarted event received:",n),e.prev=1,n.isPlayer){e.next=5;break}return console.log("[GameInitializer] 不是玩家，跳过 GameSession 加载"),e.abrupt("return");case 5:if(r=n.game,t=n.template,a=n.gameData,r&&t&&a){e.next=11;break}return console.error("[GameInitializer] 事件数据不完整",{game:!!r,template:!!t,gameData:!!a}),e.abrupt("return");case 11:if(!this.gameSession){e.next=19;break}return e.next=14,this.gameSession.loadFromMoveGame(r,t,a);case 14:console.log("[GameInitializer] GameSession 数据加载完成"),G.instance.set("currentGameSession",this.gameSession),console.log("[GameInitializer] GameSession 设置到 Blackboard"),e.next=20;break;case 19:console.error("[GameInitializer] GameSession 未初始化");case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(1),console.error("[GameInitializer] Failed to load GameSession:",e.t0);case 25:case"end":return e.stop()}}),e,this,[[1,22]])})));return function(n){return e.apply(this,arguments)}}(),c.getGameSession=function(){return this.gameSession},n}(p))._instance=null,P=n((A=B).prototype,"configLoaderNode",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=n(A.prototype,"roleManagerNode",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),C=n(A.prototype,"showProgress",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R=n(A.prototype,"enableProfiling",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),O=n(A.prototype,"mapContainer",[T],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F=n(A.prototype,"mapManagerNode",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x=A))||x));e("gameInitializer",{get instance(){return H.getInstance()}});c._RF.pop()}}}));

System.register("chunks:///_virtual/GameMap.ts",["./rollupPluginModLoBabelHelpers.js","cc","./MapTile.ts","./CameraController.ts","./VoxelSystem.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./GridGround.ts","./GridBoundary.ts","./MapInteractionManager.ts","./Web3BlockTypes.ts","./PaperActorFactory.ts","./PaperActor.ts","./ActorFactory.ts","./Actor.ts","./BlockOverlayManager.ts","./constants.ts","./OverlayTypes.ts","./UINotification.ts","./NumberTextureGenerator.ts","./MapTemplateConverter.ts"],(function(e,t){var i,n,a,o,r,s,l,c,d,u,p,h,g,f,v,x,m,b,y,_,I,w,M,T,k,C,G,P,A,B,R,z,S,E,O,N,D,L,U,j,F,V,W,q,H,K,X,Q,Y,J,Z,$;return{setters:[function(e){i=e.applyDecoratedDescriptor,n=e.inheritsLoose,a=e.initializerDefineProperty,o=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose,s=e.createClass,l=e.asyncToGenerator,c=e.regeneratorRuntime},function(e){d=e.cclegacy,u=e._decorator,p=e.Node,h=e.Camera,g=e.find,f=e.Color,v=e.Vec2,x=e.Vec3,m=e.UITransform,b=e.Label,y=e.director,_=e.Canvas,I=e.Component,w=e.BoxCollider,M=e.sys,T=e.resources,k=e.JsonAsset,C=e.Texture2D},function(e){G=e.MapTile},function(e){P=e.CameraController},function(e){A=e.VoxelSystem},function(e){B=e.EventBus},function(e){R=e.EventTypes},function(e){z=e.Blackboard},function(e){S=e.GridGround},function(e){E=e.GridBoundary},function(e){O=e.MapInteractionManager,N=e.MapInteractionEvent},function(e){D=e.Web3TileType,L=e.isWeb3Object,U=e.isWeb3Tile,j=e.getBuildingSize,F=e.isWeb3Building,V=e.getWeb3BlockByBlockId},function(e){W=e.PaperActorFactory},function(e){q=e.PaperActor},function(e){H=e.ActorFactory},function(e){K=e.Actor},function(e){X=e.BlockOverlayManager},function(e){Q=e.NpcKind},function(e){Y=e.OverlayFace},function(e){J=e.UINotification},function(e){Z=e.NumberTextureGenerator},function(e){$=e.convertMapTemplateToSaveData}],execute:function(){var ee,te,ie,ne,ae,oe,re,se,le,ce,de,ue,pe,he,ge,fe,ve,xe;d._RF.push({},"61256jXe8VFR5ZwdvIMUtB6","GameMap",void 0);var me=u.ccclass,be=u.property;e("GameMap",(ee=me("GameMap"),te=be({displayName:"地图ID",tooltip:"地图的唯一标识符"}),ie=be({displayName:"地块容器节点",type:p,tooltip:"用于放置所有地块的父节点"}),ne=be({displayName:"物体容器节点",type:p,tooltip:"用于放置所有物体的父节点"}),ae=be({displayName:"主摄像机",type:h,tooltip:"场景主摄像机"}),oe=be({displayName:"启用编辑模式",tooltip:"是否启用编辑模式"}),re=be({displayName:"启用调试模式",tooltip:"显示调试信息"}),se=be({displayName:"加载后重建2x2父容器",tooltip:"在加载地图数据后自动为2x2地产重建父容器"}),ee(((xe=function(e){function i(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).MAP_DATA_DIR="data/maps/",t.DEFAULT_MAP_ID="default_map",a(t,"mapId",de,o(t)),a(t,"tilesContainer",ue,o(t)),a(t,"objectsContainer",pe,o(t)),a(t,"mainCamera",he,o(t)),a(t,"enableEditMode",ge,o(t)),a(t,"debugMode",fe,o(t)),a(t,"rebuildPropertyContainersAfterLoad",ve,o(t)),t._tiles=[],t._objects=[],t._tileIndex=new Map,t._objectIndex=new Map,t._mapConfig=null,t._isEditMode=!1,t._isShowingTileTypes=!1,t._voxelSystem=null,t._currentSelectedBlockId=null,t._interactionManager=null,t._isInitialized=!1,t._actors=new Map,t._buildings=new Map,t._buildingActors=new Map,t._decorations=new Map,t._actorsRoot=null,t._buildingsRoot=null,t._decorationsRoot=null,t._npcActors=new Map,t._playerActors=new Map,t._npcsRoot=null,t._playersRoot=null,t._mapSaveData=null,t.AUTO_SAVE_DELAY=1e3,t._autoSaveTimer=null,t._idLabelsRoot=null,t._idLabelsRootUI=null,t._uiCanvas=null,t._idLabels=new Map,t._idLabelWorldPos=new Map,t._hasUnsavedChanges=!1,t._buildingRegistry=new Map,t._tileOverlays=new Map,t}n(i,e);var d=i.prototype;return d.onLoad=function(){console.log("[GameMap] Component loaded, waiting for init()")},d.onDestroy=function(){this.cleanup()},d.init=function(){var e=l(c().mark((function e(t,i){var n,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[GameMap] Initializing with config:",t.id,"isEdit:",i),this._mapConfig=t,this._isEditMode=i,this.enableEditMode=i,this.mapId=t.id||this.DEFAULT_MAP_ID,B.emit(R.Map.EditModeChanged,{isEditMode:this._isEditMode,mapId:this.mapId,gameMap:this}),console.log("[GameMap] EditModeChanged event sent: isEditMode="+this._isEditMode),this.ensureContainers(),this.findMainCamera(),!i){e.next=14;break}return e.next=12,this.initializeVoxelSystem();case 12:this.createEditModeGrid(),this.initializeInteractionManager();case 14:return a=null==(n=z.instance.get("loadFromLocalStorage"))||n,e.next=17,this.loadMap(this.mapId,{loadFromLocalStorage:a});case 17:!e.sent&&i&&this.createEmptyMap(),this._isInitialized=!0,console.log("[GameMap] Initialization completed");case 21:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.ensureContainers=function(){this.tilesContainer||(this.tilesContainer=new p("TilesContainer"),this.node.addChild(this.tilesContainer),console.log("[GameMap] Created TilesContainer")),this.objectsContainer||(this.objectsContainer=new p("ObjectsContainer"),this.node.addChild(this.objectsContainer),console.log("[GameMap] Created ObjectsContainer")),this._actorsRoot||(this._actorsRoot=new p("ActorsRoot"),this.node.addChild(this._actorsRoot),console.log("[GameMap] Created ActorsRoot")),this._buildingsRoot||(this._buildingsRoot=new p("BuildingsRoot"),this.node.addChild(this._buildingsRoot),console.log("[GameMap] Created BuildingsRoot")),this._decorationsRoot||(this._decorationsRoot=new p("DecorationsRoot"),this.node.addChild(this._decorationsRoot),console.log("[GameMap] Created DecorationsRoot")),this._npcsRoot||(this._npcsRoot=new p("NPCsRoot"),this.node.addChild(this._npcsRoot),console.log("[GameMap] Created NPCsRoot")),this._playersRoot||(this._playersRoot=new p("PlayersRoot"),this.node.addChild(this._playersRoot),console.log("[GameMap] Created PlayersRoot"))},d.findMainCamera=function(){if(!this.mainCamera){var e=g("Main Camera");e?(this.mainCamera=e.getComponent(h),console.log("[GameMap] Found Main Camera")):(this.mainCamera=P.getMainCamera(),this.mainCamera?console.log("[GameMap] Got camera from CameraController"):console.warn("[GameMap] No camera found"))}},d.initializeVoxelSystem=function(){var e=l(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this._voxelSystem=A.getInstance(),this._voxelSystem){e.next=6;break}return e.next=5,A.quickInitialize();case 5:this._voxelSystem=e.sent;case 6:B.on(R.UI.MapElementSelected,this.onMapElementSelected,this),console.log("[GameMap] Voxel system initialized for edit mode"),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("[GameMap] Failed to initialize voxel system:",e.t0);case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),d.createEditModeGrid=function(){var e=new p("GridGround");e.setParent(this.node);var t=e.addComponent(S);t.step=1,t.minCoord=0,t.maxCoord=50,t.color=new f(130,130,130,255),t.y=0,t.enableClickDetection=!0,t.enableSnapping=!0,t.debugMode=this.debugMode,t.cam=this.mainCamera,this.mainCamera&&t.createWithConfig({step:1,halfSize:50,color:new f(130,130,130,255),y:0,camera:this.mainCamera}),console.log("[GameMap] Edit mode grid created with GridGround component");var i=new p("GridBoundary");i.setParent(this.node);var n=i.addComponent(E);n.cam=this.mainCamera,n.minCoord=0,n.maxCoord=255,n.y=.05,n.showOriginMarker=!0,n.enabled=!0,console.log("[GameMap] Grid boundary (0-255) created for u8 coordinate validation")},d.createEmptyMap=function(){this._mapSaveData={mapId:this.mapId,mapName:"Map "+this.mapId,version:"1.0.0",createTime:Date.now(),updateTime:Date.now(),gameMode:"edit",tiles:[],objects:[]},console.log("[GameMap] Created empty map")},d.onMapElementSelected=function(e){this._currentSelectedBlockId=e.blockId||null,console.log("[GameMap] Selected block: "+this._currentSelectedBlockId)},d.initializeInteractionManager=function(){this._interactionManager=this.node.addComponent(O),this._interactionManager.targetCamera=this.mainCamera,this._interactionManager.debugMode=this.debugMode,B.on(N.REQUEST_PLACE,this.onRequestPlace,this),B.on(N.REQUEST_REMOVE,this.onRequestRemove,this),B.on(N.ELEMENT_CLICKED,this.onElementClicked,this),console.log("[GameMap] Interaction manager initialized")},d.onRequestPlace=function(){var e=l(c().mark((function e(t){var i,n,a,o,r,s,l,d,u,p,h,g;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._isEditMode&&this._voxelSystem){e.next=2;break}return e.abrupt("return");case 2:if(i=t.gridPosition,this._currentSelectedBlockId){e.next=6;break}return console.warn("[GameMap] No block selected"),e.abrupt("return");case 6:if(n=V(this._currentSelectedBlockId)){e.next=10;break}return console.warn("[GameMap] Unknown block: "+this._currentSelectedBlockId),e.abrupt("return");case 10:if(a=n.typeId,o=F(a),r=this.findBuilding2x2Info(i),s=i.x+"_"+i.y,l=this._tileIndex.get(s),!o){e.next=26;break}if(!r||r.blockId!==this._currentSelectedBlockId){e.next=20;break}return d=new v(r.position.x,r.position.z),this.cycleBuildingDirection(d),e.abrupt("return");case 20:return r&&2===r.size&&2===j(this._currentSelectedBlockId)&&(i.x===r.position.x&&i.y===r.position.z?console.log("[GameMap] Replacing 2x2 property at ("+i.x+", "+i.y+")"):(console.log("[GameMap] Removing existing 2x2 property to place new one"),u=new v(r.position.x,r.position.z),this.removeBuilding(u))),p=j(this._currentSelectedBlockId),e.next=24,this.placeBuildingAt(this._currentSelectedBlockId,i,p);case 24:e.next=46;break;case 26:if(!U(a)){e.next=37;break}if(!l){e.next=32;break}if(l.getBlockId()!==this._currentSelectedBlockId){e.next=32;break}return console.log("[GameMap] Same tile type at ("+i.x+", "+i.y+"), skipping"),e.abrupt("return");case 32:return r&&2===r.size&&(console.log("[GameMap] Removing existing 2x2 property to place new tile"),h=new v(r.position.x,r.position.z),this.removeBuilding(h)),e.next=35,this.placeTileAt(this._currentSelectedBlockId,i);case 35:e.next=46;break;case 37:if(r&&2===r.size&&(console.log("[GameMap] Removing existing 2x2 property to place new element"),g=new v(r.position.x,r.position.z),this.removeBuilding(g)),!L(a)){e.next=43;break}return e.next=41,this.placeObjectAt(this._currentSelectedBlockId,i);case 41:e.next=46;break;case 43:if("decoration"!==n.category){e.next=46;break}return e.next=46,this.placeDecorationAt(this._currentSelectedBlockId,i);case 46:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.onRequestRemove=function(e){if(this._isEditMode){var t=e.gridPosition;this.removeElementAt(t)}},d.onElementClicked=function(){var e=l(c().mark((function e(t){var i,n,a,o,r,s,l,d,u,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._isEditMode){e.next=2;break}return e.abrupt("return");case 2:if(console.log("[GameMap] Element clicked: "+(null==(i=t.hitNode)?void 0:i.name)+" at grid ("+t.gridPosition.x+", "+t.gridPosition.y+"), button: "+t.button),n=t.gridPosition,1!==t.button){e.next=8;break}return e.next=7,this.handleShowAssociation(n);case 7:return e.abrupt("return");case 8:a=n.x+"_"+n.y,o=this._tileIndex.get(a),r=this.findBuilding2x2Info(n),s={gridPos:{x:n.x,y:n.y}},o&&(l=o.getTileId(),d=o.getBlockId(),u=V(d),s.tileId=l,s.blockId=d,s.blockName=(null==u?void 0:u.name)||d),r&&(s.buildingId=r.buildingId,s.buildingBlockId=r.blockId,p=V(r.blockId),s.blockName=(null==p?void 0:p.name)||r.blockId,s.blockId=r.blockId),(o||r)&&B.emit(R.UI.MapElementSelected,s);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.placeTileAt=function(){var e=l(c().mark((function e(t,i){var n,a,o,r,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.validateGridPosition(i)){e.next=2;break}return e.abrupt("return");case 2:return n=i.x+"_"+i.y,(a=this._tileIndex.get(n))&&this.removeTile(a),(o=new p("T_"+i.x+"_"+i.y)).setParent(this.tilesContainer),r=o.addComponent(G),e.next=10,r.initialize(t,i);case 10:if(this._tiles.push(r),this._tileIndex.set(n,r),!this._isShowingTileTypes||0===r.getTypeId()){e.next=16;break}return s=Z.getTileTypeTexture(r.getTypeId()),e.next=16,this.addTileOverlay(i,{texture:s,faces:[Y.UP],inflate:.0025,layerIndex:5,techniqueIndex:1});case 16:this._isEditMode&&this.scheduleAutoSave();case 17:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.placeDecorationAt=function(){var e=l(c().mark((function e(t,i){var n,a,o,r,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.x+"_"+i.y,this._decorations.has(n)&&((a=this._decorations.get(n))&&a.destroy(),this._decorations.delete(n)),this._voxelSystem){e.next=5;break}return console.error("[GameMap] VoxelSystem not initialized"),e.abrupt("return");case 5:return o=new x(i.x,1,i.y),e.next=8,this._voxelSystem.createBlockNode(this._decorationsRoot,t,o);case 8:(r=e.sent)?((s=r.addComponent(w))&&(s.size=new x(1,.1,1),s.center=new x(0,0,0)),this._decorations.set(n,r),console.log("[GameMap] Placed decoration "+t+" at ("+i.x+", "+i.y+")")):console.error("[GameMap] Failed to create decoration "+t),this._isEditMode&&this.scheduleAutoSave();case 11:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.placeObjectAt=function(){var e=l(c().mark((function e(t,i){var n,a,o,r,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=i.x+"_"+i.y,(a=this._actors.get(n))&&(a.destroy(),this._actors.delete(n)),o=new x(i.x,.5,i.y),(r=W.createFromBlockType(t,o))?(r.parent=this._actorsRoot,(s=r.addComponent(w))&&(s.size=new x(1,.1,1),s.center=new x(0,0,0)),this._actors.set(n,r),console.log("[GameMap] Placed PaperActor "+t+" at ("+i.x+", "+i.y+")")):console.error("[GameMap] Failed to create PaperActor for "+t),this._isEditMode&&this.scheduleAutoSave();case 7:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.removeElementAt=function(e){var t=e.x+"_"+e.y,i=this._actors.get(t);if(i)return i.destroy(),this._actors.delete(t),console.log("[GameMap] Removed PaperActor at ("+e.x+", "+e.y+")"),void(this._isEditMode&&this.scheduleAutoSave());var n=this._decorations.get(t);if(n)return n.destroy(),this._decorations.delete(t),console.log("[GameMap] Removed decoration at ("+e.x+", "+e.y+")"),void(this._isEditMode&&this.scheduleAutoSave());var a=this.findBuilding2x2Info(e);if(a){var o=new v(a.position.x,a.position.z);return this.removeBuilding(o),console.log("[GameMap] Removed "+a.size+"x"+a.size+" property at base position ("+o.x+", "+o.y+")"),void(this._isEditMode&&this.scheduleAutoSave())}var r=this._tileIndex.get(t);if(r)return this.removeTile(r),console.log("[GameMap] Removed tile at ("+e.x+", "+e.y+")"),void(this._isEditMode&&this.scheduleAutoSave());console.log("[GameMap] No element found at ("+e.x+", "+e.y+")")},d.removeTile=function(e){var t=e.getGridPosition(),i=t.x+"_"+t.y;this._tileIndex.delete(i);var n=this._tiles.indexOf(e);n>=0&&this._tiles.splice(n,1),e.node&&e.node.isValid&&e.node.destroy()},d.removeObject=function(e){var t=e.getGridPosition(),i=t.x+"_"+t.y;this._objectIndex.delete(i);var n=this._objects.indexOf(e);n>=0&&this._objects.splice(n,1),e.destroyObject()},d.clearAllPlacedBlocks=function(){console.log("[GameMap] Clearing all placed blocks..."),this.clearMap(),this._isEditMode&&this.scheduleAutoSave(),console.log("[GameMap] All blocks cleared")},d.upgradeBuilding=function(e,t){var i=e.x+"_"+e.y,n=this._buildings.get(i);if(!n)return console.warn("[GameMap] No building found at ("+e.x+", "+e.y+")"),!1;var a=W.upgradeBuilding(n,t);if(a){console.log("[GameMap] Upgraded building at ("+e.x+", "+e.y+") to level "+t);var o=e.x+"_"+e.y,r=this._buildingRegistry.get(o);r&&(r.level=t),this._isEditMode&&this.scheduleAutoSave()}return a},d.updateBuildingRender=function(){var e=l(c().mark((function e(i,n,a,o,r){var s,l,d,u,p,h,g,f,m,b,y,_,I,w;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n+"_"+a,l=this._buildingActors.get(s),d=this._session,u=null==d?void 0:d.getBuildingByIndex(i),!0,!l||!l.isValid){e.next=25;break}return e.next=9,t.import("./CompositeVoxelActor.ts");case 9:if(p=e.sent,h=p.CompositeVoxelActor,!(g=l.getComponent(h))||!u){e.next=19;break}return f=u.size,m=.45+.1*r,b=1===f?new x(m,.1,m):new x(2*m,.1,2*m),y=Z.getBuildingLabelTexture(r,o),e.next=19,g.setConfig({components:[{blockId:"web3:empty_land",position:new x(0,0,0),scale:b,techniqueIndex:1,overlays:[{texture:y,faces:[Y.UP],layerIndex:0,inflate:.002,techniqueIndex:1}]}]});case 19:e.next=23;break;case 21:(_=l.getComponent(K))&&u&&_.updateBuildingRender(u);case 23:e.next=29;break;case 25:if(!u){e.next=29;break}return I=new v(n,a),e.next=29,this.createBuildingActor(u,I);case 29:(w=this._buildingRegistry.get(s))&&(w.owner=o,w.level=r),console.log("[GameMap] Building render 更新完成: ("+n+", "+a+"), Owner: "+o+", Level: "+r);case 32:case"end":return e.stop()}}),e,this)})));return function(t,i,n,a,o){return e.apply(this,arguments)}}(),d.createBuildingActor=function(){var e=l(c().mark((function e(t,i){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0,e.next=4,this.renderBuildingWithComposite(t,i);case 4:e.next=8;break;case 6:return e.next=8,this.renderBuildingWithPaperActor(t,i);case 8:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.renderBuildingWithPaperActor=function(){var e=l(c().mark((function e(t,i){var n,a,o,r,s,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.x+"_"+i.y,(a=this._buildingActors.get(n))&&(a.destroy(),this._buildingActors.delete(n)),o=H.createForBuilding(t)){if(o.parent=this._buildingsRoot,o.name="B_"+t.size+"x"+t.size+"_"+i.x+"_"+i.y+"_3D",2===t.size)for(r=0;r<2;r++)for(s=0;s<2;s++)l=i.x+r+"_"+(i.y+s),this._buildingActors.set(l,o);else this._buildingActors.set(n,o);console.log("[GameMap] Building Actor created with PaperActor: "+n)}case 5:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.scheduleAutoSave=function(){var e=this;this._hasUnsavedChanges=!0,this._autoSaveTimer&&clearTimeout(this._autoSaveTimer),this._autoSaveTimer=setTimeout((function(){e.executeAutoSave()}),this.AUTO_SAVE_DELAY)},d.executeAutoSave=function(){var e=l(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._hasUnsavedChanges){e.next=2;break}return e.abrupt("return");case 2:return console.log("[GameMap] Auto-saving map..."),e.next=5,this.saveMap({compress:!1,includeGameRules:!0});case 5:e.sent?(this._hasUnsavedChanges=!1,console.log("[GameMap] Auto-save completed"),console.log("[GameMap] Saved to: map_"+this.mapId)):console.error("[GameMap] Auto-save failed");case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),d.saveImmediate=function(){var e=l(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._autoSaveTimer&&(clearTimeout(this._autoSaveTimer),this._autoSaveTimer=null),e.next=3,this.saveMap({compress:!1,includeGameRules:!0});case 3:return(t=e.sent)&&(this._hasUnsavedChanges=!1),e.abrupt("return",t);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),d.saveMap=function(){var e=l(c().mark((function e(t){var i,n,a,o,r,s,l,d,u,p,h;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=this._tiles.map((function(e){return e.getData()})),o=this._objects.map((function(e){return e.getData()})),r=[],this._buildingRegistry.forEach((function(e,t){var i,n=(null==(i=V(e.blockId))?void 0:i.typeId)||0;r.push({blockId:e.blockId,typeId:n,size:e.size,position:e.position,direction:e.direction,buildingId:e.buildingId,entranceTileIds:e.entranceTileIds,owner:e.owner,level:e.level,price:e.price})})),s=[],this._actors.forEach((function(e,t){var i=t.split("_").map(Number),n=i[0],a=i[1],o=e.getComponent(q);if(o){var r=o.actorId,l=V(r);s.push({blockId:r,typeId:(null==l?void 0:l.typeId)||0,position:{x:n,z:a}})}})),l=[],this._decorations.forEach((function(e,t){var i=t.split("_").map(Number),n=i[0],a=i[1],o=e.name.replace("Block_","");o.includes(":")||(o="web3:"+o);var r=V(o);l.push({blockId:o,typeId:(null==r?void 0:r.typeId)||0,position:{x:n,z:a}})})),d={mapId:this.mapId,mapName:(null==(i=this._mapConfig)?void 0:i.name)||"Map "+this.mapId,version:"1.0.0",createTime:(null==(n=this._mapSaveData)?void 0:n.createTime)||Date.now(),updateTime:Date.now(),gameMode:this._isEditMode?"edit":"play",tiles:a,objects:o,buildings:r.length>0?r:void 0,npcs:s.length>0?s:void 0,decorations:l.length>0?l:void 0},null!=t&&t.includeGameRules&&this._mapConfig&&(d.gameRules={startingMoney:1e4,passingBonus:200,landingBonus:400,maxPlayers:4,minPlayers:2}),u="map_"+this.mapId,p=JSON.stringify(d,null,null!=t&&t.compress?0:2),M.isBrowser?(localStorage.setItem(u,p),console.log("[GameMap] Map saved to localStorage: "+u)):console.log("[GameMap] Map save to file not implemented yet"),this._mapSaveData=d,h={mapId:this.mapId,tiles:a.length,objects:o.length,storage:M.isBrowser?"localStorage":"file",key:u,size:(p.length/1024).toFixed(2)+" KB"},console.log("[GameMap] Map saved successfully:",h),e.abrupt("return",!0);case 20:return e.prev=20,e.t0=e.catch(0),console.error("[GameMap] Failed to save map:",e.t0),e.abrupt("return",!1);case 24:case"end":return e.stop()}}),e,this,[[0,20]])})));return function(t){return e.apply(this,arguments)}}(),d.loadMap=function(){var e=l(c().mark((function e(t,i){var n,a,o,s,l,d,u,h,g,f,x,m,b,y,_,I,w,C,P,A,B,R,z,S,E,O,N,D,L,U,j,F,V,W,q,H;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=null,M.isBrowser&&!1!==(null==i?void 0:i.loadFromLocalStorage)&&(a="map_"+t,(o=localStorage.getItem(a))&&(n=JSON.parse(o),console.log("[GameMap] Map loaded from localStorage: "+a))),n){e.next=17;break}return s=""+this.MAP_DATA_DIR+t,e.prev=5,e.next=8,new Promise((function(e,t){T.load(s,k,(function(i,n){i?t(i):e(n)}))}));case 8:l=e.sent,n=l.json,console.log("[GameMap] Map loaded from resources: "+s),e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(5),console.log("[GameMap] No saved map found for: "+t),e.abrupt("return",!1);case 17:if(n){e.next=19;break}return e.abrupt("return",!1);case 19:!1!==(null==i?void 0:i.clearExisting)&&this.clearMap(),d=0,u=r(n.tiles);case 22:if((h=u()).done){e.next=36;break}return g=h.value,(f=new p("T_"+g.position.x+"_"+g.position.z)).setParent(this.tilesContainer),x=f.addComponent(G),e.next=29,x.loadData(g);case 29:m=g.position.x+"_"+g.position.z,this._tiles.push(x),this._tileIndex.set(m,x),d++,null!=i&&i.onProgress&&(b=d/(n.tiles.length+n.objects.length),i.onProgress(b));case 34:e.next=22;break;case 36:y=0,_=r(n.objects);case 38:if((I=_()).done){e.next=52;break}return w=I.value,(C=new p("Object_"+w.position.x+"_"+w.position.z)).setParent(this.objectsContainer),P=C.addComponent("MapObject"),e.next=45,P.loadData(w);case 45:A=w.position.x+"_"+w.position.z,this._objects.push(P),this._objectIndex.set(A,P),y++,null!=i&&i.onProgress&&(B=(d+y)/(n.tiles.length+n.objects.length),i.onProgress(B));case 50:e.next=38;break;case 52:if(R=n.buildings)for(z=r(R);!(S=z()).done;)E=S.value,O=E.position.x+"_"+E.position.z,N={blockId:E.blockId,position:E.position,size:E.size,direction:E.direction||0,buildingId:E.buildingId,entranceTileIds:E.entranceTileIds,owner:E.owner,level:E.level,price:E.price},this._buildingRegistry.set(O,N),D=new v(E.position.x,E.position.z),this.createBuildingPaperActor(E.blockId,D,E.size,E.level||0,N.direction)||console.warn("[GameMap] Failed to recreate building "+E.blockId);if(!n.npcs){e.next=64;break}L=r(n.npcs);case 56:if((U=L()).done){e.next=63;break}return j=U.value,F=new v(j.position.x,j.position.z),e.next=61,this.placeObjectAt(j.blockId,F);case 61:e.next=56;break;case 63:console.log("[GameMap] Loaded "+n.npcs.length+" NPCs");case 64:if(!n.decorations){e.next=74;break}V=r(n.decorations);case 66:if((W=V()).done){e.next=73;break}return q=W.value,H=new v(q.position.x,q.position.z),e.next=71,this.placeDecorationAt(q.blockId,H);case 71:e.next=66;break;case 73:console.log("[GameMap] Loaded "+n.decorations.length+" decorations");case 74:return this._mapSaveData=n,this.mapId=n.mapId,this.rebuildPropertyContainersAfterLoad&&this.rebuildPropertyContainers(),console.log("[GameMap] Map loaded successfully: "+d+" tiles, "+y+" objects"),this.focusCameraOnMapCenter(),e.abrupt("return",!0);case 82:return e.prev=82,e.t1=e.catch(0),console.error("[GameMap] Failed to load map:",e.t1),e.abrupt("return",!1);case 86:case"end":return e.stop()}}),e,this,[[0,82],[5,13]])})));return function(t,i){return e.apply(this,arguments)}}(),d.loadFromGameSession=function(){var e=l(c().mark((function e(t){var i,n,a,o,s,l,d,u,p,h,g,f,v,x,m,b,y;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,console.log("[GameMap] 从 GameSession 加载场景"),this._session=t,this.clearMap(),i=t.getTiles(),n=t.getBuildings(),a=t.getAllNPCs(),o=t.getAllPlayers(),console.log("[GameMap] 场景数据统计"),console.log("  Tiles:",i.length),console.log("  Buildings:",n.length),console.log("  NPCs:",a.length),console.log("  Players:",o.length),s=r(i);case 14:if((l=s()).done){e.next=20;break}return d=l.value,e.next=18,this.renderGameTile(d);case 18:e.next=14;break;case 20:u=r(n);case 21:if((p=u()).done){e.next=27;break}return h=p.value,e.next=25,this.renderGameBuilding(h);case 25:e.next=21;break;case 27:g=r(a);case 28:if((f=g()).done){e.next=35;break}return v=f.value,x=v.getTileId(),e.next=33,this.renderNPC(v,x);case 33:e.next=28;break;case 35:m=r(o);case 36:if((b=m()).done){e.next=42;break}return y=b.value,e.next=40,this.renderPlayer(y);case 40:e.next=36;break;case 42:return this._isEditMode&&this.focusCameraOnMapCenter(),console.log("[GameMap] 场景加载完成"),e.abrupt("return",!0);case 47:return e.prev=47,e.t0=e.catch(0),console.error("[GameMap] Failed to load from GameSession:",e.t0),e.abrupt("return",!1);case 51:case"end":return e.stop()}}),e,this,[[0,47]])})));return function(t){return e.apply(this,arguments)}}(),d.loadFromChainData=function(){var e=l(c().mark((function e(t,i){var n,a,o;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("[GameMap] Loading map from chain data..."),console.log("  Template id:",null==t?void 0:t.map_id),console.log("  Template tiles:",null==t||null==(n=t.tiles_static)?void 0:n.size),console.log("  Template buildings:",null==t||null==(a=t.buildings_static)?void 0:a.size),console.log("  Game ID:",null==i?void 0:i.id),o=$(t,i,"chain_"+i.id),e.next=9,this._loadMapFromData(o);case 9:return e.abrupt("return",e.sent);case 12:return e.prev=12,e.t0=e.catch(0),console.error("[GameMap] Failed to load from chain data:",e.t0),e.abrupt("return",!1);case 16:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(t,i){return e.apply(this,arguments)}}(),d.renderGameTile=function(){var e=l(c().mark((function e(t){var i,n,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=new p("T_"+t.x+"_"+t.y)).setParent(this.tilesContainer),n=i.addComponent(G),e.next=5,n.initialize(t.blockId,new v(t.x,t.y));case 5:n.setTileId(t.tileId),n.setBuildingId(t.buildingId),n.setW(t.w),n.setN(t.n),n.setE(t.e),n.setS(t.s),a=t.x+"_"+t.y,this._tiles.push(n),this._tileIndex.set(a,n);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.renderGameBuilding=function(){var e=l(c().mark((function e(t){var i,n,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.x+"_"+t.y,n=new v(t.x,t.y),1!==t.size){e.next=7;break}return e.next=5,this.placeTileAt(t.blockId,n);case 5:e.next=10;break;case 7:if(2!==t.size){e.next=10;break}return e.next=10,this.place2x2Building(t.blockId,n);case 10:a={blockId:t.blockId,position:{x:t.x,z:t.y},size:t.size,direction:t.direction,buildingId:t.buildingId,entranceTileIds:t.entranceTileIds,chainPrevId:t.chainPrevId,chainNextId:t.chainNextId,owner:t.owner,level:t.level,price:Number(t.price)},this._buildingRegistry.set(i,a),this.createBuildingPaperActor(t.blockId,n,t.size,t.level||0,t.direction),this.createBuildingActor(t,n);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.renderNPC=function(){var e=l(c().mark((function e(t,i){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0,e.next=4,this.renderNPCWithComposite(t,i);case 4:e.next=8;break;case 6:return e.next=8,this.renderNPCWithPaperActor(t,i);case 8:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.renderNPCWithPaperActor=function(){var e=l(c().mark((function e(t,i){var n,a,o,r,s,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._session){e.next=4;break}return console.warn("[GameMap] Session not set, cannot render NPC"),e.abrupt("return");case 4:if(a=n.getTileByIndex(i)){e.next=8;break}return console.warn("[GameMap] Tile "+i+" not found for NPC"),e.abrupt("return");case 8:if(o=new x(a.x+.5,.5,a.y+.5),r=this.getNPCActorId(t.getKind()),s=W.createNPC(r,o)){e.next=14;break}return console.error("[GameMap] Failed to create NPC: "+r),e.abrupt("return");case 14:s.setParent(this._npcsRoot),s.name="NPC_"+t.getKind()+"_T"+i,(l=s.getComponent(q))&&(l.setRole(t),t.setPaperActor(l)),this._npcActors.set(i,s),console.log("[GameMap] Rendered NPC with PaperActor at tile "+i+":",r);case 20:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.removeNPCActor=function(e){var t=this._npcActors.get(e);t&&t.isValid?(t.destroy(),this._npcActors.delete(e),console.log("[GameMap] Removed NPC PaperActor at tile "+e)):console.warn("[GameMap] NPC PaperActor not found at tile "+e)},d.getNPCActorId=function(e){var t;return((t={})[Q.BARRIER]="web3:roadblock",t[Q.BOMB]="web3:bomb",t[Q.DOG]="web3:dog",t[Q.LAND_GOD]="web3:land_god",t[Q.WEALTH_GOD]="web3:wealth_god",t[Q.FORTUNE_GOD]="web3:fortune_god",t[Q.POOR_GOD]="web3:poverty_god",t)[e]||"web3:land_god"},d.getNPCBlockId=function(e){switch(e){case Q.BARRIER:return"web3:barrier";case Q.BOMB:return"web3:bomb";case Q.DOG:return"web3:dog";case Q.LAND_GOD:return"web3:land_god";case Q.WEALTH_GOD:return"web3:wealth_god";case Q.FORTUNE_GOD:return"web3:fortune_god";case Q.POOR_GOD:return"web3:poor_god";default:return"web3:land_god"}},d.renderNPCWithComposite=function(){var e=l(c().mark((function e(i,n){var a,o,r,s,l,d,u,h,g,f;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this._session){e.next=4;break}return console.warn("[GameMap] Session not set, cannot render NPC"),e.abrupt("return");case 4:if(o=a.getTileByIndex(n)){e.next=8;break}return console.warn("[GameMap] Tile "+n+" not found for NPC"),e.abrupt("return");case 8:return r=new x(o.x+.5,.8,o.y+.5),(s=new p("NPC_"+i.getKind()+"_T"+n)).setParent(this._npcsRoot),s.setWorldPosition(r),e.next=14,t.import("./CompositeVoxelActor.ts");case 14:return l=e.sent,d=l.CompositeVoxelActor,u=s.addComponent(d),h=this.getNPCBlockId(i.getKind()),g=i.getName(),f=Z.getNPCNameTexture(g),e.next=22,u.setConfig({components:[{blockId:h,position:new x(0,0,0),scale:new x(.7,.3,.7),techniqueIndex:1,overlays:[{texture:f,faces:[Y.UP],layerIndex:0,inflate:.002,techniqueIndex:1}]}]});case 22:this._npcActors.set(n,s),this.playNPCAnimation(u,i.getKind()),console.log("[GameMap] Rendered NPC with CompositeVoxelActor at tile "+n+":",{kind:i.getKind(),name:g,blockId:h,position:r});case 25:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.renderBuildingWithComposite=function(){var e=l(c().mark((function e(i,n){var a,o,r,s,l,d,u,h,g,f,v,m,b,y;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=i.size,o=i.level,r=1===a?new x(n.x+.5,.6,n.y+.5):new x(n.x+1,.6,n.y+1),s=.45+.1*o,l=1===a?new x(s,.1,s):new x(2*s,.1,2*s),(d=new p("B_"+a+"x"+a+"_"+n.x+"_"+n.y)).setParent(this._buildingsRoot),d.setWorldPosition(r),e.next=10,t.import("./CompositeVoxelActor.ts");case 10:return u=e.sent,h=u.CompositeVoxelActor,g=d.addComponent(h),f=Z.getBuildingLabelTexture(i.level,i.owner),e.next=16,g.setConfig({components:[{blockId:"web3:building_1x1",position:new x(0,0,0),scale:l,techniqueIndex:1,overlays:[{texture:f,faces:[Y.UP],layerIndex:0,inflate:.002,techniqueIndex:1}]}]});case 16:if(v=n.x+"_"+n.y,2===a)for(m=0;m<2;m++)for(b=0;b<2;b++)y=n.x+m+"_"+(n.y+b),this._buildingActors.set(y,d);else this._buildingActors.set(v,d);console.log("[GameMap] Rendered Building with CompositeVoxelActor at "+v+":",{size:a,level:i.level,position:r,scale:l});case 19:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.playNPCAnimation=function(e,t){switch(t){case Q.BOMB:e.playBounceAnimation(.15,.8),e.playRotateAnimation(2);break;case Q.DOG:e.playBounceAnimation(.1,.4,.3);break;case Q.WEALTH_GOD:case Q.FORTUNE_GOD:e.playFloatAnimation(.1,3),e.playRotateAnimation(4);break;case Q.POOR_GOD:e.playSwayAnimation(.05,1.6);break;case Q.BARRIER:e.playBreathAnimation(1.05,2);break;case Q.LAND_GOD:e.playRotateAnimation(5);break;default:e.playFloatAnimation(.05,2.5)}},d.renderPlayer=function(){var e=l(c().mark((function e(t){var i,n,a,o,r,s,l,d;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this._session){e.next=4;break}return console.warn("[GameMap] Session not set, cannot render Player"),e.abrupt("return");case 4:if(n=t.getPos(),a=i.getTileByIndex(n)){e.next=9;break}return console.warn("[GameMap] Tile "+n+" not found for Player"),e.abrupt("return");case 9:if(o=new x(a.x+.5,.5,a.y+.5),r=t.getPlayerIndex(),s=""+r,l=W.createPlayer(s,o)){e.next=16;break}return console.error("[GameMap] Failed to create Player: "+s),e.abrupt("return");case 16:l.setParent(this._playersRoot),l.name="Player_"+r,(d=l.getComponent(q))&&(d.setRole(t),t.setPaperActor(d)),this._playerActors.set(r,l),console.log("[GameMap] Rendered Player "+r+" at tile "+n);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d._loadMapFromData=function(){var e=l(c().mark((function e(t){var i,n,a,o,s,l,d,u,h,g,f,x,m,b,y,_,I,w,M,T,k;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,this.clearMap(),console.log("[GameMap] Loading from MapSaveData..."),console.log("  Tiles:",t.tiles.length),console.log("  Buildings:",(null==(i=t.buildings)?void 0:i.length)||0),n=r(t.tiles);case 6:if((a=n()).done){e.next=18;break}return o=a.value,(s=new p("T_"+o.position.x+"_"+o.position.z)).setParent(this.tilesContainer),l=s.addComponent(G),e.next=13,l.loadData(o);case 13:d=o.position.x+"_"+o.position.z,this._tiles.push(l),this._tileIndex.set(d,l);case 16:e.next=6;break;case 18:if(!t.buildings){e.next=38;break}u=r(t.buildings);case 20:if((h=u()).done){e.next=37;break}if(g=h.value,f=g.position.x+"_"+g.position.z,x=new v(g.position.x,g.position.z),1!==g.size){e.next=29;break}return e.next=27,this.placeTileAt(g.blockId,x);case 27:e.next=32;break;case 29:if(2!==g.size){e.next=32;break}return e.next=32,this.place2x2Building(g.blockId,x);case 32:m={blockId:g.blockId,position:g.position,size:g.size,direction:g.direction||0,buildingId:g.buildingId,entranceTileIds:g.entranceTileIds,chainPrevId:g.chainPrevId,chainNextId:g.chainNextId,owner:g.owner,level:g.level,price:g.price},this._buildingRegistry.set(f,m),this.createBuildingPaperActor(g.blockId,x,g.size,g.level||0,m.direction);case 35:e.next=20;break;case 37:console.log("[GameMap] Loaded "+t.buildings.length+" buildings");case 38:if(!t.npcs){e.next=48;break}b=r(t.npcs);case 40:if((y=b()).done){e.next=47;break}return _=y.value,I=new v(_.position.x,_.position.z),e.next=45,this.placeObjectAt(_.blockId,I);case 45:e.next=40;break;case 47:console.log("[GameMap] Loaded "+t.npcs.length+" NPCs");case 48:if(!t.decorations){e.next=58;break}w=r(t.decorations);case 50:if((M=w()).done){e.next=57;break}return T=M.value,k=new v(T.position.x,T.position.z),e.next=55,this.placeDecorationAt(T.blockId,k);case 55:e.next=50;break;case 57:console.log("[GameMap] Loaded "+t.decorations.length+" decorations");case 58:return this._mapSaveData=t,this.mapId=t.mapId,console.log("[GameMap] Map data loaded successfully"),console.log("  Total tiles:",this._tiles.length),console.log("  Total buildings:",this._buildingRegistry.size),this.focusCameraOnMapCenter(),e.abrupt("return",!0);case 67:return e.prev=67,e.t0=e.catch(0),console.error("[GameMap] Failed to load map from data:",e.t0),e.abrupt("return",!1);case 71:case"end":return e.stop()}}),e,this,[[0,67]])})));return function(t){return e.apply(this,arguments)}}(),d.clearMap=function(){for(var e,t=r(this._tiles);!(e=t()).done;){var i=e.value;i.node&&i.node.isValid&&i.node.destroy()}this._tiles=[],this._tileIndex.clear();for(var n,a=r(this._objects);!(n=a()).done;){n.value.destroyObject()}this._objects=[],this._objectIndex.clear(),this._decorations.forEach((function(e){e&&e.isValid&&e.destroy()})),this._decorations.clear(),this._decorationsRoot&&this._decorationsRoot.isValid&&this._decorationsRoot.removeAllChildren(),this._actors.forEach((function(e){e&&e.isValid&&e.destroy()})),this._actors.clear(),new Set(this._buildings.values()).forEach((function(e){e&&e.isValid&&e.destroy()})),this._buildings.clear(),new Set(this._buildingActors.values()).forEach((function(e){e&&e.isValid&&e.destroy()})),this._buildingActors.clear(),this._buildingRegistry.clear(),console.log("[GameMap] Map cleared")},d.getTileAt=function(e,t){var i=e+"_"+t;return this._tileIndex.get(i)||null},d.getObjectAt=function(e,t){var i=e+"_"+t;return this._objectIndex.get(i)||null},d.getAllTiles=function(){return[].concat(this._tiles)},d.getAllObjects=function(){return[].concat(this._objects)},d.getMapStats=function(){return{tileCount:this._tiles.length,objectCount:this._objects.length,mapId:this.mapId,isEditMode:this._isEditMode,hasVoxelSystem:null!==this._voxelSystem}},d.cleanup=function(){this._isEditMode&&this._hasUnsavedChanges&&(console.log("[GameMap] Saving unsaved changes before cleanup..."),this.saveImmediate()),this._autoSaveTimer&&(clearTimeout(this._autoSaveTimer),this._autoSaveTimer=null),this.hideIds(),this.clearAllOverlays(),this.clearMap(),this._isEditMode&&(B.off(R.UI.MapElementSelected,this.onMapElementSelected,this),B.off(N.REQUEST_PLACE,this.onRequestPlace,this),B.off(N.REQUEST_REMOVE,this.onRequestRemove,this),B.off(N.ELEMENT_CLICKED,this.onElementClicked,this)),this._voxelSystem=null,this._mapConfig=null,this._mapSaveData=null,this._currentSelectedBlockId=null,console.log("[GameMap] Cleanup completed")},d.findBestDirection=function(e,t){for(var i=0,n=[{dx:0,dz:1,dir:0},{dx:1,dz:0,dir:1},{dx:0,dz:-1,dir:2},{dx:-1,dz:0,dir:3}];i<n.length;i++){var a=n[i],o=a.dx,r=a.dz,s=a.dir,l=!1;if(1===t){var c=new v(e.x+o,e.y+r),d=c.x+"_"+c.y,u=this._tileIndex.get(d);u&&this.isPathTile(u)&&(l=!0)}else for(var p=0;p<2;p++){var h=e.x,g=e.y;0!==o?(h=e.x+(o>0?2:-1),g=e.y+p):(h=e.x+p,g=e.y+(r>0?2:-1));var f=h+"_"+g,x=this._tileIndex.get(f);if(x&&this.isPathTile(x)){l=!0;break}}if(l)return s}return 0},d.isPathTile=function(e){if(!e)return!1;var t=e.getBlockId();return"web3:building_1x1"!==t&&"web3:building_2x2"!==t},d.placeBuildingAt=function(){var e=l(c().mark((function e(t,i,n){var a,o,r,s,l,d,u,p,h,g,f;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[GameMap] Placing building "+t+" at ("+i.x+", "+i.y+") with size "+n),this.validateBuildingPosition(i,n)){e.next=3;break}return e.abrupt("return");case 3:if(a=i.x+"_"+i.y,2!==n){e.next=20;break}o=0;case 6:if(!(o<n)){e.next=20;break}r=0;case 8:if(!(r<n)){e.next=17;break}if(s=new v(i.x+o,i.y+r),l=s.x+"_"+s.y,!this._tileIndex.has(l)){e.next=14;break}return console.warn("[GameMap] Position ("+s.x+", "+s.y+") is occupied, cannot place 2x2 property"),e.abrupt("return");case 14:r++,e.next=8;break;case 17:o++,e.next=6;break;case 20:if(1!==n){e.next=28;break}return e.next=23,this.placeTileAt(t,i);case 23:d=i.x+"_"+i.y,(u=this._tileIndex.get(d))&&u.node&&u.node.isValid&&(u.node.name="Building1x1Tile_"+d),e.next=30;break;case 28:return e.next=30,this.place2x2Building(t,i);case 30:(p=this._buildings.get(a))&&(p.destroy(),this._buildings.delete(a)),h=this.findBestDirection(i,n),this.createBuildingPaperActor(t,i,n,0,h)||console.warn("[GameMap] Failed to create PaperActor for "+t),g=i.x+"_"+i.y,f={blockId:t,position:{x:i.x,z:i.y},size:n,direction:h},this._buildingRegistry.set(g,f),this._hasUnsavedChanges=!0,this.scheduleAutoSave();case 40:case"end":return e.stop()}}),e,this)})));return function(t,i,n){return e.apply(this,arguments)}}(),d.cycleBuildingDirection=function(e){var t=e.x+"_"+e.y,i=this._buildingRegistry.get(t);if(i){var n=((i.direction||0)+1)%4;i.direction=n;var a=this._buildings.get(t);if(a&&a.isValid){var o=a.getComponent(q);o&&(o.setDirection(n),console.log("[GameMap] Property direction cycled to "+n+" at ("+e.x+", "+e.y+")"))}this._hasUnsavedChanges=!0,this.scheduleAutoSave()}else console.warn("[GameMap] No property found at ("+e.x+", "+e.y+")")},d.createBuildingPaperActor=function(e,t,i,n,a){if(void 0===n&&(n=0),!this._isEditMode)return null;var o;o=1===i?new x(t.x+.5,.5,t.y+.5):new x(t.x+1,.5,t.y+1),void 0===a&&(a=this.findBestDirection(t,i));var r=W.createBuilding(e,n,o);if(r){r.parent=this._buildingsRoot,r.name="B_"+i+"x"+i+"_"+t.x+"_"+t.y;var s=r.getComponent(q);s&&s.setDirection(a);var l=t.x+"_"+t.y;if(2===i)for(var c=0;c<i;c++)for(var d=0;d<i;d++){var u=t.x+c+"_"+(t.y+d);this._buildings.set(u,r)}else this._buildings.set(l,r)}return r},d.isValidGridPosition=function(e){return e.x>=-50&&e.x<=50&&e.y>=-50&&e.y<=50},d.place2x2Building=function(){var e=l(c().mark((function e(t,i){var n,a,o,r,s,l,d,u,h,g,f,x,m,b;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(a="Property2x2_"+i.x+"_"+i.y,(o=null==(n=this.tilesContainer)?void 0:n.getChildByName(a))||(o=new p(a)).setParent(this.tilesContainer),r=0;r<2;r++)for(s=0;s<2;s++)l=new v(i.x+r,i.y+s),d=l.x+"_"+l.y,(u=this._tileIndex.get(d))&&this.removeTile(u);h=0;case 5:if(!(h<2)){e.next=23;break}g=0;case 7:if(!(g<2)){e.next=20;break}return f=new v(i.x+h,i.y+g),x=f.x+"_"+f.y,(m=new p("Building2x2Tile_"+f.x+"_"+f.y)).setParent(o),b=m.addComponent(G),e.next=15,b.initialize(t,f);case 15:this._tiles.push(b),this._tileIndex.set(x,b);case 17:g++,e.next=7;break;case 20:h++,e.next=5;break;case 23:o.isProperty2x2=!0,o.propertyBlockId=t,o.propertyPosition=i.clone();case 26:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.removeBuilding=function(e){var t=e.x+"_"+e.y,i=this._buildingRegistry.get(t);if(i){var n=this._buildings.get(t);if(n&&n.isValid&&n.destroy(),2===i.size)for(var a=0;a<2;a++)for(var o=0;o<2;o++){var r=e.x+a+"_"+(e.y+o);this._buildings.delete(r)}else this._buildings.delete(t);if(2===i.size){var s,l="Property2x2_"+e.x+"_"+e.y,c=null==(s=this.tilesContainer)?void 0:s.getChildByName(l);c&&c.destroy();for(var d=0;d<2;d++)for(var u=0;u<2;u++){var p=new v(e.x+d,e.y+u),h=p.x+"_"+p.y,g=this._tileIndex.get(h);g&&this.removeTile(g)}}else{var f=new v(e.x,e.y),x=f.x+"_"+f.y,m=this._tileIndex.get(x);m&&this.removeTile(m)}this._buildingRegistry.delete(t),this._hasUnsavedChanges=!0,this.scheduleAutoSave()}},d.rebuildPropertyContainers=function(){var e=this;this._buildingRegistry.forEach((function(t,i){var n;if(2===t.size){var a="Property2x2_"+t.position.x+"_"+t.position.z,o=null==(n=e.tilesContainer)?void 0:n.getChildByName(a);o||(o=new p(a)).setParent(e.tilesContainer);for(var r=0;r<2;r++)for(var s=0;s<2;s++){var l=t.position.x+r+"_"+(t.position.z+s),c=e._tileIndex.get(l);c&&c.node&&c.node.isValid&&(c.node.setParent(o),c.node.setScale(1,1,1))}o.isProperty2x2=!0,o.propertyBlockId=t.blockId,o.propertyPosition=new v(t.position.x,t.position.z)}}))},d.findBuilding2x2Info=function(e){for(var t,i=r(this._buildingRegistry);!(t=i()).done;){var n=t.value,a=(n[0],n[1]);if(2===a.size){var o=a.position;if(e.x>=o.x&&e.x<o.x+2&&e.y>=o.z&&e.y<o.z+2)return a}}var s=e.x+"_"+e.y;return this._buildingRegistry.get(s)||null},d.isPartOfBuilding2x2=function(e){var t=this.findBuilding2x2Info(e);return null!==t&&2===t.size},d.assignIds=function(){console.log("[GameMap] Starting ID assignment..."),this.clearAllIds(),this.assignTileIds(),this.assignBuildingIds(),this.calculateTileNeighbors(),this.calculateBuildingChains(),console.log("[GameMap] ID assignment completed"),this.scheduleAutoSave()},d.clearAllIds=function(){for(var e,t=r(this._tiles);!(e=t()).done;){e.value.setTileId(65535)}for(var i,n=r(this._buildingRegistry.values());!(i=n()).done;){i.value.buildingId=65535}console.log("[GameMap] All IDs cleared")},d.assignTileIds=function(){var e=this.findHospitalTiles();if(0!==e.length){for(var t,i=e[0],n=r(e);!(t=n()).done;){var a=t.value,o=a.getGridPosition(),s=i.getGridPosition();o.x<s.x&&(i=a)}var l=new Set;this.dfsAssignTileId(i,0,l),console.log("[GameMap] Assigned IDs to "+l.size+" tiles")}else console.warn("[GameMap] No hospital tiles found")},d.findHospitalTiles=function(){for(var e,t=[],i=r(this._tiles);!(e=i()).done;){var n=e.value;"web3:hospital"===n.getBlockId()&&t.push(n)}return t},d.dfsAssignTileId=function(e,t,i){var n=e.getGridPosition(),a=n.x+"_"+n.y;if(i.has(a))return t;var o=e.getBlockId();if("web3:building_1x1"===o||"web3:building_2x2"===o)return i.add(a),e.setTileId(65535),t;i.add(a),e.setTileId(t),t++;for(var r=0,s=[{x:0,y:1},{x:1,y:0},{x:0,y:-1},{x:-1,y:0}];r<s.length;r++){var l=s[r],c=new v(n.x+l.x,n.y+l.y),d=c.x+"_"+c.y,u=this._tileIndex.get(d);if(u&&!i.has(d)){var p=u.getBlockId();"web3:building_1x1"!==p&&"web3:building_2x2"!==p?t=this.dfsAssignTileId(u,t,i):(i.add(d),u.setTileId(65535))}}return t},d.assignBuildingIds=function(){var e=Array.from(this._buildingRegistry.values());e.sort((function(e,t){return e.position.z!==t.position.z?e.position.z-t.position.z:e.position.x-t.position.x}));for(var t=0;t<e.length;t++)e[t].buildingId=t;console.log("[GameMap] Assigned IDs to "+e.length+" buildings")},d.calculateTileNeighbors=function(){console.log("[GameMap] Calculating tile neighbors...");for(var e,t=0,i=0,n=r(this._tiles);!(e=n()).done;){var a=e.value,o=a.getTileId();if(65535!==o){var s=a.getGridPosition(),l=this.getTileAt(s.x-1,s.y),c=this.getTileAt(s.x,s.y-1),d=this.getTileAt(s.x+1,s.y),u=this.getTileAt(s.x,s.y+1),p=null==l?void 0:l.getTileId(),h=null==c?void 0:c.getTileId(),g=null==d?void 0:d.getTileId(),f=null==u?void 0:u.getTileId();a.setW(void 0!==p&&65535!==p?p:65535),a.setN(void 0!==h&&65535!==h?h:65535),a.setE(void 0!==g&&65535!==g?g:65535),a.setS(void 0!==f&&65535!==f?f:65535);var v=[a.getW(),a.getN(),a.getE(),a.getS()].filter((function(e){return 65535!==e})).length;if(0===v)t++,console.warn("[GameMap] Isolated tile: T"+o+" at ("+s.x+", "+s.y+") - no neighbors");else if(1===v){i++;var x=65535!==a.getW()?"w=T"+a.getW():65535!==a.getN()?"n=T"+a.getN():65535!==a.getE()?"e=T"+a.getE():"s=T"+a.getS();console.log("[GameMap] Endpoint tile: T"+o+" at ("+s.x+", "+s.y+"), "+x)}}}console.log("[GameMap] Tile neighbors calculated: "+t+" isolated, "+i+" endpoints"),this.validateTileNeighborConsistency()},d.validateTileNeighborConsistency=function(){console.log("[GameMap] Validating neighbor consistency...");for(var e,t=0,i=r(this._tiles);!(e=i()).done;){var n=e.value,a=n.getTileId();if(65535!==a){var o=n.getGridPosition(),s=n.getE();if(65535!==s){var l=this.findTileById(s);if(l){var c=l.getGridPosition();c.x===o.x+1&&c.y===o.y||(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").e=T"+s+": position error, T"+s+" at ("+c.x+","+c.y+") expected ("+(o.x+1)+","+o.y+")"),t++),l.getW()!==a&&(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").e=T"+s+", but T"+s+".w=T"+l.getW()+" (expected T"+a+")"),t++)}}var d=n.getW();if(65535!==d){var u=this.findTileById(d);if(u){var p=u.getGridPosition();p.x===o.x-1&&p.y===o.y||(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").w=T"+d+": position error, T"+d+" at ("+p.x+","+p.y+") expected ("+(o.x-1)+","+o.y+")"),t++),u.getE()!==a&&(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").w=T"+d+", but T"+d+".e=T"+u.getE()+" (expected T"+a+")"),t++)}}var h=n.getS();if(65535!==h){var g=this.findTileById(h);if(g){var f=g.getGridPosition();f.x===o.x&&f.y===o.y+1||(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").s=T"+h+": position error, T"+h+" at ("+f.x+","+f.y+") expected ("+o.x+","+(o.y+1)+")"),t++),g.getN()!==a&&(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").s=T"+h+", but T"+h+".n=T"+g.getN()+" (expected T"+a+")"),t++)}}var v=n.getN();if(65535!==v){var x=this.findTileById(v);if(x){var m=x.getGridPosition();m.x===o.x&&m.y===o.y-1||(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").n=T"+v+": position error, T"+v+" at ("+m.x+","+m.y+") expected ("+o.x+","+(o.y-1)+")"),t++),x.getS()!==a&&(console.warn("[GameMap] T"+a+"("+o.x+","+o.y+").n=T"+v+", but T"+v+".s=T"+x.getS()+" (expected T"+a+")"),t++)}}}}0===t?console.log("[GameMap] ✓ Tile neighbor consistency validation passed"):console.error("[GameMap] ✗ Tile neighbor consistency validation failed: "+t+" errors")},d.findTileById=function(e){for(var t,i=r(this._tiles);!(t=i()).done;){var n=t.value;if(n.getTileId()===e)return n}return null},d.calculateBuildingEntrances=function(){console.log("[GameMap] Calculating building entrances..."),this.assignIds();for(var e,t=new Map,i=r(this._buildingRegistry.values());!(e=i()).done;){var n=e.value,a=this.getAdjacentTilesInDirection(n);t.set(n,a)}for(var o,s=!1,l=r(t);!(o=l()).done;){var c=o.value,d=c[0],u=c[1],p=1===d.size?1:2,h=d.position;if(u.length===p)for(var g,f=r(u);!(g=f()).done;){var v=g.value,x=v.getTypeId(),m=v.getGridPosition();x!==D.EMPTY_LAND&&(console.warn("[GameMap] Building #"+d.buildingId+" at ("+h.x+", "+h.z+"): Entrance tile at ("+m.x+", "+m.y+") has invalid type "+x+" (must be EMPTY_LAND)"),s=!0)}else console.warn("[GameMap] Building #"+d.buildingId+" at ("+h.x+", "+h.z+"): Expected "+p+" entrance tiles, found "+u.length),s=!0}if(s)return console.error("[GameMap] Validation failed, calculation aborted"),!1;for(var b,y=r(t);!(b=y()).done;){var _,I=b.value,w=I[0],M=I[1];w.entranceTileIds=[M[0].getTileId(),(null==(_=M[1])?void 0:_.getTileId())||65535];for(var T,k=r(M);!(T=k()).done;){T.value.setBuildingId(w.buildingId)}}return this.scheduleAutoSave(),console.log("[GameMap] Building entrance calculation completed successfully"),!0},d.getAdjacentTilesInDirection=function(e){var t=e.position,i=e.size,n=e.direction,a=void 0===n?0:n,o=[];if(1===i){var r;switch(a){case 0:r=new v(t.x,t.z+1);break;case 1:r=new v(t.x+1,t.z);break;case 2:r=new v(t.x,t.z-1);break;case 3:r=new v(t.x-1,t.z);break;default:r=new v(t.x,t.z+1)}var s=this.getTileAt(r.x,r.y);s&&o.push(s)}else{var l=[];switch(a){case 0:l=[new v(t.x,t.z+2),new v(t.x+1,t.z+2)];break;case 1:l=[new v(t.x+2,t.z),new v(t.x+2,t.z+1)];break;case 2:l=[new v(t.x,t.z-1),new v(t.x+1,t.z-1)];break;case 3:l=[new v(t.x-1,t.z),new v(t.x-1,t.z+1)]}for(var c=0,d=l;c<d.length;c++){var u=d[c],p=this.getTileAt(u.x,u.y);p&&o.push(p)}}return o},d.showIds=function(){if(console.log("[GameMap] Showing ID labels..."),this.ensureIdLabelUIRoot()){this.clearIdLabels();for(var e,t=r(this._tiles);!(e=t()).done;){var i=e.value,n=i.getBlockId();if("web3:building_1x1"!==n&&"web3:building_2x2"!==n){var a=i.getTileId();if(65535!==a){var o=i.getGridPosition(),s=new x(o.x+.5,1.5,o.y+.5),l="tile_"+o.x+"_"+o.y,c=this.createIdLabel("T"+a,s,new f(255,255,255),l);this._idLabels.set(l,c),this._idLabelWorldPos.set(l,s)}}}for(var d,u=r(this._buildingRegistry.values());!(d=u()).done;){var p=d.value;if(void 0!==p.buildingId&&65535!==p.buildingId){var h=p.position.x,g=p.position.z;2===p.size?(h+=1,g+=1):(h+=.5,g+=.5);var v=new x(h,2,g),m="building_"+p.position.x+"_"+p.position.z,b=this.createIdLabel("B"+p.buildingId,v,new f(255,255,0),m);this._idLabels.set(m,b),this._idLabelWorldPos.set(m,v)}}console.log("[GameMap] Created "+this._idLabels.size+" ID labels")}else console.warn("[GameMap] Canvas not found, cannot show ID labels")},d.showIdsWithOverlay=function(){var e=l(c().mark((function e(){var t,i,n,a,o,s,l,d,u,p,h,g;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("[GameMap] Showing IDs with overlay..."),this.clearAllOverlays(),t=r(this._tiles);case 3:if((i=t()).done){e.next=13;break}if(n=i.value,65535===(a=n.getTileId())){e.next=11;break}return o=n.getGridPosition(),s=Z.getNumberTexture(a,{size:64,fontSize:28,bgColor:"rgba(255, 255, 255, 0.85)",textColor:"#000",withBorder:!0}),e.next=11,this.addTileOverlay(new v(o.x,o.y),{texture:s,faces:[Y.UP],inflate:.002,layerIndex:0,techniqueIndex:1});case 11:e.next=3;break;case 13:l=r(this._buildingRegistry);case 14:if((d=l()).done){e.next=25;break}if((u=d.value)[0],void 0===(p=u[1]).buildingId||65535===p.buildingId){e.next=23;break}if(h=p.position,g=Z.getNumberTexture(p.buildingId,{size:64,fontSize:28,bgColor:"rgba(255, 200, 100, 0.9)",textColor:"#000",withBorder:!0}),!this.getTileAt(h.x,h.z)){e.next=23;break}return e.next=23,this.addTileOverlay(new v(h.x,h.z),{texture:g,faces:[Y.UP],inflate:.003,layerIndex:1,techniqueIndex:0});case 23:e.next=14;break;case 25:console.log("[GameMap] IDs overlay created");case 26:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),d.hideIdsWithOverlay=function(){console.log("[GameMap] Hiding IDs overlay..."),this.clearAllOverlays()},d.showTileTypeOverlays=function(){var e=l(c().mark((function e(){var t,i,n,a,o,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("[GameMap] Showing tile type overlays..."),this.clearTileTypeOverlays(),t=r(this._tiles);case 3:if((i=t()).done){e.next=14;break}if(n=i.value,0!==(a=n.getTypeId())&&65535!==n.getTileId()){e.next=8;break}return e.abrupt("continue",12);case 8:return o=n.getGridPosition(),s=Z.getTileTypeTexture(a),e.next=12,this.addTileOverlay(new v(o.x,o.y),{texture:s,faces:[Y.UP],inflate:.0025,layerIndex:5,techniqueIndex:1});case 12:e.next=3;break;case 14:this._isShowingTileTypes=!0,console.log("[GameMap] Tile type overlays created");case 16:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),d.clearTileTypeOverlays=function(){console.log("[GameMap] Clearing tile type overlays..."),this._tileOverlays.forEach((function(e,t){var i=e.get(5);i&&i.isValid&&(i.destroy(),e.delete(5))})),this._isShowingTileTypes=!1,console.log("[GameMap] Tile type overlays cleared")},d.hideIds=function(){console.log("[GameMap] Hiding ID labels..."),this.clearIdLabels(),this._idLabelsRoot&&(this._idLabelsRoot.destroy(),this._idLabelsRoot=null),this._idLabelsRootUI&&(this._idLabelsRootUI.destroy(),this._idLabelsRootUI=null)},d.createIdLabel=function(e,t,i,n){this._idLabelsRootUI&&this._uiCanvas||this.ensureIdLabelUIRoot();var a=new p("IDLabel_"+e);a.addComponent(m),a.parent=this._idLabelsRootUI,a.layer=this._idLabelsRootUI.layer;var o=a.addComponent(b);return o.string=e,o.fontSize=18,o.lineHeight=20,o.color=i,o.useSystemFont=!0,o.fontFamily="Arial",o.overflow=b.Overflow.NONE,o.horizontalAlign=b.HorizontalAlign.CENTER,o.verticalAlign=b.VerticalAlign.CENTER,a.worldPos=t.clone(),this._idLabelWorldPos.set(n,t.clone()),this.updateSingleIdLabelPosition(n,a),a},d.clearIdLabels=function(){for(var e,t=r(this._idLabels.values());!(e=t()).done;){var i=e.value;i&&i.isValid&&i.destroy()}this._idLabels.clear(),this._idLabelWorldPos.clear(),this._idLabelsRootUI&&this._idLabelsRootUI.isValid&&this._idLabelsRootUI.removeAllChildren()},d.ensureIdLabelUIRoot=function(){if(this._uiCanvas&&this._idLabelsRootUI&&this._idLabelsRootUI.isValid)return!0;var e=y.getScene();if(!e)return!1;var t=e.getChildByName("Canvas");if(!t)return console.warn("[GameMap] Canvas node not found in scene"),!1;var i=t.getComponent(_);if(!i)return console.warn("[GameMap] Canvas component not found on Canvas node"),!1;this._uiCanvas=i;var n=t.getChildByName("IDLabelsRootUI");return n||((n=new p("IDLabelsRootUI")).addComponent(m),t.addChild(n)),n.layer=t.layer,this._idLabelsRootUI=n,!0},d.update=function(e){var t=this;this._uiCanvas&&this._idLabelsRootUI&&0!==this._idLabels.size&&this._idLabels.forEach((function(e,i){t.updateSingleIdLabelPosition(i,e)}))},d.updateSingleIdLabelPosition=function(e,t){if(this._uiCanvas&&this.mainCamera){var i=this._idLabelWorldPos.get(e)||t.worldPos;if(i){var n=this.mainCamera.worldToScreen(i),a=n.z<=0;if(t.active=!a,!a){var o=this._uiCanvas.node.getComponent(m);if(o){var r=o.convertToNodeSpaceAR(new x(n.x,n.y,0));t.setPosition(r)}}}}},d.addTileOverlay=function(){var e=l(c().mark((function e(t,i){var n,a,o;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.getTileAt(t.x,t.y)){e.next=4;break}return console.warn("[GameMap] Tile not found at ("+t.x+", "+t.y+")"),e.abrupt("return",!1);case 4:return e.next=6,X.createOverlay(n.node,i);case 6:if(!(a=e.sent)){e.next=12;break}return o=t.x+"_"+t.y,this._tileOverlays.has(o)||this._tileOverlays.set(o,new Map),this._tileOverlays.get(o).set(i.layerIndex||0,a),e.abrupt("return",!0);case 12:return e.abrupt("return",!1);case 13:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}(),d.removeTileOverlay=function(e,t){void 0===t&&(t=0);var i=e.x+"_"+e.y,n=this._tileOverlays.get(i);if(n){var a=n.get(t);a&&a.isValid&&(a.destroy(),n.delete(t),console.log("[GameMap] Removed overlay from tile at ("+e.x+", "+e.y+"), layer "+t),0===n.size&&this._tileOverlays.delete(i))}},d.removeAllTileOverlays=function(e){var t=e.x+"_"+e.y,i=this._tileOverlays.get(t);i&&(i.forEach((function(e,t){e&&e.isValid&&e.destroy()})),this._tileOverlays.delete(t),console.log("[GameMap] Removed all overlays from tile at ("+e.x+", "+e.y+")"))},d.updateTileOverlayTexture=function(e,t,i){var n,a=e.x+"_"+e.y,o=null==(n=this._tileOverlays.get(a))?void 0:n.get(t);o?(X.updateOverlayTexture(o,i),console.log("[GameMap] Updated overlay texture at ("+e.x+", "+e.y+"), layer "+t)):console.warn("[GameMap] Overlay not found at ("+e.x+", "+e.y+"), layer "+t)},d.updateTileOverlayColor=function(e,t,i){var n,a=e.x+"_"+e.y,o=null==(n=this._tileOverlays.get(a))?void 0:n.get(t);o&&X.updateOverlayColor(o,i)},d.hasTileOverlay=function(e,t){var i;void 0===t&&(t=0);var n=e.x+"_"+e.y;return(null==(i=this._tileOverlays.get(n))?void 0:i.has(t))||!1},d.showTileNeighbors=function(){var e=l(c().mark((function e(t){var i,n,a,o,r,s,l,d,u,p,h,g,f;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(65535!==(i=t.getTileId())){e.next=3;break}return e.abrupt("return");case 3:if(n=t.getW(),a=t.getN(),o=t.getE(),r=t.getS(),65535!==n||65535!==a||65535!==o||65535!==r){e.next=10;break}return console.log("[GameMap] T"+i+" has no neighbor data"),e.abrupt("return");case 10:t.getGridPosition(),console.log("[GameMap] Showing neighbors for T"+i+": w="+n+", n="+a+", e="+o+", s="+r),s=0,l=[{dir:"W",id:n},{dir:"N",id:a},{dir:"E",id:o},{dir:"S",id:r}];case 14:if(!(s<l.length)){e.next=28;break}if(d=l[s],u=d.dir,65535!==(p=d.id)){e.next=18;break}return e.abrupt("continue",25);case 18:if(h=this.findTileById(p)){e.next=21;break}return e.abrupt("continue",25);case 21:return g=h.getGridPosition(),f=Z.getLetterTexture(u),e.next=25,this.addTileOverlay(new v(g.x,g.y),{texture:f,faces:[Y.UP],inflate:.006,layerIndex:20,techniqueIndex:1});case 25:s++,e.next=14;break;case 28:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.clearTileNeighborOverlays=function(){for(var e,t=r(this._tiles);!(e=t()).done;){var i=e.value.getGridPosition();this.removeTileOverlay(new v(i.x,i.y),20)}},d.handleShowAssociation=function(){var e=l(c().mark((function e(t){var i,n,a,o;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[GameMap] Show association at ("+t.x+", "+t.y+")"),this.clearAssociationOverlays(),this.clearTileNeighborOverlays(),this.clearBuildingChainOverlay(),i=this.getTileAt(t.x,t.y),n=this.findBuilding2x2Info(t),!i||n){e.next=15;break}if(65535===(a=i.getBuildingId())){e.next=13;break}if(!(o=this.findBuildingById(a))){e.next=13;break}return e.next=13,this.showBuildingAssociation(o);case 13:return e.next=15,this.showTileNeighbors(i);case 15:if(!n){e.next=21;break}return e.next=18,this.showEntranceTilesAssociation(n);case 18:if(1!==n.size||void 0===n.buildingId){e.next=21;break}return e.next=21,this.showBuildingChainOverlay(n.buildingId);case 21:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.showBuildingAssociation=function(){var e=l(c().mark((function e(t){var i,n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.position,e.next=3,new Promise((function(e,t){T.load("textures/tileBuilding/texture",C,(function(i,n){i?(console.error("[GameMap] Failed to load tileBuilding texture:",i),t(i)):e(n)}))}));case 3:if(n=e.sent,!this.getTileAt(i.x,i.z)){e.next=9;break}return e.next=8,this.addTileOverlay(new v(i.x,i.z),{texture:n,faces:[Y.UP],inflate:.004,layerIndex:10,techniqueIndex:0});case 8:console.log("[GameMap] Showed building association at ("+i.x+", "+i.z+")");case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.showEntranceTilesAssociation=function(){var e=l(c().mark((function e(t){var i,n,a,o,s,l,d,u,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.entranceTileIds){e.next=4;break}return console.warn("[GameMap] Building has no entrance tiles"),e.abrupt("return");case 4:return e.next=6,new Promise((function(e,t){T.load("textures/buildingEntrance/texture",C,(function(i,n){i?t(i):e(n)}))}));case 6:return n=e.sent,e.next=9,new Promise((function(e,t){T.load("textures/highlightBorder/texture",C,(function(i,n){i?t(i):e(n)}))}));case 9:a=e.sent,o=i.filter((function(e){return 65535!==e})),s=r(this._tiles);case 12:if((l=s()).done){e.next=24;break}if(d=l.value,65535===(u=d.getTileId())||!o.includes(u)){e.next=22;break}return p=d.getGridPosition(),e.next=19,this.addTileOverlay(new v(p.x,p.y),{texture:n,faces:[Y.UP],inflate:.004,layerIndex:10,techniqueIndex:1});case 19:return e.next=21,this.addTileOverlay(new v(p.x,p.y),{texture:a,faces:[Y.NORTH,Y.SOUTH,Y.EAST,Y.WEST],color:new f(255,200,0,255),alpha:.6,inflate:.005,layerIndex:11,techniqueIndex:1});case 21:console.log("[GameMap] Showed entrance tile overlay at ("+p.x+", "+p.y+")");case 22:e.next=12;break;case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.clearAssociationOverlays=function(){this._tileOverlays.forEach((function(e,t){for(var i=10;i<=20;i++){var n=e.get(i);n&&n.isValid&&(n.destroy(),e.delete(i))}})),console.log("[GameMap] Cleared association overlays")},d.findBuildingById=function(e){for(var t,i=r(this._buildingRegistry);!(t=i()).done;){var n=t.value,a=(n[0],n[1]);if(a.buildingId===e)return a}return null},d.clearAllOverlays=function(){this._tileOverlays.forEach((function(e,t){e.forEach((function(e){e&&e.isValid&&e.destroy()}))})),this._tileOverlays.clear()},d.calculateBuildingChains=function(){var e=this;console.log("[GameMap] ===== Calculating building chains =====");var t=Array.from(this._buildingRegistry.values()).filter((function(e){return 1===e.size&&void 0!==e.buildingId}));console.log("[GameMap] Found "+t.length+" 1x1 buildings");for(var i,n=r(t);!(i=n()).done;){var a=i.value;a.chainPrevId=65535,a.chainNextId=65535}for(var o,s=new Map,l=r(t);!(o=l()).done;){var c,d=o.value,u=null!=(c=d.direction)?c:0;s.has(u)||s.set(u,[]),s.get(u).push(d)}s.forEach((function(e,t){console.log("[GameMap] Direction "+t+": "+e.length+" buildings"),e.forEach((function(e){console.log("  Building "+e.buildingId+" at ("+e.position.x+", "+e.position.z+")")}))})),s.forEach((function(t,i){e.calculateChainsForDirection(t,i)})),console.log("[GameMap] ----- Chain results -----");for(var p,h=r(t);!(p=h()).done;){var g=p.value;65535===g.chainPrevId&&65535===g.chainNextId||console.log("Building "+g.buildingId+": prev="+g.chainPrevId+", next="+g.chainNextId)}console.log("[GameMap] ===== Building chains calculated =====")},d.calculateChainsForDirection=function(e,t){console.log("[GameMap] --- Calculating chains for direction "+t+" ---");for(var i,n=1===t||3===t,a=new Map,o=r(e);!(i=o()).done;){var s=i.value,l=n?s.position.x:s.position.z;a.has(l)||a.set(l,[]),a.get(l).push(s)}console.log("[GameMap] Grouped into "+a.size+" "+(n?"columns(x)":"rows(z)")),a.forEach((function(e,t){var i=n?"x":"z";if(console.log("  "+i+"="+t+": "+e.length+" buildings"),e.length<2)console.log("    Only 1 building, no chain");else{e.sort((function(e,t){return n?e.position.z-t.position.z:e.position.x-t.position.x}));for(var a=0;a<e.length-1;a++){var o=e[a],r=e[a+1];1===(n?Math.abs(r.position.z-o.position.z):Math.abs(r.position.x-o.position.x))&&(o.chainNextId=r.buildingId,r.chainPrevId=o.buildingId,console.log("    ✓ "+o.buildingId+" ↔ "+r.buildingId))}}})),console.log("[GameMap] --- Direction "+t+" done ---")},d.getChainBuildings=function(e){var t=this.getBuildingById(e);if(!t||1!==t.size)return[e];for(var i=new Set([e]),n=e;;){var a=this.getBuildingById(n);if(!a||void 0===a.chainNextId||65535===a.chainNextId)break;if(i.has(a.chainNextId))break;i.add(a.chainNextId),n=a.chainNextId}for(n=e;;){var o=this.getBuildingById(n);if(!o||void 0===o.chainPrevId||65535===o.chainPrevId)break;if(i.has(o.chainPrevId))break;i.add(o.chainPrevId),n=o.chainPrevId}return Array.from(i).sort((function(e,t){return e-t}))},d.getBuildingById=function(e){for(var t,i=r(this._buildingRegistry.values());!(t=i()).done;){var n=t.value;if(n.buildingId===e)return n}},d.getTileById=function(e){for(var t,i=r(this._tiles);!(t=i()).done;){var n=t.value;if(n.getTileId()===e)return n}},d.showBuildingChainOverlay=function(){var e=l(c().mark((function e(t){var i,n,a,o,s,l,d,u,p,h,g,x,m;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(console.log("[GameMap] ===== Showing chain overlay for building "+t+" ====="),this.clearBuildingChainOverlay(),i=this.getChainBuildings(t),console.log("[GameMap] Chain building IDs: ["+i.join(", ")+"]"),n=r(i);!(a=n()).done;)o=a.value,(s=this.getBuildingById(o))&&console.log("  Building "+o+": pos=("+s.position.x+","+s.position.z+"), prev="+(null!=(l=s.chainPrevId)?l:65535)+", next="+(null!=(d=s.chainNextId)?d:65535));return e.next=7,new Promise((function(e,t){T.load("textures/street/texture",C,(function(i,n){i?(console.error("[GameMap] Failed to load street texture:",i),t(i)):e(n)}))}));case 7:if(u=e.sent){e.next=11;break}return console.error("[GameMap] Street texture not loaded"),e.abrupt("return");case 11:p=r(i);case 12:if((h=p()).done){e.next=24;break}if(g=h.value,x=this.getBuildingById(g)){e.next=18;break}return console.warn("[GameMap] Building "+g+" not found in registry"),e.abrupt("continue",22);case 18:return m=x.position,console.log("[GameMap] Adding overlay to building "+g+" at ("+m.x+", "+m.z+")"),e.next=22,this.addTileOverlay(new v(m.x,m.z),{texture:u,faces:[Y.UP],color:new f(100,200,255,255),alpha:.8,inflate:.006,layerIndex:30,techniqueIndex:1});case 22:e.next=12;break;case 24:console.log("[GameMap] ===== Chain overlay shown for "+i.length+" buildings ====="),console.log("[GameMap] Chain building IDs: ["+i.join(", ")+"]");case 26:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.clearBuildingChainOverlay=function(){this._tileOverlays.forEach((function(e,t){var i=e.get(30);i&&i.isValid&&(i.destroy(),e.delete(30))})),console.log("[GameMap] Chain overlay cleared")},d.getTileCount=function(){return this._tiles.filter((function(e){return 65535!==e.getTileId()})).length},d.getBuildingCount=function(){return Array.from(this._buildingRegistry.values()).filter((function(e){return void 0!==e.buildingId&&65535!==e.buildingId})).length},d.getTotalTileCount=function(){return this._tiles.length},d.getTotalBuildingCount=function(){return this._buildingRegistry.size},d.getTiles=function(){return this._tiles},d.getBuildingRegistry=function(){return this._buildingRegistry},d.validateGridPosition=function(e){var t=e.x,n=e.y,a=t>=i.MIN_GRID_COORD&&t<=i.MAX_GRID_COORD&&n>=i.MIN_GRID_COORD&&n<=i.MAX_GRID_COORD&&Number.isInteger(t)&&Number.isInteger(n);return a||(J.warning("坐标超出范围！\n\n位置: ("+t+", "+n+")\n有效范围: 0-255\n\nMove 链使用 u8 存储坐标，\n只支持 0-255 范围内的整数坐标"),console.warn("[GameMap] Grid position out of range: ("+t+", "+n+"), valid range: ["+i.MIN_GRID_COORD+", "+i.MAX_GRID_COORD+"]")),a},d.validateBuildingPosition=function(e,t){if(!this.validateGridPosition(e))return!1;if(2===t)for(var i=0,n=[new v(e.x+1,e.y),new v(e.x,e.y+1),new v(e.x+1,e.y+1)];i<n.length;i++){var a=n[i];if(!this.validateGridPosition(a))return!1}return!0},d.calculateMapCenter=function(){if(0===this._tiles.length){console.log("[GameMap] No tiles, using default center (15, 15)");var e=new v(15,15);return new x(e.x+.5,0,e.y+.5)}var t=0,i=0;this._tiles.forEach((function(e){var n=e.getGridPosition();t+=n.x,i+=n.y}));var n=Math.floor(t/this._tiles.length),a=Math.floor(i/this._tiles.length);return console.log("[GameMap] Map center calculated: grid("+n+", "+a+") from "+this._tiles.length+" tiles"),new x(n+.5,0,a+.5)},d.focusCameraOnMapCenter=function(){var e=this.calculateMapCenter(),t=g("Main Camera");if(t){var i=t.getComponent(P);i?(i.lookAt(e,!1),console.log("[GameMap] Camera focused on map center: world("+e.x.toFixed(1)+", "+e.y.toFixed(1)+", "+e.z.toFixed(1)+")")):console.warn("[GameMap] No CameraController found")}else console.warn("[GameMap] No Main Camera found")},s(i,[{key:"isEditMode",get:function(){return this._isEditMode}},{key:"isInitialized",get:function(){return this._isInitialized}},{key:"currentMapId",get:function(){return this.mapId}}]),i}(I)).MIN_GRID_COORD=0,xe.MAX_GRID_COORD=255,de=i((ce=xe).prototype,"mapId",[te],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"default_map"}}),ue=i(ce.prototype,"tilesContainer",[ie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pe=i(ce.prototype,"objectsContainer",[ne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),he=i(ce.prototype,"mainCamera",[ae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ge=i(ce.prototype,"enableEditMode",[oe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fe=i(ce.prototype,"debugMode",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ve=i(ce.prototype,"rebuildPropertyContainersAfterLoad",[se],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),le=ce))||le));d._RF.pop()}}}));

System.register("chunks:///_virtual/GameSession.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./constants.ts","./Player.ts","./NPC.ts","./GameTile.ts","./GameBuilding.ts","./MapManager.ts","./SuiManager.ts","./IdFormatter.ts"],(function(e,n){var t,s,i,o,a,r,l,u,c,d,h,g,m,_,p,y,f;return{setters:[function(e){t=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){i=e.cclegacy,o=e.Vec3},function(e){a=e.EventBus},function(e){r=e.EventTypes},function(e){l=e.Blackboard},function(e){u=e.PendingDecision,c=e.NO_OWNER,d=e.GameStatus},function(e){h=e.Player},function(e){g=e.NPC},function(e){m=e.GameTile},function(e){_=e.GameBuilding},function(e){p=e.MapManager},function(e){y=e.SuiManager},function(e){f=e.IdFormatter}],execute:function(){i._RF.push({},"cb46cD6IC1AF6tZHp2nbauc","GameSession",void 0);e("GameSession",function(){function e(){this._gameId="",this._status=d.READY,this._templateMapId="",this._mySeat=null,this._round=0,this._turn=0,this._activePlayerIndex=0,this._hasRolled=!1,this._players=[],this._myPlayer=null,this._myPlayerIndex=-1,this._npcs=[],this._pendingDecision=null,this._mapTemplate=null,this._gameData=null,this._tiles=[],this._buildings=[],this._gameMap=null,this._maxRounds=0,this._priceRiseDays=15,this._winner=null,console.log("[GameSession] GameSession 实例创建")}var i=e.prototype;return i.loadFromMoveGame=function(){var e=t(s().mark((function e(t,i,o){var l,u,c;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[GameSession] 从 Move 数据加载游戏会话"),console.log("  Game ID:",t.id),this._mapTemplate=i,this._gameData=o,this._gameId=t.id,this._status=t.status,this._templateMapId=t.template_map_id,this._round=t.round,this._turn=t.turn,this._activePlayerIndex=t.active_idx,this._hasRolled=t.has_rolled,this._maxRounds=t.max_rounds,this._priceRiseDays=t.price_rise_days,this._winner=t.winner||null,console.log("[GameSession] 合并地图数据..."),this._tiles=this.mergeTiles(i,t),this._buildings=this.mergeBuildings(i,t),console.log("[GameSession] 合并完成："+this._tiles.length+" tiles, "+this._buildings.length+" buildings"),this.loadPlayers(t.players),this.loadNPCs(t.npc_on,t.tiles),this.identifyMyPlayer(),this.loadPendingDecision(t),console.log("[GameSession] "),console.log("[GameSession] 数据加载完成， 发送 GameStart 事件，触发 -> UIInGame 的切换。"),console.log("[GameSession]  GameSession:",this),console.log("[GameSession]  Game:",t),console.log("[GameSession]  Template:",i),console.log("[GameSession]  GameData:",o),a.emit(r.Game.GameStart,{mode:"play",source:"chain_game"}),console.log("[GameSession] 开始加载游戏地图..."),e.next=32,this.loadGameMap();case 32:return console.log("[GameSession] 游戏会话加载完成",{gameId:this._gameId,status:this._status,round:this._round,turn:this._turn,playerCount:this._players.length,tileCount:this._tiles.length,buildingCount:this._buildings.length,npcCount:this._npcs.length}),a.emit(r.Game.SessionLoaded,{session:this,game:t}),console.log("[GameSession] 刷新玩家资产..."),e.next=37,n.import("./SuiManager.ts");case 37:return l=e.sent,u=l.SuiManager,e.next=41,u.instance.loadPlayerAssets();case 41:console.log("[GameSession] 玩家资产已刷新"),(c=u.instance.playerAssets)&&(this._mySeat=c.findSeatByGame(this._gameId),this._mySeat?console.log("[GameSession] 当前游戏 Seat 已缓存:",this._mySeat.id):console.warn("[GameSession] 未找到当前游戏的 Seat"));case 44:case"end":return e.stop()}}),e,this)})));return function(n,t,s){return e.apply(this,arguments)}}(),i.loadPlayers=function(e){var n=this;this._players=[],e.forEach((function(e,t){var s=new h;s.loadFromMovePlayer(e,t),n._players.push(s)})),console.log("[GameSession] 加载 "+this._players.length+" 个玩家")},i.loadNPCs=function(e,n){var t=this;this._npcs=[],n.forEach((function(n,s){var i=n.npc_on;if(65535!==i&&i<e.length){var o=e[i];if(o){var a=new g;a.loadFromMoveNPC(o,s),t._npcs.push(a)}}})),console.log("[GameSession] 加载 "+this._npcs.length+" 个NPC")},i.identifyMyPlayer=function(){var e=y.instance.currentAddress;if(e){console.log("[GameSession] identifyMyPlayer DEBUG:",{currentAddress:e,currentAddressShort:f.shortenAddress(e),playerCount:this._players.length,players:this._players.map((function(n,t){return{index:t,address:n.getOwner(),addressShort:f.shortenAddress(n.getOwner()),match:n.getOwner()===e}}))});var n=this._players.findIndex((function(n){return n.getOwner()===e}));n>=0?(this._myPlayer=this._players[n],this._myPlayerIndex=n,console.log("[GameSession] My player identified:"),console.log("  Player index:",n),console.log("  Address:",f.shortenAddress(e))):(console.warn("[GameSession] My player not found in game"),console.warn("  Current address:",e),console.warn("  Game players:",this._players.map((function(e){return e.getOwner()}))))}else console.warn("[GameSession] No current address, cannot identify my player")},i.loadPendingDecision=function(e){e.pending_decision!==u.NONE?this.setPendingDecision({type:e.pending_decision,tileId:e.decision_tile,amount:e.decision_amount}):this._pendingDecision=null},i.mergeTiles=function(e,n){var t=[];return e.tiles_static.forEach((function(e,s){var i=n.tiles[s],o=m.merge(e,i,s);t.push(o)})),console.log("[GameSession] 合并了 "+t.length+" 个 Tiles"),t},i.mergeBuildings=function(e,n){var t=[];return e.buildings_static.forEach((function(s,i){var o=n.buildings[i],a=_.merge(s,o,i,e);t.push(a)})),console.log("[GameSession] 合并了 "+t.length+" 个 Buildings"),t},i.loadGameMap=function(){var e=t(s().mark((function e(){var t,i,o,a,r,l;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[GameSession] 加载游戏地图..."),t=p.getInstance()){e.next=4;break}throw new Error("[GameSession] MapManager not found");case 4:return e.next=6,t.loadGameMapFromSession(this);case 6:if(this._gameMap=e.sent,console.log("[GameSession] 游戏地图加载完成"),this._initializeTileCenters(),!this._gameMap||this._gameMap.isEditMode){e.next=20;break}if(!(i=this.getActivePlayer())){e.next=20;break}if(!(o=i.getPaperActor())||!o.node){e.next=20;break}return e.next=16,n.import("./CameraController.ts");case 16:a=e.sent,r=a.CameraController,(l=r.getInstance())&&(l.setLookAtTarget(o.node.getWorldPosition()),console.log("[GameSession] 相机已设置跟随当前玩家:",i.getPlayerIndex()));case 20:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),i._initializeTileCenters=function(){var e=this;this._gameMap?(this._tiles.forEach((function(n,t){var s=null==e._gameMap.getTileNode?void 0:e._gameMap.getTileNode(t);if(s){var i=s.getWorldPosition().clone();i.x+=.5,i.y+=.5,i.z+=.5,n.setWorldCenter(i)}else{var a=new o(n.x+.5,.5,n.y+.5);n.setWorldCenter(a),console.warn("[GameSession] Tile "+t+" 节点未找到，使用计算坐标")}})),console.log("[GameSession] 已初始化 "+this._tiles.length+" 个 Tile 的顶部中心点")):console.warn("[GameSession] GameMap not found, skip tile centers initialization")},i.startTurn=function(){console.log("[GameSession] 开始回合 (Round "+this._round+", Turn "+this._turn+")");var e=this.getActivePlayer();e?(this._hasRolled=!1,a.emit(r.Game.TurnStart,{session:this,player:e,round:this._round,turn:this._turn})):console.warn("[GameSession] 无活跃玩家")},i.endTurn=function(){console.log("[GameSession] 结束回合 (Round "+this._round+", Turn "+this._turn+")");var e=this.getActivePlayer();a.emit(r.Game.TurnEnd,{session:this,player:e,round:this._round,turn:this._turn})},i.setRolled=function(e){this._hasRolled=e},i.setRound=function(e){if(this._round!==e){var n=this._round;this._round=e,console.log("[GameSession] 轮次变化: "+n+" -> "+e),a.emit(r.Game.RoundChanged,{session:this,oldRound:n,newRound:e})}},i.advance_turn=function(){var e=t(s().mark((function e(t){var i,o,l,u,c,d,h,g,m,_,p,y,f,G,P,S,v,x,I;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(l=this._players.length)){e.next=4;break}return console.warn("[GameSession] Cannot advance turn: no players in game"),e.abrupt("return");case 4:u=t,c=0,d=!1;case 7:if(u+1>=l&&(d=!0),u=(u+1)%l,c++,!(h=this._players[u])||h.isBankrupt()){e.next=14;break}return e.abrupt("break",19);case 14:if(!(c>=l)){e.next=17;break}return console.warn("[GameSession] All players bankrupt, this should not happen"),e.abrupt("break",19);case 17:e.next=7;break;case 19:if(g=u,this._turn!==g||this._activePlayerIndex!==g){e.next=22;break}return e.abrupt("return");case 22:if(m=this._turn,_=this._activePlayerIndex,this._turn=g,this._activePlayerIndex=g,this._hasRolled=!1,console.log("[GameSession] 回合推进: Turn "+m+" -> "+g+", ActivePlayer: "+_+" -> "+g+", will_wrap="+d+", attempts="+c),d&&(console.log("[GameSession] 检测到回绕，轮次递增: "+this._round+" -> "+(this._round+1)),this.setRound(this._round+1)),p=this.getActivePlayer(),console.log("[GameSession] advance_turn完成，activePlayer信息:",{playerIndex:null==p?void 0:p.getPlayerIndex(),owner:null==p?void 0:p.getOwner(),position:null==p?void 0:p.getPos(),hasPaperActor:!(null==p||!p.getPaperActor()),paperActorNodeName:null==p||null==(i=p.getPaperActor())||null==(i=i.node)?void 0:i.name,paperActorPosition:null==p||null==(o=p.getPaperActor())||null==(o=o.node)?void 0:o.getWorldPosition()}),a.emit(r.Game.TurnChanged,{session:this,oldPlayerIndex:_,newPlayerIndex:g,activePlayer:p,isMyTurn:this.isMyTurn()}),!p||!this._gameMap||this._gameMap.isEditMode){e.next=48;break}if(console.log("[GameSession] 准备设置相机跟随，检查条件:",{hasGameMap:!!this._gameMap,isEditMode:null==(y=this._gameMap)?void 0:y.isEditMode,activePlayerIndex:p.getPlayerIndex()}),P=p.getPaperActor(),console.log("[GameSession] PaperActor检查:",{hasPaperActor:!!P,hasNode:!(null==P||!P.node),nodeName:null==P||null==(f=P.node)?void 0:f.name,worldPosition:null==P||null==(G=P.node)?void 0:G.getWorldPosition()}),!P||!P.node){e.next=45;break}return e.next=39,n.import("./CameraController.ts");case 39:S=e.sent,v=S.CameraController,(x=v.getInstance())&&(I=P.node.getWorldPosition(),console.log("[GameSession] 设置相机目标位置:",{playerIndex:p.getPlayerIndex(),targetPos:"("+I.x.toFixed(2)+", "+I.y.toFixed(2)+", "+I.z.toFixed(2)+")"}),x.setLookAtTarget(I,!0),console.log("[GameSession] ✓ 相机已切换跟随新玩家:",p.getPlayerIndex())),e.next=46;break;case 45:console.warn("[GameSession] ✗ PaperActor或node不存在，无法设置相机");case 46:e.next=49;break;case 48:console.log("[GameSession] 跳过相机设置:",{reason:p?this._gameMap?this._gameMap.isEditMode?"isEditMode=true":"unknown":"no gameMap":"no activePlayer"});case 49:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),i.setPendingDecision=function(e){this._pendingDecision=e,e?(console.log("[GameSession] 设置待决策",e),a.emit(r.Game.DecisionPending,{session:this,decision:e})):(console.log("[GameSession] 清除待决策"),a.emit(r.Game.DecisionCleared,{session:this}))},i.clearPendingDecision=function(){this.setPendingDecision(null)},i.hasPendingDecision=function(){return null!==this._pendingDecision},i.getActivePlayer=function(){return this._activePlayerIndex>=0&&this._activePlayerIndex<this._players.length?this._players[this._activePlayerIndex]:null},i.getPlayerByIndex=function(e){return e>=0&&e<this._players.length?this._players[e]:null},i.getPlayerByAddress=function(e){return this._players.find((function(n){return n.getOwner()===e}))||null},i.getAllPlayers=function(){return[].concat(this._players)},i.getPlayerCount=function(){return this._players.length},i.getMyPlayer=function(){return this._myPlayer},i.getMyPlayerIndex=function(){return this._myPlayerIndex},i.isMyTurn=function(){return this._myPlayerIndex===this._activePlayerIndex},i.addNPC=function(e){this._npcs.push(e),console.log("[GameSession] 添加NPC到地块 "+e.getTileId()),a.emit(r.Game.NPCSpawned,{session:this,tileId:e.getTileId(),npc:e})},i.removeNPC=function(e){var n=this._npcs.findIndex((function(n){return n.getTileId()===e}));if(n>=0){var t=this._npcs[n];this._npcs.splice(n,1),console.log("[GameSession] 移除地块 "+e+" 上的NPC"),a.emit(r.Game.NPCRemoved,{session:this,tileId:e,npc:t})}},i.getNPCAtTile=function(e){return this._npcs.find((function(n){return n.getTileId()===e}))||null},i.getNPCByIndex=function(e){return this._npcs[e]||null},i.getAllNPCs=function(){return[].concat(this._npcs)},i.hasNPC=function(e){return this._npcs.some((function(n){return n.getTileId()===e}))},i.getNPCCount=function(){return this._npcs.length},i.updateBuilding=function(e,n,t,s){var i=this._buildings[e];if(i){var o=i.owner,l=i.level,u=i.buildingType,d=new _(i.buildingId,i.x,i.y,i.size,i.price,i.chainPrevId,i.chainNextId,n,t,null!=s?s:i.buildingType,i.blockId,i.direction,i.entranceTileIds);if(o!==c?d.originalOwner=o:i.originalOwner!==c?d.originalOwner=i.originalOwner:n!==c&&(d.originalOwner=n),this._buildings[e]=d,console.log("[GameSession] 建筑数据更新: Building "+e+", Owner: "+o+"->"+n+", Level: "+l+"->"+t+", BuildingType: "+u+"->"+d.buildingType+", OriginalOwner: "+d.originalOwner),this._gameMap&&this._gameMap.updateBuildingRender){var h=this._buildings[e];this._gameMap.updateBuildingRender(e,h.x,h.y,n,t)}a.emit(r.Game.BuildingChanged,{session:this,buildingId:e,oldOwner:o,newOwner:n,oldLevel:l,newLevel:t})}else console.warn("[GameSession] 建筑不存在: "+e)},i.setStatus=function(e){var n=this._status;this._status=e,console.log("[GameSession] 游戏状态变化: "+n+" -> "+e),a.emit(r.Game.StatusChanged,{session:this,oldStatus:n,newStatus:e})},i.isReady=function(){return this._status===d.READY},i.isActive=function(){return this._status===d.ACTIVE},i.isEnded=function(){return this._status===d.ENDED},i.setWinner=function(e){this._winner=e,e&&(console.log("[GameSession] 游戏胜利者:",e),a.emit(r.Game.GameEnded,{session:this,winner:e}))},i.getGameId=function(){return this._gameId},i.getStatus=function(){return this._status},i.getTemplateMapId=function(){return this._templateMapId},i.getMySeat=function(){return this._mySeat},i.getRound=function(){return this._round},i.getTurn=function(){return this._turn},i.getActivePlayerIndex=function(){return this._activePlayerIndex},i.hasRolled=function(){return this._hasRolled},i.getPendingDecision=function(){return this._pendingDecision},i.getMaxRounds=function(){return this._maxRounds},i.getPriceRiseDays=function(){return this._priceRiseDays},i.getWinner=function(){return this._winner},i.getMapTemplate=function(){return this._mapTemplate},i.getGameData=function(){return this._gameData},i.getTiles=function(){return[].concat(this._tiles)},i.getBuildings=function(){return[].concat(this._buildings)},i.getGameMap=function(){return this._gameMap},i.getTileByIndex=function(e){return this._tiles[e]||null},i.getBuildingByIndex=function(e){return this._buildings[e]||null},i.getBuildingByTileId=function(e){return this._buildings.find((function(n){return n.entranceTileIds.includes(e)}))||null},i.getTileWorldCenter=function(e){var n=this._tiles[e];return(null==n?void 0:n.getWorldCenter())||null},i.debugInfo=function(){return"[GameSession] "+["GameID: "+this._gameId,"Status: "+this._status,"Round: "+this._round,"Turn: "+this._turn,"ActivePlayer: "+this._activePlayerIndex,"Players: "+this._players.length,"NPCs: "+this._npcs.length,"HasRolled: "+this._hasRolled,"PendingDecision: "+(this._pendingDecision?this._pendingDecision.type:"None")].join(", ")},i.exitGameCleanup=function(){if(console.log("[GameSession] 开始清理游戏状态"),y.instance.unregisterGameEvents(),console.log("[GameSession] 游戏事件监听已取消"),this._gameMap){var e=p.getInstance();e&&(e.unloadCurrentMap(),console.log("[GameSession] GameMap 已卸载"))}this.reset(),l.instance.set("currentGameSession",null),console.log("[GameSession] Blackboard 已清理"),a.emit(r.Game.GameExit,{source:"game_session"}),console.log("[GameSession] 游戏状态清理完成")},i.reset=function(){console.log("[GameSession] 重置游戏会话"),this._gameId="",this._status=d.READY,this._templateMapId="",this._round=0,this._turn=0,this._activePlayerIndex=0,this._hasRolled=!1,this._players=[],this._myPlayer=null,this._myPlayerIndex=-1,this._mySeat=null,this._npcs=[],this._pendingDecision=null,this._maxRounds=0,this._priceRiseDays=15,this._winner=null,this._mapTemplate=null,this._gameData=null,this._tiles=[],this._buildings=[],this._gameMap=null,a.emit(r.Game.SessionReset,{session:this})},i.destroy=function(){console.log("[GameSession] 销毁游戏会话"),this._players.forEach((function(e){return e.destroy()})),this._players=[],this._npcs.forEach((function(e){return e.destroy()})),this._npcs=[],a.emit(r.Game.SessionDestroyed,{session:this})},e}());i._RF.pop()}}}));

System.register("chunks:///_virtual/GameSettings.ts",["cc"],(function(e){var t;return{setters:[function(e){t=e.cclegacy}],execute:function(){t._RF.push({},"e1449wU7ohATZzgIhgkKqFf","GameSettings",void 0);e("default",{designWidth:1920,designHeight:1080});t._RF.pop()}}}));

System.register("chunks:///_virtual/GameTile.ts",["cc","./constants.ts","./Web3BlockTypes.ts"],(function(t){var i,e,n,s,r;return{setters:[function(t){i=t.cclegacy},function(t){e=t.NO_BUILDING,n=t.INVALID_TILE_ID,s=t.TileKind},function(t){r=t.Web3TileType}],execute:function(){i._RF.push({},"f45fdYsfAxJ4rXogAkp7Dlb","GameTile",void 0);t("GameTile",function(){function t(t,i,e,n,s,r,h,u,d,o,c,l,a){this.tileId=void 0,this.x=void 0,this.y=void 0,this.kind=void 0,this.buildingId=void 0,this.special=void 0,this.w=void 0,this.n=void 0,this.e=void 0,this.s=void 0,this.npcIndex=void 0,this.blockId=void 0,this.typeId=void 0,this._worldCenter=null,this.tileId=t,this.x=i,this.y=e,this.kind=n,this.buildingId=s,this.special=r,this.w=h,this.n=u,this.e=d,this.s=o,this.npcIndex=c,this.blockId=l,this.typeId=a}t.merge=function(i,e,n){var s=this.getTileBlockId(i.kind),r=this.getTileTypeId(i.kind);return new t(n,i.x,i.y,i.kind,i.building_id,i.special,i.w,i.n,i.e,i.s,e.npc_on,s,r)};var i=t.prototype;return i.hasBuilding=function(){return this.buildingId!==e},i.hasNPC=function(){return this.npcIndex!==n},i.getNeighbors=function(){return[this.w,this.n,this.e,this.s]},i.getValidNeighbors=function(){var t=[];return this.w!==n&&t.push(this.w),this.n!==n&&t.push(this.n),this.e!==n&&t.push(this.e),this.s!==n&&t.push(this.s),t},i.getNeighborCount=function(){return this.getValidNeighbors().length},i.getPosition=function(){return{x:this.x,z:this.y}},i.getKindName=function(){return h(this.kind)},i.setWorldCenter=function(t){this._worldCenter=t},i.getWorldCenter=function(){return this._worldCenter},i.isFunctionalTile=function(){return this.kind===s.HOSPITAL||this.kind===s.LOTTERY||this.kind===s.CHANCE||this.kind===s.BONUS||this.kind===s.FEE||this.kind===s.CARD||this.kind===s.NEWS},t.getTileBlockId=function(t){switch(t){case s.EMPTY:return"web3:empty_land";case s.LOTTERY:return"web3:lottery";case s.HOSPITAL:return"web3:hospital";case s.CHANCE:return"web3:chance";case s.BONUS:return"web3:bonus";case s.FEE:return"web3:fee";case s.CARD:return"web3:card";case s.NEWS:return"web3:news";default:return console.warn("[GameTile] Unknown tile kind: "+t+", using empty_land"),"web3:empty_land"}},t.getTileTypeId=function(t){switch(t){case s.EMPTY:return r.EMPTY_LAND;case s.LOTTERY:return r.LOTTERY;case s.HOSPITAL:return r.HOSPITAL;case s.CHANCE:return r.CHANCE;case s.BONUS:return r.BONUS;case s.FEE:return r.FEE;case s.CARD:return r.CARD;case s.NEWS:return r.NEWS;default:return console.warn("[GameTile] Unknown tile kind: "+t+", using EMPTY_LAND"),r.EMPTY_LAND}},i.debugInfo=function(){return JSON.stringify({tileId:this.tileId,position:{x:this.x,y:this.y},kind:h(this.kind),buildingId:this.buildingId!==e?this.buildingId:"none",neighbors:{w:this.w!==n?this.w:"none",n:this.n!==n?this.n:"none",e:this.e!==n?this.e:"none",s:this.s!==n?this.s:"none"},hasNPC:this.hasNPC(),npcIndex:this.npcIndex!==n?this.npcIndex:"none"},null,2)},t}());function h(t){switch(t){case s.EMPTY:return"空地";case s.LOTTERY:return"乐透";case s.HOSPITAL:return"医院";case s.CHANCE:return"机会";case s.BONUS:return"奖励";case s.FEE:return"收费站";case s.CARD:return"卡片站";case s.NEWS:return"新闻站";default:return"未知("+t+")"}}i._RF.pop()}}}));

System.register("chunks:///_virtual/GridBoundary.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var i,r,n,t,o,a,l,s,u,d,c,h,m,f,p,b;return{setters:[function(e){i=e.applyDecoratedDescriptor,r=e.inheritsLoose,n=e.initializerDefineProperty,t=e.assertThisInitialized},function(e){o=e.cclegacy,a=e._decorator,l=e.find,s=e.Camera,u=e.Vec3,d=e.Node,c=e.Material,h=e.primitives,m=e.utils,f=e.MeshRenderer,p=e.Component,b=e.Color}],execute:function(){var y,w,C,g,v,z,k,G,M,_,L,x,B,P,R,I,O,F,U,N,T,D;o._RF.push({},"c269dUqZUlHkKgGCvMuPwOW","GridBoundary",void 0);var H=a.ccclass,V=a.property,j=a.executeInEditMode;e("GridBoundary",(y=H("GridBoundary"),w=j(!0),C=V({tooltip:"目标相机"}),g=V({tooltip:"边界颜色（橙黄色）"}),v=V({tooltip:"最小坐标（u8 最小值）"}),z=V({tooltip:"最大坐标（u8 最大值）"}),k=V({tooltip:"Y 高度（稍高于 grid）"}),G=V({tooltip:"是否显示原点标记"}),M=V({tooltip:"原点标记颜色（红色）"}),_=V({tooltip:"是否显示边界"}),L=V({tooltip:"备用边界线厚度（用于无GeometryRenderer环境）"}),y(x=w((P=i((B=function(e){function i(){for(var i,r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];return i=e.call.apply(e,[this].concat(o))||this,n(i,"cam",P,t(i)),n(i,"boundaryColor",R,t(i)),n(i,"minCoord",I,t(i)),n(i,"maxCoord",O,t(i)),n(i,"y",F,t(i)),n(i,"showOriginMarker",U,t(i)),n(i,"originColor",N,t(i)),n(i,"visible",T,t(i)),i._isInitialized=!1,i._useGeometryRenderer=!0,i._fallbackLineContainer=null,n(i,"fallbackLineThickness",D,t(i)),i}r(i,e);var o=i.prototype;return o.start=function(){this.initializeCamera()},o.update=function(){this.visible&&this.drawBoundary()},o.initializeCamera=function(){if(!this.cam){var e=l("Main Camera");e&&(this.cam=e.getComponent(s))}if(this.cam){if(this.cam.camera&&this.cam.camera.initGeometryRenderer)try{this.cam.camera.initGeometryRenderer()}catch(e){this._useGeometryRenderer=!1,console.warn("[GridBoundary] GeometryRenderer init failed, using fallback")}else this._useGeometryRenderer=!1;this._isInitialized=!0,console.log("[GridBoundary] Initialized")}else console.error("[GridBoundary] No camera found")},o.drawBoundary=function(){var e;if(this._isInitialized){var i=this._useGeometryRenderer?null==(e=this.cam)||null==(e=e.camera)?void 0:e.geometryRenderer:null;if(i){var r=this.minCoord+.5,n=this.maxCoord+.5,t=this.y;if(i.addLine(new u(r,t,r),new u(n,t,r),this.boundaryColor),i.addLine(new u(n,t,r),new u(n,t,n),this.boundaryColor),i.addLine(new u(n,t,n),new u(r,t,n),this.boundaryColor),i.addLine(new u(r,t,n),new u(r,t,r),this.boundaryColor),this.showOriginMarker){if(0>=this.minCoord&&0<=this.maxCoord&&0>=this.minCoord&&0<=this.maxCoord){i.addLine(new u(0,t,.5),new u(1,t,.5),this.originColor),i.addLine(new u(.5,t,0),new u(.5,t,1),this.originColor)}}}else this.ensureFallbackLines()}},o.ensureFallbackLines=function(){if(!this._fallbackLineContainer){var e=new d("GridBoundaryFallback");e.setParent(this.node),this._fallbackLineContainer=e;var i=new c;i.initialize({effectName:"builtin-unlit"}),i.setProperty("mainColor",this.boundaryColor.clone());for(var r=this.minCoord+.5,n=this.maxCoord+.5,t=this.y,o=Math.max(.001,this.fallbackLineThickness),a=n-r,l=[{pos:new u((r+n)/2,t,r),size:{w:a,l:o}},{pos:new u((r+n)/2,t,n),size:{w:a,l:o}},{pos:new u(r,t,(r+n)/2),size:{w:o,l:a}},{pos:new u(n,t,(r+n)/2),size:{w:o,l:a}}],s=0;s<l.length;s++){var p=new d("Boundary_"+s);p.setParent(e);var b=h.box({width:l[s].size.w,height:o,length:l[s].size.l}),y=m.MeshUtils.createMesh(b),w=p.addComponent(f);w.mesh=y,w.material=i,p.setPosition(l[s].pos)}if(this.showOriginMarker){var C=new c;C.initialize({effectName:"builtin-unlit"}),C.setProperty("mainColor",this.originColor.clone());var g=new d("Origin_H");g.setParent(e);var v=h.box({width:1,height:o,length:o}),z=m.MeshUtils.createMesh(v),k=g.addComponent(f);k.mesh=z,k.material=C,g.setPosition(.5,t,.5);var G=new d("Origin_V");G.setParent(e);var M=h.box({width:o,height:o,length:1}),_=m.MeshUtils.createMesh(M),L=G.addComponent(f);L.mesh=_,L.material=C,G.setPosition(.5,t,.5)}}},o.isInBounds=function(e,i){return e>=this.minCoord&&e<=this.maxCoord&&i>=this.minCoord&&i<=this.maxCoord},o.setVisible=function(e){this.visible=e},i}(p)).prototype,"cam",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R=i(B.prototype,"boundaryColor",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new b(255,200,0,255)}}),I=i(B.prototype,"minCoord",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),O=i(B.prototype,"maxCoord",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),F=i(B.prototype,"y",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.05}}),U=i(B.prototype,"showOriginMarker",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N=i(B.prototype,"originColor",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new b(255,0,0,255)}}),T=i(B.prototype,"visible",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),D=i(B.prototype,"fallbackLineThickness",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.03}}),x=B))||x)||x));o._RF.pop()}}}));

System.register("chunks:///_virtual/GridGround.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./EventTypes.ts"],(function(e){var i,t,n,r,o,s,a,l,h,d,c,u,m,f,p,g,b,G;return{setters:[function(e){i=e.applyDecoratedDescriptor,t=e.inheritsLoose,n=e.initializerDefineProperty,r=e.assertThisInitialized},function(e){o=e.cclegacy,s=e._decorator,a=e.find,l=e.Camera,h=e.Node,d=e.Material,c=e.primitives,u=e.utils,m=e.MeshRenderer,f=e.Color,p=e.Vec3,g=e.Component},function(e){b=e.EventBus},function(e){G=e.EventTypes}],execute:function(){var C,v,y,z,M,_,w,k,x,L,D,R,I,E,P,S,B,F,N,T,U,X,Y,H,W,Z,j,V,A,K,q,J,O,Q;o._RF.push({},"28c2cDjmWZK8pwnkWXxGf6G","GridGround",void 0);var $=s.ccclass,ee=s.property,ie=s.executeInEditMode;e("GridGround",(C=$("GridGround"),v=ie(!0),y=ee({tooltip:"目标相机"}),z=ee({tooltip:"网格间距（单位）"}),M=ee({tooltip:"最小坐标"}),_=ee({tooltip:"最大坐标"}),w=ee({tooltip:"半尺寸（已废弃，使用 min/maxCoord）"}),k=ee({tooltip:"网格颜色"}),x=ee({tooltip:"网格所在的 Y 高度"}),L=ee({tooltip:"是否启用点击检测"}),D=ee({tooltip:"是否启用网格对齐"}),R=ee({tooltip:"调试模式"}),I=ee({tooltip:"是否启用Mesh网格（用于调试点击偏移）"}),E=ee({tooltip:"Mesh网格颜色"}),P=ee({tooltip:"Mesh网格高度（稍微高于网格线）"}),S=ee({tooltip:"优先使用GeometryRenderer绘制网格"}),B=ee({tooltip:"备用网格线厚度（用于无GeometryRenderer环境）"}),C(F=v((T=i((N=function(e){function i(){for(var i,t=arguments.length,o=new Array(t),s=0;s<t;s++)o[s]=arguments[s];return i=e.call.apply(e,[this].concat(o))||this,n(i,"cam",T,r(i)),n(i,"step",U,r(i)),n(i,"minCoord",X,r(i)),n(i,"maxCoord",Y,r(i)),n(i,"halfSize",H,r(i)),n(i,"color",W,r(i)),n(i,"y",Z,r(i)),n(i,"enableClickDetection",j,r(i)),n(i,"enableSnapping",V,r(i)),n(i,"debugMode",A,r(i)),n(i,"enableMeshGrid",K,r(i)),n(i,"meshGridColor",q,r(i)),n(i,"meshGridHeight",J,r(i)),n(i,"useGeometryRenderer",O,r(i)),n(i,"fallbackLineThickness",Q,r(i)),i._isInitialized=!1,i._meshGridNodes=new Map,i._highlightedGrid=null,i._meshGridContainer=null,i._fallbackLineContainer=null,i._fallbackInitialized=!1,i}t(i,e);var o=i.prototype;return o.start=function(){this.log("GridGround start"),this.initializeCamera(),this.enableMeshGrid&&this.createMeshGrid(),this.enableClickDetection&&this.registerClickEvents()},o.update=function(){this.drawGrid()},o.onDestroy=function(){this.log("GridGround onDestroy"),this.unregisterClickEvents(),this.cleanupMeshGrid()},o.createWithConfig=function(e){void 0!==e.step&&(this.step=e.step),void 0!==e.halfSize&&(this.halfSize=e.halfSize),void 0!==e.color&&(this.color=e.color),void 0!==e.y&&(this.y=e.y),void 0!==e.enableClickDetection&&(this.enableClickDetection=e.enableClickDetection),void 0!==e.camera&&(this.cam=e.camera),this.initializeCamera(),this.enableMeshGrid&&this.createMeshGrid()},o.initializeCamera=function(){if(!this.cam){var e=a("Main Camera");e&&(this.cam=e.getComponent(l))}if(this.cam){if(this.useGeometryRenderer&&this.cam.camera&&this.cam.camera.initGeometryRenderer)try{this.cam.camera.initGeometryRenderer()}catch(e){this.useGeometryRenderer=!1,this.log("GeometryRenderer not available, use fallback mesh lines")}else!this.useGeometryRenderer||this.cam.camera&&this.cam.camera.initGeometryRenderer||(this.useGeometryRenderer=!1,this.log("GeometryRenderer missing, switching to fallback mesh lines"));this._isInitialized=!0,this.log("GeometryRenderer initialized")}else this.logError("No camera found for GridGround")},o.createMeshGrid=function(){this.log("Creating mesh grid for visualization..."),this._meshGridContainer||(this._meshGridContainer=new h("MeshGridContainer"),this._meshGridContainer.setParent(this.node));var e=this.minCoord,i=this.maxCoord,t=this.minCoord,n=this.maxCoord,r=Math.floor((i-e)/this.step)+1,o=Math.floor((n-t)/this.step)+1,s=new d;s.initialize({effectName:"builtin-unlit"});for(var a=0;a<r;a++)for(var l=0;l<o;l++){var f=e+a*this.step,p=t+l*this.step,g=a+"_"+l,b=new h("Grid_"+a+"_"+l);b.setParent(this._meshGridContainer);var G=c.box({width:.95*this.step,height:this.meshGridHeight,length:.95*this.step}),C=u.MeshUtils.createMesh(G);if(C){var v=b.addComponent(m);v.mesh=C,v.material=s,b.setPosition(f+.5*this.step,this.y+.5*this.meshGridHeight,p+.5*this.step),this._meshGridNodes.set(g,b)}}this.updateMeshGridColor(),this.log("Created "+this._meshGridNodes.size+" mesh grid cells")},o.updateMeshGridColor=function(){var e=this;this._meshGridContainer&&this._meshGridNodes.forEach((function(i){var t=i.getComponent(m);if(t&&t.material){var n=e.meshGridColor.clone();t.material.setProperty("mainColor",n)}}))},o.highlightGridCell=function(e,i){var t=this;if(this._highlightedGrid){var n=this._highlightedGrid.getComponent(m);n&&n.material&&n.material.setProperty("mainColor",this.meshGridColor)}var r=e-this.minCoord+"_"+(i-this.minCoord),o=this._meshGridNodes.get(r);if(o){var s=o.getComponent(m);if(s&&s.material){var a=new f(0,255,0,180);s.material.setProperty("mainColor",a),this._highlightedGrid=o,setTimeout((function(){t._highlightedGrid===o&&s.material&&(s.material.setProperty("mainColor",t.meshGridColor),t._highlightedGrid=null)}),3e3)}}},o.toggleMeshGrid=function(){this._meshGridContainer&&(this._meshGridContainer.active=!this._meshGridContainer.active,this.log("Mesh grid "+(this._meshGridContainer.active?"enabled":"disabled")))},o.cleanupMeshGrid=function(){this._meshGridContainer&&(this._meshGridContainer.destroy(),this._meshGridContainer=null),this._meshGridNodes.clear(),this._highlightedGrid=null,this._fallbackLineContainer&&(this._fallbackLineContainer.destroy(),this._fallbackLineContainer=null,this._fallbackInitialized=!1)},o.drawGrid=function(){var e;if(this._isInitialized){var i=this.useGeometryRenderer?null==(e=this.cam)||null==(e=e.camera)?void 0:e.geometryRenderer:null;if(i){for(var t=this.y,n=Math.max(.001,this.step),r=this.minCoord,o=this.maxCoord,s=this.minCoord,a=this.maxCoord,l=r;l<=o+1;l+=n)i.addLine(new p(l,t,s),new p(l,t,a+1),this.color);for(var h=s;h<=a+1;h+=n)i.addLine(new p(r,t,h),new p(o+1,t,h),this.color)}else this._fallbackInitialized||(this.createFallbackGridLines(),this._fallbackInitialized=!0)}},o.createFallbackGridLines=function(){this._fallbackLineContainer||(this._fallbackLineContainer=new h("GridLinesFallback"),this._fallbackLineContainer.setParent(this.node));var e=new d;e.initialize({effectName:"builtin-unlit"}),e.setProperty("mainColor",this.color.clone());for(var i=this.minCoord,t=this.maxCoord,n=this.minCoord,r=this.maxCoord,o=this.y,s=Math.max(.001,this.fallbackLineThickness),a=t-i+1,l=r-n+1,f=i;f<=t+1;f+=this.step){var p=new h("Line_X_"+f);p.setParent(this._fallbackLineContainer);var g=c.box({width:s,height:s,length:l}),b=u.MeshUtils.createMesh(g),G=p.addComponent(m);G.mesh=b,G.material=e,p.setPosition(f,o,n+l/2)}for(var C=n;C<=r+1;C+=this.step){var v=new h("Line_Z_"+C);v.setParent(this._fallbackLineContainer);var y=c.box({width:a,height:s,length:s}),z=u.MeshUtils.createMesh(y),M=v.addComponent(m);M.mesh=z,M.material=e,v.setPosition(i+a/2,o,C)}},o.registerClickEvents=function(){this.enableClickDetection&&(b.on(G.Input3D.MouseDown,this.onEventBusMouseDown,this),b.on(G.Input3D.MouseUp,this.onEventBusMouseUp,this),this.log("Click events registered (EventBus + Direct input)"))},o.unregisterClickEvents=function(){b.off(G.Input3D.MouseDown,this.onEventBusMouseDown,this),b.off(G.Input3D.MouseUp,this.onEventBusMouseUp,this),this.log("Click events unregistered")},o.onEventBusMouseDown=function(e){if(0===e.button&&this._isInitialized&&this.cam){var i={getLocationX:function(){return e.screenX},getLocationY:function(){return e.screenY},getButton:function(){return e.button||0}},t=this.performRaycast(i,this.cam);t&&this.handleGroundClick(t,e.button||0)}},o.onEventBusMouseUp=function(e){if(2===e.button&&this._isInitialized&&this.cam){var i={getLocationX:function(){return e.screenX},getLocationY:function(){return e.screenY},getButton:function(){return e.button||2}},t=this.performRaycast(i,this.cam);t&&this.handleGroundClick(t,e.button||2)}},o.performRaycast=function(e,i){var t=i.screenPointToRay(e.getLocationX(),e.getLocationY()),n=this.y;if(Math.abs(t.d.y)<.001)return null;var r=(n-t.o.y)/t.d.y;if(r<0)return null;var o=new p(t.o.x+r*t.d.x,n,t.o.z+r*t.d.z);return Math.abs(o.x)<=this.halfSize&&Math.abs(o.z)<=this.halfSize?o:null},o.handleGroundClick=function(e,i){void 0===i&&(i=0);var t=Math.floor(e.x/this.step),n=Math.floor(e.z/this.step),r={x:t,z:n},o=t*this.step+.5*this.step,s=n*this.step+.5*this.step,a=new p(o,e.y,s);this.enableSnapping||(a=e.clone());var l=new p(e.x,e.y-this.y,e.z);this.enableMeshGrid&&this.highlightGridCell(r.x,r.z),this.debugMode&&(console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("[GridGround] 点击检测 - BoxCollider计算"),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("原始点击位置: ("+e.x.toFixed(2)+", "+e.y.toFixed(2)+", "+e.z.toFixed(2)+")"),console.log("命中的格子索引: ["+r.x+", "+r.z+"]"),console.log("该格子的范围: X["+t*this.step+", "+(t+1)*this.step+"], Z["+n*this.step+", "+(n+1)*this.step+"]"),console.log("格子中心（对齐位置）: ("+a.x.toFixed(2)+", "+a.y.toFixed(2)+", "+a.z.toFixed(2)+")"),console.log("鼠标按键: "+(0===i?"左键":2===i?"右键":"其他")),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));var h={worldPosition:e.clone(),localPosition:l.clone(),snappedPosition:a.clone(),gridIndex:r,groundComponent:this,button:i};b.emit(G.Game.GroundClicked,h)},o.getGridInfo=function(){var e=2*this.halfSize,i=Math.floor(e/this.step)+1;return{step:this.step,halfSize:this.halfSize,totalSize:e,lineCount:i}},o.worldToGridIndex=function(e){return{x:Math.round(e.x/this.step),z:Math.round(e.z/this.step)}},o.gridIndexToWorld=function(e,i){return new p(e*this.step,this.y,i*this.step)},o.isValidGridIndex=function(e,i){return e>=this.minCoord&&e<=this.maxCoord&&i>=this.minCoord&&i<=this.maxCoord},o.setColor=function(e){this.color=e},o.log=function(e){this.debugMode&&console.log("[GridGround] "+e)},o.logError=function(e){console.error("[GridGround] "+e)},i}(g)).prototype,"cam",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U=i(N.prototype,"step",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X=i(N.prototype,"minCoord",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y=i(N.prototype,"maxCoord",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),H=i(N.prototype,"halfSize",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),W=i(N.prototype,"color",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f(130,130,130,255)}}),Z=i(N.prototype,"y",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),j=i(N.prototype,"enableClickDetection",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),V=i(N.prototype,"enableSnapping",[D],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A=i(N.prototype,"debugMode",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K=i(N.prototype,"enableMeshGrid",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q=i(N.prototype,"meshGridColor",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f(0,255,0,76)}}),J=i(N.prototype,"meshGridHeight",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.01}}),O=i(N.prototype,"useGeometryRenderer",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Q=i(N.prototype,"fallbackLineThickness",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.02}}),F=N))||F)||F));o._RF.pop()}}}));

System.register("chunks:///_virtual/HistoryStorage.ts",["cc","./WalkingPreference.ts"],(function(t){var e,r;return{setters:[function(t){e=t.cclegacy},function(t){r=t.createRotorRouterHistory}],execute:function(){e._RF.push({},"171642+q0JNzoyHxhR1A3Ny","HistoryStorage",void 0);var o="tycoon_rotor_history";t("HistoryStorage",function(){function t(){}return t.getStorageKey=function(t,e){var r=t.replace(/[^a-zA-Z0-9_]/g,"_");return o+"_"+r+"_"+e},t.save=function(t,e,r){try{var o=this.getStorageKey(t,e),a={lastDirection:Array.from(r.lastDirection.entries()),timestamp:Date.now()};localStorage.setItem(o,JSON.stringify(a)),console.log("[HistoryStorage] 历史记录已保存",{gameId:t,playerIndex:e,recordCount:r.lastDirection.size,key:o})}catch(t){console.error("[HistoryStorage] 保存失败",t)}},t.load=function(t,e){try{var o=this.getStorageKey(t,e),a=localStorage.getItem(o);if(!a)return console.log("[HistoryStorage] 未找到历史记录，返回空记录",{gameId:t,playerIndex:e}),r();var n=JSON.parse(a),c={lastDirection:new Map(n.lastDirection)};return console.log("[HistoryStorage] 历史记录已加载",{gameId:t,playerIndex:e,recordCount:c.lastDirection.size,age:Date.now()-n.timestamp}),c}catch(t){return console.error("[HistoryStorage] 加载失败",t),r()}},t.clear=function(t,e){try{var r=this.getStorageKey(t,e);localStorage.removeItem(r),console.log("[HistoryStorage] 历史记录已清除",{gameId:t,playerIndex:e,key:r})}catch(t){console.error("[HistoryStorage] 清除失败",t)}},t.clearAll=function(){try{for(var t=[],e=0;e<localStorage.length;e++){var r=localStorage.key(e);r&&r.startsWith(o)&&t.push(r)}for(var a=0,n=t;a<n.length;a++){var c=n[a];localStorage.removeItem(c)}console.log("[HistoryStorage] 所有历史记录已清除",{count:t.length})}catch(t){console.error("[HistoryStorage] 清除所有历史记录失败",t)}},t.exists=function(t,e){var r=this.getStorageKey(t,e);return null!==localStorage.getItem(r)},t.getAllKeys=function(){for(var t=[],e=0;e<localStorage.length;e++){var r=localStorage.key(e);r&&r.startsWith(o)&&t.push(r)}return t},t}());e._RF.pop()}}}));

System.register("chunks:///_virtual/IdFormatter.ts",["cc"],(function(t){var e;return{setters:[function(t){e=t.cclegacy}],execute:function(){e._RF.push({},"7d770LrNt1I979FRQpBY4SS","IdFormatter",void 0);t("IdFormatter",function(){function t(){}return t.shortenAddress=function(t,e,n){return void 0===e&&(e=6),void 0===n&&(n=4),!t||t.length<e+n?t:t.slice(0,e)+"..."+t.slice(-n)},t.shortenId=function(t,e,n){return void 0===e&&(e=8),void 0===n&&(n=6),!t||t.length<e+n?t:t.slice(0,e)+"..."+t.slice(-n)},t}());e._RF.pop()}}}));

System.register("chunks:///_virtual/index.ts",["cc","./UIManager.ts","./UIBase.ts","./UITypes.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./UIModeSelect.ts","./UIMapSelect.ts","./UIInGame.ts","./UIHelper.ts","./fairygui.mjs"],(function(e){var n;return{setters:[function(e){n=e.cclegacy},function(n){e("UIManager",n.UIManager)},function(n){e("UIBase",n.UIBase)},function(n){var t={};t.FGUIResourceType=n.FGUIResourceType,t.UIEventType=n.UIEventType,t.UILayer=n.UILayer,e(t)},function(n){e("EventBus",n.EventBus)},function(n){e("EventTypes",n.EventTypes)},function(n){e("Blackboard",n.Blackboard)},function(n){e("UIModeSelect",n.UIModeSelect)},function(n){e("UIMapSelect",n.UIMapSelect)},function(n){e("UIInGame",n.UIInGame)},function(n){e("UIHelper",n.UIHelper)},function(n){e("fgui",n)}],execute:function(){n._RF.push({},"0309f5lH39BlY7qkJpAkNH6","index",void 0),n._RF.pop()}}}));

System.register("chunks:///_virtual/index10.ts",["cc","./types2.ts","./aggregated.ts","./indexer.ts","./processor.ts","./cursor.ts"],(function(e){var t;return{setters:[function(e){t=e.cclegacy},function(t){e("EventType",t.EventType)},function(t){var n={};n.CASH_REASON_TEXT=t.CASH_REASON_TEXT,n.NPC_ACTION_TEXT=t.NPC_ACTION_TEXT,n.NPC_RESULT_TEXT=t.NPC_RESULT_TEXT,n.STOP_TYPE_TEXT=t.STOP_TYPE_TEXT,n.analyzePath=t.analyzePath,n.calculateTotalCashChange=t.calculateTotalCashChange,n.getAffectedPlayers=t.getAffectedPlayers,e(n)},function(t){var n={};n.TycoonEventIndexer=t.TycoonEventIndexer,n.createEventIndexer=t.createEventIndexer,e(n)},function(t){var n={};n.GameEffectType=t.GameEffectType,n.TycoonEventProcessor=t.TycoonEventProcessor,n.eventProcessor=t.eventProcessor,e(n)},function(t){var n={};n.SuiEventCursor=t.SuiEventCursor,n.createEventCursor=t.createEventCursor,e(n)}],execute:function(){t._RF.push({},"d74a6w9hEtNY6c5v/sDwUdn","index",void 0),t._RF.pop()}}}));

System.register("chunks:///_virtual/index11.ts",["cc","./SuiManager.ts"],(function(e){var n;return{setters:[function(e){n=e.cclegacy},function(n){var a={};a.SuiManager=n.SuiManager,a.suiManager=n.suiManager,e(a)}],execute:function(){n._RF.push({},"e5adaI4KI5NJqOxzvhNGWZf","index",void 0),n._RF.pop()}}}));

System.register("chunks:///_virtual/index12.ts",["cc","./Card.ts","./CardRegistry.ts","./MapRegistry.ts","./GameData.ts"],(function(t){var a;return{setters:[function(t){a=t.cclegacy},function(a){var r={};r.Card=a.Card,r.CardRarity=a.CardRarity,r.CardTargetType=a.CardTargetType,t(r)},function(a){t("CardRegistry",a.CardRegistry)},function(a){t("MapRegistry",a.MapRegistry)},function(a){t("GameData",a.GameData)}],execute:function(){a._RF.push({},"ee431LxRgJGZKfENKV/ck1l","index",void 0),a._RF.pop()}}}));

System.register("chunks:///_virtual/index13.ts",["./rollupPluginModLoBabelHelpers.js","cc","./index10.ts","./index9.ts","./MapGraph.ts","./BFSPathfinder.ts","./PathChoiceGenerator.ts","./indexer.ts","./processor.ts","./cursor.ts","./types2.ts","./aggregated.ts","./game2.ts"],(function(e){var t,n,r,a;return{setters:[function(e){t=e.asyncToGenerator,n=e.regeneratorRuntime},function(e){r=e.cclegacy},null,function(t){a=t.TycoonGameClient;var n={};n.AdminInteraction=t.AdminInteraction,n.CardInteraction=t.CardInteraction,n.PropertyInteraction=t.PropertyInteraction,n.TycoonGameClient=t.TycoonGameClient,n.initInteractions=t.initInteractions,e(n)},function(t){e("MapGraph",t.MapGraph)},function(t){e("BFSPathfinder",t.BFSPathfinder)},function(t){e("PathChoiceGenerator",t.PathChoiceGenerator)},function(t){var n={};n.TycoonEventIndexer=t.TycoonEventIndexer,n.createEventIndexer=t.createEventIndexer,e(n)},function(t){var n={};n.GameEffectType=t.GameEffectType,n.TycoonEventProcessor=t.TycoonEventProcessor,n.eventProcessor=t.eventProcessor,e(n)},function(t){var n={};n.SuiEventCursor=t.SuiEventCursor,n.createEventCursor=t.createEventCursor,e(n)},function(t){e("EventType",t.EventType)},function(t){var n={};n.CASH_REASON_TEXT=t.CASH_REASON_TEXT,n.NPC_ACTION_TEXT=t.NPC_ACTION_TEXT,n.NPC_RESULT_TEXT=t.NPC_RESULT_TEXT,n.STOP_TYPE_TEXT=t.STOP_TYPE_TEXT,n.analyzePath=t.analyzePath,n.calculateTotalCashChange=t.calculateTotalCashChange,n.getAffectedPlayers=t.getAffectedPlayers,e(n)},function(t){var n={};n.GameInteraction=t.GameInteraction,n.initGameInteraction=t.initGameInteraction,e(n)}],execute:function(){function o(){return(o=t(n().mark((function e(t){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.create({network:t.network,packageId:t.packageId,gameDataId:t.gameDataId});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}e("createTycoonClient",(function(e){return o.apply(this,arguments)})),r._RF.push({},"f58bd4NIaVD5YkgoD5Yu54y","index",void 0);e("DEFAULT_CONFIG",{network:"testnet",packageId:"0x0",gameDataId:"0x0"}),e("VERSION","1.0.0"),e("BUILD_DATE",(new Date).toISOString());r._RF.pop()}}}));

System.register("chunks:///_virtual/index2.ts",["cc","./SignerProvider.ts","./WalletSigner.ts","./KeypairSigner.ts"],(function(e){var n;return{setters:[function(e){n=e.cclegacy},null,function(n){e("WalletSigner",n.WalletSigner)},function(n){e("KeypairSigner",n.KeypairSigner)}],execute:function(){n._RF.push({},"11563T64jFI9YWnGlU+8T+e","index",void 0),n._RF.pop()}}}));

System.register("chunks:///_virtual/index3.ts",["cc","./VoxelSystem.ts","./BlockParser.ts","./types.ts","./TextureManager.ts","./MaterialFactory.ts","./MeshBuilder.ts","./VoxelBlock.ts","./VoxelSystemExample.ts","./VoxelConfig.ts","./VoxelMap.ts","./VoxelTypes.ts","./VoxelChunk.ts","./VoxelTerrain.ts","./VoxelWorld.ts","./VoxelNoise.ts","./VoxelMesh.ts","./VoxelRenderer.ts","./VoxelCuller.ts","./VoxelInteractionManager.ts","./VoxelRayCaster.ts"],(function(e){var o;return{setters:[function(e){o=e.cclegacy},function(o){var l={};l.VoxelSystem=o.VoxelSystem,l.getVoxelSystem=o.getVoxelSystem,l.isVoxelSystemReady=o.isVoxelSystemReady,e(l)},function(o){e("BlockParser",o.BlockParser)},function(o){e("isCross",o.isCross)},function(o){var l={};l.TextureManager=o.TextureManager,l.getGlobalTextureManager=o.getGlobalTextureManager,l.initializeGlobalTextureManager=o.initializeGlobalTextureManager,e(l)},function(o){var l={};l.MaterialFactory=o.MaterialFactory,l.MaterialType=o.MaterialType,l.getGlobalMaterialFactory=o.getGlobalMaterialFactory,l.initializeGlobalMaterialFactory=o.initializeGlobalMaterialFactory,e(l)},function(o){e("MeshBuilder",o.MeshBuilder)},function(o){var l={};l.BlockRegistry=o.BlockRegistry,l.BlockRenderType=o.BlockRenderType,l.VoxelBlockRegistry=o.VoxelBlockRegistry,l.VoxelBlockType=o.VoxelBlockType,e(l)},function(o){var l={};l.VoxelSystemExample=o.VoxelSystemExample,l.VoxelSystemTest=o.VoxelSystemTest,e(l)},function(o){e("VoxelConfig",o.VoxelConfig)},function(o){e("VoxelMapUtils",o.VoxelMapUtils)},null,function(o){e("VoxelChunkManager",o.VoxelChunkManager)},function(o){e("VoxelTerrain",o.VoxelTerrain)},function(o){e("VoxelWorld",o.VoxelWorld)},function(o){e("VoxelNoise",o.VoxelNoise)},function(o){e("VoxelMeshGenerator",o.VoxelMeshGenerator)},function(o){e("VoxelRenderer",o.VoxelRenderer)},function(o){e("VoxelCuller",o.VoxelCuller)},function(o){var l={};l.VoxelCameraMode=o.VoxelCameraMode,l.VoxelInteractionManager=o.VoxelInteractionManager,e(l)},function(o){var l={};l.RaycastAlgorithm=o.RaycastAlgorithm,l.VoxelRayCaster=o.VoxelRayCaster,e(l)}],execute:function(){o._RF.push({},"304dcnwVHlJWriZl1OAPuJ6","index",void 0),o._RF.pop()}}}));

System.register("chunks:///_virtual/index4.ts",["cc","./QueryService.ts","./AssetService.ts","./DataPollingService.ts"],(function(e){var t;return{setters:[function(e){t=e.cclegacy},function(t){e("QueryService",t.QueryService)},function(t){e("AssetService",t.AssetService)},function(t){e("DataPollingService",t.DataPollingService)}],execute:function(){t._RF.push({},"3a86fTbtTVOvLnZuim3kvt6","index",void 0),t._RF.pop()}}}));

System.register("chunks:///_virtual/index5.ts",["cc","./constants.ts","./game.ts","./map.ts","./cards.ts","./admin.ts","./assets.ts"],(function(e){var a;return{setters:[function(e){a=e.cclegacy},function(a){var i={};i.BuffKind=a.BuffKind,i.BuildingLevel=a.BuildingLevel,i.BuildingSize=a.BuildingSize,i.BuildingType=a.BuildingType,i.CardKind=a.CardKind,i.CashReason=a.CashReason,i.DEFAULT_BUILDING_PRICE_1X1=a.DEFAULT_BUILDING_PRICE_1X1,i.DEFAULT_BUILDING_PRICE_2X2=a.DEFAULT_BUILDING_PRICE_2X2,i.DEFAULT_HOSPITAL_TURNS=a.DEFAULT_HOSPITAL_TURNS,i.DEFAULT_MAX_PLAYERS=a.DEFAULT_MAX_PLAYERS,i.DEFAULT_MAX_ROUNDS=a.DEFAULT_MAX_ROUNDS,i.DEFAULT_TILE_BONUS_AMOUNT=a.DEFAULT_TILE_BONUS_AMOUNT,i.DEFAULT_TILE_FEE_AMOUNT=a.DEFAULT_TILE_FEE_AMOUNT,i.DecisionType=a.DecisionType,i.GameEndReason=a.GameEndReason,i.GamePhase=a.GamePhase,i.GameStatus=a.GameStatus,i.INVALID_TILE_ID=a.INVALID_TILE_ID,i.NO_BUILDING=a.NO_BUILDING,i.NO_OWNER=a.NO_OWNER,i.NpcAction=a.NpcAction,i.NpcKind=a.NpcKind,i.NpcResult=a.NpcResult,i.PendingDecision=a.PendingDecision,i.SkipReason=a.SkipReason,i.StopType=a.StopType,i.TileKind=a.TileKind,i.getGameStatusText=a.getGameStatusText,i.isLargeBuilding=a.isLargeBuilding,i.isLargeBuildingType=a.isLargeBuildingType,i.isSmallBuilding=a.isSmallBuilding,e(i)},function(a){var i={};i.canAct=a.canAct,i.getCardCount=a.getCardCount,i.hasBuffActive=a.hasBuffActive,i.hasOwner=a.hasOwner,i.isInHospital=a.isInHospital,e(i)},function(a){var i={};i.areAdjacent=a.areAdjacent,i.getAdjacentTiles=a.getAdjacentTiles,i.getBuildingTiles=a.getBuildingTiles,i.getDistance=a.getDistance,i.hasBuilding=a.hasBuilding,e(i)},function(a){var i={};i.CARD_EFFECTS=a.CARD_EFFECTS,i.calculateCardDrop=a.calculateCardDrop,i.cardNeedsParam=a.cardNeedsParam,i.cardNeedsTarget=a.cardNeedsTarget,i.getCardName=a.getCardName,i.validateCardParams=a.validateCardParams,e(i)},null,function(a){e("PlayerAssets",a.PlayerAssets)}],execute:function(){a._RF.push({},"48b94bnPoVPw6+sPQkDodka","index",void 0),a._RF.pop()}}}));

System.register("chunks:///_virtual/index6.ts",["./rollupPluginModLoBabelHelpers.js","cc","./types.ts","./utils.ts","./ResourceLoader.ts","./TemplateProcessor.ts","./BlockParser.ts"],(function(e){var r,t,a,o,n;return{setters:[function(e){r=e.asyncToGenerator,t=e.regeneratorRuntime,a=e.createForOfIteratorHelperLoose},function(e){o=e.cclegacy},function(r){e("isCross",r.isCross)},function(r){var t={};t.buildResourcePath=r.buildResourcePath,t.checkResourceExists=r.checkResourceExists,t.deepClone=r.deepClone,t.getPreferredTextureKey=r.getPreferredTextureKey,t.mergeTextures=r.mergeTextures,t.normalizeTexturePath=r.normalizeTexturePath,t.parseModelOrTexRef=r.parseModelOrTexRef,t.parseNamespacedId=r.parseNamespacedId,t.pickDefaultVariant=r.pickDefaultVariant,e(t)},function(r){e("ResourceLoader",r.ResourceLoader)},function(r){e("TemplateProcessor",r.TemplateProcessor)},function(r){n=r.BlockParser,e("BlockParser",r.BlockParser)}],execute:function(){e({clearGlobalCache:m,getCacheStats:k,getGlobalBlockParser:c,parseBlock:l,parseBlocks:i,preloadCommonBlocks:f}),o._RF.push({},"859045jZPNJtpdkWyTp8syT","index",void 0);var s=null;function c(e){return s||(s=new n(e)),s}function l(e,r){return u.apply(this,arguments)}function u(){return(u=r(t().mark((function e(r,a){var o;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=a?new n(a):c(),e.abrupt("return",o.parseBlock(r));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function i(e,r){return p.apply(this,arguments)}function p(){return(p=r(t().mark((function e(r,o){var s,l,u,i,p,f;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=o?new n(o):c(),l=[],u=a(r);case 3:if((i=u()).done){e.next=17;break}return p=i.value,e.prev=5,e.next=8,s.parseBlock(p);case 8:f=e.sent,l.push(f),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(5),console.error("[parseBlocks] 解析失败: "+p,e.t0);case 15:e.next=3;break;case 17:return e.abrupt("return",l);case 18:case"end":return e.stop()}}),e,null,[[5,12]])})))).apply(this,arguments)}function f(e){return d.apply(this,arguments)}function d(){return(d=r(t().mark((function e(r){var a,o,n;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=["minecraft:stone","minecraft:grass_block","minecraft:dirt","minecraft:cobblestone","minecraft:oak_planks","minecraft:oak_log","minecraft:sand","minecraft:glass","minecraft:oak_leaves","minecraft:water","minecraft:lava","minecraft:glowstone","web3:empty_land","web3:lottery","web3:hospital","web3:chance","web3:bonus","web3:fee","web3:card","web3:news","web3:land_god","web3:wealth_god","web3:fortune_god","web3:dog","web3:poverty_god","web3:roadblock","web3:bomb"],console.log("[preloadCommonBlocks] 开始预加载常用方块..."),o=Date.now(),e.next=5,i(a,r);case 5:n=Date.now()-o,console.log("[preloadCommonBlocks] 预加载完成，耗时 "+n+"ms");case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(){s&&s.clearCache()}function k(){return s?s.getCacheStats():{blockstates:0,models:0,textures:0}}e("default",{getGlobalBlockParser:c,parseBlock:l,parseBlocks:i,preloadCommonBlocks:f,clearGlobalCache:m,getCacheStats:k});o._RF.pop()}}}));

System.register("chunks:///_virtual/index7.ts",["cc","./SuiConfig.ts","./env.testnet.ts"],(function(e){var t,r,n;return{setters:[function(e){t=e.cclegacy},function(t){r=t.fromEnvConfig;var n={};n.DEFAULT_CLOCK_OBJECT_ID=t.DEFAULT_CLOCK_OBJECT_ID,n.DEFAULT_RANDOM_OBJECT_ID=t.DEFAULT_RANDOM_OBJECT_ID,n.fromEnvConfig=t.fromEnvConfig,n.getExplorerUrl=t.getExplorerUrl,n.getFallbackExplorerUrl=t.getFallbackExplorerUrl,n.getNetworkDisplayName=t.getNetworkDisplayName,n.getNetworkRpcUrl=t.getNetworkRpcUrl,e(n)},function(e){n=e.SuiEnvConfig}],execute:function(){t._RF.push({},"9bdaeO/DQNDNLqZOIAH2HW7","index",void 0);e("CURRENT_SUI_CONFIG",r(n));t._RF.pop()}}}));

System.register("chunks:///_virtual/index8.ts",["cc","./GameTile.ts","./GameBuilding.ts"],(function(e){var i;return{setters:[function(e){i=e.cclegacy},function(i){e("GameTile",i.GameTile)},function(i){e("GameBuilding",i.GameBuilding)}],execute:function(){i._RF.push({},"ac7e6zfTC5FOIZ4Tzfbp/+9","index",void 0),i._RF.pop()}}}));

System.register("chunks:///_virtual/index9.ts",["./rollupPluginModLoBabelHelpers.js","cc","./game2.ts","./loader.ts"],(function(t){var e,n,r,a,i,s,c;return{setters:[function(t){e=t.asyncToGenerator,n=t.regeneratorRuntime,r=t.createForOfIteratorHelperLoose},function(t){a=t.cclegacy},function(e){i=e.GameInteraction;var n={};n.GameInteraction=e.GameInteraction,n.initGameInteraction=e.initGameInteraction,t(n)},function(t){s=t.loadSuiTransactions,c=t.loadSuiClient}],execute:function(){t("initInteractions",(function(){return u.apply(this,arguments)})),a._RF.push({},"c9d77doF4lCQJvlA+ksW6si","index",void 0);var o=null;function u(){return(u=e(n().mark((function t(){var e,r;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o){t.next=6;break}return t.next=3,s();case 3:e=t.sent,r=e.Transaction,o=r;case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var p=t("PropertyInteraction",function(){function t(t,e,n){this.client=t,this.packageId=e,this.gameDataId=n}var r=t.prototype;return r.buyProperty=function(){var t=e(n().mark((function t(e,r,a,i){var s,c;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(s=new o).moveCall({target:this.packageId+"::game::decide_property_purchase",arguments:[s.object(e),s.object(r),s.object(this.gameDataId),s.object(a)]}),t.next=4,this.client.signAndExecuteTransaction({transaction:s,signer:i});case 4:return c=t.sent,t.abrupt("return",{success:!0,txHash:c.digest});case 6:case"end":return t.stop()}}),t,this)})));return function(e,n,r,a){return t.apply(this,arguments)}}(),r.upgradeProperty=function(){var t=e(n().mark((function t(e,r,a,i){var s,c;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(s=new o).moveCall({target:this.packageId+"::game::decide_property_upgrade",arguments:[s.object(e),s.object(r),s.object(this.gameDataId),s.object(a)]}),t.next=4,this.client.signAndExecuteTransaction({transaction:s,signer:i});case 4:return c=t.sent,t.abrupt("return",{success:!0,txHash:c.digest});case 6:case"end":return t.stop()}}),t,this)})));return function(e,n,r,a){return t.apply(this,arguments)}}(),t}()),d=t("CardInteraction",function(){function t(t,e,n,r){void 0===r&&(r="0x8"),this.client=t,this.packageId=e,this.gameDataId=n,this.randomObjectId=r}return t.prototype.useCard=function(){var t=e(n().mark((function t(e,r,a,i,s,c){var u,p;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(u=new o).moveCall({target:this.packageId+"::game::use_card",arguments:[u.object(e),u.object(r),u.pure.u8(i),u.pure.vector("u16",s),u.object(this.gameDataId),u.object(a),u.object(this.randomObjectId)]}),t.next=4,this.client.signAndExecuteTransaction({transaction:u,signer:c});case 4:return p=t.sent,t.abrupt("return",{success:!0,txHash:p.digest});case 6:case"end":return t.stop()}}),t,this)})));return function(e,n,r,a,i,s){return t.apply(this,arguments)}}(),t}()),l=t("AdminInteraction",function(){function t(t,e,n){this.client=t,this.packageId=e,this.gameDataId=n}var a=t.prototype;return a.publishMapTemplate=function(){var t=e(n().mark((function t(e,r,a){var i,s,c,u,p;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=new o,s=r.tiles.map((function(t){return i.pure.vector("u8",[t.x,t.y,t.kind])})),c=r.properties.map((function(t){return i.pure.vector("u64",[t.kind,t.size,Number(t.price),Number(t.base_toll)])})),i.moveCall({target:this.packageId+"::admin::register_template",arguments:[i.object(e),i.object(this.gameDataId),i.pure.string(r.name),i.pure.string(r.description),i.pure.vector("vector<u8>",s),i.pure.vector("vector<u64>",c),i.pure.u16(r.starting_tile),i.pure.u8(r.min_players),i.pure.u8(r.max_players)]}),t.next=6,this.client.signAndExecuteTransaction({transaction:i,signer:a,options:{showEvents:!0}});case 6:return u=t.sent,p=this.extractTemplateId(u),t.abrupt("return",{templateId:p,txHash:u.digest});case 9:case"end":return t.stop()}}),t,this)})));return function(e,n,r){return t.apply(this,arguments)}}(),a.extractTemplateId=function(t){for(var e,n=t.events||[],a=r(n);!(e=a()).done;){var i,s=e.value;if(s.type.includes("MapTemplatePublishedEvent"))return(null==(i=s.parsedJson)?void 0:i.template_id)||"0"}return"0"},t}());t("TycoonGameClient",function(){function t(t,e,n,r,a){void 0===r&&(r="0x8"),void 0===a&&(a="0x6"),this.game=void 0,this.property=void 0,this.card=void 0,this.admin=void 0,this.game=new i(t,e,n,r,a),this.property=new p(t,e,n),this.card=new d(t,e,n,r),this.admin=new l(t,e,n)}return t.create=function(){var r=e(n().mark((function e(r){var a,i,s,o;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a="string"==typeof r.network&&r.network.startsWith("http")?r.network:"https://fullnode."+r.network+".sui.io",e.next=3,c();case 3:return i=e.sent,s=i.SuiClient,o=new s({url:a}),e.abrupt("return",new t(o,r.packageId,r.gameDataId,r.randomObjectId,r.clockObjectId));case 7:case"end":return e.stop()}}),e)})));return function(t){return r.apply(this,arguments)}}(),t}());a._RF.pop()}}}));

System.register("chunks:///_virtual/indexer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./types2.ts","./loader.ts","./RpcConfigManager.ts"],(function(e){var t,n,r,s,i,a,o,l;return{setters:[function(e){t=e.extends,n=e.asyncToGenerator,r=e.regeneratorRuntime,s=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy},function(e){a=e.EventType},function(e){o=e.loadSuiClient},function(e){l=e.RpcConfigManager}],execute:function(){e("createEventIndexer",(function(e){return u.apply(this,arguments)})),i._RF.push({},"24476Yiws9JzbEZf1XSatX2","indexer",void 0);var c=e("TycoonEventIndexer",function(){function e(e){this.client=void 0,this.packageId=void 0,this.pollInterval=void 0,this.batchSize=void 0,this.isRunning=!1,this.pollTimer=void 0,this.typeMap={GameCreatedEvent:a.GAME_CREATED,PlayerJoinedEvent:a.PLAYER_JOINED,GameStartedEvent:a.GAME_STARTED,GameEndedEvent:a.GAME_ENDED,MapTemplatePublishedEvent:a.MAP_TEMPLATE_PUBLISHED,TurnStartEvent:a.TURN_START,SkipTurnEvent:a.SKIP_TURN,EndTurnEvent:a.END_TURN,RoundEndedEvent:a.ROUND_ENDED,BankruptEvent:a.BANKRUPT,BuildingDecisionEvent:a.BUILDING_DECISION,RentDecisionEvent:a.RENT_DECISION,DecisionSkippedEvent:a.DECISION_SKIPPED,UseCardActionEvent:a.USE_CARD_ACTION,RollAndStepActionEvent:a.ROLL_AND_STEP_ACTION},this.perTypeCursor=new Map,this.bootstrapped=!1,this.eventHandlers=new Map,this.globalHandlers=[],this.currentGameId=null,this.gameFlowEventTypes=["RollAndStepActionEvent","BuildingDecisionEvent","RentDecisionEvent","DecisionSkippedEvent","SkipTurnEvent","BankruptEvent","GameEndedEvent"],this.filterTestStats={enabled:!1,totalQueries:0,originalCount:0,filteredCount:0,matchedCount:0,mismatchedCount:0},this.client=e.client,this.packageId=e.packageId,this.pollInterval=e.pollInterval||3e3,this.batchSize=e.batchSize||100,e.autoStart&&this.start()}var i=e.prototype;return i.start=function(){var e=this;this.isRunning||(this.isRunning=!0,this.bootstrap().finally((function(){e.pollEvents()})))},i.stop=function(){this.isRunning&&(this.isRunning=!1,this.pollTimer&&(clearTimeout(this.pollTimer),this.pollTimer=void 0))},i.on=function(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)},i.onAny=function(e){this.globalHandlers.push(e)},i.off=function(e,t){var n=this.eventHandlers.get(e);if(n){var r=n.indexOf(t);r>=0&&n.splice(r,1)}},i.setCurrentGameId=function(e){this.currentGameId=e,console.log("[EventIndexer] Test: Current game ID set:",e)},i.enableFilterTest=function(e){this.filterTestStats.enabled=e,console.log("[EventIndexer] Test: Filter test",e?"enabled":"disabled"),e&&(this.filterTestStats={enabled:!0,totalQueries:0,originalCount:0,filteredCount:0,matchedCount:0,mismatchedCount:0})},i.getFilterTestStats=function(){return t({},this.filterTestStats)},i.pollEvents=function(){var e=n(r().mark((function e(){var t,n,i,a,o,c,u,d,p,h,v,g,f,m,E,T,y,b,x=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isRunning){e.next=2;break}return e.abrupt("return");case 2:e.prev=2,t=this.getAllTypeNames(),n=s(t);case 5:if((i=n()).done){e.next=30;break}return u=i.value,d=null!=(a=this.perTypeCursor.get(u))?a:void 0,p=this.packageId+"::events::"+u,e.next=11,this.client.queryEvents({query:{MoveEventType:p},order:"ascending",limit:this.batchSize,cursor:d});case 11:if(h=e.sent,!((null!=(o=null==(c=h.data)?void 0:c.length)?o:0)>0)){e.next=28;break}if(!(this.filterTestStats.enabled&&this.currentGameId&&this.gameFlowEventTypes.includes(u))){e.next=17;break}return e.next=17,this.testChainFilter(u,p,h.data,d);case 17:f=s(h.data);case 18:if((m=f()).done){e.next=26;break}if(E=m.value,!(T=this.parseEvent(E))){e.next=24;break}return e.next=24,this.handleEvent(T);case 24:e.next=18;break;case 26:y=h.data[h.data.length-1],this.perTypeCursor.set(u,null!=(v=null!=(g=null==y?void 0:y.id)?g:d)?v:null);case 28:e.next=5;break;case 30:e.next=35;break;case 32:e.prev=32,e.t0=e.catch(2),console.error("Failed to poll events:",e.t0);case 35:this.isRunning&&(b=l.getEventIndexerInterval(),this.pollTimer=setTimeout((function(){return x.pollEvents()}),b));case 36:case"end":return e.stop()}}),e,this,[[2,32]])})));return function(){return e.apply(this,arguments)}}(),i.bootstrap=function(){var e=n(r().mark((function e(){var t,n,i,a,o,l,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=this.getAllTypeNames(),n=s(t);case 3:if((i=n()).done){e.next=12;break}return a=i.value,o=this.packageId+"::events::"+a,e.next=8,this.client.queryEvents({query:{MoveEventType:o},order:"descending",limit:1});case 8:(l=e.sent).data&&l.data.length>0?(c=l.data[0],this.perTypeCursor.set(a,c.id)):this.perTypeCursor.set(a,null);case 10:e.next=3;break;case 12:this.bootstrapped=!0,e.next=17;break;case 15:e.prev=15,e.t0=e.catch(0);case 17:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),i.parseEvent=function(e){try{var t,n,r=e.type.split("::").pop(),s=this.getEventType(r);return s?{type:s,data:this.normalizeEventData(e.parsedJson),timestamp:Number(e.timestampMs||Date.now()),sequence:Number(null!=(t=null==(n=e.id)?void 0:n.eventSeq)?t:0),txHash:e.id.txDigest||"",blockHeight:0}:null}catch(e){return console.error("Failed to parse event:",e),null}},i.normalizeEventData=function(e){try{var n=t({},e);return n&&n.game&&"object"==typeof n.game&&("string"==typeof n.game.id?n.game=n.game.id:"string"==typeof n.game.bytes&&(n.game=n.game.bytes)),n&&n.player&&"object"==typeof n.player&&("string"==typeof n.player.id?n.player=n.player.id:"string"==typeof n.player.bytes&&(n.player=n.player.bytes)),n.steps&&Array.isArray(n.steps)&&(n.steps=n.steps.map((function(e){var n=t({},e);return n.stop_effect&&"object"==typeof n.stop_effect&&n.stop_effect.fields&&(n.stop_effect=t({},n.stop_effect.fields)),n.npc_event&&"object"==typeof n.npc_event&&n.npc_event.fields&&(n.npc_event=t({},n.npc_event.fields)),n}))),n}catch(t){return e}},i.getEventType=function(e){return this.typeMap[e]||null},i.getAllTypeNames=function(){return Object.keys(this.typeMap)},i.handleEvent=function(){var e=n(r().mark((function e(t){var n,i,a,o,l,c,u;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(n=this.eventHandlers.get(t.type)||[]).length){e.next=4;break}return console.warn("[EventIndexer] No handler registered for event type: "+t.type),e.abrupt("return");case 4:i=s(n);case 5:if((a=i()).done){e.next=17;break}return o=a.value,e.prev=7,e.next=10,o(t);case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(7),console.error("Error handling event "+t.type+":",e.t0);case 15:e.next=5;break;case 17:l=s(this.globalHandlers);case 18:if((c=l()).done){e.next=30;break}return u=c.value,e.prev=20,e.next=23,u(t);case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(20),console.error("Error in global event handler:",e.t1);case 28:e.next=18;break;case 30:case"end":return e.stop()}}),e,this,[[7,12],[20,25]])})));return function(t){return e.apply(this,arguments)}}(),i.testChainFilter=function(){var e=n(r().mark((function e(t,n,s,i){var a,o,l,c,u,d,p,h,v=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.filterTestStats.totalQueries++,this.filterTestStats.originalCount+=s.length,console.log("\n========== [FilterTest] "+t+" =========="),console.log("[FilterTest] Original query returned: "+s.length+" events"),console.log("[FilterTest] Current game ID: "+this.currentGameId),a=[],o="",e.prev=8,e.next=11,this.client.queryEvents({query:{MoveEventField:{path:"/game",value:this.currentGameId}},order:"ascending",limit:this.batchSize,cursor:i});case 11:l=e.sent,a=l.data||[],o="MoveEventField",console.log("[FilterTest] ✅ MoveEventField query succeeded: "+a.length+" events"),e.next=23;break;case 17:e.prev=17,e.t0=e.catch(8),console.log("[FilterTest] ❌ MoveEventField query failed:",e.t0.message),a=s.filter((function(e){var t;return(null==(t=e.parsedJson)?void 0:t.game)===v.currentGameId})),o="Client-side filter",console.log("[FilterTest] Using client-side filter: "+a.length+" events");case 23:this.filterTestStats.filteredCount+=a.length,console.log("[FilterTest] Method: "+o),s.length>0&&(c=(100*(1-a.length/s.length)).toFixed(1),console.log("[FilterTest] Reduction: "+s.length+" -> "+a.length+" ("+c+"% filtered out)")),u=new Set(s.map((function(e){var t;return null==(t=e.parsedJson)?void 0:t.game})).filter((function(e){return e}))),d=new Set(a.map((function(e){var t;return null==(t=e.parsedJson)?void 0:t.game})).filter((function(e){return e}))),console.log("[FilterTest] Original events cover "+u.size+" game(s):",Array.from(u)),console.log("[FilterTest] Filtered events cover "+d.size+" game(s):",Array.from(d)),p=s.filter((function(e){var t;return(null==(t=e.parsedJson)?void 0:t.game)===v.currentGameId})),h=s.filter((function(e){var t;return(null==(t=e.parsedJson)?void 0:t.game)!==v.currentGameId})),console.log("[FilterTest] Should include: "+p.length+" events (game="+this.currentGameId+")"),console.log("[FilterTest] Should exclude: "+h.length+" events (other games)"),this.filterTestStats.matchedCount+=p.length,this.filterTestStats.mismatchedCount+=h.length,a.length===p.length?console.log("[FilterTest] ✅ Result verified: Filter is working correctly"):console.warn("[FilterTest] ⚠️ Result mismatch: Expected "+p.length+", got "+a.length),console.log("========== [FilterTest] End ==========\n"),e.next=43;break;case 40:e.prev=40,e.t1=e.catch(0),console.error("[FilterTest] Test failed for "+t+":",e.t1);case 43:case"end":return e.stop()}}),e,this,[[0,40],[8,17]])})));return function(t,n,r,s){return e.apply(this,arguments)}}(),i.printFilterTestSummary=function(){if(this.filterTestStats.enabled){var e=this.filterTestStats,t=e.originalCount>0?(100*(1-e.filteredCount/e.originalCount)).toFixed(1):"0";console.log("\n========== [FilterTest] Summary =========="),console.log("Total queries: "+e.totalQueries),console.log("Original events: "+e.originalCount),console.log("Filtered events: "+e.filteredCount),console.log("Reduction rate: "+t+"%"),console.log("Events matched (current game): "+e.matchedCount),console.log("Events filtered out (other games): "+e.mismatchedCount),console.log("==========================================\n")}else console.log("[FilterTest] Test is not enabled")},e}());function u(){return(u=n(r().mark((function e(t){var n,s,i,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="string"==typeof t.network&&t.network.startsWith("http")?t.network:"https://fullnode."+t.network+".sui.io",e.next=3,o();case 3:return s=e.sent,i=s.SuiClient,a=new i({url:n}),e.abrupt("return",new c({client:a,packageId:t.packageId,autoStart:t.autoStart}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}i._RF.pop()}}}));

System.register("chunks:///_virtual/InteractionManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./CameraManager.ts","./CameraConfig.ts","./EventBus.ts","./EventTypes.ts"],(function(e){var n,t,a,o,r,i,s,u,c,h,M,l,p,d,m,f,g;return{setters:[function(e){n=e.applyDecoratedDescriptor,t=e.inheritsLoose,a=e.initializerDefineProperty,o=e.assertThisInitialized,r=e.extends},function(e){i=e.cclegacy,s=e._decorator,u=e.Vec3,c=e.input,h=e.Input,M=e.KeyCode,l=e.Component},function(e){p=e.CameraManager,d=e.CameraControllerType},function(e){m=e.CameraMode},function(e){f=e.EventBus},function(e){g=e.EventTypes}],execute:function(){var C,_,D,I,b,v,w,y,E,T,S,L,N;i._RF.push({},"afb69CYp5xOGrTXrwRcEtB2","InteractionManager",void 0);var G=s.ccclass,k=s.property;e("InteractionManager",(C=G("InteractionManager"),_=k({displayName:"启用主游戏相机",tooltip:"在start时自动启用主游戏相机控制器"}),D=k({displayName:"默认相机模式",tooltip:"启动时的默认相机模式"}),I=k({displayName:"启用键盘快捷键",tooltip:"是否启用F1-F3切换相机模式"}),b=k({displayName:"启用鼠标交互",tooltip:"是否启用鼠标点击和拖拽交互"}),v=k({displayName:"调试模式",tooltip:"显示调试信息"}),C((E=n((y=function(e){function n(){for(var n,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];return n=e.call.apply(e,[this].concat(r))||this,a(n,"enableMainGameCamera",E,o(n)),a(n,"defaultCameraMode",T,o(n)),a(n,"enableKeyboardShortcuts",S,o(n)),a(n,"enableMouseInteraction",L,o(n)),a(n,"debugMode",N,o(n)),n._cameraManager=null,n._events={},n._isMouseDown=!1,n._lastMousePos=new u,n}t(n,e);var i=n.prototype;return i.onLoad=function(){this._cameraManager=p.getInstance(),this._cameraManager||console.error("[InteractionManager] 无法获取CameraManager实例！请确保场景中有CameraManager组件")},i.start=function(){this.enableMainGameCamera&&this._cameraManager&&(this._cameraManager.switchToController(d.MAIN_GAME)?(this._cameraManager.setMainGameCameraMode(this.defaultCameraMode),this.debugLog("已启用主游戏相机，模式: "+this.defaultCameraMode)):console.warn("[InteractionManager] 无法切换到主游戏相机控制器"));this._setupEventListeners()},i.onEnable=function(){this._cameraManager&&(this._cameraManager.switchToController(d.MAIN_GAME)?(this._cameraManager.setMainGameCameraMode(this.defaultCameraMode),this.debugLog("onEnable: 已切换到主游戏相机，模式: "+this.defaultCameraMode)):console.warn("[InteractionManager] onEnable: 无法切换到主游戏相机控制器"));this.enableKeyboardShortcuts&&c.on(h.EventType.KEY_DOWN,this.onKeyDown,this),this.enableMouseInteraction&&(f.on(g.Input3D.MouseDown,this.onInput3DMouseDown,this),f.on(g.Input3D.MouseUp,this.onInput3DMouseUp,this),f.on(g.Input3D.MouseMove,this.onInput3DMouseMove,this),f.on(g.Input3D.TouchStart,this.onInput3DTouchStart,this),f.on(g.Input3D.TouchEnd,this.onInput3DTouchEnd,this))},i.onDisable=function(){c.off(h.EventType.KEY_DOWN,this.onKeyDown,this),f.off(g.Input3D.MouseDown,this.onInput3DMouseDown,this),f.off(g.Input3D.MouseUp,this.onInput3DMouseUp,this),f.off(g.Input3D.MouseMove,this.onInput3DMouseMove,this),f.off(g.Input3D.TouchStart,this.onInput3DTouchStart,this),f.off(g.Input3D.TouchEnd,this.onInput3DTouchEnd,this),this._isMouseDown=!1},i.onDestroy=function(){this._removeEventListeners()},i.setEventCallbacks=function(e){this._events=r({},this._events,e)},i.switchCameraMode=function(e){this._cameraManager&&(this._cameraManager.setMainGameCameraMode(e),this.debugLog("切换相机模式: "+e),this._events.onCameraModeChange&&this._events.onCameraModeChange(e))},i.getCurrentCameraMode=function(){if(!this._cameraManager)return null;var e=this._cameraManager.getActiveController();return e&&"getCameraState"in e?e.getCameraState().currentMode:null},i.enableMainCamera=function(){if(!this._cameraManager)return!1;var e=this._cameraManager.switchToController(d.MAIN_GAME);return e&&(this._cameraManager.setMainGameCameraMode(this.defaultCameraMode),this.debugLog("手动启用主游戏相机成功")),e},i.onKeyDown=function(e){if(this._cameraManager)switch(e.keyCode){case M.F1:this.switchCameraMode(m.ISOMETRIC);break;case M.F2:this.switchCameraMode(m.TOP_DOWN);break;case M.F3:this.switchCameraMode(m.THIRD_PERSON_FOLLOW)}},i.onInput3DMouseDown=function(e){this._isMouseDown=!0,this._lastMousePos.set(e.screenX,e.screenY,0),this._handleInput3DClick(e)},i.onInput3DMouseUp=function(e){this._isMouseDown=!1},i.onInput3DMouseMove=function(e){this._isMouseDown&&this._handleInput3DDrag(e)},i.onInput3DTouchStart=function(e){this._isMouseDown=!0,this._lastMousePos.set(e.screenX,e.screenY,0),this._handleInput3DClick(e)},i.onInput3DTouchEnd=function(e){this._isMouseDown=!1},i._handleInput3DClick=function(e){var n,t,a=null!=(n=e.uiX)?n:e.screenX,o=null!=(t=e.uiY)?t:e.screenY,r=new u(a,o,0);this._events.onBoardClick&&this._events.onBoardClick(r)},i._handleInput3DDrag=function(e){var n=new u(e.screenX,e.screenY,0);n.subtract(this._lastMousePos);this._lastMousePos=n},i._setupEventListeners=function(){f.on(g.System.CameraModeChanged,this._onCameraModeChanged,this)},i._removeEventListeners=function(){f.off(g.System.CameraModeChanged,this._onCameraModeChanged,this)},i._onCameraModeChanged=function(e){e.controllerType===d.MAIN_GAME&&this.debugLog("相机控制器切换到主游戏模式")},i.debugLog=function(e){this.debugMode&&console.log("[InteractionManager] "+e)},n}(l)).prototype,"enableMainGameCamera",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T=n(y.prototype,"defaultCameraMode",[D],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return m.ISOMETRIC}}),S=n(y.prototype,"enableKeyboardShortcuts",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),L=n(y.prototype,"enableMouseInteraction",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N=n(y.prototype,"debugMode",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w=y))||w));i._RF.pop()}}}));

System.register("chunks:///_virtual/InteractionManagerSwitcher.ts",["./rollupPluginModLoBabelHelpers.js","cc","./InteractionManager.ts","./VoxelInteractionManager.ts","./CameraManager.ts"],(function(e){var n,a,t,r,i,o,c,s,g,l,u,h,M;return{setters:[function(e){n=e.applyDecoratedDescriptor,a=e.inheritsLoose,t=e.initializerDefineProperty,r=e.assertThisInitialized},function(e){i=e.cclegacy,o=e._decorator,c=e.input,s=e.Input,g=e.KeyCode,l=e.Component},function(e){u=e.InteractionManager},function(e){h=e.VoxelInteractionManager},function(e){M=e.CameraManager}],execute:function(){var b,p,d,f,I,m,w,y,_,v,x,T,K;i._RF.push({},"3a1c9uYiQZHALKQXCqMmk/6","InteractionManagerSwitcher",void 0);var L=o.ccclass,S=o.property;e("InteractionManagerSwitcher",(b=L("InteractionManagerSwitcher"),p=S({type:u,displayName:"主游戏交互管理器"}),d=S({type:h,displayName:"体素交互管理器"}),f=S({displayName:"启用键盘切换",tooltip:"是否允许通过键盘快捷键切换管理器"}),I=S({displayName:"默认管理器",tooltip:"启动时的默认管理器"}),m=S({displayName:"调试模式",tooltip:"显示调试信息"}),b((_=n((y=function(e){function n(){for(var n,a=arguments.length,i=new Array(a),o=0;o<a;o++)i[o]=arguments[o];return n=e.call.apply(e,[this].concat(i))||this,t(n,"mainInteractionManager",_,r(n)),t(n,"voxelInteractionManager",v,r(n)),t(n,"enableKeyboardSwitching",x,r(n)),t(n,"defaultManager",T,r(n)),t(n,"debugMode",K,r(n)),n._currentManager=null,n._cameraManager=null,n}a(n,e);var i=n.prototype;return i.onLoad=function(){this._cameraManager=M.getInstance(),this._cameraManager?(this.mainInteractionManager||(this.mainInteractionManager=this.getComponent(u)),this.voxelInteractionManager||(this.voxelInteractionManager=this.getComponent(h)),this.debugLog("交互管理器切换器已初始化")):console.error("[InteractionManagerSwitcher] 无法获取CameraManager实例")},i.start=function(){this.switchToManager(this.defaultManager),this.debugLog("切换器启动完成，当前管理器: "+this._currentManager),this.printInstructions()},i.onEnable=function(){this.enableKeyboardSwitching&&c.on(s.EventType.KEY_DOWN,this.onKeyDown,this)},i.onDisable=function(){c.off(s.EventType.KEY_DOWN,this.onKeyDown,this)},i.switchToManager=function(e){if(this._currentManager===e)return this.debugLog("已经是 "+e+" 管理器，无需切换"),!0;this._disableCurrentManager();var n=this._enableManager(e);return n?(this._currentManager=e,this.debugLog("✅ 成功切换到 "+e+" 管理器")):this.debugLog("❌ 切换到 "+e+" 管理器失败"),n},i.switchToMainManager=function(){return this.switchToManager("main")},i.switchToVoxelManager=function(){return this.switchToManager("voxel")},i.getCurrentManager=function(){return this._currentManager},i.printStatus=function(){if(console.log("=== 交互管理器状态 ==="),console.log("当前管理器: "+this._currentManager),this.mainInteractionManager&&console.log("主游戏管理器: "+(this.mainInteractionManager.enabled?"启用":"禁用")),this.voxelInteractionManager&&console.log("体素管理器: "+(this.voxelInteractionManager.enabled?"启用":"禁用")),this._cameraManager){var e=this._cameraManager.getActiveControllerType();console.log("当前相机控制器: "+e)}console.log("======================")},i._disableCurrentManager=function(){this._currentManager&&("main"===this._currentManager&&this.mainInteractionManager?(this.mainInteractionManager.enabled=!1,this.debugLog("已禁用主游戏管理器")):"voxel"===this._currentManager&&this.voxelInteractionManager&&(this.voxelInteractionManager.enabled=!1,this.debugLog("已禁用体素管理器")))},i._enableManager=function(e){return"main"===e?this.mainInteractionManager?(this.mainInteractionManager.enabled=!0,this.debugLog("已启用主游戏管理器"),!0):(console.error("[InteractionManagerSwitcher] 主游戏管理器不存在"),!1):"voxel"===e&&(this.voxelInteractionManager?(this.voxelInteractionManager.enabled=!0,this.debugLog("已启用体素管理器"),!0):(console.error("[InteractionManagerSwitcher] 体素管理器不存在"),!1))},i.onKeyDown=function(e){switch(e.keyCode){case g.KEY_Q:this.switchToMainManager();break;case g.KEY_E:this.switchToVoxelManager();break;case g.KEY_TAB:"main"===this._currentManager?this.switchToVoxelManager():this.switchToMainManager();break;case g.KEY_I:this.printStatus()}},i.printInstructions=function(){console.log("=== 交互管理器切换器使用说明 ==="),console.log("Q: 切换到主游戏管理器"),console.log("E: 切换到体素管理器"),console.log("Tab: 在两种管理器间切换"),console.log("I: 打印当前状态"),console.log("================================")},i.debugLog=function(e){this.debugMode&&console.log("[InteractionManagerSwitcher] "+e)},n}(l)).prototype,"mainInteractionManager",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v=n(y.prototype,"voxelInteractionManager",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x=n(y.prototype,"enableKeyboardSwitching",[f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T=n(y.prototype,"defaultManager",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"main"}}),K=n(y.prototype,"debugMode",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),w=y))||w));i._RF.pop()}}}));

System.register("chunks:///_virtual/KeypairSigner.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var n,r,t;return{setters:[function(e){n=e.asyncToGenerator,r=e.regeneratorRuntime},function(e){t=e.cclegacy}],execute:function(){t._RF.push({},"483a5/HSbtCc5MguIM3xyIi","KeypairSigner",void 0);e("KeypairSigner",function(){function e(e){this.keypair=e}var t=e.prototype;return t.getAddress=function(){return this.keypair.toSuiAddress()},t.signAndExecuteTransaction=function(){var e=n(r().mark((function e(n,t){var i;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[KeypairSigner] Signing transaction with keypair:",this.getAddress()),e.prev=1,e.next=4,t.signAndExecuteTransaction({transaction:n,signer:this.keypair,options:{showEffects:!0,showEvents:!0,showObjectChanges:!0}});case 4:return i=e.sent,console.log("[KeypairSigner] Transaction executed:",i.digest),e.abrupt("return",i);case 9:throw e.prev=9,e.t0=e.catch(1),console.error("[KeypairSigner] Transaction failed:",e.t0),e.t0;case 13:case"end":return e.stop()}}),e,this,[[1,9]])})));return function(n,r){return e.apply(this,arguments)}}(),t.getType=function(){return"keypair"},e}());t._RF.pop()}}}));

System.register("chunks:///_virtual/KeystoreConfig.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var o,t;return{setters:[function(e){o=e.createClass},function(e){t=e.cclegacy}],execute:function(){t._RF.push({},"ddaeb8pHPNIOLYFBwGgfBei","KeystoreConfig",void 0);var s="web3_tycoon_keystore_config_key",r="dev0",n="password0";e("KeystoreConfig",function(){function e(){this._storageKey=r,this._password=n,this.loadStorageKey()}var t=e.prototype;return t.getStorageKey=function(){return this._storageKey},t.setStorageKey=function(e){this._storageKey=e||r,this.saveStorageKey(),console.log("[KeystoreConfig] Storage key updated:",this._storageKey)},t.getFullStorageKey=function(){return"web3_tycoon_sui_"+this._storageKey},t.loadStorageKey=function(){var e=localStorage.getItem(s);e?(this._storageKey=e,console.log("[KeystoreConfig] Loaded storage key from localStorage:",this._storageKey)):console.log("[KeystoreConfig] Using default storage key:",this._storageKey)},t.saveStorageKey=function(){localStorage.setItem(s,this._storageKey)},t.getPassword=function(){return this._password},t.setPassword=function(e){this._password=e||n,console.log("[KeystoreConfig] Password updated (memory only)")},t.clearPassword=function(){this._password=n,console.log("[KeystoreConfig] Password cleared (reset to default)")},t.applyConfig=function(e,o){this.setStorageKey(e),this.setPassword(o),console.log("[KeystoreConfig] Config applied"),console.log("  Storage key:",this._storageKey),console.log("  Full key:",this.getFullStorageKey())},t.reset=function(){this._storageKey=r,this._password=n,localStorage.removeItem(s),console.log("[KeystoreConfig] Reset to defaults")},t.getSummary=function(){return{storageKey:this._storageKey,fullStorageKey:this.getFullStorageKey(),hasPassword:""!==this._password}},o(e,null,[{key:"instance",get:function(){return e._instance||(e._instance=new e),e._instance}}]),e}())._instance=null,t._RF.pop()}}}));

System.register("chunks:///_virtual/KeystoreLoader.ts",["./rollupPluginModLoBabelHelpers.js","cc","./loader.ts","./CryptoUtils.ts","./FaucetUtils.ts","./UINotification.ts","./KeystoreConfig.ts","./SuiEnvConfigManager.ts","./SuiConfig.ts"],(function(e,o){var t,r,n,s,a,l,c,i,g,u,d;return{setters:[function(e){t=e.asyncToGenerator,r=e.regeneratorRuntime},function(e){n=e.cclegacy},function(e){s=e.loadEd25519},function(e){a=e.encryptWithPassword,l=e.decryptWithPassword},function(e){c=e.requestSuiFromFaucet},function(e){i=e.UINotification},function(e){g=e.KeystoreConfig},function(e){u=e.SuiEnvConfigManager},function(e){d=e.getNetworkRpcUrl}],execute:function(){function p(){return(p=t(r().mark((function e(){var o,t,n,p,S,K,m,L,k,v,w,x,E,C,U,b,F,A;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=g.instance,t=o.getFullStorageKey(),n=o.getPassword(),p=u.instance.load(),S=p.network,K=d(S),console.log("=".repeat(60)),console.log("[KeystoreLoader] === START ==="),console.log("  Timestamp:",(new Date).toISOString()),console.log("  Storage key:",t),console.log("  Network:",S),console.log("  RPC URL:",K),console.log("  Config:",o.getSummary()),console.log("=".repeat(60)),e.prev=14,console.log("[KeystoreLoader] Step 1: Checking localStorage"),m=localStorage.getItem(t),console.log("  Encrypted data exists:",!!m),m&&console.log("  Encrypted data length:",m.length),!m){e.next=39;break}return i.info("加载已有密钥"),console.log("[KeystoreLoader] Step 2: Decrypting"),e.next=24,l(m,n);case 24:return L=e.sent,console.log("  Decryption successful"),console.log("  Decrypted data length:",L.length),console.log("[KeystoreLoader] Step 3: Parsing keypair"),e.next=30,y(L);case 30:if(k=e.sent,v=k.toSuiAddress(),console.log("  Address:",v),"localnet"!==S&&"devnet"!==S&&"testnet"!==S){e.next=36;break}return e.next=36,h(v,S,K);case 36:return console.log("[KeystoreLoader] === SUCCESS (LOADED) ==="),console.log("=".repeat(60)),e.abrupt("return",k);case 39:return console.log("[KeystoreLoader] No saved keypair found"),i.info("生成新开发密钥"),console.log("[KeystoreLoader] Step 4: Generating new keypair"),e.next=44,s();case 44:return w=e.sent,x=w.Ed25519Keypair,E=x.generate(),C=E.toSuiAddress(),console.log("  Generated address:",C),"localnet"!==S&&"devnet"!==S&&"testnet"!==S||(console.log("[KeystoreLoader] Step 5: Requesting faucet (async)"),i.info("正在从水龙头获取测试币..."),c(C,S).then((function(e){console.log("[KeystoreLoader] Faucet callback, success:",e),e?i.success("测试币获取成功"):i.warning("测试币获取失败")})).catch((function(e){console.error("[KeystoreLoader] Faucet callback error:",e)}))),console.log("[KeystoreLoader] Step 6: Exporting keypair to base64"),U=f(E),console.log("  Exported length:",U.length),console.log("[KeystoreLoader] Step 7: Encrypting"),e.next=56,a(U,n);case 56:return b=e.sent,console.log("  Encrypted length:",b.length),console.log("[KeystoreLoader] Step 8: Saving to localStorage"),localStorage.setItem(t,b),console.log("  Saved"),console.log("[KeystoreLoader] Step 9: Verifying save"),F=localStorage.getItem(t),A=F===b,console.log("  Verification result:",A?"SUCCESS":"FAILED"),console.log("  Saved data exists:",!!F),F&&(console.log("  Saved data length:",F.length),console.log("  Matches encrypted:",F===b)),A||(console.error("[KeystoreLoader] ✗ Save verification FAILED!"),i.error("密钥保存失败")),console.log("[KeystoreLoader] === SUCCESS (GENERATED) ==="),console.log("=".repeat(60)),e.abrupt("return",E);case 73:throw e.prev=73,e.t0=e.catch(14),console.error("=".repeat(60)),console.error("[KeystoreLoader] === ERROR ==="),console.error("  Error:",e.t0),console.error("  Error message:",e.t0.message),console.error("  Error stack:",e.t0.stack),console.error("=".repeat(60)),i.error("密钥加载失败: "+e.t0),e.t0;case 83:case"end":return e.stop()}}),e,null,[[14,73]])})))).apply(this,arguments)}function y(e){return S.apply(this,arguments)}function S(){return(S=t(r().mark((function e(o){var t,n,a,l,c,i,g,u,d,p;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[KeystoreLoader] parseKeypairFromBase64: START"),console.log("  Data length:",o.length),console.log("  Data sample:",o.substring(0,20)+"..."),e.next=5,s();case 5:return t=e.sent,n=t.Ed25519Keypair,e.prev=7,console.log("[KeystoreLoader] Attempting method 1: Direct fromSecretKey"),a=n.fromSecretKey(o),l=a.toSuiAddress(),console.log("  Method 1 SUCCESS, address:",l),e.abrupt("return",a);case 15:for(e.prev=15,e.t0=e.catch(7),console.warn("[KeystoreLoader] Method 1 failed:",e.t0),e.prev=18,console.log("[KeystoreLoader] Attempting method 2: Base64 decode"),c=atob(o),i=new Uint8Array(c.length),g=0;g<c.length;g++)i[g]=c.charCodeAt(g);return u=i.subarray(1),console.log("  Decoded bytes length:",u.length),d=n.fromSecretKey(u),p=d.toSuiAddress(),console.log("  Method 2 SUCCESS, address:",p),e.abrupt("return",d);case 31:throw e.prev=31,e.t1=e.catch(18),console.error("[KeystoreLoader] Method 2 also failed:",e.t1),new Error("Failed to parse keypair from stored data");case 35:case"end":return e.stop()}}),e,null,[[7,15],[18,31]])})))).apply(this,arguments)}function f(e){console.log("[KeystoreLoader] exportKeypairToBase64: START");var o=e.getSecretKey(),t="string"==typeof o,r=o instanceof Uint8Array;if(console.log("  Secret key type:",t?"string":r?"Uint8Array":"unknown"),console.log("  Secret key length:",o.length),t)return console.log("  Format: Bech32 string"),console.log("  Sample:",o.substring(0,20)+"..."),o;if(r){console.log("  Format: Uint8Array, converting to Base64");var n=btoa(String.fromCharCode.apply(String,o));return console.log("  Base64 length:",n.length),n}throw console.error("[KeystoreLoader] Unknown secret key format"),new Error("Unknown secret key format from getSecretKey()")}function h(e,o,t){return K.apply(this,arguments)}function K(){return(K=t(r().mark((function e(t,n,s){var a,l,g,u,d,p,y,S;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[KeystoreLoader] Step 4: Checking balance"),console.log("  Network:",n),console.log("  RPC URL:",s),e.prev=3,e.next=6,o.import("./loader.ts");case 6:return a=e.sent,l=a.loadSuiClient,e.next=10,l();case 10:return g=e.sent,u=g.SuiClient,d=new u({url:s}),e.next=15,d.getBalance({owner:t,coinType:"0x2::sui::SUI"});case 15:if(p=e.sent,y=BigInt(p.totalBalance),S=Number(y)/1e9,console.log("  Balance:",S.toFixed(4),"SUI"),!(y<10000000000n)){e.next=28;break}return console.log("[KeystoreLoader] Balance too low (< 10 SUI), requesting faucet"),i.warning("余额不足（"+S.toFixed(4)+" SUI），正在请求测试币..."),e.next=24,c(t,n);case 24:e.sent?i.success("测试币获取成功"):i.warning("测试币获取失败，请手动获取"),e.next=29;break;case 28:console.log("[KeystoreLoader] Balance sufficient (>= 10 SUI)");case 29:e.next=34;break;case 31:e.prev=31,e.t0=e.catch(3),console.error("[KeystoreLoader] Failed to check balance:",e.t0);case 34:case"end":return e.stop()}}),e,null,[[3,31]])})))).apply(this,arguments)}e({clearStoredKeypair:function(){var e=g.instance.getFullStorageKey();localStorage.removeItem(e),console.log("[KeystoreLoader] Stored keypair cleared:",e)},loadKeypairFromKeystore:function(){return p.apply(this,arguments)}}),n._RF.push({},"ee30aF9iQxH07M1YmRMIflK","KeystoreLoader",void 0),n._RF.pop()}}}));

System.register("chunks:///_virtual/loader.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(r){var n,t,e;return{setters:[function(r){n=r.asyncToGenerator,t=r.regeneratorRuntime},function(r){e=r.cclegacy}],execute:function(){r({loadEd25519:function(){return p.apply(this,arguments)},loadSuiBcs:function(){return i.apply(this,arguments)},loadSuiClient:function(){return c.apply(this,arguments)},loadSuiFaucet:function(){return d.apply(this,arguments)},loadSuiTransactions:function(){return o.apply(this,arguments)},loadSuiUtils:function(){return f.apply(this,arguments)},loadWalletStandard:function(){return l.apply(this,arguments)},preloadAll:function(){return h.apply(this,arguments)}}),e._RF.push({},"fbe88MkVCZGnLTt7aU4o8T0","loader",void 0);var u=null;function a(){return s.apply(this,arguments)}function s(){return(s=n(t().mark((function r(){var n;return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!u){r.next=2;break}return r.abrupt("return",u);case 2:return n="./libs/sui.system.js",console.log("[SuiLoader] Loading sui.system.js from:",n),r.next=6,window.System.import(n);case 6:return u=r.sent,console.log("[SuiLoader] Sui SDK loaded successfully"),r.abrupt("return",u);case 9:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function c(){return(c=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function o(){return(o=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function i(){return(i=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function p(){return(p=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function l(){return(l=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function f(){return(f=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function d(){return(d=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function h(){return(h=n(t().mark((function r(){return t().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return console.log("[SuiLoader] Preloading Sui SDK..."),r.next=3,a();case 3:console.log("[SuiLoader] Sui SDK preloaded");case 4:case"end":return r.stop()}}),r)})))).apply(this,arguments)}e._RF.pop()}}}));

System.register("chunks:///_virtual/main",["./BaseCameraController.ts","./CameraConfig.ts","./CameraController.ts","./CameraDebugger.ts","./CameraManager.ts","./VoxelCameraConfig.ts","./VoxelCameraController.ts","./Card2.ts","./CardConfig.ts","./CardManager.ts","./ConfigLoader.ts","./GameSettings.ts","./SuiEnvConfigManager.ts","./env.devnet.ts","./env.localnet.ts","./env.mainnet.ts","./env.testnet.ts","./GameInitializer.ts","./GameSession.ts","./Blackboard.ts","./EventBus.ts","./EventTypes.ts","./UI3DInteractionManager.ts","./InteractionManagerSwitcher.ts","./DiceController.ts","./GameBuilding.ts","./GameTile.ts","./index8.ts","./InteractionManager.ts","./GridBoundary.ts","./GridGround.ts","./MapManager.ts","./GameMap.ts","./MapBuilding.ts","./MapElement.ts","./MapObject.ts","./MapTile.ts","./MapDataTypes.ts","./MapInteractionManager.ts","./MapTemplateExporter.ts","./Actor.ts","./ActorConfig.ts","./ActorFactory.ts","./ActorTypes.ts","./NPC.ts","./PaperActor.ts","./PaperActorFactory.ts","./Player.ts","./Role.ts","./RoleAction.ts","./RoleManager.ts","./RoleTypes.ts","./RpcConfigManager.ts","./SuiConfig.ts","./index7.ts","./RollAndStepAction.ts","./aggregated.ts","./cursor.ts","./BankruptHandler.ts","./BuildingDecisionHandler.ts","./DecisionSkippedHandler.ts","./GameEndedHandler.ts","./RentDecisionHandler.ts","./RollAndStepHandler.ts","./SkipTurnHandler.ts","./index10.ts","./indexer.ts","./processor.ts","./types2.ts","./RollAndStepEvent.ts","./index13.ts","./game2.ts","./index9.ts","./mapAdmin.ts","./loader.ts","./SuiManager.ts","./index11.ts","./Card.ts","./CardRegistry.ts","./GameData.ts","./MapRegistry.ts","./index12.ts","./BFSPathfinder.ts","./HistoryStorage.ts","./MapGraph.ts","./PathCalculator.ts","./PathChoiceGenerator.ts","./RightHandRule.ts","./RotorRouter.ts","./WalkingPreference.ts","./PathfindingTest.ts","./AssetService.ts","./DataPollingService.ts","./QueryService.ts","./index4.ts","./KeypairSigner.ts","./SignerProvider.ts","./WalletSigner.ts","./index2.ts","./MapTemplate.ts","./admin.ts","./assets.ts","./cards.ts","./constants.ts","./game.ts","./index5.ts","./map.ts","./CryptoUtils.ts","./FaucetUtils.ts","./KeystoreConfig.ts","./KeystoreLoader.ts","./MapTemplateConverter.ts","./SuiErrorTranslator.ts","./TransactionErrorHandler.ts","./mapBcsEncoder.ts","./UIBase.ts","./UIManager.ts","./UITypes.ts","./UIBankruptcy.ts","./UICommonLayout.ts","./UICommonSetting.ts","./UIEditor.ts","./UIGameConfig.ts","./UIGameEnd.ts","./UIInGame.ts","./UIInGameBuildingSelect.ts","./UIInGameCards.ts","./UIInGameDebug.ts","./UIInGameDice.ts","./UIInGameInfo.ts","./UIInGamePlaySetting.ts","./UIInGamePlayer.ts","./UIMapElement.ts","./UIMapSelect.ts","./UIModeSelect.ts","./UISuiConfig.ts","./UIWallet.ts","./UIGameDetail.ts","./UIGameList.ts","./UIMapAssetList.ts","./UIMapList.ts","./index.ts","./DecisionDialogHelper.ts","./IdFormatter.ts","./UIFairyGUIAdapter.ts","./UIHelper.ts","./UIMessage.ts","./UINotification.ts","./object-utils.ts","./VoxelSystem.ts","./Web3BlockTypes.ts","./CompositeBlockRenderer.ts","./CompositeTypes.ts","./CompositeVoxelActor.ts","./VoxelBlock.ts","./VoxelBlockCatalog.ts","./VoxelBlockRegistry.ts","./VoxelChunkStorage.ts","./VoxelConfig.ts","./VoxelMap.ts","./VoxelPalette.ts","./VoxelTypes.ts","./VoxelWorldConfig.ts","./VoxelInteractionExample.ts","./VoxelLightingExample.ts","./VoxelSystemExample.ts","./index3.ts","./VoxelCollisionSystem.ts","./VoxelInteractionManager.ts","./VoxelRayCaster.ts","./AOCalculator.ts","./VoxelLightingSystem.ts","./VoxelNoise.ts","./VoxelNormalCalculator.ts","./BlockOverlayManager.ts","./NumberTextureGenerator.ts","./OverlayTypes.ts","./CubeCrossMesh.ts","./CubeCrossRenderer.ts","./VoxelCuller.ts","./VoxelMesh.ts","./VoxelRenderer.ts","./MaterialFactory.ts","./MeshBuilder.ts","./TextureManager.ts","./BlockParser.ts","./ResourceLoader.ts","./ResourcePackExample.ts","./TemplateProcessor.ts","./index6.ts","./types.ts","./utils.ts","./VoxelChunk.ts","./VoxelMapUtils.ts","./VoxelTerrain.ts","./VoxelWorld.ts"],(function(){return{setters:[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){}}}));

System.register("chunks:///_virtual/map.ts",["cc","./constants.ts"],(function(t){var e,i;return{setters:[function(t){e=t.cclegacy},function(t){i=t.NO_BUILDING}],execute:function(){function n(t,e){var i=e.tiles_static.get(t);if(!i)return[];var n=[];return 65535!==i.w&&n.push(i.w),65535!==i.n&&n.push(i.n),65535!==i.e&&n.push(i.e),65535!==i.s&&n.push(i.s),n}t({areAdjacent:function(t,e,i){return n(t,i).includes(e)},getAdjacentTiles:n,getBuildingTiles:function(t,e){var i=[];return e.tiles_static.forEach((function(e,n){e.building_id===t&&i.push(n)})),i},getDistance:function(t,e,i,n){void 0===n&&(n=65535);if(t===e)return 0;var r=[{tile:t,dist:0,prev:n}],s=new Set([t]);for(;r.length>0;){var u=r.shift(),c=u.tile,a=u.dist,f=u.prev,o=i.tiles_static.get(c);if(o)for(var d=[o.w,o.n,o.e,o.s],l=0,h=d;l<h.length;l++){var p=h[l];if(65535!==p&&(!s.has(p)&&(p!==f||0!==a))){if(p===e)return a+1;s.add(p),r.push({tile:p,dist:a+1,prev:c})}}}return-1},hasBuilding:function(t){return t.building_id!==i}}),e._RF.push({},"143dcACbu1DR5qreoiY/zhL","map",void 0),e._RF.pop()}}}));

System.register("chunks:///_virtual/mapAdmin.ts",["./rollupPluginModLoBabelHelpers.js","cc","./mapBcsEncoder.ts","./loader.ts"],(function(e){var t,n,s,o,a;return{setters:[function(e){t=e.asyncToGenerator,n=e.regeneratorRuntime},function(e){s=e.cclegacy},function(e){o=e.encodeMapTemplateToBCS},function(e){a=e.loadSuiTransactions}],execute:function(){e("initMapAdminInteraction",(function(){return i.apply(this,arguments)})),s._RF.push({},"c0a603oBcRJJJ1opH3JvGCn","mapAdmin",void 0);var r=null;function i(){return(i=t(n().mark((function e(){var t,s;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=6;break}return e.next=3,a();case 3:t=e.sent,s=t.Transaction,r=s;case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}e("MapAdminInteraction",function(){function e(e,t,n){this.client=e,this.packageId=t,this.gameDataId=n}var s=e.prototype;return s.buildUploadMapTemplateTx=function(){var e=t(n().mark((function e(t,s){var a,i;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[MapAdmin] Building upload map template transaction..."),console.log("Template ID: "+t.id),console.log("Schema version: "+s),console.log("Tiles: "+t.tiles_static.size),console.log("Buildings: "+t.buildings_static.size),console.log("Hospital IDs: "+t.hospital_ids.length),console.log("[MapAdmin] Encoding map template to BCS..."),e.next=9,o(t);case 9:return a=e.sent,console.log("Encoded tiles: "+a.tilesBytes.length+" bytes"),console.log("Encoded buildings: "+a.buildingsBytes.length+" bytes"),console.log("Encoded hospital_ids: "+a.hospitalIdsBytes.length+" bytes"),(i=new r).moveCall({target:this.packageId+"::tycoon::publish_map_from_bcs",arguments:[i.object(this.gameDataId),i.pure.u8(s),i.pure.vector("u8",a.tilesBytes),i.pure.vector("u8",a.buildingsBytes),i.pure.vector("u8",a.hospitalIdsBytes)]}),e.abrupt("return",i);case 16:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),s.uploadMapTemplate=function(){var e=t(n().mark((function e(t,s){var a,i,l,c,u,p,d,g;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[MapAdmin] Starting map upload..."),console.log("Template ID: "+t.id),console.log("Tiles: "+t.tiles_static.size),console.log("Buildings: "+t.buildings_static.size),console.log("Hospital IDs: "+t.hospital_ids.length),console.log("[MapAdmin] Encoding map template to BCS..."),e.next=8,o(t);case 8:return l=e.sent,console.log("Encoded tiles: "+l.tilesBytes.length+" bytes"),console.log("Encoded buildings: "+l.buildingsBytes.length+" bytes"),console.log("Encoded hospital_ids: "+l.hospitalIdsBytes.length+" bytes"),(c=new r).moveCall({target:this.packageId+"::tycoon::publish_map_from_bcs",arguments:[c.object(this.gameDataId),c.pure.u8(t.schema_version),c.pure.vector("u8",l.tilesBytes),c.pure.vector("u8",l.buildingsBytes),c.pure.vector("u8",l.hospitalIdsBytes)]}),console.log("[MapAdmin] Submitting transaction..."),e.next=17,this.client.signAndExecuteTransaction({transaction:c,signer:s,options:{showEffects:!0,showEvents:!0,showObjectChanges:!0}});case 17:if(u=e.sent,"success"===(null==(a=u.effects)||null==(a=a.status)?void 0:a.status)){e.next=21;break}throw d=(null==(p=u.effects)||null==(p=p.status)?void 0:p.error)||"Unknown error",new Error("Transaction failed: "+d);case 21:return console.log("[MapAdmin] Map template uploaded successfully!"),console.log("Transaction digest:",u.digest),(g=null==(i=u.events)?void 0:i.find((function(e){return e.type.includes("MapTemplatePublishedEvent")})))&&console.log("MapTemplatePublished Event:",g.parsedJson),e.abrupt("return",{txHash:u.digest,templateId:t.id});case 26:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),s.getMapTemplate=function(){var e=t(n().mark((function e(t){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("[MapAdmin] Getting map template "+t+"..."),e.abrupt("return",null);case 5:return e.prev=5,e.t0=e.catch(0),console.error("[MapAdmin] Failed to get map template:",e.t0),e.abrupt("return",null);case 9:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}(),s.listMapTemplates=function(){var e=t(n().mark((function e(){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",[]);case 4:return e.prev=4,e.t0=e.catch(0),console.error("[MapAdmin] Failed to list map templates:",e.t0),e.abrupt("return",[]);case 8:case"end":return e.stop()}}),e,null,[[0,4]])})));return function(){return e.apply(this,arguments)}}(),e}());s._RF.pop()}}}));

System.register("chunks:///_virtual/mapBcsEncoder.ts",["./rollupPluginModLoBabelHelpers.js","cc","./loader.ts"],(function(e){var t,i,n,r;return{setters:[function(e){t=e.asyncToGenerator,i=e.regeneratorRuntime},function(e){n=e.cclegacy},function(e){r=e.loadSuiBcs}],execute:function(){e({decodeMapTemplateFromBCS:function(e,t,i){return o.apply(this,arguments)},encodeMapTemplateToBCS:function(e){return p.apply(this,arguments)}}),n._RF.push({},"8eab2LYKghF2bHFIBtb/AIk","mapBcsEncoder",void 0);var s=null,a=null;function c(){return u.apply(this,arguments)}function u(){return(u=t(i().mark((function e(){var t,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s||!a){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,r();case 4:t=e.sent,n=t.bcs,s=n.struct("TileStatic",{x:n.u8(),y:n.u8(),kind:n.u8(),building_id:n.u16(),special:n.u64(),w:n.u16(),n:n.u16(),e:n.u16(),s:n.u16()}),a=n.struct("BuildingStatic",{x:n.u8(),y:n.u8(),size:n.u8(),price:n.u64(),chain_prev_id:n.u16(),chain_next_id:n.u16()});case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(){return(p=t(i().mark((function e(t){var n,u,p,o,l,d,f,x,y,_,b,h,g,m,v,k;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c();case 2:return e.next=4,r();case 4:n=e.sent,u=n.bcs,p=[],o=Math.max.apply(Math,Array.from(t.tiles_static.keys())),l=0;case 9:if(!(l<=o)){e.next=17;break}if(d=t.tiles_static.get(l)){e.next=13;break}throw new Error("Missing tile at index "+l+". Tiles must be sequential from 0 to "+o+".");case 13:p.push({x:d.x,y:d.y,kind:d.kind,building_id:d.building_id,special:"bigint"==typeof d.special?d.special:BigInt(d.special||0),w:d.w,n:d.n,e:d.e,s:d.s});case 14:l++,e.next=9;break;case 17:if(f=[],!(t.buildings_static.size>0)){e.next=29;break}x=Math.max.apply(Math,Array.from(t.buildings_static.keys())),y=0;case 21:if(!(y<=x)){e.next=29;break}if(_=t.buildings_static.get(y)){e.next=25;break}throw new Error("Missing building at index "+y+". Buildings must be sequential from 0 to "+x+".");case 25:f.push({x:_.x,y:_.y,size:_.size,price:"bigint"==typeof _.price?_.price:BigInt(_.price||0),chain_prev_id:_.chain_prev_id,chain_next_id:_.chain_next_id});case 26:y++,e.next=21;break;case 29:return b=u.vector(s),h=u.vector(a),g=u.vector(u.u16()),m=b.serialize(p).toBytes(),v=h.serialize(f).toBytes(),k=g.serialize(t.hospital_ids).toBytes(),e.abrupt("return",{tilesBytes:Array.from(m),buildingsBytes:Array.from(v),hospitalIdsBytes:Array.from(k)});case 36:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function o(){return(o=t(i().mark((function e(t,n,u){var p,o,l,d,f,x,y,_;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c();case 2:return e.next=4,r();case 4:return p=e.sent,o=p.bcs,l=o.vector(s),d=o.vector(a),f=o.vector(o.u16()),x=l.parse(t),y=d.parse(n),_=f.parse(u),e.abrupt("return",{tiles:x.map((function(e){return{x:e.x,y:e.y,kind:e.kind,building_id:e.building_id,special:e.special,w:e.w,n:e.n,e:e.e,s:e.s}})),buildings:y.map((function(e){return{x:e.x,y:e.y,size:e.size,price:e.price,chain_prev_id:e.chain_prev_id,chain_next_id:e.chain_next_id}})),hospital_ids:_});case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}n._RF.pop()}}}));

System.register("chunks:///_virtual/MapBuilding.ts",["./rollupPluginModLoBabelHelpers.js","cc","./MapElement.ts","./Web3BlockTypes.ts"],(function(i){var e,t,n,r,o,s,l,c,u;return{setters:[function(i){e=i.inheritsLoose,t=i.asyncToGenerator,n=i.regeneratorRuntime},function(i){r=i.cclegacy,o=i._decorator,s=i.Vec3,l=i.Vec2},function(i){c=i.MapElement},function(i){u=i.getWeb3BlockByBlockId}],execute:function(){var d;r._RF.push({},"a9817nVO0ZIy4vFSJ+++4Hy","MapBuilding",void 0);var a=o.ccclass;i("MapBuilding",a("MapBuilding")(d=function(i){function r(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=i.call.apply(i,[this].concat(n))||this)._buildingId=65535,e._owner=null,e._level=0,e._direction=0,e._size=1,e._price=0,e}e(r,i);var o=r.prototype;return o.initialize=function(){var i=t(n().mark((function i(e,t){var r;return n().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(this._blockId=e,this._gridPosition=t,r=u(e)){i.next=6;break}return console.error("[MapBuilding] Unknown block ID: "+e),i.abrupt("return");case 6:this._size=r.size||1,this._typeId=r.typeId,1===this._size?this._worldPosition=new s(t.x+.5,0,t.y+.5):this._worldPosition=new s(t.x+1,0,t.y+1),this.node.setPosition(this._worldPosition),this.initializeBuildingProperties(),this._initialized=!0,console.log("[MapBuilding] Initialized building "+e+" at ("+t.x+", "+t.y+")");case 13:case"end":return i.stop()}}),i,this)})));return function(e,t){return i.apply(this,arguments)}}(),o.initializeBuildingProperties=function(){this._price=1e3},o.getElementType=function(){return"building"},o.createVisual=function(){var i=t(n().mark((function i(){return n().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:case"end":return i.stop()}}),i)})));return function(){return i.apply(this,arguments)}}(),o.getData=function(){return{blockId:this._blockId,typeId:this._typeId,position:{x:this._gridPosition.x,z:this._gridPosition.y},size:this._size,buildingId:65535!==this._buildingId?this._buildingId:void 0,owner:this._owner||void 0,level:this._level,direction:this._direction,price:this._price}},o.loadData=function(){var i=t(n().mark((function i(e){return n().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.initialize(e.blockId,new l(e.position.x,e.position.z));case 2:void 0!==e.buildingId&&(this._buildingId=e.buildingId),void 0!==e.owner&&(this._owner=e.owner),void 0!==e.level&&(this._level=e.level),void 0!==e.direction&&(this._direction=e.direction),void 0!==e.price&&(this._price=e.price);case 7:case"end":return i.stop()}}),i,this)})));return function(e){return i.apply(this,arguments)}}(),o.canUpgrade=function(){return!!this._owner&&!(this._level>=4)},o.getBuildingId=function(){return this._buildingId},o.setBuildingId=function(i){this._buildingId=i},o.getOwner=function(){return this._owner},o.setOwner=function(i){this._owner=i,console.log("[MapBuilding] Set owner of building at ("+this._gridPosition.x+", "+this._gridPosition.y+") to "+i)},o.getLevel=function(){return this._level},o.setLevel=function(i){if(i<0||i>4)console.warn("[MapBuilding] Invalid building level: "+i);else{var e=this._level;this._level=i,console.log("[MapBuilding] Building level changed from "+e+" to "+i)}},o.getDirection=function(){return this._direction},o.setDirection=function(i){this._direction=i%4},o.getSize=function(){return this._size},o.upgrade=function(){return!!this.canUpgrade()&&(this.setLevel(this._level+1),!0)},o.downgrade=function(){return!(this._level<=0)&&(this.setLevel(this._level-1),!0)},o.getPrice=function(){return this._price},o.setPrice=function(i){this._price=i},o.getUpgradeCost=function(){return.5*this._price*(this._level+1)},o.getBuildingInfo=function(){return{blockId:this._blockId,typeId:this._typeId,position:{x:this._gridPosition.x,z:this._gridPosition.y},size:this._size,buildingId:65535!==this._buildingId?this._buildingId:void 0,owner:this._owner,level:this._level,levelName:this.getLevelName(),direction:this._direction,price:this._price,rent:this._price,upgradeCost:this.canUpgrade()?this.getUpgradeCost():null}},o.getLevelName=function(){switch(this._level){case 0:return"空地";case 1:return"小屋";case 2:return"洋房";case 3:return"大楼";case 4:return"地标";default:return"未知"}},r}(c))||d);r._RF.pop()}}}));

System.register("chunks:///_virtual/MapDataTypes.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Web3BlockTypes.ts"],(function(e){var t,a,i,o;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){a=e.cclegacy},function(e){i=e.Web3TileType,o=e.Web3ObjectType}],execute:function(){e({createEmptyMapData:function(e,t){return{mapId:e,mapName:t,version:"1.0.0",createTime:Date.now(),updateTime:Date.now(),gameMode:"edit",tiles:[],objects:[]}},validateMapData:function(e){var a=[],n=[];e.mapId||a.push("Missing mapId");e.mapName||a.push("Missing mapName");e.version||a.push("Missing version");Array.isArray(e.tiles)||a.push("tiles must be an array");Array.isArray(e.objects)||a.push("objects must be an array");for(var s,r=new Set,p=t(e.tiles);!(s=p()).done;){var u=s.value,l=u.position.x+"_"+u.position.z;r.has(l)&&n.push("Duplicate tile at position ("+u.position.x+", "+u.position.z+")"),r.add(l)}for(var c,d=new Set,h=t(e.objects);!(c=h()).done;){var v=c.value,y=v.position.x+"_"+v.position.z;d.has(y)&&n.push("Duplicate object at position ("+v.position.x+", "+v.position.z+")"),d.add(y)}var m=e.tiles.filter((function(e){return e.typeId===i.LOTTERY})).length,b=e.objects.filter((function(e){return e.typeId>=o.LAND_GOD&&e.typeId<=o.POVERTY_GOD})).length;return{valid:0===a.length,errors:a.length>0?a:void 0,warnings:n.length>0?n:void 0,stats:{tileCount:e.tiles.length,objectCount:e.objects.length,propertyCount:m,npcCount:b}}}}),a._RF.push({},"ea474MQ9kRCPp4RwPjYV7nf","MapDataTypes",void 0),a._RF.pop()}}}));

System.register("chunks:///_virtual/MapElement.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelSystem.ts"],(function(e){var t,n,o,i,r,l,s,c,d,a;return{setters:[function(e){t=e.inheritsLoose,n=e.asyncToGenerator,o=e.regeneratorRuntime},function(e){i=e.cclegacy,r=e._decorator,l=e.Vec3,s=e.BoxCollider,c=e.Vec2,d=e.Component},function(e){a=e.VoxelSystem}],execute:function(){var u;i._RF.push({},"c4ac5kCsJ5JBanWCA966I3n","MapElement",void 0);var h=r.ccclass;r.property,e("MapElement",h("MapElement")(u=function(e){function i(){for(var t,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(t=e.call.apply(e,[this].concat(o))||this)._blockId="",t._typeId=0,t._gridPosition=new c,t._worldPosition=new l,t._renderNode=null,t._collider=null,t._voxelSystem=null,t._initialized=!1,t}t(i,e);var r=i.prototype;return r.getGridPosition=function(){return this._gridPosition.clone()},r.getWorldPosition=function(){return this._worldPosition.clone()},r.getBlockId=function(){return this._blockId},r.getTypeId=function(){return this._typeId},r.isInitialized=function(){return this._initialized},r.setupCollider=function(e,t){void 0===e&&(e=new l(1,1,1)),void 0===t&&(t=new l(0,.5,0)),this._collider||(this._collider=this.node.addComponent(s)),this._collider.size=e,this._collider.center=t},r.createVoxelRender=function(){var e=n(o().mark((function e(t,n){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this._voxelSystem){e.next=7;break}if(this._voxelSystem=a.getInstance(),this._voxelSystem){e.next=7;break}return e.next=6,a.quickInitialize();case 6:this._voxelSystem=e.sent;case 7:if(!this._voxelSystem){e.next=14;break}return e.next=10,this._voxelSystem.preloadBlockMaterial(t);case 10:return e.next=12,this._voxelSystem.createBlockNode(this.node,t,n);case 12:this._renderNode=e.sent,this._renderNode||console.warn("[MapElement] Failed to create voxel render for "+t);case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("[MapElement] Error creating voxel render:",e.t0);case 19:case"end":return e.stop()}}),e,this,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}(),r.cleanupRenderNode=function(){this._renderNode&&this._renderNode.isValid&&(this._renderNode.destroy(),this._renderNode=null)},r.setHighlighted=function(e){this._renderNode},r.setSelected=function(e){this._renderNode},r.playAnimation=function(e){},r.stopAnimation=function(){},r.update=function(e){},r.onEnable=function(){},r.onDisable=function(){},r.onDestroy=function(){this.cleanupRenderNode(),this._collider&&(this._collider=null),this._voxelSystem=null,this._initialized=!1},r.gridToWorld=function(e,t){return void 0===t&&(t=0),new l(e.x+.5,t,e.y+.5)},r.worldToGrid=function(e){return new c(Math.floor(e.x),Math.floor(e.z))},i}(d))||u);i._RF.pop()}}}));

System.register("chunks:///_virtual/MapGraph.ts",["./rollupPluginModLoBabelHelpers.js","cc","./MapTemplate.ts"],(function(e){var t,n,o,r;return{setters:[function(e){t=e.createForOfIteratorHelperLoose,n=e.createClass},function(e){o=e.cclegacy},function(e){r=e.getTileNeighbors}],execute:function(){o._RF.push({},"39a6c9Ne0xNTIMe92IaElPH","MapGraph",void 0);e("MapGraph",function(){function e(e){this.nodes=void 0,this.template=void 0,this.template=e,this.nodes=new Map,this.buildGraph()}var o=e.prototype;return o.buildGraph=function(){for(var e,n=t(this.template.tiles);!(e=n()).done;){var o=e.value,i=o[0],s=o[1],a={id:i,neighbors:r(this.template,i),tileInfo:s};this.nodes.set(i,a)}console.log("[MapGraph] Built graph with "+this.nodes.size+" nodes")},o.getNode=function(e){return this.nodes.get(e)},o.getNeighbors=function(e){var t=this.nodes.get(e);return t?t.neighbors:[]},o.getAllNodes=function(){return Array.from(this.nodes.values())},o.areNeighbors=function(e,t){var n=this.nodes.get(e);return!!n&&n.neighbors.includes(t)},o.getMoveType=function(e,t){var n=this.template.tiles.get(e);return n?n.cw_next===t?"cw":n.ccw_next===t?"ccw":n.adj.includes(t)?"adj":null:null},o.getTemplate=function(){return this.template},o.debugPrint=function(){console.log("[MapGraph] Graph structure:");for(var e,n=t(this.nodes);!(e=n()).done;){var o=e.value,r=o[0],i=o[1];console.log("  Node "+r+": neighbors = ["+i.neighbors.join(", ")+"]")}},n(e,[{key:"size",get:function(){return this.nodes.size}}]),e}());o._RF.pop()}}}));

System.register("chunks:///_virtual/MapInteractionManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./EventTypes.ts"],(function(e){var t,i,o,n,r,a,s,l,u,c,d,h,g,p;return{setters:[function(e){t=e.applyDecoratedDescriptor,i=e.inheritsLoose,o=e.initializerDefineProperty,n=e.assertThisInitialized},function(e){r=e.cclegacy,a=e._decorator,s=e.Camera,l=e.find,u=e.Vec3,c=e.Vec2,d=e.PhysicsSystem,h=e.Component},function(e){g=e.EventBus},function(e){p=e.EventTypes}],execute:function(){var f,E,m,M,y,v,C,P,b,w,_,R,D,N,I;r._RF.push({},"899c77ulSNKGqUTWa9fBieD","MapInteractionManager",void 0);var T=a.ccclass,S=a.property,L=e("MapInteractionEvent",function(e){return e.ELEMENT_CLICKED="MapElementClicked",e.EMPTY_CLICKED="EmptyPositionClicked",e.REQUEST_PLACE="RequestPlaceElement",e.REQUEST_REMOVE="RequestRemoveElement",e.HOVER_CHANGED="HoverPositionChanged",e}({}));e("MapInteractionManager",(f=T("MapInteractionManager"),E=S({type:s,displayName:"目标相机"}),m=S({displayName:"启用物理射线检测"}),M=S({displayName:"最大检测距离"}),y=S({displayName:"地面Y坐标"}),v=S({displayName:"网格步长"}),C=S({displayName:"调试模式"}),f((w=t((b=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return t=e.call.apply(e,[this].concat(r))||this,o(t,"targetCamera",w,n(t)),o(t,"enablePhysicsRaycast",_,n(t)),o(t,"maxRayDistance",R,n(t)),o(t,"groundY",D,n(t)),o(t,"gridStep",N,n(t)),o(t,"debugMode",I,n(t)),t.LAYER_TILES=1,t.LAYER_OBJECTS=2,t._currentHoverGrid=null,t._currentHoverNode=null,t._initialized=!1,t}i(t,e);var r=t.prototype;return r.onLoad=function(){if(!this.targetCamera){var e=l("Main Camera");e&&(this.targetCamera=e.getComponent(s))}this.targetCamera?(this._initialized=!0,this.log("MapInteractionManager initialized")):console.error("[MapInteractionManager] No camera found!")},r.onEnable=function(){this._initialized&&(g.on(p.Input3D.MouseDown,this.onMouseDown,this),g.on(p.Input3D.MouseUp,this.onMouseUp,this),g.on(p.Input3D.MouseMove,this.onMouseMove,this),this.log("EventBus mouse events registered"))},r.onDisable=function(){g.off(p.Input3D.MouseDown,this.onMouseDown,this),g.off(p.Input3D.MouseUp,this.onMouseUp,this),g.off(p.Input3D.MouseMove,this.onMouseMove,this),this.log("EventBus mouse events unregistered")},r.onMouseDown=function(e){this.handleMouseClick(e,!0)},r.onMouseUp=function(e){2===e.button&&this.handleMouseClick(e,!1)},r.onMouseMove=function(e){if(this.targetCamera){var t=this.performRaycast(e),i=this.worldToGrid(t.worldPosition);this._currentHoverGrid&&i.equals(this._currentHoverGrid)||(this._currentHoverGrid=i,this._currentHoverNode=t.hitNode||null,g.emit(L.HOVER_CHANGED,{worldPosition:t.worldPosition,gridPosition:i,hitNode:t.hitNode,hasElement:t.hasElement}))}},r.handleMouseClick=function(e,t){if(this.targetCamera){var i=e.button||0;if(!(0===i&&!t||2===i&&t)){var o,n=this.performRaycast(e),r={worldPosition:n.worldPosition,gridPosition:n.gridPosition,button:i,hitNode:n.hitNode,hitCollider:n.hitCollider,hasElement:n.hasElement};if(this.debugMode)console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("[MapInteractionManager] 点击检测"),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("世界坐标: ("+n.worldPosition.x.toFixed(2)+", "+n.worldPosition.y.toFixed(2)+", "+n.worldPosition.z.toFixed(2)+")"),console.log("网格坐标: ["+n.gridPosition.x+", "+n.gridPosition.y+"]"),console.log("击中元素: "+(n.hasElement?null==(o=n.hitNode)?void 0:o.name:"无")),console.log("鼠标按键: "+(0===i?"左键":2===i?"右键":"其他")),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");n.hasElement?(g.emit(L.ELEMENT_CLICKED,r),2===i?g.emit(L.REQUEST_REMOVE,r):0===i&&g.emit(L.REQUEST_PLACE,r)):(g.emit(L.EMPTY_CLICKED,r),0===i&&g.emit(L.REQUEST_PLACE,r))}}},r.performRaycast=function(e){var t,i;if(!this.targetCamera)return{worldPosition:new u,gridPosition:new c,hasElement:!1};var o=this.targetCamera.screenPointToRay(e.screenX,e.screenY),n=null,r=new u;if(this.enablePhysicsRaycast&&d.instance){var a=d.instance.raycastResults,s=this.LAYER_TILES|this.LAYER_OBJECTS;if(d.instance.raycast(o,s,this.maxRayDistance,!1)&&a.length>0){var l=a[0];n={hitNode:l.collider.node,hitCollider:l.collider,hitPoint:l.hitPoint,distance:l.distance},r=l.hitPoint.clone(),this.log("物理射线击中: "+l.collider.node.name+" at "+r)}}if(!n){var h=this.raycastPlane(o,this.groundY);h&&(r=h,this.log("平面检测击中: "+r))}return{worldPosition:r,gridPosition:this.worldToGrid(r),hitNode:(null==(t=n)?void 0:t.hitNode)||null,hitCollider:(null==(i=n)?void 0:i.hitCollider)||null,hasElement:null!==n}},r.raycastPlane=function(e,t){if(Math.abs(e.d.y)<.001)return null;var i=(t-e.o.y)/e.d.y;return i<0?null:new u(e.o.x+i*e.d.x,t,e.o.z+i*e.d.z)},r.worldToGrid=function(e){return new c(Math.floor(e.x/this.gridStep),Math.floor(e.z/this.gridStep))},r.gridToWorld=function(e,t){return void 0===t&&(t=0),new u(e.x*this.gridStep+.5*this.gridStep,t,e.y*this.gridStep+.5*this.gridStep)},r.getCurrentHoverGrid=function(){return this._currentHoverGrid?this._currentHoverGrid.clone():null},r.getCurrentHoverNode=function(){return this._currentHoverNode},r.log=function(e){this.debugMode&&console.log("[MapInteractionManager] "+e)},t}(h)).prototype,"targetCamera",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_=t(b.prototype,"enablePhysicsRaycast",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R=t(b.prototype,"maxRayDistance",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),D=t(b.prototype,"groundY",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),N=t(b.prototype,"gridStep",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),I=t(b.prototype,"debugMode",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P=b))||P));r._RF.pop()}}}));

System.register("chunks:///_virtual/MapManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./GameMap.ts","./VoxelSystem.ts","./GridGround.ts","./UINotification.ts","./IdFormatter.ts"],(function(e,n){var t,a,r,o,i,s,c,p,u,l,d,M,f,m,h,g,y,v,_,I,C,b;return{setters:[function(e){t=e.applyDecoratedDescriptor,a=e.inheritsLoose,r=e.initializerDefineProperty,o=e.assertThisInitialized,i=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){c=e.cclegacy,p=e._decorator,u=e.Node,l=e.director,d=e.Component,M=e.resources,f=e.Prefab,m=e.instantiate},function(e){h=e.EventBus},function(e){g=e.EventTypes},function(e){y=e.Blackboard},function(e){v=e.GameMap},function(e){_=e.VoxelSystem},function(e){I=e.GridGround},function(e){C=e.UINotification},function(e){b=e.IdFormatter}],execute:function(){var w,G,x,k,E,P,S,z,N,T;c._RF.push({},"cc233vriZxLvKmg8V4xQNBR","MapManager",void 0);var L=p.ccclass,R=p.property,F=e("MapManager",(w=L("MapManager"),G=R({displayName:"地图容器节点",type:u,tooltip:"地图实例将加载到此容器中"}),x=R({displayName:"地图配置文件路径",tooltip:"存储所有地图配置的JSON文件路径"}),k=R({displayName:"启用调试模式",tooltip:"是否输出详细的调试信息"}),w(((T=function(e){function t(){for(var n,t=arguments.length,a=new Array(t),i=0;i<t;i++)a[i]=arguments[i];return n=e.call.apply(e,[this].concat(a))||this,r(n,"mapContainer",S,o(n)),r(n,"mapConfigPath",z,o(n)),r(n,"debugMode",N,o(n)),n._mapConfigs=new Map,n._currentMapInstance=null,n._currentMapComponent=null,n._currentMapId=null,n._preloadedMaps=new Map,n}a(t,e),t.getInstance=function(){return t._instance};var c=t.prototype;return c.onLoad=function(){null===t._instance?(t._instance=this,l.addPersistRootNode(this.node),this.log("MapManager initialized")):this.destroy()},c.start=function(){var e=i(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.loadMapConfigs();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),console.error("[MapManager] 地图配置加载失败，继续以降级模式运行:",e.t0);case 8:this.registerEventListeners(),_.getInstance().initialize(),this.log("MapManager ready");case 11:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(){return e.apply(this,arguments)}}(),c.onDestroy=function(){t._instance===this&&(t._instance=null),this.unloadCurrentMap(),this._preloadedMaps.clear()},c.loadMapConfigs=function(){var e=i(s().mark((function e(){var n=this;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,t){M.load(n.mapConfigPath,(function(a,r){if(a)return console.error("[MapManager] 加载地图配置失败:",a),void t(a);try{var o=r.json;o&&o.maps&&(o.maps.forEach((function(e){n._mapConfigs.set(e.id,e)})),n.log("已加载 "+n._mapConfigs.size+" 个地图配置")),e()}catch(e){console.error("[MapManager] 解析地图配置失败:",e),t(e)}}))})));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),c.getAvailableMaps=function(){return Array.from(this._mapConfigs.values())},c.getMapConfig=function(e){return this._mapConfigs.get(e)||null},c.preloadMap=function(){var e=i(s().mark((function e(n){var t,a=this;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getMapConfig(n)){e.next=4;break}return console.error("[MapManager] 地图配置不存在:",n),e.abrupt("return",!1);case 4:if(!this._preloadedMaps.has(n)){e.next=7;break}return this.log("地图 "+n+" 已预加载"),e.abrupt("return",!0);case 7:return e.abrupt("return",new Promise((function(e){M.load(t.prefabPath,f,(function(t,r){if(t)return console.error("[MapManager] 预加载地图 "+n+" 失败:",t),void e(!1);a._preloadedMaps.set(n,r),a.log("地图 "+n+" 预加载成功"),e(!0)}))})));case 8:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),c.loadMap=function(){var e=i(s().mark((function e(n,t){var a,r,o,i,c;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("准备加载地图: "+n),a=this.getMapConfig(n)){e.next=4;break}return e.abrupt("return",{success:!1,error:"地图配置不存在"});case 4:if(e.prev=4,this.unloadCurrentMap(),(r=this._preloadedMaps.get(n))||!a.prefabPath){e.next=11;break}return e.next=10,this.loadMapPrefab(a.prefabPath);case 10:r=e.sent;case 11:return r?o=m(r):(o=new u(a.id),this.log("地图 "+n+" 没有预制体，创建空节点")),i=o.addComponent(v),e.next=15,i.init(a,t);case 15:if((c=this.mapContainer||l.getScene())&&c.addChild(o),this._currentMapInstance=o,this._currentMapComponent=i,this._currentMapId=n,this.log("地图 "+n+" 加载成功"),!t){e.next=26;break}return console.log("[MapManager] Editor mode: showing tile type overlays by default..."),e.next=25,i.showTileTypeOverlays();case 25:console.log("[MapManager] Tile type overlays shown");case 26:return h.emit(g.Game.MapLoaded,{mapId:n,mapName:a.name,mapComponent:i}),e.abrupt("return",{success:!0,mapInstance:o,mapComponent:i});case 30:return e.prev=30,e.t0=e.catch(4),console.error("[MapManager] 加载地图 "+n+" 失败:",e.t0),e.abrupt("return",{success:!1,error:e.t0.toString()});case 34:case"end":return e.stop()}}),e,this,[[4,30]])})));return function(n,t){return e.apply(this,arguments)}}(),c.loadGameMapFromSession=function(){var e=i(s().mark((function e(n){var t,a,r,o,i,c;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[MapManager] 从 GameSession 加载游戏地图"),this.unloadCurrentMap(),t=n.getGameId(),a=b.shortenAddress(t).replace(/\.\.\./g,"___"),r=new u("ChainGame_"+a),o=r.addComponent(v),i={id:"chain_"+t,name:"Chain Game",prefabPath:"",previewImagePath:"",type:"classic"},console.log("[MapManager] Initializing GameMap (play mode)..."),e.next=10,o.init(i,!1);case 10:return console.log("[MapManager] Loading scene from GameSession..."),C.info("正在加载游戏地图..."),e.next=14,o.loadFromGameSession(n);case 14:if(e.sent){e.next=17;break}throw new Error("Failed to load game map from session");case 17:return console.log("[MapManager] Game map loaded successfully"),(c=this.mapContainer||l.getScene())&&c.addChild(r),this._currentMapInstance=r,this._currentMapComponent=o,this._currentMapId=i.id,this.log("链上游戏地图加载成功: "+i.id),console.log("[MapManager] Showing tile type overlays by default..."),e.next=27,o.showTileTypeOverlays();case 27:return console.log("[MapManager] Tile type overlays shown"),h.emit(g.Game.MapLoaded,{gameId:t,mapId:i.id,mapComponent:o}),C.success("游戏地图加载完成"),e.abrupt("return",o);case 31:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),c.unloadCurrentMap=function(){this._currentMapInstance&&(this.log("卸载当前地图: "+this._currentMapId),this._currentMapId&&h.emit(g.Game.MapUnloaded,{mapId:this._currentMapId}),this._currentMapInstance.destroy(),this._currentMapInstance=null,this._currentMapComponent=null,this._currentMapId=null)},c.getCurrentGameMap=function(){return this._currentMapComponent},c.getCurrentMapInfo=function(){if(!this._currentMapId||!this._currentMapComponent)return null;var e=this.getMapConfig(this._currentMapId);return e?{mapId:this._currentMapId,config:e,component:this._currentMapComponent}:null},c.loadMapPrefab=function(){var e=i(s().mark((function e(n){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){M.load(n,f,(function(n,t){if(n)return console.warn("[MapManager] 加载地图预制体失败:",n),void e(null);e(t)}))})));case 1:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),c.registerEventListeners=function(){h.on(g.Game.MapSelected,this.onMapSelected,this),h.on(g.Game.RequestMapChange,this.onMapChangeRequest,this)},c.onMapSelected=function(){var e=i(s().mark((function e(t){var a,r,o,i;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("收到地图选择事件: mapId="+t.mapId+", isEdit="+t.isEdit),e.next=3,this.loadMap(t.mapId,t.isEdit);case 3:if(!(a=e.sent).success){e.next=16;break}return console.log("[MapManager] loadMap成功, 显示 UIInGame"),e.next=8,n.import("./UIManager.ts");case 8:return o=e.sent,i=o.UIManager,e.next=12,null==(r=i.instance)?void 0:r.showUI("InGame");case 12:console.log("[MapManager] 发送 GameStart 事件"),h.emit(g.Game.GameStart,{mode:t.isEdit?"edit":"play",source:"map_select"}),e.next=18;break;case 16:console.error("[MapManager] loadMap失败:",a.error),h.emit(g.Game.MapLoadFailed,{mapId:t.mapId,isEdit:t.isEdit,error:a.error});case 18:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),c._initializeGameState=function(e,n){if(console.log("[MapManager] Initializing game state to Blackboard"),y.instance.set("currentGameId",e.id),y.instance.set("currentRound",e.round),y.instance.set("currentTurn",e.turn),y.instance.set("currentGame",e),e.players&&e.players.length>0){var t=e.players[0];y.instance.set("playerName","玩家 #1"),y.instance.set("playerMoney",Number(t.cash)),y.instance.set("playerLevel",1),y.instance.set("playerHp",100),y.instance.set("playerMaxHp",100),y.instance.set("playerExp",0),y.instance.set("playerMaxExp",1e3)}y.instance.set("gameData",n),y.instance.set("gameTime",0),console.log("[MapManager] Game state initialized")},c.onMapChangeRequest=function(){var e=i(s().mark((function e(n){var t;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("地图切换请求: "+n.fromMapId+" -> "+n.toMapId),null!==n.toMapId){e.next=4;break}return this.unloadCurrentMap(),e.abrupt("return");case 4:return e.next=6,this.loadMap(n.toMapId,n.isEdit||!1);case 6:(t=e.sent).success||console.error("[MapManager] 地图切换失败:",t.error);case 8:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),c.createGridGround=function(e){var n=new u("GridGround"),t=n.addComponent(I);return e&&t.createWithConfig(e),n.setPosition(0,0,0),this.log("Grid ground created successfully with GridGround component"),n},c.getCurrentMapEditMode=function(){return!!this._currentMapComponent&&this._currentMapComponent.isEditMode},c.log=function(e){this.debugMode&&console.log("[MapManager] "+e)},t}(d))._instance=null,S=t((P=T).prototype,"mapContainer",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),z=t(P.prototype,"mapConfigPath",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"data/configs/maps_config"}}),N=t(P.prototype,"debugMode",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),E=P))||E));e("mapManager",{get instance(){return F.getInstance()}});c._RF.pop()}}}));

System.register("chunks:///_virtual/MapObject.ts",["./rollupPluginModLoBabelHelpers.js","cc","./MapElement.ts","./Web3BlockTypes.ts"],(function(t){var n,e,i,a,o,s,r,c,h,u,d;return{setters:[function(t){n=t.inheritsLoose,e=t.asyncToGenerator,i=t.regeneratorRuntime},function(t){a=t.cclegacy,o=t._decorator,s=t.Vec3,r=t.Animation,c=t.Vec2},function(t){h=t.MapElement},function(t){u=t.Web3ObjectType,d=t.getWeb3BlockByBlockId}],execute:function(){var l;a._RF.push({},"01ee6XyZ2dCCZ7dVneFwdYH","MapObject",void 0);var p=o.ccclass;t("MapObject",p("MapObject")(l=function(t){function a(){for(var n,e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return(n=t.call.apply(t,[this].concat(i))||this)._animation=null,n._currentAnimation="",n._state="idle",n._owner=null,n._remainingTurns=-1,n._useFBXModel=!1,n._fbxModelPath="",n}n(a,t);var o=a.prototype;return o.initialize=function(){var t=e(i().mark((function t(n,e){var a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._blockId=n,this._gridPosition=e,this._worldPosition=this.gridToWorld(e,1),a=d(n)){t.next=7;break}return console.error("[MapObject] Unknown block ID: "+n),t.abrupt("return");case 7:return this._typeId=a.typeId,this.node.setPosition(this._worldPosition),this.initializeObjectProperties(),t.next=12,this.createVisual();case 12:this.setupCollider(new s(1,1,1),new s(0,.5,0)),this._initialized=!0,console.log("[MapObject] Initialized object "+n+" at ("+e.x+", "+e.y+")");case 15:case"end":return t.stop()}}),t,this)})));return function(n,e){return t.apply(this,arguments)}}(),o.initializeObjectProperties=function(){switch(this._typeId){case u.LAND_GOD:case u.WEALTH_GOD:case u.FORTUNE_GOD:case u.POVERTY_GOD:case u.DOG:this._state="idle",this._useFBXModel=!1;break;case u.ROADBLOCK:this._state="active",this._remainingTurns=3;break;case u.BOMB:this._state="armed",this._remainingTurns=1}},o.getElementType=function(){return"object"},o.createVisual=function(){var t=e(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this._useFBXModel||!this._fbxModelPath){t.next=5;break}return t.next=3,this.createFBXModel();case 3:t.next=7;break;case 5:return t.next=7,this.createVoxelRender(this._blockId,s.ZERO);case 7:this._renderNode&&(this._animation=this._renderNode.getComponent(r),this._animation&&this._currentAnimation&&this.playAnimation(this._currentAnimation));case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),o.createFBXModel=function(){var t=e(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:console.log("[MapObject] Loading FBX model from "+this._fbxModelPath);case 1:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),o.getData=function(){var t={blockId:this._blockId,typeId:this._typeId,position:{x:this._gridPosition.x,z:this._gridPosition.y}};return(this._currentAnimation||"idle"!==this._state||this._owner||this._remainingTurns>=0)&&(t.data={animation:this._currentAnimation||void 0,state:"idle"!==this._state?this._state:void 0,owner:this._owner||void 0,remainingTurns:this._remainingTurns>=0?this._remainingTurns:void 0}),t},o.loadData=function(){var t=e(i().mark((function t(n){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.initialize(n.blockId,new c(n.position.x,n.position.z));case 2:n.data&&(n.data.animation&&(this._currentAnimation=n.data.animation,this.playAnimation(this._currentAnimation)),n.data.state&&(this._state=n.data.state),n.data.owner&&(this._owner=n.data.owner),void 0!==n.data.remainingTurns&&(this._remainingTurns=n.data.remainingTurns));case 3:case"end":return t.stop()}}),t,this)})));return function(n){return t.apply(this,arguments)}}(),o.getState=function(){return this._state},o.setState=function(t){var n=this._state;this._state=t,console.log("[MapObject] State changed from "+n+" to "+t),this.onStateChanged(n,t)},o.onStateChanged=function(t,n){var e=this;switch(n){case"idle":this.playAnimation("idle");break;case"active":this.playAnimation("active");break;case"triggered":this.playAnimation("triggered");break;case"destroyed":this.playAnimation("destroyed"),this.scheduleOnce((function(){e.destroyObject()}),1)}},o.getOwner=function(){return this._owner},o.setOwner=function(t){this._owner=t,console.log("[MapObject] Set owner to "+t)},o.getRemainingTurns=function(){return this._remainingTurns},o.setRemainingTurns=function(t){this._remainingTurns=t,t<=0&&this.isTemporary()&&this.setState("destroyed")},o.decrementTurns=function(){return!(this._remainingTurns>0&&(this._remainingTurns--,console.log("[MapObject] Remaining turns: "+this._remainingTurns),this._remainingTurns<=0))||(this.setState("destroyed"),!1)},o.isTemporary=function(){return this._typeId===u.ROADBLOCK||this._typeId===u.BOMB},o.isNPC=function(){return this._typeId>=u.LAND_GOD&&this._typeId<=u.POVERTY_GOD},o.playAnimation=function(t){this._animation&&(this._currentAnimation=t,this._animation.clips.find((function(n){return n.name===t}))?(this._animation.play(t),console.log("[MapObject] Playing animation: "+t)):console.warn("[MapObject] Animation not found: "+t))},o.stopAnimation=function(){this._animation&&(this._animation.stop(),this._currentAnimation="",console.log("[MapObject] Animation stopped"))},o.onPlayerInteract=function(t){switch(console.log("[MapObject] Player "+t+" interacts with object at ("+this._gridPosition.x+", "+this._gridPosition.y+")"),this._typeId){case u.LAND_GOD:this.handleLandGodInteraction(t);break;case u.WEALTH_GOD:this.handleWealthGodInteraction(t);break;case u.FORTUNE_GOD:this.handleFortuneGodInteraction(t);break;case u.POVERTY_GOD:this.handlePovertyGodInteraction(t);break;case u.DOG:this.handleDogInteraction(t);break;case u.ROADBLOCK:this.handleRoadblockInteraction(t);break;case u.BOMB:this.handleBombInteraction(t)}},o.handleLandGodInteraction=function(t){console.log("[MapObject] Land God grants property discount to "+t),this.playAnimation("blessing")},o.handleWealthGodInteraction=function(t){console.log("[MapObject] Wealth God grants money to "+t),this.playAnimation("blessing")},o.handleFortuneGodInteraction=function(t){console.log("[MapObject] Fortune God grants luck to "+t),this.playAnimation("blessing")},o.handlePovertyGodInteraction=function(t){console.log("[MapObject] Poverty God curses "+t),this.playAnimation("curse")},o.handleDogInteraction=function(t){console.log("[MapObject] Dog barks at "+t),this.playAnimation("bark")},o.handleRoadblockInteraction=function(t){console.log("[MapObject] Player "+t+" is blocked by roadblock"),this.setState("triggered")},o.handleBombInteraction=function(t){var n=this;console.log("[MapObject] Bomb explodes on "+t),this.setState("triggered"),this.playAnimation("explode"),this.scheduleOnce((function(){n.setState("destroyed")}),.5)},o.getObjectInfo=function(){var t={blockId:this._blockId,typeId:this._typeId,position:{x:this._gridPosition.x,z:this._gridPosition.y},typeName:this.getTypeName(),state:this._state};return this._owner&&(t.owner=this._owner),this._remainingTurns>=0&&(t.remainingTurns=this._remainingTurns),this.isNPC()&&(t.isNPC=!0),this.isTemporary()&&(t.isTemporary=!0),t},o.getTypeName=function(){switch(this._typeId){case u.LAND_GOD:return"土地神";case u.WEALTH_GOD:return"财神";case u.FORTUNE_GOD:return"福神";case u.DOG:return"狗狗";case u.POVERTY_GOD:return"穷神";case u.ROADBLOCK:return"路障";case u.BOMB:return"炸弹";default:return"未知"}},o.destroyObject=function(){console.log("[MapObject] Destroying object at ("+this._gridPosition.x+", "+this._gridPosition.y+")"),this._animation&&(this._animation.stop(),this._animation=null),t.prototype.onDestroy.call(this),this.node&&this.node.isValid&&this.node.destroy()},a}(h))||l);a._RF.pop()}}}));

System.register("chunks:///_virtual/MapRegistry.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(t){var e,n;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){n=t.cclegacy}],execute:function(){n._RF.push({},"38c4bnW6hhB26XLFB1CpPfZ","MapRegistry",void 0);t("MapRegistry",function(){function t(t,e){this.id=void 0,this.templates=void 0,this.id=t,this.templates=e}t.loadFromFields=function(n){var s;console.log("[MapRegistry] 从 fields 加载数据",n);for(var i,l=(null==(s=n.id)?void 0:s.id)||n.id||"",r=n.templates||[],o=[],a=e(r);!(i=a()).done;){var p=i.value;try{var u=this.parseID(p);u&&o.push(u)}catch(t){console.error("[MapRegistry] Failed to parse template ID:",t)}}return console.log("[MapRegistry] 加载了 "+o.length+" 个地图模板 ID"),new t(l,o)},t.parseID=function(t){return"string"==typeof t?t:null!=t&&t.bytes?t.bytes:null!=t&&t.id?t.id:""};var n=t.prototype;return n.getTemplateIds=function(){return[].concat(this.templates)},n.hasTemplate=function(t){return this.templates.includes(t)},n.getTemplateCount=function(){return this.templates.length},n.getTemplateAt=function(t){return t>=0&&t<this.templates.length?this.templates[t]:null},n.findTemplateIndex=function(t){return this.templates.indexOf(t)},n.printAllTemplates=function(){console.log("[MapRegistry] 共 "+this.templates.length+" 个地图模板:"),this.templates.forEach((function(t,e){console.log("  ["+e+"] "+t)}))},n.debugInfo=function(){return JSON.stringify({id:this.id,templateCount:this.templates.length,templates:this.templates},null,2)},t}());n._RF.pop()}}}));

System.register("chunks:///_virtual/MapTemplate.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,n;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){n=e.cclegacy}],execute:function(){e({createMapTemplateFromJSON:function(e){var t,n,i=new Map;e.tiles&&Array.isArray(e.tiles)&&e.tiles.forEach((function(e){var t={id:BigInt(e.id),kind:e.kind,cw_next:BigInt(e.cw_next),ccw_next:BigInt(e.ccw_next),adj:e.adj?e.adj.map((function(e){return BigInt(e)})):[]};i.set(t.id,t)}));return{id:Number(e.id||0),name:e.name||"",description:e.description||"",tiles:i,player_count_range:{min:(null==(t=e.player_count_range)?void 0:t.min)||2,max:(null==(n=e.player_count_range)?void 0:n.max)||4},starting_tile:BigInt(e.starting_tile||0)}},getTileNeighbors:function(e,n){var r=e.tiles.get(n);if(!r)return[];var c=[];r.cw_next!==n&&i(e,c,r.cw_next);r.ccw_next!==n&&i(e,c,r.ccw_next);for(var a,o=t(r.adj);!(a=o()).done;){var u=a.value;u!==n&&i(e,c,u)}return c},isValidNeighbor:function(e,t,n){var i=e.tiles.get(t);return!!i&&(i.cw_next===n||(i.ccw_next===n||!!i.adj.includes(n)))}}),n._RF.push({},"dc3fbqIUBNMorsE7hJOhtyT","MapTemplate",void 0);e("TileType",function(e){return e[e.EMPTY=0]="EMPTY",e[e.PROPERTY=1]="PROPERTY",e[e.HOSPITAL=3]="HOSPITAL",e[e.LOTTERY=4]="LOTTERY",e[e.CHANCE=5]="CHANCE",e[e.NEWS=6]="NEWS",e[e.BONUS=7]="BONUS",e[e.FEE=8]="FEE",e[e.TELEPORT=9]="TELEPORT",e[e.START=10]="START",e[e.PARK=11]="PARK",e[e.GOD_LAND=12]="GOD_LAND",e[e.GOD_POOR=13]="GOD_POOR",e}({})),e("MoveDirection",function(e){return e[e.CLOCKWISE=0]="CLOCKWISE",e[e.COUNTER_CLOCKWISE=1]="COUNTER_CLOCKWISE",e[e.ADJACENT=2]="ADJACENT",e}({}));function i(e,t,n){e.tiles.has(n)&&!t.includes(n)&&t.push(n)}n._RF.pop()}}}));

System.register("chunks:///_virtual/MapTemplateConverter.ts",["cc","./constants.ts","./Web3BlockTypes.ts","./IdFormatter.ts"],(function(e){var n,i,t,l,o,s;return{setters:[function(e){n=e.cclegacy},function(e){i=e.BuildingSize,t=e.TileKind},function(e){l=e.Web3BuildingType,o=e.Web3TileType},function(e){s=e.IdFormatter}],execute:function(){function r(e,n,i){if(65535===n)return 0;var t=i.tiles_static.get(n);if(!t)return 0;var l=t.x-e.x,o=t.y-e.y;return Math.abs(o)>Math.abs(l)?o>0?0:2:l>0?1:3}function a(e){switch(e){case t.EMPTY:return o.EMPTY_LAND;case t.LOTTERY:return o.LOTTERY;case t.HOSPITAL:return o.HOSPITAL;case t.CHANCE:return o.CHANCE;case t.BONUS:return o.BONUS;case t.FEE:return o.FEE;case t.CARD:return o.CARD;case t.NEWS:return o.NEWS;default:return console.warn("[Converter] Unknown tile kind: "+e+", using EMPTY_LAND"),o.EMPTY_LAND}}function c(e){switch(e){case t.EMPTY:return"web3:empty_land";case t.LOTTERY:return"web3:lottery";case t.HOSPITAL:return"web3:hospital";case t.CHANCE:return"web3:chance";case t.BONUS:return"web3:bonus";case t.FEE:return"web3:fee";case t.CARD:return"web3:card";case t.NEWS:return"web3:news";default:return console.warn("[Converter] Unknown tile kind: "+e+", using empty_land"),"web3:empty_land"}}function u(e){return e===i.SIZE_1X1?l.BUILDING_1X1:l.BUILDING_2X2}function d(e,n){return e===i.SIZE_1X1?"web3:building_1x1":e===i.SIZE_2X2?"web3:building_2x2":(console.warn("[Converter] Unknown building size: "+e+", using 1x1"),"web3:building_1x1")}e("convertMapTemplateToSaveData",(function(e,n,i){var t=[],l=[];console.log("[MapTemplateConverter] Converting template to save data"),console.log("  Template tiles:",e.tiles_static.size,e.tiles_static),console.log("  Template buildings:",e.buildings_static.size,e.buildings_static),console.log("  Game buildings:",n.buildings.length,n.buildings),e.tiles_static.forEach((function(e,n){t.push({blockId:c(e.kind),typeId:a(e.kind),position:{x:e.x,z:e.y},data:{tileId:n,buildingId:e.building_id,special:Number(e.special),w:e.w,n:e.n,e:e.e,s:e.s}})})),e.buildings_static.forEach((function(i,t){var o=i.size,s=i.price,a=(i.chain_prev_id,i.chain_next_id,[]);e.tiles_static.forEach((function(e,n){e.building_id===t&&a.push(n)}));var c=a;0===a.length?(c=[65535,65535],console.warn("[Converter] Building "+t+" has no entrance tiles")):1===a.length?c.push(65535):a.length>2&&(c=a.slice(0,2),console.warn("[Converter] Building "+t+" has more than 2 entrance tiles"));var g={x:i.x,y:i.y},b=n.buildings[t];b||console.warn("[Converter] Building "+t+" not found in Game.buildings."),l.push({blockId:d(i.size,null==b?void 0:b.building_type),typeId:u(i.size),size:o,position:{x:g.x,z:g.y},direction:r(g,c[0],e),buildingId:t,entranceTileIds:c,owner:null==b?void 0:b.owner,level:null==b?void 0:b.level,price:Number(s)})})),console.log("[MapTemplateConverter] Conversion completed"),console.log("  Tiles:",t.length),console.log("  Buildings:",l.length);var o={mapId:i,mapName:"Chain Game "+s.shortenAddress(n.id),version:"1.0.0",createTime:Date.now(),updateTime:Date.now(),gameMode:"play",tiles:t,objects:[],buildings:l,npcs:[],decorations:[]};console.log("=".repeat(80)),console.log("[MapTemplateConverter] 转换后的 MapSaveData 对象（用于对比 publish 前）："),console.log("  完整对象:",o),console.log("  tiles 数组:",o.tiles),console.log("  buildings 数组:",o.buildings),o.tiles.length>0&&console.log("  第一个 tile:",o.tiles[0]);o.buildings&&o.buildings.length>0&&console.log("  第一个 building:",o.buildings[0]);return console.log("=".repeat(80)),o})),n._RF.push({},"83770K7X+FGGblCifE3+ZMS","MapTemplateConverter",void 0),n._RF.pop()}}}));

System.register("chunks:///_virtual/MapTemplateExporter.ts",["cc","./constants.ts"],(function(e){var i,t,n,r,o,l,a,s,p;return{setters:[function(e){i=e.cclegacy},function(e){t=e.INVALID_TILE_ID,n=e.DEFAULT_BUILDING_PRICE_1X1,r=e.DEFAULT_BUILDING_PRICE_2X2,o=e.NO_BUILDING,l=e.TileKind,a=e.DEFAULT_HOSPITAL_TURNS,s=e.DEFAULT_TILE_FEE_AMOUNT,p=e.DEFAULT_TILE_BONUS_AMOUNT}],execute:function(){function c(e){switch(e){case l.BONUS:return p;case l.FEE:return s;case l.HOSPITAL:return a;default:return 0n}}function u(e){return 1===e?n:r}e("exportGameMapToMapTemplate",(function(e,i){void 0===i&&(i="0");console.log("[MapExporter] Exporting GameMap to MapTemplate..."),function(e){var i=e.getTiles();if(!i||0===i.length)throw new Error("❌ 地图没有tiles！请先放置地块。");var n=i[0];if(!n||n.getTileId()===t)throw new Error("❌ Tiles尚未编号！\n\n导出前应先调用 calculateBuildingEntrances()，\n该函数会自动执行所有必要的计算和验证。");for(var r=e.getBuildingRegistry(),o=Array.from(r.values()),l=0,a=o;l<a.length;l++){var s=a[l];if(void 0===s.buildingId)throw new Error("❌ Building未编号！请先执行计算流程。");if(!s.entranceTileIds||0===s.entranceTileIds.length)throw new Error("❌ Building #"+s.buildingId+" 未关联入口tiles！")}console.log("[MapExporter] ✓ Prerequisites check passed")}(e);var n=new Map;e.getTiles().forEach((function(e){var i,r=e.getTileId();if(r!==t){var o=e.getGridPosition(),l=e.getTypeId();n.set(r,{x:o.x,y:o.y,kind:l,building_id:e.getBuildingId(),special:null!=(i=null==e.getSpecial?void 0:e.getSpecial())?i:c(l),w:e.getW(),n:e.getN(),e:e.getE(),s:e.getS()})}else console.warn("[MapExporter] Skipping tile without ID")})),console.log("[MapExporter] Collected "+n.size+" tiles");var r=new Map,a=e.getBuildingRegistry();a&&a.forEach((function(e,i){var t,n,l;if(void 0===e.buildingId)throw new Error("❌ Building at ("+e.position.x+", "+e.position.z+') missing buildingId!\n\n请先点击 "分配编号" 按钮（或内部会自动调用）。');var a=e.buildingId,s=e.size;r.set(a,{x:e.position.x,y:e.position.z,size:s,price:null!=(t=e.price)?t:u(s),chain_prev_id:null!=(n=e.chainPrevId)?n:o,chain_next_id:null!=(l=e.chainNextId)?l:o})}));console.log("[MapExporter] Collected "+r.size+" buildings");var s=[];n.forEach((function(e,i){e.kind===l.HOSPITAL&&s.push(i)})),console.log("[MapExporter] Found "+s.length+" hospitals"),function(e,i){if(0===e.size)throw new Error("Exported map has no tiles");for(var t=Array.from(e.keys()).sort((function(e,i){return e-i})),n=0;n<t.length;n++)if(t[n]!==n)throw new Error("Tile IDs not sequential at index "+n);if(i.size>0)for(var r=Array.from(i.keys()).sort((function(e,i){return e-i})),o=0;o<r.length;o++)if(r[o]!==o)throw new Error("Building IDs not sequential at index "+o);console.log("[MapExporter] ✓ Exported data validation passed")}(n,r);var p={id:i,tiles_static:n,buildings_static:r,hospital_ids:s};return console.log("[MapExporter] Export complete"),p})),i._RF.push({},"5169am9qDpMk4ei8wIh/9XY","MapTemplateExporter",void 0),i._RF.pop()}}}));

System.register("chunks:///_virtual/MapTile.ts",["./rollupPluginModLoBabelHelpers.js","cc","./MapElement.ts","./Web3BlockTypes.ts"],(function(t){var i,e,n,r,s,o,a,u,d,c;return{setters:[function(t){i=t.inheritsLoose,e=t.asyncToGenerator,n=t.regeneratorRuntime},function(t){r=t.cclegacy,s=t._decorator,o=t.Vec3,a=t.Vec2},function(t){u=t.MapElement},function(t){d=t.Web3TileType,c=t.getWeb3BlockByBlockId}],execute:function(){var l;r._RF.push({},"3c982V7W0FI5ac1meCO96AI","MapTile",void 0);var h=s.ccclass;t("MapTile",h("MapTile")(l=function(t){function r(){for(var i,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(i=t.call.apply(t,[this].concat(n))||this)._tileId=65535,i._buildingId=65535,i._w=65535,i._n=65535,i._e=65535,i._s=65535,i}i(r,t);var s=r.prototype;return s.initialize=function(){var t=e(n().mark((function t(i,e){var r;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._blockId=i,this._gridPosition=e,this._worldPosition=this.gridToWorld(e,0),r=c(i)){t.next=7;break}return console.error("[MapTile] Unknown block ID: "+i),t.abrupt("return");case 7:return this._typeId=r.typeId,this.node.setPosition(this._worldPosition),t.next=11,this.createVisual();case 11:this.setupCollider(new o(1,.1,1),new o(0,0,0)),this._initialized=!0;case 13:case"end":return t.stop()}}),t,this)})));return function(i,e){return t.apply(this,arguments)}}(),s.getElementType=function(){return"tile"},s.createVisual=function(){var t=e(n().mark((function t(){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.createVoxelRender(this._blockId,o.ZERO);case 2:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),s.getData=function(){return{blockId:this._blockId,typeId:this._typeId,position:{x:this._gridPosition.x,z:this._gridPosition.y},data:{tileId:this._tileId,buildingId:this._buildingId,w:this._w,n:this._n,e:this._e,s:this._s}}},s.loadData=function(){var t=e(n().mark((function t(i){var e,r,s,o,u,d;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.initialize(i.blockId,new a(i.position.x,i.position.z));case 2:void 0!==(null==(e=i.data)?void 0:e.tileId)&&(this._tileId=i.data.tileId),void 0!==(null==(r=i.data)?void 0:r.buildingId)&&(this._buildingId=i.data.buildingId),void 0!==(null==(s=i.data)?void 0:s.w)&&(this._w=i.data.w),void 0!==(null==(o=i.data)?void 0:o.n)&&(this._n=i.data.n),void 0!==(null==(u=i.data)?void 0:u.e)&&(this._e=i.data.e),void 0!==(null==(d=i.data)?void 0:d.s)&&(this._s=i.data.s);case 8:case"end":return t.stop()}}),t,this)})));return function(i){return t.apply(this,arguments)}}(),s.getTileId=function(){return this._tileId},s.setTileId=function(t){this._tileId=t},s.getBuildingId=function(){return this._buildingId},s.setBuildingId=function(t){this._buildingId=t},s.getW=function(){return this._w},s.setW=function(t){this._w=t},s.getN=function(){return this._n},s.setN=function(t){this._n=t},s.getE=function(){return this._e},s.setE=function(t){this._e=t},s.getS=function(){return this._s},s.setS=function(t){this._s=t},s.getTileInfo=function(){return{blockId:this._blockId,typeId:this._typeId,position:{x:this._gridPosition.x,z:this._gridPosition.y},typeName:this.getTypeName(),tileId:this._tileId,buildingId:this._buildingId}},s.getTypeName=function(){switch(this._typeId){case d.EMPTY_LAND:return"空地";case d.LOTTERY:return"乐透";case d.HOSPITAL:return"医院";case d.CHANCE:return"机会";case d.BONUS:return"奖励";case d.FEE:return"收费站";case d.CARD:return"卡片站";case d.NEWS:return"新闻站";default:return"未知"}},r}(u))||l);r._RF.pop()}}}));

System.register("chunks:///_virtual/MaterialFactory.ts",["./rollupPluginModLoBabelHelpers.js","cc","./index6.ts","./VoxelBlock.ts","./types.ts"],(function(e){var t,r,a,n,i,s,o,c,u;return{setters:[function(e){t=e.createForOfIteratorHelperLoose,r=e.asyncToGenerator,a=e.regeneratorRuntime},function(e){n=e.cclegacy,i=e.Material,s=e.resources,o=e.EffectAsset},null,function(e){c=e.BlockRenderType},function(e){u=e.isCross}],execute:function(){e({getGlobalMaterialFactory:function(){return h},initializeGlobalMaterialFactory:function(e){h&&h.destroy();return h=new p(e)}}),n._RF.push({},"72dac+R45VF2qqBYx5Og/Ln","MaterialFactory",void 0);var l=e("MaterialType",function(e){return e.OPAQUE="opaque",e.TRANSPARENT="transparent",e.CUTOUT="cutout",e.DOUBLE_SIDED="double_sided",e.PLANT="plant",e.EMISSIVE="emissive",e.OVERLAY="overlay",e}({})),p=e("MaterialFactory",function(){function e(e){this.textureManager=void 0,this.materialCache=new Map,this.shaderCache=new Map,this.textureManager=e}var n=e.prototype;return n.createMaterial=function(){var e=r(a().mark((function e(t){var r,n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.getMaterialCacheKey(t),!this.materialCache.has(r)){e.next=3;break}return e.abrupt("return",this.materialCache.get(r));case 3:return e.prev=3,e.next=6,this.doCreateMaterial(t);case 6:return(n=e.sent)&&this.materialCache.set(r,n),e.abrupt("return",n);case 11:return e.prev=11,e.t0=e.catch(3),console.error("[MaterialFactory] 材质创建失败: "+r,e.t0),e.abrupt("return",null);case 15:case"end":return e.stop()}}),e,this,[[3,11]])})));return function(t){return e.apply(this,arguments)}}(),n.doCreateMaterial=function(){var e=r(a().mark((function e(t){var r,n,s,o,c;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.textureManager.loadTexture(t.texture);case 2:if((r=e.sent)&&r.texture){e.next=8;break}return console.warn("[MaterialFactory] 纹理加载失败，使用后备材质: "+t.texture),e.next=7,this.createMissingMaterial();case 7:return e.abrupt("return",e.sent);case 8:return n=this.selectShaderAndTechnique(t),s=new i,e.next=12,this.loadEffectAsset(n.shader);case 12:if(o=e.sent){e.next=16;break}return console.error("[MaterialFactory] EffectAsset 加载失败: voxel/shaders/"+n.shader),e.abrupt("return",null);case 16:if(s.initialize({effectAsset:o,technique:n.technique}),e.prev=17,s.setProperty("mainTexture",r.texture),!t.overlayTexture){e.next=25;break}return e.next=22,this.textureManager.loadTexture(t.overlayTexture);case 22:(c=e.sent)&&c.texture?s.setProperty("u_OverlayTex",c.texture):(console.warn("[MaterialFactory] Overlay纹理加载失败: "+t.overlayTexture),s.setProperty("u_OverlayTex",r.texture)),this.setOverlayUniforms(s);case 25:this.setVoxelShaderUniforms(s,t),this.configureMaterial(s,t),e.next=34;break;case 29:return e.prev=29,e.t0=e.catch(17),console.error("[MaterialFactory] 材质属性设置失败:",e.t0),s.destroy(),e.abrupt("return",null);case 34:return e.abrupt("return",s);case 35:case"end":return e.stop()}}),e,this,[[17,29]])})));return function(t){return e.apply(this,arguments)}}(),n.selectShaderAndTechnique=function(t){switch(t.type){case l.OPAQUE:return{shader:e.SHADERS.VOXEL_BLOCK,technique:0};case l.CUTOUT:return{shader:e.SHADERS.VOXEL_BLOCK,technique:1};case l.TRANSPARENT:case l.DOUBLE_SIDED:return{shader:e.SHADERS.VOXEL_BLOCK,technique:2};case l.PLANT:return{shader:e.SHADERS.VOXEL_PLANT,technique:0};case l.EMISSIVE:return{shader:e.SHADERS.VOXEL_EMISSIVE,technique:0};case l.OVERLAY:return{shader:e.SHADERS.VOXEL_OVERLAY,technique:0};default:return{shader:e.SHADERS.VOXEL_BLOCK,technique:0}}},n.configureMaterial=function(e,t){var r=e.passes[0];if(r)switch(t.type){case l.OPAQUE:this.configureOpaqueMaterial(r,t);break;case l.TRANSPARENT:this.configureTransparentMaterial(r,t);break;case l.CUTOUT:this.configureCutoutMaterial(r,t);break;case l.DOUBLE_SIDED:this.configureDoubleSidedMaterial(r,t);break;case l.PLANT:this.configurePlantMaterial(r,t);break;case l.EMISSIVE:this.configureEmissiveMaterial(r,t);break;case l.OVERLAY:this.configureOverlayMaterial(r,t)}},n.setVoxelShaderUniforms=function(e,t){try{switch(e.setProperty("timer",0),e.setProperty("daylight",1),e.setProperty("fogDistance",150),e.setProperty("ortho",0),t.type){case l.CUTOUT:e.setProperty("alphaThreshold",t.alphaTest||.5);break;case l.TRANSPARENT:case l.DOUBLE_SIDED:e.setProperty("transparency",t.transparency||.8);break;case l.PLANT:e.setProperty("windStrength",t.windStrength||.1),e.setProperty("windSpeed",t.windSpeed||1),e.setProperty("alphaThreshold",t.alphaTest||.1),e.setProperty("tintColor",[1,1,1,1]),e.setProperty("plantHeight",1);break;case l.EMISSIVE:var r=t.emissiveColor||[1,.8,.3,1];e.setProperty("emissiveColor",r),e.setProperty("emissiveIntensity",t.emissiveIntensity||2),e.setProperty("flickerSpeed",t.flickerSpeed||0),e.setProperty("flickerAmount",t.flickerAmount||0),e.setProperty("bloomIntensity",1)}}catch(e){throw console.error("[MaterialFactory] 设置着色器参数失败:",e),e}},n.configureOpaqueMaterial=function(e,t){},n.configureTransparentMaterial=function(e,t){},n.configureCutoutMaterial=function(e,t){},n.configurePlantMaterial=function(e,t){},n.configureEmissiveMaterial=function(e,t){},n.configureOverlayMaterial=function(e,t){console.log("[MaterialFactory] 配置overlay材质参数")},n.setOverlayUniforms=function(e,t,r){void 0===t&&(t=[.5,1,.3,1]),void 0===r&&(r=.001),e.setProperty("u_BiomeColor",t),e.setProperty("u_Inflate",r),console.log("[MaterialFactory] 设置overlay uniform: biomeColor="+t+", inflate="+r)},n.updateAnimationUniforms=function(e,t){var r=(e.getProperty("timer")||0)+t;e.setProperty("timer",r)},n.setEnvironmentUniforms=function(e,t,r){e.setProperty("daylight",t),e.setProperty("fogDistance",r)},n.configureDoubleSidedMaterial=function(e,t){this.configureTransparentMaterial(e,t)},n.configureEmissive=function(e,t){console.log("[MaterialFactory] 发光属性配置：intensity="+t.emissiveIntensity)},n.preloadTexture=function(){var e=r(a().mark((function e(t){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.textureManager.loadTexture(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),console.warn("[MaterialFactory] Failed to preload texture: "+t,e.t0);case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}(),n.createMissingMaterial=function(){var e=r(a().mark((function e(){var t;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.warn("[MaterialFactory] 创建缺失纹理后备材质"),(t=new i).initialize({effectName:"voxel/shaders/voxel-block",technique:0}),t.passes&&0!==t.passes.length){e.next=6;break}return console.error("[MaterialFactory] 后备材质创建失败"),e.abrupt("return",null);case 6:return t.setProperty("timer",0),t.setProperty("daylight",1),t.setProperty("fogDistance",150),t.setProperty("ortho",0),e.abrupt("return",t);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),n.loadEffectAsset=function(){var e=r(a().mark((function e(t){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){s.load("voxel/shaders/"+t,o,(function(t,r){e(t?null:r)}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),n.createBlockMaterial=function(){var e=r(a().mark((function e(t,r,n){var i,s;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.textureManager.loadTexture(t);case 2:if(e.sent){e.next=5;break}return e.abrupt("return",null);case 5:return i=u(r)?l.DOUBLE_SIDED:n.renderType===c.TRANSLUCENT||n.renderType===c.CUTOUT?l.TRANSPARENT:l.OPAQUE,s={type:i,texture:t,alphaTest:i===l.CUTOUT?.5:void 0},n&&n.lightLevel,e.next=11,this.createMaterial(s);case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)})));return function(t,r,a){return e.apply(this,arguments)}}(),n.createOverlayBlockMaterial=function(){var e=r(a().mark((function e(t,r,n){var i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n=!1),i={type:l.OVERLAY,texture:t,overlayTexture:r,emissive:n,emissiveIntensity:n?1:0},e.next=4,this.createMaterial(i);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,a){return e.apply(this,arguments)}}(),n.createMaterialsBatch=function(){var e=r(a().mark((function e(t){var n,i,s=this;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Map,i=t.map(r(a().mark((function e(t){var r,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.createMaterial(t);case 2:return r=e.sent,i=s.getMaterialCacheKey(t),n.set(i,r),e.abrupt("return",{key:i,material:r});case 6:case"end":return e.stop()}}),e)})))),e.next=4,Promise.allSettled(i);case 4:return console.log("[MaterialFactory] 批量创建完成: "+t.length+" 个材质"),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),n.getMaterialCacheKey=function(e){var t;return[e.type,e.texture,e.overlayTexture||"no-overlay",(null==(t=e.alphaTest)?void 0:t.toString())||"no-alpha",e.emissive?"emissive":"no-emissive",e.doubleSided?"double-sided":"single-sided"].join("|")},n.isPlantTexture=function(e){var t=e.toLowerCase();return!!["short_grass","fern","dandelion","poppy","flower","sapling","vine","wheat","carrot","potato"].some((function(e){return t.includes(e)}))||!(!t.includes("web3:block/")||!["bomb","bonus","card","chance","dog","empty_land","fee","fortune_god","hospital","land_god","news","poverty_god","property","roadblock","wealth_god"].some((function(e){return t.includes(e)})))},n.getMaterial=function(e,t){void 0===t&&(t=l.OPAQUE);var r={type:t,texture:e},a=this.getMaterialCacheKey(r);return this.materialCache.get(a)||null},n.clearCache=function(){for(var e,r=t(this.materialCache.values());!(e=r()).done;){e.value.destroy()}this.materialCache.clear(),console.log("[MaterialFactory] 材质缓存已清理")},n.getCacheStats=function(){for(var e,r=0,a=0,n=0,i=0,s=0,o=t(this.materialCache);!(e=o()).done;){var c=e.value[0];c.includes("opaque")?r++:c.includes("transparent")?a++:c.includes("cutout")?n++:c.includes("double_sided")?i++:c.includes("overlay")&&s++}return{materials:this.materialCache.size,opaque:r,transparent:a,cutout:n,doubleSided:i,overlay:s}},n.destroy=function(){this.clearCache(),this.shaderCache.clear()},e}());p.SHADERS={VOXEL_BLOCK:"voxel-block",VOXEL_PLANT:"voxel-plant",VOXEL_EMISSIVE:"voxel-emissive",VOXEL_OVERLAY:"voxel-overlay"};var h=null;n._RF.pop()}}}));

System.register("chunks:///_virtual/MeshBuilder.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var r,o,n,t,i,s,a;return{setters:[function(e){r=e.createForOfIteratorHelperLoose},function(e){o=e.cclegacy,n=e.utils,t=e.gfx,i=e.Vec3,s=e.Vec2,a=e.Color}],execute:function(){o._RF.push({},"34e7c1bdlRPDqTOYPgZ29ld","MeshBuilder",void 0);e("MeshBuilder",function(){function e(){}return e.buildMesh=function(e,o){var n={vertices:[],indices:[],textureGroups:new Map};if(e.textures.some((function(e){return e.name.includes("overlay")||e.id.includes("overlay")}))){n.hasOverlay=!0;var t=e.textures.find((function(e){return"side"===e.key&&!e.name.includes("overlay")})),i=e.textures.find((function(e){return e.name.includes("side_overlay")}));t&&i&&(n.overlayInfo={baseSideTexture:t.rel,overlaySideTexture:i.rel})}for(var s,a=r(e.elements);!(s=a()).done;){var u=s.value;this.buildElementMesh(u,e,o,n)}o.blockRotation&&0!==o.blockRotation.y&&this.applyBlockRotation(n,o.blockRotation);for(var l,c=r(n.textureGroups);!(l=c()).done;){var d=l.value;d[0],d[1]}return n},e.buildOverlayBlockMeshes=function(e){console.log("[MeshBuilder] buildOverlayBlockMesh: 开始构建双层网格");for(var o=[],i=[],s=[],a=[],u=[],l=[],c=0,d=0,h=[{dir:"north",normal:[0,0,-1],positions:[[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5],[-.5,-.5,-.5]]},{dir:"south",normal:[0,0,1],positions:[[-.5,-.5,.5],[-.5,.5,.5],[.5,.5,.5],[.5,-.5,.5]]},{dir:"west",normal:[-1,0,0],positions:[[-.5,-.5,-.5],[-.5,.5,-.5],[-.5,.5,.5],[-.5,-.5,.5]]},{dir:"east",normal:[1,0,0],positions:[[.5,-.5,.5],[.5,.5,.5],[.5,.5,-.5],[.5,-.5,-.5]]},{dir:"up",normal:[0,1,0],positions:[[-.5,.5,-.5],[.5,.5,-.5],[.5,.5,.5],[-.5,.5,.5]]},{dir:"down",normal:[0,-1,0],positions:[[-.5,-.5,.5],[.5,-.5,.5],[.5,-.5,-.5],[-.5,-.5,-.5]]}];d<h.length;d++){for(var p,v=h[d],x=r(v.positions);!(p=x()).done;){var y=p.value;o.push.apply(o,y),i.push.apply(i,v.normal),s.push(0,0),a.push(1,1,1,1)}var f=[c,c+1,c+2,c,c+2,c+3];"up"===v.dir||"down"===v.dir?u.push.apply(u,f):(u.push.apply(u,f),l.push.apply(l,f)),c+=4}var w=n.MeshUtils.createMesh({positions:o,normals:i,uvs:s,colors:a,indices:u,primitiveMode:t.PrimitiveMode.TRIANGLE_LIST}),m=n.MeshUtils.createMesh({positions:o,normals:i,uvs:s,colors:a,indices:l,primitiveMode:t.PrimitiveMode.TRIANGLE_LIST});return console.log("[MeshBuilder] buildOverlayBlockMesh: 双层网格构建完成"),{baseMesh:w,overlayMesh:m}},e.buildElementMesh=function(e,o,n,t){for(var s,a=e.from,u=a[0],l=a[1],c=a[2],d=e.to,h=d[0],p=d[1],v=d[2],x=new i(u/16-.5,l/16-.5,c/16-.5),y=new i(h/16-.5,p/16-.5,v/16-.5),f=r(e.faces);!(s=f()).done;){var w=s.value;this.buildFaceMesh(w,x,y,o,n,t,e.shade)}},e.buildFaceMesh=function(e,r,o,n,t,i,s){var a=n.textures.find((function(r){return r.key===e.textureKey}));if(a){var u=a.rel,l=i.textureGroups.get(u);l||(l={texture:u,vertices:[],indices:[],transparent:!1},i.textureGroups.set(u,l));for(var c=this.getFaceVertices(e.dir,r,o),d=this.getFaceNormal(e.dir),h=this.calculateUV(e.uv||[0,0,16,16],e.rotation),p=this.getTintColor(e.tintindex),v=this.calculateFaceAO(e.dir,t),x=this.calculateFaceLight(e.dir,t),y=l.vertices.length,f=0;f<4;f++)l.vertices.push({position:c[f],normal:d,texCoord:h[f],color:p,ao:v[f],light:x});l.indices.push(y,y+1,y+2,y,y+2,y+3)}else console.warn("[MeshBuilder] 纹理未找到: key="+e.textureKey)},e.getFaceVertices=function(e,r,o){switch(e){case"north":return[new i(o.x,r.y,r.z),new i(r.x,r.y,r.z),new i(r.x,o.y,r.z),new i(o.x,o.y,r.z)];case"south":return[new i(r.x,r.y,o.z),new i(o.x,r.y,o.z),new i(o.x,o.y,o.z),new i(r.x,o.y,o.z)];case"west":return[new i(r.x,r.y,r.z),new i(r.x,r.y,o.z),new i(r.x,o.y,o.z),new i(r.x,o.y,r.z)];case"east":return[new i(o.x,r.y,o.z),new i(o.x,r.y,r.z),new i(o.x,o.y,r.z),new i(o.x,o.y,o.z)];case"up":return[new i(o.x,o.y,r.z),new i(r.x,o.y,r.z),new i(r.x,o.y,o.z),new i(o.x,o.y,o.z)];case"down":return[new i(r.x,r.y,o.z),new i(r.x,r.y,r.z),new i(o.x,r.y,r.z),new i(o.x,r.y,o.z)]}},e.getFaceNormal=function(e){switch(e){case"north":return new i(0,0,-1);case"south":return new i(0,0,1);case"west":return new i(-1,0,0);case"east":return new i(1,0,0);case"up":return new i(0,1,0);case"down":return new i(0,-1,0);default:return new i(0,1,0)}},e.calculateUV=function(e,r){var o=e[0]/16,n=e[1]/16,t=e[2]/16,i=e[3]/16,a=[new s(o,i),new s(t,i),new s(t,n),new s(o,n)];if(r)for(var u=Math.floor(r/90),l=0;l<u;l++)a=[a[3],a[0],a[1],a[2]];return a},e.getTintColor=function(e){return 0===e?new a(128,255,128,255):a.WHITE.clone()},e.calculateFaceAO=function(e,r){if(!r.getBlockAt)return[1,1,1,1];var o=.8+.2*Math.random();return[o,o,o,o]},e.calculateFaceLight=function(e,r){switch(e){case"up":return 1;case"down":return.5;case"north":case"south":return.8;case"west":case"east":return.6;default:return.7}},e.applyElementRotation=function(e,r,o){if(o)new i((o.origin[0]-8)/16,(o.origin[1]-8)/16,(o.origin[2]-8)/16),o.angle,Math.PI,o.axis},e.applyBlockRotation=function(e,o){if(0!==o.y)for(var n,t=o.y*Math.PI/180,i=Math.cos(t),s=Math.sin(t),a=r(e.textureGroups.values());!(n=a()).done;)for(var u,l=n.value,c=r(l.vertices);!(u=c()).done;){var d=u.value,h=d.position.x,p=d.position.z;d.position.x=h*i-p*s,d.position.z=h*s+p*i;var v=d.normal.x,x=d.normal.z;d.normal.x=v*i-x*s,d.normal.z=v*s+x*i}},e.createCCMesh=function(e){for(var o,i=[],s=[],a=[],u=[],l=[],c=0,d=r(e.textureGroups.values());!(o=d()).done;){for(var h,p=o.value,v=r(p.vertices);!(h=v()).done;){var x=h.value;i.push(x.position.x,x.position.y,x.position.z),s.push(x.normal.x,x.normal.y,x.normal.z),a.push(x.texCoord.x,x.texCoord.y),u.push(x.color.r/255,x.color.g/255,x.color.b/255,x.color.a/255)}for(var y,f=r(p.indices);!(y=f()).done;){var w=y.value;l.push(w+c)}c+=p.vertices.length}return n.MeshUtils.createMesh({positions:i,normals:s,uvs:a,colors:u,indices:l,primitiveMode:t.PrimitiveMode.TRIANGLE_LIST})},e.createCocosMesh=function(e,o){var i=e.textureGroups.get(o);if(!i||0===i.vertices.length)return console.warn("[MeshBuilder] 纹理组为空或未找到: "+o),null;for(var s,a=[],u=[],l=[],c=[],d=r(i.vertices);!(s=d()).done;){var h=s.value;a.push(h.position.x,h.position.y,h.position.z),u.push(h.normal.x,h.normal.y,h.normal.z),l.push(h.texCoord.x,h.texCoord.y);var p=h.ao||1;c.push(p,p,p,1)}return n.MeshUtils.createMesh({positions:a,normals:u,uvs:l,colors:c,indices:i.indices,primitiveMode:t.PrimitiveMode.TRIANGLE_LIST})},e}());o._RF.pop()}}}));

System.register("chunks:///_virtual/NPC.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Role.ts","./RoleTypes.ts","./constants.ts","./EventBus.ts","./EventTypes.ts"],(function(n){var t,e,i,s,o,d,r,u;return{setters:[function(n){t=n.inheritsLoose},function(n){e=n.cclegacy},function(n){i=n.Role},function(n){s=n.RoleAttribute,o=n.RoleType},function(n){d=n.NpcKind},function(n){r=n.EventBus},function(n){u=n.EventTypes}],execute:function(){e._RF.push({},"3d92dwwspVCKZYJgDpYAuxk","NPC",void 0);n("NPC",function(n){function e(){var t;return(t=n.call(this)||this)._kind=d.NONE,t._consumable=!1,t._spawnIndex=65535,t._tileId=-1,t.m_eType=o.NPC,console.log("[NPC] NPC 实例创建"),t}t(e,n);var i=e.prototype;return i.loadFromMoveNPC=function(n,t){console.log("[NPC] 从 Move NpcInst 加载数据",n),this._kind=n.kind,this._consumable=n.consumable,this._spawnIndex=n.spawn_index,void 0!==t&&(this._tileId=t),this.m_strName=this.getNPCKindName(this._kind),this.m_oId="npc_"+this._kind+"_"+this._spawnIndex+"_"+Date.now(),this.setAttr(s.HP,1),console.log("[NPC] NPC数据加载完成",{kind:this._kind,name:this.m_strName,consumable:this._consumable,spawnIndex:this._spawnIndex,tileId:this._tileId}),r.emit(u.Role.Initialized,{roleId:this.m_oId,role:this,npcKind:this._kind})},i.loadFromConfig=function(n,t){console.log("[NPC] 从配置加载数据",n),this._kind=n.kind,this._consumable=n.consumable,this._spawnIndex=n.spawnIndex,void 0!==t&&(this._tileId=t),this.m_strName=n.displayName||this.getNPCKindName(this._kind),this.m_oId="npc_"+this._kind+"_"+this._spawnIndex+"_"+Date.now(),console.log("[NPC] NPC配置加载完成")},i.getNPCKindName=function(n){switch(n){case d.BARRIER:return"路障";case d.BOMB:return"炸弹";case d.DOG:return"恶犬";case d.LAND_GOD:return"土地神";case d.WEALTH_GOD:return"财神";case d.FORTUNE_GOD:return"福神";case d.POOR_GOD:return"穷神";default:return"NPC_"+n}},i.isPlayerPlaced=function(){return 65535===this._spawnIndex},i.isBarrierType=function(){return this._kind===d.BARRIER||this._kind===d.BOMB||this._kind===d.DOG},i.isBeneficialType=function(){return this._kind===d.LAND_GOD||this._kind===d.WEALTH_GOD||this._kind===d.FORTUNE_GOD},i.isDisruptiveType=function(){return this._kind===d.POOR_GOD},i.getKind=function(){return this._kind},i.isConsumable=function(){return this._consumable},i.getSpawnIndex=function(){return this._spawnIndex},i.getTileId=function(){return this._tileId},i.setTileId=function(n){this._tileId=n,this.setCurrentTileId(n)},i.reset=function(){n.prototype.reset.call(this),this._kind=d.NONE,this._consumable=!1,this._spawnIndex=65535,this._tileId=-1,console.log("[NPC] NPC重置完成")},i.debugInfo=function(){return n.prototype.debugInfo.call(this)+", "+["Kind: "+this._kind+" ("+this.m_strName+")","Consumable: "+this._consumable,"SpawnIndex: "+this._spawnIndex,"TileId: "+this._tileId,"PlayerPlaced: "+this.isPlayerPlaced()].join(", ")},e}(i));e._RF.pop()}}}));

System.register("chunks:///_virtual/NumberTextureGenerator.ts",["cc"],(function(e){var t,r,n;return{setters:[function(e){t=e.cclegacy,r=e.ImageAsset,n=e.Texture2D}],execute:function(){t._RF.push({},"7bca3adXvNEgqR3qFo+3m5h","NumberTextureGenerator",void 0),e("NumberTextureGenerator",function(){function e(){}return e.getNumberTexture=function(e,t){var r=(null==t?void 0:t.prefix)||"",n=(null==t?void 0:t.bgColor)||"default",u=(null==t?void 0:t.customText)||"",o=u?"custom_"+u+"_"+n:""+r+e+"_"+n;if(this.cache.has(o))return this.cache.get(o);var i=this.generateTexture(e,t);return this.cache.set(o,i),i},e.generateTexture=function(e,t){var u=(null==t?void 0:t.size)||64,o=(null==t?void 0:t.fontSize)||42,i=(null==t?void 0:t.bgColor)||"rgba(255, 255, 255, 0.85)",a=(null==t?void 0:t.textColor)||"#000",c=!1!==(null==t?void 0:t.withBorder),l=(null==t?void 0:t.prefix)||"",s=(null==t?void 0:t.borderRadius)||6,d=document.createElement("canvas");d.width=u,d.height=u;var g=d.getContext("2d");g.clearRect(0,0,u,u),g.fillStyle=i,this.drawRoundRect(g,2,2,u-4,u-4,s),g.fill(),c&&(g.strokeStyle="rgba(0, 0, 0, 0.5)",g.lineWidth=2,this.drawRoundRect(g,2,2,u-4,u-4,s),g.stroke());var h=(null==t?void 0:t.customText)||(l?""+l+e:e.toString());g.fillStyle=a,g.font="bold "+o+"px Arial",g.textAlign="center",g.textBaseline="middle",g.fillText(h,u/2,u/2);var T=new r;T.reset({_data:d,width:u,height:u,format:n.PixelFormat.RGBA8888,_compressed:!1});var F=new n;return F.image=T,F},e.drawRoundRect=function(e,t,r,n,u,o){e.beginPath(),e.moveTo(t+o,r),e.lineTo(t+n-o,r),e.quadraticCurveTo(t+n,r,t+n,r+o),e.lineTo(t+n,r+u-o),e.quadraticCurveTo(t+n,r+u,t+n-o,r+u),e.lineTo(t+o,r+u),e.quadraticCurveTo(t,r+u,t,r+u-o),e.lineTo(t,r+o),e.quadraticCurveTo(t,r,t+o,r),e.closePath()},e.clearCache=function(){this.cache.forEach((function(e){e&&e.isValid&&e.destroy()})),this.cache.clear(),console.log("[NumberTextureGenerator] Cache cleared")},e.getCacheStats=function(){return{count:this.cache.size,keys:Array.from(this.cache.keys())}},e.getLetterTexture=function(e){return this.getNumberTexture(0,{size:64,fontSize:36,bgColor:"rgba(100, 200, 255, 0.85)",textColor:"#FFF",withBorder:!0,customText:e})},e.getNPCNameTexture=function(e){var t=2===e.length?22:18,r=this.getNPCTextColor(e);return this.getNumberTexture(0,{size:64,fontSize:t,bgColor:"rgba(0, 0, 0, 0)",textColor:r,withBorder:!0,borderRadius:4,customText:e})},e.getTileTypeTexture=function(e){var t=this.getTileTypeName(e),r=this.getTileTypeColor(e),n=this.getTileTypeTextColor(e),u=4===e||5===e?18:22;return this.getNumberTexture(0,{size:64,fontSize:u,bgColor:r,textColor:n,withBorder:!0,borderRadius:4,customText:t})},e.getTileTypeName=function(e){switch(e){case 0:return"空地";case 1:return"乐透";case 2:return"医院";case 3:return"机会";case 4:return"+2000";case 5:return"-2000";case 6:return"卡片";case 7:return"新闻";default:return"未知"}},e.getTileTypeColor=function(e){return"rgba(0, 0, 0, 0)"},e.getTileTypeTextColor=function(e){switch(e){case 1:return"#4A4A4A";case 2:return"#FFFFFF";case 3:return"#00E5FF";case 4:return"#2E7D32";case 5:return"#FF6F00";case 6:return"#5E35B1";case 7:return"#FFD700";default:return"#FFFFFF"}},e.getNPCTextColor=function(e){switch(e){case"路障":return"#FFD700";case"炸弹":return"#FF6F00";case"恶犬":return"#FFEB3B";case"福神":case"土地神":return"#4A4A4A";case"穷神":return"#FFD700";case"财神":return"#4A4A4A";default:return"#FFFFFF"}},e.getBuildingLabelTexture=function(e,t){var r=this.getBuildingLevelText(e),n=this.getBuildingOwnerColor(t);return this.getNumberTexture(0,{size:64,fontSize:22,bgColor:"rgba(0, 0, 0, 0)",textColor:n,withBorder:!0,borderRadius:4,customText:r})},e.getBuildingLevelText=function(e){return 0===e?"空地":e>=1&&e<=5?e+"级":"未知"},e.getBuildingOwnerColor=function(e){switch(e){case 255:return"#424242";case 0:return"#FFC107";case 1:return"#FF5252";case 2:return"#69F0AE";case 3:return"#E040FB";default:return"#FFD700"}},e}()).cache=new Map,t._RF.pop()}}}));

System.register("chunks:///_virtual/object-utils.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){r=e.cclegacy}],execute:function(){function o(e){for(var r,o={},n=t(e);!(r=n()).done;){var c=r.value;if(c&&!(c.length<2)){var u=c[0],i=c[1];o[u]=i}}return o}e("fromEntries",o),r._RF.push({},"6c79eIdmSxN3KtbgwZfVaXf","object-utils",void 0);e("ObjectUtils",{fromEntries:o});r._RF.pop()}}}));

System.register("chunks:///_virtual/OverlayTypes.ts",["cc"],(function(e){var t;return{setters:[function(e){t=e.cclegacy}],execute:function(){t._RF.push({},"f75a74LBYBGE7HymbVroQtk","OverlayTypes",void 0);e("OverlayFace",function(e){return e.UP="up",e.DOWN="down",e.NORTH="north",e.SOUTH="south",e.WEST="west",e.EAST="east",e}({}));t._RF.pop()}}}));

System.register("chunks:///_virtual/PaperActor.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ActorConfig.ts","./ActorTypes.ts"],(function(e){var t,i,n,r,a,o,s,l,c,u,h,p,d,f,m,v,g,w,b,y,x,T,A,P,I,M;return{setters:[function(e){t=e.applyDecoratedDescriptor,i=e.inheritsLoose,n=e.initializerDefineProperty,r=e.assertThisInitialized,a=e.asyncToGenerator,o=e.regeneratorRuntime},function(e){s=e.cclegacy,l=e._decorator,c=e.CCInteger,u=e.Camera,h=e.Node,p=e.SpriteFrame,d=e.Vec3,f=e.find,m=e.MeshRenderer,v=e.primitives,g=e.utils,w=e.resources,b=e.Material,y=e.tween,x=e.Component,T=e.Texture2D,A=e.Prefab,P=e.instantiate},function(e){I=e.ActorConfigManager},function(t){M=t.ActorType,e("ActorType",t.ActorType)}],execute:function(){var k,F,R,z,N,_,B,O,C,D,q,S,L,G,j,E;s._RF.push({},"5b31ciTkk1NK4ZjitlnXkrn","PaperActor",void 0);var U=l.ccclass,W=l.property;e("PaperActor",(k=U("PaperActor"),F=W({type:c,tooltip:"Actor类型 (0=NPC, 1=PLAYER, 2=BUILDING, 3=OBJECT)"}),R=W(u),z=W(h),N=W([p]),k((O=t((B=function(e){function t(){for(var t,i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return t=e.call.apply(e,[this].concat(a))||this,n(t,"actorId",O,r(t)),n(t,"level",C,r(t)),n(t,"actorType",D,r(t)),n(t,"camera",q,r(t)),n(t,"card",S,r(t)),n(t,"billboardMode",L,r(t)),n(t,"direction",G,r(t)),t.meshRenderer=null,t.quadMesh=null,t.material=null,t.currentTexture=null,n(t,"frames",j,r(t)),t.currentFrame=0,t.frameTimer=0,t.frameRange=[0,0],t.isPlayingAnimation=!1,n(t,"frameRate",E,r(t)),t.tweens=new Map,t.state="idle",t.textBubble=null,t.arrowNode=null,t.role=null,t.config=null,t._tmp=new d,t}i(t,e);var s=t.prototype;return s.onLoad=function(){if(this.node.active=!1,this.card||(this.card=this.node),!this.camera){var e=f("Main Camera")||f("Camera");e&&(this.camera=e.getComponent(u))}this.setupRenderer()},s.start=function(){},s.update=function(e){"off"!==this.billboardMode&&this.updateBillboard(),this.isPlayingAnimation&&this.frames.length>0&&this.updateFrameAnimation(e)},s.onDestroy=function(){this.stopAllTweens(),this.arrowNode&&(this.arrowNode.destroy(),this.arrowNode=null)},s.initialize=function(){var e=a(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.config=I.getConfig(this.actorId),this.applyScale(),e.next=5,this.ensureMaterialReady();case 5:if(!this.actorId){e.next=8;break}return e.next=8,this.loadTexture();case 8:if(this.actorType!==M.BUILDING||"off"!==this.billboardMode){e.next=12;break}return this.applyDirection(),e.next=12,this.loadArrowIndicator();case 12:return this.actorType!==M.NPC&&this.actorType!==M.PLAYER||this.playFrameAnimation("idle"),this.node.active=!0,e.abrupt("return",!0);case 17:return e.prev=17,e.t0=e.catch(0),console.error("[PaperActor] Failed to initialize "+this.node.name+":",e.t0),this.node.active=!0,e.abrupt("return",!1);case 22:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),s.ensureMaterialReady=function(){var e=this;return new Promise((function(t){if(e.material)t();else var i=0,n=setInterval((function(){e.material?(clearInterval(n),t()):i++>20&&(clearInterval(n),console.warn("[PaperActor] Material not ready after timeout"),t())}),100)}))},s.setupRenderer=function(){this.meshRenderer=this.card.getComponent(m),this.meshRenderer||(this.meshRenderer=this.card.addComponent(m)),this.createQuadMesh(),this.createMaterial()},s.createQuadMesh=function(){var e=I.getConfig(this.actorId),t=(null==e?void 0:e.size.width)||1,i=(null==e?void 0:e.size.height)||1,n=v.quad();if(n.positions)for(var r=n.positions,a=0;a<r.length;a+=3){var o=r[a],s=r[a+1];r[a]=o*t,r[a+1]=(s+.5)*i}this.quadMesh=g.MeshUtils.createMesh(n),this.meshRenderer&&(this.meshRenderer.mesh=this.quadMesh)},s.createMaterial=function(){var e=this;w.load("materials/paper-actor",b,(function(t,i){!t&&i?(e.material=new b,e.material.copy(i)):console.error("[PaperActor] Failed to create material!")}))},s.updateBillboard=function(){if(this.camera&&this.card){var e=this.camera.node.worldPosition,t=this.node.worldPosition;if("full"===this.billboardMode)this.card.lookAt(e);else if("yAxis"===this.billboardMode&&(d.subtract(this._tmp,e,t),this._tmp.y=0,this._tmp.lengthSqr()>.001)){this._tmp.normalize();var i=Math.atan2(this._tmp.x,this._tmp.z);this.card.setRotationFromEuler(0,180*i/Math.PI,0)}}},s.loadTexture=function(){var e=a(o().mark((function e(){var t,i=this;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getTexturePath()){e.next=4;break}return console.warn("[PaperActor] No texture path for "+this.node.name),e.abrupt("return");case 4:return e.abrupt("return",new Promise((function(e){var n=t+"/texture";w.load(n,T,(function(n,r){if(n)return console.error("[PaperActor] Failed to load texture: "+t,n),void e();i.applyTexture(r),e()}))})));case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),s.getTexturePath=function(){if(!this.actorId)return"";if(this.config&&this.config.textures){if(this.actorType===M.BUILDING&&this.config.textures.levels){var e=Math.min(this.level,this.config.textures.levels.length-1);return this.config.textures.levels[e]}if(this.config.textures.default)return this.config.textures.default}var t=this.actorId.replace("web3:","");return this.actorType===M.BUILDING?0===this.level?"web3/buildings/lv"+this.level:"web3/buildings/"+t+"_lv"+this.level:"web3/actors/"+t},s.applyTexture=function(e){var t=this;if(!this.material)return console.warn("[PaperActor] Material not ready for "+this.node.name),void this.scheduleOnce((function(){t.material&&e&&t.applyTexture(e)}),.1);try{this.material.setProperty("mainTexture",e),this.currentTexture=e,this.meshRenderer&&this.meshRenderer.setMaterial(this.material,0)}catch(e){console.warn("[PaperActor] Failed to set texture for "+this.node.name+":",e)}},s.setFrame=function(e){if(e>=0&&e<this.frames.length){var t=this.frames[e];t&&t.texture&&this.applyTexture(t.texture)}},s.jump=function(e,t){var i=this;void 0===e&&(e=.5),void 0===t&&(t=.5),this.stopTween("jump");var n=this.node.position.clone(),r=n.clone();r.y+=e;var a=y(this.node).to(.4*t,{position:r},{easing:"quadOut"}).to(.6*t,{position:n},{easing:"bounceOut"}).call((function(){i.tweens.delete("jump"),i.state="idle"})).start();this.tweens.set("jump",a),this.state="jumping"},s.say=function(e,t){var i=this;void 0===t&&(t=2),this.stopTween("say");var n=y(this.card).to(.1,{scale:new d(1.1,1.2,1)},{easing:"backOut"}).to(.2,{scale:d.ONE},{easing:"elasticOut"}).call((function(){i.tweens.delete("say")})).start();this.tweens.set("say",n),this.state="talking",e&&this.showTextBubble(e,t)},s.moveTo=function(e,t){var i=this;this.stopTween("move"),this.state="moving",this.playFrameAnimation("walk");var n=y(this.node).to(t,{position:e},{easing:"linear",onUpdate:function(){}}).call((function(){i.state="idle",i.playFrameAnimation("idle"),i.tweens.delete("move")})).start();this.tweens.set("move",n)},s.moveToTile=function(){var e=a(o().mark((function e(t){var i,n,r;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.targetPosition,r=null!=(i=t.playerIndex)?i:0,n){e.next=5;break}return console.warn("[PaperActor] No targetPosition in params"),e.abrupt("return");case 5:e.t0=r%4,e.next=0===e.t0?8:1===e.t0?11:2===e.t0?14:3===e.t0?17:20;break;case 8:return e.next=10,this._moveWithHop(n);case 10:return e.abrupt("break",20);case 11:return e.next=13,this._moveWithBounce(n);case 13:return e.abrupt("break",20);case 14:return e.next=16,this._moveWithDash(n);case 16:return e.abrupt("break",20);case 17:return e.next=19,this._moveWithGlide(n);case 19:return e.abrupt("break",20);case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),s._moveWithHop=function(e){var t=this;return new Promise((function(i){t.stopTween("move"),t.state="moving",t.playFrameAnimation("walk");var n=t.node.position.clone().clone().add(e).multiplyScalar(.5);n.y+=.3,y(t.node).to(.2,{position:n},{easing:"quadOut"}).to(.2,{position:e},{easing:"quadIn"}).call((function(){t.state="idle",t.playFrameAnimation("idle"),i()})).start()}))},s._moveWithBounce=function(e){var t=this;return new Promise((function(i){t.stopTween("move"),t.state="moving",t.playFrameAnimation("walk");var n=t.node.position.clone().clone().add(e).multiplyScalar(.5);n.y+=.5,y(t.node).to(.3,{position:n},{easing:"backOut"}).to(.3,{position:e},{easing:"bounceOut"}).call((function(){t.state="idle",t.playFrameAnimation("idle"),i()})).start()}))},s._moveWithDash=function(e){var t=this;return new Promise((function(i){t.stopTween("move"),t.state="moving",t.playFrameAnimation("walk");var n=t.node.position.clone().clone().add(e).multiplyScalar(.5);n.y+=.2,y(t.node).to(.15,{position:n},{easing:"quadIn"}).to(.2,{position:e},{easing:"quadOut"}).call((function(){t.state="idle",t.playFrameAnimation("idle"),i()})).start()}))},s._moveWithGlide=function(e){var t=this;return new Promise((function(i){t.stopTween("move"),t.state="moving",t.playFrameAnimation("walk");var n=t.node.position.clone().clone().add(e).multiplyScalar(.5);n.y+=.3,y(t.node).to(.25,{position:n},{easing:"sineOut"}).to(.25,{position:e},{easing:"sineIn"}).call((function(){t.state="idle",t.playFrameAnimation("idle"),i()})).start()}))},s.upgrade=function(e){var t=this;this.stopTween("upgrade");var i=y(this.card).to(.3,{scale:new d(.8,.8,.8)},{easing:"quadIn"}).call((function(){t.level=e,t.loadTexture()})).to(.5,{scale:new d(1.2,1.2,1.2),eulerAngles:new d(0,360,0)},{easing:"backOut"}).to(.2,{scale:d.ONE},{easing:"quadOut"}).call((function(){t.tweens.delete("upgrade")})).start();this.tweens.set("upgrade",i)},s.shake=function(e,t){var i=this;void 0===e&&(e=.1),void 0===t&&(t=.3),this.stopTween("shake");for(var n=this.node.position.clone(),r=Math.floor(t/.05),a=y(this.node),o=0;o<r;o++){var s=(Math.random()-.5)*e*2,l=(Math.random()-.5)*e*2,c=n.clone();c.x+=s,c.z+=l,a=a.to(.05,{position:c})}a.to(.05,{position:n}).call((function(){i.tweens.delete("shake")})).start(),this.tweens.set("shake",a)},s.disappear=function(){var e=this;this.stopAllTweens(),y(this.card).to(.3,{scale:new d(1.2,0,1.2),eulerAngles:new d(0,720,0)},{easing:"quadIn"}).call((function(){e.node.destroy()})).start()},s.float=function(e,t){void 0===e&&(e=.2),void 0===t&&(t=2),this.stopTween("float");var i=this.node.position.y,n=y(this.node).repeatForever(y().to(t/2,{position:new d(this.node.position.x,i+e,this.node.position.z)},{easing:"sineInOut"}).to(t/2,{position:new d(this.node.position.x,i,this.node.position.z)},{easing:"sineInOut"})).start();this.tweens.set("float",n)},s.playFrameAnimation=function(e){switch(e){case"idle":this.frameRange=[0,Math.min(1,this.frames.length-1)];break;case"walk":this.frameRange=[2,Math.min(5,this.frames.length-1)];break;case"jump":this.frameRange=[6,Math.min(7,this.frames.length-1)];break;default:this.frameRange=[0,0]}this.currentFrame=this.frameRange[0],this.frameTimer=0,this.isPlayingAnimation=!0,this.setFrame(this.currentFrame)},s.stopFrameAnimation=function(){this.isPlayingAnimation=!1},s.updateFrameAnimation=function(e){if(0!==this.frames.length){this.frameTimer+=e;var t=1/this.frameRate;this.frameTimer>=t&&(this.frameTimer-=t,this.currentFrame++,this.currentFrame>this.frameRange[1]&&(this.currentFrame=this.frameRange[0]),this.setFrame(this.currentFrame))}},s.showTextBubble=function(e,t){var i=this;console.log("["+this.actorId+"]: "+e),this.scheduleOnce((function(){i.hideTextBubble()}),t)},s.hideTextBubble=function(){this.textBubble&&(this.textBubble.active=!1)},s.stopTween=function(e){var t=this.tweens.get(e);t&&(t.stop(),this.tweens.delete(e))},s.stopAllTweens=function(){this.tweens.forEach((function(e){return e.stop()})),this.tweens.clear()},s.setActorInfo=function(e,t,i){void 0===i&&(i=1),this.actorId=e,this.actorType=t,this.level=i},s.setDirection=function(e){this.direction=Math.floor(e)%4,this.direction<0&&(this.direction+=4),this.actorType===M.BUILDING&&"off"===this.billboardMode&&this.applyDirection()},s.applyScale=function(){if(this.config&&this.config.size.scale){var e=this.config.size.scale;this.node.setScale(e,e,e)}},s.applyDirection=function(){var e=90*this.direction,t=this.node.eulerAngles;this.node.setRotationFromEuler(t.x,e,t.z)},s.loadArrowIndicator=function(){var e=a(o().mark((function e(){var t=this;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.actorType===M.BUILDING){e.next=2;break}return e.abrupt("return");case 2:return e.abrupt("return",new Promise((function(e){w.load("prefabs/arrow",A,(function(i,n){if(i)return console.warn("[PaperActor] Failed to load arrow prefab:",i),void e();t.arrowNode=P(n),t.arrowNode.parent=t.node,t.arrowNode.setPosition(0,0,0),t.arrowNode.setScale(.4,.4,.4),e()}))})));case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),s.getState=function(){return this.state},s.setRole=function(e){this.role=e},s.getRole=function(){return this.role},s.hasRole=function(){return null!==this.role},t}(x)).prototype,"actorId",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),C=t(B.prototype,"level",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),D=t(B.prototype,"actorType",[F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M.NPC}}),q=t(B.prototype,"camera",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S=t(B.prototype,"card",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L=t(B.prototype,"billboardMode",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"yAxis"}}),G=t(B.prototype,"direction",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),j=t(B.prototype,"frames",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),E=t(B.prototype,"frameRate",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),_=B))||_));s._RF.pop()}}}));

System.register("chunks:///_virtual/PaperActorFactory.ts",["./rollupPluginModLoBabelHelpers.js","cc","./PaperActor.ts","./ActorConfig.ts","./Web3BlockTypes.ts","./ActorTypes.ts"],(function(e){var r,o,t,n,a,c,i,l,s,u,d,p;return{setters:[function(e){r=e.createForOfIteratorHelperLoose,o=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){n=e.cclegacy,a=e.Node,c=e.find,i=e.Camera,l=e.Vec3},function(e){s=e.PaperActor},function(e){u=e.ActorConfigManager},function(e){d=e.getWeb3BlockByBlockId},function(e){p=e.ActorType}],execute:function(){n._RF.push({},"ca2b9kEFptCD7stfSHCb3Dy","PaperActorFactory",void 0);e("PaperActorFactory",function(){function e(){}return e.createActor=function(e,r){var o=u.getConfig(e);return o?o.type===p.BUILDING?this.createBuilding(e,o.defaultLevel||0,r):this.createNPC(e,r):(console.error("[PaperActorFactory] Config not found for: "+e),null)},e.createNPC=function(e,r){var o=this,t=u.getConfig(e);if(!t)return console.error("[PaperActorFactory] NPC config not found: "+e),null;var n=new a("NPC_"+e.replace("web3:","")),c=n.addComponent(s);return c.setActorInfo(e,t.type,1),t.billboardMode&&(c.billboardMode=t.billboardMode),n.setPosition(r),t.size.scale&&n.setScale(t.size.scale,t.size.scale,t.size.scale),this.setupCamera(c),c.initialize().then((function(){o.startInitialAnimations(c,t)})),console.log("[PaperActorFactory] Created NPC: "+e+" at",r),n},e.getBuildingActorIdFromBuilding=function(e){return{"web3:building_1x1":"web3:building_1x1","web3:building_2x2":"web3:building_2x2","web3:temple":"web3:temple","web3:research":"web3:research","web3:oil_company":"web3:oil_company","web3:commercial":"web3:commercial","web3:hotel":"web3:hotel","web3:property_small":"web3:property_small"}[e]||e},e.createBuilding=function(e,r,o){var t=this.getBuildingActorIdFromBuilding(e),n=u.getConfig(t);if(!n)return console.error("[PaperActorFactory] Building config not found: "+t+" (from "+e+")"),null;var c=new a("Building_"+e.replace("web3:","")),i=c.addComponent(s);i.setActorInfo(t,p.BUILDING,r),i.billboardMode=n.billboardMode||"off",c.setPosition(o);return c.setScale(1,1,1),this.setupCamera(i),i.initialize(),c},e.createPlayer=function(e,r){var o=new a("Player_"+e),t=o.addComponent(s);return t.setActorInfo("web3:player_"+e,p.PLAYER,1),t.billboardMode="yAxis",o.setPosition(r),this.setupCamera(t),t.initialize(),console.log("[PaperActorFactory] Created Player: "+e+" at",r),o},e.createFromBlockType=function(e,r){return d(e)||console.warn("[PaperActorFactory] Block not found in Web3BlockTypes: "+e),this.createActor(e,r)},e.createMultiple=function(e){for(var o,t=[],n=r(e);!(o=n()).done;){var a=o.value,c=this.createActor(a.actorId,a.position);c&&t.push(c)}return t},e.upgradeBuilding=function(e,r){var o=e.getComponent(s);if(!o)return console.error("[PaperActorFactory] No PaperActor component found"),!1;var t=u.getMaxLevel(o.actorId);return r>t?(console.warn("[PaperActorFactory] Level "+r+" exceeds max level "+t),!1):(o.upgrade(r),console.log("[PaperActorFactory] Upgraded building "+o.actorId+" to level "+r),!0)},e.setupCamera=function(e){if(!e.camera){var r=c("Main Camera")||c("Camera")||c("Canvas/Camera");if(r){var o=r.getComponent(i);o&&(e.camera=o)}}},e.startInitialAnimations=function(e,r){r.animations.canFloat?e.float(.2,2):r.type===p.NPC&&e.playFrameAnimation("idle"),r.id.includes("deco_")&&r.animations.canShake},e.createAndAddTo=function(e,r,o){var t=this.createActor(e,r);return t&&(t.parent=o),t},e.preloadActorResources=function(){var e=o(t().mark((function e(r){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("[PaperActorFactory] Preloading resources for:",r);case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e.getSuggestedPosition=function(e,r,o){var t=new l(e,0,r);switch(o){case p.NPC:case p.PLAYER:t.y=.5;break;case p.BUILDING:t.y=0;break;case p.OBJECT:t.y=.3}return t},e}());n._RF.pop()}}}));

System.register("chunks:///_virtual/PathCalculator.ts",["cc","./WalkingPreference.ts","./RotorRouter.ts","./RightHandRule.ts"],(function(t){var e,r,o,a,s,i;return{setters:[function(t){e=t.cclegacy},function(t){r=t.WalkingPreference,o=t.createRotorRouterHistory,a=t.INVALID_TILE_ID},function(t){s=t.RotorRouter},function(t){i=t.RightHandRule}],execute:function(){t("createPathCalculator",(function(t,e){return new n(t,e)})),e._RF.push({},"40182eZIg5GwZN7NQmwsIXF","PathCalculator",void 0);var n=t("PathCalculator",function(){function t(t,e){this.template=void 0,this.rotorRouter=void 0,this.rightHandRule=void 0,this.rotorHistory=void 0,this.template=t,this.rotorHistory=e||o(),this.rotorRouter=new s(t,this.rotorHistory),this.rightHandRule=new i(t)}var e=t.prototype;return e.calculatePath=function(t){var e,o=t.startTile,i=t.steps,n=t.preference,l=t.lastTile,u=void 0===l?a:l,c=t.rotorHistory;if(i<=0)return{path:[],success:!1,actualSteps:0,error:"Invalid steps: must be > 0"};if(!this.template.tiles_static.has(o))return{path:[],success:!1,actualSteps:0,error:"Start tile "+o+" not found in template"};switch(c&&(this.rotorHistory=c,this.rotorRouter=new s(this.template,this.rotorHistory)),n){case r.ROTOR_ROUTER:e=this.rotorRouter.calculatePath(o,i,u);break;case r.RIGHT_HAND_RULE:e=this.rightHandRule.calculatePath(o,i,u);break;default:return{path:[],success:!1,actualSteps:0,error:"Unknown walking preference: "+n}}var h=e.length,p=h===i;return!p&&h>0?console.warn("[PathCalculator] Path incomplete: expected "+i+" steps, got "+h+" (回溯后仍不足)"):0===h&&console.error("[PathCalculator] No valid path found from tile "+o),{path:e,success:p,actualSteps:h,error:p?void 0:h>0?"Path incomplete: "+h+"/"+i+" steps":"No valid path found"}},e.quickCalculate=function(t,e,r,o){return this.calculatePath({startTile:t,steps:e,preference:r,lastTile:o}).path},e.getRotorHistory=function(){return this.rotorHistory},e.setRotorHistory=function(t){this.rotorHistory=t,this.rotorRouter=new s(this.template,this.rotorHistory)},e.resetRotorHistory=function(){this.rotorRouter.resetHistory()},e.validatePath=function(t,e){if(0===e.length)return!0;for(var r=t,o=0;o<e.length;o++){var a=e[o],s=this.template.tiles_static.get(r);if(!s)return console.error("[PathCalculator] Tile "+r+" not found"),!1;if(!(s.w===a||s.n===a||s.e===a||s.s===a))return console.error("[PathCalculator] Invalid path at step "+o+": "+r+" -> "+a+" (not neighbors)"),!1;r=a}return!0},e.debugPath=function(t,e){console.log("[PathCalculator] Path Details:",{start:t,steps:e.length,tiles:[t].concat(e),valid:this.validatePath(t,e)});for(var r=t,o=0;o<e.length;o++){var a=e[o],s=this.template.tiles_static.get(r);if(s){var i="?";s.w===a?i="W":s.n===a?i="N":s.e===a?i="E":s.s===a&&(i="S"),console.log("  Step "+o+": "+r+" -> "+a+" ("+i+")")}r=a}},e.debugRotorHistory=function(){this.rotorRouter.debugHistory()},t}());e._RF.pop()}}}));

System.register("chunks:///_virtual/PathChoiceGenerator.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,o;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){o=e.cclegacy}],execute:function(){o._RF.push({},"38712tusy5ORaPL1jBjzhUS","PathChoiceGenerator",void 0);e("PathChoiceGenerator",function(){function e(e){this.graph=void 0,this.graph=e}var o=e.prototype;return o.generateChoices=function(e){if(e.length<2)return{forkChoices:[],completePath:e,choiceDetails:[]};for(var t=[],o=[],r=0;r<e.length-1;r++){var n=e[r],i=e[r+1],c=this.graph.getNeighbors(n);this.hasFork(n,c)&&(t.push(i),o.push({atTile:n,choice:i,stepIndex:r}))}return{forkChoices:t,completePath:e,choiceDetails:o}},o.hasFork=function(e,t){return t.length>1},o.validateChoices=function(e,t,o){for(var r=e,n=0,i=0;n<o&&i<t.length;){var c=this.graph.getNeighbors(r);if(0===c.length)return!1;var h=void 0;if(this.hasFork(r,c)){if(i>=t.length)return!1;if(h=t[i],i++,!c.includes(h))return!1}else h=c[0];r=h,n++}return!0},o.reconstructPath=function(e,t,o){for(var r=[e],n=e,i=0,c=0;c<o;c++){var h=this.graph.getNeighbors(n);if(0===h.length)return null;var s=void 0;if(this.hasFork(n,h)){if(i>=t.length)return null;if(s=t[i],i++,!h.includes(s))return null}else s=this.getDefaultNext(n,h);r.push(s),n=s}return r},o.getDefaultNext=function(e,t){var o=this.graph.getNode(e);return o?t.includes(o.tileInfo.cw_next)?o.tileInfo.cw_next:t.includes(o.tileInfo.ccw_next)?o.tileInfo.ccw_next:t[0]:t[0]},o.debugPrintChoices=function(e){console.log("[PathChoiceGenerator] Path choice result:"),console.log("  Complete path: ["+e.completePath.join(" -> ")+"]"),console.log("  Fork choices: ["+e.forkChoices.join(", ")+"]"),console.log("  Choice details:");for(var o,r=t(e.choiceDetails);!(o=r()).done;){var n=o.value;console.log("    At tile "+n.atTile+" (step "+n.stepIndex+"): choose "+n.choice)}},e}());o._RF.pop()}}}));

System.register("chunks:///_virtual/PathfindingTest.ts",["./rollupPluginModLoBabelHelpers.js","cc","./MapTemplate.ts","./MapGraph.ts","./BFSPathfinder.ts","./PathChoiceGenerator.ts"],(function(t){var e,o,n,s,i,a;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){o=t.cclegacy},function(t){n=t.createMapTemplateFromJSON},function(t){s=t.MapGraph},function(t){i=t.BFSPathfinder},function(t){a=t.PathChoiceGenerator}],execute:function(){t("runPathfindingTests",(function(){var t=new l;t.runAllTests(),t.demonstrateFullFlow()})),o._RF.push({},"dba4dMhnhlBIZ1BVH5ARXHc","PathfindingTest",void 0);var l=t("PathfindingTest",function(){function t(){this.template=void 0,this.graph=void 0,this.pathfinder=void 0,this.generator=void 0,this.template=function(){for(var t={id:"1",name:"Test Map",description:"Test map for pathfinding",starting_tile:"0",player_count_range:{min:2,max:4},tiles:[]},e=0;e<20;e++)t.tiles.push({id:e.toString(),kind:0===e?10:1,cw_next:((e+1)%20).toString(),ccw_next:((e-1+20)%20).toString(),adj:[]});return t.tiles[0].adj=["10"],t.tiles[10].adj=["0"],t.tiles[5].adj=["15"],t.tiles[15].adj=["5"],t.tiles[7].adj=["13"],n(t)}(),this.graph=new s(this.template),this.pathfinder=new i(this.graph),this.generator=new a(this.graph)}var o=t.prototype;return o.runAllTests=function(){console.log("[PathfindingTest] Starting tests...\n"),this.testGraphConstruction(),this.testBasicBFS(),this.testShortcuts(),this.testPathGeneration(),this.testPathValidation(),this.testTileZeroHandling(),console.log("\n[PathfindingTest] All tests completed!")},o.testGraphConstruction=function(){console.log("Test 1: Graph Construction"),console.assert(20===this.graph.size,"Graph should have 20 nodes");var t=this.graph.getNeighbors(BigInt(0));console.assert(t.includes(BigInt(1)),"Node 0 should connect to node 1 (cw)"),console.assert(t.includes(BigInt(19)),"Node 0 should connect to node 19 (ccw)"),console.assert(t.includes(BigInt(10)),"Node 0 should connect to node 10 (adj)"),console.log("  ✓ Graph construction successful")},o.testBasicBFS=function(){console.log("Test 2: Basic BFS");var t=this.pathfinder.getTilesAtExactDistance(BigInt(0),1);console.assert(3===t.length,"From node 0, 3 nodes reachable in 1 step"),console.assert(t.includes(BigInt(1)),"Node 1 reachable"),console.assert(t.includes(BigInt(19)),"Node 19 reachable"),console.assert(t.includes(BigInt(10)),"Node 10 reachable via shortcut");var e=this.pathfinder.getTilesAtExactDistance(BigInt(0),2);console.assert(e.includes(BigInt(2)),"Node 2 reachable in 2 steps"),console.assert(e.includes(BigInt(18)),"Node 18 reachable in 2 steps"),console.assert(e.includes(BigInt(11)),"Node 11 reachable in 2 steps via shortcut"),console.log("  ✓ Basic BFS working correctly")},o.testShortcuts=function(){console.log("Test 3: Shortcut Paths");var t=this.pathfinder.findPath(BigInt(0),BigInt(11),5);console.assert(null!==t,"Should find path from 0 to 11"),console.assert(2===t.distance,"Distance should be 2 via shortcut"),console.assert(3===t.path.length,"Path should have 3 nodes"),console.assert(t.path[1]===BigInt(10),"Path should go through node 10");var e=this.pathfinder.findPath(BigInt(7),BigInt(13),3);console.assert(null!==e,"Should find path from 7 to 13"),console.assert(1===e.distance,"Distance should be 1 via direct connection");var o=this.pathfinder.findPath(BigInt(13),BigInt(7),3);console.assert(null===o||o.distance>1,"Reverse path should be longer"),console.log("  ✓ Shortcut paths working correctly")},o.testPathGeneration=function(){console.log("Test 4: Path Choice Generation");var t=[BigInt(0),BigInt(1),BigInt(2),BigInt(3)],e=this.generator.generateChoices(t);console.log("  Simple path choices: ["+e.forkChoices.join(", ")+"]");var o=[BigInt(0),BigInt(10),BigInt(11)],n=this.generator.generateChoices(o);console.log("  Fork path choices: ["+n.forkChoices.join(", ")+"]"),console.assert(n.forkChoices.includes(BigInt(10)),"Should record choice at fork"),console.log("  ✓ Path choice generation working")},o.testPathValidation=function(){console.log("Test 5: Path Validation");var t=[BigInt(10),BigInt(11)],e=this.generator.validateChoices(BigInt(0),t,3);console.assert(e,"Valid path should pass validation");var o=[BigInt(5)],n=this.generator.validateChoices(BigInt(0),o,2);console.assert(!n,"Invalid path should fail validation"),console.log("  ✓ Path validation working correctly")},o.testTileZeroHandling=function(){console.log("Test 6: Tile 0 Handling (Bug Fix Verification)");var t=this.graph.getNeighbors(BigInt(19));console.assert(t.includes(BigInt(0)),"Tile 19 should have tile 0 as cw neighbor"),console.assert(t.includes(BigInt(18)),"Tile 19 should have tile 18 as ccw neighbor"),console.log("  Neighbors of tile 19: ["+t.join(", ")+"]");var e=this.pathfinder.findPath(BigInt(19),BigInt(0),3);console.assert(null!==e,"Should find path from 19 to 0"),console.assert(1===e.distance,"Distance from 19 to 0 should be 1"),console.assert(2===e.path.length,"Path should have 2 nodes (19 and 0)"),console.assert(e.path[1]===BigInt(0),"Path should end at tile 0");var o=this.pathfinder.findPath(BigInt(18),BigInt(0),3);console.assert(null!==o,"Should find path from 18 to 0"),console.assert(2===o.distance,"Distance from 18 to 0 should be 2"),console.log("  Path from 18 to 0: ["+o.path.join(" -> ")+"]");var n=this.generator.hasFork(BigInt(19),t);console.assert(n===t.length>1,"hasFork should be based on neighbor count");var s=this.generator.getDefaultNext(BigInt(19),t);console.assert(s===BigInt(0),"Default next from tile 19 should be tile 0 (cw priority)"),console.log("  ✓ Tile 0 handling working correctly (bug fixed!)")},o.demonstrateFullFlow=function(){console.log("\n[PathfindingTest] Demonstrating full pathfinding flow:");var t=BigInt(0),o=BigInt(15);console.log("\n1. Finding path from "+t+" to "+o+" in 6 steps");var n=this.pathfinder.findPath(t,o,6);if(n){console.log("  Found path with distance "+n.distance+":"),console.log("  Path: ["+n.path.join(" -> ")+"]");var s=this.generator.generateChoices(n.path);console.log("\n2. Generated choice sequence:"),console.log("  Fork choices: ["+s.forkChoices.join(", ")+"]"),console.log("\n3. Choice details:");for(var i,a=e(s.choiceDetails);!(i=a()).done;){var l=i.value;console.log("  At tile "+l.atTile+": choose "+l.choice)}var r=this.generator.validateChoices(t,s.forkChoices,6);console.log("\n4. Validation result: "+(r?"✓ Valid":"✗ Invalid"))}else console.log("  No path found!")},t}());o._RF.pop()}}}));

System.register("chunks:///_virtual/Player.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Role.ts","./RoleTypes.ts","./constants.ts","./EventBus.ts","./EventTypes.ts","./IdFormatter.ts","./Card2.ts","./Blackboard.ts"],(function(t){var e,n,s,i,r,a,o,l,u,d,h,c,f;return{setters:[function(t){e=t.inheritsLoose,n=t.extends},function(t){s=t.cclegacy},function(t){i=t.Role},function(t){r=t.RoleAttribute,a=t.RoleState,o=t.RoleType},function(t){l=t.INVALID_TILE_ID},function(t){u=t.EventBus},function(t){d=t.EventTypes},function(t){h=t.IdFormatter},function(t){c=t.Card},function(t){f=t.Blackboard}],execute:function(){s._RF.push({},"120427M+uJLo5/aXT/NdXvR","Player",void 0);t("Player",function(t){function s(){var e;return(e=t.call(this)||this)._owner="",e._playerIndex=0,e._pos=0,e._cash=BigInt(0),e._bankrupt=!1,e._inHospitalTurns=0,e._lastTileId=l,e._nextTileId=l,e._templeLevels=[],e._buffs=[],e._cards=[],e.m_eType=o.PLAYER,console.log("[Player] Player 实例创建"),e}e(s,t);var i=s.prototype;return i.loadFromMovePlayer=function(t,e){console.log("[Player] 从 Move Player 加载数据",t),this._owner=t.owner,this._playerIndex=e,this.m_oId="player_"+e+"_"+h.shortenAddress(t.owner),this.m_strName="玩家 "+(e+1),this._pos=t.pos,this._cash=t.cash,this._bankrupt=t.bankrupt,this._inHospitalTurns=t.in_hospital_turns,this._lastTileId=t.last_tile_id,this._nextTileId=t.next_tile_id,this._templeLevels=[].concat(t.temple_levels),this.loadBuffs(t.buffs),this.loadCards(t.cards),this.setAttr(r.MONEY,Number(t.cash)),this.setAttr(r.POSITION,t.pos),this.setAttr(r.BANKRUPT,t.bankrupt?1:0),this.setCurrentTileId(t.pos),this._bankrupt?this.setState(a.BANKRUPT):this.setState(a.IDLE),console.log("[Player] 玩家数据加载完成",{owner:this._owner,index:this._playerIndex,pos:this._pos,cash:this._cash.toString(),bankrupt:this._bankrupt,buffsCount:this._buffs.length,cardsCount:this._cards.length}),u.emit(d.Role.Initialized,{roleId:this.m_oId,role:this,playerIndex:this._playerIndex})},i.loadBuffs=function(t){this._buffs=t.map((function(t){return{kind:t.kind,last_active_round:t.last_active_round,value:t.value,spawn_index:t.spawn_index}})),console.log("[Player] 加载 "+this._buffs.length+" 个 Buff")},i.loadCards=function(t){this._cards=t.map((function(t){return c.fromEntry(t.kind,t.count)})),console.log("[Player] 加载 "+this._cards.length+" 种卡牌")},i.hasActiveBuff=function(t,e){return this._buffs.some((function(n){return n.kind===t&&e<=n.last_active_round}))},i.getBuff=function(t){return this._buffs.find((function(e){return e.kind===t}))||null},i.getAllBuffs=function(){return[].concat(this._buffs)},i.hasAnyActiveBuff=function(t){return this._buffs.some((function(e){return t<=e.last_active_round}))},i.addBuff=function(t){var e=this._buffs.findIndex((function(e){return e.kind===t.kind}));e>=0?(this._buffs[e]=n({},t),console.log("[Player] 更新Buff: kind="+t.kind+", last_active_round="+t.last_active_round)):(this._buffs.push(n({},t)),console.log("[Player] 添加Buff: kind="+t.kind+", last_active_round="+t.last_active_round)),u.emit(d.Player.BuffAdded,{playerId:this.m_oId,playerIndex:this._playerIndex,buff:t})},i.removeBuff=function(t){var e=this._buffs.findIndex((function(e){return e.kind===t}));if(e>=0){var n=this._buffs[e];return this._buffs.splice(e,1),console.log("[Player] 删除Buff: kind="+t),u.emit(d.Player.BuffRemoved,{playerId:this.m_oId,playerIndex:this._playerIndex,buffKind:t,removedBuff:n}),!0}return console.warn("[Player] Buff不存在: kind="+t),!1},i.updateBuffs=function(t){this._buffs=t.map((function(t){return n({},t)})),console.log("[Player] 批量更新Buffs: count="+t.length),u.emit(d.Player.BuffsUpdated,{playerId:this.m_oId,playerIndex:this._playerIndex,buffs:this._buffs})},i.getCardCount=function(t){var e=this._cards.find((function(e){return e.kind===t}));return e?e.count:0},i.getAllCards=function(){return[].concat(this._cards)},i.hasCard=function(t){return this.getCardCount(t)>0},i.getTotalCardCount=function(){return this._cards.reduce((function(t,e){return t+e.count}),0)},i.addCard=function(t,e){var n=this._cards.findIndex((function(e){return e.kind===t}));if(n>=0){var s=this._cards[n].count;this._cards[n]=c.fromEntry(t,s+e)}else this._cards.push(c.fromEntry(t,e));console.log("[Player] 添加卡牌: kind="+t+", count="+e),u.emit(d.Player.CardChange,{playerId:this.m_oId,cardKind:t,count:e,totalCount:this.getTotalCardCount()})},i.removeCard=function(t,e){void 0===e&&(e=1);var n,s=this._cards.findIndex((function(e){return e.kind===t}));if(s<0||this._cards[s].count<e)return console.warn("[Player] 卡牌不足: kind="+t+", have="+((null==(n=this._cards[s])?void 0:n.count)||0)+", need="+e),!1;var i=this._cards[s].count-e;return 0===i?this._cards.splice(s,1):this._cards[s]=c.fromEntry(t,i),console.log("[Player] 删除卡牌: kind="+t+", count="+e+", remaining="+i),u.emit(d.Player.CardRemoved,{playerId:this.m_oId,playerIndex:this._playerIndex,cardKind:t,count:e,remainingCount:i}),!0},i.isInHospital=function(){return this._inHospitalTurns>0},i.canAct=function(){return!this._bankrupt&&!this.isInHospital()},i.isBankrupt=function(){return this._bankrupt},i.hasNextTile=function(){return this._nextTileId!==l},i.getOwner=function(){return this._owner},i.getPlayerIndex=function(){return this._playerIndex},i.getPos=function(){return this._pos},i.setPos=function(t,e){void 0===e&&(e=!0);var n=this._pos;e&&(this._lastTileId=n),this._pos=t,this.setAttr(r.POSITION,t),this.setCurrentTileId(t),console.log("[Player] 位置变化: "+n+" -> "+t+(e?", lastTile: "+this._lastTileId:" (瞬移，lastTile不变)")),u.emit(d.Player.PositionChanged,{playerId:this.m_oId,playerIndex:this._playerIndex,oldPos:n,newPos:t})},i.getCash=function(){return this._cash},i.getBankrupt=function(){return this._bankrupt},i.setCash=function(t){var e=this._cash;this._cash=t,this.setAttr(r.MONEY,Number(t)),console.log("[Player] 现金变化: "+e+" -> "+t),u.emit(d.Player.CashChange,{playerId:this.m_oId,playerIndex:this._playerIndex,oldCash:e,newCash:t,delta:t-e})},i.setBankrupt=function(t){var e=this._bankrupt;this._bankrupt=t,this.setAttr(r.BANKRUPT,t?1:0),t?this.setState(a.BANKRUPT):this.setState(a.IDLE),console.log("[Player] 破产状态变化: "+e+" -> "+t),u.emit(d.Player.StatusChange,{playerId:this.m_oId,playerIndex:this._playerIndex,statusType:"bankrupt",oldValue:e?1:0,newValue:t?1:0})},i.getInHospitalTurns=function(){return this._inHospitalTurns},i.setInHospitalTurns=function(t){var e=this._inHospitalTurns;this._inHospitalTurns=t,t>0?this.setState(a.IDLE):this._bankrupt||0!==t||this.setState(a.IDLE),console.log("[Player] 医院回合变化: "+e+" -> "+t),u.emit(d.Player.StatusChange,{playerId:this.m_oId,playerIndex:this._playerIndex,statusType:"hospital",oldValue:e,newValue:t})},i.getLastTileId=function(){return this._lastTileId},i.getNextTileId=function(){return this._nextTileId},i.getTempleLevels=function(){return[].concat(this._templeLevels)},i.setPaperActor=function(e){if(t.prototype.setPaperActor.call(this,e),e){var n=f.instance.get("currentGameSession");n?this.updatePaperActorDirection(n):console.warn("[Player] GameSession not found, skip direction update")}},i.updatePaperActorDirection=function(t){var e=this.getPaperActor();if(e){var n,s;if(this._nextTileId!==l)n=this._pos,s=this._nextTileId;else{if(this._lastTileId===l)return;n=this._lastTileId,s=this._pos}var i=t.getTileWorldCenter(n),r=t.getTileWorldCenter(s);if(i&&r){var a=this.calculateDirection(i,r);e.setDirection(a),console.log("[Player] 更新朝向: from="+n+" to="+s+", direction="+a)}else console.warn("[Player] 无法获取tile位置: from="+n+", to="+s)}},i.calculateDirection=function(t,e){var n=e.x-t.x,s=e.z-t.z,i=180*Math.atan2(n,s)/Math.PI;return i<0&&(i+=360),Math.round(i/90)%4},i.reset=function(){t.prototype.reset.call(this),this._owner="",this._playerIndex=0,this._pos=0,this._cash=BigInt(0),this._bankrupt=!1,this._inHospitalTurns=0,this._lastTileId=l,this._nextTileId=l,this._templeLevels=[],this._buffs=[],this._cards=[],console.log("[Player] 玩家重置完成")},i.debugInfo=function(){return t.prototype.debugInfo.call(this)+", "+["Owner: "+h.shortenAddress(this._owner),"Index: "+this._playerIndex,"Pos: "+this._pos,"Cash: "+this._cash.toString(),"Bankrupt: "+this._bankrupt,"Hospital: "+this._inHospitalTurns,"Buffs: "+this._buffs.length,"Cards: "+this._cards.length].join(", ")},s}(i));s._RF.pop()}}}));

System.register("chunks:///_virtual/processor.ts",["./rollupPluginModLoBabelHelpers.js","cc","./types2.ts","./aggregated.ts","./constants.ts"],(function(e){var t,a,n,p,s,r,o,i,c;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){a=e.cclegacy},function(e){n=e.EventType},function(e){p=e.analyzePath},function(e){s=e.NpcKind,r=e.CashReason,o=e.NpcAction,i=e.BuffKind,c=e.StopType}],execute:function(){a._RF.push({},"c7b2bGpBEtBGq7gSR/Cao2L","processor",void 0);var u=e("GameEffectType",function(e){return e.EARN_MONEY="earn_money",e.LOSE_MONEY="lose_money",e.PAY_RENT="pay_rent",e.COLLECT_RENT="collect_rent",e.BUY_BUILDING="buy_building",e.UPGRADE_BUILDING="upgrade_building",e.NORMAL_MOVE="normal_move",e.CONTROLLED_MOVE="controlled_move",e.BLOCKED_MOVE="blocked_move",e.SENT_TO_HOSPITAL="sent_to_hospital",e.USE_CARD="use_card",e.DRAW_CARD="draw_card",e.HIT_BOMB="hit_bomb",e.HIT_BARRIER="hit_barrier",e.HIT_DOG="hit_dog",e.PLACE_NPC="place_npc",e.GAIN_BUFF="gain_buff",e.LOSE_BUFF="lose_buff",e.BANKRUPT="bankrupt",e.FROZEN="frozen",e.IN_HOSPITAL="in_hospital",e}({})),_=e("TycoonEventProcessor",function(){function e(){}var a=e.prototype;return a.processEvent=function(e){switch(e.type){case n.ROLL_AND_STEP_ACTION:return this.processRollAndStep(e);case n.USE_CARD_ACTION:return this.processUseCard(e);case n.BANKRUPT:return this.processBankrupt(e);default:return this.processBasicEvent(e)}},a.processRollAndStep=function(e){var a=e.data,o=[],i=new Map,c=new Map;c.set(a.player,a.end_pos),a.dice>0&&o.push({type:u.NORMAL_MOVE,player:a.player,position:{from:a.from,to:a.end_pos},data:{dice:a.dice},description:"掷出"+a.dice+"点，移动到位置"+a.end_pos});for(var _,l=p(a),d=t(l.npcs);!(_=d()).done;){var y=_.value;y.kind===s.BOMB?(o.push({type:u.HIT_BOMB,player:a.player,position:{tile:y.tile_id},description:"踩到炸弹，送往医院"}),y.result_tile&&o.push({type:u.SENT_TO_HOSPITAL,player:a.player,position:{to:y.result_tile},description:"被送往医院"})):y.kind===s.BARRIER&&o.push({type:u.HIT_BARRIER,player:a.player,position:{tile:y.tile_id},description:"遇到路障，停止移动"})}for(var f,E=t(l.cards);!(f=E()).done;){var m=f.value;o.push({type:u.DRAW_CARD,player:a.player,data:{cardKind:m.kind,count:m.count},description:"获得卡牌×"+m.count})}l.finalStop&&this.processStopEffect(l.finalStop,a.player,o);for(var N,h=t(a.cash_changes);!(N=h()).done;){var O=N.value,R=O.is_debit?-O.amount:O.amount,A=i.get(O.player)||0n;i.set(O.player,A+R),O.reason===r.TOLL&&(O.is_debit?o.push({type:u.PAY_RENT,player:O.player,amount:O.amount,position:{tile:O.details},description:"支付过路费 "+O.amount}):o.push({type:u.COLLECT_RENT,player:O.player,amount:O.amount,position:{tile:O.details},description:"收取过路费 "+O.amount}))}return{eventType:n.ROLL_AND_STEP_ACTION,gameId:a.game,timestamp:e.timestamp,effects:o,cashFlows:i,positionChanges:c}},a.processUseCard=function(e){var a=e.data,p=[],s=new Map;p.push({type:u.USE_CARD,player:a.player,data:{cardKind:a.kind,params:a.params},description:"使用了卡牌"});for(var r,c=t(a.npc_changes);!(r=c()).done;){var _=r.value;_.action===o.SPAWN&&p.push({type:u.PLACE_NPC,player:a.player,position:{tile:_.tile_id},data:{npcKind:_.kind},description:"在位置"+_.tile_id+"放置了NPC"})}for(var l,d=t(a.buff_changes);!(l=d()).done;){var y=l.value;p.push({type:u.GAIN_BUFF,player:y.target,data:{buffType:y.buff_type,duration:y.last_active_round},description:"获得了Buff效果"}),y.buff_type===i.FROZEN&&p.push({type:u.FROZEN,player:y.target,description:"被冰冻了"})}for(var f,E=t(a.cash_changes);!(f=E()).done;){var m=f.value,N=m.is_debit?-m.amount:m.amount,h=s.get(m.player)||0n;s.set(m.player,h+N)}return{eventType:n.USE_CARD_ACTION,gameId:a.game,timestamp:e.timestamp,effects:p,cashFlows:s,positionChanges:new Map}},a.processBankrupt=function(e){var t=e.data,a=[];return a.push({type:u.BANKRUPT,player:t.player,target:t.creditor,amount:t.debt,description:"玩家破产，欠债 "+t.debt}),{eventType:n.BANKRUPT,gameId:t.game,timestamp:e.timestamp,effects:a,cashFlows:new Map,positionChanges:new Map}},a.processBasicEvent=function(e){var t=e.data,a=[];switch(e.type){case n.GAME_STARTED:a.push({type:u.NORMAL_MOVE,player:t.starting_player,description:"游戏开始"})}return{eventType:e.type,gameId:t.game||"",timestamp:e.timestamp,effects:a,cashFlows:new Map,positionChanges:new Map}},a.processStopEffect=function(e,t,a){switch(e.stop_type){case c.BUILDING_TOLL:break;case c.BUILDING_NO_RENT:a.push({type:u.NORMAL_MOVE,player:t,position:{tile:e.tile_id},description:"免租通过"});break;case c.HOSPITAL:a.push({type:u.IN_HOSPITAL,player:t,data:{turns:e.turns},description:"进入医院"+e.turns+"回合"});break;case c.BONUS:a.push({type:u.EARN_MONEY,player:t,amount:e.amount,description:"获得奖金 "+e.amount});break;case c.FEE:a.push({type:u.LOSE_MONEY,player:t,amount:e.amount,description:"支付罚款 "+e.amount});break;case c.BUILDING_UNOWNED:a.push({type:u.BUY_BUILDING,player:t,position:{tile:e.tile_id},description:"可以购买地产"})}},e}());e("eventProcessor",new _);a._RF.pop()}}}));

System.register("chunks:///_virtual/QueryService.ts",["./rollupPluginModLoBabelHelpers.js","cc","./GameData.ts"],(function(e){var t,r,n,a,i;return{setters:[function(e){t=e.asyncToGenerator,r=e.regeneratorRuntime,n=e.createForOfIteratorHelperLoose},function(e){a=e.cclegacy},function(e){i=e.GameData}],execute:function(){a._RF.push({},"2b571sIYdZAF4k7zrP4PjEt","QueryService",void 0);e("QueryService",function(){function e(e,t,r){this.MULTI_GET_BATCH_SIZE=50,this.client=e,this.packageId=t,this.gameDataId=r}var a=e.prototype;return a.getGameData=function(){var e=t(r().mark((function e(){var t,n,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.client.getObject({id:this.gameDataId,options:{showContent:!0,showType:!0}});case 3:if(n=e.sent,"moveObject"!==(null==(t=n.data)||null==(t=t.content)?void 0:t.dataType)){e.next=7;break}return a=n.data.content.fields,e.abrupt("return",i.loadFromFields(a));case 7:return e.abrupt("return",null);case 10:return e.prev=10,e.t0=e.catch(0),console.error("[QueryService] Failed to get GameData:",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),a.queryGamesByDynamicFields=function(){var e=t(r().mark((function e(t){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[];try{console.warn("[QueryService] queryGamesByDynamicFields not implemented yet")}catch(e){console.error("[QueryService] Failed to query games:",e)}return e.abrupt("return",n);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a.queryAllGamesBatch=function(){var e=t(r().mark((function e(t){var n,a,i,s,o,u,c,l,p,d,v,m,h,g,f,y,b,_,x,S;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===t&&(t={}),n=[],e.prev=2,a=[],i=void 0,s=!0,o=0,u=100,c=50,console.log("[QueryService] Starting pagination for GameCreatedEvent...");case 10:if(!(s&&o<u)){e.next=21;break}return e.next=13,this.client.queryEvents({query:{MoveEventType:this.packageId+"::events::GameCreatedEvent"},limit:c,order:t.order||"descending",cursor:i});case 13:p=e.sent,a.push.apply(a,p.data),s=p.hasNextPage,i=null!=(l=p.nextCursor)?l:void 0,o++,console.log("[QueryService] Page "+o+": "+p.data.length+" events (total: "+a.length+")"),e.next=10;break;case 21:if(o>=u&&console.warn("[QueryService] Reached max pages limit:",u),console.log("[QueryService] Pagination completed: "+a.length+" total events"),0!==(d=a.map((function(e){var t=e.parsedJson,r=t.game;return r?{gameId:r,createdAt:Number(e.timestampMs||0),creator:t.creator}:null})).filter((function(e){return null!==e}))).length){e.next=26;break}return e.abrupt("return",n);case 26:v=d.map((function(e){return e.gameId})),console.log("[QueryService] Fetching "+v.length+" games in batches..."),m=[],h=0,g=0;case 31:if(!(g<v.length)){e.next=42;break}return f=v.slice(g,g+this.MULTI_GET_BATCH_SIZE),h++,console.log("[QueryService] Batch "+h+": Fetching "+f.length+" games ("+(g+1)+"-"+(g+f.length)+"/"+v.length+")"),e.next=37,this.client.multiGetObjects({ids:f,options:{showContent:!0,showType:!0}});case 37:y=e.sent,m.push.apply(m,y);case 39:g+=this.MULTI_GET_BATCH_SIZE,e.next=31;break;case 42:console.log("[QueryService] Fetched "+m.length+" games in "+h+" batches"),b=0;case 44:if(!(b<m.length)){e.next=57;break}if(_=m[b],x=d[b],S=this.parseGameObject(_)){e.next=51;break}return console.log("[QueryService] Game not found:",x.gameId),e.abrupt("continue",54);case 51:if(void 0===t.status||S.status===t.status){e.next=53;break}return e.abrupt("continue",54);case 53:n.push({game:S,objectId:x.gameId,createdAt:x.createdAt,isMyCreation:!1});case 54:b++,e.next=44;break;case 57:console.log("[QueryService] Batch query completed: "+n.length+" games matched"),e.next=63;break;case 60:e.prev=60,e.t0=e.catch(2),console.error("[QueryService] Failed to query all games (batch):",e.t0);case 63:return e.abrupt("return",n);case 64:case"end":return e.stop()}}),e,this,[[2,60]])})));return function(t){return e.apply(this,arguments)}}(),a.getGame=function(){var e=t(r().mark((function e(t){var n,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.client.getObject({id:t,options:{showContent:!0,showType:!0}});case 3:if(a=e.sent,"moveObject"!==(null==(n=a.data)||null==(n=n.content)?void 0:n.dataType)){e.next=6;break}return e.abrupt("return",this.parseGameObject(a));case 6:return e.abrupt("return",null);case 9:return e.prev=9,e.t0=e.catch(0),console.error("[QueryService] Failed to get game "+t+":",e.t0),e.abrupt("return",null);case 13:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(t){return e.apply(this,arguments)}}(),a.getMapTemplates=function(){var e=t(r().mark((function e(){var t,a,i,s,o,u,c,l,p,d,v,m;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],e.prev=1,a=void 0,i=!0,s=0,o=100,u=50,console.log("[QueryService] Starting pagination for MapTemplatePublishedEvent...");case 8:if(!(i&&s<o)){e.next=19;break}return e.next=11,this.client.queryEvents({query:{MoveEventType:this.packageId+"::events::MapTemplatePublishedEvent"},limit:u,order:"descending",cursor:a});case 11:for(l=e.sent,p=n(l.data);!(d=p()).done;)v=d.value,m=v.parsedJson,t.push({template_id:m.template_id||"",publisher:m.publisher||"",tile_count:m.tile_count||0,building_count:m.building_count||0});i=l.hasNextPage,a=null!=(c=l.nextCursor)?c:void 0,s++,console.log("[QueryService] Page "+s+": "+l.data.length+" templates (total: "+t.length+")"),e.next=8;break;case 19:s>=o&&console.warn("[QueryService] Reached max pages limit:",o),console.log("[QueryService] Found "+t.length+" map templates in "+s+" pages"),e.next=26;break;case 23:e.prev=23,e.t0=e.catch(1),console.error("[QueryService] Failed to query map templates:",e.t0);case 26:return e.abrupt("return",t);case 27:case"end":return e.stop()}}),e,this,[[1,23]])})));return function(){return e.apply(this,arguments)}}(),a.getPlayerSeats=function(){var e=t(r().mark((function e(t){var n,a,i,s,o,u,c,l,p;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=[],a=void 0,i=!0,s=0,o=100,u=50,console.log("[QueryService] Starting pagination for player seats...");case 8:if(!(i&&s<o)){e.next=20;break}return e.next=11,this.client.getOwnedObjects({owner:t,filter:{StructType:this.packageId+"::game::Seat"},options:{showContent:!0,showType:!0},cursor:a,limit:u});case 11:l=e.sent,p=l.data.map((function(e){var t;return"moveObject"===(null==(t=e.data)||null==(t=t.content)?void 0:t.dataType)?e.data.content.fields:null})).filter((function(e){return null!==e})),n.push.apply(n,p),i=l.hasNextPage,a=null!=(c=l.nextCursor)?c:void 0,s++,console.log("[QueryService] Page "+s+": "+p.length+" seats (total: "+n.length+")"),e.next=8;break;case 20:return s>=o&&console.warn("[QueryService] Reached max pages limit:",o),console.log("[QueryService] Found "+n.length+" seats for "+t+" in "+s+" pages"),e.abrupt("return",n);case 25:return e.prev=25,e.t0=e.catch(0),console.error("[QueryService] Failed to get player seats:",e.t0),e.abrupt("return",[]);case 29:case"end":return e.stop()}}),e,this,[[0,25]])})));return function(t){return e.apply(this,arguments)}}(),a.queryAllEvents=function(){var e=t(r().mark((function e(t,n){var a,i,s,o,u,c,l,p;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=[],i=void 0,s=!0,o=0,u=(null==n?void 0:n.maxPages)||100,c=(null==n?void 0:n.limit)||50;case 6:if(!(s&&o<u)){e.next=17;break}return e.next=9,this.client.queryEvents({query:{MoveEventType:t},limit:c,order:(null==n?void 0:n.order)||"descending",cursor:i});case 9:p=e.sent,a.push.apply(a,p.data.map((function(e){return e.parsedJson}))),s=p.hasNextPage,i=null!=(l=p.nextCursor)?l:void 0,o++,console.log("[QueryService] Page "+o+": "+p.data.length+" events (total: "+a.length+")"),e.next=6;break;case 17:return o>=u&&console.warn("[QueryService] Reached max pages limit:",u),console.log("[QueryService] Pagination completed: "+a.length+" events in "+o+" pages"),e.abrupt("return",a);case 20:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),a.parseID=function(e){return"string"==typeof e?e:null!=e&&e.bytes?e.bytes:null!=e&&e.id?e.id:""},a.parseOption=function(e){if(e)return e.vec&&Array.isArray(e.vec)&&e.vec.length>0?e.vec[0]:void 0},a.parseGameObject=function(e){var t;if("moveObject"!==(null==(t=e.data)||null==(t=t.content)?void 0:t.dataType))return null;var r=e.data.content.fields;try{var n;return{id:(null==(n=r.id)?void 0:n.id)||e.data.objectId,status:Number(r.status)||0,template_map_id:this.parseID(r.template_map_id),players:this.parsePlayers(r.players||[]),round:Number(r.round)||0,turn:Number(r.turn)||0,active_idx:Number(r.active_idx)||0,has_rolled:Boolean(r.has_rolled),tiles:this.parseTiles(r.tiles||[]),buildings:this.parseBuildings(r.buildings||[]),npc_on:this.parseNpcInstances(r.npc_on||[]),npc_spawn_pool:r.npc_spawn_pool||[],max_rounds:Number(r.max_rounds)||0,price_rise_days:Number(r.price_rise_days)||0,pending_decision:Number(r.pending_decision)||0,decision_tile:Number(r.decision_tile)||0,decision_amount:BigInt(r.decision_amount||0),winner:this.parseOption(r.winner)}}catch(e){return console.error("[QueryService] Failed to parse game object:",e),console.error("  Raw fields:",r),null}},a.parsePlayers=function(e){var t=this;return e.map((function(e){var r=e.fields||e;return{owner:r.owner||"",pos:Number(r.pos)||0,cash:BigInt(r.cash||0),bankrupt:Boolean(r.bankrupt),in_hospital_turns:Number(r.in_hospital_turns)||0,last_tile_id:Number(r.last_tile_id)||0,next_tile_id:Number(r.next_tile_id)||0,temple_levels:r.temple_levels||[],buffs:r.buffs||[],cards:t.parseCardEntries(r.cards||[])}}))},a.parseCardEntries=function(e){return e.map((function(e){var t=e.fields||e;return{kind:Number(t.kind),count:Number(t.count)}}))},a.parseTiles=function(e){return e.map((function(e){var t,r=e.fields||e;return{npc_on:Number(null!=(t=r.npc_on)?t:65535)}}))},a.parseBuildings=function(e){return e.map((function(e){var t=e.fields||e;return{owner:Number(t.owner),level:Number(t.level)||0,building_type:Number(t.building_type)||0}}))},a.parseNpcInstances=function(e){return e.map((function(e){var t=e.fields||e;return{tile_id:Number(t.tile_id),kind:Number(t.kind),consumable:Boolean(t.consumable),spawn_index:Number(t.spawn_index)}}))},e}());a._RF.pop()}}}));

System.register("chunks:///_virtual/RentDecisionHandler.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Blackboard.ts","./EventBus.ts","./EventTypes.ts","./UINotification.ts","./constants.ts"],(function(e){var n,t,r,o,i,a,s,c;return{setters:[function(e){n=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){r=e.cclegacy},function(e){o=e.Blackboard},function(e){i=e.EventBus},function(e){a=e.EventTypes},function(e){s=e.UINotification},function(e){c=e.CardKind}],execute:function(){r._RF.push({},"1b92epN7PpGnbnin8TOL92u","RentDecisionHandler",void 0);var l=e("RentDecisionHandler",function(){function e(){console.log("[RentDecisionHandler] Handler 创建")}e.getInstance=function(){return e._instance||(e._instance=new e),e._instance};var r=e.prototype;return r.initialize=function(){console.log("[RentDecisionHandler] 初始化事件监听")},r.handleEvent=function(){var e=n(t().mark((function e(n){var r,l,u,d,g,f,R,p,y;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[RentDecisionHandler] 收到 RentDecisionEvent",n),r=n.data,e.prev=2,l=o.instance.get("currentGameSession")){e.next=7;break}return console.warn("[RentDecisionHandler] GameSession not found"),e.abrupt("return");case 7:if(r.game===l.getGameId()){e.next=10;break}return console.warn("[RentDecisionHandler] Event game mismatch, ignoring",{eventGame:r.game,currentGame:l.getGameId()}),e.abrupt("return");case 10:if(!r.auto_decision){e.next=16;break}if(r.decision){e.next=14;break}return console.warn("[RentDecisionHandler] Auto-decision event with null decision, ignoring"),e.abrupt("return");case 14:return console.log("[RentDecisionHandler] Auto-decision event ignored (handled by RollAndStepHandler)",{payer:r.decision.payer,owner:r.decision.owner,rentAmount:r.decision.rent_amount.toString(),usedRentFree:r.decision.used_rent_free}),e.abrupt("return");case 16:if(u=r.decision){e.next=20;break}return console.error("[RentDecisionHandler] Missing decision data in RentDecisionEvent"),e.abrupt("return");case 20:return l.setRound(r.round),e.next=23,l.advance_turn(r.turn);case 23:if(console.log("[RentDecisionHandler] Turn 已更新",{round:r.round,turn:r.turn}),d=l.getPlayerByAddress(u.payer),g=l.getPlayerByAddress(u.owner),d&&g){e.next=29;break}return console.warn("[RentDecisionHandler] Player not found",{payer:u.payer,owner:u.owner}),e.abrupt("return");case 29:u.used_rent_free?d.removeCard(c.RENT_FREE,1)?(console.log("[RentDecisionHandler] 免租卡已使用",{player:d.getPlayerIndex()}),s.info("玩家"+(d.getPlayerIndex()+1)+"使用了免租卡"),l.getMyPlayer()===d&&(i.emit(a.UI.CardFlyOut,{cardKind:c.RENT_FREE,fromSlot:d.getCardCount(c.RENT_FREE)+1}),console.log("[RentDecisionHandler] 触发卡牌飞出动画"))):console.error("[RentDecisionHandler] 免租卡使用失败"):(f=BigInt(u.rent_amount),R=d.getCash()-f,p=g.getCash()+f,d.setCash(R),g.setCash(p),console.log("[RentDecisionHandler] 租金已支付",{payer:d.getPlayerIndex(),owner:g.getPlayerIndex(),amount:f.toString()}),(y=l.getMyPlayer())&&(d===y?s.info("-"+f,void 0,2e3,"center"):g===y&&s.info("+"+f,void 0,2e3,"center"))),console.log("[RentDecisionHandler] RentDecisionEvent 处理完成"),e.next=37;break;case 33:e.prev=33,e.t0=e.catch(2),console.error("[RentDecisionHandler] 处理事件失败",e.t0),s.error("租金决策处理失败: "+(e.t0.message||e.t0));case 37:case"end":return e.stop()}}),e,null,[[2,33]])})));return function(n){return e.apply(this,arguments)}}(),r.destroy=function(){console.log("[RentDecisionHandler] Handler 销毁"),e._instance=null},e}());l._instance=null;e("rentDecisionHandler",{get instance(){return l.getInstance()}});r._RF.pop()}}}));

System.register("chunks:///_virtual/ResourceLoader.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r,n,s,a,o,c;return{setters:[function(e){t=e.asyncToGenerator,r=e.regeneratorRuntime,n=e.createForOfIteratorHelperLoose},function(e){s=e.cclegacy,a=e.resources,o=e.JsonAsset,c=e.Texture2D}],execute:function(){s._RF.push({},"f2cd0WEJeJOGJCSSg4JMXQh","ResourceLoader",void 0);e("ResourceLoader",function(){function e(e,t){void 0===e&&(e="voxel/resource_pack"),this.rootDir=void 0,this.searchRoots=void 0,this.cache=void 0,this.rootDir=e,this.searchRoots=t||[e],this.cache={blockstates:new Map,models:new Map,textures:new Map}}var s=e.prototype;return s.loadJsonFromRoots=function(){var e=t(r().mark((function e(t){var n,s,a,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=0;case 1:if(!(n<this.searchRoots.length)){e.next=18;break}return s=this.searchRoots[n],a=s+"/"+t,e.prev=4,e.next=7,this.loadJson(a);case 7:if(!(o=e.sent)){e.next=10;break}return e.abrupt("return",{json:o,rel:t,foundRootIndex:n});case 10:e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(4),e.abrupt("continue",15);case 15:n++,e.next=1;break;case 18:return console.warn("[ResourceLoader] 未找到资源: "+t),e.abrupt("return",null);case 20:case"end":return e.stop()}}),e,this,[[4,12]])})));return function(t){return e.apply(this,arguments)}}(),s.loadJson=function(){var e=t(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.endsWith(".json")&&(t=t.substring(0,t.length-5)),e.abrupt("return",new Promise((function(e,r){a.load(t,o,(function(t,n){t?r(t):e(n.json)}))})));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),s.loadBlockState=function(){var e=t(r().mark((function e(t,n){var s,a,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t+":"+n,!this.cache.blockstates.has(s)){e.next=3;break}return e.abrupt("return",this.cache.blockstates.get(s));case 3:return a="assets/"+t+"/blockstates/"+n+".json",e.next=6,this.loadJsonFromRoots(a);case 6:if(!(o=e.sent)){e.next=10;break}return this.cache.blockstates.set(s,o.json),e.abrupt("return",o.json);case 10:return e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),s.loadModel=function(){var e=t(r().mark((function e(t,n,s){var a,o,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t+":"+n+"/"+s,!this.cache.models.has(a)){e.next=3;break}return e.abrupt("return",this.cache.models.get(a));case 3:return o="assets/"+t+"/models/"+n+"/"+s+".json",e.next=6,this.loadJsonFromRoots(o);case 6:if(!(c=e.sent)){e.next=10;break}return this.cache.models.set(a,c.json),e.abrupt("return",c.json);case 10:return e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),s.loadTexture=function(){var e=t(r().mark((function e(t,n,s){var o,u;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t+":"+n+"/"+s,(u=this.cache.textures.get(o))||(u=this.rootDir+"/assets/"+t+"/textures/"+n+"/"+s,this.cache.textures.set(o,u)),e.abrupt("return",new Promise((function(e){a.load(u+"/texture",c,(function(t,r){if(t)return console.warn("[ResourceLoader] 纹理加载失败: "+u,t),void e(null);r.setFilters(c.Filter.NEAREST,c.Filter.NEAREST),e(r)}))})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),s.checkResourceExists=function(){var e=t(r().mark((function e(t){var s,o,c,u;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=r().mark((function e(){var n,s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=u.value,s=n+"/"+t,e.prev=2,e.next=5,new Promise((function(e){a.load(s,(function(t){e(!t)}))}));case 5:if(!e.sent){e.next=8;break}return e.abrupt("return",{v:!0});case 8:e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(2),e.abrupt("return",0);case 13:case"end":return e.stop()}}),e,null,[[2,10]])})),c=n(this.searchRoots);case 2:if((u=c()).done){e.next=11;break}return e.delegateYield(s(),"t0",4);case 4:if(0!==(o=e.t0)){e.next=7;break}return e.abrupt("continue",9);case 7:if(!o){e.next=9;break}return e.abrupt("return",o.v);case 9:e.next=2;break;case 11:return e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),s.clearCache=function(){this.cache.blockstates.clear(),this.cache.models.clear(),this.cache.textures.clear()},s.getCacheStats=function(){return{blockstates:this.cache.blockstates.size,models:this.cache.models.size,textures:this.cache.textures.size}},s.setSearchRoots=function(e){this.searchRoots=e},s.getRootDir=function(){return this.rootDir},s.getSearchRoots=function(){return[].concat(this.searchRoots)},e}());s._RF.pop()}}}));

System.register("chunks:///_virtual/ResourcePackExample.ts",["./rollupPluginModLoBabelHelpers.js","cc","./index6.ts","./BlockParser.ts"],(function(e){var n,r,o,t,a,s,c,l,u,i,p,f;return{setters:[function(e){n=e.inheritsLoose,r=e.createForOfIteratorHelperLoose,o=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){a=e.cclegacy,s=e._decorator,c=e.Component},function(e){l=e.parseBlock,u=e.parseBlocks,i=e.getCacheStats,p=e.preloadCommonBlocks},function(e){f=e.BlockParser}],execute:function(){var m;e({describeBlock:function(e){var n=[];n.push("方块: "+e.id.ns+":"+e.id.path),n.push("模板: "+e.modelTemplate),n.push("纹理数: "+e.textures.length),n.push("元素数: "+e.elements.length),e.rotationY&&n.push("旋转: "+e.rotationY+"°");return n.join(", ")},validateParsedData:function(e){if(!e.id||!e.id.ns||!e.id.path)return console.error("缺少 ID 信息"),!1;if(!e.elements||0===e.elements.length)return console.error("缺少元素信息"),!1;for(var n,o=r(e.elements);!(n=o()).done;){var t=n.value;if(!t.from||!t.to)return console.error("元素缺少位置信息"),!1;if(!t.faces||0===t.faces.length)return console.error("元素缺少面信息"),!1}return!0}}),a._RF.push({},"3b9a6vji1pFlo3mwensCxOL","ResourcePackExample",void 0);var g=s.ccclass;s.property,e("ResourcePackExample",g("ResourcePackExample")(m=function(e){function a(){return e.apply(this,arguments)||this}n(a,e);var s=a.prototype;return s.example1_parseSingleBlock=function(){var e=o(t().mark((function e(){var n,r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("=== 示例1: 解析单个方块 ==="),e.next=3,l("minecraft:grass_block");case 3:return n=e.sent,console.log("Grass Block 方块数据:",n),e.next=7,l("web3:hospital");case 7:r=e.sent,console.log("Hospital Block 方块数据:",r);case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),s.example2_parseMultipleBlocks=function(){var e=o(t().mark((function e(){var n,o,a,s,c;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("=== 示例2: 批量解析方块 ==="),n=["minecraft:stone","minecraft:oak_log","minecraft:oak_planks","web3:empty_land","web3:hospital"],e.next=4,u(n);case 4:for(o=e.sent,a=r(o);!(s=a()).done;)c=s.value,console.log("- "+c.id.ns+":"+c.id.path),console.log("  模板: "+c.modelTemplate),console.log("  纹理: "+c.textures.map((function(e){return e.name})).join(", "));case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),s.example3_customConfig=function(){var e=o(t().mark((function e(){var n,r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("=== 示例3: 使用自定义配置 ==="),n=new f({rootDir:"voxel/resource_pack",searchRoots:["voxel/resource_pack","voxel/default"],defaultNamespace:"web3"}),e.next=4,n.parseBlock("empty_land");case 4:r=e.sent,console.log("Empty Land 数据:",r);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),s.example4_preloadBlocks=function(){var e=o(t().mark((function e(){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("=== 示例4: 预加载常用方块 ==="),console.log("预加载前缓存:",i()),e.next=4,p();case 4:console.log("预加载后缓存:",i());case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),s.example5_parseDetails=function(){var e=o(t().mark((function e(){var n,o,a,s,c,u,i;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("=== 示例5: 访问解析细节 ==="),e.next=3,l("minecraft:oak_planks");case 3:for(n=e.sent,console.log("BlockState 路径:",n.debug.blockstatePath),console.log("模型继承链:",n.debug.modelChainPaths),console.log("纹理映射:",n.debug.combinedJson.texturesDict),o=r(n.elements);!(a=o()).done;)for(s=a.value,console.log("元素:",{from:s.from,to:s.to,faces:s.faces.length}),c=r(s.faces);!(u=c()).done;)i=u.value,console.log("  面 "+i.dir+":",{uv:i.uv,texture:i.textureRel});case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),s.example6_web3Blocks=function(){var e=o(t().mark((function e(){var n,r,o,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("=== 示例6: Web3 特殊方块 ==="),n=0,r=["web3:land_god","web3:wealth_god","web3:fortune_god","web3:poverty_god","web3:dog","web3:roadblock","web3:bomb"];case 3:if(!(n<r.length)){e.next=12;break}return o=r[n],e.next=7,l(o);case 7:a=e.sent,console.log(o+":",{template:a.modelTemplate,textures:a.textures.map((function(e){return e.name})),rotationY:a.rotationY});case 9:n++,e.next=3;break;case 12:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),s.example7_errorHandling=function(){var e=o(t().mark((function e(){var n;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("=== 示例7: 错误处理 ==="),e.prev=1,e.next=4,l("minecraft:non_existent_block");case 4:n=e.sent,console.log("解析结果:",n),n.textures.some((function(e){return e.missing}))&&console.log("检测到缺失的纹理"),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),console.error("解析失败:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[1,9]])})));return function(){return e.apply(this,arguments)}}(),s.runAllExamples=function(){var e=o(t().mark((function e(){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("========== Resource Pack 解析系统示例 =========="),e.next=3,this.example1_parseSingleBlock();case 3:console.log("========== 所有示例运行完成 ==========");case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),s.start=function(){this.runAllExamples().catch((function(e){console.error("示例运行失败:",e)}))},a}(c))||m);a._RF.pop()}}}));

System.register("chunks:///_virtual/RightHandRule.ts",["./rollupPluginModLoBabelHelpers.js","cc","./WalkingPreference.ts"],(function(t){var e,n,i,r,o,l,a;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){n=t.cclegacy},function(t){i=t.Direction,r=t.RightTurnDirection,o=t.LeftTurnDirection,l=t.OppositeDirection,a=t.INVALID_TILE_ID}],execute:function(){n._RF.push({},"8e40eAqGbRLaI4mWgdDU5KZ","RightHandRule",void 0);t("RightHandRule",function(){function t(t){this.template=void 0,this.template=t}var n=t.prototype;return n.inferMovingDirection=function(t,e){var n=this.template.tiles_static.get(t);return n?n.w===e?i.EAST:n.n===e?i.SOUTH:n.e===e?i.WEST:n.s===e?i.NORTH:null:null},n.getDirectionPriority=function(t){return[r[t],t,o[t],l[t]]},n.getNextTile=function(t,n){var r,o=this.template.tiles_static.get(t);if(!o)return console.warn("[RightHandRule] Tile "+t+" not found in template"),a;var l=((r={})[i.WEST]=o.w,r[i.NORTH]=o.n,r[i.EAST]=o.e,r[i.SOUTH]=o.s,r),u=this.inferMovingDirection(t,n);if(null===u)return console.warn("[RightHandRule] Cannot infer moving direction from "+n+" to "+t),this.getAnyValidNeighbor(t,n);for(var s,g=this.getDirectionPriority(u),h=e(g);!(s=h()).done;){var c=l[s.value];if(c!==a)return c}return console.warn("[RightHandRule] No valid neighbor found for tile "+t),a},n.getAnyValidNeighbor=function(t,e){var n=this.template.tiles_static.get(t);if(!n)return a;for(var i=0,r=[n.w,n.n,n.e,n.s];i<r.length;i++){var o=r[i];if(o!==a&&o!==e)return o}return a},n.calculatePath=function(t,e,n){void 0===n&&(n=a);var i=[],r=new Map,o=[],l=t,u=n;for(r.set(t,1);i.length<e;){var s=this.getValidNeighbors(l,u);if(0===s.length){if(o.length>0){var g=o.pop();i.splice(g.pathLength),l=g.tile,u=g.prevTile,console.log("[RightHandRule] 回溯到分叉点: tile "+l+", path length "+i.length);continue}console.warn("[RightHandRule] 无法继续，返回 "+i.length+" 步");break}s.length>1&&o.push({tile:l,prevTile:u,pathLength:i.length});var h=this.selectBestNeighbor(l,u,s,r);i.push(h),r.set(h,(r.get(h)||0)+1),u=l,l=h}return i},n.getValidNeighbors=function(t,e){var n=this.template.tiles_static.get(t);if(!n)return[];for(var i=[],r=0,o=[n.w,n.n,n.e,n.s];r<o.length;r++){var l=o[r];l!==a&&l!==e&&i.push(l)}return i},n.selectBestNeighbor=function(t,n,r,o){if(1===r.length)return r[0];var l=this.inferMovingDirection(t,n);if(null!==l)for(var a,u,s=this.template.tiles_static.get(t),g=((a={})[i.WEST]=s.w,a[i.NORTH]=s.n,a[i.EAST]=s.e,a[i.SOUTH]=s.s,a),h=this.getDirectionPriority(l),c=e(h);!(u=c()).done;){var f=g[u.value];if(r.includes(f))return f}return r.sort((function(t,e){return(o.get(t)||0)-(o.get(e)||0)})),r[0]},n.debugPath=function(t){console.log("[RightHandRule] Path:",{length:t.length,tiles:t})},t}());n._RF.pop()}}}));

System.register("chunks:///_virtual/Role.ts",["./rollupPluginModLoBabelHelpers.js","cc","./_baseGetTag.js","./_baseToString.js","./_metaMap.js","./_root.js","./_LazyWrapper.js","./wrapperLodash.js","./_defineProperty.js","./assign.js","./assignIn.js","./assignInWith.js","./assignWith.js","./at.js","./attempt.js","./bind.js","./bindAll.js","./bindKey.js","./_createRound.js","./_baseClone.js","./_LodashWrapper.js","./_isFlattenable.js","./_Stack.js","./_SetCache.js","./_equalByTag.js","./isArguments.js","./isBuffer.js","./isTypedArray.js","./_getTag.js","./_stringToPath.js","./curry.js","./curryRight.js","./defaults.js","./defaultsDeep.js","./defer.js","./delay.js","./difference.js","./differenceBy.js","./differenceWith.js","./forEach.js","./flow.js","./flowRight.js","./intersection.js","./intersectionBy.js","./intersectionWith.js","./invoke.js","./invokeMap.js","./isArrayBuffer.js","./isDate.js","./isPlainObject.js","./isFinite.js","./isMap.js","./_baseIsNative.js","./_coreJsData.js","./isRegExp.js","./isSet.js","./memoize.js","./merge.js","./mergeWith.js","./method.js","./methodOf.js","./toArray.js","./omit.js","./over.js","./overArgs.js","./overEvery.js","./overSome.js","./parseInt.js","./partial.js","./partialRight.js","./pick.js","./pull.js","./pullAt.js","./rearg.js","./sortBy.js","./union.js","./unionBy.js","./unionWith.js","./_createSet.js","./without.js","./wrapperAt.js","./xor.js","./xorBy.js","./xorWith.js","./zip.js","./zipWith.js","./lodash.default.js","./EventBus.ts","./EventTypes.ts","./RoleTypes.ts"],(function(t){var e,i,s,n,r,l,o,u,a,h,m;return{setters:[function(t){e=t.createForOfIteratorHelperLoose,i=t.asyncToGenerator,s=t.regeneratorRuntime},function(t){n=t.cclegacy,r=t.Vec3},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,function(t){l=t.default},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,function(t){o=t.EventBus},function(t){u=t.EventTypes},function(t){a=t.RoleAttribute,h=t.RoleState,m=t.RoleType}],execute:function(){n._RF.push({},"0a4d8ruEGRKh7E7bVKmg66d","Role",void 0);t("Role",function(){function t(){this.m_oId="",this.m_eType=m.PLAYER,this.m_iTypeId=0,this.m_strName="",this.m_eState=h.IDLE,this.m_position=new r,this.m_currentTileId=-1,this.m_targetTileId=-1,this.m_attr=new Map,this.m_tmpAttr=new Map,this._paperActor=null,this.m_actor=null,this.m_roleAction=null,this.m_bInitialized=!1,this.m_bVisible=!0,this.m_bActive=!0,this.initializeAttributes(),this.m_oId=this.generateId()}var n=t.prototype;return n.initializeAttributes=function(){this.m_attr.set(a.MONEY,1e4),this.m_attr.set(a.HP,100),this.m_attr.set(a.MOVE_SPEED,1),this.m_attr.set(a.LUCK,50),this.m_attr.set(a.LEVEL,1),this.m_attr.set(a.VIP_LEVEL,0),this.m_attr.set(a.PROPERTIES_COUNT,0),this.m_attr.set(a.BANKRUPT,0),this.m_tmpAttr.clear()},n.generateId=function(){return"role_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)},n.initialize=function(t){var e=this;this.m_iTypeId=t.typeId,this.m_strName=t.name,t.defaultAttributes&&l(t.defaultAttributes,(function(t,i){var s=a[i];void 0!==s&&e.m_attr.set(s,t)})),this.m_bInitialized=!0,o.emit(u.Role.Initialized,{roleId:this.m_oId,role:this}),console.log("[Role] 角色初始化完成: "+this.m_strName+" ("+this.m_oId+")")},n.getAttr=function(t){return(this.m_attr.get(t)||0)+(this.m_tmpAttr.get(t)||0)},n.setAttr=function(t,e){var i=this.getAttr(t);this.m_attr.set(t,e),o.emit(u.Role.AttributeChange,{roleId:this.m_oId,attribute:t,oldValue:i,newValue:e}),this.onAttributeChanged(t,i,this.getAttr(t))},n.addAttr=function(t,e){var i=this.m_attr.get(t)||0;this.setAttr(t,i+e)},n.getTmpAttr=function(t){return this.m_tmpAttr.get(t)||0},n.setTmpAttr=function(t,e){this.m_tmpAttr.set(t,e)},n.addTmpAttr=function(t,e){var i=this.m_tmpAttr.get(t)||0;this.setTmpAttr(t,i+e)},n.clearTmpAttr=function(t){void 0!==t?this.m_tmpAttr.delete(t):this.m_tmpAttr.clear()},n.getId=function(){return this.m_oId},n.getRoleId=function(){return this.m_oId},n.setId=function(t){this.m_oId=t},n.getName=function(){return this.m_strName},n.setName=function(t){this.m_strName=t},n.getType=function(){return this.m_eType},n.setType=function(t){this.m_eType=t},n.getTypeId=function(){return this.m_iTypeId},n.setTypeId=function(t){this.m_iTypeId=t},n.getState=function(){return this.m_eState},n.setState=function(t){var e=this.m_eState;this.m_eState=t,this.onStateChanged(e,t)},n.getPosition=function(){return this.m_position.clone()},n.setPosition=function(t){this.m_position.set(t),this.m_actor&&this.m_actor.updatePosition(t)},n.getCurrentTileId=function(){return this.m_currentTileId},n.setCurrentTileId=function(t){var e=this.m_currentTileId;this.m_currentTileId=t,this.setAttr(a.POSITION,t),this.onTileChanged(e,t)},n.setPaperActor=function(t){this._paperActor=t},n.getPaperActor=function(){return this._paperActor},n.getActor=function(){return this.m_actor},n.setActor=function(t){this.m_actor=t,t&&t.bindRole(this)},n.getRoleAction=function(){return this.m_roleAction},n.setRoleAction=function(t){this.m_roleAction=t},n.moveTo=function(){var t=i(s().mark((function t(e){return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.m_eState!==h.MOVING){t.next=3;break}return console.warn("[Role] "+this.m_strName+" 正在移动中"),t.abrupt("return",!1);case 3:if(this.setState(h.MOVING),this.m_targetTileId=e.targetTileId,t.prev=5,!this._paperActor){t.next=9;break}return t.next=9,this._paperActor.moveToTile(e);case 9:return this.setCurrentTileId(e.targetTileId),this.setState(h.IDLE),o.emit(u.Role.PositionChange,{roleId:this.m_oId,fromTileId:this.m_currentTileId,toTileId:e.targetTileId,steps:e.steps,position:this.m_position}),t.abrupt("return",!0);case 15:return t.prev=15,t.t0=t.catch(5),console.error("[Role] "+this.m_strName+" 移动失败:",t.t0),this.setState(h.IDLE),t.abrupt("return",!1);case 20:case"end":return t.stop()}}),t,this,[[5,15]])})));return function(e){return t.apply(this,arguments)}}(),n.exportData=function(){for(var t,i={},s=e(this.m_attr);!(t=s()).done;){var n=t.value,r=n[0],l=n[1];i[r]=l}for(var o,u={},a=e(this.m_tmpAttr);!(o=a()).done;){var h=o.value,m=h[0],c=h[1];u[m]=c}return{id:this.m_oId,type:this.m_eType,typeId:this.m_iTypeId,name:this.m_strName,attributes:i,tmpAttributes:u,position:this.m_position.clone(),currentTileId:this.m_currentTileId,state:this.m_eState}},n.loadData=function(t){var e=this;this.m_oId=t.id,this.m_eType=t.type,this.m_iTypeId=t.typeId,this.m_strName=t.name,this.m_position.set(t.position),this.m_currentTileId=t.currentTileId,this.m_eState=t.state,this.m_attr.clear(),l(t.attributes,(function(t,i){e.m_attr.set(parseInt(i),t)})),this.m_tmpAttr.clear(),l(t.tmpAttributes,(function(t,i){e.m_tmpAttr.set(parseInt(i),t)})),console.log("[Role] 角色数据加载完成: "+this.m_strName)},n.isAlive=function(){return this.getAttr(a.HP)>0},n.isBankrupt=function(){return this.getAttr(a.BANKRUPT)>0},n.canMove=function(){return this.m_eState===h.IDLE&&!this.isBankrupt()},n.onAttributeChanged=function(t,e,i){},n.onStateChanged=function(t,e){console.log("[Role] "+this.m_strName+" 状态变化: "+t+" -> "+e),o.emit(u.Role.StateChange,{roleId:this.m_oId,oldState:t,newState:e})},n.onTileChanged=function(t,e){console.log("[Role] "+this.m_strName+" 位置变化: "+t+" -> "+e),o.emit(u.Role.PositionChange,{roleId:this.m_oId,oldTileId:t,newTileId:e})},n.reset=function(){this.initializeAttributes(),this.setState(h.IDLE),this.m_currentTileId=-1,this.m_targetTileId=-1,this.clearTmpAttr(),this._paperActor=null,this.m_actor=null,this.m_roleAction=null,console.log("[Role] 角色重置完成: "+this.m_strName)},n.destroy=function(){if(this._paperActor){var t=this._paperActor.node;t&&t.isValid&&t.destroy(),this._paperActor=null}this.m_actor&&(this.m_actor.destroy(),this.m_actor=null),this.m_roleAction&&(this.m_roleAction.destroy(),this.m_roleAction=null),o.emit(u.Role.Destroyed,{roleId:this.m_oId,roleType:this.m_eType,roleName:this.m_strName}),this.m_attr.clear(),this.m_tmpAttr.clear(),console.log("[Role] 角色销毁完成: "+this.m_strName)},n.debugInfo=function(){return"[Role] "+["ID: "+this.m_oId,"名称: "+this.m_strName,"类型: "+this.m_eType,"状态: "+this.m_eState,"位置: "+this.m_currentTileId,"金钱: "+this.getAttr(a.MONEY),"生命: "+this.getAttr(a.HP)].join(", ")},t}());n._RF.pop()}}}));

System.register("chunks:///_virtual/RoleAction.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RoleTypes.ts"],(function(t){var e,r,n,i,a;return{setters:[function(t){e=t.createForOfIteratorHelperLoose,r=t.asyncToGenerator,n=t.regeneratorRuntime},function(t){i=t.cclegacy},function(t){a=t.RoleState}],execute:function(){i._RF.push({},"4bf92pF5AtBmI7oMdqnDBuZ","RoleAction",void 0);var c=t("ActionType",function(t){return t.IDLE="idle",t.MOVE="move",t.INTERACT="interact",t.USE_SKILL="use_skill",t.USE_CARD="use_card",t}({})),u=t("ActionState",function(t){return t.READY="ready",t.EXECUTING="executing",t.COMPLETED="completed",t.FAILED="failed",t.CANCELLED="cancelled",t}({}));t("RoleAction",function(){function t(){this.m_role=null,this.m_currentAction=c.IDLE,this.m_actionState=u.READY,this.m_actionQueue=[],this.m_isExecuting=!1,this.m_actionStartTime=0,this.m_actionTimeout=3e4,this.m_enableQueue=!0,this.m_maxQueueLength=10}var i=t.prototype;return i.bindRole=function(t){this.m_role=t,console.log("[RoleAction] 绑定角色: "+t.getName())},i.unbindRole=function(){this.clearQueue(),this.m_isExecuting&&this.cancelCurrentAction(),this.m_role=null,console.log("[RoleAction] 角色解绑")},i.executeAction=function(){var t=r(n().mark((function t(e){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.m_role){t.next=2;break}return t.abrupt("return",this.createFailResult("未绑定角色",e.type));case 2:if(!this.m_isExecuting||this.canInterrupt()){t.next=8;break}if(!(this.m_enableQueue&&this.m_actionQueue.length<this.m_maxQueueLength)){t.next=7;break}return t.abrupt("return",this.enqueueAction(e));case 7:return t.abrupt("return",this.createFailResult("角色正在执行其他行为",e.type));case 8:if(!(e.delay&&e.delay>0)){t.next=11;break}return t.next=11,this.delay(1e3*e.delay);case 11:return t.next=13,this.startAction(e);case 13:return t.abrupt("return",t.sent);case 14:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),i.startAction=function(){var t=r(n().mark((function t(e){var r;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.m_isExecuting=!0,this.m_currentAction=e.type,this.m_actionState=u.EXECUTING,this.m_actionStartTime=Date.now(),this.updateRoleState(e.type),this.emit("action-start",{actionType:e.type,role:this.m_role,params:e}),t.prev=6,t.t0=e.type,t.next=t.t0===c.MOVE?10:t.t0===c.INTERACT?14:t.t0===c.USE_SKILL?18:t.t0===c.USE_CARD?22:26;break;case 10:return t.next=12,this.executeMove(e);case 12:return r=t.sent,t.abrupt("break",30);case 14:return t.next=16,this.executeInteract(e);case 16:return r=t.sent,t.abrupt("break",30);case 18:return t.next=20,this.executeUseSkill(e);case 20:return r=t.sent,t.abrupt("break",30);case 22:return t.next=24,this.executeUseCard(e);case 24:return r=t.sent,t.abrupt("break",30);case 26:return t.next=28,this.executeIdle(e);case 28:return r=t.sent,t.abrupt("break",30);case 30:return this.m_actionState=r.success?u.COMPLETED:u.FAILED,t.abrupt("return",r);case 34:return t.prev=34,t.t1=t.catch(6),console.error("[RoleAction] 行为执行异常:",t.t1),this.m_actionState=u.FAILED,t.abrupt("return",this.createFailResult(t.t1.toString(),e.type));case 39:return t.prev=39,this.finishAction(),t.finish(39);case 42:case"end":return t.stop()}}),t,this,[[6,34,39,42]])})));return function(e){return t.apply(this,arguments)}}(),i.finishAction=function(){var t=Date.now()-this.m_actionStartTime;this.emit("action-end",{actionType:this.m_currentAction,actionState:this.m_actionState,duration:t,role:this.m_role}),this.m_isExecuting=!1,this.m_currentAction=c.IDLE,this.m_actionState=u.READY,this.m_role&&this.m_role.setState(a.IDLE),this.processNextAction()},i.executeMove=function(){var t=r(n().mark((function t(e){var r;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.m_role){t.next=2;break}return t.abrupt("return",this.createFailResult("角色不存在",c.MOVE));case 2:if(r=e.data){t.next=5;break}return t.abrupt("return",this.createFailResult("移动参数无效",c.MOVE));case 5:if(t.prev=5,this.m_role.canMove()){t.next=8;break}return t.abrupt("return",this.createFailResult("角色当前无法移动",c.MOVE));case 8:return t.next=10,this.m_role.moveTo(r);case 10:if(!t.sent){t.next=15;break}return t.abrupt("return",this.createSuccessResult("移动完成",c.MOVE,{fromTileId:this.m_role.getCurrentTileId(),toTileId:r.targetTileId,steps:r.steps}));case 15:return t.abrupt("return",this.createFailResult("移动失败",c.MOVE));case 16:t.next=21;break;case 18:return t.prev=18,t.t0=t.catch(5),t.abrupt("return",this.createFailResult("移动异常: "+t.t0,c.MOVE));case 21:case"end":return t.stop()}}),t,this,[[5,18]])})));return function(e){return t.apply(this,arguments)}}(),i.executeInteract=function(){var t=r(n().mark((function t(e){var r,i,a;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=e.target,a=(null==(r=e.data)?void 0:r.type)||"default",console.log("[RoleAction] 执行交互: "+a),t.next=5,this.delay(500);case 5:return t.abrupt("return",this.createSuccessResult("交互完成",c.INTERACT,{target:i,interactType:a}));case 6:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),i.executeUseSkill=function(){var t=r(n().mark((function t(e){var r,i,a;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=null==(r=e.data)?void 0:r.skillId,a=e.target,i){t.next=4;break}return t.abrupt("return",this.createFailResult("技能ID无效",c.USE_SKILL));case 4:return console.log("[RoleAction] 使用技能: "+i),t.next=7,this.delay(1e3);case 7:return t.abrupt("return",this.createSuccessResult("技能使用完成",c.USE_SKILL,{skillId:i,target:a}));case 8:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),i.executeUseCard=function(){var t=r(n().mark((function t(e){var r,i,a;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=null==(r=e.data)?void 0:r.cardIndex,a=e.target,!(void 0===i||i<0)){t.next=4;break}return t.abrupt("return",this.createFailResult("卡牌索引无效",c.USE_CARD));case 4:if(console.log("[RoleAction] 使用卡牌: "+i),!this.m_role){t.next=14;break}return t.next=8,this.m_role.useCard(i,a);case 8:if(!t.sent){t.next=13;break}return t.abrupt("return",this.createSuccessResult("卡牌使用完成",c.USE_CARD,{cardIndex:i,target:a}));case 13:return t.abrupt("return",this.createFailResult("卡牌使用失败",c.USE_CARD));case 14:return t.abrupt("return",this.createFailResult("角色不存在",c.USE_CARD));case 15:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),i.executeIdle=function(){var t=r(n().mark((function t(e){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.createSuccessResult("空闲",c.IDLE));case 1:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),i.enqueueAction=function(){var t=r(n().mark((function t(e){var r=this;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){var n={params:e,callback:t,createTime:Date.now(),priority:r.getActionPriority(e.type)};r.insertActionByPriority(n),console.log("[RoleAction] 行为加入队列: "+e.type)})));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),i.insertActionByPriority=function(t){for(var e=!1,r=0;r<this.m_actionQueue.length;r++)if(t.priority>this.m_actionQueue[r].priority){this.m_actionQueue.splice(r,0,t),e=!0;break}e||this.m_actionQueue.push(t)},i.processNextAction=function(){var t=r(n().mark((function t(){var e,r;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==this.m_actionQueue.length&&!this.m_isExecuting){t.next=2;break}return t.abrupt("return");case 2:return e=this.m_actionQueue.shift(),t.next=5,this.startAction(e.params);case 5:r=t.sent,e.callback&&e.callback(r);case 7:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),i.getActionPriority=function(t){switch(t){case c.USE_SKILL:return 10;case c.USE_CARD:return 9;case c.INTERACT:return 8;case c.MOVE:return 5;case c.IDLE:return 1;default:return 5}},i.clearQueue=function(){for(var t,r=e(this.m_actionQueue);!(t=r()).done;){var n=t.value;n.callback&&n.callback(this.createFailResult("行为被取消",n.params.type))}this.m_actionQueue.length=0,console.log("[RoleAction] 行为队列已清空")},i.cancelCurrentAction=function(){return!!this.m_isExecuting&&(this.m_actionState=u.CANCELLED,this.emit("action-cancelled",{actionType:this.m_currentAction,role:this.m_role}),this.finishAction(),console.log("[RoleAction] 当前行为已取消: "+this.m_currentAction),!0)},i.canInterrupt=function(){switch(this.m_currentAction){case c.MOVE:return!1;default:return!0}},i.checkTimeout=function(){if(!this.m_isExecuting)return!1;var t=Date.now()-this.m_actionStartTime;return t>this.m_actionTimeout&&(console.warn("[RoleAction] 行为超时: "+this.m_currentAction+", 耗时: "+t+"ms"),this.cancelCurrentAction(),!0)},i.updateRoleState=function(t){if(this.m_role)switch(t){case c.MOVE:this.m_role.setState(a.MOVING);break;case c.IDLE:default:this.m_role.setState(a.IDLE)}},i.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},i.createSuccessResult=function(t,e,r){return{success:!0,message:t,actionType:e,duration:Date.now()-this.m_actionStartTime,data:r}},i.createFailResult=function(t,e){return{success:!1,message:t,actionType:e,duration:Date.now()-this.m_actionStartTime}},i.getCurrentAction=function(){return this.m_currentAction},i.getActionState=function(){return this.m_actionState},i.isExecuting=function(){return this.m_isExecuting},i.getQueueLength=function(){return this.m_actionQueue.length},i.setActionTimeout=function(t){this.m_actionTimeout=Math.max(1e3,t)},i.setEnableQueue=function(t){this.m_enableQueue=t,t||this.clearQueue()},i.destroy=function(){this.clearQueue(),this.cancelCurrentAction(),this.unbindRole(),this.targetOff(),console.log("[RoleAction] 组件销毁完成")},i.debugInfo=function(){var t;return"[RoleAction] "+["当前行为: "+this.m_currentAction,"行为状态: "+this.m_actionState,"队列长度: "+this.m_actionQueue.length,"正在执行: "+this.m_isExecuting,"绑定角色: "+((null==(t=this.m_role)?void 0:t.getName())||"无")].join(", ")},t}());i._RF.pop()}}}));

System.register("chunks:///_virtual/RoleManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Player.ts","./NPC.ts","./Actor.ts","./RoleTypes.ts"],(function(e){var t,n,r,o,i,a,s,l,c,u,p,f,h,d,y,g,P;return{setters:[function(e){t=e.applyDecoratedDescriptor,n=e.inheritsLoose,r=e.initializerDefineProperty,o=e.assertThisInitialized,i=e.createForOfIteratorHelperLoose,a=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){l=e.cclegacy,c=e._decorator,u=e.EventTarget,p=e.Vec3,f=e.Component,h=e.instantiate},function(e){d=e.Player},function(e){y=e.NPC},function(e){g=e.Actor},function(e){P=e.NPCType}],execute:function(){var v,b,N,m,C,R,I,x,w,A,T,z,E,S;l._RF.push({},"2b977QUcp5Fc4dLdk/kPztN","RoleManager",void 0);var F=c.ccclass,M=c.property,_=function(){function e(e,t,n){void 0===n&&(n=10),this.pool=[],this.createFn=void 0,this.resetFn=void 0,this.maxSize=void 0,this.createFn=e,this.resetFn=t,this.maxSize=n}var t=e.prototype;return t.get=function(){return this.pool.length>0?this.pool.pop():this.createFn()},t.return=function(e){this.pool.length<this.maxSize?(this.resetFn(e),this.pool.push(e)):e.destroy()},t.clear=function(){this.pool.forEach((function(e){return e.destroy()})),this.pool=[]},t.getPoolSize=function(){return this.pool.length},e}(),L=e("RoleManager",(v=F("RoleManager"),b=M({displayName:"玩家预制体",tooltip:"玩家角色预制体"}),N=M({displayName:"NPC预制体列表",tooltip:"各类NPC预制体"}),m=M({displayName:"最大玩家数量",tooltip:"游戏中最大玩家数量"}),C=M({displayName:"NPC池大小",tooltip:"NPC对象池大小"}),R=M({displayName:"启用对象池",tooltip:"是否启用NPC对象池"}),v(((S=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return t=e.call.apply(e,[this].concat(i))||this,r(t,"playerPrefab",w,o(t)),r(t,"npcPrefabs",A,o(t)),r(t,"maxPlayers",T,o(t)),r(t,"npcPoolSize",z,o(t)),r(t,"enablePooling",E,o(t)),t.players=new Map,t.npcs=new Map,t.allRoles=new Map,t.npcPools=new Map,t.nextRoleId=1,t.nextPlayerId=1,t.nextNpcId=1e3,t.eventTarget=new u,t}n(t,e),t.getInstance=function(){return t._instance};var l=t.prototype;return l.onLoad=function(){null===t._instance?(t._instance=this,this.initializeObjectPools()):this.destroy()},l.onDestroy=function(){t._instance===this&&(t._instance=null),this.clearAllPools()},l.initializeObjectPools=function(){var e=this;if(this.enablePooling)for(var t,n=Object.values(P).filter((function(e){return"string"==typeof e})),r=function(){var n=t.value,r=new _((function(){return e.createNPCInstance(n)}),(function(t){return e.resetNPC(t)}),e.npcPoolSize);e.npcPools.set(n,r)},o=i(n);!(t=o()).done;)r()},l.createPlayer=function(){var e=a(s().mark((function e(t){var n,r,o,i;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.players.size>=this.maxPlayers)){e.next=3;break}return console.warn("已达到最大玩家数量限制"),e.abrupt("return",null);case 3:return e.prev=3,n=new d,r=t.roleId||this.generatePlayerId(),e.next=8,n.init(r,t);case 8:return e.next=10,this.createActorNode(this.playerPrefab);case 10:return(o=e.sent)&&(i=o.getComponent(g))&&(n.setActor(i),i.bindRole(n)),this.players.set(r,n),this.allRoles.set(r,n),this.eventTarget.dispatchEvent(new CustomEvent("player-created",{detail:{playerId:r,player:n}})),console.log("玩家创建成功: ID="+r+", Name="+n.getName()),e.abrupt("return",n);case 19:return e.prev=19,e.t0=e.catch(3),console.error("创建玩家失败:",e.t0),e.abrupt("return",null);case 23:case"end":return e.stop()}}),e,this,[[3,19]])})));return function(t){return e.apply(this,arguments)}}(),l.createNPC=function(){var e=a(s().mark((function e(t){var n,r,o,i,a,l;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.enablePooling&&this.npcPools.has(t.npcType)?(r=this.npcPools.get(t.npcType),n=r.get()):n=this.createNPCInstance(t.npcType),o=t.roleId||this.generateNpcId(),e.next=5,n.init(o,t);case 5:return i=this.getNPCPrefab(t.npcType),e.next=8,this.createActorNode(i);case 8:return(a=e.sent)&&(l=a.getComponent(g))&&(n.setActor(l),l.bindRole(n)),this.npcs.set(o,n),this.allRoles.set(o,n),this.eventTarget.dispatchEvent(new CustomEvent("npc-created",{detail:{npcId:o,npc:n}})),console.log("NPC创建成功: ID="+o+", Type="+t.npcType),e.abrupt("return",n);case 17:return e.prev=17,e.t0=e.catch(0),console.error("创建NPC失败:",e.t0),e.abrupt("return",null);case 21:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(t){return e.apply(this,arguments)}}(),l.destroyRole=function(e){var t=this.allRoles.get(e);if(!t)return!1;try{if(this.allRoles.delete(e),t instanceof d)this.players.delete(e),this.eventTarget.dispatchEvent(new CustomEvent("player-destroyed",{detail:{playerId:e}}));else if(t instanceof y){if(this.npcs.delete(e),this.enablePooling){var n=t.getNPCType(),r=this.npcPools.get(n);if(r)return r.return(t),!0}this.eventTarget.dispatchEvent(new CustomEvent("npc-destroyed",{detail:{npcId:e}}))}return t.destroy(),!0}catch(e){return console.error("销毁角色失败:",e),!1}},l.getPlayer=function(e){return this.players.get(e)||null},l.getNPC=function(e){return this.npcs.get(e)||null},l.getRole=function(e){return this.allRoles.get(e)||null},l.getAllPlayers=function(){return Array.from(this.players.values())},l.getAllNPCs=function(){return Array.from(this.npcs.values())},l.getNPCsByType=function(e){return this.getAllNPCs().filter((function(t){return t.getNPCType()===e}))},l.getAllRoles=function(){return Array.from(this.allRoles.values())},l.getRolesByPosition=function(e,t){return void 0===t&&(t=1),this.getAllRoles().filter((function(n){var r=n.getActor();return!!r&&p.distance(r.node.position,e)<=t}))},l.getRolesByTileIndex=function(e){return this.getAllRoles().filter((function(t){return t.getCurrentTileIndex()===e}))},l.clearAllRoles=function(){for(var e,t=i(this.allRoles);!(e=t()).done;){var n=e.value[0];this.destroyRole(n)}this.clearAllPools(),this.nextRoleId=1,this.nextPlayerId=1,this.nextNpcId=1e3},l.getStats=function(){for(var e,t={},n=i(this.npcPools);!(e=n()).done;){var r=e.value,o=r[0],a=r[1];t[o]=a.getPoolSize()}return{totalRoles:this.allRoles.size,players:this.players.size,npcs:this.npcs.size,poolStats:t}},l.addEventListener=function(e,t){this.eventTarget.addEventListener(e,t)},l.removeEventListener=function(e,t){this.eventTarget.removeEventListener(e,t)},l.createNPCInstance=function(e){return new y},l.resetNPC=function(e){e.reset()},l.createActorNode=function(){var e=a(s().mark((function e(t){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:return e.prev=2,(n=h(t)).getComponent(g)||n.addComponent(g),e.abrupt("return",n);case 8:return e.prev=8,e.t0=e.catch(2),console.error("创建Actor节点失败:",e.t0),e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,null,[[2,8]])})));return function(t){return e.apply(this,arguments)}}(),l.getNPCPrefab=function(e){return this.npcPrefabs.length>0?this.npcPrefabs[0]:null},l.generatePlayerId=function(){return this.nextPlayerId++},l.generateNpcId=function(){return this.nextNpcId++},l.clearAllPools=function(){for(var e,t=i(this.npcPools.values());!(e=t()).done;){e.value.clear()}this.npcPools.clear()},t}(f))._instance=null,w=t((x=S).prototype,"playerPrefab",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A=t(x.prototype,"npcPrefabs",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T=t(x.prototype,"maxPlayers",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),z=t(x.prototype,"npcPoolSize",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),E=t(x.prototype,"enablePooling",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I=x))||I));e("roleManager",{get instance(){return L.getInstance()}});l._RF.pop()}}}));

System.register("chunks:///_virtual/RoleTypes.ts",["cc"],(function(e){var r;return{setters:[function(e){r=e.cclegacy}],execute:function(){r._RF.push({},"c10fe614iNFRpwnNDIM2K+3","RoleTypes",void 0);var t=e("RoleType",function(e){return e[e.PLAYER=1]="PLAYER",e[e.NPC=4]="NPC",e[e.BUILDING=5]="BUILDING",e}({})),n=e("RoleAttribute",function(e){return e[e.MONEY=0]="MONEY",e[e.HP=1]="HP",e[e.MOVE_SPEED=2]="MOVE_SPEED",e[e.LUCK=3]="LUCK",e[e.POSITION=4]="POSITION",e[e.TURN_ORDER=5]="TURN_ORDER",e[e.VIP_LEVEL=6]="VIP_LEVEL",e[e.EXPERIENCE=7]="EXPERIENCE",e[e.LEVEL=8]="LEVEL",e[e.PROPERTIES_COUNT=10]="PROPERTIES_COUNT",e[e.CARDS_COUNT=11]="CARDS_COUNT",e[e.BANKRUPT=13]="BANKRUPT",e[e.MAX=20]="MAX",e}({})),u=e("NPCType",function(e){return e.FORTUNE="fortune",e.BOMB="bomb",e.ANGEL="angel",e.DEVIL="devil",e.BANKER="banker",e.THIEF="thief",e}({}));e("RoleState",function(e){return e.IDLE="idle",e.MOVING="moving",e.THINKING="thinking",e.BANKRUPT="bankrupt",e.WINNER="winner",e}({})),e("RoleTypeUtils",function(){function e(){}return e.isPlayer=function(e){return e===t.PLAYER},e.isNPC=function(e){return e===t.NPC},e.isBuilding=function(e){return e===t.BUILDING},e.getTypeName=function(e){switch(e){case t.PLAYER:return"玩家";case t.NPC:return"NPC";case t.BUILDING:return"建筑";default:return"未知"}},e.getAttributeName=function(e){switch(e){case n.MONEY:return"金钱";case n.HP:return"生命值";case n.MOVE_SPEED:return"移动速度";case n.LUCK:return"幸运值";case n.POSITION:return"位置";case n.TURN_ORDER:return"回合顺序";case n.VIP_LEVEL:return"VIP等级";case n.LEVEL:return"等级";case n.PROPERTIES_COUNT:return"房产数量";case n.CARDS_COUNT:return"卡牌数量";default:return"未知属性"}},e.getNPCTypeName=function(e){switch(e){case u.FORTUNE:return"福神";case u.BOMB:return"炸弹";case u.ANGEL:return"天使";case u.DEVIL:return"恶魔";case u.BANKER:return"银行家";case u.THIEF:return"小偷";default:return"未知NPC"}},e}());r._RF.pop()}}}));

System.register("chunks:///_virtual/RollAndStepAction.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./EventTypes.ts"],(function(t){var e,n,r,s,i;return{setters:[function(t){e=t.asyncToGenerator,n=t.regeneratorRuntime},function(t){r=t.cclegacy},function(t){s=t.EventBus},function(t){i=t.EventTypes}],execute:function(){r._RF.push({},"fe463T1zolPW6r746VPnzYN","RollAndStepAction",void 0);var o=t("PlaybackState",function(t){return t.IDLE="idle",t.PLAYING="playing",t.PAUSED="paused",t.COMPLETED="completed",t.STOPPED="stopped",t}({}));t("RollAndStepAction",function(){function t(t,e,n){var r,s,i;this.event=void 0,this.session=void 0,this.state=o.IDLE,this.currentStepIndex=-1,this.config=void 0,this.callbacks={},this.playbackTimer=null,this.isExecutingStep=!1,this.event=t,this.session=e,this.config={stepDelay:null!=(r=null==n?void 0:n.stepDelay)?r:300,autoPlay:null==(s=null==n?void 0:n.autoPlay)||s,playbackSpeed:null!=(i=null==n?void 0:n.playbackSpeed)?i:1},console.log("[RollAndStepAction] Created:",{game:t.game,player:t.player,steps:t.steps.length,config:this.config})}var r=t.prototype;return r.play=function(){var t=e(n().mark((function t(){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.state!==o.PLAYING){t.next=3;break}return console.warn("[RollAndStepAction] Already playing"),t.abrupt("return");case 3:if(this.state!==o.COMPLETED){t.next=6;break}return console.warn("[RollAndStepAction] Already completed"),t.abrupt("return");case 6:return console.log("[RollAndStepAction] Starting playback"),this.state=o.PLAYING,s.emit(i.Game.ActionPlaybackStart,{action:this,event:this.event}),t.next=11,this.playbackLoop();case 11:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),r.pause=function(){this.state===o.PLAYING?(console.log("[RollAndStepAction] Paused"),this.state=o.PAUSED,this.playbackTimer&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),s.emit(i.Game.ActionPlaybackPaused,{action:this,currentStep:this.currentStepIndex})):console.warn("[RollAndStepAction] Not playing, cannot pause")},r.resume=function(){var t=e(n().mark((function t(){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.state===o.PAUSED){t.next=3;break}return console.warn("[RollAndStepAction] Not paused, cannot resume"),t.abrupt("return");case 3:return console.log("[RollAndStepAction] Resumed"),this.state=o.PLAYING,s.emit(i.Game.ActionPlaybackResumed,{action:this,currentStep:this.currentStepIndex}),t.next=8,this.playbackLoop();case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),r.skipCurrentStep=function(){this.state===o.PLAYING||this.state===o.PAUSED?console.log("[RollAndStepAction] Skipping step "+this.currentStepIndex):console.warn("[RollAndStepAction] Cannot skip, not in playback")},r.stop=function(){console.log("[RollAndStepAction] Stopped"),this.state=o.STOPPED,this.playbackTimer&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),s.emit(i.Game.ActionPlaybackStopped,{action:this,currentStep:this.currentStepIndex})},r.playbackLoop=function(){var t=e(n().mark((function t(){var e,r;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.state!==o.PLAYING){t.next=22;break}if(!(this.currentStepIndex>=this.event.steps.length-1)){t.next=5;break}return t.next=4,this.complete();case 4:return t.abrupt("return");case 5:return this.currentStepIndex++,e=this.event.steps[this.currentStepIndex],t.prev=7,t.next=10,this.executeStep(e,this.currentStepIndex);case 10:t.next=17;break;case 12:return t.prev=12,t.t0=t.catch(7),console.error("[RollAndStepAction] Error executing step "+this.currentStepIndex+":",t.t0),this.handleError(t.t0),t.abrupt("return");case 17:return r=this.config.stepDelay/this.config.playbackSpeed,t.next=20,this.delay(r);case 20:t.next=0;break;case 22:case"end":return t.stop()}}),t,this,[[7,12]])})));return function(){return t.apply(this,arguments)}}(),r.executeStep=function(){var t=e(n().mark((function t(e,r){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.isExecutingStep){t.next=3;break}return console.warn("[RollAndStepAction] Step already executing, skipping"),t.abrupt("return");case 3:if(this.isExecutingStep=!0,t.prev=4,console.log("[RollAndStepAction] Executing step "+r+":",e),!this.callbacks.onStepStart){t.next=9;break}return t.next=9,this.callbacks.onStepStart(e,r);case 9:if(s.emit(i.Game.ActionStepStart,{action:this,step:e,index:r}),e.pass_draws&&e.pass_draws.length>0&&(console.log("[RollAndStepAction] Pass draws:",e.pass_draws),s.emit(i.Game.CardDrawn,{cards:e.pass_draws,isPass:!0})),e.npc_event&&(console.log("[RollAndStepAction] NPC event:",e.npc_event),s.emit(i.Game.NPCInteraction,{npcEvent:e.npc_event})),e.stop_effect&&(console.log("[RollAndStepAction] Stop effect:",e.stop_effect),s.emit(i.Game.TileStopEffect,{stopEffect:e.stop_effect})),!this.callbacks.onStepComplete){t.next=16;break}return t.next=16,this.callbacks.onStepComplete(e,r);case 16:s.emit(i.Game.ActionStepComplete,{action:this,step:e,index:r});case 17:return t.prev=17,this.isExecutingStep=!1,t.finish(17);case 20:case"end":return t.stop()}}),t,this,[[4,,17,20]])})));return function(e,n){return t.apply(this,arguments)}}(),r.complete=function(){var t=e(n().mark((function t(){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[RollAndStepAction] Playback completed"),this.state=o.COMPLETED,!this.callbacks.onComplete){t.next=5;break}return t.next=5,this.callbacks.onComplete();case 5:s.emit(i.Game.ActionPlaybackComplete,{action:this,event:this.event});case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),r.handleError=function(t){console.error("[RollAndStepAction] Playback error:",t),this.state=o.STOPPED,this.callbacks.onError&&this.callbacks.onError(t),s.emit(i.Game.ActionPlaybackError,{action:this,error:t.message})},r.delay=function(t){var e=this;return new Promise((function(n){e.playbackTimer=setTimeout((function(){e.playbackTimer=null,n()}),t)}))},r.onStepStart=function(t){return this.callbacks.onStepStart=t,this},r.onStepComplete=function(t){return this.callbacks.onStepComplete=t,this},r.onComplete=function(t){return this.callbacks.onComplete=t,this},r.onError=function(t){return this.callbacks.onError=t,this},r.getEvent=function(){return this.event},r.getSession=function(){return this.session},r.getState=function(){return this.state},r.getCurrentStepIndex=function(){return this.currentStepIndex},r.getTotalSteps=function(){return this.event.steps.length},r.getProgress=function(){return 0===this.event.steps.length?0:(this.currentStepIndex+1)/this.event.steps.length},r.isPlaying=function(){return this.state===o.PLAYING},r.isCompleted=function(){return this.state===o.COMPLETED},t}());r._RF.pop()}}}));

System.register("chunks:///_virtual/RollAndStepEvent.ts",["cc"],(function(N){var n;return{setters:[function(N){n=N.cclegacy}],execute:function(){n._RF.push({},"debcct4nCVN1o9+nyO9Puim","RollAndStepEvent",void 0);N("NpcAction",function(N){return N[N.SPAWN=1]="SPAWN",N[N.REMOVE=2]="REMOVE",N[N.HIT=3]="HIT",N}({})),N("NpcResult",function(N){return N[N.NONE=0]="NONE",N[N.SEND_HOSPITAL=1]="SEND_HOSPITAL",N[N.BARRIER_STOP=2]="BARRIER_STOP",N}({})),N("StopType",function(N){return N[N.NONE=0]="NONE",N[N.BUILDING_TOLL=1]="BUILDING_TOLL",N[N.BUILDING_NO_RENT=2]="BUILDING_NO_RENT",N[N.HOSPITAL=3]="HOSPITAL",N[N.BONUS=5]="BONUS",N[N.FEE=6]="FEE",N[N.CARD_STOP=7]="CARD_STOP",N[N.BUILDING_UNOWNED=8]="BUILDING_UNOWNED",N}({})),N("CashReason",function(N){return N[N.TOLL=1]="TOLL",N[N.BUY=2]="BUY",N[N.UPGRADE=3]="UPGRADE",N[N.BONUS=4]="BONUS",N[N.FEE=5]="FEE",N[N.CARD=6]="CARD",N}({}));n._RF.pop()}}}));

System.register("chunks:///_virtual/RollAndStepHandler.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RollAndStepAction.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./UINotification.ts","./constants.ts"],(function(e){var n,t,r,o,s,l,a,i,c,u;return{setters:[function(e){n=e.asyncToGenerator,t=e.regeneratorRuntime,r=e.createForOfIteratorHelperLoose},function(e){o=e.cclegacy},function(e){s=e.RollAndStepAction},function(e){l=e.EventBus},function(e){a=e.EventTypes},function(e){i=e.Blackboard},function(e){c=e.UINotification},function(e){u=e.DecisionType}],execute:function(){o._RF.push({},"9cae50t2VFJiLpmSsNp+B5k","RollAndStepHandler",void 0);var d=e("RollAndStepHandler",function(){function e(){this.currentAction=null,this.currentSession=null,console.log("[RollAndStepHandler] Handler 创建")}e.getInstance=function(){return e._instance||(e._instance=new e),e._instance};var o=e.prototype;return o.initialize=function(){console.log("[RollAndStepHandler] 初始化事件监听")},o.handleEvent=function(){var e=n(t().mark((function e(r){var o,c,u=this;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[RollAndStepHandler] 收到 RollAndStepActionEvent",r),o=r.data,e.prev=2,this.currentSession=i.instance.get("currentGameSession"),this.currentSession){e.next=7;break}return console.warn("[RollAndStepHandler] GameSession not found"),e.abrupt("return");case 7:return l.emit(a.Dice.RollResult,{value:o.dice,source:"chain"}),console.log("[RollAndStepHandler] 发送骰子结果:",o.dice),e.next=11,this.updateGameSession(o);case 11:return(c=new s(o,this.currentSession,{stepDelay:400,autoPlay:!0,playbackSpeed:1})).onStepStart(n(t().mark((function e(n,r){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[RollAndStepHandler] Step "+r+" 开始",n),e.next=3,u.handleStepStart(n,r,o);case 3:case"end":return e.stop()}}),e)})))).onStepComplete(n(t().mark((function e(n,r){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[RollAndStepHandler] Step "+r+" 完成",n),e.next=3,u.handleStepComplete(n,r,o);case 3:case"end":return e.stop()}}),e)})))).onComplete(n(t().mark((function e(){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[RollAndStepHandler] 播放完成"),e.next=3,u.handlePlaybackComplete(o);case 3:case"end":return e.stop()}}),e)})))).onError((function(e){console.error("[RollAndStepHandler] 播放错误",e),u.handlePlaybackError(e,o)})),this.currentAction=c,e.next=16,c.play();case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(2),console.error("[RollAndStepHandler] 处理事件失败",e.t0);case 21:case"end":return e.stop()}}),e,this,[[2,18]])})));return function(n){return e.apply(this,arguments)}}(),o.updateGameSession=function(){var e=n(t().mark((function e(n){var r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[RollAndStepHandler] 更新 GameSession 数据"),r=this.currentSession,r.getPlayerByAddress(n.player)){e.next=6;break}return console.warn("[RollAndStepHandler] 玩家未找到",n.player),e.abrupt("return");case 6:console.log("[RollAndStepHandler] 更新玩家位置",{from:n.from,to:n.end_pos,dice:n.dice,steps:n.steps.length});case 7:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),o.handleStepStart=function(){var e=n(t().mark((function e(n,r,o){var s,l,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this.currentSession,l=s.getPlayerByAddress(o.player)){e.next=4;break}return e.abrupt("return");case 4:return a=s.getTileWorldCenter(n.to_tile),e.prev=5,e.next=8,l.moveTo({targetTileId:n.to_tile,steps:1,path:[n.to_tile],targetPosition:a,playerIndex:l.getPlayerIndex()});case 8:console.log("[RollAndStepHandler] 玩家移动完成: "+n.from_tile+" -> "+n.to_tile),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(5),console.error("[RollAndStepHandler] 玩家移动失败",e.t0);case 14:case"end":return e.stop()}}),e,this,[[5,11]])})));return function(n,t,r){return e.apply(this,arguments)}}(),o.handleStepComplete=function(){var e=n(t().mark((function e(n,o,s){var l,a,i,u,d,p,f,g,h;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(l=this.currentSession,(a=l.getPlayerByAddress(s.player))&&(a.setPos(n.to_tile),console.log("[RollAndStepHandler] 玩家位置已更新: "+n.from_tile+" -> "+n.to_tile)),n.stop_effect&&console.log("[RollAndStepHandler] 处理停留效果",n.stop_effect),n.npc_event&&(console.log("[RollAndStepHandler] 处理 NPC 交互",n.npc_event),i=this._getNpcEventDescription(n.npc_event),c.info(i,"NPC事件"),n.npc_event.consumed&&((u=this.currentSession).removeNPC(n.npc_event.tile_id),(d=u.getGameMap())&&d.removeNPCActor&&d.removeNPCActor(n.npc_event.tile_id),console.log("[RollAndStepHandler] NPC 已消耗并删除:",n.npc_event.tile_id))),n.pass_draws&&n.pass_draws.length>0&&(console.log("[RollAndStepHandler] 处理路过卡牌",n.pass_draws),a)){for(p=r(n.pass_draws);!(f=p()).done;)g=f.value,a.addCard(g.kind,g.count);h=n.pass_draws.map((function(e){return"卡牌"+e.kind+" x"+e.count})).join(", "),c.info("获得: "+h,"卡牌")}case 6:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}(),o.handlePlaybackComplete=function(){var e=n(t().mark((function e(n){var o,s,i,u,d,p,f,g,h,_,y,S,v,A;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[RollAndStepHandler] 所有步骤播放完成"),!(o=this.currentSession)){e.next=8;break}if(n.game===o.getGameId()){e.next=6;break}return console.warn("[RollAndStepHandler] Event game mismatch, ignoring",{eventGame:n.game,currentGame:o.getGameId()}),e.abrupt("return");case 6:o.setRound(n.round),console.log("[RollAndStepHandler] Round 已同步（from event）",{round:n.round,turn_will_be:n.turn_in_round});case 8:if(n.cash_changes&&n.cash_changes.length>0)for(console.log("[RollAndStepHandler] 处理现金变动",n.cash_changes),s=r(n.cash_changes);!(i=s()).done;)u=i.value,(d=o.getPlayerByAddress(u.player))&&(f=BigInt(u.amount),g=u.is_debit?d.getCash()-f:d.getCash()+f,d.setCash(g),(h=null==(p=this.currentSession)?void 0:p.getMyPlayer())&&d===h&&(_=u.is_debit?"-"+f:"+"+f,c.info(_,void 0,2e3,"center"),console.log("[RollAndStepHandler] 显示现金变动:",_)),console.log("[RollAndStepHandler] 玩家现金已更新",{player:u.player,isDebit:u.is_debit,amount:f.toString(),newCash:g.toString(),reason:u.reason}));if(!(y=n.steps[n.steps.length-1])||!y.stop_effect){e.next=15;break}if(!(S=y.stop_effect).building_decision){e.next=15;break}return e.next=15,this._handleBuildingUpdate(S.building_decision,n.player,o);case 15:return y&&y.stop_effect&&(v=y.stop_effect,(A=o.getPlayerByAddress(n.player))&&null!==v.turns&&void 0!==v.turns&&3===v.stop_type&&(A.setInHospitalTurns(v.turns),console.log("[RollAndStepHandler] 玩家进入医院",{player:n.player,turns:v.turns}))),this.currentAction=null,l.emit(a.Game.PlayerMove,{player:n.player,from:n.from,to:n.end_pos,steps:n.steps.length}),e.next=20,this._handleTeleportIfNeeded(n);case 20:return e.next=22,this._handleDecisionIfNeeded(n);case 22:if(!o){e.next=26;break}return e.next=25,o.advance_turn(n.turn_in_round);case 25:console.log("[RollAndStepHandler] Turn 已同步（from event）",{round:n.round,turn:n.turn_in_round});case 26:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),o._handleTeleportIfNeeded=function(){var e=n(t().mark((function e(n){var r,o,s,l;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=n.steps[n.steps.length-1])&&r.to_tile!==n.end_pos){e.next=3;break}return e.abrupt("return");case 3:if(console.log("[RollAndStepHandler] 检测到玩家瞬移",{lastTile:r.to_tile,endPos:n.end_pos,reason:"遇到炸弹/恶犬等 NPC"}),o=this.currentSession,!(s=o.getPlayerByAddress(n.player))){e.next=12;break}return s.setPos(n.end_pos,!1),l=o.getTileWorldCenter(n.end_pos),e.next=11,s.moveTo({targetTileId:n.end_pos,steps:0,targetPosition:l,teleport:!0});case 11:console.log("[RollAndStepHandler] 玩家已瞬移到:",n.end_pos);case 12:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),o.handlePlaybackError=function(e,n){console.error("[RollAndStepHandler] 播放错误",e,n),this.currentAction=null},o.getCurrentAction=function(){return this.currentAction},o.isPlaying=function(){return null!==this.currentAction&&this.currentAction.isPlaying()},o.stopCurrentAction=function(){this.currentAction&&(this.currentAction.stop(),this.currentAction=null)},o._handleDecisionIfNeeded=function(){var e=n(t().mark((function e(n){var r,o,s,l;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.steps[n.steps.length-1],(o=null==r?void 0:r.stop_effect)&&void 0!==o.pending_decision&&o.pending_decision!==u.NONE){e.next=4;break}return e.abrupt("return");case 4:if(console.log("[RollAndStepHandler] 检测到待决策",{decisionType:o.pending_decision,amount:o.decision_amount}),s=this.currentSession,l=s.getMyPlayer()){e.next=10;break}return console.warn("[RollAndStepHandler] My player not found, skip decision UI"),e.abrupt("return");case 10:if(s.getPlayerByAddress(n.player)===l){e.next=14;break}return console.log("[RollAndStepHandler] Not my turn, skip decision UI",{eventPlayer:n.player,myPlayer:l.getOwner()}),e.abrupt("return");case 14:if(s.getActivePlayer()){e.next=18;break}return console.warn("[RollAndStepHandler] Active player not found"),e.abrupt("return");case 18:s.setPendingDecision({type:o.pending_decision,tileId:o.decision_tile,amount:BigInt(o.decision_amount)}),console.log("[RollAndStepHandler] 已设置待决策状态，UIInGame 将显示对话框",{type:o.pending_decision,tileId:o.decision_tile,amount:o.decision_amount.toString()});case 20:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),o._handleBuildingUpdate=function(){var e=n(t().mark((function e(n,r,o){var s,l,a,i,c,u;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(l=o.getPlayerByAddress(r)){e.next=4;break}return console.warn("[RollAndStepHandler] Player not found for building update"),e.abrupt("return");case 4:a=n.building_id,i=l.getPlayerIndex(),c=n.new_level,u=n.building_type,console.log("[RollAndStepHandler] 更新建筑状态（from building_decision）",{buildingId:a,owner:i,level:c,buildingType:u,decisionType:n.decision_type,amount:(null==(s=n.amount)?void 0:s.toString())||"N/A",tileId:n.tile_id}),o.updateBuilding(a,i,c,u),console.log("[RollAndStepHandler] 建筑状态已更新");case 11:case"end":return e.stop()}}),e)})));return function(n,t,r){return e.apply(this,arguments)}}(),o._getNpcEventDescription=function(e){var n=this._getNpcKindName(e.kind),t=1,r=2;return e.result===t?"遇到"+n+"！被送往医院":e.result===r?"遇到"+n+"！前进受阻":"遇到"+n},o._getNpcKindName=function(e){switch(e){case 20:return"路障";case 21:return"炸弹";case 22:return"恶犬";case 23:return"土地神";case 24:return"财神";case 25:return"福神";case 26:return"穷神";default:return"NPC"}},o.destroy=function(){this.stopCurrentAction(),this.currentSession=null,e._instance=null,console.log("[RollAndStepHandler] Handler 销毁")},e}());d._instance=null;e("rollAndStepHandler",{get instance(){return d.getInstance()}});o._RF.pop()}}}));

System.register("chunks:///_virtual/RotorRouter.ts",["cc","./WalkingPreference.ts"],(function(t){var e,r,o,i,n;return{setters:[function(t){e=t.cclegacy},function(t){r=t.INVALID_TILE_ID,o=t.Direction,i=t.NextDirectionCW,n=t.createRotorRouterHistory}],execute:function(){e._RF.push({},"e6f1erVJfpPt6BDzsPA4r2v","RotorRouter",void 0);t("RotorRouter",function(){function t(t,e){this.history=void 0,this.template=void 0,this.template=t,this.history=e||n()}var e=t.prototype;return e.getNextTile=function(t,e){var n,s;void 0===e&&(e=r);var l=this.template.tiles_static.get(t);if(!l)return console.warn("[RotorRouter] Tile "+t+" not found in template"),r;for(var u=((n={})[o.WEST]=l.w,n[o.NORTH]=l.n,n[o.EAST]=l.e,n[o.SOUTH]=l.s,n),c=null!=(s=this.history.lastDirection.get(t))?s:o.WEST,a=i[c],h=0;h<4;){var g=u[a];if(g!==r&&(e===r||g!==e))return this.history.lastDirection.set(t,a),g;a=i[a],h++}return console.warn("[RotorRouter] No valid neighbor found for tile "+t),r},e.calculatePath=function(t,e,o){void 0===o&&(o=r);var i=[],n=new Map,s=[],l=t,u=o;for(n.set(t,1);i.length<e;){var c=this.getValidNeighbors(l,u);if(0===c.length){if(s.length>0){var a=s.pop();i.splice(a.pathLength),l=a.tile,u=a.prevTile,console.log("[RotorRouter] 回溯到分叉点: tile "+l+", path length "+i.length);continue}console.warn("[RotorRouter] 无法继续，返回 "+i.length+" 步");break}c.length>1&&s.push({tile:l,prevTile:u,pathLength:i.length});var h=this.selectBestNeighbor(c,n);i.push(h),n.set(h,(n.get(h)||0)+1),u=l,l=h}return i},e.getValidNeighbors=function(t,e){var o=this.template.tiles_static.get(t);if(!o)return[];for(var i=[],n=0,s=[o.w,o.n,o.e,o.s];n<s.length;n++){var l=s[n];l!==r&&l!==e&&i.push(l)}return i},e.selectBestNeighbor=function(t,e){return t.sort((function(t,r){return(e.get(t)||0)-(e.get(r)||0)})),t[0]},e.getHistory=function(){return this.history},e.resetHistory=function(){this.history.lastDirection.clear()},e.debugHistory=function(){console.log("[RotorRouter] History:",{recordCount:this.history.lastDirection.size,records:Array.from(this.history.lastDirection.entries()).map((function(t){var e=t[0],r=t[1];return{tile:e,direction:o[r]}}))})},t}());e._RF.pop()}}}));

System.register("chunks:///_virtual/RpcConfigManager.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(o){var t,e;return{setters:[function(o){t=o.extends},function(o){e=o.cclegacy}],execute:function(){e._RF.push({},"60c47OcNyRO96XBb0dkcbfe","RpcConfigManager",void 0);var n={default:{eventIndexer:1e3,dataPolling:2e3},ratelimit:{eventIndexer:2e3,dataPolling:5e3}},i=o("RpcConfigManager",function(){function o(){}return o.load=function(){if(!this.loaded){try{var o=localStorage.getItem(this.STORAGE_KEY);if(o){var t=JSON.parse(o);this.config={mode:t.mode||"default",customRpcUrl:t.customRpcUrl},console.log("[RpcConfig] Loaded from localStorage:",this.config)}else console.log("[RpcConfig] No stored config, using defaults")}catch(o){console.error("[RpcConfig] Failed to load config:",o)}this.loaded=!0}},o.save=function(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.config)),console.log("[RpcConfig] Saved to localStorage:",this.config)}catch(o){console.error("[RpcConfig] Failed to save config:",o)}},o.setMode=function(o){this.load(),this.config.mode=o,this.save(),console.log("[RpcConfig] Mode set to:",o)},o.setCustomRpc=function(o){this.load(),this.config.customRpcUrl=o,this.save(),console.log("[RpcConfig] Custom RPC set to:",o||"none")},o.getMode=function(){return this.load(),this.config.mode},o.getCustomRpcUrl=function(){return this.load(),this.config.customRpcUrl},o.getEventIndexerInterval=function(){return this.load(),n[this.config.mode].eventIndexer},o.getDataPollingInterval=function(){return this.load(),n[this.config.mode].dataPolling},o.getConfig=function(){return this.load(),t({},this.config)},o.reset=function(){this.config={mode:"default"},this.save(),console.log("[RpcConfig] Reset to defaults")},o}());i.STORAGE_KEY="sui_rpc_config",i.config={mode:"default"},i.loaded=!1,e._RF.pop()}}}));

System.register("chunks:///_virtual/SignerProvider.ts",["cc"],(function(){var e;return{setters:[function(r){e=r.cclegacy}],execute:function(){e._RF.push({},"d3537cqe8pC+JNefvTxbxGZ","SignerProvider",void 0),e._RF.pop()}}}));

System.register("chunks:///_virtual/SkipTurnHandler.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Blackboard.ts","./UINotification.ts","./IdFormatter.ts"],(function(n){var e,r,t,a,i,u;return{setters:[function(n){e=n.asyncToGenerator,r=n.regeneratorRuntime},function(n){t=n.cclegacy},function(n){a=n.Blackboard},function(n){i=n.UINotification},function(n){u=n.IdFormatter}],execute:function(){t._RF.push({},"00000000-0000-0000-0000-skip-turn-hdlr","SkipTurnHandler",void 0);var s=n("SkipTurnHandler",function(){function n(){}return n.getInstance=function(){return n._instance||(n._instance=new n),n._instance},n.prototype.handleEvent=function(){var n=e(r().mark((function n(e){var t,s,o,c;return r().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=e.data,!(s=a.instance.get("currentGameSession"))){n.next=8;break}return s.setRound(t.round),n.next=6,s.advance_turn(t.turn);case 6:(o=s.getPlayerByAddress(t.player))&&null!==t.remaining_turns&&void 0!==t.remaining_turns&&(o.setInHospitalTurns(t.remaining_turns),console.log("[SkipTurnHandler] 更新医院剩余回合",{player:t.player,remainingTurns:t.remaining_turns}));case 8:c=u.shortenAddress(t.player),i.info("玩家 "+c+" 在医院，还需休息 "+t.remaining_turns+" 天","跳过回合");case 10:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),n}());s._instance=null;n("skipTurnHandler",{get instance(){return s.getInstance()}});t._RF.pop()}}}));

System.register("chunks:///_virtual/SuiConfig.ts",["cc"],(function(t){var e;return{setters:[function(t){e=t.cclegacy}],execute:function(){t({fromEnvConfig:function(t){return{network:t.network,packageId:t.packageId,gameDataId:t.gameData,adminCapId:t.adminCap,upgradeCapId:t.upgradeCap,signerType:t.signerType}},getExplorerUrl:n,getFallbackExplorerUrl:function(t,e,r){void 0===r&&(r="object");var i=t;if("localnet"===i)return n(t,e,r);return"https://suiscan.xyz/"+("mainnet"===i?"mainnet":i)+"/"+r+"/"+e},getNetworkDisplayName:function(t){return{localnet:"Localnet",devnet:"Devnet",testnet:"Testnet",mainnet:"Mainnet"}[t]||t},getNetworkRpcUrl:function(t,e){if(e)return e;switch(t){case"localnet":return"http://127.0.0.1:9000";case"testnet":return"https://fullnode.testnet.sui.io:443";case"mainnet":return"https://fullnode.mainnet.sui.io:443";case"devnet":return"https://fullnode.devnet.sui.io:443";default:if(t.startsWith("http"))return t;throw new Error("Unknown network: "+t)}}}),e._RF.push({},"89cc4QvvElCVLyW0EixDZOv","SuiConfig",void 0);t("DEFAULT_RANDOM_OBJECT_ID","0x8"),t("DEFAULT_CLOCK_OBJECT_ID","0x6");function n(t,e,n){void 0===n&&(n="object");var r=t;if("localnet"===r){return"txblock"===n&&(n="tx"),"https://custom.suiscan.xyz/custom/"+n+"/"+e+"?network="+encodeURIComponent("http://127.0.0.1:9000")}return"https://"+("mainnet"===r?"":r+".")+"suivision.xyz/"+n+"/"+e}e._RF.pop()}}}));

System.register("chunks:///_virtual/SuiEnvConfigManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./SuiConfig.ts","./env.mainnet.ts","./env.testnet.ts","./env.devnet.ts","./env.localnet.ts"],(function(n){var e,t,o,i,r,a,c,s;return{setters:[function(n){e=n.extends,t=n.createClass},function(n){o=n.cclegacy},function(n){i=n.fromEnvConfig},function(n){r=n.SuiEnvConfig},function(n){a=n.SuiEnvConfig},function(n){c=n.SuiEnvConfig},function(n){s=n.SuiEnvConfig}],execute:function(){o._RF.push({},"edd3bB1avtMjqueorRPqOQz","SuiEnvConfigManager",void 0);var u=n("SuiEnvConfigManager",function(){function n(){}var o=n.prototype;return o.load=function(){try{var t=localStorage.getItem(n.STORAGE_KEY);if(t){var o=JSON.parse(t);return console.log("[SuiEnvConfigManager] 从 localStorage 加载配置:",o),o}}catch(n){console.error("[SuiEnvConfigManager] 加载配置失败:",n)}return console.log("[SuiEnvConfigManager] 使用默认配置:",n.DEFAULT_CONFIG),e({},n.DEFAULT_CONFIG)},o.save=function(e,t){var o={network:e,signerType:t};try{localStorage.setItem(n.STORAGE_KEY,JSON.stringify(o)),console.log("[SuiEnvConfigManager] 配置已保存:",o)}catch(n){console.error("[SuiEnvConfigManager] 保存配置失败:",n)}},o.clear=function(){localStorage.removeItem(n.STORAGE_KEY),console.log("[SuiEnvConfigManager] 配置已清除")},o.getConfig=function(n,e){var t;switch(n){case"mainnet":t=r;break;case"testnet":t=a;break;case"devnet":t=c;break;case"localnet":t=s;break;default:console.warn("[SuiEnvConfigManager] 未知网络: "+n+", 使用 testnet"),t=a}var o=i(t);return o.signerType=e,o},o.loadAndGetConfig=function(){var n=this.load();return this.getConfig(n.network,n.signerType)},o.getSummary=function(){return this.load()},o.isUsingDefaults=function(){var e=this.load();return e.network===n.DEFAULT_CONFIG.network&&e.signerType===n.DEFAULT_CONFIG.signerType},t(n,null,[{key:"instance",get:function(){return n._instance||(n._instance=new n),n._instance}}]),n}());u._instance=null,u.STORAGE_KEY="web3_tycoon_sui_env_config",u.DEFAULT_CONFIG={network:"testnet",signerType:"wallet"};n("suiEnvConfigManager",u.instance);o._RF.pop()}}}));

System.register("chunks:///_virtual/SuiErrorTranslator.ts",["cc"],(function(r){var e;return{setters:[function(r){e=r.cclegacy}],execute:function(){e._RF.push({},"13919hbpZ1AUbPpwrkxQ/xP","SuiErrorTranslator",void 0);var n={1001:"不是当前活跃玩家",1002:"本回合已经掷过骰子",1003:"游戏不匹配",1004:"游戏未开始",1005:"还未掷骰子",1006:"找不到玩家",2001:"地块被 NPC 占据",2002:"NPC 不存在",2003:"位置不匹配",2004:"不是建筑地块",2005:"建筑已被拥有",2006:"建筑未被拥有",2007:"不是建筑拥有者",2008:"无效的价格",2009:"已达到最大等级",2010:"现金不足",3003:"地块已存在",3010:"地块 ID 超过最大值",3011:"地块 ID 必须连续",3012:"无效的下一个地块 ID",3013:"目标地块不存在",3021:"不支持的 schema 版本",4001:"无效的移动",4002:"路径长度不足骰子值",4003:"非法路径：包含非邻居关系或回头路",5001:"不拥有此卡牌",5002:"手牌已满",5003:"无效的卡牌目标",5004:"卡牌不存在",5005:"参数无效",5006:"无法使用转向卡（可能在初始位置）",6001:"游戏已满员",6002:"游戏已开始",6003:"游戏已结束",6004:"玩家数量不足",6005:"已经加入游戏",6006:"无效的决策",6007:"存在待决策",6008:"当前状态不应跳过回合",7001:"资金不足",7002:"建筑已被拥有",7003:"不是建筑拥有者",7004:"已达到最大等级",7010:"不是 2x2 建筑",7011:"建筑类型已设置",7012:"无效的建筑类型",7013:"建筑已升级，无法选择类型",7014:"建筑不存在",8001:"NPC 生成池索引越界",8002:"地块索引越界",9001:"地图不匹配"};r("SuiErrorTranslator",function(){function r(){}return r.extractMoveErrorCode=function(r){var e=String(r).match(/MoveAbort\([\s\S]*,\s*(\d+)\)/);return e&&e[1]?parseInt(e[1],10):null},r.translateErrorCode=function(r){return n[r]||"未知错误 (错误码: "+r+")"},r.translate=function(r){var e=this.extractMoveErrorCode(r);if(null!==e)return{code:e,message:this.translateErrorCode(e),isMoveError:!0,originalError:r};var n=r instanceof Error?r.message:String(r);return{code:null,message:this.formatGenericError(n),isMoveError:!1,originalError:r}},r.formatGenericError=function(r){return(r=r.replace(/^Error:\s*/i,"")).includes("Dry run failed")?"交易模拟失败，请检查参数和余额":r.includes("Insufficient gas")?"Gas 不足，请充值 SUI":r.includes("Transaction failed")?"交易失败":r.includes("签名")?"用户取消签名":r.includes("Not connected")||r.includes("No signer")?"钱包未连接":r.length>100?r.substring(0,100)+"...":r},r.getDetailedError=function(r){var e=this.translate(r);return e.isMoveError&&null!==e.code?"Move 错误 ["+e.code+"]: "+e.message:"错误: "+e.message},r.isErrorCode=function(r,e){return this.extractMoveErrorCode(r)===e},r.isMoveError=function(r){return null!==this.extractMoveErrorCode(r)},r}());e._RF.pop()}}}));

System.register("chunks:///_virtual/SuiManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./loader.ts","./index7.ts","./RpcConfigManager.ts","./index2.ts","./index9.ts","./mapAdmin.ts","./index4.ts","./indexer.ts","./types2.ts","./constants.ts","./assets.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./UINotification.ts","./UIMessage.ts","./KeystoreLoader.ts","./RollAndStepHandler.ts","./BuildingDecisionHandler.ts","./RentDecisionHandler.ts","./DecisionSkippedHandler.ts","./SkipTurnHandler.ts","./BankruptHandler.ts","./GameEndedHandler.ts","./WalletSigner.ts","./KeypairSigner.ts","./AssetService.ts","./SuiConfig.ts","./QueryService.ts","./DataPollingService.ts","./game2.ts"],(function(e){var t,n,r,a,s,i,o,c,u,l,d,g,h,p,_,m,f,v,S,y,x,M,I,w,b,k,G,A,E,T,C,D,P,N,R,B,U,z;return{setters:[function(e){t=e.createForOfIteratorHelperLoose,n=e.asyncToGenerator,r=e.regeneratorRuntime,a=e.extends,s=e.createClass},function(e){i=e.cclegacy},function(e){o=e.loadSuiClient},null,function(e){c=e.RpcConfigManager},null,function(e){u=e.TycoonGameClient,l=e.initInteractions},function(e){d=e.MapAdminInteraction,g=e.initMapAdminInteraction},null,function(e){h=e.TycoonEventIndexer},function(e){p=e.EventType},function(e){_=e.GameStatus},function(e){m=e.PlayerAssets},function(e){f=e.EventBus},function(e){v=e.EventTypes},function(e){S=e.Blackboard},function(e){y=e.UINotification},function(e){x=e.UIMessage},function(e){M=e.loadKeypairFromKeystore},function(e){I=e.rollAndStepHandler},function(e){w=e.buildingDecisionHandler},function(e){b=e.rentDecisionHandler},function(e){k=e.decisionSkippedHandler},function(e){G=e.skipTurnHandler},function(e){A=e.bankruptHandler},function(e){E=e.gameEndedHandler},function(e){T=e.WalletSigner},function(e){C=e.KeypairSigner},function(e){D=e.AssetService},function(e){P=e.getExplorerUrl,N=e.getNetworkDisplayName,R=e.getNetworkRpcUrl},function(e){B=e.QueryService},function(e){U=e.DataPollingService},function(e){z=e.initGameInteraction}],execute:function(){i._RF.push({},"bb688AmgcVPoIBPhsdrkKMU","SuiManager",void 0);var H=e("SuiManager",function(){function e(){this._client=null,this._signer=null,this._gameClient=null,this._mapAdmin=null,this._queryService=null,this._assetService=null,this._pollingService=null,this._config=null,this._options={},this._initialized=!1,this._currentAddress=null,this._currentSeat=null,this._cachedGameData=null,this._cachedGames=[],this._cachedMapTemplates=[],this._cacheTimestamp=0,this._playerAssets=null,this._lastPublishedTemplateId=null,this._currentGame=null,this._eventIndexer=null,this._gameEventHandlers=new Map,this._preloadStarted=!1,this._preloadCompleted=!1}var i=e.prototype;return i.init=function(){var e=n(r().mark((function e(t,n){var s,i,h,p;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._initialized){e.next=3;break}return console.warn("[SuiManager] Already initialized"),e.abrupt("return");case 3:return this._config=t,this._options=a({},n),c.load(),e.next=8,l();case 8:return e.next=10,z();case 10:return e.next=12,g();case 12:return s=c.getCustomRpcUrl(),i=s||R(t.network,t.rpcUrl),e.next=16,o();case 16:return h=e.sent,p=h.SuiClient,this._client=new p({url:i}),this._gameClient=new u(this._client,t.packageId,t.gameDataId),this._mapAdmin=new d(this._client,t.packageId,t.gameDataId),this._queryService=new B(this._client,t.packageId,t.gameDataId),this._assetService=new D(this._client,t.packageId),this._pollingService=new U,this._initialized=!0,this._log("[SuiManager] Initialized successfully",{network:t.network,rpcUrl:i,packageId:t.packageId,gameDataId:t.gameDataId,signerType:t.signerType||"wallet"}),e.next=28,this._autoConfigureSigner(t);case 28:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),i._autoConfigureSigner=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("keypair"!==t.signerType){e.next=15;break}return console.log("[SuiManager] Config signerType is keypair, loading..."),y.info("检测到 Keypair 模式"),e.prev=3,e.next=6,this._loadAndSetKeypair();case 6:e.next=13;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("[SuiManager] Failed to load keypair:",e.t0),y.error("Keypair 加载失败"),console.log("[SuiManager] Falling back to wallet connection...");case 13:e.next=16;break;case 15:console.log("[SuiManager] Waiting for wallet connection (signerType: wallet)");case 16:case"end":return e.stop()}}),e,this,[[3,8]])})));return function(t){return e.apply(this,arguments)}}(),i._loadAndSetKeypair=function(){var e=n(r().mark((function e(t){var n,a=this;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t=!1),e.next=3,M();case 3:n=e.sent,this.setKeypairSigner(n),console.log("[SuiManager] ✓ Keypair loaded and set"),console.log("  Address:",this._currentAddress),S.instance.set("sui_keypair_connected",!0),t?(S.instance.set("sui_current_address",null),setTimeout((function(){S.instance.set("sui_current_address",a._currentAddress)}),1)):S.instance.set("sui_current_address",this._currentAddress),this.loadPlayerAssets().catch((function(e){console.error("[SuiManager] Failed to load assets:",e)}));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.reloadKeypair=function(){var e=n(r().mark((function e(){var t,n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._currentAddress,console.log("[SuiManager] Reloading keypair..."),console.log("  Old address:",t),e.prev=3,e.next=6,this._loadAndSetKeypair(!0);case 6:return n=t!==this._currentAddress,console.log("[SuiManager] Keypair reloaded"),console.log("  New address:",this._currentAddress),console.log("  Address changed:",n),e.abrupt("return",n);case 13:throw e.prev=13,e.t0=e.catch(3),console.error("[SuiManager] Failed to reload keypair:",e.t0),y.error("密钥重新加载失败"),e.t0;case 18:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(){return e.apply(this,arguments)}}(),i._ensureInitialized=function(){if(!(this._initialized&&this._client&&this._gameClient&&this._mapAdmin&&this._queryService&&this._assetService))throw new Error("[SuiManager] Not initialized. Call init() first.")},i.setWalletSigner=function(e,t){this._signer=new T(e,t,this._config.network),this._currentAddress=t.address,this._log("[SuiManager] Wallet signer set",{wallet:e.name,address:t.address}),this.startAssetPolling()},i.setKeypairSigner=function(e){this._signer=new C(e),this._currentAddress=e.toSuiAddress(),this._log("[SuiManager] Keypair signer set",{address:this._currentAddress}),this.startAssetPolling()},i.clearSigner=function(){this.stopAssetPolling(),this._signer=null,this._currentAddress=null,this._currentSeat=null,this._log("[SuiManager] Signer cleared")},i._ensureSigner=function(){if(!this._signer)throw new Error("[SuiManager] No signer set. Call setWalletSigner() or setKeypairSigner() first.")},i.signAndExecuteTransaction=function(){var e=n(r().mark((function e(t){var n,a,s,i,o,c,u;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),this._ensureSigner(),this._log("[SuiManager] Executing transaction..."),e.next=5,this._signer.signAndExecuteTransaction(t,this._client);case 5:return i=e.sent,console.log("[SuiManager] Waiting for transaction to be indexed..."),e.next=9,this._client.waitForTransaction({digest:i.digest,options:{showEffects:!0,showEvents:!0,showObjectChanges:!0,showBalanceChanges:!0}});case 9:return console.log("[SuiManager] Transaction indexed"),this._log("[SuiManager] Transaction executed",{digest:i.digest,status:null==(n=i.effects)||null==(n=n.status)?void 0:n.status}),(o=null==(a=i.effects)?void 0:a.gasUsed)&&(c=BigInt(o.computationCost)+BigInt(o.storageCost)-BigInt(o.storageRebate),u=Number(c)/1e9,console.log("[SuiManager] Gas used:",u.toFixed(6),"SUI"),i._gasInfo={totalGas:c,gasSui:u.toFixed(6)+" SUI",computationCost:o.computationCost,storageCost:o.storageCost,storageRebate:o.storageRebate}),"success"===(null==(s=i.effects)||null==(s=s.status)?void 0:s.status)&&this._refreshBalanceAsync().catch((function(e){console.error("[SuiManager] Failed to refresh balance after tx:",e)})),e.abrupt("return",i);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.createGame=function(){var e=n(r().mark((function e(t){var n,a,s,i,o,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),this._ensureSigner(),this._log("[SuiManager] Creating game...",t),n=this._signer.getAddress(),a=this._gameClient.game.buildCreateGameTx(t,n),e.next=7,this.signAndExecuteTransaction(a);case 7:return s=e.sent,i=this._extractObjectId(s,"Game"),o=this._extractObjectId(s,"Seat"),c={gameId:i,seatId:o,txHash:s.digest},this._log("[SuiManager] Game created",c),e.abrupt("return",c);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.joinGame=function(){var e=n(r().mark((function e(t){var n,a,s,i,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),this._ensureSigner(),this._log("[SuiManager] Joining game...",{gameId:t}),n=this._gameClient.game.buildJoinGameTx(t),e.next=6,this.signAndExecuteTransaction(n);case 6:return a=e.sent,s=this._extractObjectId(a,"Seat"),i=this._extractPlayerIndex(a),this._currentSeat={id:s,game_id:t,player:this._currentAddress,player_index:i},o={seatId:s,playerIndex:i,txHash:a.digest},this._log("[SuiManager] Joined game",o),e.abrupt("return",o);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.startGame=function(){var e=n(r().mark((function e(t,n){var a,s,i,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),this._ensureSigner(),this._log("[SuiManager] Starting game...",{gameId:t,mapTemplateId:n}),this._registerGameEventListeners(),e.prev=4,a=this._gameClient.game.buildStartGameTx(t,n),e.next=8,this.signAndExecuteTransaction(a);case 8:return s=e.sent,i=this._extractStartingPlayer(s),o={success:!0,startingPlayer:i,txHash:s.digest},this._log("[SuiManager] Game started",o),e.abrupt("return",o);case 15:throw e.prev=15,e.t0=e.catch(4),console.error("[SuiManager] Failed to start game, unregistering game events"),this._unregisterGameEventListeners(),e.t0;case 20:case"end":return e.stop()}}),e,this,[[4,15]])})));return function(t,n){return e.apply(this,arguments)}}(),i.rollAndStep=function(){var e=n(r().mark((function e(t,n){var a,s,i,o,c,u,l;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._ensureInitialized(),this._ensureSigner(),a=t.getGameId(),s=t.getTemplateMapId(),i=t.getMySeat(),this._log("[SuiManager] Rolling dice and stepping...",{gameId:a,path:n}),i){e.next=8;break}throw new Error("[SuiManager] No Seat found in GameSession");case 8:return o=this._gameClient.game.buildRollAndStepTx(a,i.id,s,n),e.next=11,this.signAndExecuteTransaction(o);case 11:return c=e.sent,u=this._extractRollAndStepEvent(c),l={dice:u.dice,endPos:u.end_pos,txHash:c.digest},c._gasInfo&&(l._gasInfo=c._gasInfo),this._log("[SuiManager] Roll and step completed",l),e.abrupt("return",l);case 17:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),i.skipTurn=function(){var e=n(r().mark((function e(t){var n,a,s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),this._ensureSigner(),this._log("[SuiManager] Skipping turn...",{gameId:t.getGameId()}),n=this._gameClient.game.buildSkipTurnTx(t.getGameId(),t.getMySeat().id,t.getTemplateMapId()),e.next=6,this.signAndExecuteTransaction(n);case 6:return a=e.sent,s={success:!0,txHash:a.digest},a._gasInfo&&(s._gasInfo=a._gasInfo),this._log("[SuiManager] Skip turn completed",s),e.abrupt("return",s);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.getGameState=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),e.next=3,this._queryService.getGame(t);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.getPlayerSeat=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.warn("[SuiManager] getPlayerSeat is deprecated"),e.abrupt("return",null);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),i.publishMapTemplate=function(){var e=n(r().mark((function e(t){var n,a,s,i,o,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._ensureInitialized(),this._ensureSigner(),e.t0=this._cachedGameData,e.t0){e.next=7;break}return e.next=6,this._queryService.getGameData();case 6:e.t0=e.sent;case 7:return n=e.t0,a=(null==n?void 0:n.mapSchemaVersion)||1,this._log("[SuiManager] Publishing map template...",{templateId:t.id,schemaVersion:a}),console.log("[SuiManager] Using schema_version from GameData:",a),e.next=13,this._mapAdmin.buildUploadMapTemplateTx(t,a);case 13:return s=e.sent,e.next=16,this.signAndExecuteTransaction(s);case 16:return i=e.sent,o=this._extractTemplateId(i),this._lastPublishedTemplateId=o,console.log("[SuiManager] Recorded last published template ID:",o),c={txHash:i.digest,templateId:o},this._log("[SuiManager] Map template published",c),e.abrupt("return",c);case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.setCurrentGame=function(e){this._currentGame=e,this._log("[SuiManager] Current game set",{gameId:(null==e?void 0:e.id)||"null"})},i.createGameWithTemplate=function(){var e=n(r().mark((function e(t,n){var a,s,i;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[SuiManager] createGameWithTemplate:",t),this.isConnected){e.next=4;break}throw y.warning("请先连接钱包"),new Error("Not connected");case 4:if(e.t0=this._cachedGameData,e.t0){e.next=9;break}return e.next=8,this._queryService.getGameData();case 8:e.t0=e.sent;case 9:return a=e.t0,s=(null==a?void 0:a.startingCash)||BigInt(1e4),console.log("[SuiManager] Using defaults from GameData:"),console.log("  starting_cash:",s),y.info("正在创建游戏..."),e.prev=14,e.next=17,this.createGame({template_map_id:t,max_players:(null==n?void 0:n.maxPlayers)||4,starting_cash:(null==n?void 0:n.startingCash)||s,price_rise_days:(null==n?void 0:n.priceRiseDays)||15,max_rounds:(null==n?void 0:n.maxRounds)||0});case 17:return i=e.sent,console.log("[SuiManager] Game created successfully"),console.log("  Game ID:",i.gameId),console.log("  Seat ID:",i.seatId),x.success("游戏创建成功！\n\n游戏 ID: "+i.gameId+"\n\n等待链上确认和其他玩家加入...","创建成功").catch((function(e){return console.error("[SuiManager] MessageBox error:",e)})),e.abrupt("return",i);case 25:throw e.prev=25,e.t1=e.catch(14),console.error("[SuiManager] Failed to create game:",e.t1),y.error("创建游戏失败"),e.t1;case 30:case"end":return e.stop()}}),e,this,[[14,25]])})));return function(t,n){return e.apply(this,arguments)}}(),i.getMapTemplate=function(){var e=n(r().mark((function e(t){var n,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),e.prev=1,e.next=4,this._client.getObject({id:t,options:{showContent:!0,showType:!0}});case 4:if(a=e.sent,"moveObject"!==(null==(n=a.data)||null==(n=n.content)?void 0:n.dataType)){e.next=7;break}return e.abrupt("return",this._parseMapTemplateObject(a.data.content.fields));case 7:return e.abrupt("return",null);case 10:return e.prev=10,e.t0=e.catch(1),console.error("[SuiManager] Failed to get map template:",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,this,[[1,10]])})));return function(t){return e.apply(this,arguments)}}(),i._parseMapTemplateObject=function(e){var t=new Map,n=new Map;console.log("[SuiManager] Parsing map template object, fields:",e),e.tiles_static&&Array.isArray(e.tiles_static)&&e.tiles_static.forEach((function(e,n){var r=e.fields;t.set(n,{x:Number(r.x),y:Number(r.y),kind:Number(r.kind),building_id:Number(r.building_id),special:BigInt(r.special||0),w:Number(r.w),n:Number(r.n),e:Number(r.e),s:Number(r.s)})})),e.buildings_static&&Array.isArray(e.buildings_static)&&e.buildings_static.forEach((function(e,t){var r=e.fields;n.set(t,{x:Number(r.x||0),y:Number(r.y||0),size:Number(r.size),price:BigInt(r.price||0),chain_prev_id:Number(r.chain_prev_id),chain_next_id:Number(r.chain_next_id)})}));var r=e.hospital_ids&&Array.isArray(e.hospital_ids)?e.hospital_ids.map((function(e){return Number(e)})):[];return{id:e.id.id,tiles_static:t,buildings_static:n,hospital_ids:r}},i.getMapTemplates=function(){var e=n(r().mark((function e(){var t;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),this._log("[SuiManager] Querying map templates..."),e.next=4,this._queryService.getMapTemplates();case 4:return t=e.sent,this._log("[SuiManager] Found "+t.length+" map templates"),e.abrupt("return",t);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),i.getGameData=function(){var e=n(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),e.next=3,this._queryService.getGameData();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),i.getSignerType=function(){return this._signer?this._signer.getType():null},i._extractObjectId=function(e,n){for(var r,a=e.objectChanges||[],s=t(a);!(r=s()).done;){var i,o=r.value;if("created"===o.type&&null!=(i=o.objectType)&&i.includes(n))return o.objectId}throw new Error("[SuiManager] Failed to extract "+n+" ID from transaction")},i._extractPlayerIndex=function(e){for(var n,r=e.events||[],a=t(r);!(n=a()).done;){var s,i=n.value;if(i.type.includes("PlayerJoinedEvent"))return(null==(s=i.parsedJson)?void 0:s.player_index)||0}return 0},i._extractStartingPlayer=function(e){for(var n,r=e.events||[],a=t(r);!(n=a()).done;){var s,i=n.value;if(i.type.includes("GameStartedEvent"))return(null==(s=i.parsedJson)?void 0:s.starting_player)||""}return""},i._extractTemplateId=function(e){for(var n,r=e.events||[],a=t(r);!(n=a()).done;){var s,i=n.value;if(i.type.includes("MapTemplatePublishedEvent"))return(null==(s=i.parsedJson)?void 0:s.template_id)||"0"}return"0"},i._extractRollAndStepEvent=function(e){for(var n,r=e.events||[],a=t(r);!(n=a()).done;){var s=n.value;if(s.type.includes("RollAndStepActionEvent"))return s.parsedJson}return{dice:0,end_pos:0,from:0,steps:[],cash_changes:[]}},i._log=function(e,t){this._options.debug&&(t?console.log(e,t):console.log(e))},i.startBackgroundSync=function(){var e=n(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._preloadStarted){e.next=3;break}return console.warn("[SuiManager] Background sync already started"),e.abrupt("return");case 3:this._preloadStarted=!0,console.log("[SuiManager] Starting background sync..."),this._preloadData(),this._startEventListener();case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),i._preloadData=function(){var e=n(r().mark((function e(){var t,n,a,s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._ensureInitialized(),console.log("[SuiManager] Starting data preload..."),y.info("正在加载链上数据..."),e.prev=3,e.next=6,Promise.all([this._queryService.getGameData(),this._queryService.queryAllGamesBatch({limit:50,order:"descending"}),this._queryService.getMapTemplates()]);case 6:t=e.sent,n=t[0],a=t[1],s=t[2],console.log("[SuiManager] GameData loaded:"),n&&(console.log("  mapSchemaVersion:",n.mapSchemaVersion),console.log("  startingCash:",n.startingCash.toString()),console.log("  mapTemplates:",n.mapRegistry.getTemplateCount()),console.log("  cards:",n.cardRegistry.getCardCount())),this._cachedGameData=n,this._cachedGames=this._sortAndLimitGames(a),this._cachedMapTemplates=s,this._cacheTimestamp=Date.now(),this._preloadCompleted=!0,console.log("[SuiManager] Preload completed",{games:this._cachedGames.length,templates:this._cachedMapTemplates.length}),y.info("数据加载完成："+this._cachedGames.length+" 个游戏，"+this._cachedMapTemplates.length+" 个模板"),f.emit(v.Sui.DataPreloaded,{gamesCount:this._cachedGames.length,templatesCount:this._cachedMapTemplates.length}),e.next=26;break;case 22:e.prev=22,e.t0=e.catch(3),console.error("[SuiManager] Preload failed:",e.t0),y.error("数据加载失败");case 26:case"end":return e.stop()}}),e,this,[[3,22]])})));return function(){return e.apply(this,arguments)}}(),i._startEventListener=function(){var e=this;this._ensureInitialized(),console.log("[SuiManager] Starting event listener...");var t=c.getEventIndexerInterval();console.log("[SuiManager] Using event indexer interval:",t,"ms"),this._eventIndexer=new h({client:this._client,packageId:this._config.packageId,autoStart:!0,pollInterval:t}),this._eventIndexer.on(p.GAME_CREATED,n(r().mark((function t(n){var s;return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[SuiManager] GameCreatedEvent from chain:",n.data),t.next=3,e._addNewGameToCache(n.data.game);case 3:(s=t.sent)&&n.data.creator===e._currentAddress&&(e._currentGame=s,console.log("[SuiManager] Set as current game (creator)")),f.emit(v.Move.GameCreated,a({},n.data,{gameObject:s}));case 6:case"end":return t.stop()}}),t)})))),this._eventIndexer.on(p.PLAYER_JOINED,(function(t){console.log("[SuiManager] PlayerJoinedEvent from chain:",t.data),e._onPlayerJoined(t),f.emit(v.Move.PlayerJoined,t.data)})),this._eventIndexer.on(p.GAME_STARTED,n(r().mark((function t(n){return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[SuiManager] GameStartedEvent from chain:",n.data),t.next=3,e._onGameStarted(n);case 3:case"end":return t.stop()}}),t)})))),this._eventIndexer.on(p.MAP_TEMPLATE_PUBLISHED,(function(t){console.log("[SuiManager] MapTemplatePublishedEvent from chain:",t.data);var n={template_id:t.data.template_id,publisher:t.data.publisher,tile_count:t.data.tile_count,building_count:t.data.building_count};e._cachedMapTemplates.push(n),console.log("[SuiManager] Map template added to cache:",n),f.emit(v.Move.MapTemplatePublished,t.data)})),console.log("[SuiManager] Event listener started (global events only)"),console.log("[SuiManager] Game event listeners will be registered when game starts")},i._registerGameEventListeners=function(){if(this._eventIndexer){var e=S.instance.get("currentGameSession");if(e){var t=e.getGameId();this._eventIndexer.setCurrentGameId(t),this._eventIndexer.enableFilterTest(!0),console.log("[SuiManager] Filter test enabled for game:",t)}else console.warn("[SuiManager] No GameSession found, filter test not enabled");console.log("[SuiManager] Registering game event listeners...");var a=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] RollAndStepActionEvent from chain:",t.data),e.next=3,I.instance.handleEvent(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this._eventIndexer.on(p.ROLL_AND_STEP_ACTION,a),this._gameEventHandlers.set(p.ROLL_AND_STEP_ACTION,a);var s=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] BuildingDecisionEvent from chain:",t.data),e.next=3,w.instance.handleEvent(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this._eventIndexer.on(p.BUILDING_DECISION,s),this._gameEventHandlers.set(p.BUILDING_DECISION,s);var i=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] RentDecisionEvent from chain:",t.data),e.next=3,b.instance.handleEvent(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this._eventIndexer.on(p.RENT_DECISION,i),this._gameEventHandlers.set(p.RENT_DECISION,i);var o=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] DecisionSkippedEvent from chain:",t.data),e.next=3,k.instance.handleEvent(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this._eventIndexer.on(p.DECISION_SKIPPED,o),this._gameEventHandlers.set(p.DECISION_SKIPPED,o);var c=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] SkipTurnEvent from chain:",t.data),e.next=3,G.instance.handleEvent(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this._eventIndexer.on(p.SKIP_TURN,c),this._gameEventHandlers.set(p.SKIP_TURN,c);var u=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] BankruptEvent from chain:",t.data),e.next=3,A.instance.handleEvent(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this._eventIndexer.on(p.BANKRUPT,u),this._gameEventHandlers.set(p.BANKRUPT,u);var l=function(){var e=n(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] GameEndedEvent from chain:",t.data),e.next=3,E.instance.handleEvent(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();this._eventIndexer.on(p.GAME_ENDED,l),this._gameEventHandlers.set(p.GAME_ENDED,l),console.log("[SuiManager] Game event listeners registered (7 events)")}else console.warn("[SuiManager] EventIndexer not initialized, skip registering game events")},i._unregisterGameEventListeners=function(){var e=this;this._eventIndexer&&(console.log("[SuiManager] Unregistering game event listeners..."),this._eventIndexer.printFilterTestSummary(),this._eventIndexer.enableFilterTest(!1),this._eventIndexer.setCurrentGameId(null),this._gameEventHandlers.forEach((function(t,n){e._eventIndexer.off(n,t)})),this._gameEventHandlers.clear(),console.log("[SuiManager] Game event listeners unregistered"))},i.unregisterGameEvents=function(){this._unregisterGameEventListeners()},i._addNewGameToCache=function(){var e=n(r().mark((function e(t){var n,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._queryService.getGame(t);case 3:if(n=e.sent){e.next=7;break}return console.error("[SuiManager] Failed to get new game:",t),e.abrupt("return",null);case 7:return(a=this._cachedGames.findIndex((function(e){return e.id===t})))>=0?(console.warn("[SuiManager] Game already in cache, replacing"),this._cachedGames[a]=n):(this._cachedGames.unshift(n),console.log("[SuiManager] New game added to cache")),this._cacheTimestamp=Date.now(),console.log("[SuiManager] Game cache updated"),console.log("  Game ID:",t),console.log("  Total games:",this._cachedGames.length),f.emit(v.Sui.GamesListUpdated,{games:this._cachedGames}),e.abrupt("return",n);case 17:return e.prev=17,e.t0=e.catch(0),console.error("[SuiManager] Failed to add game to cache:",e.t0),e.abrupt("return",null);case 21:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(t){return e.apply(this,arguments)}}(),i._onPlayerJoined=function(e){var t,n,r,a,s,i=null==(t=e.data)?void 0:t.game,o=null==(n=e.data)?void 0:n.player,c=null==(r=e.data)?void 0:r.player_index;if(i&&o){var u=this._cachedGames.find((function(e){return e.id===i}));if(u){var l=u.players.length>0?u.players[0].cash:(null==(a=this._cachedGameData)?void 0:a.startingCash)||BigInt(1e4),d={owner:o,pos:0,cash:l,bankrupt:!1,in_hospital_turns:0,last_tile_id:65535,next_tile_id:65535,temple_levels:[],buffs:[],cards:[]};u.players.push(d),console.log("[SuiManager] Player added to game cache"),console.log("  Game:",i),console.log("  Player:",o),console.log("  Index:",c),console.log("  Total players:",u.players.length),console.log("  Starting cash:",l.toString()),f.emit(v.Sui.GamesListUpdated,{games:this._cachedGames}),(null==(s=this._currentGame)?void 0:s.id)===i&&(this._currentGame=u,console.log("[SuiManager] Current game updated"))}else console.warn("[SuiManager] Game not found in cache:",i)}else console.warn("[SuiManager] Invalid PlayerJoinedEvent data")},i._onGameStarted=function(){var e=n(r().mark((function e(t){var n,a,s,i,o,c,u,l,d;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=null==(n=t.data)?void 0:n.game,o=null==(a=t.data)?void 0:a.template_map_id,c=(null==(s=t.data)?void 0:s.players)||[],i){e.next=5;break}return e.abrupt("return");case 5:if(u=c.includes(this._currentAddress),console.log("[SuiManager] GameStarted event processing"),console.log("  Game:",i),console.log("  Template:",o),console.log("  Players:",c),console.log("  Is player:",u),!u){e.next=17;break}return console.log("[SuiManager] I am a player, loading game scene..."),e.next=15,this.loadGameScene(i,o);case 15:e.next=22;break;case 17:console.log("[SuiManager] Not a player, updating cache"),(l=this._cachedGames.find((function(e){return e.id===i})))&&(l.status=_.ACTIVE),(d=this._cachedGames.findIndex((function(e){return e.id===i})))>=0&&(this._cachedGames.splice(d,1),f.emit(v.Sui.GamesListUpdated,{games:this._cachedGames}));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i.loadGameScene=function(){var e=n(r().mark((function e(t,n){var a,s,i,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] Loading game scene..."),y.info("正在加载游戏场景..."),this._registerGameEventListeners(),e.prev=3,e.next=6,Promise.all([this._queryService.getGame(t),this.getMapTemplate(n),this._queryService.getGameData()]);case 6:if(a=e.sent,s=a[0],i=a[1],o=a[2],s){e.next=12;break}throw new Error("Failed to get game state");case 12:if(i){e.next=14;break}throw new Error("Failed to get map template");case 14:this._currentGame=s,console.log("[SuiManager] Game scene data loaded"),console.log("  Game ID:",s.id),console.log("  Template tiles:",i.tiles_static.size),console.log("  Template buildings:",i.buildings_static.size),console.log("  Game players:",s.players.length),f.emit(v.Move.GameStarted,{game:s,template:i,gameData:o,isPlayer:!0}),y.success("游戏场景加载完成"),e.next=30;break;case 24:throw e.prev=24,e.t0=e.catch(3),console.error("[SuiManager] Failed to load game scene, unregistering game events:",e.t0),this._unregisterGameEventListeners(),y.error("游戏场景加载失败"),e.t0;case 30:case"end":return e.stop()}}),e,this,[[3,24]])})));return function(t,n){return e.apply(this,arguments)}}(),i._sortAndLimitGames=function(e){return e.sort((function(e,t){return e.isMyCreation&&!t.isMyCreation?-1:!e.isMyCreation&&t.isMyCreation?1:t.createdAt-e.createdAt})),e.map((function(e){return e.game}))},i.stopEventListener=function(){this._eventIndexer&&(this._eventIndexer.stop(),this._eventIndexer=null,console.log("[SuiManager] Event listener stopped"))},i.getCachedGames=function(){return this._cachedGames},i.getCachedMapTemplates=function(){return this._cachedMapTemplates},i.getCachedGameData=function(){return this._cachedGameData},i.loadPlayerAssets=function(){var e=n(r().mark((function e(){var t,n,a,s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._currentAddress){e.next=3;break}return console.warn("[SuiManager] No wallet connected, skip loading assets"),e.abrupt("return");case 3:return this._ensureInitialized(),console.log("[SuiManager] Loading player assets for:",this._currentAddress),y.info("正在查询钱包资产..."),e.prev=6,e.next=9,Promise.all([this._assetService.getSuiBalance(this._currentAddress),this._assetService.getPlayerSeats(this._currentAddress)]);case 9:t=e.sent,n=t[0],a=t[1],this._playerAssets=new m(n,a,[],{}),console.log("[SuiManager] Player assets loaded",{balance:n.toString(),seats:a.length}),S.instance.set("sui_balance",n),s=this._formatSuiAmount(n),y.success("资产加载完成："+s+" SUI，"+a.length+" 个 Seat"),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(6),console.error("[SuiManager] Failed to load player assets:",e.t0),y.error("资产查询失败");case 23:case"end":return e.stop()}}),e,this,[[6,19]])})));return function(){return e.apply(this,arguments)}}(),i._refreshBalanceAsync=function(){var e=n(r().mark((function e(){var t,n,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._currentAddress){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this._assetService.getSuiBalance(this._currentAddress);case 5:n=e.sent,a=(null==(t=this._playerAssets)?void 0:t.suiBalance)||0n,n!==a&&(this._playerAssets&&this._playerAssets.setSuiBalance(n),S.instance.set("sui_balance",n),console.log("[SuiManager] Balance updated:",n.toString())),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),console.error("[SuiManager] Failed to refresh balance:",e.t0);case 13:case"end":return e.stop()}}),e,this,[[2,10]])})));return function(){return e.apply(this,arguments)}}(),i._formatSuiAmount=function(e){return D.formatSuiAmount(e,4)},i.getExplorer=function(e,t){return void 0===t&&(t="address"),this._ensureInitialized(),P(this._config.network,e,t)},i.getNetworkName=function(){return this._ensureInitialized(),N(this._config.network)},i.openCurrentAddressExplorer=function(){if(!this._currentAddress)return console.warn("[SuiManager] No address connected"),void y.warning("请先连接钱包");var e=this.getExplorer(this._currentAddress,"address");this.openUrl(e)},i.openUrl=function(e){"undefined"!=typeof window&&window.open?(window.open(e,"_blank"),console.log("[SuiManager] Opened URL:",e)):console.log("[SuiManager] URL to open:",e)},i.startAssetPolling=function(){var e=this;if(this._pollingService&&this._currentAddress){console.log("[SuiManager] Starting asset polling...");var t=c.getDataPollingInterval();console.log("[SuiManager] Using data polling interval:",t,"ms"),this._pollingService.registerSimple("sui_balance",n(r().mark((function t(){var n;return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e._assetService.getSuiBalance(e._currentAddress);case 2:return n=t.sent,t.abrupt("return",n);case 4:case"end":return t.stop()}}),t)}))),t,"sui_balance"),this._pollingService.start(),console.log("[SuiManager] Asset polling started"),console.log("  Balance: every 2s")}else console.warn("[SuiManager] Cannot start polling: service or address missing")},i.stopAssetPolling=function(){this._pollingService&&(this._pollingService.clear(),console.log("[SuiManager] Asset polling stopped and cleared"))},i.reinit=function(){var e=n(r().mark((function e(t){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[SuiManager] ======================================"),console.log("[SuiManager] 开始重新初始化"),console.log("[SuiManager] ======================================"),console.log("  旧网络:",null==(n=this._config)?void 0:n.network),console.log("  新网络:",t.network),console.log("  新签名器:",t.signerType),console.log("[SuiManager] [1/4] 停止服务..."),this._eventIndexer&&(this._eventIndexer.stop(),this._eventIndexer=null,console.log("  ✓ EventIndexer 已停止")),this._pollingService&&(this._pollingService.clear(),console.log("  ✓ AssetPolling 已停止")),console.log("[SuiManager] [2/4] 清除状态和缓存..."),this._initialized=!1,this._signer=null,this._currentAddress=null,this._currentSeat=null,this._cachedGameData=null,this._cachedGames=[],this._cachedMapTemplates=[],this._playerAssets=null,this._cacheTimestamp=0,this._preloadStarted=!1,this._preloadCompleted=!1,this._currentGame=null,this._lastPublishedTemplateId=null,console.log("  ✓ 所有缓存已清除"),console.log("[SuiManager] [3/4] 重新初始化..."),e.next=27,this.init(t,this._options);case 27:return console.log("  ✓ 初始化完成"),console.log("[SuiManager] [3.5/4] 重新启动后台同步..."),e.next=31,this.startBackgroundSync();case 31:console.log("  ✓ 后台同步已启动"),console.log("[SuiManager] [4/4] 通知 UI..."),S.instance.set("sui_network_changed",{network:t.network,signerType:t.signerType,timestamp:Date.now()}),console.log("[SuiManager] ======================================"),console.log("[SuiManager] 重新初始化完成"),console.log("[SuiManager] ======================================");case 37:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),s(e,[{key:"lastPublishedTemplateId",get:function(){return this._lastPublishedTemplateId}},{key:"currentGame",get:function(){return this._currentGame}},{key:"client",get:function(){return this._ensureInitialized(),this._client}},{key:"gameClient",get:function(){return this._ensureInitialized(),this._gameClient}},{key:"config",get:function(){return this._ensureInitialized(),this._config}},{key:"currentAddress",get:function(){return this._currentAddress}},{key:"currentSeat",get:function(){return this._currentSeat}},{key:"isConnected",get:function(){return null!==this._signer}},{key:"isPreloadCompleted",get:function(){return this._preloadCompleted}},{key:"playerAssets",get:function(){return this._playerAssets}},{key:"suiBalance",get:function(){var e;return(null==(e=this._playerAssets)?void 0:e.suiBalance)||0n}},{key:"seats",get:function(){var e;return(null==(e=this._playerAssets)?void 0:e.seats)||[]}},{key:"mapTemplateNFTs",get:function(){var e;return(null==(e=this._playerAssets)?void 0:e.mapTemplateNFTs)||[]}},{key:"defiAssets",get:function(){var e;return(null==(e=this._playerAssets)?void 0:e.defiAssets)||{}}}],[{key:"instance",get:function(){return e._instance||(e._instance=new e),e._instance}}]),e}());H._instance=null;e("suiManager",H.instance);i._RF.pop()}}}));

System.register("chunks:///_virtual/TemplateProcessor.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){r=e.cclegacy}],execute:function(){r._RF.push({},"38251WGot9OD6YE+mNOBiDU","TemplateProcessor",void 0);e("TemplateProcessor",function(){function e(){}return e.detectTemplate=function(e){if(0===e.length)return"unsupported";var t=e[e.length-1].rel;if(t.startsWith("builtin:"))switch(t.substring("builtin:".length)){case"cross":return"cross";case"generated":case"entity":case"missing":default:return"builtin"}if(t.includes("cube_all"))return"cube_all";if(t.includes("cube_column"))return"cube_column";if(t.includes("cube_bottom_top"))return"cube_bottom_top";if(t.includes("cross"))return"cross";if(t.includes("tinted_cross"))return"tinted_cross";if(t.includes("orientable"))return"orientable";if(t.includes("cube"))return"cube";var r=e[0];return r.json&&r.json.elements&&r.json.elements.length>0?"elements":"unsupported"},e.synthesizeElementsByTemplate=function(e,r,u){if(u&&u.length>0)for(var n,s=t(u);!(n=s()).done;){var i,o=n.value;if(null!=(i=o.json)&&i.elements)return this.parseElements(o.json.elements)}switch(e){case"cube_all":return this.generateCubeAll();case"cube_column":return this.generateCubeColumn();case"cube_bottom_top":return this.generateCubeBottomTop();case"cross":case"tinted_cross":return this.generateCross();case"orientable":return this.generateOrientable();case"cube":return this.generateCube();case"builtin":return this.generateBuiltin();default:return this.generateFallback()}},e.parseElements=function(e){return e.map((function(e){var t=[];if(e.faces)for(var r in e.faces){var u;if(e.faces.hasOwnProperty(r)){var n=e.faces[r],s=null!=(u=n.texture)&&u.startsWith("#")?n.texture.substring(1):n.texture;t.push({dir:r,uv:n.uv||[0,0,16,16],textureKey:s,cullface:n.cullface,rotation:n.rotation,tintindex:n.tintindex})}}var i={from:e.from||[0,0,0],to:e.to||[16,16,16],faces:t};return e.rotation&&(i.rotation=e.rotation),void 0!==e.shade&&(i.shade=e.shade),i}))},e.generateCubeAll=function(){var e="all";return[{from:[0,0,0],to:[16,16,16],shade:!0,faces:[{dir:"north",uv:[0,0,16,16],textureKey:e},{dir:"south",uv:[0,0,16,16],textureKey:e},{dir:"east",uv:[0,0,16,16],textureKey:e},{dir:"west",uv:[0,0,16,16],textureKey:e},{dir:"up",uv:[0,0,16,16],textureKey:e},{dir:"down",uv:[0,0,16,16],textureKey:e}]}]},e.generateCubeColumn=function(){return[{from:[0,0,0],to:[16,16,16],shade:!0,faces:[{dir:"north",uv:[0,0,16,16],textureKey:"side"},{dir:"south",uv:[0,0,16,16],textureKey:"side"},{dir:"east",uv:[0,0,16,16],textureKey:"side"},{dir:"west",uv:[0,0,16,16],textureKey:"side"},{dir:"up",uv:[0,0,16,16],textureKey:"end"},{dir:"down",uv:[0,0,16,16],textureKey:"end"}]}]},e.generateCubeBottomTop=function(){return[{from:[0,0,0],to:[16,16,16],shade:!0,faces:[{dir:"north",uv:[0,0,16,16],textureKey:"side"},{dir:"south",uv:[0,0,16,16],textureKey:"side"},{dir:"east",uv:[0,0,16,16],textureKey:"side"},{dir:"west",uv:[0,0,16,16],textureKey:"side"},{dir:"up",uv:[0,0,16,16],textureKey:"top"},{dir:"down",uv:[0,0,16,16],textureKey:"bottom"}]}]},e.generateCross=function(){var e="cross";return[{from:[0,0,0],to:[16,16,16],shade:!1,faces:[{dir:"north",uv:[0,0,16,16],textureKey:e},{dir:"south",uv:[0,0,16,16],textureKey:e},{dir:"west",uv:[0,0,16,16],textureKey:e},{dir:"east",uv:[0,0,16,16],textureKey:e}]},{from:[0,0,16],to:[16,16,0],shade:!1,faces:[{dir:"north",uv:[0,0,16,16],textureKey:e},{dir:"south",uv:[0,0,16,16],textureKey:e},{dir:"west",uv:[0,0,16,16],textureKey:e},{dir:"east",uv:[0,0,16,16],textureKey:e}]}]},e.generateOrientable=function(){return[{from:[0,0,0],to:[16,16,16],shade:!0,faces:[{dir:"north",uv:[0,0,16,16],textureKey:"front"},{dir:"south",uv:[0,0,16,16],textureKey:"side"},{dir:"east",uv:[0,0,16,16],textureKey:"side"},{dir:"west",uv:[0,0,16,16],textureKey:"side"},{dir:"up",uv:[0,0,16,16],textureKey:"top"},{dir:"down",uv:[0,0,16,16],textureKey:"bottom"}]}]},e.generateCube=function(){return[{from:[0,0,0],to:[16,16,16],shade:!0,faces:[{dir:"north",uv:[0,0,16,16],textureKey:"north"},{dir:"south",uv:[0,0,16,16],textureKey:"south"},{dir:"east",uv:[0,0,16,16],textureKey:"east"},{dir:"west",uv:[0,0,16,16],textureKey:"west"},{dir:"up",uv:[0,0,16,16],textureKey:"up"},{dir:"down",uv:[0,0,16,16],textureKey:"down"}]}]},e.generateBuiltin=function(){return this.generateFallback()},e.generateFallback=function(){return[{from:[0,0,0],to:[16,16,16],shade:!0,faces:[{dir:"north",uv:[0,0,16,16],textureKey:"missing"},{dir:"south",uv:[0,0,16,16],textureKey:"missing"},{dir:"east",uv:[0,0,16,16],textureKey:"missing"},{dir:"west",uv:[0,0,16,16],textureKey:"missing"},{dir:"up",uv:[0,0,16,16],textureKey:"missing"},{dir:"down",uv:[0,0,16,16],textureKey:"missing"}]}]},e.resolveBuiltin=function(e){switch(e){case"cross":return"minecraft:block/cross";case"generated":case"entity":case"missing":default:return null}},e}());r._RF.pop()}}}));

System.register("chunks:///_virtual/TextureManager.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r,n,a,i,s,o;return{setters:[function(e){t=e.createForOfIteratorHelperLoose,r=e.asyncToGenerator,n=e.regeneratorRuntime},function(e){a=e.cclegacy,i=e.Texture2D,s=e.ImageAsset,o=e.resources}],execute:function(){e({getGlobalTextureManager:function(){return c},initializeGlobalTextureManager:function(){c&&c.destroy();return c=new u}}),a._RF.push({},"b5b4aSkHwVC5omC/jqt4yx+","TextureManager",void 0);var u=e("TextureManager",function(){function e(){this.textureCache=new Map,this.loadingPromises=new Map,this.missingTexture=null,this.rootDir=void 0}var a=e.prototype;return a.initialize=function(){var e=r(n().mark((function e(t){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[TextureManager] 初始化纹理管理器..."),this.rootDir=t,e.next=4,this.createMissingTexture();case 4:console.log("[TextureManager] 纹理管理器初始化完成");case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),a.loadTexture=function(){var e=r(n().mark((function e(t){var r,a,i;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.textureCache.has(t)){e.next=8;break}if(!(r=this.textureCache.get(t)).texture||!r.texture.isValid){e.next=6;break}return e.abrupt("return",r);case 6:console.warn("[TextureManager] 缓存的纹理已失效，重新加载: "+t),this.textureCache.delete(t);case 8:if(!this.loadingPromises.has(t)){e.next=12;break}return e.next=11,this.loadingPromises.get(t);case 11:return e.abrupt("return",e.sent);case 12:return a=this.doLoadTexture(t),this.loadingPromises.set(t,a),e.prev=14,e.next=17,a;case 17:return i=e.sent,e.abrupt("return",i);case 19:return e.prev=19,this.loadingPromises.delete(t),e.finish(19);case 22:case"end":return e.stop()}}),e,this,[[14,,19,22]])})));return function(t){return e.apply(this,arguments)}}(),a.doLoadTexture=function(){var e=r(n().mark((function e(t){var r,a;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.loadTextureFromCocos(this.rootDir,t);case 3:if(r=e.sent){e.next=7;break}return console.warn("[TextureManager] 纹理加载失败: "+t),e.abrupt("return",this.getMissingTextureInfo());case 7:return a={texture:r,path:t,loaded:!0},this.configureTexture(r),this.textureCache.set(t,a),e.abrupt("return",a);case 13:return e.prev=13,e.t0=e.catch(0),console.error("[TextureManager] 纹理加载异常: "+t,e.t0),e.abrupt("return",this.getMissingTextureInfo());case 17:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(t){return e.apply(this,arguments)}}(),a.configureTexture=function(e){e&&e.isValid?(e.setFilters(i.Filter.NEAREST,i.Filter.NEAREST),e.setWrapMode(i.WrapMode.CLAMP_TO_EDGE,i.WrapMode.CLAMP_TO_EDGE)):console.warn("[TextureManager] 尝试配置无效纹理，跳过配置")},a.loadTexturesBatch=function(){var e=r(n().mark((function e(t){var a,i,s=this;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new Map,i=t.map(r(n().mark((function e(t){var r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.loadTexture(t);case 2:return r=e.sent,a.set(t,r),e.abrupt("return",{path:t,result:r});case 5:case"end":return e.stop()}}),e)})))),e.next=4,Promise.allSettled(i);case 4:return console.log("[TextureManager] 批量加载完成，成功: "+Array.from(a.values()).filter((function(e){return null==e?void 0:e.loaded})).length+"/"+t.length),e.abrupt("return",a);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a.preloadCommonTextures=function(){var e=r(n().mark((function e(){var t;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=["minecraft:block/stone","minecraft:block/dirt","minecraft:block/grass_block_side","minecraft:block/grass_block_top","minecraft:block/oak_log","minecraft:block/oak_log_top","minecraft:block/oak_planks","minecraft:block/sand","minecraft:block/cobblestone","minecraft:block/glass","minecraft:block/oak_leaves","minecraft:block/dandelion","minecraft:block/poppy","minecraft:block/short_grass","minecraft:block/fern"],console.log("[TextureManager] 开始预加载常用纹理..."),e.next=4,this.loadTexturesBatch(t);case 4:console.log("[TextureManager] 常用纹理预加载完成");case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.getTexture=function(e){var t=this.textureCache.get(e);return t&&t.loaded?t.texture:this.missingTexture||this.createEmptyTexture()},a.isTextureLoaded=function(e){var t=this.textureCache.get(e);return!!t&&t.loaded},a.getTextureInfo=function(e){return this.textureCache.get(e)||null},a.createMissingTexture=function(){var e=r(n().mark((function e(){var t,r,a,o,u,c,l;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=16,(r=document.createElement("canvas")).width=t,r.height=t,a=r.getContext("2d"),"#FF00FF","#000000",o=0;o<t;o++)for(u=0;u<t;u++)c=Math.floor(u/8)+Math.floor(o/8),a.fillStyle=c%2==0?"#FF00FF":"#000000",a.fillRect(u,o,1,1);(l=new s).reset({_nativeAsset:r,width:t,height:t,format:i.PixelFormat.RGBA8888}),this.missingTexture=new i,this.missingTexture.image=l,this.configureTexture(this.missingTexture,!1),console.log("[TextureManager] 缺失纹理创建完成");case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.getMissingTextureInfo=function(){return{texture:this.missingTexture||this.createEmptyTexture(),path:"minecraft:missing",loaded:!0,transparent:!1,size:{width:16,height:16}}},a.createEmptyTexture=function(){var e=new s;e.reset({width:1,height:1,format:i.PixelFormat.RGBA8888});var t=new i;return t.image=e,t},a.clearCache=function(e){void 0===e&&(e=!0),console.warn("[TextureManager] 清理纹理缓存会影响性能，建议保持缓存");for(var r,n=t(this.textureCache);!(r=n()).done;){var a=r.value,i=a[0];a[1];e&&"minecraft:missing"===i||this.textureCache.delete(i)}console.log("[TextureManager] 纹理缓存引用已清理（纹理对象保留）")},a.getCacheStats=function(){for(var e,r=0,n=0,a=0,i=t(this.textureCache.values());!(e=i()).done;){var s=e.value;s.loaded&&r++,s.transparent&&n++,a+=s.size.width*s.size.height*4}return{total:this.textureCache.size,loaded:r,transparent:n,totalMemory:a}},a.loadTextureFromCocos=function(e,t){return new Promise((function(r){t=t.split(".")[0];var n=e+"/"+t+"/texture";o.load(n,i,(function(e,n){e?(console.warn("[TextureManager] Cocos 资源加载失败: "+t,e),r(null)):r(n)}))}))},a.destroy=function(){this.clearCache(!1),this.missingTexture&&(this.missingTexture.destroy(),this.missingTexture=null),this.loadingPromises.clear()},e}()),c=null;a._RF.pop()}}}));

System.register("chunks:///_virtual/TransactionErrorHandler.ts",["cc","./SuiErrorTranslator.ts","./UINotification.ts","./UIMessage.ts"],(function(r){var o,e,n,i;return{setters:[function(r){o=r.cclegacy},function(r){e=r.SuiErrorTranslator},function(r){n=r.UINotification},function(r){i=r.UIMessage}],execute:function(){r("handleSuiTransactionError",(function(r,o){return a.handle(r,o)})),o._RF.push({},"d3ebelEX5JPi6lYYrnN04l0","TransactionErrorHandler",void 0);var t=r("ErrorSeverity",function(r){return r.INFO="info",r.WARNING="warning",r.ERROR="error",r.CRITICAL="critical",r}({})),a=r("TransactionErrorHandler",function(){function r(){}return r.handle=function(r,o){void 0===o&&(o={});var n=o,i=n.title,a=void 0===i?"":i,s=n.severity,c=void 0===s?t.ERROR:s,u=n.logToConsole,f=void 0===u||u,l=n.messagePrefix,d=void 0===l?"":l,E=n.messageSuffix,v=void 0===E?"":E,R=e.translate(r),g=R.message;if(d&&(g=d+g),v&&(g+=v),f){var I=e.getDetailedError(r);console.error("[TransactionErrorHandler] "+(a||"交易错误")+":",I),console.error("  原始错误:",r)}return this._showNotification(g,a,c),R},r._showNotification=function(r,o,e){switch(e){case t.INFO:n.info(r,o,6e3);break;case t.WARNING:n.warning(r,o,6e3);break;case t.ERROR:n.error(r,o,6e3);break;case t.CRITICAL:i.error(r,o||"严重错误").catch((function(r){console.error("[TransactionErrorHandler] MessageBox error:",r)}));break;default:n.error(r,o,6e3)}},r.isErrorCode=function(r,o){return e.isErrorCode(r,o)},r.isMoveError=function(r){return e.isMoveError(r)},r}());o._RF.pop()}}}));

System.register("chunks:///_virtual/types.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){r=e.cclegacy}],execute:function(){e("isCross",(function(e){if(!e.elements||2!==e.elements.length)return!1;for(var r,n=t(e.elements);!(r=n()).done;){var s=r.value;if(!s.faces||2!==s.faces.length)return!1}return!0})),r._RF.push({},"3de25oPu0dNCZVKQuuPmZhB","types",void 0),r._RF.pop()}}}));

System.register("chunks:///_virtual/types2.ts",["cc"],(function(e){var n;return{setters:[function(e){n=e.cclegacy}],execute:function(){n._RF.push({},"d0549aU22ZGFYDLsMUnmKeP","types",void 0);e("EventType",function(e){return e.GAME_CREATED="GameCreatedEvent",e.PLAYER_JOINED="PlayerJoinedEvent",e.GAME_STARTED="GameStartedEvent",e.GAME_ENDED="GameEndedEvent",e.MAP_TEMPLATE_PUBLISHED="MapTemplatePublishedEvent",e.TURN_START="TurnStartEvent",e.SKIP_TURN="SkipTurnEvent",e.END_TURN="EndTurnEvent",e.ROUND_ENDED="RoundEndedEvent",e.BANKRUPT="BankruptEvent",e.BUILDING_DECISION="BuildingDecisionEvent",e.RENT_DECISION="RentDecisionEvent",e.DECISION_SKIPPED="DecisionSkippedEvent",e.USE_CARD_ACTION="UseCardActionEvent",e.ROLL_AND_STEP_ACTION="RollAndStepActionEvent",e}({}));n._RF.pop()}}}));

System.register("chunks:///_virtual/UI3DInteractionManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./fairygui.mjs","./EventBus.ts","./EventTypes.ts","./CameraController.ts"],(function(t){var e,n,o,i,s,a,c,r,u,h,l,p,D,y,E,T,f;return{setters:[function(t){e=t.applyDecoratedDescriptor,n=t.inheritsLoose,o=t.initializerDefineProperty,i=t.assertThisInitialized},function(t){s=t.cclegacy,a=t._decorator,c=t.Camera,r=t.Input,u=t.EventMouse,h=t.EventTouch,l=t.geometry,p=t.PhysicsSystem,D=t.Component},function(t){y=t.GRoot},function(t){E=t.EventBus},function(t){T=t.EventTypes},function(t){f=t.CameraController}],execute:function(){var v,M,I,d,g,m,b,U,S,C,O;s._RF.push({},"b03cdeElGhON5xhCfq0xYn7","UI3DInteractionManager",void 0);var R=a.ccclass,_=a.property;t("UI3DInteractionManager",(v=R("UI3DInteractionManager"),M=_(c),I=_({tooltip:"启用内置射线检测功能"}),d=_({tooltip:"启用调试日志"}),g=_({tooltip:"射线检测最大距离"}),v((U=e((b=function(t){function e(){for(var e,n=arguments.length,s=new Array(n),a=0;a<n;a++)s[a]=arguments[a];return e=t.call.apply(t,[this].concat(s))||this,o(e,"camera3D",U,i(e)),o(e,"enableBuiltinRaycast",S,i(e)),o(e,"enableDebug",C,i(e)),o(e,"maxRaycastDistance",O,i(e)),e}n(e,t);var s=e.prototype;return s.start=function(){this.enableDebug&&console.log("[UI3DInteractionManager] start"),this.camera3D||(this.camera3D=f.getMainCamera()),!this.camera3D&&this.enableDebug&&console.warn("[UI3DInteractionManager] 未找到3D相机")},s.onEnable=function(){this.node.on(r.EventType.MOUSE_DOWN,this.onMouseDown,this),this.node.on(r.EventType.MOUSE_UP,this.onMouseUp,this),this.node.on(r.EventType.MOUSE_MOVE,this.onMouseMove,this),this.node.on(r.EventType.MOUSE_WHEEL,this.onMouseWheel,this),this.node.on(r.EventType.TOUCH_START,this.onTouchStart,this),this.node.on(r.EventType.TOUCH_MOVE,this.onTouchMove,this),this.node.on(r.EventType.TOUCH_END,this.onTouchEnd,this),this.node.on(r.EventType.TOUCH_CANCEL,this.onTouchCancel,this)},s.onDisable=function(){this.node.off(r.EventType.MOUSE_DOWN,this.onMouseDown,this),this.node.off(r.EventType.MOUSE_UP,this.onMouseUp,this),this.node.off(r.EventType.MOUSE_MOVE,this.onMouseMove,this),this.node.off(r.EventType.MOUSE_WHEEL,this.onMouseWheel,this),this.node.off(r.EventType.TOUCH_START,this.onTouchStart,this),this.node.off(r.EventType.TOUCH_MOVE,this.onTouchMove,this),this.node.off(r.EventType.TOUCH_END,this.onTouchEnd,this),this.node.off(r.EventType.TOUCH_CANCEL,this.onTouchCancel,this)},s.onMouseDown=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.MouseDown,t)},s.onMouseUp=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.MouseUp,t)},s.onMouseMove=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.MouseMove,t)},s.onMouseWheel=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.MouseWheel,t)},s.onTouchStart=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.TouchStart,t)},s.onTouchMove=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.TouchMove,t)},s.onTouchEnd=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.TouchEnd,t)},s.onTouchCancel=function(t){this.shouldPassToScene(t)&&this.emit3DInputEvent(T.Input3D.TouchCancel,t)},s.shouldPassToScene=function(t){var e=y.inst.touchTarget;return e&&e!==y.inst?(this.enableDebug&&console.log("[UI3DInteractionManager] 点击到FairyGUI UI元素:",e.name),!1):(this.enableDebug&&console.log("[UI3DInteractionManager] 事件将传递给3D场景"),!0)},s.emit3DInputEvent=function(t,e){var n=e.getLocation(),o=e.getUILocation?e.getUILocation():n,i={type:t,screenX:n.x,screenY:n.y,uiX:o.x,uiY:o.y,originalEvent:e,timestamp:Date.now()};if(e instanceof u&&(i.button=e.getButton(),t===T.Input3D.MouseWheel)){var s=e.getScrollY();i.scrollDelta={x:0,y:s}}e instanceof h&&(i.touchId=e.getID()),E.emit(t,i),this.enableBuiltinRaycast&&this.camera3D&&this.performRaycastAndEmit(o.x,o.y,t),this.enableDebug&&console.log("[UI3DInteractionManager] 发送3D输入事件: "+t,i)},s.performRaycastAndEmit=function(t,e,n){try{var o=new l.Ray;this.camera3D.screenPointToRay(t,e,o);var i={rayOrigin:{x:o.o.x,y:o.o.y,z:o.o.z},rayDirection:{x:o.d.x,y:o.d.y,z:o.d.z},rayDistance:this.maxRaycastDistance,hit:!1,timestamp:Date.now()};if(p.instance.raycast(o,void 0,this.maxRaycastDistance)){var s=p.instance.raycastResults;if(s.length>0){var a=s[0];i.hit=!0,i.hitPoint={x:a.hitPoint.x,y:a.hitPoint.y,z:a.hitPoint.z},i.collider=a.collider,i.node=a.collider.node,i.rayResult=a,E.emit(T.Input3D.RaycastHit,i),this.enableDebug&&console.log("[UI3DInteractionManager] 射线检测命中:",i.node.name)}else i.hit=!1}i.hit||(E.emit(T.Input3D.RaycastMiss,i),this.enableDebug&&console.log("[UI3DInteractionManager] 射线检测未命中"))}catch(t){console.error("[UI3DInteractionManager] 射线检测出错:",t)}},e}(D)).prototype,"camera3D",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),S=e(b.prototype,"enableBuiltinRaycast",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),C=e(b.prototype,"enableDebug",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),O=e(b.prototype,"maxRaycastDistance",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),m=b))||m));s._RF.pop()}}}));

System.register("chunks:///_virtual/UIBankruptcy.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts"],(function(t){var e,n,o,r;return{setters:[function(t){e=t.inheritsLoose},function(t){n=t.cclegacy,o=t._decorator},function(t){r=t.UIBase}],execute:function(){var i;n._RF.push({},"e6bc37n2ARK5YgdfwxYvMDj","UIBankruptcy",void 0);var s=o.ccclass;t("UIBankruptcy",s("UIBankruptcy")(i=function(t){function n(){for(var e,n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(e=t.call.apply(t,[this].concat(o))||this)._titleText=null,e}e(n,t);var o=n.prototype;return o.onInit=function(){this._setupComponents()},o._setupComponents=function(){this._titleText=this.getText("title")},o.onShow=function(t){if(t){var e=this._buildMessage(t);this._titleText&&(this._titleText.text=e),console.log("[UIBankruptcy] 显示破产通知",t)}else console.warn("[UIBankruptcy] No data provided")},o._buildMessage=function(t){var e=[];return e.push(t.playerName+" 破产！"),e.push(""),t.debt>0&&e.push("欠款金额："+t.debt.toString()),t.creditorName&&e.push("债权人："+t.creditorName),e.join("\n")},o.onHide=function(){console.log("[UIBankruptcy] 隐藏破产通知")},n}(r))||i);n._RF.pop()}}}));

System.register("chunks:///_virtual/UIBase.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./Blackboard.ts","./fairygui.mjs","./GameSettings.ts"],(function(t){var n,i,e,s,o,u,r,h,a,l;return{setters:[function(t){n=t.inheritsLoose,i=t.createClass},function(t){e=t.cclegacy,s=t._decorator,o=t.Component},function(t){u=t.EventBus},function(t){r=t.Blackboard},function(t){h=t,a=t.GRoot},function(t){l=t.default}],execute:function(){var c;e._RF.push({},"c6164wkgTFI9YCuWQJTVXK/","UIBase",void 0);var d=s.ccclass;s.property,t("UIBase",d("UIBase")(c=function(t){function e(){for(var n,i=arguments.length,e=new Array(i),s=0;s<i;s++)e[s]=arguments[s];return(n=t.call.apply(t,[this].concat(e))||this)._panel=null,n._uiName="",n._inited=!1,n._isShowing=!1,n._data=null,n}n(e,t);var s=e.prototype;return s.onLoad=function(){},s.onEnable=function(){this._inited&&(this.bindEvents(),this._isShowing=!0,this.onShow(this._data))},s.onDisable=function(){this._inited&&(this.unbindEvents(),this._isShowing=!1,this.onHide())},s.onDestroy=function(){this._inited&&(this._inited=!1)},s.setUIName=function(t){this._uiName=t},s.setPanel=function(t){this._panel=t,this._inited||this._initComponent()},s._initComponent=function(){if(!this._inited&&this._panel)try{this.onInit(),this._inited=!0}catch(t){console.error("[UIBase] Error initializing UI "+this._uiName+":",t)}},s.init=function(){this._inited||(this.onInit(),this.bindEvents(),this._inited=!0)},s.show=function(t,n){if(void 0===n&&(n=!0),this._data=t,n){var i,e,s,o=(null==h||null==(i=a)?void 0:i.inst.width)||l.designWidth,u=(null==h||null==(e=a)?void 0:e.inst.height)||l.designHeight;null==(s=this._panel)||s.setSize(o,u),console.log("[UIBase] show, adjust size to "+o+"x"+u)}var r=this.node.active;this.node.active=!0,r&&this._inited&&(this._isShowing=!0,this.onShow(this._data))},s.hide=function(){this.node.active=!1},s.refresh=function(t){void 0!==t&&(this._data=t),this.onRefresh(this._data)},s.getChild=function(t){return this._panel?this._panel.getChild(t):null},s.getFGuiComponent=function(t){var n=this.getChild(t);return n?n.asCom:null},s.getButton=function(t){var n=this.getChild(t);return n||null},s.getText=function(t){var n=this.getChild(t);return n||null},s.getImage=function(t){var n=this.getChild(t);return n||null},s.getList=function(t){var n=this.getChild(t);return n||null},s.getLoader=function(t){var n=this.getChild(t);return n||null},s.getProgressBar=function(t){var n=this.getChild(t);return n||null},s.getSlider=function(t){var n=this.getChild(t);return n||null},s.getController=function(t){return this._panel?this._panel.getController(t):null},s.getTransition=function(t){return this._panel?this._panel.getTransition(t):null},s.onInit=function(){},s.bindEvents=function(){},s.unbindEvents=function(){u.offTarget(this),r.instance.unwatchTarget(this)},s.onShow=function(t){},s.onHide=function(){},s.onRefresh=function(t){},i(e,[{key:"uiName",get:function(){return this._uiName}},{key:"panel",get:function(){return this._panel}},{key:"isShowing",get:function(){return this._isShowing}},{key:"data",get:function(){return this._data}}]),e}(o))||c);e._RF.pop()}}}));

System.register("chunks:///_virtual/UICommonLayout.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./UIWallet.ts","./UICommonSetting.ts"],(function(i,n){var t,o,e,s,g,a;return{setters:[function(i){t=i.inheritsLoose},function(i){o=i.cclegacy,e=i._decorator},function(i){s=i.UIBase},function(i){g=i.UIWallet},function(i){a=i.UICommonSetting}],execute:function(){var m;o._RF.push({},"0a6c8Q4u2lHtqdd/qq3reG+","UICommonLayout",void 0);var u=e.ccclass;i("UICommonLayout",u("UICommonLayout")(m=function(i){function o(){for(var n,t=arguments.length,o=new Array(t),e=0;e<t;e++)o[e]=arguments[e];return(n=i.call.apply(i,[this].concat(o))||this).wallet=void 0,n.commonSetting=void 0,n.gameConfig=void 0,n.suiConfig=void 0,n.walletUI=void 0,n.settingUI=void 0,n.gameConfigUI=void 0,n.suiConfigUI=void 0,n}t(o,i),o.getPackageName=function(){return"Common"},o.getComponentName=function(){return"CommonLayout"};var e=o.prototype;return e.onInit=function(){var i=this;console.log("[UICommonLayout] Initializing..."),this.wallet=this.getFGuiComponent("wallet"),this.commonSetting=this.getFGuiComponent("commonSetting"),this.gameConfig=this.getFGuiComponent("gameConfig"),this.suiConfig=this.getFGuiComponent("suiConfig"),this.wallet&&this.commonSetting&&this.gameConfig&&this.suiConfig?(this.walletUI=this.wallet.node.addComponent(g),this.walletUI.setUIName("Wallet"),this.walletUI.setPanel(this.wallet),this.walletUI.init(),this.settingUI=this.commonSetting.node.addComponent(a),this.settingUI.setUIName("CommonSetting"),this.settingUI.setPanel(this.commonSetting),this.settingUI.init(),n.import("./UIGameConfig.ts").then((function(n){var t=n.UIGameConfig;i.gameConfigUI=i.gameConfig.node.addComponent(t),i.gameConfigUI.setUIName("GameConfig"),i.gameConfigUI.setPanel(i.gameConfig),i.gameConfigUI.init(),i.gameConfig.visible=!1,console.log("[UICommonLayout] GameConfig initialized (hidden by default)")})),n.import("./UISuiConfig.ts").then((function(n){var t=n.UISuiConfig;i.suiConfigUI=i.suiConfig.node.addComponent(t),i.suiConfigUI.setUIName("SuiConfig"),i.suiConfigUI.setPanel(i.suiConfig),i.suiConfigUI.init(),i.suiConfig.visible=!1,console.log("[UICommonLayout] SuiConfig initialized (hidden by default)")})),console.log("[UICommonLayout] Initialized with Wallet, CommonSetting, GameConfig, and SuiConfig")):console.error("[UICommonLayout] Failed to get child components")},e.getWallet=function(){return this.walletUI},e.getSetting=function(){return this.settingUI},e.getGameConfig=function(){return this.gameConfigUI},e.toggleGameConfig=function(){this.gameConfig?(this.gameConfig.visible=!this.gameConfig.visible,console.log("[UICommonLayout] GameConfig visible:",this.gameConfig.visible)):console.warn("[UICommonLayout] gameConfig component not initialized")},e.isGameConfigVisible=function(){var i;return(null==(i=this.gameConfig)?void 0:i.visible)||!1},e.toggleSuiConfig=function(){this.suiConfig?(this.suiConfig.visible=!this.suiConfig.visible,console.log("[UICommonLayout] SuiConfig visible:",this.suiConfig.visible)):console.warn("[UICommonLayout] suiConfig component not initialized")},e.isSuiConfigVisible=function(){var i;return(null==(i=this.suiConfig)?void 0:i.visible)||!1},e.getSuiConfig=function(){return this.suiConfigUI},e.showInGameButtons=function(){this.settingUI?this.settingUI.showInGameButtons():console.warn("[UICommonLayout] settingUI not initialized")},e.hideInGameButtons=function(){this.settingUI?this.settingUI.hideInGameButtons():console.warn("[UICommonLayout] settingUI not initialized")},e.showEnvButton=function(){this.settingUI?this.settingUI.showEnvButton():console.warn("[UICommonLayout] settingUI not initialized")},e.hideEnvButton=function(){this.settingUI?this.settingUI.hideEnvButton():console.warn("[UICommonLayout] settingUI not initialized")},o}(s))||m);o._RF.pop()}}}));

System.register("chunks:///_virtual/UICommonSetting.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./UIManager.ts","./EventBus.ts","./EventTypes.ts"],(function(t){var n,e,i,o,s,g,l;return{setters:[function(t){n=t.inheritsLoose},function(t){e=t.cclegacy,i=t._decorator},function(t){o=t.UIBase},function(t){s=t.UIManager},function(t){g=t.EventBus},function(t){l=t.EventTypes}],execute:function(){var c;e._RF.push({},"130ddaPcKhPtInge3SJwIK2","UICommonSetting",void 0);var a=i.ccclass;t("UICommonSetting",a("UICommonSetting")(c=function(t){function e(){for(var n,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];return(n=t.call.apply(t,[this].concat(i))||this).btn_gameConfig=void 0,n.btn_env=void 0,n.btn_playSetting=void 0,n.btn_debug=void 0,n}n(e,t),e.getPackageName=function(){return"Common"},e.getComponentName=function(){return"CommonSetting"};var i=e.prototype;return i.onInit=function(){this.btn_gameConfig=this.getButton("btn_gameConfig"),this.btn_env=this.getButton("btn_env"),this.btn_playSetting=this.getButton("btn_playSetting"),this.btn_debug=this.getButton("btn_debug"),this.btn_gameConfig.onClick(this.onGameConfigClick,this),this.btn_env.onClick(this.onEnvClick,this),this.btn_playSetting.onClick(this.onPlaySettingClick,this),this.btn_debug.onClick(this.onDebugClick,this),this.btn_env.visible=!1,this.hideInGameButtons(),g.on(l.UI.PlaySettingClosed,this.onPlaySettingClosed,this),g.on(l.UI.SuiConfigClosed,this.onSuiConfigClosed,this),console.log("[UICommonSetting] Initialized")},i.onGameConfigClick=function(){console.log("[UICommonSetting] Game Config button clicked"),s.instance.toggleGameConfig(),this.btn_gameConfig.selected=s.instance.isGameConfigVisible()},i.onEnvClick=function(){console.log("[UICommonSetting] Env button clicked"),s.instance.toggleSuiConfig(),this.btn_env.selected=s.instance.isSuiConfigVisible()},i.onPlaySettingClick=function(){console.log("[UICommonSetting] PlaySetting button clicked");var t=s.instance.getActiveUI("InGame");if(t&&"togglePlaySetting"in t){var n=t.togglePlaySetting();this.btn_playSetting.selected=n}else console.warn("[UICommonSetting] UIInGame not found or togglePlaySetting not available")},i.onDebugClick=function(){console.log("[UICommonSetting] Debug button clicked");var t=s.instance.getActiveUI("InGame");if(t&&"toggleDebug"in t){var n=t.toggleDebug();this.btn_debug.selected=n}else console.warn("[UICommonSetting] UIInGame not found or toggleDebug not available")},i.onPlaySettingClosed=function(){console.log("[UICommonSetting] PlaySetting closed event received"),this.btn_playSetting.selected=!1},i.onSuiConfigClosed=function(){console.log("[UICommonSetting] SuiConfig closed event received"),this.btn_env.selected=!1},i.showInGameButtons=function(){console.log("[UICommonSetting] Showing in-game buttons"),this.btn_playSetting&&(this.btn_playSetting.visible=!0,this.btn_playSetting.selected=!1),this.btn_debug&&(this.btn_debug.visible=!0,this.btn_debug.selected=!1)},i.hideInGameButtons=function(){console.log("[UICommonSetting] Hiding in-game buttons"),this.btn_playSetting&&(this.btn_playSetting.visible=!1,this.btn_playSetting.selected=!1),this.btn_debug&&(this.btn_debug.visible=!1,this.btn_debug.selected=!1)},i.showEnvButton=function(){console.log("[UICommonSetting] Showing env button"),this.btn_env&&(this.btn_env.visible=!0,this.btn_env.selected=!1)},i.hideEnvButton=function(){console.log("[UICommonSetting] Hiding env button"),this.btn_env&&(this.btn_env.visible=!1,this.btn_env.selected=!1)},i.unbindEvents=function(){this.btn_gameConfig&&this.btn_gameConfig.offClick(this.onGameConfigClick,this),this.btn_env&&this.btn_env.offClick(this.onEnvClick,this),this.btn_playSetting&&this.btn_playSetting.offClick(this.onPlaySettingClick,this),this.btn_debug&&this.btn_debug.offClick(this.onDebugClick,this),g.off(l.UI.PlaySettingClosed,this.onPlaySettingClosed,this),g.off(l.UI.SuiConfigClosed,this.onSuiConfigClosed,this),t.prototype.unbindEvents.call(this)},e}(o))||c);e._RF.pop()}}}));

System.register("chunks:///_virtual/UIEditor.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./MapManager.ts","./UIMessage.ts","./UINotification.ts","./SuiManager.ts","./MapTemplateExporter.ts"],(function(t){var e,n,i,o,s,l,a,r,c,h,d,u,p,m;return{setters:[function(t){e=t.inheritsLoose,n=t.asyncToGenerator,i=t.regeneratorRuntime},function(t){o=t.cclegacy,s=t._decorator},function(t){l=t.UIBase},function(t){a=t.EventBus},function(t){r=t.EventTypes},function(t){c=t.MapManager},function(t){h=t.UIMessage,d=t.MessageBoxIcon},function(t){u=t.UINotification},function(t){p=t.SuiManager},function(t){m=t.exportGameMapToMapTemplate}],execute:function(){var _;o._RF.push({},"95f10HOWilCiLvXQiWQsiOo","UIEditor",void 0);var I=s.ccclass;t("UIEditor",I("UIEditor")(_=function(t){function o(){for(var e,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))||this).m_btn_mapElement=void 0,e.m_btn_clearAll=void 0,e.m_btn_download=void 0,e.m_btn_assignId=void 0,e.m_btn_showIds=void 0,e.m_btn_showTileType=void 0,e.m_btn_calcBuildingEntrance=void 0,e.m_btn_toMoveMap=void 0,e._isShowingIds=!1,e._isShowingTileTypes=!1,e.m_tile=void 0,e.m_tileTitle=void 0,e.m_tileIcon=void 0,e.m_mapElementUI=void 0,e}e(o,t);var s=o.prototype;return s.onInit=function(){this._setupComponents(),this._setupDefaultValues()},s._setupComponents=function(){this.m_btn_mapElement=this.getChild("btn_mapElement"),this.m_btn_clearAll=this.getChild("btn_clearAll"),this.m_btn_download=this.getChild("btn_download"),this.m_btn_assignId=this.getChild("btn_assignId"),this.m_btn_showIds=this.getChild("btn_showIds"),this.m_btn_showTileType=this.getChild("btn_showTileType"),this.m_btn_calcBuildingEntrance=this.getChild("btn_calcBuildingEntrance"),this.m_btn_toMoveMap=this.getChild("btn_toMoveMap"),this.m_tile=this.getChild("tile").asCom,this.m_tile&&(this.m_tileTitle=this.m_tile.getChild("title"),this.m_tileIcon=this.m_tile.getChild("tileIcon"),this.m_tile.visible=!1),console.log("[UIEditor] Components setup completed")},s._setupDefaultValues=function(){},s.bindEvents=function(){this.m_btn_mapElement&&this.m_btn_mapElement.onClick(this._onMapElementClick,this),this.m_btn_clearAll&&this.m_btn_clearAll.onClick(this._onClearAllClick,this),this.m_btn_download&&this.m_btn_download.onClick(this._onDownloadClick,this),this.m_btn_assignId&&this.m_btn_assignId.onClick(this._onAssignIdClick,this),this.m_btn_showIds&&this.m_btn_showIds.onClick(this._onShowIdsClick,this),this.m_btn_showTileType&&this.m_btn_showTileType.onClick(this._onShowTileTypeClick,this),this.m_btn_calcBuildingEntrance&&this.m_btn_calcBuildingEntrance.onClick(this._onCalcBuildingEntranceClick,this),this.m_btn_toMoveMap&&this.m_btn_toMoveMap.onClick(this._onPublishMapClick,this),this.m_tile&&this.m_tile.onClick(this._onTileClick,this),a.on(r.UI.MapElementSelected,this._onMapElementSelected,this)},s.unbindEvents=function(){this.m_btn_mapElement&&this.m_btn_mapElement.offClick(this._onMapElementClick,this),this.m_btn_clearAll&&this.m_btn_clearAll.offClick(this._onClearAllClick,this),this.m_btn_download&&this.m_btn_download.offClick(this._onDownloadClick,this),this.m_btn_assignId&&this.m_btn_assignId.offClick(this._onAssignIdClick,this),this.m_btn_showIds&&this.m_btn_showIds.offClick(this._onShowIdsClick,this),this.m_btn_showTileType&&this.m_btn_showTileType.offClick(this._onShowTileTypeClick,this),this.m_btn_calcBuildingEntrance&&this.m_btn_calcBuildingEntrance.offClick(this._onCalcBuildingEntranceClick,this),this.m_btn_toMoveMap&&this.m_btn_toMoveMap.offClick(this._onPublishMapClick,this),this.m_tile&&this.m_tile.offClick(this._onTileClick,this),a.off(r.UI.MapElementSelected,this._onMapElementSelected,this),t.prototype.unbindEvents.call(this)},s.onShow=function(t){var e;console.log("[UIEditor] Showing editor UI"),this.updateEditorVisibility(),null==(e=this.m_mapElementUI)||e.hide(),this._isShowingIds=!1,this.m_btn_showIds&&(this.m_btn_showIds.title="显示ID"),this._isShowingTileTypes=!0,this.m_btn_showTileType&&(this.m_btn_showTileType.title="隐藏类型");var n=c.getInstance();if(n){var i=n.getCurrentMapInfo();i&&i.component&&i.component.hideIds()}},s.onHide=function(){console.log("[UIEditor] Hiding editor UI");var t=c.getInstance();if(t){var e=t.getCurrentMapInfo();e&&e.component&&(e.component.hideIds(),e.component.clearTileTypeOverlays())}this._isShowingIds=!1,this.m_btn_showIds&&(this.m_btn_showIds.title="显示ID"),this._isShowingTileTypes=!1,this.m_btn_showTileType&&(this.m_btn_showTileType.title="显示类型")},s.onRefresh=function(t){var e;this.updateEditorVisibility(),null==(e=this.m_mapElementUI)||e.hide()},s.updateEditorVisibility=function(){var t=c.getInstance().getCurrentMapEditMode();this.node.active=t},s.setMapElementUI=function(t){this.m_mapElementUI=t},s._onMapElementClick=function(){console.log("[UIEditor] Map element button clicked"),this._toggleMapElementUI()},s._onTileClick=function(){console.log("[UIEditor] Tile clicked"),this._toggleMapElementUI()},s._toggleMapElementUI=function(){this.m_mapElementUI?this.m_mapElementUI.isShowing?(this.m_mapElementUI.hide(),console.log("[UIEditor] MapElement UI hidden")):(this.m_mapElementUI.show(void 0,!1),console.log("[UIEditor] MapElement UI shown")):console.warn("[UIEditor] MapElement UI not found")},s._onMapElementSelected=function(t){if(this.m_tile){if(this.m_tile.visible=!0,this.m_tile.data=t.blockId,this.m_tileTitle){var e=t.blockName||"";void 0!==t.tileId&&65535!==t.tileId?e+=" [T"+t.tileId+"]":void 0!==t.buildingId&&65535!==t.buildingId&&(e+=" [B"+t.buildingId+"]"),this.m_tileTitle.text=e}this.m_tileIcon&&t.spriteFrame&&(this.m_tileIcon.texture=t.spriteFrame),console.log("[UIEditor] Tile selected: "+t.blockName)}},s.getSelectedBlock=function(){var t;return this.m_tile&&this.m_tile.visible?{blockId:this.m_tile.data||"",blockName:(null==(t=this.m_tileTitle)?void 0:t.text)||""}:null},s.clearSelectedBlock=function(){this.m_tile&&(this.m_tile.visible=!1,this.m_tile.data=null),this.m_tileTitle&&(this.m_tileTitle.text=""),this.m_tileIcon&&(this.m_tileIcon.texture=null)},s._onClearAllClick=function(){console.log("[UIEditor] Clear all button clicked");var t=c.getInstance();if(t){var e=t.getCurrentMapInfo();e&&e.component&&(e.component.clearAllPlacedBlocks(),this.clearSelectedBlock(),a.emit(r.Map.AllBlocksCleared),console.log("[UIEditor] All blocks cleared"))}},s._onCalcBuildingEntranceClick=function(){var t=n(i().mark((function t(){var e,n,o;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UIEditor] Calculate building entrance button clicked"),!(e=c.getInstance())){t.next=16;break}if(!(n=e.getCurrentMapInfo())||!n.component){t.next=16;break}if(!n.component.calculateBuildingEntrances()){t.next=13;break}return o=n.component.getBuildingCount(),t.next=10,h.success("建筑入口计算完成！\n\n已处理 "+o+" 个建筑的入口关联","计算成功");case 10:console.log("[UIEditor] ✓ Building entrances calculated successfully"),t.next=16;break;case 13:return t.next=15,h.warning("建筑入口计算失败\n\n可能原因：\n• 入口tile数量不正确\n  (1x1建筑需要1个，2x2建筑需要2个)\n• 入口tile类型必须为EMPTY_LAND\n• 建筑朝向设置有误\n\n请检查<color=#ffaa00>控制台</color>的详细警告信息","验证失败");case 15:console.error("[UIEditor] ✗ Calculation failed - check warnings above");case 16:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),s._onPublishMapClick=function(){var t=n(i().mark((function t(){var e,o,s,l,_,I,g,b,f=this;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UIEditor] Publish map to Move clicked"),t.prev=1,p.instance.isConnected){t.next=6;break}return t.next=5,h.warning("请先连接钱包\n\n需要钱包签名才能发布地图到链上","未连接钱包");case 5:return t.abrupt("return");case 6:if(e=c.getInstance()){t.next=11;break}return t.next=10,h.error("地图管理器未初始化","错误");case 10:return t.abrupt("return");case 11:if((o=e.getCurrentMapInfo())&&o.component){t.next=16;break}return t.next=15,h.error("当前没有加载的地图","错误");case 15:return t.abrupt("return");case 16:if(s=o.component,console.log("[UIEditor] Validating map..."),s.calculateBuildingEntrances()){t.next=23;break}return t.next=22,h.error("建筑入口验证失败！\n\n请检查控制台中的警告信息\n\n常见问题：\n• 建筑周围缺少空地 tile\n• 入口 tile 的类型不是 EMPTY_LAND\n• 1x1 建筑应有 1 个入口\n• 2x2 建筑应有 2 个入口\n\n修复后地图会自动保存，然后重新点击此按钮","验证失败");case 22:return t.abrupt("return");case 23:return console.log("[UIEditor] ✓ Map validation passed"),console.log("[UIEditor] Exporting map template..."),l=m(s,"0"),console.log("[UIEditor] ✓ Map template exported"),_="确认发布地图到 Sui 链上？\n\n✓ 地块数量: "+l.tiles_static.size+"\n✓ 建筑数量: "+l.buildings_static.size+"\n✓ 医院数量: "+l.hospital_ids.length+"\n\n注意：\n• 发布后无法修改\n• 需要消耗 Gas 费用\n• 数据已通过完整验证\n\n确认继续？",t.next=30,h.confirm({message:_,title:"确认发布",confirmText:"确认",cancelText:"取消"});case 30:if(t.sent){t.next=34;break}return console.log("[UIEditor] User cancelled"),t.abrupt("return");case 34:return u.info("正在发布地图到链上，请在钱包中确认..."),t.next=37,p.instance.publishMapTemplate(l);case 37:return I=t.sent,console.log("[UIEditor] ✓ Map published successfully"),console.log("  Template ID:",I.templateId),console.log("  Tx Hash:",I.txHash),g=p.instance.getExplorer(I.txHash,"txblock"),t.next=44,h.show({title:"发布成功",message:"地图发布成功！\n\n模板 ID: "+I.templateId+"\n交易哈希: "+I.txHash+"\n\n✓ 数据已写入区块链\n✓ 玩家现在可以使用此地图创建游戏",icon:d.SUCCESS,buttons:{primary:{text:"返回创建游戏",callback:function(){try{f._returnToMapSelectWithTemplate(I.templateId)}catch(t){console.error("[UIEditor] Primary callback error:",t)}}},secondary:{text:"查看详情",visible:!0,callback:function(){try{u.info("正在打开区块链浏览器..."),p.instance.openUrl(g)}catch(t){console.error("[UIEditor] Secondary callback error:",t)}}},btn_3:{text:"创建游戏",visible:!0,callback:function(){var t=n(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UIEditor] Creating game with template:",I.templateId),t.prev=1,a.emit(r.Game.RequestMapChange,{toMapId:null}),a.emit(r.UI.ShowMapSelect,{category:0}),t.next=6,p.instance.createGameWithTemplate(I.templateId);case 6:t.next=12;break;case 8:t.prev=8,t.t0=t.catch(1),console.error("[UIEditor] Create game error:",t.t0),a.emit(r.UI.ShowMapSelect,{category:0});case 12:case"end":return t.stop()}}),t,null,[[1,8]])})));return function(){return t.apply(this,arguments)}}()},close:{visible:!1}}});case 44:t.next=52;break;case 46:return t.prev=46,t.t0=t.catch(1),console.error("[UIEditor] Failed to publish map:",t.t0),b=t.t0 instanceof Error?t.t0.message:String(t.t0),t.next=52,h.error("发布失败\n\n"+b+"\n\n详细错误信息已输出到控制台","发布失败");case 52:return t.prev=52,this.m_btn_toMoveMap&&(this.m_btn_toMoveMap.enabled=!0,console.log("[UIEditor] Publish button re-enabled")),t.finish(52);case 55:case"end":return t.stop()}}),t,this,[[1,46,52,55]])})));return function(){return t.apply(this,arguments)}}(),s._returnToMapSelectWithTemplate=function(t){console.log("[UIEditor] Returning to UIMapSelect"),console.log("  Template ID:",t),a.emit(r.Game.RequestMapChange,{toMapId:null}),a.emit(r.UI.ShowMapSelect,{category:1,selectTemplateId:t}),console.log("[UIEditor] Returning to map selection with template selected")},s._onDownloadClick=function(){console.log("[UIEditor] Download button clicked"),this._downloadCurrentMap()},s._onAssignIdClick=function(){var t=n(i().mark((function t(){var e,n,o,s,l,a,r;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UIEditor] Assign ID button clicked"),!(e=c.getInstance())){t.next=22;break}if(!(n=e.getCurrentMapInfo())||!n.component){t.next=22;break}return t.prev=5,n.component.assignIds(),o=n.component.getTileCount(),s=n.component.getBuildingCount(),l=n.component.getTotalTileCount(),a=n.component.getTotalBuildingCount(),t.next=13,h.success("编号分配完成！\n\n• Tiles: "+o+"/"+l+"\n• Buildings: "+s+"/"+a,"分配成功");case 13:console.log("[UIEditor] IDs assigned successfully"),t.next=22;break;case 16:return t.prev=16,t.t0=t.catch(5),r=t.t0 instanceof Error?t.t0.message:String(t.t0),t.next=21,h.error("编号分配失败：\n"+r,"操作失败");case 21:console.error("[UIEditor] Assign ID failed:",t.t0);case 22:case"end":return t.stop()}}),t,null,[[5,16]])})));return function(){return t.apply(this,arguments)}}(),s._onShowIdsClick=function(){var t=n(i().mark((function t(){var e,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UIEditor] Show IDs button clicked"),!(e=c.getInstance())){t.next=15;break}if(!(n=e.getCurrentMapInfo())||!n.component){t.next=15;break}if(this._isShowingIds=!this._isShowingIds,!this._isShowingIds){t.next=12;break}return t.next=9,n.component.showIdsWithOverlay();case 9:this.m_btn_showIds&&(this.m_btn_showIds.title="隐藏ID"),t.next=14;break;case 12:n.component.hideIdsWithOverlay(),this.m_btn_showIds&&(this.m_btn_showIds.title="显示ID");case 14:console.log("[UIEditor] IDs "+(this._isShowingIds?"shown":"hidden")+" (3D Overlay only)");case 15:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),s._onShowTileTypeClick=function(){var t=n(i().mark((function t(){var e,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UIEditor] Show tile type button clicked"),!(e=c.getInstance())){t.next=15;break}if(!(n=e.getCurrentMapInfo())||!n.component){t.next=15;break}if(this._isShowingTileTypes=!this._isShowingTileTypes,!this._isShowingTileTypes){t.next=12;break}return t.next=9,n.component.showTileTypeOverlays();case 9:this.m_btn_showTileType&&(this.m_btn_showTileType.title="隐藏类型"),t.next=14;break;case 12:n.component.clearTileTypeOverlays(),this.m_btn_showTileType&&(this.m_btn_showTileType.title="显示类型");case 14:console.log("[UIEditor] Tile types "+(this._isShowingTileTypes?"shown":"hidden"));case 15:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),s._downloadCurrentMap=function(){var t=n(i().mark((function t(){var e,n,o,s,l,a,r,h,d,u;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e=c.getInstance(),n=null==e?void 0:e.getCurrentMapInfo()){t.next=6;break}return console.warn("[UIEditor] No current map info"),t.abrupt("return");case 6:if(o=n.component,s=n.mapId,l="map_"+s,a=localStorage.getItem(l)){t.next=14;break}return t.next=13,o.saveImmediate();case 13:a=localStorage.getItem(l);case 14:if(a){t.next=17;break}return console.warn("[UIEditor] No MapSaveData found in localStorage:",l),t.abrupt("return");case 17:r=s+".json",h=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(h),(u=document.createElement("a")).href=d,u.download=r,u.click(),URL.revokeObjectURL(d),console.log("[UIEditor] Download triggered: "+r),t.next=31;break;case 28:t.prev=28,t.t0=t.catch(0),console.error("[UIEditor] Download failed:",t.t0);case 31:case"end":return t.stop()}}),t,null,[[0,28]])})));return function(){return t.apply(this,arguments)}}(),o}(l))||_);o._RF.pop()}}}));

System.register("chunks:///_virtual/UIFairyGUIAdapter.ts",["./rollupPluginModLoBabelHelpers.js","cc","./fairygui.mjs","./GameSettings.ts","./EventBus.ts","./EventTypes.ts"],(function(t){var e,n,i,a,s,o,r,l,c,h,u,p;return{setters:[function(t){e=t.inheritsLoose},function(t){n=t.cclegacy,i=t._decorator,a=t.view,s=t.game,o=t.Game,r=t.Component},function(t){l=t,c=t.GRoot},function(t){h=t.default},function(t){u=t.EventBus},function(t){p=t.EventTypes}],execute:function(){var d;n._RF.push({},"063a4b+mytG4IbMPr63BCtu","UIFairyGUIAdapter",void 0);var f=i.ccclass;i.property,t("UIFairyGUIAdapter",f("UIFairyGUIAdapter")(d=function(t){function n(){for(var e,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(e=t.call.apply(t,[this].concat(i))||this).designWidth=h.designWidth,e.designHeight=h.designHeight,e.applyScale=function(){var t,n,i;if(null!=l&&null!=(t=c)&&t.inst){var a=(null==l||null==(n=c)?void 0:n.inst.width)||e.designWidth,s=(null==l||null==(i=c)?void 0:i.inst.height)||e.designHeight;u.emit(p.UI.ScreenSizeChanged,{width:a,height:s})}},e}e(n,t);var i=n.prototype;return i.onLoad=function(){a.on("frame-size-changed",this.applyScale,this),a.on("design-resolution-changed",this.applyScale,this),s.on(o.EVENT_SHOW,this.applyScale,this)},i.onDestroy=function(){a.off("frame-size-changed",this.applyScale,this),a.off("design-resolution-changed",this.applyScale,this),s.off(o.EVENT_SHOW,this.applyScale,this)},n}(r))||d);n._RF.pop()}}}));

System.register("chunks:///_virtual/UIGameConfig.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./UINotification.ts","./UIMessage.ts","./RpcConfigManager.ts"],(function(t){var o,n,e,i,s,c,a;return{setters:[function(t){o=t.inheritsLoose},function(t){n=t.cclegacy,e=t._decorator},function(t){i=t.UIBase},function(t){s=t.UINotification},function(t){c=t.UIMessage},function(t){a=t.RpcConfigManager}],execute:function(){var r;n._RF.push({},"589aapZ5DxGr6BgZoR56NOZ","UIGameConfig",void 0);var l=e.ccclass;t("UIGameConfig",l("UIGameConfig")(r=function(t){function n(){for(var o,n=arguments.length,e=new Array(n),i=0;i<n;i++)e[i]=arguments[i];return(o=t.call.apply(t,[this].concat(e))||this).btn_rateLimitRPC=void 0,o.btn_useCustomPRC=void 0,o.rpcUrl=void 0,o.btn_close=void 0,o}o(n,t),n.getPackageName=function(){return"Common"},n.getComponentName=function(){return"GameConfig"};var e=n.prototype;return e.onInit=function(){this.btn_rateLimitRPC=this.getButton("btn_rateLimitRPC"),this.btn_useCustomPRC=this.getButton("btn_useCustomPRC"),this.rpcUrl=this.getText("rpcUrl"),this.btn_close=this.getButton("btn_close"),this.btn_rateLimitRPC.onClick(this.onToggleRateLimit,this),this.btn_useCustomPRC.onClick(this.onApplyCustomRpc,this),this.btn_close.onClick(this.onClose,this),console.log("[UIGameConfig] Initialized")},e.onShow=function(){this.loadCurrentConfig()},e.loadCurrentConfig=function(){var t=a.getMode();this.btn_rateLimitRPC.selected="ratelimit"===t;var o=a.getCustomRpcUrl();this.rpcUrl.text=o||"",console.log("[UIGameConfig] Loaded config:",{mode:t,customRpc:o})},e.onToggleRateLimit=function(){var t=this.btn_rateLimitRPC.selected,o=t?"ratelimit":"default";a.setMode(o),console.log("[UIGameConfig] Mode changed to:",o),t?s.success("限速模式已启用"):s.success("限速模式已取消")},e.onApplyCustomRpc=function(){var t=this.rpcUrl.text.trim();if(!t||t.startsWith("http")){a.setCustomRpc(t||void 0);var o=t?"自定义 RPC 已保存：\n\n"+t+"\n\n刷新页面后生效":"已清除自定义 RPC，将使用默认 RPC\n\n刷新页面后生效";console.log("[UIGameConfig] Custom RPC set to:",t||"none"),c.success(o,"配置已保存")}else s.error("RPC URL 必须以 http:// 或 https:// 开头")},e.onClose=function(){this.panel&&(this.panel.visible=!1,console.log("[UIGameConfig] Closed (set visible = false)"))},n}(i))||r);n._RF.pop()}}}));

System.register("chunks:///_virtual/UIGameDetail.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./SuiManager.ts","./UINotification.ts","./UIMessage.ts","./IdFormatter.ts","./EventBus.ts","./EventTypes.ts","./constants.ts"],(function(t){var e,n,a,i,s,r,o,l,m,c,u,_,h,d;return{setters:[function(t){e=t.inheritsLoose,n=t.asyncToGenerator,a=t.regeneratorRuntime},function(t){i=t.cclegacy,s=t._decorator},function(t){r=t.UIBase},function(t){o=t.SuiManager},function(t){l=t.UINotification},function(t){m=t.UIMessage},function(t){c=t.IdFormatter},function(t){u=t.EventBus},function(t){_=t.EventTypes},function(t){h=t.GameStatus,d=t.DEFAULT_MAX_PLAYERS}],execute:function(){var p;i._RF.push({},"7932275TpJAK6xv+sMrquZy","UIGameDetail",void 0);var G=s.ccclass;t("UIGameDetail",G("UIGameDetail")(p=function(t){function i(){for(var e,n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))||this).m_btn_ok=void 0,e.m_btn_quitGame=void 0,e.m_btn_startGame=void 0,e.m_gameid=void 0,e.m_mapid=void 0,e.m_player_0=void 0,e.m_player_1=void 0,e.m_player_2=void 0,e.m_player_3=void 0,e._parentUI=null,e}e(i,t);var s=i.prototype;return s.onInit=function(){this._setupComponents()},s._setupComponents=function(){this.m_btn_ok=this.getButton("btn_ok"),this.m_btn_quitGame=this.getButton("btn_quitGame"),this.m_btn_startGame=this.getButton("btn_startGame"),this.m_gameid=this.getText("gameid"),this.m_mapid=this.getText("mapid"),this.m_player_0=this.getText("player_0"),this.m_player_1=this.getText("player_1"),this.m_player_2=this.getText("player_2"),this.m_player_3=this.getText("player_3"),console.log("[UIGameDetail] Components setup"),console.log("  Buttons found:",!!this.m_btn_ok,!!this.m_btn_quitGame,!!this.m_btn_startGame)},s.bindEvents=function(){var t,e,n;null==(t=this.m_btn_ok)||t.onClick(this._onOkClick,this),null==(e=this.m_btn_quitGame)||e.onClick(this._onQuitGameClick,this),null==(n=this.m_btn_startGame)||n.onClick(this._onStartGameClick,this),u.on(_.Move.PlayerJoined,this._onPlayerJoinedEvent,this)},s.unbindEvents=function(){var e,n,a;null==(e=this.m_btn_ok)||e.offClick(this._onOkClick,this),null==(n=this.m_btn_quitGame)||n.offClick(this._onQuitGameClick,this),null==(a=this.m_btn_startGame)||a.offClick(this._onStartGameClick,this),u.off(_.Move.PlayerJoined,this._onPlayerJoinedEvent,this),t.prototype.unbindEvents.call(this)},s.setParentUI=function(t){this._parentUI=t},s.showGame=function(){var t=o.instance.currentGame;if(!t)return console.error("[UIGameDetail] No current game"),void l.error("无法获取游戏详情");console.log("[UIGameDetail] Showing game:",t.id),this.m_gameid&&(this.m_gameid.text=t.id),this.m_mapid&&(this.m_mapid.text=t.template_map_id);for(var e=o.instance.currentAddress,n=t.players.some((function(t){return t.owner===e})),a=0;a<4;a++){var i=this["m_player_"+a];if(i)if(a<t.players.length){var s=t.players[a];i.text=c.shortenAddress(s.owner)}else i.text="---"}var r=t.status===h.ACTIVE,m=t.status===h.ENDED,u=t.players.length<d,_=t.players.length>=2;m?(this.m_btn_startGame.title="回放(开发中)",this.m_btn_startGame.visible=!0,this.m_btn_startGame.enabled=!1,this.m_btn_startGame.grayed=!0,this.m_btn_quitGame.visible=!1):r?n?(this.m_btn_startGame.title="继续游戏",this.m_btn_startGame.visible=!0,this.m_btn_startGame.enabled=!0,this.m_btn_startGame.grayed=!1,this.m_btn_quitGame.visible=!0):(this.m_btn_startGame.visible=!1,this.m_btn_quitGame.visible=!1):n?(this.m_btn_startGame.title="开始游戏",this.m_btn_startGame.visible=!0,this.m_btn_startGame.enabled=_,this.m_btn_startGame.grayed=!_,this.m_btn_quitGame.visible=!0):u?(this.m_btn_startGame.title="加入游戏",this.m_btn_startGame.visible=!0,this.m_btn_startGame.enabled=!0,this.m_btn_startGame.grayed=!1,this.m_btn_quitGame.visible=!1):(this.m_btn_startGame.title="已满员",this.m_btn_startGame.visible=!0,this.m_btn_startGame.enabled=!1,this.m_btn_startGame.grayed=!0,this.m_btn_quitGame.visible=!1),console.log("[UIGameDetail] Game displayed"),console.log("  Players count:",t.players.length),console.log("  Is player:",n),console.log("  Can join:",u),console.log("  Can start:",_)},s._onOkClick=function(){console.log("[UIGameDetail] OK clicked, returning to main panel"),this._parentUI&&this._parentUI.showMainPanel&&this._parentUI.showMainPanel()},s._onQuitGameClick=function(){console.log("[UIGameDetail] Quit game clicked"),l.info("退出游戏功能待实现")},s._onStartGameClick=function(){var t=n(a().mark((function t(){var e,n,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UIGameDetail] Start/Join/Continue game clicked"),e=o.instance.currentGame){t.next=5;break}return console.error("[UIGameDetail] No current game"),t.abrupt("return");case 5:if(n=o.instance.currentAddress,i=e.players.some((function(t){return t.owner===n})),!(e.status===h.ACTIVE)||!i){t.next=13;break}return t.next=11,this._handleContinueGame(e);case 11:t.next=20;break;case 13:if(!i){t.next=18;break}return t.next=16,this._handleStartGame(e);case 16:t.next=20;break;case 18:return t.next=20,this._handleJoinGame(e);case 20:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),s._handleStartGame=function(){var t=n(a().mark((function t(e){var n,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(e.players.length<2)){t.next=3;break}return l.warning("至少需要 2 名玩家才能开始游戏"),t.abrupt("return");case 3:return t.prev=3,l.info("正在开始游戏..."),t.next=7,o.instance.startGame(e.id,e.template_map_id);case 7:return n=t.sent,console.log("[UIGameDetail] Game started successfully"),console.log("  Starting player:",n.startingPlayer),console.log("  TX hash:",n.txHash),t.next=13,m.success("游戏开始成功！\n\n游戏 ID: "+e.id+"\n玩家数: "+e.players.length+"\n起始玩家: "+c.shortenAddress(n.startingPlayer)+"\n交易哈希: "+n.txHash+"\n\n正在加载游戏场景...","游戏开始");case 13:t.next=21;break;case 15:return t.prev=15,t.t0=t.catch(3),console.error("[UIGameDetail] Failed to start game:",t.t0),i=(null==t.t0?void 0:t.t0.message)||(null==t.t0?void 0:t.t0.toString())||"未知错误",t.next=21,m.error("开始游戏失败\n\n错误信息: "+i+"\n\n请检查网络连接或稍后重试","开始失败");case 21:case"end":return t.stop()}}),t,null,[[3,15]])})));return function(e){return t.apply(this,arguments)}}(),s._handleJoinGame=function(){var t=n(a().mark((function t(e){var n,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,l.info("正在加入游戏..."),t.next=4,o.instance.joinGame(e.id);case 4:return n=t.sent,console.log("[UIGameDetail] Joined game successfully"),console.log("  Seat ID:",n.seatId),console.log("  Player index:",n.playerIndex),t.next=10,m.success("加入游戏成功！\n\n座位 ID: "+n.seatId+"\n玩家序号: #"+(n.playerIndex+1)+"\n交易哈希: "+n.txHash+"\n\n等待其他玩家加入或游戏开始...","加入成功");case 10:t.next=18;break;case 12:return t.prev=12,t.t0=t.catch(0),console.error("[UIGameDetail] Failed to join game:",t.t0),i=(null==t.t0?void 0:t.t0.message)||(null==t.t0?void 0:t.t0.toString())||"未知错误",t.next=18,m.error("加入游戏失败\n\n错误信息: "+i+"\n\n请检查网络连接或稍后重试","加入失败");case 18:case"end":return t.stop()}}),t,null,[[0,12]])})));return function(e){return t.apply(this,arguments)}}(),s._handleContinueGame=function(){var t=n(a().mark((function t(e){var n;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,l.info("正在加载游戏场景..."),t.next=4,o.instance.loadGameScene(e.id,e.template_map_id);case 4:console.log("[UIGameDetail] Game scene loaded"),t.next=13;break;case 7:return t.prev=7,t.t0=t.catch(0),console.error("[UIGameDetail] Failed to continue game:",t.t0),n=(null==t.t0?void 0:t.t0.message)||(null==t.t0?void 0:t.t0.toString())||"未知错误",t.next=13,m.error("加载游戏场景失败\n\n错误信息: "+n+"\n\n请检查网络连接或稍后重试","加载失败");case 13:case"end":return t.stop()}}),t,null,[[0,7]])})));return function(e){return t.apply(this,arguments)}}(),s._onPlayerJoinedEvent=function(t){var e=o.instance.currentGame;e&&t.game===e.id&&(console.log("[UIGameDetail] PlayerJoined event for current game, refreshing"),this.showGame())},i}(r))||p);i._RF.pop()}}}));

System.register("chunks:///_virtual/UIGameEnd.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts"],(function(n,t){var e,i,s,o,r,a;return{setters:[function(n){e=n.inheritsLoose,i=n.asyncToGenerator,s=n.regeneratorRuntime},function(n){o=n.cclegacy,r=n._decorator},function(n){a=n.UIBase}],execute:function(){var u;o._RF.push({},"06792KzLaZLW4h0YK4tKCnU","UIGameEnd",void 0);var c=r.ccclass;n("UIGameEnd",c("UIGameEnd")(u=function(n){function o(){for(var t,e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];return(t=n.call.apply(n,[this].concat(i))||this)._titleText=null,t._btnEnd=null,t}e(o,n);var r=o.prototype;return r.onInit=function(){this._setupComponents()},r._setupComponents=function(){this._titleText=this.getText("title"),this._btnEnd=this.getButton("btn_end")},r.bindEvents=function(){this._btnEnd&&this._btnEnd.onClick(this._onEndClick,this)},r.unbindEvents=function(){this._btnEnd&&this._btnEnd.offClick(this._onEndClick,this),n.prototype.unbindEvents.call(this)},r.onShow=function(n){if(n){var t=this._buildMessage(n);this._titleText&&(this._titleText.text=t),console.log("[UIGameEnd] 显示游戏结束界面",n)}else console.warn("[UIGameEnd] No data provided")},r._buildMessage=function(n){var t=[];return t.push("游戏结束！"),t.push(""),n.winner?t.push("🏆 获胜者："+n.winnerName):t.push("无获胜者"),t.push(""),t.push("结束原因："+n.reasonText),t.push("游戏轮次：第 "+n.round+" 轮"),t.push("当前回合：第 "+n.turn+" 回合"),t.join("\n")},r._onEndClick=function(){var n=i(s().mark((function n(){var e,i;return s().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log("[UIGameEnd] btn_end clicked, exiting game"),this.hide(),n.next=4,t.import("./UIManager.ts");case 4:e=n.sent,(i=e.UIManager)&&i.instance?i.instance.exitGame():console.error("[UIGameEnd] UIManager not found");case 7:case"end":return n.stop()}}),n,this)})));return function(){return n.apply(this,arguments)}}(),r.onHide=function(){console.log("[UIGameEnd] 隐藏游戏结束界面")},o}(a))||u);o._RF.pop()}}}));

System.register("chunks:///_virtual/UIGameList.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./SuiManager.ts","./UINotification.ts","./IdFormatter.ts","./EventBus.ts","./EventTypes.ts","./constants.ts"],(function(e){var t,s,i,n,a,o,l,r,c,m,d,h;return{setters:[function(e){t=e.inheritsLoose,s=e.asyncToGenerator,i=e.regeneratorRuntime},function(e){n=e.cclegacy,a=e._decorator},function(e){o=e.UIBase},function(e){l=e.SuiManager},function(e){r=e.UINotification},function(e){c=e.IdFormatter},function(e){m=e.EventBus},function(e){d=e.EventTypes},function(e){h=e.getGameStatusText}],execute:function(){var u;n._RF.push({},"b45baYVT7tK0b97NJoWbO1Z","UIGameList",void 0);var _=a.ccclass;e("UIGameList",_("UIGameList")(u=function(e){function n(){for(var t,s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];return(t=e.call.apply(e,[this].concat(i))||this).m_list=void 0,t.m_btn_joinGame=void 0,t._games=[],t._selectedGameId=null,t._selectedIndex=-1,t}t(n,e);var a=n.prototype;return a.onInit=function(){this._setupComponents()},a._setupComponents=function(){this.m_btn_joinGame=this.getButton("btn_joinGame"),this.m_list=this.getList("game_id"),console.log("[UIGameList] Components setup"),console.log("  m_btn_joinGame:",!!this.m_btn_joinGame),console.log("  m_list:",!!this.m_list)},a.bindEvents=function(){var e;null==(e=this.m_btn_joinGame)||e.onClick(this._onJoinGameClick,this),m.on(d.Sui.GamesListUpdated,this._onGamesListUpdated,this)},a.unbindEvents=function(){var t;null==(t=this.m_btn_joinGame)||t.offClick(this._onJoinGameClick,this),m.off(d.Sui.GamesListUpdated,this._onGamesListUpdated,this),e.prototype.unbindEvents.call(this)},a.refresh=function(){var e=this;if(console.log("[UIGameList] Refreshing game list"),this._games=l.instance.getCachedGames(),console.log("[UIGameList] Loaded "+this._games.length+" games"),this.m_list){this.m_list.numItems=this._games.length,console.log("  List updated, numItems:",this.m_list.numItems);for(var t=0;t<this._games.length;t++){var s=this.m_list.getChildAt(t);s&&this._renderItem(t,s)}if(this._selectedGameId){var i=this._games.findIndex((function(t){return t.id===e._selectedGameId}));i>=0?(this._selectGame(i),console.log("  Kept previous selection:",this._selectedGameId)):this._games.length>0&&(this._selectGame(0),console.log("  Previous game not found, selected first"))}else this._games.length>0&&(this._selectGame(0),console.log("  First load, selected first game"))}},a._renderItem=function(e,t){if(!(e>=this._games.length)){var s=this._games[e],i=t.asCom,n=i.getChild("index");n&&(n.text=(e+1).toString());var a=i.getChild("gameid");a&&(a.text=s.id);var o=i.getChild("mapid");o&&(o.text=s.template_map_id||"N/A");var l=i.getChild("status");l&&(l.text=h(s.status));for(var r=0;r<4;r++){var m=i.getChild("player_"+r);if(m)if(r<s.players.length){var d=s.players[r];m.text=c.shortenAddress(d.owner)}else m.text="---"}i.selected=e===this._selectedIndex,i.data=e,i.offClick(this._onItemClick,this),i.onClick(this._onItemClick,this)}},a._selectGame=function(e){if(!(e<0||e>=this._games.length)){this._selectedIndex=e;var t=this._games[e];this._selectedGameId=t.id,console.log("[UIGameList] Selected game: "+t.id),this.m_list&&(this.m_list.selectedIndex=e)}},a._onJoinGameClick=function(){var e=s(i().mark((function e(){var t;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIGameList] Join game clicked"),this._selectedGameId){e.next=4;break}return r.warning("请先选择游戏"),e.abrupt("return");case 4:if(l.instance.isConnected){e.next=7;break}return r.warning("请先连接钱包"),e.abrupt("return");case 7:return e.prev=7,r.info("正在加入游戏..."),e.next=11,l.instance.joinGame(this._selectedGameId);case 11:t=e.sent,console.log("[UIGameList] Joined game successfully"),console.log("  Seat ID:",t.seatId),console.log("  Player index:",t.playerIndex),r.success("已加入游戏，玩家 #"+(t.playerIndex+1)),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(7),console.error("[UIGameList] Failed to join game:",e.t0),r.error("加入游戏失败");case 22:case"end":return e.stop()}}),e,this,[[7,18]])})));return function(){return e.apply(this,arguments)}}(),a.selectGameById=function(e){console.log("[UIGameList] selectGameById:",e);var t,s=this._games.findIndex((function(t){return t.id===e}));s>=0?(this._selectGame(s),null!=(t=this.m_list)&&t.scrollToView&&this.m_list.scrollToView(s)):console.warn("[UIGameList] Game not found in list:",e)},a._onItemClick=function(e){var t,s=e.sender,i=null!=(t=null==s?void 0:s.data)?t:-1;if(i>=0&&i<this._games.length){this._selectGame(i);var n=this._games[i];this._showGameDetail(n)}},a._showGameDetail=function(e){console.log("[UIGameList] Showing game detail:",e.id),l.instance.setCurrentGame(e),m.emit(d.Game.ShowGameDetail,{gameId:e.id})},a._onGamesListUpdated=function(){console.log("[UIGameList] GamesListUpdated event received"),this.refresh()},n}(o))||u);n._RF.pop()}}}));

System.register("chunks:///_virtual/UIHelper.ts",["cc","./CameraController.ts"],(function(e){var t,n,o,i,r,a,u;return{setters:[function(e){t=e.cclegacy,n=e.Vec3,o=e.UITransform,i=e.tween,r=e.view,a=e.Node},function(e){u=e.CameraController}],execute:function(){t._RF.push({},"7bcefLX9g9DvLACrs3scPSu","UIHelper",void 0);e("UIHelper",function(){function e(){}return e.worldToUIPosition=function(e,t){var i=t.cameraComponent||u.getMainCamera();if(!i)return console.warn("[UIHelper] Camera not found"),n.ZERO;var r=i.worldToScreen(e),a=t.node.getComponent(o);return a?a.convertToNodeSpaceAR(new n(r.x,r.y,0)):n.ZERO},e.uiToWorldPosition=function(e,t,i){void 0===i&&(i=0);var r=t.cameraComponent||u.getMainCamera();if(!r)return console.warn("[UIHelper] Camera not found"),n.ZERO;var a=t.node.getComponent(o);if(!a)return n.ZERO;var c=a.convertToWorldSpaceAR(e);return r.screenToWorld(new n(c.x,c.y,i))},e.getNodeBounds=function(e){var t=e.getComponent(o);if(!t)return{min:n.ZERO,max:n.ZERO,center:n.ZERO,size:n.ZERO};var i=t.contentSize,r=e.getWorldPosition(),a=i.width/2,u=i.height/2;return{min:new n(r.x-a,r.y-u,r.z),max:new n(r.x+a,r.y+u,r.z),center:r.clone(),size:new n(i.width,i.height,0)}},e.isNodesOverlap=function(e,t){var n=this.getNodeBounds(e),o=this.getNodeBounds(t);return!(n.max.x<o.min.x||n.min.x>o.max.x||n.max.y<o.min.y||n.min.y>o.max.y)},e.getDistanceBetweenNodes=function(e,t){var o=e.getWorldPosition(),i=t.getWorldPosition();return n.distance(o,i)},e.fitNodeToSize=function(e,t,n){void 0===n&&(n=!0);var i=e.getComponent(o);if(i){var r=i.contentSize;if(n){var a=t.width/r.width,u=t.height/r.height,c=Math.min(a,u);e.setScale(c,c,1)}else{var s=t.width/r.width,l=t.height/r.height;e.setScale(s,l,1)}}},e.moveNodeTo=function(e,t,n,o){return void 0===n&&(n=.5),void 0===o&&(o="quartOut"),new Promise((function(r){i(e).to(n,{position:t},{easing:o}).call((function(){return r()})).start()}))},e.scaleNodeTo=function(e,t,n,o){return void 0===n&&(n=.3),void 0===o&&(o="backOut"),new Promise((function(r){i(e).to(n,{scale:t},{easing:o}).call((function(){return r()})).start()}))},e.bounceNode=function(e,t,n){return void 0===t&&(t=.1),void 0===n&&(n=.6),new Promise((function(o){var r=e.scale.clone(),a=r.clone().multiplyScalar(1+t);i(e).to(.3*n,{scale:a},{easing:"quartOut"}).to(.7*n,{scale:r},{easing:"elasticOut"}).call((function(){return o()})).start()}))},e.shakeNode=function(e,t,o){return void 0===t&&(t=10),void 0===o&&(o=.5),new Promise((function(i){var r=e.position.clone(),a=0,u=Math.floor(60*o),c=setInterval((function(){if(a>=u)return clearInterval(c),e.setPosition(r),void i();var o=(Math.random()-.5)*t*2,s=(Math.random()-.5)*t*2,l=r.clone().add(new n(o,s,0));e.setPosition(l),a++}),1e3/60)}))},e.fadeIn=function(e,t){return void 0===t&&(t=.3),new Promise((function(n){e.active=!0,i(e).set({opacity:0}).to(t,{opacity:255},{easing:"quartOut"}).call((function(){return n()})).start()}))},e.fadeOut=function(e,t,n){return void 0===t&&(t=.3),void 0===n&&(n=!0),new Promise((function(o){i(e).to(t,{opacity:0},{easing:"quartIn"}).call((function(){n&&(e.active=!1),o()})).start()}))},e.getScreenSize=function(){var e=r.getVisibleSize();return{width:e.width,height:e.height}},e.getDesignResolution=function(){var e=r.getDesignResolutionSize();return{width:e.width,height:e.height}},e.getScreenScale=function(){var e=this.getScreenSize(),t=this.getDesignResolution();return{x:e.width/t.width,y:e.height/t.height}},e.isPointInNode=function(e,t){var n=t.getComponent(o);if(!n)return!1;var i=n.convertToNodeSpaceAR(e),r=n.contentSize,a=n.anchorPoint,u=-r.width*a.x,c=r.width*(1-a.x),s=-r.height*a.y,l=r.height*(1-a.y);return i.x>=u&&i.x<=c&&i.y>=s&&i.y<=l},e.clampNodeInBounds=function(e,t){var n=e.position,i=e.getComponent(o);if(i){var r=i.contentSize,a=e.scale,u=r.width*a.x/2,c=r.height*a.y/2,s=Math.max(t.min.x+u,Math.min(t.max.x-u,n.x)),l=Math.max(t.min.y+c,Math.min(t.max.y-c,n.y));e.setPosition(s,l,n.z)}},e.createMask=function(e,t){var n=new a("UIMask");n.layer=e.layer;var i=n.addComponent(o),r=e.getComponent(o);if(r)i.setContentSize(r.contentSize);else{var u=this.getScreenSize();i.setContentSize(u.width,u.height)}return e.insertChild(n,0),n},e.animateNumber=function(e,t,n,o,i){return new Promise((function(r){var a=e,u=t-e,c=Date.now();!function s(){var l=Date.now()-c,d=Math.min(l/(1e3*n),1),h=1-Math.pow(1-d,3);a=e+u*h;i?i(a):Math.floor(a).toString();o(Math.floor(a)),d<1?requestAnimationFrame(s):(o(t),r())}()}))},e.formatNumber=function(e,t){return void 0===t&&(t=0),e>=1e9?(e/1e9).toFixed(t)+"B":e>=1e6?(e/1e6).toFixed(t)+"M":e>=1e3?(e/1e3).toFixed(t)+"K":e.toFixed(t)},e.debounce=function(e,t){var n=null;return function(){for(var o=arguments.length,i=new Array(o),r=0;r<o;r++)i[r]=arguments[r];null!==n&&clearTimeout(n),n=window.setTimeout((function(){e.apply(null,i),n=null}),t)}},e.throttle=function(e,t){var n=0;return function(){var o=Date.now();if(o-n>=t){n=o;for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];e.apply(null,r)}}},e}());t._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGame.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./UIMapElement.ts","./UIEditor.ts","./UIInGameDebug.ts","./UIInGameCards.ts","./UIInGameDice.ts","./UIInGamePlayer.ts","./UIInGameInfo.ts","./UIInGameBuildingSelect.ts","./UIInGamePlaySetting.ts","./MapManager.ts","./constants.ts","./DecisionDialogHelper.ts"],(function(e,n){var t,i,o,s,a,l,r,m,c,I,u,h,d,g,_,U,p,f,G,v,S;return{setters:[function(e){t=e.inheritsLoose,i=e.asyncToGenerator,o=e.regeneratorRuntime},function(e){s=e.cclegacy,a=e._decorator},function(e){l=e.UIBase},function(e){r=e.EventBus},function(e){m=e.EventTypes},function(e){c=e.Blackboard},function(e){I=e.UIMapElement},function(e){u=e.UIEditor},function(e){h=e.UIInGameDebug},function(e){d=e.UIInGameCards},function(e){g=e.UIInGameDice},function(e){_=e.UIInGamePlayer},function(e){U=e.UIInGameInfo},function(e){p=e.UIInGameBuildingSelect},function(e){f=e.UIInGamePlaySetting},function(e){G=e.MapManager},function(e){v=e.DecisionType},function(e){S=e.DecisionDialogHelper}],execute:function(){var C;s._RF.push({},"dc175aqehlJto+JAgwO5Adz","UIInGame",void 0);var y=a.ccclass;e("UIInGame",y("UIInGame")(C=function(e){function s(){for(var n,t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];return(n=e.call.apply(e,[this].concat(i))||this).m_mapElementUI=void 0,n.m_editorUI=void 0,n.m_debugUI=null,n.m_cardsUI=null,n.m_diceUI=null,n.m_playerPanelUI=null,n.m_infoUI=null,n.m_buildingSelectUI=null,n.m_playSettingUI=null,n.m_modeController=void 0,n._pauseBtn=null,n._settingsBtn=null,n._bagBtn=null,n._gameTimerID=null,n._isInitialized=!1,n}t(s,e);var a=s.prototype;return a.onInit=function(){this._setupComponents(),this._setupDefaultValues()},a._setupComponents=function(){var e,n,t,i,o,s,a=this.getChild("editor").asCom;this.m_editorUI=a.node.addComponent(u),this.m_editorUI.setUIName("Editor"),this.m_editorUI.setPanel(a),this.m_editorUI.init(),this.m_modeController=this.getController("mode");var l=this.getChild("mapElement").asCom;this.m_mapElementUI=l.node.addComponent(I),this.m_mapElementUI.setUIName("MapElement"),this.m_mapElementUI.setPanel(l),this.m_mapElementUI.init(),this.m_editorUI.setMapElementUI(this.m_mapElementUI),this.m_mapElementUI.hide();var r=null==(e=this.getChild("debug"))?void 0:e.asCom;r?(this.m_debugUI=r.node.addComponent(h),this.m_debugUI.setUIName("InGameDebug"),this.m_debugUI.setPanel(r),this.m_debugUI.init(),console.log("[UIInGame] Debug UI component created")):console.warn("[UIInGame] Debug component not found in FairyGUI");var m=null==(n=this.getChild("cards"))?void 0:n.asCom;m&&(this.m_cardsUI=m.node.addComponent(d),this.m_cardsUI.setUIName("InGameCards"),this.m_cardsUI.setPanel(m),this.m_cardsUI.init(),console.log("[UIInGame] Cards UI component created"));var c=null==(t=this.getChild("dice"))?void 0:t.asCom;c&&(this.m_diceUI=c.node.addComponent(g),this.m_diceUI.setUIName("InGameDice"),this.m_diceUI.setPanel(c),this.m_diceUI.init(),console.log("[UIInGame] Dice UI component created")),this.m_playerPanelUI=this.panel.node.addComponent(_),this.m_playerPanelUI.setUIName("InGamePlayer"),this.m_playerPanelUI.setPanel(this.panel),this.m_playerPanelUI.init(),console.log("[UIInGame] Player UI component created");var G=null==(i=this.getChild("gameInfo"))?void 0:i.asCom;G&&(this.m_infoUI=G.node.addComponent(U),this.m_infoUI.setUIName("InGameInfo"),this.m_infoUI.setPanel(G),this.m_infoUI.init(),console.log("[UIInGame] Info UI component created"));var v=null==(o=this.getChild("buildingSelect"))?void 0:o.asCom;v&&(this.m_buildingSelectUI=v.node.addComponent(p),this.m_buildingSelectUI.setUIName("InGameBuildingSelect"),this.m_buildingSelectUI.setPanel(v),this.m_buildingSelectUI.init(),console.log("[UIInGame] BuildingSelect UI component created"));var S=null==(s=this.getChild("playSetting"))?void 0:s.asCom;S&&(this.m_playSettingUI=S.node.addComponent(f),this.m_playSettingUI.setUIName("InGamePlaySetting"),this.m_playSettingUI.setPanel(S),this.m_playSettingUI.init(),console.log("[UIInGame] PlaySetting UI component created")),this._pauseBtn=this.getButton("btnPause"),this._settingsBtn=this.getButton("btnSettings"),this._bagBtn=this.getButton("btnBag"),this.updateModeController()},a.updateModeController=function(){var e;if(this.m_modeController){var n=null==(e=G.getInstance())?void 0:e.getCurrentGameMap(),t=(null==n?void 0:n.isEditMode)||!1;this.m_modeController.selectedIndex=t?1:0}},a._setupDefaultValues=function(){},a.bindEvents=function(){this._pauseBtn&&this._pauseBtn.onClick(this._onPauseClick,this),this._settingsBtn&&this._settingsBtn.onClick(this._onSettingsClick,this),this._bagBtn&&this._bagBtn.onClick(this._onBagClick,this),r.on(m.Game.GamePause,this._onGamePause,this),r.on(m.Game.GameResume,this._onGameResume,this),r.on(m.Map.EditModeChanged,this._onEditModeChanged,this),r.on(m.UI.ScreenSizeChanged,this._onScreenSizeChanged,this),r.on(m.UI.ShowMapSelect,this._onShowMapSelect,this),r.on(m.Game.DecisionPending,this._onDecisionPending,this)},a.unbindEvents=function(){this._pauseBtn&&this._pauseBtn.offClick(this._onPauseClick,this),this._settingsBtn&&this._settingsBtn.offClick(this._onSettingsClick,this),this._bagBtn&&this._bagBtn.offClick(this._onBagClick,this),r.off(m.Game.GamePause,this._onGamePause,this),r.off(m.Game.GameResume,this._onGameResume,this),r.off(m.Map.EditModeChanged,this._onEditModeChanged,this),r.off(m.UI.ScreenSizeChanged,this._onScreenSizeChanged,this),r.off(m.UI.ShowMapSelect,this._onShowMapSelect,this),r.off(m.Game.DecisionPending,this._onDecisionPending,this),e.prototype.unbindEvents.call(this)},a.onShow=function(){var e=i(o().mark((function e(t){var i,s,a;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[UIInGame] Showing in-game UI"),this._startGameTimer(),this.refreshAllSubModules(),this._playShowAnimation(),this._isInitialized=!0,e.next=7,n.import("./UIManager.ts");case 7:s=e.sent,a=s.UIManager,null==(i=a.instance)||i.showInGameButtons(),this._showDecisionDialogIfNeeded().catch((function(e){console.error("[UIInGame] Failed to show decision dialog:",e)})),console.log("[UIInGame] 界面初始化完成，已检查待决策状态");case 12:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}(),a.onHide=function(){var e=i(o().mark((function e(){var t,i,s;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[UIInGame] Hiding in-game UI"),this._stopGameTimer(),e.next=4,n.import("./UIManager.ts");case 4:i=e.sent,s=i.UIManager,null==(t=s.instance)||t.hideInGameButtons();case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.onRefresh=function(e){this.updateModeController(),this.refreshAllSubModules()},a.refreshAllSubModules=function(){var e,n,t;null==(e=this.m_cardsUI)||e.refresh(),null==(n=this.m_playerPanelUI)||n.refresh(),null==(t=this.m_infoUI)||t.refresh()},a._onPauseClick=function(){console.log("[UIInGame] Pause clicked"),r.emit(m.Game.GamePause,{source:"in_game_ui"}),r.emit(m.UI.ShowPauseMenu)},a._onSettingsClick=function(){console.log("[UIInGame] Settings clicked"),r.emit(m.UI.ShowSettings,{source:"in_game_ui"})},a._onBagClick=function(){console.log("[UIInGame] Bag clicked"),r.emit(m.UI.OpenBag,{source:"in_game_ui"})},a._onShowMapSelect=function(e){console.log("[UIInGame] ShowMapSelect event received, hiding"),console.log("  Data:",e),this.hide()},a._onEditModeChanged=function(e){console.log("[UIInGame] EditModeChanged event received"),console.log("  isEditMode:",e.isEditMode),this.m_modeController&&(this.m_modeController.selectedIndex=e.isEditMode?1:0,console.log("[UIInGame] Mode controller set to:",this.m_modeController.selectedIndex))},a._onGamePause=function(){console.log("[UIInGame] Game paused"),this._pauseBtn&&(this._pauseBtn.text="继续"),this._stopGameTimer()},a._onGameResume=function(){console.log("[UIInGame] Game resumed"),this._pauseBtn&&(this._pauseBtn.text="暂停"),this._startGameTimer()},a._onScreenSizeChanged=function(e){this._panel.setSize(e.width,e.height)},a._startGameTimer=function(){this._gameTimerID&&this._stopGameTimer(),this._gameTimerID=window.setInterval((function(){var e=c.instance.get("gameTime",0);c.instance.set("gameTime",e+1)}),1e3)},a._stopGameTimer=function(){this._gameTimerID&&(clearInterval(this._gameTimerID),this._gameTimerID=null)},a._playShowAnimation=function(){var e=this.getTransition("showAnim");e&&e.play(),console.log("[UIInGame] Playing show animation")},a._onDecisionPending=function(e){console.log("[UIInGame] 收到待决策事件",e);var n=e.decision,t=e.session;if(n&&t){if(this._isInitialized){var i=t.getMyPlayer();i?(console.log("[UIInGame] 直接显示决策窗口（从事件数据）",n),this._showDecisionDialog(n,i,t)):console.warn("[UIInGame] My player not found in event session")}}else console.warn("[UIInGame] DecisionPending 事件缺少数据")},a._showDecisionDialogIfNeeded=function(){var e=i(o().mark((function e(){var t,i,s,a,l,r;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.import("./GameInitializer.ts");case 2:if(i=e.sent,s=i.GameInitializer,a=null==(t=s.getInstance())?void 0:t.getGameSession()){e.next=8;break}return console.log("[UIInGame] GameSession 未找到"),e.abrupt("return");case 8:if(l=a.getPendingDecision()){e.next=12;break}return console.log("[UIInGame] 没有待决策"),e.abrupt("return");case 12:if(a.isMyTurn()){e.next=15;break}return console.log("[UIInGame] 不是我的回合，不显示决策窗口",{myPlayerIndex:a.getMyPlayerIndex(),activePlayerIndex:a.getActivePlayerIndex()}),e.abrupt("return");case 15:if(r=a.getMyPlayer()){e.next=19;break}return console.warn("[UIInGame] 我的玩家未找到"),e.abrupt("return");case 19:console.log("[UIInGame] 显示决策窗口",l),this._showDecisionDialog(l,r,a);case 21:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a._showDecisionDialog=function(e,n,t){switch(e.type){case v.BUY_PROPERTY:S.showBuyDialog(e,t);break;case v.UPGRADE_PROPERTY:S.showUpgradeDialog(e,t);break;case v.PAY_RENT:S.showRentDialog(e,t);break;default:console.warn("[UIInGame] 未知的决策类型",e.type)}},a.togglePlaySetting=function(){if(!this.m_playSettingUI||!this.m_playSettingUI.panel)return console.warn("[UIInGame] PlaySetting UI not initialized"),!1;var e=!this.m_playSettingUI.panel.visible;return this.m_playSettingUI.panel.visible=e,console.log("[UIInGame] PlaySetting toggled:",e),e||r.emit(m.UI.PlaySettingClosed),e},a.toggleDebug=function(){if(!this.m_debugUI||!this.m_debugUI.panel)return console.warn("[UIInGame] Debug UI not initialized"),!1;var e=!this.m_debugUI.panel.visible;return this.m_debugUI.panel.visible=e,console.log("[UIInGame] Debug toggled:",e),e},a.isPlaySettingVisible=function(){var e;return(null==(e=this.m_playSettingUI)||null==(e=e.panel)?void 0:e.visible)||!1},a.isDebugVisible=function(){var e;return(null==(e=this.m_debugUI)||null==(e=e.panel)?void 0:e.visible)||!1},a.onDestroy=function(){this._stopGameTimer(),e.prototype.onDestroy.call(this)},s}(l))||C);s._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGameBuildingSelect.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./GameInitializer.ts","./SuiManager.ts","./UINotification.ts","./constants.ts"],(function(e){var n,i,t,s,l,o,a,d,u,c,r,g,p,m;return{setters:[function(e){n=e.inheritsLoose,i=e.asyncToGenerator,t=e.regeneratorRuntime},function(e){s=e.cclegacy,l=e._decorator},function(e){o=e.UIBase},function(e){a=e.EventBus},function(e){d=e.EventTypes},function(e){u=e.GameInitializer},function(e){c=e.SuiManager},function(e){r=e.UINotification},function(e){g=e.BuildingType,p=e.DecisionType,m=e.BuildingSize}],execute:function(){var h;s._RF.push({},"c22e5J7PqdDdpo/6PbCFo9/","UIInGameBuildingSelect",void 0);var b=l.ccclass;e("UIInGameBuildingSelect",b("UIInGameBuildingSelect")(h=function(e){function s(){for(var n,i=arguments.length,t=new Array(i),s=0;s<i;s++)t[s]=arguments[s];return(n=e.call.apply(e,[this].concat(t))||this).m_buildingList=void 0,n.m_btnUpgrade=void 0,n.m_btnSkip=void 0,n.m_selectedBuildingType=g.TEMPLE,n.m_buildingTypes=[{type:g.TEMPLE,name:"土地庙",enabled:!0,status:""},{type:g.RESEARCH,name:"研究所",enabled:!1,status:"当前版本暂未支持"},{type:g.OIL,name:"石油公司",enabled:!1,status:"当前版本暂未支持"},{type:g.COMMERCIAL,name:"商业中心",enabled:!1,status:"当前版本暂未支持"},{type:g.HOTEL,name:"大饭店",enabled:!1,status:"当前版本暂未支持"}],n}n(s,e);var l=s.prototype;return l.onInit=function(){this._setupComponents(),this._setupButtons(),this.hide()},l._setupComponents=function(){this.m_buildingList=this.getList("list"),this.m_buildingList?(this.m_buildingList.itemRenderer=this.renderBuildingItem.bind(this),console.log("[UIInGameBuildingSelect] Building list setup")):console.error("[UIInGameBuildingSelect] Building list not found"),this.m_btnUpgrade=this.getButton("btn_upgrade"),this.m_btnSkip=this.getButton("btn_skip"),this.m_btnUpgrade&&this.m_btnSkip||console.error("[UIInGameBuildingSelect] Buttons not found")},l._setupButtons=function(){this.m_btnUpgrade&&this.m_btnUpgrade.onClick(this.onUpgradeClicked,this),this.m_btnSkip&&this.m_btnSkip.onClick(this.onSkipClicked,this)},l.bindEvents=function(){a.on(d.Move.BuildingDecision,this._onBuildingDecision,this)},l.unbindEvents=function(){a.off(d.Move.BuildingDecision,this._onBuildingDecision,this),e.prototype.unbindEvents.call(this)},l.onShow=function(e){console.log("[UIInGameBuildingSelect] Showing building select"),this.refresh()},l.onRefresh=function(e){this.refresh()},l.refresh=function(){this.m_buildingList?(this.m_buildingList.numItems=this.m_buildingTypes.length,this.m_buildingList.selectedIndex=0,this.m_selectedBuildingType=g.TEMPLE,console.log("[UIInGameBuildingSelect] Refreshed with "+this.m_buildingTypes.length+" building types")):console.warn("[UIInGameBuildingSelect] Building list not initialized")},l.renderBuildingItem=function(e,n){var i=this,t=n.asButton;if(t){var s=this.m_buildingTypes[e];if(s){var l=t.getChild("title");l&&(l.text=s.name);var o=t.getChild("status");o&&(o.text=s.status,o.visible=""!==s.status),t.enabled=s.enabled,t.onClick((function(){s.enabled&&(i.m_selectedBuildingType=s.type,console.log("[UIInGameBuildingSelect] Selected building type: "+s.name+" ("+s.type+")"))}))}else console.warn("[UIInGameBuildingSelect] Building info not found at index "+e)}else console.warn("[UIInGameBuildingSelect] Item is not a button")},l._onBuildingDecision=function(e){var n;console.log("[UIInGameBuildingSelect] BuildingDecision event received",e);var i=null==(n=u.getInstance())?void 0:n.getGameSession();if(i){var t=e,s=i.getBuildingByIndex(t.building_id);if(s){var l=t.decision_type===p.UPGRADE_PROPERTY&&s.getSize()===m.SIZE_2X2&&0===s.getLevel();console.log("[UIInGameBuildingSelect] Check conditions:",{decisionType:t.decision_type,buildingSize:s.getSize(),buildingLevel:s.getLevel(),needsTypeSelection:l}),l?(console.log("[UIInGameBuildingSelect] Showing building type selection"),this.show()):console.log("[UIInGameBuildingSelect] Using MessageBox for decision")}else console.warn("[UIInGameBuildingSelect] Building not found:",t.building_id)}else console.warn("[UIInGameBuildingSelect] GameSession not found")},l.onUpgradeClicked=function(){var e=i(t().mark((function e(){var n,i,s,l,o,a,d,g;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIInGameBuildingSelect] Upgrade button clicked"),i=null==(n=u.getInstance())?void 0:n.getGameSession()){e.next=5;break}return r.error("游戏会话未找到"),e.abrupt("return");case 5:if(this.m_btnUpgrade&&(this.m_btnUpgrade.enabled=!1),this.m_btnSkip&&(this.m_btnSkip.enabled=!1),e.prev=7,r.info("正在升级为"+this._getBuildingTypeName(this.m_selectedBuildingType)+"..."),l=i.getGameId(),o=null==(s=i.getMySeat())?void 0:s.id,a=i.getTemplateMapId(),o){e.next=14;break}throw new Error("座位信息未找到");case 14:return d=c.instance.gameClient.game.buildUpgradeBuildingTx(l,o,a,this.m_selectedBuildingType),e.next=17,c.instance.signAndExecuteTransaction(d);case 17:g=e.sent,console.log("[UIInGameBuildingSelect] Upgrade transaction success",g.digest),r.success("升级成功！"),this.hide(),e.next=29;break;case 23:e.prev=23,e.t0=e.catch(7),console.error("[UIInGameBuildingSelect] Upgrade failed:",e.t0),r.error("升级失败: "+(e.t0.message||e.t0)),this.m_btnUpgrade&&(this.m_btnUpgrade.enabled=!0),this.m_btnSkip&&(this.m_btnSkip.enabled=!0);case 29:case"end":return e.stop()}}),e,this,[[7,23]])})));return function(){return e.apply(this,arguments)}}(),l.onSkipClicked=function(){var e=i(t().mark((function e(){var n,i,s,l,o,a,d,g;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIInGameBuildingSelect] Skip button clicked"),i=null==(n=u.getInstance())?void 0:n.getGameSession()){e.next=5;break}return r.error("游戏会话未找到"),e.abrupt("return");case 5:if(this.m_btnUpgrade&&(this.m_btnUpgrade.enabled=!1),this.m_btnSkip&&(this.m_btnSkip.enabled=!1),e.prev=7,r.info("正在跳过升级..."),l=i.getGameId(),o=null==(s=i.getMySeat())?void 0:s.id,a=i.getTemplateMapId(),o){e.next=14;break}throw new Error("座位信息未找到");case 14:return d=c.instance.gameClient.game.buildSkipBuildingDecisionTx(l,o,a),e.next=17,c.instance.signAndExecuteTransaction(d);case 17:g=e.sent,console.log("[UIInGameBuildingSelect] Skip transaction success",g.digest),r.success("已跳过升级"),this.hide(),e.next=29;break;case 23:e.prev=23,e.t0=e.catch(7),console.error("[UIInGameBuildingSelect] Skip failed:",e.t0),r.error("跳过失败: "+(e.t0.message||e.t0)),this.m_btnUpgrade&&(this.m_btnUpgrade.enabled=!0),this.m_btnSkip&&(this.m_btnSkip.enabled=!0);case 29:case"end":return e.stop()}}),e,this,[[7,23]])})));return function(){return e.apply(this,arguments)}}(),l._getBuildingTypeName=function(e){var n=this.m_buildingTypes.find((function(n){return n.type===e}));return(null==n?void 0:n.name)||"未知建筑"},l.hide=function(){e.prototype.hide.call(this),this.m_btnUpgrade&&(this.m_btnUpgrade.enabled=!0),this.m_btnSkip&&(this.m_btnSkip.enabled=!0),this.m_selectedBuildingType=g.TEMPLE,this.m_buildingList&&(this.m_buildingList.selectedIndex=0)},s}(o))||h);s._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGameCards.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./GameInitializer.ts","./cards.ts"],(function(e){var n,t,r,a,s,i,o,d,h,c,l,C,u;return{setters:[function(e){n=e.inheritsLoose},function(e){t=e.cclegacy,r=e._decorator,a=e.resources,s=e.Texture2D,i=e.SpriteFrame,o=e.Size,d=e.Rect},function(e){h=e.UIBase},function(e){c=e.EventBus},function(e){l=e.EventTypes},function(e){C=e.GameInitializer},function(e){u=e.getCardName}],execute:function(){var f;t._RF.push({},"babcfAAJOpJhrad4EC4babk","UIInGameCards",void 0);var g=r.ccclass;e("UIInGameCards",g("UIInGameCards")(f=function(e){function t(){for(var n,t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];return(n=e.call.apply(e,[this].concat(r))||this).m_cardList=void 0,n}n(t,e);var r=t.prototype;return r.onInit=function(){this._setupComponents()},r._setupComponents=function(){this.m_cardList=this.getList("cards"),this.m_cardList?(this.m_cardList.itemRenderer=this.renderCardItem.bind(this),console.log("[UIInGameCards] Card list setup")):console.error("[UIInGameCards] Card list not found")},r.bindEvents=function(){c.on(l.Player.CardChange,this._onCardChange,this),c.on(l.Player.CardRemoved,this._onCardChange,this),c.on(l.Card.GetNewCard,this._onCardChange,this),c.on(l.Card.UseCard,this._onCardChange,this)},r.unbindEvents=function(){c.off(l.Player.CardChange,this._onCardChange,this),c.off(l.Player.CardRemoved,this._onCardChange,this),c.off(l.Card.GetNewCard,this._onCardChange,this),c.off(l.Card.UseCard,this._onCardChange,this),e.prototype.unbindEvents.call(this)},r.onShow=function(e){console.log("[UIInGameCards] Showing cards"),this.refresh()},r.onRefresh=function(e){this.refresh()},r.refresh=function(){var e,n=null==(e=C.getInstance())?void 0:e.getGameSession();if(!n)return console.warn("[UIInGameCards] GameSession not found"),void(this.m_cardList.numItems=0);var t=n.getMyPlayer();if(!t)return console.warn("[UIInGameCards] My player not found"),void(this.m_cardList.numItems=0);var r=t.getAllCards();this.m_cardList.numItems=r.length,console.log("[UIInGameCards] Refreshed with "+r.length+" cards")},r.renderCardItem=function(e,n){var t,r=n.asCom,h=null==(t=C.getInstance())?void 0:t.getGameSession(),c=null==h?void 0:h.getMyPlayer(),l=null==h?void 0:h.getGameData();if(c&&l){var f=c.getAllCards()[e];if(f)if(l.cardRegistry.getCard(f.kind)){var g=r.getChild("icon");if(g){var m="web3/cards/"+f.kind+"/texture";a.load(m,s,(function(e,n){if(!e&&n){var t=new i;t.texture=n,t.originalSize=new o(n.width,n.height),t.rect=new d(0,0,n.width,n.height),g.texture=t}else console.warn("[UIInGameCards] Failed to load card texture: "+m)}))}var I=r.getChild("title");I&&(I.text=u(f.kind));var v=r.getChild("count");v&&(v.text="x"+f.count)}else console.warn("[UIInGameCards] Card definition not found for kind: "+f.kind)}},r._onCardChange=function(e){console.log("[UIInGameCards] Card changed, refreshing"),this.refresh()},t}(h))||f);t._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGameDebug.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./MapManager.ts","./EventBus.ts","./EventTypes.ts","./GameInitializer.ts"],(function(e){var n,t,s,i,o,h,r,a,u,l;return{setters:[function(e){n=e.inheritsLoose,t=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){i=e.cclegacy,o=e._decorator},function(e){h=e.UIBase},function(e){r=e.MapManager},function(e){a=e.EventBus},function(e){u=e.EventTypes},function(e){l=e.GameInitializer}],execute:function(){var _;i._RF.push({},"216abVFJw1Nu7iwVq7mG9JR","UIInGameDebug",void 0);var d=o.ccclass;e("UIInGameDebug",d("UIInGameDebug")(_=function(e){function i(){for(var n,t=arguments.length,s=new Array(t),i=0;i<t;i++)s[i]=arguments[i];return(n=e.call.apply(e,[this].concat(s))||this).m_btn_showIds=void 0,n.m_btn_showTileType=void 0,n.m_label_roundTurn=void 0,n._isShowingIds=!1,n._isShowingTileTypes=!1,n}n(i,e);var o=i.prototype;return o.onInit=function(){this._setupComponents()},o._setupComponents=function(){this.m_btn_showIds=this.getButton("btn_showIds"),this.m_btn_showTileType=this.getButton("btn_showTileType"),this.m_label_roundTurn=this.getText("roundTurn"),console.log("[UIInGameDebug] Components setup",{btn_showIds:!!this.m_btn_showIds,btn_showTileType:!!this.m_btn_showTileType,label_roundTurn:!!this.m_label_roundTurn})},o.bindEvents=function(){this.m_btn_showIds&&this.m_btn_showIds.onClick(this._onShowIdsClick,this),this.m_btn_showTileType&&this.m_btn_showTileType.onClick(this._onShowTileTypeClick,this),a.on(u.Game.TurnChanged,this._onTurnChanged,this),a.on(u.Game.RoundChanged,this._onRoundChanged,this)},o.unbindEvents=function(){this.m_btn_showIds&&this.m_btn_showIds.offClick(this._onShowIdsClick,this),this.m_btn_showTileType&&this.m_btn_showTileType.offClick(this._onShowTileTypeClick,this),a.off(u.Game.TurnChanged,this._onTurnChanged,this),a.off(u.Game.RoundChanged,this._onRoundChanged,this),e.prototype.unbindEvents.call(this)},o.onShow=function(e){var n;console.log("[UIInGameDebug] Showing debug UI"),this._isShowingIds=!1,this.m_btn_showIds&&(this.m_btn_showIds.title="显示ID"),this._isShowingTileTypes=!0,this.m_btn_showTileType&&(this.m_btn_showTileType.title="隐藏类型");var t=null==(n=r.getInstance())?void 0:n.getCurrentGameMap();t&&t.hideIdsWithOverlay(),this._refreshRoundTurnDisplay()},o.onHide=function(){var e;console.log("[UIInGameDebug] Hiding debug UI");var n=null==(e=r.getInstance())?void 0:e.getCurrentGameMap();n&&(n.hideIdsWithOverlay(),n.clearTileTypeOverlays()),this._isShowingIds=!1,this.m_btn_showIds&&(this.m_btn_showIds.title="显示ID"),this._isShowingTileTypes=!1,this.m_btn_showTileType&&(this.m_btn_showTileType.title="显示类型")},o._onShowIdsClick=function(){var e=t(s().mark((function e(){var n,t;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIInGameDebug] Button clicked"),t=null==(n=r.getInstance())?void 0:n.getCurrentGameMap()){e.next=5;break}return console.error("[UIInGameDebug] No GameMap found!"),e.abrupt("return");case 5:if(this._isShowingIds=!this._isShowingIds,!this._isShowingIds){e.next=12;break}return e.next=9,t.showIdsWithOverlay();case 9:this.m_btn_showIds&&(this.m_btn_showIds.title="隐藏ID"),e.next=14;break;case 12:t.hideIdsWithOverlay(),this.m_btn_showIds&&(this.m_btn_showIds.title="显示ID");case 14:console.log("[UIInGameDebug] IDs "+(this._isShowingIds?"shown":"hidden"));case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),o._onShowTileTypeClick=function(){var e=t(s().mark((function e(){var n,t;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIInGameDebug] Tile type button clicked"),t=null==(n=r.getInstance())?void 0:n.getCurrentGameMap()){e.next=5;break}return console.error("[UIInGameDebug] No GameMap found!"),e.abrupt("return");case 5:if(this._isShowingTileTypes=!this._isShowingTileTypes,!this._isShowingTileTypes){e.next=12;break}return e.next=9,t.showTileTypeOverlays();case 9:this.m_btn_showTileType&&(this.m_btn_showTileType.title="隐藏类型"),e.next=14;break;case 12:t.clearTileTypeOverlays(),this.m_btn_showTileType&&(this.m_btn_showTileType.title="显示类型");case 14:console.log("[UIInGameDebug] Tile types "+(this._isShowingTileTypes?"shown":"hidden"));case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),o._onTurnChanged=function(){this._refreshRoundTurnDisplay()},o._onRoundChanged=function(){this._refreshRoundTurnDisplay()},o._refreshRoundTurnDisplay=function(){var e;if(this.m_label_roundTurn){var n=null==(e=l.getInstance())?void 0:e.getGameSession();if(n){var t=n.getRound(),s=n.getTurn();this.m_label_roundTurn.text="round: "+t+"\nturn: "+s}else this.m_label_roundTurn.text="round: -\nturn: -"}},i}(h))||_);i._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGameDice.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./DiceController.ts","./SuiManager.ts","./constants.ts","./WalkingPreference.ts","./HistoryStorage.ts","./UINotification.ts","./GameInitializer.ts","./TransactionErrorHandler.ts"],(function(e,n){var t,o,i,r,s,a,l,c,u,_,h,m,p,I,g,f,d;return{setters:[function(e){t=e.inheritsLoose,o=e.asyncToGenerator,i=e.regeneratorRuntime},function(e){r=e.cclegacy,s=e._decorator},function(e){a=e.UIBase},function(e){l=e.EventBus},function(e){c=e.EventTypes},function(e){u=e.Blackboard},function(e){_=e.DiceController},function(e){h=e.SuiManager},function(e){m=e.BuffKind},function(e){p=e.WalkingPreference},function(e){I=e.HistoryStorage},function(e){g=e.UINotification},function(e){f=e.GameInitializer},function(e){d=e.handleSuiTransactionError}],execute:function(){var b;r._RF.push({},"4fc7bdi1BpOaK3AP+vTPUV0","UIInGameDice",void 0);var D=s.ccclass;e("UIInGameDice",D("UIInGameDice")(b=function(e){function r(){for(var n,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];return(n=e.call.apply(e,[this].concat(o))||this).m_btn_roll=void 0,n.m_btn_skipTurn=void 0,n}t(r,e);var s=r.prototype;return s.onInit=function(){this._setupComponents()},s._setupComponents=function(){this.m_btn_roll=this.getButton("btn_roll"),this.m_btn_skipTurn=this.getButton("btn_skipTurn"),this.m_btn_roll?console.log("[UIInGameDice] Dice button found"):console.error("[UIInGameDice] Dice button (n2) not found"),this.m_btn_skipTurn?(this.m_btn_skipTurn.visible=!1,console.log("[UIInGameDice] Skip turn button found")):console.error("[UIInGameDice] Skip turn button not found")},s.bindEvents=function(){this.m_btn_roll&&this.m_btn_roll.onClick(this._onRollDiceOnSui,this),this.m_btn_skipTurn&&this.m_btn_skipTurn.onClick(this._onSkipTurnClick,this),l.on(c.Dice.StartRoll,this._onDiceStart,this),l.on(c.Dice.RollComplete,this._onDiceComplete,this),l.on(c.Game.TurnChanged,this._onTurnChanged,this)},s.unbindEvents=function(){this.m_btn_roll&&this.m_btn_roll.offClick(this._onRollDiceOnSui,this),this.m_btn_skipTurn&&this.m_btn_skipTurn.offClick(this._onSkipTurnClick,this),l.off(c.Dice.StartRoll,this._onDiceStart,this),l.off(c.Dice.RollComplete,this._onDiceComplete,this),l.off(c.Game.TurnChanged,this._onTurnChanged,this),e.prototype.unbindEvents.call(this)},s.onShow=function(e){console.log("[UIInGameDice] Showing"),this._updateButtonState()},s.onRefresh=function(e){this._updateButtonState()},s._updateButtonState=function(){var e,n=null==(e=f.getInstance())?void 0:e.getGameSession();if(!n)return this.m_btn_roll.enabled=!1,this.m_btn_skipTurn&&(this.m_btn_skipTurn.visible=!1),void console.log("[UIInGameDice] No session, 骰子按钮禁用");var t=n.isMyTurn(),o=n.getMyPlayer(),i=o&&o.isInHospital();console.log("[UIInGameDice] _updateButtonState DEBUG:",{myPlayerIndex:n.getMyPlayerIndex(),activePlayerIndex:n.getActivePlayerIndex(),turn:n.getTurn(),round:n.getRound(),isMyTurn:t,hasMyPlayer:!!o,inHospital:(null==o?void 0:o.getInHospitalTurns())||0,shouldSkip:i,btnRollEnabled:t&&!i,btnSkipVisible:t&&i}),this.m_btn_skipTurn&&(this.m_btn_skipTurn.visible=t&&i,this.m_btn_skipTurn.enabled=t&&i,console.log("[UIInGameDice] SkipTurn 按钮:",t&&i?"显示并启用":"隐藏")),this.m_btn_roll.enabled=t&&!i,console.log("[UIInGameDice] Dice 按钮:",t&&!i?"启用":"禁用")},s._onRollDiceClick=function(){var e=this;console.log("[UIInGameDice] Roll dice clicked"),this.m_btn_roll&&(this.m_btn_roll.enabled=!1);var n=Math.floor(6*Math.random())+1;console.log("[UIInGameDice] 骰子点数: "+n),_.instance.roll(n,(function(){console.log("[UIInGameDice] 骰子动画完成，最终点数: "+n),e.m_btn_roll&&(e.m_btn_roll.enabled=!0),l.emit(c.Dice.RollComplete,{value:n,playerId:u.instance.get("currentPlayerId"),source:"in_game_ui"})})),l.emit(c.Dice.StartRoll,{playerId:u.instance.get("currentPlayerId"),source:"in_game_ui"})},s._onRollDiceOnSui=function(){var e=o(i().mark((function e(){var t,o,r,s,a,l,c,u,m,b,D,k,v,T,G,y,U,S,R,x;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIInGameDice] 掷骰子按钮点击（链上版本）"),this.m_btn_roll&&(this.m_btn_roll.enabled=!1),t=!1,e.prev=3,r=null==(o=f.getInstance())?void 0:o.getGameSession()){e.next=7;break}throw new Error("GameSession 未找到");case 7:if(s=r.getMyPlayer()){e.next=10;break}throw new Error("当前玩家未找到");case 10:if(a=r.getMapTemplate()){e.next=13;break}throw new Error("地图模板未找到");case 13:return console.log("[UIInGameDice] 游戏数据获取成功",{gameId:r.getGameId(),player:s.getPlayerIndex(),currentTile:s.getPos()}),l=this._getDiceCount(s,r.getRound()),c=6*l,console.log("[UIInGameDice] 骰子数量: "+l+", 最大步数: "+c),u=this._getWalkingPreference(),console.log("[UIInGameDice] 使用行走偏好: "+u),e.next=21,n.import("./PathCalculator.ts");case 21:if(m=e.sent,b=m.PathCalculator,D=void 0,u===p.ROTOR_ROUTER&&(D=I.load(r.getGameId(),s.getPlayerIndex()),console.log("[UIInGameDice] Rotor-Router 历史记录已加载",{recordCount:D.lastDirection.size})),k=new b(a,D),(v=k.calculatePath({startTile:s.getPos(),steps:c,preference:u,lastTile:s.getLastTileId(),rotorHistory:D})).success){e.next=29;break}throw new Error("路径计算失败: "+v.error);case 29:if(console.log("[UIInGameDice] 路径计算成功",{path:v.path,steps:v.actualSteps}),u===p.ROTOR_ROUTER&&(T=k.getRotorHistory(),I.save(r.getGameId(),s.getPlayerIndex(),T),console.log("[UIInGameDice] Rotor-Router 历史记录已保存")),k.validatePath(s.getPos(),v.path)){e.next=34;break}throw new Error("路径校验失败：包含无效的邻接关系");case 34:return console.log("[UIInGameDice] 路径校验通过"),e.next=37,this._playDiceAnimation(l);case 37:return console.log("[UIInGameDice] 提交链上交易..."),e.next=40,h.instance.rollAndStep(r,v.path);case 40:G=e.sent,console.log("[UIInGameDice] 交易成功",{txHash:G.txHash,dice:G.dice,endPos:G.endPos}),t=!0,y=G._gasInfo,U=h.instance.getExplorer(G.txHash,"txblock"),g.txNotification(!0,"掷骰成功",G.txHash,y,U),e.next=53;break;case 48:e.prev=48,e.t0=e.catch(3),console.error("[UIInGameDice] 掷骰子失败:",e.t0),_.instance.stopRolling(),d(e.t0,{title:"掷骰子失败",messagePrefix:""});case 53:return e.prev=53,!t&&this.m_btn_roll&&(R=null==(S=f.getInstance())?void 0:S.getGameSession(),x=(null==R?void 0:R.isMyTurn())||!1,this.m_btn_roll.enabled=x,console.log("[UIInGameDice] 交易失败，恢复按钮状态:",x?"启用":"禁用")),e.finish(53);case 56:case"end":return e.stop()}}),e,this,[[3,48,53,56]])})));return function(){return e.apply(this,arguments)}}(),s._getDiceCount=function(e,n){return e.hasActiveBuff(m.MOVE_CTRL,n)?2:1},s._getWalkingPreference=function(){return u.instance.get("walkingPreference",p.ROTOR_ROUTER)},s._onSkipTurnClick=function(){var e=o(i().mark((function e(){var n,t,o,r,s,a,l,c,u,_,m;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIInGameDice] Skip turn button clicked"),this.m_btn_skipTurn&&(this.m_btn_skipTurn.enabled=!1),n=!1,e.prev=3,o=null==(t=f.getInstance())?void 0:t.getGameSession()){e.next=7;break}throw new Error("GameSession 未找到");case 7:return e.next=9,h.instance.skipTurn(o);case 9:r=e.sent,console.log("[UIInGameDice] 跳过回合交易已发送"),n=!0,s=r._gasInfo,a=h.instance.getExplorer(r.txHash,"txblock"),g.txNotification(!0,"跳过回合成功",r.txHash,s,a),e.next=21;break;case 17:e.prev=17,e.t0=e.catch(3),console.error("[UIInGameDice] 跳过回合失败",e.t0),d(e.t0,{title:"跳过回合失败"});case 21:return e.prev=21,!n&&this.m_btn_skipTurn&&(c=null==(l=f.getInstance())?void 0:l.getGameSession())&&(u=c.getMyPlayer(),_=u&&u.isInHospital(),m=c.isMyTurn(),this.m_btn_skipTurn.enabled=m&&_,console.log("[UIInGameDice] 交易失败，恢复按钮状态:",m&&_?"启用":"禁用")),e.finish(21);case 24:case"end":return e.stop()}}),e,this,[[3,17,21,24]])})));return function(){return e.apply(this,arguments)}}(),s._playDiceAnimation=function(){var e=o(i().mark((function e(n){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("[UIInGameDice] 开始播放骰子循环动画，数量: "+n),_.instance.startRolling(n,(function(){console.log("[UIInGameDice] 骰子动画完成（已停在链上值）")})),l.emit(c.Dice.StartRoll,{diceCount:n,source:"ui_dice"});case 3:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),s._onDiceStart=function(){this.m_btn_roll&&(this.m_btn_roll.enabled=!1)},s._onDiceComplete=function(e){console.log("[UIInGameDice] Dice roll completed:",e)},s._onTurnChanged=function(e){this._updateButtonState()},r}(a))||b);r._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGameInfo.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./GameInitializer.ts","./IdFormatter.ts"],(function(e){var t,n,i,s,o,a,r,d;return{setters:[function(e){t=e.inheritsLoose},function(e){n=e.cclegacy,i=e._decorator},function(e){s=e.UIBase},function(e){o=e.EventBus},function(e){a=e.EventTypes},function(e){r=e.GameInitializer},function(e){d=e.IdFormatter}],execute:function(){var c;n._RF.push({},"b3262cI+RNEfIHznPvtnNPP","UIInGameInfo",void 0);var u=i.ccclass;e("UIInGameInfo",u("UIInGameInfo")(c=function(e){function n(){for(var t,n=arguments.length,i=new Array(n),s=0;s<n;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).m_gameId=void 0,t.m_daysElapsed=void 0,t.m_weekday=void 0,t.m_priceIndex=void 0,t}t(n,e);var i=n.prototype;return i.onInit=function(){this._setupComponents()},i._setupComponents=function(){this.m_gameId=this.getText("gameid"),this.m_daysElapsed=this.getText("daysElapsed"),this.m_weekday=this.getText("weekday"),this.m_priceIndex=this.getText("priceIndex")},i.bindEvents=function(){o.on(a.Game.TurnEnd,this._onTurnEnd,this)},i.unbindEvents=function(){o.off(a.Game.TurnEnd,this._onTurnEnd,this),e.prototype.unbindEvents.call(this)},i.onShow=function(e){this.refresh()},i.onRefresh=function(e){this.refresh()},i.refresh=function(){var e,t=null==(e=r.getInstance())?void 0:e.getGameSession();if(t){var n=t.getRound(),i=t.getPriceRiseDays(),s=t.getGameId();if(this.m_gameId){var o=d.shortenAddress(s);this.m_gameId.text=o}if(this.m_daysElapsed&&(this.m_daysElapsed.text=n+1+"天"),this.m_weekday){var a=n%7+1,c=this.getWeekdayName(a);this.m_weekday.text=c}if(this.m_priceIndex){var u=Math.floor((n+1)/i)+1;this.m_priceIndex.text="物价指数: "+u}}},i.getWeekdayName=function(e){return["","周一","周二","周三","周四","周五","周六","周日"][e]||""},i._onTurnEnd=function(){this.refresh()},n}(s))||c);n._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGamePlayer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./GameInitializer.ts"],(function(e){var t,a,n,r,i,s,l,o,h,d,f,u;return{setters:[function(e){t=e.inheritsLoose},function(e){a=e.cclegacy,n=e._decorator,r=e.resources,i=e.Texture2D,s=e.SpriteFrame,l=e.Size,o=e.Rect},function(e){h=e.UIBase},function(e){d=e.EventBus},function(e){f=e.EventTypes},function(e){u=e.GameInitializer}],execute:function(){var y;a._RF.push({},"3334feuD3ZDVIQdqCPrifks","UIInGamePlayer",void 0);var m=n.ccclass;e("UIInGamePlayer",m("UIInGamePlayer")(y=function(e){function a(){for(var t,a=arguments.length,n=new Array(a),r=0;r<a;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).m_myPlayer=void 0,t.m_myPlayerAvatar=void 0,t.m_playerList=void 0,t}t(a,e);var n=a.prototype;return n.onInit=function(){this._setupComponents()},n._setupComponents=function(){var e,t;this.m_myPlayer=null==(e=this.getChild("myPlayer"))?void 0:e.asCom,this.m_myPlayer&&(this.m_myPlayerAvatar=this.m_myPlayer.getChild("avatar"));var a=null==(t=this.getChild("playerList"))?void 0:t.asCom;a&&(this.m_playerList=a.getChild("players"),this.m_playerList&&(this.m_playerList.itemRenderer=this.renderPlayerItem.bind(this)))},n.bindEvents=function(){d.on(f.Game.TurnEnd,this._onGameUpdate,this),d.on(f.Player.MoneyChange,this._onGameUpdate,this),d.on(f.Player.CashChange,this._onGameUpdate,this),d.on(f.Player.StatusChange,this._onGameUpdate,this),d.on(f.Player.BuffAdded,this._onGameUpdate,this),d.on(f.Player.BuffRemoved,this._onGameUpdate,this),d.on(f.Player.BuffsUpdated,this._onGameUpdate,this),d.on(f.Game.TurnChanged,this._onTurnChanged,this)},n.unbindEvents=function(){d.off(f.Game.TurnEnd,this._onGameUpdate,this),d.off(f.Player.MoneyChange,this._onGameUpdate,this),d.off(f.Player.CashChange,this._onGameUpdate,this),d.off(f.Player.StatusChange,this._onGameUpdate,this),d.off(f.Player.BuffAdded,this._onGameUpdate,this),d.off(f.Player.BuffRemoved,this._onGameUpdate,this),d.off(f.Player.BuffsUpdated,this._onGameUpdate,this),d.off(f.Game.TurnChanged,this._onTurnChanged,this),e.prototype.unbindEvents.call(this)},n.onShow=function(e){this.refresh()},n.onRefresh=function(e){this.refresh()},n.refresh=function(){var e,t=null==(e=u.getInstance())?void 0:e.getGameSession();t&&(this.refreshMyPlayer(t),this.refreshPlayerList(t))},n.refreshMyPlayer=function(e){var t=e.getMyPlayer();if(t&&this.m_myPlayerAvatar){var a=t.getPlayerIndex();this.loadPlayerAvatar(this.m_myPlayerAvatar,a)}},n.refreshPlayerList=function(e){if(this.m_playerList){var t=e.getAllPlayers();this.m_playerList.numItems=t.length;var a=e.getActivePlayerIndex();this.m_playerList.selectedIndex=a,console.log("[UIInGamePlayer] Player list refreshed",{count:t.length,selectedIndex:a})}},n.renderPlayerItem=function(e,t){var a,n=t.asCom,r=null==(a=u.getInstance())?void 0:a.getGameSession(),i=null==r?void 0:r.getPlayerByIndex(e);if(i){var s=n.getChild("avatar");s&&this.loadPlayerAvatar(s,e);var l=n.getChild("index");l&&(l.text=""+(e+1));var o=n.getChild("playerName");o&&(o.text="玩家 "+(e+1));var h=n.getChild("cash");h&&(h.text=i.getCash().toString());var d=n.getChild("status");if(d)if(i.isBankrupt())d.text="破产";else if(i.isInHospital()){var f=i.getInHospitalTurns();d.text="住院中 (剩余"+f+"回合)"}else d.text="";var y=e===(null==r?void 0:r.getActivePlayerIndex()),m=n.getController("selected");m&&(m.selectedIndex=y?1:0);var c=n.getChild("bg");c&&(c.alpha=y?1:.6);var v=n.getChild("buffs");v&&this.renderBuffsList(v,i,r)}},n.renderBuffsList=function(e,t,a){var n=this,r=t.getAllBuffs(),i=a.getRound(),s=r.filter((function(e){return i<=e.last_active_round}));e.numItems=s.length,e.itemRenderer=function(e,t){var a=t.asCom,r=s[e],i=a.getChild("title");i&&(i.text=n.getBuffDisplayName(r.kind))}},n.getBuffDisplayName=function(e){return{1:"移动控制",2:"冻结",3:"免租",4:"停止",5:"转向",6:"飞行",7:"隐身",8:"加速",9:"减速",10:"护盾"}[e]||"Buff"+e},n.loadPlayerAvatar=function(e,t){var a="web3/actors/player_"+t+"/texture";r.load(a,i,(function(t,n){if(!t&&n){var r=new s;r.texture=n,r.originalSize=new l(n.width,n.height),r.rect=new o(0,0,n.width,n.height),e.texture=r}else console.warn("[UIInGamePlayer] Failed to load player avatar: "+a)}))},n._onGameUpdate=function(){this.refresh()},n._onTurnChanged=function(e){this.m_playerList&&(this.m_playerList.selectedIndex=e.newPlayerIndex,console.log("[UIInGamePlayer] 选中玩家:",e.newPlayerIndex)),this.refresh()},a}(h))||y);a._RF.pop()}}}));

System.register("chunks:///_virtual/UIInGamePlaySetting.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts"],(function(t,n){var e,i,o,s,l,a,c,r;return{setters:[function(t){e=t.inheritsLoose,i=t.asyncToGenerator,o=t.regeneratorRuntime},function(t){s=t.cclegacy,l=t._decorator},function(t){a=t.UIBase},function(t){c=t.EventBus},function(t){r=t.EventTypes}],execute:function(){var u;s._RF.push({},"259cfNMkjJEr56Q7KeVfaNK","UIInGamePlaySetting",void 0);var h=l.ccclass;t("UIInGamePlaySetting",h("UIInGamePlaySetting")(u=function(t){function s(){for(var n,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];return(n=t.call.apply(t,[this].concat(i))||this).btn_exitGame=void 0,n.btn_close=void 0,n._eventsBound=!1,n}e(s,t);var l=s.prototype;return l.onInit=function(){this.btn_exitGame=this.getButton("btn_exitGame"),this.btn_close=this.getButton("btn_close"),this.btn_exitGame&&this.btn_close?console.log("[UIInGamePlaySetting] Initialized"):console.error("[UIInGamePlaySetting] Failed to get buttons")},l.bindEvents=function(){this._eventsBound?console.log("[UIInGamePlaySetting] Events already bound, skipping"):(this.btn_exitGame&&this.btn_exitGame.onClick(this.onExitGameClick,this),this.btn_close&&this.btn_close.onClick(this.onCloseClick,this),this._eventsBound=!0,console.log("[UIInGamePlaySetting] Events bound"))},l.onShow=function(t){console.log("[UIInGamePlaySetting] Showing play setting panel"),this.bindEvents()},l.onHide=function(){console.log("[UIInGamePlaySetting] Hiding play setting panel"),this.unbindEvents()},l.onExitGameClick=function(){var t=i(o().mark((function t(){var e,i,s;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UIInGamePlaySetting] Exit game button clicked"),this.panel&&(this.panel.visible=!1,console.log("[UIInGamePlaySetting] Panel closed before exit")),c.emit(r.UI.PlaySettingClosed),t.next=5,n.import("./UIManager.ts");case 5:i=t.sent,s=i.UIManager,null==(e=s.instance)||e.exitGame();case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),l.onCloseClick=function(){console.log("[UIInGamePlaySetting] Close button clicked"),this.panel&&(this.panel.visible=!1,console.log("[UIInGamePlaySetting] Panel hidden")),c.emit(r.UI.PlaySettingClosed)},l.unbindEvents=function(){this._eventsBound&&(this.btn_exitGame&&this.btn_exitGame.offClick(this.onExitGameClick,this),this.btn_close&&this.btn_close.offClick(this.onCloseClick,this),this._eventsBound=!1,console.log("[UIInGamePlaySetting] Events unbound"),t.prototype.unbindEvents.call(this))},s}(a))||u);s._RF.pop()}}}));

System.register("chunks:///_virtual/UIManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./EventBus.ts","./EventTypes.ts","./Blackboard.ts","./UI3DInteractionManager.ts","./MapManager.ts","./fairygui.mjs","./UITypes.ts","./UIModeSelect.ts","./UIInGame.ts","./UIMapSelect.ts","./UICommonLayout.ts","./UIFairyGUIAdapter.ts","./UIMessage.ts","./UINotification.ts"],(function(e){var t,n,a,r,o,i,s,c,u,l,g,h,d,I,f,m,U,p,y,_,v,k,M,w,b,C,S,L,P;return{setters:[function(e){t=e.extends,n=e.createForOfIteratorHelperLoose,a=e.asyncToGenerator,r=e.regeneratorRuntime,o=e.createClass},function(e){i=e.cclegacy,s=e.warn,c=e.director,u=e.Canvas,l=e.error},function(e){g=e.EventBus},function(e){h=e.EventTypes},function(e){d=e.Blackboard},function(e){I=e.UI3DInteractionManager},function(e){f=e.MapManager},function(e){m=e.GRoot,U=e.GComponent,p=e.RelationType,y=e.UIPackage,_=e.Window},function(t){v=t.UILayer,e("UILayer",t.UILayer)},function(e){k=e.UIModeSelect},function(e){M=e.UIInGame},function(e){w=e.UIMapSelect},function(e){b=e.UICommonLayout},function(e){C=e.UIFairyGUIAdapter},function(e){S=e.MessageBoxType,L=e.UIMessage},function(e){P=e.UINotification}],execute:function(){i._RF.push({},"ea44ee9+2VPCr2sLSbIdtnI","UIManager",void 0);var x=e("UIManager",function(){function e(){this._groot=null,this._layers=new Map,this._uiConfigs=new Map,this._uiConstructors=new Map,this._activeUIs=new Map,this._commonLayoutUI=null,this._uiCache=new Map,this._loadedPackages=new Set,this._config={},this._inited=!1,this._globalListenersSetup=!1}var i=e.prototype;return i.init=function(e){if(void 0===e&&(e={}),this._inited)s("[UIManager] Already initialized!");else try{this._config=t({debug:!1,enableCache:!0,designResolution:{width:1136,height:640}},e),this._initFairyGUI(),this._inited=!0,this._config.debug&&console.log("[UIManager] Initialized with FairyGUI")}catch(e){throw console.error("[UIManager] Failed to initialize UI system:",e),e}},i._initFairyGUI=function(){try{var e=c.getScene();if(!e)throw new Error("场景未准备好，无法初始化FairyGUI");if(!e.getComponentInChildren(u))throw new Error("场景中找不到Canvas组件，FairyGUI需要Canvas才能工作");if(console.log("[UIManager] Scene and Canvas ready, initializing FairyGUI"),m.create(),this._groot=m.inst,!this._groot)throw new Error("FairyGUI GRoot创建失败");if(this._groot.node.addComponent(C),this._config.debug&&console.log("[UIManager] FairyGUI initialized",{groot:this._groot,designResolution:this._config.designResolution}),this._groot.node)this._groot.node.getComponent(I)||this._groot.node.addComponent(I);else console.warn("[UIManager] FairyGUI根节点无效，跳过UI3DInteractionManager添加");this._initLayers()}catch(e){throw console.error("[UIManager] FairyGUI初始化失败:",e),e}this._config.debug&&(g.setDebug(!0),d.instance.setDebug(!0))},i._initLayers=function(){var e=this;this._groot?([{name:"BackgroundLayer",layer:v.BACKGROUND,touchable:!1},{name:"SceneLayer",layer:v.SCENE,touchable:!0},{name:"NormalLayer",layer:v.NORMAL,touchable:!0},{name:"PersistentLayer",layer:v.PERSISTENT,touchable:!0},{name:"PopupLayer",layer:v.POPUP,touchable:!0},{name:"ModalLayer",layer:v.MODAL,touchable:!0},{name:"NotificationLayer",layer:v.NOTIFICATION,touchable:!1},{name:"SystemLayer",layer:v.SYSTEM,touchable:!1},{name:"TopLayer",layer:v.TOP,touchable:!0}].forEach((function(t){var n=new U;n.name=t.name,n.sortingOrder=t.layer,n.setSize(e._groot.width,e._groot.height),n.addRelation(e._groot,p.Size),n.touchable=t.touchable,n.opaque=!1,e._groot.addChild(n),e._layers.set(t.layer,n)})),this._config.debug&&console.log("[UIManager] UI layers initialized:",this._layers.size)):console.error("[UIManager] GRoot not initialized")},i.getLayer=function(e){return this._layers.get(e)||null},i.loadPackage=function(){var e=a(r().mark((function e(t){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._loadedPackages.has(t)){e.next=3;break}return this._config.debug&&console.log("[UIManager] Package "+t+" already loaded"),e.abrupt("return",!0);case 3:return e.next=5,this._ensureCommonPackagesLoaded();case 5:return e.abrupt("return",this._loadSinglePackage(t));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),i._ensureCommonPackagesLoaded=function(){var t=a(r().mark((function t(){var a,o,i;return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=n(e.COMMON_PACKAGES);case 1:if((o=a()).done){t.next=12;break}if(i=o.value,this._loadedPackages.has(i)){t.next=10;break}return this._config.debug&&console.log("[UIManager] Loading required common package: "+i),t.next=7,this._loadSinglePackage(i);case 7:if(t.sent){t.next=10;break}throw new Error("Failed to load required common package: "+i);case 10:t.next=1;break;case 12:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),i._loadSinglePackage=function(t){var n=this;return this._loadedPackages.has(t)?Promise.resolve(!0):new Promise((function(a){n._config.debug&&console.log("[UIManager] Loading package: "+t),y.loadPackage(e.UI_DIR+t,(function(e){e?(l("[UIManager] Failed to load package "+t+":",e),a(!1)):(n._loadedPackages.add(t),n._config.debug&&console.log("[UIManager] Package "+t+" loaded successfully"),a(!0))}))}))},i.loadCommonPackages=function(){var e=a(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._ensureCommonPackagesLoaded();case 3:return e.abrupt("return",!0);case 6:return e.prev=6,e.t0=e.catch(0),l("[UIManager] Failed to load common packages:",e.t0),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(){return e.apply(this,arguments)}}(),i.unloadPackage=function(e){if(!this._loadedPackages.has(e))return this._config.debug&&console.log("[UIManager] Package "+e+" not loaded"),!1;try{return y.removePackage(e),this._loadedPackages.delete(e),this._config.debug&&console.log("[UIManager] Package "+e+" unloaded"),!0}catch(t){return l("[UIManager] Error unloading package "+e+":",t),!1}},i.unloadAllPackages=function(){for(var e=Array.from(this._loadedPackages),t=0,n=e;t<n.length;t++){var a=n[t];this.unloadPackage(a)}this._config.debug&&console.log("[UIManager] Unloaded "+e.length+" packages")},i.isPackageLoaded=function(e){return this._loadedPackages.has(e)},i.getLoadedPackages=function(){return Array.from(this._loadedPackages)},i.registerUI=function(e,t,n){this._uiConfigs.has(e)?s("[UIManager] UI "+e+" already registered!"):(this._uiConfigs.set(e,t),this._uiConstructors.set(e,n),this._config.debug&&console.log("[UIManager] Registered UI: "+e,t))},i.showUI=function(){var e=a(r().mark((function e(t,n){var a,o,i,s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIManager] Show UI: "+t+", data: "+n),this._inited){e.next=4;break}return l("[UIManager] Not initialized!"),e.abrupt("return",null);case 4:if(a=this._uiConfigs.get(t),o=this._uiConstructors.get(t),a&&o){e.next=9;break}return l("[UIManager] UI "+t+" not registered!"),e.abrupt("return",null);case 9:if(!((i=this._activeUIs.get(t))&&i.node&&i.node.isValid)){e.next=17;break}return this._config.debug&&console.log("[UIManager] UI "+t+" already exists and is valid, returning existing instance"),i.refresh(n),i.show(n),e.abrupt("return",i);case 17:i&&(this._config.debug&&console.log("[UIManager] UI "+t+" exists but node is invalid, removing from active list"),this._activeUIs.delete(t));case 18:if(e.prev=18,this._loadedPackages.has(a.packageName)){e.next=26;break}return e.next=22,this.loadPackage(a.packageName);case 22:if(e.sent){e.next=26;break}return l("[UIManager] Failed to load package for UI "+t),e.abrupt("return",null);case 26:if(s=this._tryGetFromCache(t)){e.next=33;break}return e.next=30,this._createUIInstance(t,a,o);case 30:if(s=e.sent){e.next=33;break}return e.abrupt("return",null);case 33:return a.isWindow?this._showAsWindow(s,a):this._showAsComponent(s,a),s.show(n),this._activeUIs.set(t,s),g.emit(h.UI.ManagerStateChange,{action:"show",uiName:t,ui:s}),this._config.debug&&console.log("[UIManager] Showed UI: "+t),e.abrupt("return",s);case 41:return e.prev=41,e.t0=e.catch(18),l("[UIManager] Error showing UI "+t+":",e.t0),e.abrupt("return",null);case 45:case"end":return e.stop()}}),e,this,[[18,41]])})));return function(t,n){return e.apply(this,arguments)}}(),i.hideUI=function(e){var t=this._activeUIs.get(e);if(t){var n=this._uiConfigs.get(e);if(n)try{if(t.hide(),this._activeUIs.delete(e),n.isWindow&&t.panel.parent){var a=t.panel.parent;a&&a.hide&&a.hide()}n.cache&&this._config.enableCache?this._uiCache.set(e,t):t.destroy(),g.emit(h.UI.ManagerStateChange,{action:"hide",uiName:e,ui:t}),this._config.debug&&console.log("[UIManager] Hidden UI: "+e)}catch(t){l("[UIManager] Error hiding UI "+e+":",t)}else l("[UIManager] UI config "+e+" not found!")}else s("[UIManager] UI "+e+" not active!")},i.toggle=function(){var e=a(r().mark((function e(t,n,a){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isUIShowing(n)){e.next=4;break}this.hideUI(n),e.next=6;break;case 4:return e.next=6,this.showUI(n,a);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,a){return e.apply(this,arguments)}}(),i.getUI=function(e,t){return this._activeUIs.get(t)||null},i.getActiveUI=function(e){return this._activeUIs.get(e)||null},i.isUIShowing=function(e){var t=this._activeUIs.get(e);return!!t&&t.isShowing},i.hideAllUI=function(e){for(var t=0,n=Array.from(this._activeUIs.keys());t<n.length;t++){var a=n[t];e&&-1!==e.indexOf(a)||this.hideUI(a)}},i.clearCache=function(e){if(e){var t=this._uiCache.get(e);t&&(t.destroy(),this._uiCache.delete(e))}else{for(var a,r=n(this._uiCache);!(a=r()).done;){a.value[1].destroy()}this._uiCache.clear()}},i.getActiveUIs=function(){return Array.from(this._activeUIs.keys())},i.createObject=function(e,t){if(!this.isPackageLoaded(e))return l("[UIManager] Package "+e+" not loaded, cannot create object "+t),null;try{return y.createObject(e,t)}catch(n){return l("[UIManager] Error creating object "+e+"."+t+":",n),null}},i.createObjectAsync=function(){var e=a(r().mark((function e(t,n){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isPackageLoaded(t)){e.next=6;break}return e.next=3,this.loadPackage(t);case 3:if(e.sent){e.next=6;break}return e.abrupt("return",null);case 6:return e.abrupt("return",this.createObject(t,n));case 7:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),i.getPackageItem=function(e,t){if(!this.isPackageLoaded(e))return s("[UIManager] Package "+e+" not loaded"),null;try{var n=y.getByName(e);return n?n.getItemByName(t):null}catch(n){return l("[UIManager] Error getting package item "+e+"."+t+":",n),null}},i.hasResource=function(e,t){return null!==this.getPackageItem(e,t)},i.getStats=function(){return{loadedCount:this._loadedPackages.size,loadedPackages:Array.from(this._loadedPackages),activeUIs:Array.from(this._activeUIs.keys()),cachedUIs:this._uiCache.size}},i.destroy=function(){this.hideAllUI(),this.clearCache(),this._uiConfigs.clear(),this._uiConstructors.clear(),this._activeUIs.clear(),this._loadedPackages.clear(),this._groot=null,this._inited=!1,this._globalListenersSetup=!1,e._instance=null},e.initUISystem=function(){var t=a(r().mark((function t(n){return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UISystem] Initializing FairyGUI UI system..."),t.prev=1,e.instance.init(n),e.instance._inited){t.next=6;break}return console.error("[UISystem] UI Manager initialization failed"),t.abrupt("return",!1);case 6:return t.next=8,e.instance.loadCommonPackages();case 8:if(t.sent){t.next=12;break}return console.error("[UISystem] Failed to load common packages"),t.abrupt("return",!1);case 12:return e.instance._globalListenersSetup||(e.instance._setupGlobalUIEventListeners(),e.instance._globalListenersSetup=!0),console.log("[UISystem] FairyGUI UI system initialized successfully"),t.abrupt("return",!0);case 17:return t.prev=17,t.t0=t.catch(1),console.error("[UISystem] Failed to initialize UI system:",t.t0),t.abrupt("return",!1);case 21:case"end":return t.stop()}}),t,null,[[1,17]])})));return function(e){return t.apply(this,arguments)}}(),e.cleanupUISystem=function(){console.log("[UISystem] Cleaning up FairyGUI UI system..."),e.instance.destroy(),g.destroy(),d.instance.destroy(),console.log("[UISystem] FairyGUI UI system cleaned up successfully")},e.preloadUIPackages=function(){var t=a(r().mark((function t(a){var o,i,s,c;return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:console.log("[UISystem] Preloading UI packages:",a),o=a.filter((function(t){return!e.instance.isPackageLoaded(t)})),i=n(o);case 3:if((s=i()).done){t.next=11;break}return c=s.value,t.next=7,e.instance.loadPackage(c);case 7:t.sent||console.warn("[UISystem] Failed to load package: "+c);case 9:t.next=3;break;case 11:console.log("[UISystem] UI packages preloaded successfully");case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e.initializeGameUI=function(){var t=a(r().mark((function t(){return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UISystem] Initializing complete game UI system..."),t.prev=1,t.next=4,e.initUISystem({debug:!1,enableCache:!0,designResolution:{width:1920,height:1080}});case 4:if(t.sent){t.next=7;break}throw new Error("UI system initialization failed");case 7:return t.next=9,e.preloadUIPackages(e.PRELOAD_PACKAGES);case 9:return e.instance.registerModeSelectUI(e.PRELOAD_PACKAGES[1]),e.instance.registerMapSelectUI(e.PRELOAD_PACKAGES[2]),e.instance.registerInGameUI(e.PRELOAD_PACKAGES[3]),e.instance.registerMessageBoxUI(),e.instance.registerNotificationUI(),t.next=16,e.instance.showUI("Notification");case 16:return t.next=18,e.instance.initCommonLayoutUI();case 18:return t.next=20,e.instance.showModeSelect();case 20:console.log("[UISystem] Game UI system initialized completely"),t.next=27;break;case 23:throw t.prev=23,t.t0=t.catch(1),console.error("[UISystem] Failed to initialize game UI system:",t.t0),t.t0;case 27:case"end":return t.stop()}}),t,null,[[1,23]])})));return function(){return t.apply(this,arguments)}}(),i.registerModeSelectUI=function(e,t){void 0===t&&(t="Main"),this.registerUI("ModeSelect",{packageName:e,componentName:t,cache:!0,isWindow:!1,layer:v.SCENE},k)},i.registerInGameUI=function(e,t){void 0===t&&(t="Main"),this.registerUI("InGame",{packageName:e,componentName:t,cache:!0,isWindow:!1,layer:v.SCENE},M)},i.registerMapSelectUI=function(e,t){void 0===t&&(t="Main"),this.registerUI("MapSelect",{packageName:e,componentName:t,cache:!0,isWindow:!1,layer:v.SCENE},w)},i.registerMessageBoxUI=function(t,n){void 0===t&&(t="Common"),void 0===n&&(n=S.DEFAULT);var a=("string"==typeof n&&n.startsWith("MessageBox"),n);this.registerUI("MessageBox",{packageName:t,componentName:a,cache:!0,isWindow:!1,layer:v.MODAL},L);var r=("string"==typeof n&&n.startsWith("MessageBox"),n);L.initialize((function(){return{instance:e.instance}}),r)},i.registerNotificationUI=function(e,t){void 0===e&&(e="Common"),void 0===t&&(t="NotifyCenter"),this.registerUI("Notification",{packageName:e,componentName:t,cache:!0,isWindow:!1,layer:v.NOTIFICATION},P)},i.initCommonLayoutUI=function(){var e=a(r().mark((function e(t,n){var a,o,i;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t="Common"),void 0===n&&(n="CommonLayout"),!this._commonLayoutUI){e.next=5;break}return console.warn("[UIManager] CommonLayout UI already initialized"),e.abrupt("return");case 5:return e.prev=5,e.next=8,this.loadPackage(t);case 8:if(e.sent){e.next=12;break}return console.error("[UIManager] Failed to load package: "+t),e.abrupt("return");case 12:if(a=y.createObject(t,n)){e.next=16;break}return console.error("[UIManager] Failed to create "+t+"."+n),e.abrupt("return");case 16:if(o=a.asCom,this._commonLayoutUI=o.node.addComponent(b),this._commonLayoutUI.setUIName("CommonLayout"),this._commonLayoutUI.setPanel(o),this._commonLayoutUI.init(),i=this.getLayer(v.PERSISTENT)){e.next=25;break}return console.error("[UIManager] PERSISTENT layer not found"),e.abrupt("return");case 25:i.addChild(o),console.log("[UIManager] CommonLayout UI initialized successfully"),e.next=32;break;case 29:e.prev=29,e.t0=e.catch(5),console.error("[UIManager] Failed to initialize CommonLayout UI:",e.t0);case 32:case"end":return e.stop()}}),e,this,[[5,29]])})));return function(t,n){return e.apply(this,arguments)}}(),i.toggleGameConfig=function(){this._commonLayoutUI?this._commonLayoutUI.toggleGameConfig():console.warn("[UIManager] CommonLayout not initialized")},i.isGameConfigVisible=function(){var e;return(null==(e=this._commonLayoutUI)?void 0:e.isGameConfigVisible())||!1},i.toggleSuiConfig=function(){this._commonLayoutUI?this._commonLayoutUI.toggleSuiConfig():console.warn("[UIManager] CommonLayout not initialized")},i.isSuiConfigVisible=function(){var e;return(null==(e=this._commonLayoutUI)?void 0:e.isSuiConfigVisible())||!1},i.showInGameButtons=function(){this._commonLayoutUI?this._commonLayoutUI.showInGameButtons():console.warn("[UIManager] CommonLayout not initialized")},i.hideInGameButtons=function(){this._commonLayoutUI?this._commonLayoutUI.hideInGameButtons():console.warn("[UIManager] CommonLayout not initialized")},i.showEnvButton=function(){this._commonLayoutUI?this._commonLayoutUI.showEnvButton():console.warn("[UIManager] CommonLayout not initialized")},i.hideEnvButton=function(){this._commonLayoutUI?this._commonLayoutUI.hideEnvButton():console.warn("[UIManager] CommonLayout not initialized")},i.showModeSelect=function(){var e=a(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.showUI("ModeSelect"));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),i.showInGame=function(){var e=a(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.showUI("InGame"));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),i.showMapSelect=function(){var e=a(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.showUI("MapSelect"));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),i.exitGame=function(){console.log("[UIManager] 退出游戏");var e=d.instance.get("currentGameSession");e&&e.exitGameCleanup?(e.exitGameCleanup(),console.log("[UIManager] GameSession 已清理")):console.warn("[UIManager] GameSession not found or exitGameCleanup not available");var t=f.getInstance();t&&(t.unloadCurrentMap(),console.log("[UIManager] 地图场景已卸载")),this.isUIShowing("InGame")&&(this.hideUI("InGame"),console.log("[UIManager] UIInGame 已隐藏")),this.showUI("MapSelect"),console.log("[UIManager] 显示地图选择界面"),console.log("[UIManager] 游戏退出完成")},i._setupGlobalUIEventListeners=function(){var e=this;g.on(h.UI.ShowMainMenu,a(r().mark((function t(n){return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UISystem] UI.ShowMainMenu event received:",n),t.next=3,e.showUI("ModeSelect",n);case 3:case"end":return t.stop()}}),t)}))),this),g.on(h.UI.ShowMapSelect,a(r().mark((function t(n){return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UISystem] UI.ShowMapSelect event received:",n),t.next=3,e.showUI("MapSelect",n);case 3:case"end":return t.stop()}}),t)}))),this),g.on(h.Game.GameStart,a(r().mark((function t(n){return r().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UISystem] Game.GameStart event received:",n),t.next=3,e.showUI("InGame",n);case 3:case"end":return t.stop()}}),t)}))),this)},i._tryGetFromCache=function(e){if(!this._config.enableCache)return null;var t=this._uiCache.get(e);return t?(this._uiCache.delete(e),t):null},i._createUIInstance=function(){var e=a(r().mark((function e(t,n,a){var o,i;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,o=y.createObject(n.packageName,n.componentName)){e.next=5;break}return l("[UIManager] Failed to create FGUI component: "+n.packageName+"."+n.componentName),e.abrupt("return",null);case 5:return o.node.name=t,(i=o.node.addComponent(a)).setUIName(t),i.setPanel(o.asCom),e.abrupt("return",i);case 12:return e.prev=12,e.t0=e.catch(0),l("[UIManager] Error creating UI instance "+t+":",e.t0),e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n,a){return e.apply(this,arguments)}}(),i._showAsWindow=function(e,t){if(!this._groot)throw new Error("GRoot not initialized");var n=new _;n.contentPane=e.panel,t.modal&&(n.modal=!0),this._groot.showWindow(n)},i._showAsComponent=function(e,t){if(!this._groot)throw new Error("GRoot not initialized");var n=void 0!==t.layer?t.layer:v.NORMAL,a=this._layers.get(n);a?(a.addChild(e.panel),this._config.debug&&console.log("[UIManager] Added UI to layer "+n+" ("+v[n]+")")):(console.warn("[UIManager] Layer "+n+" not found, adding to GRoot"),this._groot.addChild(e.panel))},o(e,null,[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}},{key:"PRELOAD_PACKAGES_LIST",get:function(){return[].concat(e.PRELOAD_PACKAGES)}}]),e}());x._instance=null,x.UI_DIR="ui/",x.COMMON_PACKAGES=["Common"],x.PRELOAD_PACKAGES=["Common","ModeSelect","MapSelect","InGame"],i._RF.pop()}}}));

System.register("chunks:///_virtual/UIMapAssetList.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./MapManager.ts","./UINotification.ts","./EventBus.ts","./EventTypes.ts","./Blackboard.ts"],(function(e){var t,s,o,n,a,i,l,c,p,r,d,m,_,h;return{setters:[function(e){t=e.inheritsLoose},function(e){s=e.cclegacy,o=e._decorator,n=e.resources,a=e.Texture2D,i=e.SpriteFrame,l=e.Size,c=e.Rect},function(e){p=e.UIBase},function(e){r=e.mapManager},function(e){d=e.UINotification},function(e){m=e.EventBus},function(e){_=e.EventTypes},function(e){h=e.Blackboard}],execute:function(){var g;s._RF.push({},"a7161QoxpNPJJcVr0BY2DWb","UIMapAssetList",void 0);var u=o.ccclass;e("UIMapAssetList",u("UIMapAssetList")(g=function(e){function s(){for(var t,s=arguments.length,o=new Array(s),n=0;n<s;n++)o[n]=arguments[n];return(t=e.call.apply(e,[this].concat(o))||this).m_list=void 0,t.m_btn_editMap=void 0,t.m_btn_loadFromLocalStorage=null,t._maps=[],t._selectedMapId=null,t._selectedMapConfig=null,t._selectedIndex=-1,t}t(s,e);var o=s.prototype;return o.onInit=function(){this._setupComponents(),this._loadMapData()},o._setupComponents=function(){this.m_btn_editMap=this.getButton("btn_editMap"),this.m_list=this.getList("map_json"),this.m_btn_loadFromLocalStorage=this.getButton("btn_loadFromLocalStorage"),console.log("[UIMapAssetList] Components setup"),console.log("  m_btn_editMap:",!!this.m_btn_editMap),console.log("  m_list:",!!this.m_list),console.log("  m_btn_loadFromLocalStorage:",!!this.m_btn_loadFromLocalStorage)},o.bindEvents=function(){console.log("[UIMapAssetList] bindEvents called"),console.log("  m_btn_editMap:",!!this.m_btn_editMap),this.m_btn_editMap?(this.m_btn_editMap.onClick(this._onEditMapClick,this),console.log("  btn_editMap event bound ✅")):console.error("  ❌ btn_editMap is null, cannot bind event"),m.on(_.Game.MapConfigUpdated,this._onMapConfigUpdated,this)},o.unbindEvents=function(){var t;null==(t=this.m_btn_editMap)||t.offClick(this._onEditMapClick,this),e.prototype.unbindEvents.call(this)},o.refresh=function(){console.log("[UIMapAssetList] refresh() called"),this._loadMapData()},o._loadMapData=function(){if(console.log("[UIMapAssetList] Loading local map data"),console.log("  m_list:",!!this.m_list),r.instance)if(this._maps=r.instance.getAvailableMaps(),console.log("[UIMapAssetList] Loaded "+this._maps.length+" local maps"),this._maps.length>0&&console.log("  First map:",this._maps[0].name),this.m_list){console.log("[UIMapAssetList] Setting numItems to:",this._maps.length),this.m_list.numItems=this._maps.length,console.log("  List numItems is now:",this.m_list.numItems);for(var e=0;e<this._maps.length;e++){var t=this.m_list.getChildAt(e);t&&this._renderItem(e,t)}this._maps.length>0&&this._selectMap(0)}else console.error("[UIMapAssetList] m_list is null!");else console.error("[UIMapAssetList] MapManager not available")},o._renderItem=function(e,t){if(console.log("[UIMapAssetList] _renderItem called, index: "+e),e>=this._maps.length)console.warn("[UIMapAssetList] Index "+e+" out of range (max: "+(this._maps.length-1)+")");else{var s=this._maps[e],o=t.asCom;console.log("  Rendering map: "+s.name);var n=o.getChild("index");n&&(n.text=(e+1).toString());var a=o.getChild("mapName");a?(a.text=s.name,console.log("    mapName set to:",s.name)):console.warn("    mapName component not found");var i=o.getChild("mapType");if(i){var l=this._getMapTypeText(s.type);i.text=l,console.log("    mapType set to:",l)}else console.warn("    mapType component not found");var c=o.getChild("mapPreview");c&&s.previewImagePath?this._loadMapPreviewImage(s,c):c||console.warn("    mapPreview component not found"),o.selected=e===this._selectedIndex,o.data=e,o.offClick(this._onItemClick,this),o.onClick(this._onItemClick,this)}},o._getMapTypeText=function(e){switch(e){case"classic":return"经典模式";case"brawl":return"乱斗模式";default:return"未知"}},o._selectMap=function(e){if(!(e<0||e>=this._maps.length)){this._selectedIndex=e;var t=this._maps[e];this._selectedMapId=t.id,this._selectedMapConfig=t,console.log("[UIMapAssetList] Selected map: "+t.name),this.m_list&&(this.m_list.selectedIndex=e)}},o._loadMapPreviewImage=function(e,t){if(t&&e.previewImagePath){var s=e.previewImagePath+"/texture";console.log("[UIMapAssetList] Loading preview: "+s),n.load(s,a,(function(s,o){if(!s&&o){var n=new i;n.texture=o,n.originalSize=new l(o.width,o.height),n.rect=new c(0,0,o.width,o.height),t.texture=n}else console.warn("[UIMapAssetList] Failed to load preview:",s),t.url=e.previewImagePath}))}},o._onEditMapClick=function(){var e,t;if(console.log("=".repeat(60)),console.log("[UIMapAssetList] ===== EDIT MAP BUTTON CLICKED ====="),console.log("=".repeat(60)),!this._selectedMapId||!this._selectedMapConfig)return console.warn("[UIMapAssetList] No map selected"),void d.warning("请先选择地图");console.log("  Selected map:",this._selectedMapConfig.name),console.log("  Selected ID:",this._selectedMapId);var s=null!=(e=null==(t=this.m_btn_loadFromLocalStorage)?void 0:t.selected)&&e;console.log("[UIMapAssetList] Editing map: "+this._selectedMapConfig.name),console.log("  Load from localStorage:",s),h.instance.set("selectedMapId",this._selectedMapId),h.instance.set("selectedMapConfig",this._selectedMapConfig),h.instance.set("loadFromLocalStorage",s),m.emit(_.Game.MapSelected,{mapId:this._selectedMapId,isEdit:!0,mapConfig:this._selectedMapConfig,loadFromLocalStorage:s,source:"map_asset_list"})},o._onMapConfigUpdated=function(){console.log("[UIMapAssetList] Map config updated, refreshing"),this._loadMapData()},o._onItemClick=function(e){var t,s=e.sender,o=null!=(t=null==s?void 0:s.data)?t:-1;o>=0&&this._selectMap(o)},s}(p))||g);s._RF.pop()}}}));

System.register("chunks:///_virtual/UIMapElement.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./fairygui.mjs","./VoxelSystem.ts","./ActorConfig.ts"],(function(e){var t,o,i,n,s,l,r,c,a,d,m,u,h,g;return{setters:[function(e){t=e.inheritsLoose},function(e){o=e.cclegacy,i=e._decorator,n=e.resources,s=e.Texture2D,l=e.SpriteFrame,r=e.Size,c=e.Rect},function(e){a=e.UIBase},function(e){d=e.EventBus},function(e){m=e.EventTypes},function(e){u=e.LoaderFillType},function(e){h=e.VoxelSystem},function(e){g=e.ActorConfigManager}],execute:function(){var p;o._RF.push({},"3bf9bNeG3JHjpc98LLZVRLG","UIMapElement",void 0);var I=i.ccclass;e("UIMapElement",I("UIMapElement")(p=function(e){function o(){for(var t,o=arguments.length,i=new Array(o),n=0;n<o;n++)i[n]=arguments[n];return(t=e.call.apply(e,[this].concat(i))||this).m_tiles=void 0,t.m_objects=void 0,t.m_buildings=void 0,t.m_decorations=void 0,t.m_categoryController=void 0,t.m_tileIds=void 0,t.m_objectIds=void 0,t.m_propertyIds=void 0,t.m_decorationIds=void 0,t}t(o,e);var i=o.prototype;return i.onInit=function(){this._setupComponents(),this._setupDefaultValues()},i._setupComponents=function(){if(g.initialize(),this.panel)if(this.m_categoryController=this.panel.getController("category"),this.m_categoryController){var e=h.getInstance().getAllWeb3Blocks(),t=e.filter((function(e){return"tile"===e.category})),o=e.filter((function(e){return"object"===e.category})),i=e.filter((function(e){return"building"===e.category})),n=e.filter((function(e){return"decoration"===e.category}));this.m_tileIds=t.map((function(e){return e.id})),this.m_tiles=this.getList("tiles"),this.m_tiles&&(this.m_tiles.itemRenderer=this.renderTileItem.bind(this),this.m_tiles.numItems=this.m_tileIds.length,console.log("MapElement tiles count: ",this.m_tileIds.length)),this.m_objectIds=o.map((function(e){return e.id})),this.m_objects=this.getList("objects"),this.m_objects&&(this.m_objects.itemRenderer=this.renderObjectItem.bind(this),this.m_objects.numItems=this.m_objectIds.length,console.log("MapElement objects count: ",this.m_objectIds.length)),this.m_propertyIds=i.map((function(e){return e.id})),this.m_buildings=this.getList("buildings"),this.m_buildings&&(this.m_buildings.itemRenderer=this.renderPropertyItem.bind(this),this.m_buildings.numItems=this.m_propertyIds.length,console.log("MapElement properties count: ",this.m_propertyIds.length)),this.m_decorationIds=n.map((function(e){return e.id})),this.m_decorations=this.getList("decorations"),this.m_decorations&&(this.m_decorations.itemRenderer=this.renderDecorationItem.bind(this),this.m_decorations.numItems=this.m_decorationIds.length,console.log("MapElement decorations count: ",this.m_decorationIds.length))}else console.error("[UIMapElement] category controller not found!");else console.error("[UIMapElement] Panel not initialized!")},i._setupDefaultValues=function(){this._selectFirstElement()},i._selectFirstElement=function(){var e=this,t=this.getCurrentCategory(),o=null,i="tile";"tiles"===t?(i="tile",o=-1!==this.m_tileIds.indexOf("web3:empty_land")?"web3:empty_land":this.m_tileIds[0]):"objects"===t?(i="object",o=this.m_objectIds[0]):"properties"===t?(i="property",o=this.m_propertyIds[0]):"decorations"===t&&(i="decoration",o=this.m_decorationIds[0]),o&&this.scheduleOnce((function(){e._selectElementById(o,i)}),0)},i._selectElementById=function(e,t){void 0===t&&(t="tile");var o=("tile"===t?this.m_tileIds:"object"===t?this.m_objectIds:"property"===t?this.m_propertyIds:this.m_decorationIds).indexOf(e);if(-1===o)return console.warn("[UIMapElement] Block ID not found: "+e+", falling back to first element"),void this._selectElementByIndex(0,t);this._selectElementByIndex(o,t)},i._selectElementByIndex=function(e,t){var o;void 0===t&&(t="tile");var i="tile"===t?this.m_tileIds:"object"===t?this.m_objectIds:"property"===t?this.m_propertyIds:this.m_decorationIds,n="tile"===t?this.m_tiles:"object"===t?this.m_objects:"property"===t?this.m_buildings:this.m_decorations;if(n)if(e<0||e>=i.length)console.warn("[UIMapElement] Invalid index: "+e);else{var s=i[e],l=h.getInstance().getAllWeb3Blocks().find((function(e){return e.id===s})),r=l?l.name:(null==(o=h.getInstance().getBlockDefinition(s))?void 0:o.displayName)||s;if(l||h.getInstance().getBlockDefinition(s)){var c=n.getChildAt(e);if(c){var a=c.getChild("tileIcon"),u=a?a.texture:null,g=(null==l?void 0:l.size)||1;d.emit(m.UI.MapElementSelected,{blockId:s,blockName:r,spriteFrame:u,index:e,type:t,size:g,category:(null==l?void 0:l.category)||t}),console.log("[UIMapElement] Default selected: "+r+" ("+s+") type: "+t)}else console.warn("[UIMapElement] Tile not found at index: "+e)}else console.warn("[UIMapElement] Block not found: "+s)}else console.error("[UIMapElement] List not found for type: "+t)},i.switchCategory=function(e){console.log("[UIMapElement] Switching to category: "+e),this.m_categoryController?(this.m_categoryController.selectedPage=e,this._selectFirstElement()):console.error("[UIMapElement] Cannot switch category: controller not initialized!")},i.getCurrentCategory=function(){return this.m_categoryController?this.m_categoryController.selectedPage||"tiles":(console.error("[UIMapElement] Controller not initialized!"),"tiles")},i.switchToDecorations=function(){console.log("[UIMapElement] Switching to decorations category"),this.m_categoryController&&(this.m_categoryController.pageCount>3?(this.m_categoryController.selectedIndex=3,console.log("[UIMapElement] Switched to decorations by index")):(this.m_categoryController.selectedPage="decorations",console.log("[UIMapElement] Switched to decorations by name")),this._selectFirstElement()),console.log("[UIMapElement] Decorations list info:"),console.log("  - IDs:",this.m_decorationIds),console.log("  - List object:",this.m_decorations),this.m_decorations&&(console.log("  - List visible:",this.m_decorations.visible),console.log("  - List numItems:",this.m_decorations.numItems))},i.bindEvents=function(){},i.unbindEvents=function(){e.prototype.unbindEvents.call(this)},i.onShow=function(e){var t,o,i,n;if(console.log("[UIMapElement] Categories info:\n            - tiles: "+((null==(t=this.m_tileIds)?void 0:t.length)||0)+" items\n            - objects: "+((null==(o=this.m_objectIds)?void 0:o.length)||0)+" items\n            - properties: "+((null==(i=this.m_propertyIds)?void 0:i.length)||0)+" items\n            - decorations: "+((null==(n=this.m_decorationIds)?void 0:n.length)||0)+" items"),this.m_categoryController){console.log("[UIMapElement] Controller pages:",this.m_categoryController.pageCount);for(var s=0;s<this.m_categoryController.pageCount;s++)console.log("  Page "+s+": "+this.m_categoryController.getPageName(s))}},i.onHide=function(){},i.onRefresh=function(e){},i.renderTileItem=function(e,t){this.renderListItem(e,t,this.m_tileIds,"tile")},i.renderObjectItem=function(e,t){this.renderListItem(e,t,this.m_objectIds,"object")},i.renderPropertyItem=function(e,t){this.renderListItem(e,t,this.m_propertyIds,"property")},i.renderDecorationItem=function(e,t){this.renderListItem(e,t,this.m_decorationIds,"decoration")},i.renderListItem=function(e,t,o,i){var a,d=this,m=t.asCom,p=o[e],I=h.getInstance().getAllWeb3Blocks().find((function(e){return e.id===p})),_=I?I.name:(null==(a=h.getInstance().getBlockDefinition(p))?void 0:a.displayName)||p;m.getChild("title").text=e+" "+_;var f=m.getChild("tileIcon");if(f.fill=u.ScaleFree,"object"===i&&g.getConfig(p)){var y=g.getConfig(p);if(y&&y.textures.default){var b=y.textures.default+"/texture";n.load(b,s,(function(e,t){if(!e&&t){var o=new l;o.texture=t,o.originalSize=new r(t.width,t.height),o.rect=new c(0,0,t.width,t.height),f.texture=o}else console.warn("[UIMapElement] Failed to load PaperActor texture: "+b,e),f.url="texture/icons/default_block"}))}else f.url="texture/icons/default_block"}else try{var v=h.getInstance().getTextureManager();h.getInstance().getBlockData(p).then((function(e){if(e&&0!==e.textures.length){var t=e.textures[0].rel;return v.loadTexture(t)}console.warn("[UIMapElement] 无法获取方块纹理: "+p)})).then((function(e){if(e&&e.texture){var t=new l;t.texture=e.texture;var o=e.texture;t.originalSize=new r(o.width,o.height),t.rect=new c(0,0,o.width,o.height),f.texture=t}else f.url="texture/icons/default_block"}))}catch(e){console.warn("[UIMapElement] 加载方块纹理失败: "+p,e),f.url="texture/icons/default_block"}"tile"===i?m.onClick((function(e){return d.onTileClick(e,"tile")}),this):"object"===i?m.onClick((function(e){return d.onTileClick(e,"object")}),this):"property"===i?m.onClick((function(e){return d.onTileClick(e,"property")}),this):"decoration"===i&&m.onClick((function(e){return d.onTileClick(e,"decoration")}),this)},i.onTileClick=function(e,t){var o,i=e.sender,n="tile"===t?this.m_tiles:"object"===t?this.m_objects:"property"===t?this.m_buildings:this.m_decorations,s="tile"===t?this.m_tileIds:"object"===t?this.m_objectIds:"property"===t?this.m_propertyIds:this.m_decorationIds;if(n){var l=n.getChildIndex(i),r=s[l],c=h.getInstance().getAllWeb3Blocks().find((function(e){return e.id===r})),a=c?c.name:(null==(o=h.getInstance().getBlockDefinition(r))?void 0:o.displayName)||"";console.log("[UIMapElement] tile clicked: ",i.title);var u=i.getChild("tileIcon"),g=u?u.texture:null,p=(null==c?void 0:c.size)||1;d.emit(m.UI.MapElementSelected,{blockId:r,blockName:a,spriteFrame:g,index:l,type:t,size:p,category:(null==c?void 0:c.category)||t})}else console.error("[UIMapElement] List not found for type: "+t)},o}(a))||p);o._RF.pop()}}}));

System.register("chunks:///_virtual/UIMapList.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./SuiManager.ts","./UINotification.ts","./EventBus.ts","./EventTypes.ts"],(function(t){var e,i,n,s,l,a,o,c,r,m;return{setters:[function(t){e=t.inheritsLoose,i=t.asyncToGenerator,n=t.regeneratorRuntime},function(t){s=t.cclegacy,l=t._decorator},function(t){a=t.UIBase},function(t){o=t.SuiManager},function(t){c=t.UINotification},function(t){r=t.EventBus},function(t){m=t.EventTypes}],execute:function(){var p;s._RF.push({},"e6bafNNvk1GpqRLY0CV6bIm","UIMapList",void 0);var h=l.ccclass;t("UIMapList",h("UIMapList")(p=function(t){function s(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this).m_list=void 0,e.m_btn_createGame=void 0,e._templates=[],e._selectedTemplateId=null,e._selectedIndex=-1,e}e(s,t);var l=s.prototype;return l.onInit=function(){this._setupComponents()},l._setupComponents=function(){this.m_btn_createGame=this.getButton("btn_createGame"),this.m_list=this.getList("map_id"),console.log("[UIMapList] Components setup"),console.log("  m_btn_createGame:",!!this.m_btn_createGame),console.log("  m_list:",!!this.m_list)},l.bindEvents=function(){var t;null==(t=this.m_btn_createGame)||t.onClick(this._onCreateGameClick,this),r.on(m.Move.MapTemplatePublished,this._onMapTemplatePublished,this)},l.unbindEvents=function(){var e;null==(e=this.m_btn_createGame)||e.offClick(this._onCreateGameClick,this),r.off(m.Move.MapTemplatePublished,this._onMapTemplatePublished,this),t.prototype.unbindEvents.call(this)},l.refresh=function(){if(console.log("[UIMapList] Refreshing map template list"),this._templates=o.instance.getCachedMapTemplates(),console.log("[UIMapList] Loaded "+this._templates.length+" templates"),this.m_list){this.m_list.numItems=this._templates.length,console.log("  List updated, numItems:",this.m_list.numItems);for(var t=0;t<this._templates.length;t++){var e=this.m_list.getChildAt(t);e&&this._renderItem(t,e)}this._templates.length>0&&this._selectTemplate(0)}},l._renderItem=function(t,e){if(!(t>=this._templates.length)){var i=this._templates[t];if(i){var n=e.asCom,s=n.getChild("index");s&&(s.text=(t+1).toString());var l=n.getChild("mapid");l&&(l.text=i.template_id||"N/A");var a,o=n.getChild("tile");if(o)o.text=(null!=(a=i.tile_count)?a:0).toString();var c,r=n.getChild("building");if(r)r.text=(null!=(c=i.building_count)?c:0).toString();n.selected=t===this._selectedIndex,n.data=t,n.offClick(this._onItemClick,this),n.onClick(this._onItemClick,this)}}},l._selectTemplate=function(t){if(!(t<0||t>=this._templates.length)){this._selectedIndex=t;var e=this._templates[t];this._selectedTemplateId=e.template_id,console.log("[UIMapList] Selected template ID: "+e.template_id),this.m_list&&(this.m_list.selectedIndex=t)}},l._onCreateGameClick=function(){var t=i(n().mark((function t(){return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[UIMapList] Create game clicked"),null!==this._selectedTemplateId){t.next=4;break}return c.warning("请先选择地图模板"),t.abrupt("return");case 4:return t.prev=4,t.next=7,o.instance.createGameWithTemplate(this._selectedTemplateId);case 7:t.next=11;break;case 9:t.prev=9,t.t0=t.catch(4);case 11:case"end":return t.stop()}}),t,this,[[4,9]])})));return function(){return t.apply(this,arguments)}}(),l.selectTemplateById=function(t){console.log("[UIMapList] selectTemplateById:",t);var e=this._templates.findIndex((function(e){return e.template_id===t}));e>=0?(console.log("  Found template at index:",e),this._selectTemplate(e),this.m_list&&this.m_list.scrollToView&&this.m_list.scrollToView(e)):(console.warn("  Template not found in current list"),console.log("  Current templates:",this._templates.map((function(t){return t.id}))))},l._onItemClick=function(t){var e,i=t.sender,n=null!=(e=null==i?void 0:i.data)?e:-1;n>=0&&this._selectTemplate(n)},l._onMapTemplatePublished=function(t){console.log("[UIMapList] MapTemplatePublished event received"),console.log("  Template ID:",t.template_id),this.refresh()},s}(a))||p);s._RF.pop()}}}));

System.register("chunks:///_virtual/UIMapSelect.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./UIGameList.ts","./UIMapList.ts","./UIMapAssetList.ts","./UIGameDetail.ts","./SuiManager.ts"],(function(e){var t,o,a,n,i,s,l,m,c,r,h;return{setters:[function(e){t=e.inheritsLoose},function(e){o=e.cclegacy,a=e._decorator},function(e){n=e.UIBase},function(e){i=e.EventBus},function(e){s=e.EventTypes},function(e){l=e.UIGameList},function(e){m=e.UIMapList},function(e){c=e.UIMapAssetList},function(e){r=e.UIGameDetail},function(e){h=e.SuiManager}],execute:function(){var p;o._RF.push({},"95922Fm6OxGFpC+P7mOywv3","UIMapSelect",void 0);var d=a.ccclass;e("UIMapSelect",d("UIMapSelect")(p=function(e){function o(){for(var t,o=arguments.length,a=new Array(o),n=0;n<o;n++)a[n]=arguments[n];return(t=e.call.apply(e,[this].concat(a))||this).m_dataComponent=void 0,t.m_gameDetailComponent=void 0,t.m_categoryController=void 0,t.m_gameListUI=void 0,t.m_mapListUI=void 0,t.m_mapAssetListUI=void 0,t.m_gameDetailUI=void 0,t}t(o,e);var a=o.prototype;return a.onInit=function(){this._setupComponents(),this._initSubModules()},a._setupComponents=function(){this.m_dataComponent=this.getChild("data").asCom,this.m_dataComponent?(this.m_gameDetailComponent=this.getChild("gameDetail").asCom,this.m_gameDetailComponent||console.error("[UIMapSelect] gameDetail component not found"),this.m_categoryController=this.m_dataComponent.getController("category"),this.m_categoryController||console.error("[UIMapSelect] category controller not found"),console.log("[UIMapSelect] Components setup")):console.error("[UIMapSelect] data component not found")},a._initSubModules=function(){this.m_gameListUI=this.m_dataComponent.node.addComponent(l),this.m_gameListUI.setUIName("GameList"),this.m_gameListUI.setPanel(this.m_dataComponent),this.m_mapListUI=this.m_dataComponent.node.addComponent(m),this.m_mapListUI.setUIName("MapList"),this.m_mapListUI.setPanel(this.m_dataComponent),this.m_mapAssetListUI=this.m_dataComponent.node.addComponent(c),this.m_mapAssetListUI.setUIName("MapAssetList"),this.m_mapAssetListUI.setPanel(this.m_dataComponent),this.m_gameDetailUI=this.m_gameDetailComponent.node.addComponent(r),this.m_gameDetailUI.setUIName("GameDetail"),this.m_gameDetailUI.setPanel(this.m_gameDetailComponent),this.m_gameDetailUI.setParentUI(this),console.log("[UIMapSelect] Sub-modules initialized")},a.bindEvents=function(){i.on(s.Game.MapSelected,this._onMapSelected,this),i.on(s.Game.GameStart,this._onGameStart,this),i.on(s.Move.GameCreated,this._onMoveGameCreated,this),i.on(s.Game.ShowGameDetail,this._onShowGameDetail,this)},a.unbindEvents=function(){i.off(s.Game.MapSelected,this._onMapSelected,this),i.off(s.Game.GameStart,this._onGameStart,this),i.off(s.Move.GameCreated,this._onMoveGameCreated,this),i.off(s.Game.ShowGameDetail,this._onShowGameDetail,this),e.prototype.unbindEvents.call(this)},a._onMapSelected=function(e){console.log("[UIMapSelect] MapSelected event received"),console.log("  Source:",e.source),console.log("  Hiding UIMapSelect"),this.hide()},a._onGameStart=function(e){console.log("[UIMapSelect] GameStart event received"),console.log("  Hiding UIMapSelect"),this.hide()},a._onMoveGameCreated=function(e){console.log("[UIMapSelect] Move.GameCreated event received"),console.log("  Game:",e.game),console.log("  Creator:",e.creator);var t=h.instance.currentAddress,o=e.creator===t;console.log("  Is my game:",o),console.log("  Current address:",t),o&&e.gameObject&&(console.log("[UIMapSelect] My game created, showing detail"),this.showGameDetail(e.game))},a._onShowGameDetail=function(e){this.showGameDetail(e.gameId)},a.onShow=function(e){var t,o,a,n,l=this;console.log("[UIMapSelect] Showing"),console.log("  Data:",e),i.emit(s.Audio.PlayBGM,{musicPath:"audio/bgm/map_select",loop:!0}),this.m_dataComponent&&(this.m_dataComponent.visible=!0),this.m_gameDetailComponent&&(this.m_gameDetailComponent.visible=!1);var m=null!=(t=null==e?void 0:e.category)?t:0;this.m_categoryController&&(this.m_categoryController.selectedIndex=m,console.log("  Category set to:",m)),null==(o=this.m_gameListUI)||o.refresh(),null==(a=this.m_mapListUI)||a.refresh(),null==(n=this.m_mapAssetListUI)||n.refresh(),void 0!==(null==e?void 0:e.selectTemplateId)&&(console.log("  Will select template:",e.selectTemplateId),setTimeout((function(){var t;null==(t=l.m_mapListUI)||t.selectTemplateById(e.selectTemplateId)}),100)),this._playShowAnimation()},a.onHide=function(){console.log("[UIMapSelect] Hiding"),i.emit(s.Audio.StopBGM)},a.switchCategory=function(e){this.m_categoryController&&(this.m_categoryController.selectedIndex=e,console.log("[UIMapSelect] Switched to category: "+e))},a.showMainPanel=function(){console.log("[UIMapSelect] Showing main panel"),this.m_gameDetailComponent&&(this.m_gameDetailComponent.visible=!1)},a.showGameDetail=function(e){var t;console.log("[UIMapSelect] Showing game detail:",e),this.m_dataComponent&&(this.m_dataComponent.visible=!0),this.m_categoryController&&(this.m_categoryController.selectedIndex=0,console.log("  Category set to: 0 (Game list)")),null==(t=this.m_gameListUI)||t.selectGameById(e),this.m_gameDetailComponent&&this.m_gameDetailUI&&(this.m_gameDetailComponent.visible=!0,this.m_gameDetailUI.showGame())},a._playShowAnimation=function(){var e=this.getTransition("showAnim");e&&e.play()},o}(n))||p);o._RF.pop()}}}));

System.register("chunks:///_virtual/UIMessage.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./fairygui.mjs"],(function(t){var e,n,s,i,o,r,c,u,a;return{setters:[function(t){e=t.createClass,n=t.inheritsLoose,s=t.extends,i=t.asyncToGenerator,o=t.regeneratorRuntime},function(t){r=t.cclegacy,c=t._decorator},function(t){u=t.UIBase},function(t){a=t.Event}],execute:function(){var l,_;r._RF.push({},"d7892amFHBDAbI9JZaCbTJm","UIMessage",void 0);var h=c.ccclass,g=t("MessageBoxIcon",function(t){return t.NONE="none",t.INFO="info",t.SUCCESS="success",t.WARNING="warning",t.ERROR="error",t.CUSTOM="custom",t}({})),b=t("MessageBoxType",function(t){return t.DEFAULT="MessageBox",t.STYLE1="MessageBox1",t}({})),f=t("MessageBoxResult",function(t){return t.PRIMARY="primary",t.SECONDARY="secondary",t.CLOSE="close",t.TIMEOUT="timeout",t}({})),p=function(){function t(){this._queue=[],this._currentBox=null,this._isProcessing=!1,this._uiManagerGetter=null}var n=t.prototype;return n.setUIManagerGetter=function(t){this._uiManagerGetter=t},n.enqueue=function(t){var e=this;return new Promise((function(n){e._queue.push({options:t,resolve:n}),e._processNext()}))},n._processNext=function(){var t=i(o().mark((function t(){var e,n;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this._isProcessing&&0!==this._queue.length){t.next=2;break}return t.abrupt("return");case 2:if(this._isProcessing=!0,e=this._queue.shift()){t.next=7;break}return this._isProcessing=!1,t.abrupt("return");case 7:return t.prev=7,t.next=10,this._showMessageBox(e.options);case 10:n=t.sent,e.resolve(n),t.next=18;break;case 14:t.prev=14,t.t0=t.catch(7),console.error("[MessageBoxQueue] Error showing message box:",t.t0),e.resolve(f.CLOSE);case 18:return t.prev=18,this._currentBox=null,this._isProcessing=!1,this._processNext(),t.finish(18);case 23:case"end":return t.stop()}}),t,this,[[7,14,18,23]])})));return function(){return t.apply(this,arguments)}}(),n._showMessageBox=function(){var t=i(o().mark((function t(e){var n=this;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){if(!n._uiManagerGetter)return console.error("[MessageBoxQueue] UIManager getter not set"),void t(f.CLOSE);var s=n._uiManagerGetter();if(!s||!s.instance)return console.error("[MessageBoxQueue] UIManager not available"),void t(f.CLOSE);s.instance.showUI("MessageBox",e).then((function(s){if(!s)return console.error("[MessageBoxQueue] Failed to show MessageBox"),void t(f.CLOSE);n._currentBox=s;var i=e.onClose;s.setCloseCallback((function(e){i&&i(e),t(e)}))})).catch((function(e){console.error("[MessageBoxQueue] Error showing UI:",e),t(f.CLOSE)}))})));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),n.clear=function(){this._queue.forEach((function(t){return t.resolve(f.CLOSE)})),this._queue=[],this._currentBox&&(this._currentBox.close(f.CLOSE),this._currentBox=null),this._isProcessing=!1},e(t,[{key:"length",get:function(){return this._queue.length+(this._isProcessing?1:0)}}]),t}();t("UIMessage",h("UIMessage")(((_=function(t){function e(){for(var e,n=arguments.length,s=new Array(n),i=0;i<n;i++)s[i]=arguments[i];return(e=t.call.apply(t,[this].concat(s))||this)._bg=null,e._bgImage=null,e._icon=null,e._title=null,e._message=null,e._btnPrimary=null,e._btnSecondary=null,e._btn3=null,e._btnClose=null,e._currentOptions=null,e._closeCallback=null,e}n(e,t);var r=e.prototype;return r.onInit=function(){this._bg=this.getChild("bg"),this._bgImage=this.getLoader("bgImage"),this._icon=this.getLoader("icon"),this._title=this.getText("title"),this._message=this.getChild("message"),this._btnPrimary=this.getButton("btn_primary"),this._btnSecondary=this.getButton("btn_secondary"),this._btn3=this.getButton("btn_3"),this._btnClose=this.getButton("btn_close"),this._panel&&(this._panel.touchable=!0,this._panel.opaque=!1),console.log("[UIMessage] Initialized"),console.log("  btn_primary:",!!this._btnPrimary),console.log("  btn_secondary:",!!this._btnSecondary),console.log("  btn_close:",!!this._btnClose),this._bindButtonEvents()},r.onShow=function(t){t?(this._currentOptions=t,this._applyOptions(this._currentOptions)):console.warn("[UIMessage] No options provided")},r.onHide=function(){this._currentOptions=null,this._closeCallback=null},r._bindButtonEvents=function(){this._btnPrimary&&this._btnPrimary.on(a.CLICK,this._onPrimaryClick,this),this._btnSecondary&&this._btnSecondary.on(a.CLICK,this._onSecondaryClick,this),this._btn3&&this._btn3.on(a.CLICK,this._onBtn3Click,this),this._btnClose&&this._btnClose.on(a.CLICK,this._onCloseClick,this)},r._onPrimaryClick=function(){this._onButtonClick(f.PRIMARY)},r._onSecondaryClick=function(){this._onButtonClick(f.SECONDARY)},r._onBtn3Click=function(){this._onButtonClick("BTN_3")},r._onCloseClick=function(){this._onButtonClick(f.CLOSE)},r._applyOptions=function(t){this._title&&(this._title.text=t.title||""),this._message&&(this._message.text=t.message||""),this._setIcon(t.icon),this._setupButtons(t.buttons);var n=s({},e._defaultSkin,t.skin);this._applySkin(n)},r._setIcon=function(t){var e;if(this._icon)if(t&&t!==g.NONE){this._icon.visible=!0;var n=((e={})[g.NONE]="",e[g.INFO]="ui://Common/icon_info",e[g.SUCCESS]="ui://Common/icon_success",e[g.WARNING]="ui://Common/icon_warning",e[g.ERROR]="ui://Common/icon_error",e[g.CUSTOM]="",e);if(-1!==[g.NONE,g.INFO,g.SUCCESS,g.WARNING,g.ERROR,g.CUSTOM].indexOf(t)){var s=n[t];s?this._icon.url=s:this._icon.visible=!1}else this._icon.url=t}else this._icon.visible=!1},r._setupButtons=function(t){var e={text:"取消",visible:!1},n={text:"按钮3",visible:!1},i={text:"关闭",visible:!0},o={primary:s({},{text:"确定",visible:!0},null==t?void 0:t.primary),secondary:s({},e,null==t?void 0:t.secondary),btn_3:s({},n,null==t?void 0:t.btn_3),close:s({},i,null==t?void 0:t.close)};this._configButton(this._btnPrimary,o.primary),this._configButton(this._btnSecondary,o.secondary),this._configButton(this._btn3,o.btn_3),this._configButton(this._btnClose,o.close)},r._configButton=function(t,e){t&&(t.visible=!1!==e.visible,void 0!==e.text&&(t.title=e.text),void 0!==e.disabled&&(t.enabled=!e.disabled))},r._applySkin=function(t){t.bgColor&&this._bg,t.bgImage&&this._bgImage&&(this._bgImage.url=t.bgImage,this._bgImage.visible=!0),t.titleColor&&this._title,t.messageColor&&this._message},r._onButtonClick=function(){var t=i(o().mark((function t(e){var n;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(n=this._getButtonCallback(e))){t.next=10;break}return t.prev=2,t.next=5,n();case 5:t.next=10;break;case 7:t.prev=7,t.t0=t.catch(2),console.error("[UIMessage] Button callback error:",t.t0);case 10:this.close(e);case 11:case"end":return t.stop()}}),t,this,[[2,7]])})));return function(e){return t.apply(this,arguments)}}(),r._getButtonCallback=function(t){var e,n,s,i,o;if(null!=(e=this._currentOptions)&&e.buttons)switch(t){case f.PRIMARY:return null==(n=this._currentOptions.buttons.primary)?void 0:n.callback;case f.SECONDARY:return null==(s=this._currentOptions.buttons.secondary)?void 0:s.callback;case"BTN_3":return null==(i=this._currentOptions.buttons.btn_3)?void 0:i.callback;case f.CLOSE:return null==(o=this._currentOptions.buttons.close)?void 0:o.callback;default:return}},r.setCloseCallback=function(t){this._closeCallback=t},r.close=function(t){void 0===t&&(t=f.CLOSE),this._closeCallback&&this._closeCallback(t),this.hide(),setTimeout((function(){var t=e._queue._uiManagerGetter;if(t){var n=t();n&&n.instance&&n.instance.hideUI("MessageBox")}}),0)},e.initialize=function(t,n){e._queue.setUIManagerGetter(t),void 0!==n&&(e._currentComponentType=n),console.log("[UIMessage] Initialized with UIManager getter, componentType:",e._currentComponentType)},e.setComponentType=function(t){e._currentComponentType=t,console.log("[UIMessage] Component type set to:",t)},e.getComponentType=function(){return e._currentComponentType},e.setDefaultSkin=function(t){e._defaultSkin=s({},t)},e.clearQueue=function(){e._queue.clear()},e.getQueueLength=function(){return e._queue.length},e.show=function(t){return e._queue.enqueue(t)},e.info=function(t,n){return void 0===n&&(n=""),e.show({title:n,message:t,icon:g.INFO,buttons:{primary:{text:"知道了"},secondary:{visible:!1},close:{visible:!0}}})},e.success=function(t,n){return void 0===n&&(n=""),e.show({title:n,message:t,icon:g.SUCCESS,buttons:{primary:{text:"好的"},secondary:{visible:!1},close:{visible:!0}}})},e.warning=function(t,n){return void 0===n&&(n=""),e.show({title:n,message:t,icon:g.WARNING,buttons:{primary:{text:"我知道了"},secondary:{visible:!1},close:{visible:!0}}})},e.error=function(t,n){return void 0===n&&(n=""),e.show({title:n,message:t,icon:g.ERROR,buttons:{primary:{text:"确定"},secondary:{visible:!1},close:{visible:!0}}})},e.confirm=function(t){return new Promise((function(n){e.show({title:t.title||"确认",message:t.message,icon:t.icon||g.WARNING,buttons:{primary:{text:t.confirmText||"确定",callback:function(){return n(!0)}},secondary:{text:t.cancelText||"取消",visible:!0,callback:function(){return n(!1)}},close:{visible:!1}},onClose:function(t){t!==f.PRIMARY&&n(!1)}})}))},e}(u))._queue=new p,_._defaultSkin={},_._currentComponentType=b.DEFAULT,l=_))||l);r._RF.pop()}}}));

System.register("chunks:///_virtual/UIModeSelect.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./EventBus.ts","./EventTypes.ts"],(function(t,n){var e,o,i,s,r,a,c,u;return{setters:[function(t){e=t.inheritsLoose,o=t.asyncToGenerator,i=t.regeneratorRuntime},function(t){s=t.cclegacy,r=t._decorator},function(t){a=t.UIBase},function(t){c=t.EventBus},function(t){u=t.EventTypes}],execute:function(){var l;s._RF.push({},"a578cVz0NhLJLqQ7HrTA7zR","UIModeSelect",void 0);var h=r.ccclass;t("UIModeSelect",h("UIModeSelect")(l=function(t){function s(){for(var n,e=arguments.length,o=new Array(e),i=0;i<e;i++)o[i]=arguments[i];return(n=t.call.apply(t,[this].concat(o))||this).m_btn_start=void 0,n}e(s,t);var r=s.prototype;return r.onInit=function(){this._setupComponents()},r._setupComponents=function(){this.m_btn_start=this.getButton("btn_start")},r.bindEvents=function(){var t;null==(t=this.m_btn_start)||t.onClick(this._onStartClick,this),c.on(u.Game.GameStart,this._onGameStart,this)},r.unbindEvents=function(){var n;null==(n=this.m_btn_start)||n.offClick(this._onStartClick,this),t.prototype.unbindEvents.call(this)},r.onShow=function(){var t=o(i().mark((function t(e){var o,s,r;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UIModeSelect] Showing mode select UI"),"undefined"!=typeof window&&window.hideBootSplash&&window.hideBootSplash(),t.next=4,n.import("./UIManager.ts");case 4:s=t.sent,r=s.UIManager,null==(o=r.instance)||o.showEnvButton(),c.emit(u.Audio.PlayBGM,{musicPath:"audio/bgm/main_menu",loop:!0}),this._playShowAnimation();case 9:case"end":return t.stop()}}),t,this)})));return function(n){return t.apply(this,arguments)}}(),r.onHide=function(){var t=o(i().mark((function t(){var e,o,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[UIModeSelect] Hiding mode select UI"),t.next=3,n.import("./UIManager.ts");case 3:o=t.sent,s=o.UIManager,null==(e=s.instance)||e.hideEnvButton(),c.emit(u.Audio.StopBGM);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),r._onStartClick=function(){console.log("[UIModeSelect] Start clicked"),c.emit(u.UI.ShowMapSelect,{source:"mode_select"}),this.hide()},r._onGameStart=function(t){this.hide()},r._playShowAnimation=function(){var t=this.getTransition("showAnim");t&&t.play(),console.log("[UIModeSelect] Playing show animation")},s}(a))||l);s._RF.pop()}}}));

System.register("chunks:///_virtual/UINotification.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./fairygui.mjs"],(function(t){var e,i,o,n,s,a,c,r,h,u,l,_;return{setters:[function(t){e=t.inheritsLoose,i=t.createClass},function(t){o=t.cclegacy,n=t._decorator,s=t.Color},function(t){a=t.UIBase},function(t){c=t.GTween,r=t.EaseType,h=t.GRichTextField,u=t.GTextField,l=t.GGraph,_=t.UIPackage}],execute:function(){var f,g,d,p;o._RF.push({},"1864ekNJx5Ms7j9wEDD+VDr","UINotification",void 0);var v=n.ccclass,y=(t("NotifyIcon",function(t){return t.NONE="none",t.INFO="info",t.SUCCESS="success",t.WARNING="warning",t.ERROR="error",t.CUSTOM="custom",t}({})),t("NotifyType",function(t){return t.INFO="info",t.SUCCESS="success",t.WARNING="warning",t.ERROR="error",t.DEFAULT="default",t}({}))),O=function(){function t(t,e,i){this._gObject=void 0,this._onDestroy=void 0,this._isBottomToTop=void 0,this._isBottomToTop=e,this._onDestroy=i,this._gObject=_.createObject("Common","NotifyToast").asCom,this._setupContent(t)}var e=t.prototype;return e._setupContent=function(e){var i=this._gObject.getChild("bg")||this._findFirstGraph(this._gObject),o=this._findFirstText(this._gObject);if(o&&console.log("[NotificationToast] Message component type:",o.constructor.name,{isGRichTextField:o instanceof h,isGTextField:o instanceof u}),i&&e.type){var n=t.COLOR_MAP[e.type]||t.COLOR_MAP[y.DEFAULT],a=this._hexToColor(n);i.drawRect(0,new s(0,0,0,0),a)}if(o){var c=e.title?"【"+e.title+"】 "+e.message:e.message;o.text=c}},e._findFirstText=function(t){for(var e=[t];e.length;){var i=e.pop();if(i instanceof h)return i;if(i instanceof u)return i;var o=i.asCom;if(o)for(var n=0;n<o.numChildren;n++)e.push(o.getChildAt(n))}return null},e._findFirstGraph=function(t){for(var e=[t];e.length;){var i=e.pop();if(i instanceof l)return i;var o=i.asCom;if(o)for(var n=0;n<o.numChildren;n++)e.push(o.getChildAt(n))}return null},e._hexToColor=function(t){return new s(t>>16&255,t>>8&255,255&t,t>>24&255)},e.playEnterAnimation=function(){var t=this;this._gObject.alpha=0,c.to(0,1,.3).setEase(r.QuadOut).setTarget(this._gObject).onUpdate((function(e){t._gObject.alpha=e.value.x}))},e.destroy=function(){var t=this,e=this._isBottomToTop?this._gObject.y+50:this._gObject.y-50;c.to2(this._gObject.y,this._gObject.alpha,e,0,.25).setTarget(this._gObject).setEase(r.QuadIn).onUpdate((function(e){t._gObject.y=e.value.x,t._gObject.alpha=e.value.y})).onComplete((function(){t._gObject.dispose(),t._onDestroy&&t._onDestroy()}))},e.close=function(){this.destroy()},i(t,[{key:"gObject",get:function(){return this._gObject}}]),t}();O.COLOR_MAP=((p={})[y.INFO]=1934266594,p[y.SUCCESS]=1937691425,p[y.WARNING]=1945478691,p[y.ERROR]=1943011867,p[y.DEFAULT]=1936103884,p);var N=function(){function t(t,e,i,o){this._toasts=[],this._autoHideCancels=new Map,this._anchor=void 0,this._anchorName=void 0,this._container=void 0,this._scheduler=void 0,this._anchor=t,this._anchorName=e,this._container=i,this._scheduler=o}var e=t.prototype;return e.addNotification=function(e){var i,o=this;if(this._toasts.length>=t.MAX_NOTIFICATIONS){var n=this._toasts.shift();n&&(this._cancelAutoHide(n),n.destroy())}var s=new O(e,this._isBottomToTop(),(function(){var t=o._toasts.indexOf(s);-1!==t&&(o._toasts.splice(t,1),o._relayout(!0))}));this._container.addChild(s.gObject),this._toasts.push(s),this._isBottomToTop()?(s.gObject.x=this._anchor.x,s.gObject.y=this._anchor.y-s.gObject.height):(s.gObject.x=this._anchor.x,s.gObject.y=this._anchor.y),s.playEnterAnimation(),setTimeout((function(){o._relayout(!0)}),50);var a=T.DEFAULT_DURATIONS[e.type||y.DEFAULT],c=null!=(i=e.duration)?i:a,r=Math.max(0,c)/1e3,h=function(){o._autoHideCancels.delete(s),s.destroy()};this._scheduler.scheduleOnce(h,r),this._autoHideCancels.set(s,(function(){return o._scheduler.unschedule(h)}))},e._isBottomToTop=function(){return this._anchorName.includes("bottom")||"center"===this._anchorName},e._relayout=function(e){var i=this;if(void 0===e&&(e=!1),this._isBottomToTop())for(var o=0,n=this._toasts.length-1;n>=0;n--){var s=this._toasts[n],a=this._anchor.x,c=this._anchor.y-o-s.gObject.height;e?this._tweenToPosition(s.gObject,a,c,.2):(s.gObject.x=a,s.gObject.y=c),o+=s.gObject.height+t.SPACING}else{var r=0;this._toasts.forEach((function(o){var n=i._anchor.x,s=i._anchor.y+r;e?i._tweenToPosition(o.gObject,n,s,.2):(o.gObject.x=n,o.gObject.y=s),r+=o.gObject.height+t.SPACING}))}},e._tweenToPosition=function(t,e,i,o){c.to2(t.x,t.y,e,i,o).setTarget(t).setEase(r.QuadOut).onUpdate((function(e){t.x=e.value.x,t.y=e.value.y}))},e._cancelAutoHide=function(t){var e=this._autoHideCancels.get(t);if(e){try{e()}catch(t){}this._autoHideCancels.delete(t)}},e.clearAll=function(){var t=this;this._toasts.forEach((function(e){t._cancelAutoHide(e),e.destroy()})),this._toasts=[]},t}();N.MAX_NOTIFICATIONS=3,N.SPACING=0;var T=t("UINotification",v("UINotification")(((g=function(t){function i(){for(var e,i=arguments.length,o=new Array(i),n=0;n<i;n++)o[n]=arguments[n];return(e=t.call.apply(t,[this].concat(o))||this)._queues=new Map,e._container=null,e}e(i,t);var o=i.prototype;return o.onInit=function(){var t=this;if(this._container=this.panel,this._container){this._container.touchable=!1,this._container.opaque=!1;["lefttop","righttop","center","leftbottom","rightbottom"].forEach((function(e){var i,o=null==(i=t.panel)?void 0:i.getChild(e);if(o){o.touchable=!1,o.opaque=!1;var n=new N(o,e,t._container,t);t._queues.set(e,n),console.log("[UINotification] 创建队列: "+e)}})),i._instance=this,i._isReady=!0,console.log("[UINotification] 初始化完成，创建了 "+this._queues.size+" 个队列"),this._playPendingMessages()}else console.error("[UINotification] Panel not found")},o._playPendingMessages=function(){var t=this;0!==i._pendingMessages.length&&(console.log("[UINotification] Playing "+i._pendingMessages.length+" pending messages"),setTimeout((function(){i._pendingMessages.forEach((function(e){var i=e.options,o=e.anchor;t.addNotification(i,o)})),i._pendingMessages=[]}),100))},o.onShow=function(t){},o.onHide=function(){this.clearAll()},o.onDestroy=function(){this.clearAll(),i._instance=null,t.prototype.onDestroy.call(this)},o.addNotification=function(t,e){void 0===e&&(e="rightbottom");var i=this._queues.get(e);i?(i.addNotification(t),console.log("[UINotification] Added notification to "+e+": "+t.message)):console.error("[UINotification] Queue not found for anchor: "+e)},o.clearAll=function(){this._queues.forEach((function(t){return t.clearAll()}))},i._getInstance=function(){return i._instance},i._addMessage=function(t,e){void 0===e&&(e="rightbottom");var i=this._getInstance();if(i&&this._isReady)i.addNotification(t,e);else{var o;this._pendingMessages.push({options:t,anchor:e});var n=(null==(o=t.type)?void 0:o.toUpperCase())||"INFO",s=t.title?"["+t.title+"] ":"";console.log("["+n+"] "+s+t.message)}},i.info=function(t,e,i,o){this._addMessage({title:e,message:t,type:y.INFO,duration:i},o||"rightbottom")},i.success=function(t,e,i,o){this._addMessage({title:e,message:t,type:y.SUCCESS,duration:i},o||"rightbottom")},i.warning=function(t,e,i,o){this._addMessage({title:e,message:t,type:y.WARNING,duration:i},o||"rightbottom")},i.error=function(t,e,i,o){this._addMessage({title:e,message:t,type:y.ERROR,duration:i},o||"rightbottom")},i.show=function(t,e){this._addMessage(t,e||"rightbottom")},i.clearAll=function(){var t=this._getInstance();t&&t.clearAll()},i.txNotification=function(t,e,i,o,n){i.slice(0,8),i.slice(-6);var s=e+(o?"\nGas: "+o.gasSui:"")+"";t?this.success(s,void 0,6e3):this.error(s,void 0,6e3)},i}(a)).DEFAULT_DURATIONS=((d={})[y.INFO]=2e3,d[y.SUCCESS]=2e3,d[y.WARNING]=3e3,d[y.ERROR]=5e3,d[y.DEFAULT]=2e3,d),g._instance=null,g._pendingMessages=[],g._isReady=!1,f=g))||f);o._RF.pop()}}}));

System.register("chunks:///_virtual/UISuiConfig.ts",["./rollupPluginModLoBabelHelpers.js","cc","./fairygui.mjs","./UIBase.ts","./EventBus.ts","./EventTypes.ts","./SuiManager.ts","./SuiEnvConfigManager.ts","./KeystoreConfig.ts","./UINotification.ts"],(function(n){var e,t,i,o,s,r,a,l,c,u,g,h,f;return{setters:[function(n){e=n.inheritsLoose,t=n.asyncToGenerator,i=n.regeneratorRuntime},function(n){o=n.cclegacy,s=n._decorator},function(n){r=n.Event},function(n){a=n.UIBase},function(n){l=n.EventBus},function(n){c=n.EventTypes},function(n){u=n.SuiManager},function(n){g=n.SuiEnvConfigManager},function(n){h=n.KeystoreConfig},function(n){f=n.UINotification}],execute:function(){var d;o._RF.push({},"6b5f6cNLaFPTpVv6nKxmpX+","UISuiConfig",void 0);var p=s.ccclass;n("UISuiConfig",p("UISuiConfig")(d=function(n){function o(){for(var e,t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];return(e=n.call.apply(n,[this].concat(i))||this).envController=void 0,e.useKeypairController=void 0,e.input_storageKey=void 0,e.input_password=void 0,e.btn_cancel=void 0,e.btn_ok=void 0,e.keypairGroup=void 0,e._eventsBound=!1,e}e(o,n);var s=o.prototype;return s.onInit=function(){var n;this.envController=this.getController("env"),this.useKeypairController=this.getController("useKeypair");var e=null==(n=this.getChild("keypair"))?void 0:n.asCom;e&&(this.keypairGroup=e,this.input_storageKey=e.getChild("storageKey"),this.input_password=e.getChild("password")),this.btn_cancel=this.getButton("btn_cancel"),this.btn_ok=this.getButton("btn_ok"),this.envController&&this.useKeypairController&&this.btn_cancel&&this.btn_ok?console.log("[UISuiConfig] Components initialized"):console.error("[UISuiConfig] Failed to get required components")},s.bindEvents=function(){this._eventsBound?console.log("[UISuiConfig] Events already bound, skipping"):(this.btn_cancel&&this.btn_cancel.onClick(this.onCancelClick,this),this.btn_ok&&this.btn_ok.onClick(this.onOkClick,this),this.envController&&this.envController.on(r.STATUS_CHANGED,this.onEnvControllerChanged,this),this._eventsBound=!0,console.log("[UISuiConfig] Events bound"))},s.onShow=function(n){console.log("[UISuiConfig] Showing Sui config UI"),this.bindEvents(),this.loadCurrentConfig()},s.onHide=function(){console.log("[UISuiConfig] Hiding Sui config UI"),this.unbindEvents()},s.loadCurrentConfig=function(){var n=u.instance.config;console.log("[UISuiConfig] Loading current config:",{network:n.network,signerType:n.signerType}),this.envController.selectedIndex=this.getEnvIndex(n.network),this.useKeypairController.selectedIndex="keypair"===n.signerType?1:0,this.input_storageKey&&this.input_password&&(this.input_storageKey.text=h.instance.getStorageKey(),this.input_password.text=h.instance.getPassword())},s.onEnvControllerChanged=function(){var n=this.envController.selectedIndex,e=this.getEnvName(n);console.log("[UISuiConfig] Env controller changed to:",e,"(index:",n,")"),0===n||1===n?(this.useKeypairController.selectedIndex=0,console.log("[UISuiConfig] → 强制设置为 wallet (mainnet/testnet 不支持 keypair)")):3===n?(this.useKeypairController.selectedIndex=1,console.log("[UISuiConfig] → 强制设置为 keypair (localnet 只支持 keypair)")):console.log("[UISuiConfig] → 保持当前选择（devnet 可自由选择）")},s.onCancelClick=function(){console.log("[UISuiConfig] Cancel clicked"),this.panel.visible=!1,l.emit(c.UI.SuiConfigClosed)},s.onOkClick=function(){var n=t(i().mark((function n(){var e,t,o,s,r,a,h;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(console.log("[UISuiConfig] OK clicked"),this.btn_ok.enabled=!1,n.prev=2,e=this.getEnvName(this.envController.selectedIndex),t=1===this.useKeypairController.selectedIndex,o=t?"keypair":"wallet",s=u.instance.config,r=e!==s.network,a=o!==s.signerType,r||a){n.next=13;break}return console.log("[UISuiConfig] No changes detected"),this.panel.visible=!1,n.abrupt("return");case 13:if(!r){n.next=19;break}return console.log("[UISuiConfig] Network changed:",s.network,"→",e),n.next=17,this.handleNetworkChange(e,o);case 17:n.next=23;break;case 19:if(!a){n.next=23;break}return console.log("[UISuiConfig] Signer changed:",s.signerType,"→",o),n.next=23,this.handleSignerChange(t);case 23:g.instance.save(e,o),this.panel.visible=!1,l.emit(c.UI.SuiConfigClosed),n.next=33;break;case 28:n.prev=28,n.t0=n.catch(2),console.error("[UISuiConfig] Failed to apply config:",n.t0),h=n.t0 instanceof Error?n.t0.message:String(n.t0),f.error("配置应用失败："+h);case 33:return n.prev=33,this.btn_ok.enabled=!0,n.finish(33);case 36:case"end":return n.stop()}}),n,this,[[2,28,33,36]])})));return function(){return n.apply(this,arguments)}}(),s.handleNetworkChange=function(){var n=t(i().mark((function n(e,t){var o,s,r,a,l;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return f.info("正在切换到 "+e+"..."),o=g.instance.getConfig(e,t),n.next=4,u.instance.reinit(o);case 4:if("keypair"!==t){n.next=11;break}if(a=(null==(s=this.input_storageKey)?void 0:s.text.trim())||"",l=(null==(r=this.input_password)?void 0:r.text)||"",!a||!l){n.next=11;break}return h.instance.applyConfig(a,l),n.next=11,u.instance.reloadKeypair();case 11:f.success("已切换到 "+e);case 12:case"end":return n.stop()}}),n,this)})));return function(e,t){return n.apply(this,arguments)}}(),s.handleSignerChange=function(){var n=t(i().mark((function n(e){var t,o,s,r,a;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!e){n.next=14;break}if(s=(null==(t=this.input_storageKey)?void 0:t.text.trim())||"",r=(null==(o=this.input_password)?void 0:o.text)||"",s&&r){n.next=6;break}return f.warning("请填写 Storage Key 和 Password"),n.abrupt("return");case 6:return h.instance.applyConfig(s,r),f.info("正在加载密钥..."),n.next=10,u.instance.reloadKeypair();case 10:n.sent?(a=u.instance.currentAddress,f.success("已切换到 Keypair 模式\n"+a)):f.success("已切换到 Keypair 模式"),n.next=16;break;case 14:u.instance.clearSigner(),f.info("已切换到 Wallet 模式\n请连接钱包");case 16:case"end":return n.stop()}}),n,this)})));return function(e){return n.apply(this,arguments)}}(),s.onClose=function(){this.onCancelClick()},s.getEnvName=function(n){return["mainnet","testnet","devnet","localnet"][n]||"testnet"},s.getEnvIndex=function(n){var e=["mainnet","testnet","devnet","localnet"].indexOf(n);return e>=0?e:1},s.unbindEvents=function(){this._eventsBound?(this.btn_cancel&&this.btn_cancel.offClick(this.onCancelClick,this),this.btn_ok&&this.btn_ok.offClick(this.onOkClick,this),this.envController&&this.envController.off(r.STATUS_CHANGED,this.onEnvControllerChanged,this),this._eventsBound=!1,console.log("[UISuiConfig] Events unbound"),n.prototype.unbindEvents.call(this)):console.log("[UISuiConfig] Events not bound, skipping unbind")},o}(a))||d);o._RF.pop()}}}));

System.register("chunks:///_virtual/UITypes.ts",["cc"],(function(e){var t;return{setters:[function(e){t=e.cclegacy}],execute:function(){t._RF.push({},"69eb570hStEy4Fog3HqXu0V","UITypes",void 0);e("UILayer",function(e){return e[e.BACKGROUND=0]="BACKGROUND",e[e.SCENE=100]="SCENE",e[e.NORMAL=200]="NORMAL",e[e.PERSISTENT=250]="PERSISTENT",e[e.POPUP=300]="POPUP",e[e.MODAL=400]="MODAL",e[e.NOTIFICATION=500]="NOTIFICATION",e[e.SYSTEM=1e3]="SYSTEM",e[e.TOP=1e4]="TOP",e}({})),e("UIEventType",function(e){return e.BeforeShow="before_show",e.AfterShow="after_show",e.BeforeHide="before_hide",e.AfterHide="after_hide",e.BeforeDestroy="before_destroy",e.ManagerStateChange="manager_state_change",e}({})),e("FGUIResourceType",function(e){return e.Image="image",e.Audio="audio",e.Font="font",e.Component="component",e.Package="package",e}({}));t._RF.pop()}}}));

System.register("chunks:///_virtual/UIWallet.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIBase.ts","./Blackboard.ts","./fairygui.mjs","./UITypes.ts","./loader.ts","./UINotification.ts","./SuiManager.ts","./SuiEnvConfigManager.ts"],(function(e,t){var n,o,l,a,c,s,i,r,u,d,h,_,m,g,f,p,b,W;return{setters:[function(e){n=e.inheritsLoose,o=e.asyncToGenerator,l=e.regeneratorRuntime},function(e){a=e.cclegacy,c=e._decorator,s=e.assetManager,i=e.Texture2D,r=e.SpriteFrame},function(e){u=e.UIBase},function(e){d=e.Blackboard},function(e){h=e.UIPackage,_=e.GRoot},function(e){m=e.UILayer},function(e){g=e.loadSuiClient,f=e.loadWalletStandard},function(e){p=e.UINotification},function(e){b=e.SuiManager},function(e){W=e.SuiEnvConfigManager}],execute:function(){var w;a._RF.push({},"02495hxx99IlY8oDaMknDQl","UIWallet",void 0);var C=c.ccclass,I="sui_wallet_connection";e("UIWallet",C("UIWallet")(w=function(e){function a(){for(var t,n=arguments.length,o=new Array(n),l=0;l<n;l++)o[l]=arguments[l];return(t=e.call.apply(e,[this].concat(o))||this).m_btn_wallet=void 0,t.m_btn_connect=void 0,t.m_btn_disconnect=void 0,t.m_btn_balance=null,t.m_txt_chain=null,t.m_controller=null,t.m_connectedWallet=null,t.m_connectedAccount=null,t._isKeypairMode=!1,t.m_walletListComponent=null,t._networkChangedHandler=function(e){t._onNetworkChanged(e)},t}n(a,e);var c=a.prototype;return c.onInit=function(){this._setupComponents(),this._tryAutoConnect(),this._checkSuiManagerState()},c._setupComponents=function(){this.m_btn_wallet=this.getButton("btn_wallet"),this.m_btn_connect=this.getButton("btn_connect"),this.m_btn_disconnect=this.getButton("btn_disconnect"),this.m_btn_balance=this.getButton("btn_balance"),this.m_txt_chain=this.getText("chain"),this.m_controller=this.getController("wallet"),this.m_controller||console.error("[UIWallet] Controller 'wallet' not found"),this._updateChainDisplay(),this.m_btn_disconnect&&(this.m_btn_disconnect.visible=!1)},c.bindEvents=function(){this.m_btn_wallet&&this.m_btn_wallet.onClick(this._onWalletClick,this),this.m_btn_connect&&this.m_btn_connect.onClick(this._onConnectClick,this),this.m_btn_disconnect&&this.m_btn_disconnect.onClick(this._onDisconnectClick,this),this.m_btn_balance&&this.m_btn_balance.onClick(this._onBalanceClick,this),d.instance.watch("sui_balance",this._onBalanceChanged,this),d.instance.watch("sui_keypair_connected",this._onKeypairConnected,this),d.instance.watch("sui_current_address",this._onAddressChanged,this),d.instance.watch("sui_network_changed",this._networkChangedHandler,this)},c.unbindEvents=function(){this.m_btn_wallet&&this.m_btn_wallet.offClick(this._onWalletClick,this),this.m_btn_connect&&this.m_btn_connect.offClick(this._onConnectClick,this),this.m_btn_disconnect&&this.m_btn_disconnect.offClick(this._onDisconnectClick,this),this.m_btn_balance&&this.m_btn_balance.offClick(this._onBalanceClick,this),this._closeWalletList(),d.instance.unwatch("sui_balance",this._onBalanceChanged,this),d.instance.unwatch("sui_keypair_connected",this._onKeypairConnected,this),d.instance.unwatch("sui_current_address",this._onAddressChanged,this),d.instance.unwatch("sui_network_changed",this._networkChangedHandler,this),e.prototype.unbindEvents.call(this)},c._onConnectClick=function(){var e=o(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[UIWallet] Connect clicked"),e.next=3,this.getSuiWallets();case 3:t=e.sent,this._showWalletList(t).catch((function(e){console.error("[UIWallet] Failed to show wallet list:",e)}));case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),c._onDisconnectClick=function(){var e=o(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIWallet] Disconnect clicked"),this.m_connectedWallet){e.next=4;break}return console.warn("[UIWallet] No wallet connected"),e.abrupt("return");case 4:if(e.prev=4,!(t=this.m_connectedWallet.features["standard:disconnect"])||"function"!=typeof t.disconnect){e.next=10;break}return e.next=9,t.disconnect();case 9:console.log("[UIWallet] Disconnected from "+this.m_connectedWallet.name);case 10:this._clearConnection(),this.m_connectedWallet=null,this.m_connectedAccount=null,b.instance.clearSigner(),console.log("[UIWallet] SuiManager signer cleared"),this.m_btn_balance&&(this.m_btn_balance.title=""),this.m_controller&&(this.m_controller.selectedIndex=0),this.m_btn_disconnect&&(this.m_btn_disconnect.visible=!1),p.info("钱包已断开"),e.next=25;break;case 21:e.prev=21,e.t0=e.catch(4),console.error("[UIWallet] Failed to disconnect:",e.t0),p.error("断开钱包失败");case 25:case"end":return e.stop()}}),e,this,[[4,21]])})));return function(){return e.apply(this,arguments)}}(),c._onWalletClick=function(){console.log("[UIWallet] Wallet clicked"),this.m_controller?this._isKeypairMode?console.log("[UIWallet] Keypair mode: no disconnect allowed"):1===this.m_controller.selectedIndex&&this.m_btn_disconnect&&(this.m_btn_disconnect.visible=!this.m_btn_disconnect.visible,console.log("[UIWallet] Toggle disconnect button to "+(this.m_btn_disconnect.visible?"visible":"hidden"))):console.error("[UIWallet] Controller not initialized")},c.testSuiClient=function(){var e=o(l().mark((function e(){var t,n,o,a,c,s,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t="https://fullnode.testnet.sui.io:443",e.next=3,g();case 3:return n=e.sent,o=n.SuiClient,a=new o({url:t}),e.next=8,a.getObject({id:"0x8",options:{showBcs:!0,showContent:!0}});case 8:c=e.sent,s=c.data,i=c.error,console.log("wallet data: ",s),console.log("wallet error: ",i);case 13:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),c.getSuiWallets=function(){var e=o(l().mark((function e(){var t,n,o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f();case 2:return t=e.sent,n=t.getWallets,o=n().get(),console.log("wallets length: ",o.length),console.log("getWallets: ",o),a=this._filterSuiWallets(o),console.log("suiWallets length: ",a.length),console.log("suiWallets: ",a),e.abrupt("return",a);case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),c._showWalletList=function(){var e=o(l().mark((function e(n){var o,a,c,s,i,r,u,d,g,f=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.m_walletListComponent&&this._closeWalletList(),this.m_walletListComponent=h.createObject("Common","WalletList").asCom,this.m_walletListComponent){e.next=5;break}return console.error("[UIWallet] Failed to create WalletList component"),e.abrupt("return");case 5:if(o=this.m_walletListComponent.getChild("wallets")){e.next=9;break}return console.error("[UIWallet] Failed to get wallets list from WalletList component"),e.abrupt("return");case 9:o.numItems=n.length,a=l().mark((function e(){var t,a,s,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=n[c],a=o.getChildAt(c).asCom,(s=a.getChild("title"))&&(s.text=t.name),(i=a.getChild("icon"))&&t.icon&&f._loadWalletIcon(t.icon,i),a.onClick((function(){return f._onWalletItemClick(t)}),f);case 7:case"end":return e.stop()}}),e)})),c=0;case 12:if(!(c<n.length)){e.next=17;break}return e.delegateYield(a(),"t0",14);case 14:c++,e.next=12;break;case 17:return e.next=19,t.import("./UIManager.ts");case 19:if(s=e.sent,i=s.UIManager,r=i.instance.getLayer(m.POPUP)){e.next=25;break}return console.error("[UIWallet] POPUP layer not found"),e.abrupt("return");case 25:r.addChild(this.m_walletListComponent),u=_.inst,d=(u.width-this.m_walletListComponent.width)/2,g=(u.height-this.m_walletListComponent.height)/2,this.m_walletListComponent.setPosition(d,g),console.log("[UIWallet] WalletList displayed with "+n.length+" wallets");case 31:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),c._loadWalletIcon=function(e,t){this.createSpriteFrameFromDataURL(e,(function(e,n){!e&&n?t.texture=n:console.error("[UIWallet] Failed to load wallet icon:",e)}))},c._closeWalletList=function(){this.m_walletListComponent&&(this.m_walletListComponent.removeFromParent(),this.m_walletListComponent.dispose(),this.m_walletListComponent=null)},c._onWalletItemClick=function(){var e=o(l().mark((function e(t){var n,o,a,c,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[UIWallet] Wallet clicked: "+t.name),e.prev=1,(n=t.features["standard:connect"])&&"function"==typeof n.connect){e.next=7;break}return console.error("[UIWallet] Wallet does not support standard:connect"),p.error("钱包不支持连接功能"),e.abrupt("return");case 7:return e.next=9,n.connect();case 9:if(o=e.sent,console.log("[UIWallet] Connected to "+t.name+", accounts:",o),(a=o.accounts)&&0!==a.length){e.next=16;break}return console.error("[UIWallet] No accounts returned"),p.error("未获取到账户信息"),e.abrupt("return");case 16:c=a[0],this._saveConnection(t.name,c.address),this.m_connectedWallet=t,this.m_connectedAccount=c,this.m_controller&&(this.m_controller.selectedIndex=1),this.m_btn_wallet&&(this.m_btn_wallet.title=this._shortenAddress(c.address)),this._closeWalletList(),p.success("已连接到 "+t.name),b.instance.setWalletSigner(t,c),console.log("[UIWallet] SuiManager signer updated"),b.instance.loadPlayerAssets().catch((function(e){console.error("[UIWallet] Failed to load player assets:",e)})),(s=t.features["standard:events"])&&"function"==typeof s.on&&(s.on("change",this._onWalletChange.bind(this)),console.log("[UIWallet] Listening to wallet change for "+t.name)),e.next=35;break;case 31:e.prev=31,e.t0=e.catch(1),console.error("[UIWallet] Failed to connect to "+t.name+":",e.t0),p.error("连接 "+t.name+" 失败");case 35:case"end":return e.stop()}}),e,this,[[1,31]])})));return function(t){return e.apply(this,arguments)}}(),c._filterSuiWallets=function(e){return e.filter((function(e){var t;return(null==e?void 0:e.features)&&"function"==typeof(null==(t=e.features["sui:signTransaction"])?void 0:t.signTransaction)}))},c._tryAutoConnect=function(){var e=o(l().mark((function e(){var t,n,o,a,c,s,i,r,u,d,h;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.m_controller){e.next=3;break}return console.error("[UIWallet] Controller not initialized"),e.abrupt("return");case 3:if(t=this._loadConnection()){e.next=8;break}return console.log("[UIWallet] No saved connection, set to disconnected state"),this.m_controller.selectedIndex=0,e.abrupt("return");case 8:return e.prev=8,e.next=11,f();case 11:if(n=e.sent,o=n.getWallets,a=o().get(),c=this._filterSuiWallets(a),s=c.find((function(e){return e.name===t.walletName}))){e.next=21;break}return console.log("[UIWallet] Saved wallet '"+t.walletName+"' not found"),this._clearConnection(),this.m_controller.selectedIndex=0,e.abrupt("return");case 21:if((i=s.features["standard:connect"])&&"function"==typeof i.connect){e.next=27;break}return console.error("[UIWallet] Wallet does not support standard:connect"),this._clearConnection(),this.m_controller.selectedIndex=0,e.abrupt("return");case 27:return e.next=29,i.connect();case 29:if(r=e.sent,console.log("[UIWallet] Auto-connect to "+s.name+", accounts:",r),u=r.accounts,d=u.find((function(e){return e.address===t.accountAddress}))){e.next=38;break}return console.log("[UIWallet] Saved account '"+t.accountAddress+"' not found in accounts"),this._clearConnection(),this.m_controller.selectedIndex=0,e.abrupt("return");case 38:this.m_connectedWallet=s,this.m_connectedAccount=d,this.m_controller.selectedIndex=1,this.m_btn_wallet&&(this.m_btn_wallet.title=this._shortenAddress(d.address)),b.instance.setWalletSigner(s,d),console.log("[UIWallet] SuiManager signer updated (auto-connect)"),b.instance.loadPlayerAssets().catch((function(e){console.error("[UIWallet] Failed to load player assets:",e)})),(h=s.features["standard:events"])&&"function"==typeof h.on&&(h.on("change",this._onWalletChange.bind(this)),console.log("[UIWallet] Listening to wallet change for "+s.name)),console.log("[UIWallet] Auto-connected to "+s.name+" with account "+d.address),e.next=55;break;case 50:e.prev=50,e.t0=e.catch(8),console.error("[UIWallet] Auto-connect failed:",e.t0),this._clearConnection(),this.m_controller.selectedIndex=0;case 55:case"end":return e.stop()}}),e,this,[[8,50]])})));return function(){return e.apply(this,arguments)}}(),c.createSpriteFrameFromDataURL=function(e,t){s.loadRemote(e,{ext:".png"},(function(e,n){if(e)return console.error("[UIWallet] assetManager.loadRemote failed:",e),void t(e,null);var o=new i;o.image=n;var l=new r;l.texture=o,t(null,l)}))},c.logWallet=function(){var e=o(l().mark((function e(t){var n,o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(console.log("logWallet wallet "+t.name+": icon: "+t.icon+", accounts: "+t.accounts.length),n=0;n<t.accounts.length;n++)o=t.accounts[n],console.log("account "+n+": address: "+o.address+", publicKey: "+o.publicKey),console.log(o);return t.features["standard:events"].on("change",this._onWalletChange.bind(this)),console.log("[UIWallet] Listening to wallet change for "+t.name),e.next=6,t.features["standard:connect"].connect();case 6:a=e.sent,console.log("after connect, accounts:",a);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),c._onWalletChange=function(e){console.log("[UIWallet] onWalletChange: ",e),e.accounts&&e.accounts.length>0&&console.log("[UIWallet] Accounts changed:",e.accounts)},c._onBalanceChanged=function(e){console.log("[UIWallet] Balance changed:",e),this.m_btn_balance&&(this.m_btn_balance.title=this._formatBalance(e))},c._formatBalance=function(e){return(Number(e)/1e9).toFixed(4)+" SUI"},c._updateChainDisplay=function(){var e,t,n;if(this.m_txt_chain){var o=null==(e=b.instance)||null==(e=e.config)?void 0:e.network,l=null==(t=b.instance)?void 0:t.getSignerType();if(!o){var a=W.instance.load();o=a.network,l=a.signerType,console.log("[UIWallet] SuiManager not ready, using saved config:",a)}var c=(null==(n=b.instance)?void 0:n.getNetworkName())||o;this.m_txt_chain.text="keypair"===l?c+" (Keypair)":c,console.log("[UIWallet] Chain display updated:",this.m_txt_chain.text)}},c._onBalanceClick=function(){this.m_connectedAccount||this._isKeypairMode?(console.log("[UIWallet] Balance clicked, opening explorer"),p.info("正在打开区块链浏览器..."),b.instance.openCurrentAddressExplorer()):console.warn("[UIWallet] No account connected")},c._onKeypairConnected=function(e){if(e){console.log("[UIWallet] Keypair connected (dev mode)"),this.m_connectedWallet=null,this.m_connectedAccount=null,this._clearConnection(),this._isKeypairMode=!0;var t=d.instance.get("sui_current_address");if(t){this.m_controller&&(this.m_controller.selectedIndex=1),this.m_btn_wallet&&(this.m_btn_wallet.title=this._shortenAddress(t)),this.m_btn_disconnect&&(this.m_btn_disconnect.visible=!1),this._updateChainDisplay();var n=d.instance.get("sui_balance");null!=n?(console.log("[UIWallet] Setting initial balance from Blackboard:",n),this._onBalanceChanged(n)):console.log("[UIWallet] No balance in Blackboard yet, will wait for update"),console.log("[UIWallet] UI updated for Keypair mode"),console.log("  Address:",t)}else console.error("[UIWallet] No address in Blackboard")}},c._onAddressChanged=function(e){e&&(console.log("[UIWallet] Address changed:",e),this._isKeypairMode&&(this.m_btn_wallet&&(this.m_btn_wallet.title=this._shortenAddress(e),console.log("[UIWallet] Wallet button title updated")),this._updateChainDisplay(),p.info("地址已更新\n"+this._shortenAddress(e))))},c._onNetworkChanged=function(e){if(console.log("[UIWallet] Network changed event received:",e),this._updateChainDisplay(),this.m_connectedWallet=null,this.m_connectedAccount=null,this.m_controller){var t=b.instance.getSignerType(),n=b.instance.currentAddress;"keypair"===t&&n?(this._isKeypairMode=!0,this.m_controller.selectedIndex=1,this.m_btn_wallet&&(this.m_btn_wallet.title=this._shortenAddress(n)),console.log("[UIWallet] Keypair mode detected after network change")):(this._isKeypairMode=!1,this.m_controller.selectedIndex=0,this.m_btn_wallet&&(this.m_btn_wallet.title="Connect"),console.log("[UIWallet] Wallet mode, disconnected")),this.m_btn_disconnect&&(this.m_btn_disconnect.visible=!1)}var o=d.instance.get("sui_balance");null!=o?this._onBalanceChanged(o):this.m_btn_balance&&(this.m_btn_balance.title="0 SUI"),console.log("[UIWallet] Wallet UI updated after network change")},c._checkSuiManagerState=function(){var e=this;setTimeout((function(){try{var t=b.instance.getSignerType(),n=b.instance.currentAddress;if("keypair"===t&&n){console.log("[UIWallet] Detected existing Keypair connection on init"),e._isKeypairMode=!0,e.m_connectedWallet=null,e.m_connectedAccount=null,e.m_controller&&(e.m_controller.selectedIndex=1),e.m_btn_wallet&&(e.m_btn_wallet.title=e._shortenAddress(n)),e.m_btn_disconnect&&(e.m_btn_disconnect.visible=!1),e._updateChainDisplay();var o=d.instance.get("sui_balance");null!=o?(console.log("[UIWallet] Setting initial balance from Blackboard:",o),e._onBalanceChanged(o)):console.log("[UIWallet] No balance in Blackboard yet"),console.log("[UIWallet] UI updated for existing Keypair"),console.log("  Address:",n)}}catch(e){console.log("[UIWallet] SuiManager not ready yet, will wait for Blackboard event")}}),200)},c._saveConnection=function(e,t){var n={walletName:e,accountAddress:t};try{localStorage.setItem(I,JSON.stringify(n)),console.log("[UIWallet] Connection saved:",n)}catch(e){console.error("[UIWallet] Failed to save connection:",e)}},c._loadConnection=function(){try{var e=localStorage.getItem(I);if(!e)return null;var t=JSON.parse(e);return console.log("[UIWallet] Connection loaded:",t),t}catch(e){return console.error("[UIWallet] Failed to load connection:",e),null}},c._clearConnection=function(){try{localStorage.removeItem(I),console.log("[UIWallet] Connection cleared")}catch(e){console.error("[UIWallet] Failed to clear connection:",e)}},c._shortenAddress=function(e){return!e||e.length<10?e:e.slice(0,6)+"..."+e.slice(-4)},a}(u))||w);a._RF.pop()}}}));

System.register("chunks:///_virtual/utils.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(n){var r,e,t;return{setters:[function(n){r=n.extends,e=n.createForOfIteratorHelperLoose},function(n){t=n.cclegacy}],execute:function(){n({buildResourcePath:function(n,r,e,t){var i="assets/"+n+"/"+r;e&&(i+="/"+e);i+="/"+t,"blockstates"===r||"models"===r?i+=".json":"textures"===r&&(i+=".png");return i},checkResourceExists:function(n,r){return!0},deepClone:function n(r){if(null===r||"object"!=typeof r)return r;if(r instanceof Date)return new Date(r.getTime());if(r instanceof Array){for(var t,i=[],s=e(r);!(t=s()).done;){var u=t.value;i.push(n(u))}return i}if(r instanceof Object){var a={};for(var o in r)r.hasOwnProperty(o)&&(a[o]=n(r[o]));return a}return r},getPreferredTextureKey:function(n){if(!n||0===Object.keys(n).length)return null;for(var r=0,e=["all","side","top","front","north","east","south","west","up","down"];r<e.length;r++){var t=e[r];if(n[t])return t}return Object.keys(n)[0]},mergeTextures:function(n,e){return n||e?n?e?r({},n,e):r({},n):r({},e||{}):{}},normalizeTexturePath:function(n,r){void 0===r&&(r=i);if(!n)return"minecraft:block/missing";n.startsWith("#")&&(n=n.substring(1));if(n.includes(":"))return n;if(n.includes("/"))return r+":"+n;return r+":block/"+n},parseModelOrTexRef:function(n,r,e){if(!n)return{ns:r,name:"missing"};if(n.startsWith("#"))return{kind:"var",ns:r,name:n.substring(1)};if(n.startsWith("builtin/"))return{kind:"builtin",builtin:!0,ns:"builtin",name:n.substring("builtin/".length)};var t=n.indexOf(":");if(t>0){var i=n.substring(0,t),s=n.substring(t+1),u=s.indexOf("/");return u>0?{kind:"path",ns:i,domain:s.substring(0,u),name:s.substring(u+1)}:{kind:"path",ns:i,domain:"block",name:s}}var a=n.indexOf("/");return a>0?{kind:"path",ns:r,domain:n.substring(0,a),name:n.substring(a+1)}:{kind:"path",ns:r,domain:"block",name:n}},parseNamespacedId:function(n,r){void 0===r&&(r=i);if(!n)return{ns:r,path:""};var e=n.indexOf(":");if(e>0&&e<n.length-1)return{ns:n.substring(0,e),path:n.substring(e+1)};return{ns:r,path:n}},pickDefaultVariant:function(n){if(!n||"object"!=typeof n)return null;if(n[""]){var r=n[""];return{key:"",variant:Array.isArray(r)?r[0]:r}}var e=Object.keys(n);if(e.length>0){var t=e[0],i=n[t];return{key:t,variant:Array.isArray(i)?i[0]:i}}return null}}),t._RF.push({},"f9e49Q0R+JK972rqeZTC8Ts","utils",void 0);var i="minecraft";t._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelBlock.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Web3BlockTypes.ts"],(function(e){var t,i,s,r,a,l;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy},function(e){s=e.Web3TileType,r=e.Web3ObjectType,a=e.Web3BuildingType,l=e.Web3DecorationType}],execute:function(){i._RF.push({},"dd692+7329CXJjwsjzti77i","VoxelBlock",void 0);var n=e("VoxelBlockType",function(e){return e[e.EMPTY=0]="EMPTY",e[e.GRASS=1]="GRASS",e[e.SAND=2]="SAND",e[e.STONE=3]="STONE",e[e.BRICK=4]="BRICK",e[e.WOOD=5]="WOOD",e[e.CEMENT=6]="CEMENT",e[e.DIRT=7]="DIRT",e[e.PLANK=8]="PLANK",e[e.SNOW=9]="SNOW",e[e.GLASS=10]="GLASS",e[e.COBBLE=11]="COBBLE",e[e.LIGHT_STONE=12]="LIGHT_STONE",e[e.DARK_STONE=13]="DARK_STONE",e[e.CHEST=14]="CHEST",e[e.LEAVES=15]="LEAVES",e[e.CLOUD=16]="CLOUD",e[e.TALL_GRASS=17]="TALL_GRASS",e[e.YELLOW_FLOWER=18]="YELLOW_FLOWER",e[e.RED_FLOWER=19]="RED_FLOWER",e[e.PURPLE_FLOWER=20]="PURPLE_FLOWER",e[e.SUN_FLOWER=21]="SUN_FLOWER",e[e.WHITE_FLOWER=22]="WHITE_FLOWER",e[e.BLUE_FLOWER=23]="BLUE_FLOWER",e[e.COLOR_00=32]="COLOR_00",e[e.COLOR_01=33]="COLOR_01",e[e.COLOR_02=34]="COLOR_02",e[e.COLOR_03=35]="COLOR_03",e[e.COLOR_04=36]="COLOR_04",e[e.COLOR_05=37]="COLOR_05",e[e.COLOR_06=38]="COLOR_06",e[e.COLOR_07=39]="COLOR_07",e[e.COLOR_08=40]="COLOR_08",e[e.COLOR_09=41]="COLOR_09",e[e.COLOR_10=42]="COLOR_10",e[e.COLOR_11=43]="COLOR_11",e[e.COLOR_12=44]="COLOR_12",e[e.COLOR_13=45]="COLOR_13",e[e.COLOR_14=46]="COLOR_14",e[e.COLOR_15=47]="COLOR_15",e[e.COLOR_16=48]="COLOR_16",e[e.COLOR_17=49]="COLOR_17",e[e.COLOR_18=50]="COLOR_18",e[e.COLOR_19=51]="COLOR_19",e[e.COLOR_20=52]="COLOR_20",e[e.COLOR_21=53]="COLOR_21",e[e.COLOR_22=54]="COLOR_22",e[e.COLOR_23=55]="COLOR_23",e[e.COLOR_24=56]="COLOR_24",e[e.COLOR_25=57]="COLOR_25",e[e.COLOR_26=58]="COLOR_26",e[e.COLOR_27=59]="COLOR_27",e[e.COLOR_28=60]="COLOR_28",e[e.COLOR_29=61]="COLOR_29",e[e.COLOR_30=62]="COLOR_30",e[e.COLOR_31=63]="COLOR_31",e}({})),c=e("BlockRenderType",function(e){return e.SOLID="solid",e.CUTOUT="cutout",e.TRANSLUCENT="translucent",e.LIQUID="liquid",e}({})),o=e("BlockRegistry",function(){function e(){}return e.initialize=function(){this.initialized||(console.log("[BlockRegistry] 初始化方块注册表..."),this.registerMinecraftBlocks(),this.registerWeb3Blocks(),this.createLegacyMapping(),this.initialized=!0,console.log("[BlockRegistry] 初始化完成，共注册 "+this.blockDefinitions.size+" 个方块"))},e.registerMinecraftBlocks=function(){this.register({id:"minecraft:air",displayName:"空气",isPlant:!1,isObstacle:!1,isDestructable:!1,lightLevel:0,hardness:0,renderType:c.TRANSLUCENT}),this.register({id:"minecraft:stone",displayName:"石头",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:1.5,renderType:c.SOLID}),this.register({id:"minecraft:dirt",displayName:"泥土",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:.5,renderType:c.SOLID}),this.register({id:"minecraft:grass_block",displayName:"草方块",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:.6,renderType:c.SOLID}),this.register({id:"minecraft:sand",displayName:"沙子",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:.5,renderType:c.SOLID}),this.register({id:"minecraft:cobblestone",displayName:"鹅卵石",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:2,renderType:c.SOLID}),this.register({id:"minecraft:oak_log",displayName:"橡木原木",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:2,renderType:c.SOLID}),this.register({id:"minecraft:oak_planks",displayName:"橡木木板",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:2,renderType:c.SOLID}),this.register({id:"minecraft:oak_leaves",displayName:"橡木叶子",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:.2,renderType:c.CUTOUT}),this.register({id:"minecraft:glass",displayName:"玻璃",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:.3,renderType:c.TRANSLUCENT}),this.register({id:"minecraft:dandelion",displayName:"蒲公英",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT}),this.register({id:"minecraft:poppy",displayName:"虞粟",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT}),this.register({id:"minecraft:short_grass",displayName:"草",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT}),this.register({id:"minecraft:fern",displayName:"蕨",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT}),this.register({id:"minecraft:glowstone",displayName:"萤石",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:15,hardness:.3,renderType:c.SOLID}),this.register({id:"minecraft:torch",displayName:"火把",isPlant:!1,isObstacle:!1,isDestructable:!0,lightLevel:14,hardness:0,renderType:c.CUTOUT}),this.register({id:"minecraft:lantern",displayName:"灯笼",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:15,hardness:3.5,renderType:c.SOLID}),this.register({id:"minecraft:sea_lantern",displayName:"海晶灯",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:15,hardness:.3,renderType:c.SOLID}),this.register({id:"minecraft:jack_o_lantern",displayName:"南瓜灯",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:15,hardness:1,renderType:c.SOLID}),this.register({id:"minecraft:redstone_lamp",displayName:"红石灯",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:15,hardness:.3,renderType:c.SOLID}),this.register({id:"minecraft:campfire",displayName:"营火",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:15,hardness:2,renderType:c.SOLID}),this.register({id:"minecraft:end_rod",displayName:"末地烛",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:14,hardness:0,renderType:c.CUTOUT}),this.register({id:"minecraft:beacon",displayName:"信标",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:15,hardness:3,renderType:c.SOLID}),this.register({id:"minecraft:honey_block",displayName:"蜂蜜块",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:3,hardness:0,renderType:c.TRANSLUCENT}),this.register({id:"minecraft:glow_lichen",displayName:"荧光地衣",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:7,hardness:.2,renderType:c.CUTOUT}),this.register({id:"minecraft:glow_berries",displayName:"发光浆果",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:14,hardness:0,renderType:c.CUTOUT})},e.registerWeb3Blocks=function(){console.log("[Web3BlockTypes] 开始注册 Web3 方块..."),this.register({id:"web3:empty_land",displayName:"空地",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.SOLID,properties:{typeId:s.EMPTY_LAND,category:"tile",description:"空地块，无法购买"}}),this.register({id:"web3:lottery",displayName:"乐透",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.SOLID,properties:{typeId:s.LOTTERY,category:"tile",description:"乐透格子，触发抽奖"}}),this.register({id:"web3:hospital",displayName:"医院",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.TRANSLUCENT,properties:{typeId:s.HOSPITAL,category:"tile",description:"停留N回合"}}),this.register({id:"web3:chance",displayName:"机会",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.TRANSLUCENT,properties:{typeId:s.CHANCE,category:"tile",description:"触发随机事件"}}),this.register({id:"web3:bonus",displayName:"奖励",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.SOLID,properties:{typeId:s.BONUS,category:"tile",description:"获得金钱奖励"}}),this.register({id:"web3:fee",displayName:"费用",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.SOLID,properties:{typeId:s.FEE,category:"tile",description:"支付费用"}}),this.register({id:"web3:card",displayName:"卡片",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.SOLID,properties:{typeId:s.CARD,category:"tile",description:"获得随机卡片"}}),this.register({id:"web3:news",displayName:"新闻",isPlant:!1,isObstacle:!0,isDestructable:!1,lightLevel:0,hardness:1,renderType:c.TRANSLUCENT,properties:{typeId:s.NEWS,category:"tile",description:"触发全局新闻事件"}}),this.register({id:"web3:land_god",displayName:"土地神",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:r.LAND_GOD,category:"object",description:"增益型NPC"}}),this.register({id:"web3:wealth_god",displayName:"财神",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:r.WEALTH_GOD,category:"object",description:"增益型NPC"}}),this.register({id:"web3:fortune_god",displayName:"福神",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:r.FORTUNE_GOD,category:"object",description:"增益型NPC"}}),this.register({id:"web3:dog",displayName:"狗狗",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:r.DOG,category:"object",description:"干扰型NPC"}}),this.register({id:"web3:poverty_god",displayName:"穷神",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:r.POVERTY_GOD,category:"object",description:"干扰型NPC"}}),this.register({id:"web3:roadblock",displayName:"路障",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:r.ROADBLOCK,category:"object",description:"阻挡移动的路面物体"}}),this.register({id:"web3:bomb",displayName:"炸弹",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:r.BOMB,category:"object",description:"爆炸伤害的路面物体"}}),this.register({id:"web3:building_1x1",displayName:"小型建筑",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:1,renderType:c.TRANSLUCENT,properties:{typeId:a.BUILDING_1X1,category:"building",description:"1x1的基础建筑（lv0）",size:1}}),this.register({id:"web3:building_2x2",displayName:"大型建筑",isPlant:!1,isObstacle:!0,isDestructable:!0,lightLevel:0,hardness:1,renderType:c.TRANSLUCENT,properties:{typeId:a.BUILDING_2X2,category:"building",description:"2x2的基础建筑（lv0）",size:2}}),this.register({id:"web3:deco_dandelion",displayName:"蒲公英",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:l.DANDELION,category:"decoration",description:"装饰用蒲公英"}}),this.register({id:"web3:deco_poppy",displayName:"虞粟",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:l.POPPY,category:"decoration",description:"装饰用虞粟"}}),this.register({id:"web3:deco_short_grass",displayName:"矮草",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:l.SHORT_GRASS,category:"decoration",description:"装饰用矮草"}}),this.register({id:"web3:deco_fern",displayName:"蕨",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:0,hardness:0,renderType:c.CUTOUT,properties:{typeId:l.FERN,category:"decoration",description:"装饰用蕨"}}),this.register({id:"web3:deco_glow_lichen",displayName:"荧光地衣",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:7,hardness:0,renderType:c.CUTOUT,properties:{typeId:l.GLOW_LICHEN,category:"decoration",description:"装饰用荧光地衣，发光"}}),this.register({id:"web3:deco_glow_berries",displayName:"发光浆果",isPlant:!0,isObstacle:!1,isDestructable:!0,lightLevel:14,hardness:0,renderType:c.CUTOUT,properties:{typeId:l.GLOW_BERRIES,category:"decoration",description:"装饰用发光浆果，发光"}}),console.log("[Web3BlockTypes] 成功注册 27 个 Web3 方块")},e.createLegacyMapping=function(){this.legacyMapping.set(n.EMPTY,"minecraft:air"),this.legacyMapping.set(n.STONE,"minecraft:stone"),this.legacyMapping.set(n.DIRT,"minecraft:dirt"),this.legacyMapping.set(n.GRASS,"minecraft:grass_block"),this.legacyMapping.set(n.SAND,"minecraft:sand"),this.legacyMapping.set(n.COBBLE,"minecraft:cobblestone"),this.legacyMapping.set(n.WOOD,"minecraft:oak_log"),this.legacyMapping.set(n.PLANK,"minecraft:oak_planks"),this.legacyMapping.set(n.LEAVES,"minecraft:oak_leaves"),this.legacyMapping.set(n.GLASS,"minecraft:glass"),this.legacyMapping.set(n.YELLOW_FLOWER,"minecraft:dandelion"),this.legacyMapping.set(n.RED_FLOWER,"minecraft:poppy"),this.legacyMapping.set(n.TALL_GRASS,"minecraft:short_grass")},e.register=function(e){this.blockDefinitions.set(e.id,e),console.log("[BlockRegistry] 注册方块: "+e.id+" ("+e.displayName+")")},e.getBlock=function(e){return this.initialized||this.initialize(),this.blockDefinitions.get(e)},e.getAllBlockIds=function(){return this.initialized||this.initialize(),Array.from(this.blockDefinitions.keys())},e.fromLegacyType=function(e){return this.initialized||this.initialize(),this.legacyMapping.get(e)||"minecraft:air"},e.toLegacyType=function(e){this.initialized||this.initialize();for(var i,s=t(this.legacyMapping);!(i=s()).done;){var r=i.value,a=r[0];if(r[1]===e)return a}return n.EMPTY},e.exists=function(e){return this.initialized||this.initialize(),this.blockDefinitions.has(e)},e.isPlant=function(e){var t=this.getBlock(e);return!!t&&t.isPlant},e.isObstacle=function(e){var t=this.getBlock(e);return!!t&&t.isObstacle},e.isTransparent=function(e){var t=this.getBlock(e);return!t||t.renderType!==c.SOLID},e.isDestructable=function(e){var t=this.getBlock(e);return!!t&&t.isDestructable},e.getLightLevel=function(e){var t=this.getBlock(e);return t?t.lightLevel:0},e.getHardness=function(e){var t=this.getBlock(e);return t?t.hardness:0},e.getRenderType=function(e){var t=this.getBlock(e);return t?t.renderType:c.SOLID},e}());o.blockDefinitions=new Map,o.legacyMapping=new Map,o.initialized=!1;var d=e("VoxelBlockRegistry",function(){function e(){}return e.initialize=function(){this.ensureInitialized()},e.ensureInitialized=function(){this._initialized||(this.initializeBlocks(),this._initialized=!0)},e.initializeBlocks=function(){var e=this;this.blockProperties.set(n.EMPTY,{isPlant:!1,isObstacle:!1,isDestructable:!1,textureTop:0,textureBottom:0,textureSide:0,lightLevel:0}),this.blockProperties.set(n.GRASS,{isPlant:!1,isObstacle:!0,isDestructable:!0,textureTop:0,textureBottom:2,textureSide:1,lightLevel:0}),this.blockProperties.set(n.SAND,{isPlant:!1,isObstacle:!0,isDestructable:!0,textureTop:18,textureBottom:18,textureSide:18,lightLevel:0}),this.blockProperties.set(n.STONE,{isPlant:!1,isObstacle:!0,isDestructable:!0,textureTop:32,textureBottom:32,textureSide:32,lightLevel:0}),this.blockProperties.set(n.WOOD,{isPlant:!1,isObstacle:!0,isDestructable:!0,textureTop:21,textureBottom:21,textureSide:20,lightLevel:0}),this.blockProperties.set(n.LEAVES,{isPlant:!1,isObstacle:!0,isDestructable:!0,textureTop:22,textureBottom:22,textureSide:22,lightLevel:0}),this.blockProperties.set(n.GLASS,{isPlant:!1,isObstacle:!0,isDestructable:!0,textureTop:49,textureBottom:49,textureSide:49,lightLevel:0}),this.blockProperties.set(n.CLOUD,{isPlant:!1,isObstacle:!1,isDestructable:!1,textureTop:14,textureBottom:14,textureSide:14,lightLevel:0}),this.blockProperties.set(n.LIGHT_STONE,{isPlant:!1,isObstacle:!0,isDestructable:!0,textureTop:35,textureBottom:35,textureSide:35,lightLevel:10}),this.plants.forEach((function(t){e.blockProperties.set(t,{isPlant:!0,isObstacle:!1,isDestructable:!0,textureTop:t,textureBottom:t,textureSide:t,lightLevel:0})}))},e.isPlant=function(e){this.ensureInitialized();var t=this.blockProperties.get(e);return!!t&&t.isPlant},e.isObstacle=function(e){this.ensureInitialized();var t=this.blockProperties.get(e);return!!t&&t.isObstacle},e.isTransparent=function(e){return this.ensureInitialized(),e===n.GLASS||e===n.LEAVES},e.isDestructable=function(e){this.ensureInitialized();var t=this.blockProperties.get(e);return!!t&&t.isDestructable},e.getTextureIndex=function(e,t){this.ensureInitialized();var i=this.blockProperties.get(e);if(!i)return 0;switch(t){case 0:return i.textureTop;case 1:return i.textureBottom;default:return i.textureSide}},e.getLightLevel=function(e){this.ensureInitialized();var t=this.blockProperties.get(e);return t?t.lightLevel:0},e.getItems=function(){return this.ensureInitialized(),[].concat(this.items)},e.getItemCount=function(){return this.ensureInitialized(),this.items.length},e.isValidBlockType=function(e){return this.ensureInitialized(),this.blockProperties.has(e)},e.getBlockProperties=function(e){return this.ensureInitialized(),this.blockProperties.get(e)},e.registerCustomBlock=function(e,t){this.ensureInitialized(),this.blockProperties.set(e,t)},e}());d.blockProperties=new Map,d._initialized=!1,d.items=[n.GRASS,n.SAND,n.STONE,n.BRICK,n.WOOD,n.CEMENT,n.DIRT,n.PLANK,n.SNOW,n.GLASS,n.COBBLE,n.LIGHT_STONE,n.DARK_STONE,n.CHEST,n.LEAVES],d.plants=new Set([n.TALL_GRASS,n.YELLOW_FLOWER,n.RED_FLOWER,n.PURPLE_FLOWER,n.SUN_FLOWER,n.WHITE_FLOWER,n.BLUE_FLOWER]),o.initialize(),d.initialize(),i._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelBlockCatalog.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelBlockRegistry.ts"],(function(t){var e,r,o,s,a;return{setters:[function(t){e=t.createForOfIteratorHelperLoose,r=t.extends},function(t){o=t.cclegacy},function(t){s=t.BlockCategory,a=t.BlockRegistry}],execute:function(){t({getBlockCategories:function(){return n.getCategories()},getFavoriteBlocks:function(){return n.getFavoriteBlocks()},getRecentBlocks:function(){return n.getRecentlyUsedBlocks()},recordBlockUsage:function(t){n.recordBlockUsage(t)},searchBlocks:function(t){return n.searchBlocks(t)}}),o._RF.push({},"ba2e0Qr0m1D9ok9GbAUwm1p","VoxelBlockCatalog",void 0);var i=t("VoxelBlockCatalog",function(){function t(t){this.registry=void 0,this.usageStats=new Map,this.favorites=new Set,this.recentlyUsed=[],this.maxRecentItems=20,this.categoryConfig=new Map,this.registry=t||a,this.initializeCategoryConfig(),this.loadUserData()}var o=t.prototype;return o.initializeCategoryConfig=function(){this.categoryConfig.set(s.BUILDING,{displayName:"建筑材料",description:"用于建造结构的方块",icon:"ui/icons/category_building.png",sortOrder:1}),this.categoryConfig.set(s.NATURAL,{displayName:"天然方块",description:"自然生成的方块",icon:"ui/icons/category_natural.png",sortOrder:2}),this.categoryConfig.set(s.DECORATION,{displayName:"装饰方块",description:"装饰用的方块和植物",icon:"ui/icons/category_decoration.png",sortOrder:3}),this.categoryConfig.set(s.REDSTONE,{displayName:"红石电路",description:"红石和机械装置",icon:"ui/icons/category_redstone.png",sortOrder:4}),this.categoryConfig.set(s.TRANSPORTATION,{displayName:"交通运输",description:"铁路和交通相关方块",icon:"ui/icons/category_transport.png",sortOrder:5}),this.categoryConfig.set(s.MISCELLANEOUS,{displayName:"杂项",description:"其他类型的方块",icon:"ui/icons/category_misc.png",sortOrder:99}),this.categoryConfig.set(s.LIQUID,{displayName:"流体",description:"液体方块",icon:"ui/icons/category_liquid.png",sortOrder:6})},o.getAllBlocks=function(){var t=this;return this.registry.getAllBlocks().map((function(e){return t.createCatalogItem(e)}))},o.getBlocksByCategory=function(t){var e=this;return this.registry.getBlocksByCategory(t).map((function(t){return e.createCatalogItem(t)}))},o.searchBlocks=function(t){var e=this.getAllBlocks();if(t.query&&t.query.trim()){var r=t.query.toLowerCase();e=e.filter((function(t){return t.displayName.toLowerCase().includes(r)||t.id.toLowerCase().includes(r)||t.tags.some((function(t){return t.toLowerCase().includes(r)}))||t.description&&t.description.toLowerCase().includes(r)}))}return t.category&&(e=e.filter((function(e){return e.category===t.category}))),t.tags&&t.tags.length>0&&(e=e.filter((function(e){return t.tags.some((function(t){return e.tags.includes(t)}))}))),void 0!==t.available&&(e=e.filter((function(e){return e.available===t.available}))),void 0!==t.unlocked&&(e=e.filter((function(e){return e.unlocked===t.unlocked}))),this.sortBlocks(e,t.sortBy||"name"),t.limit&&t.limit>0&&(e=e.slice(0,t.limit)),e},o.getCategories=function(){for(var t,r=[],o=e(this.categoryConfig);!(t=o()).done;){var s=t.value,a=s[0],i=s[1],n=this.getBlocksByCategory(a);n.length>0&&r.push({category:a,displayName:i.displayName,description:i.description,icon:i.icon,blocks:n,sortOrder:i.sortOrder})}return r.sort((function(t,e){return t.sortOrder-e.sortOrder})),r},o.getFavoriteBlocks=function(){for(var t=[],e=0,r=Array.from(this.favorites);e<r.length;e++){var o=r[e],s=this.registry.getBlock(o);s&&t.push(this.createCatalogItem(s,!0))}return t},o.getRecentlyUsedBlocks=function(){for(var t,r=[],o=e(this.recentlyUsed);!(t=o()).done;){var s=t.value,a=this.registry.getBlock(s);a&&r.push(this.createCatalogItem(a))}return r},o.getPopularBlocks=function(t){void 0===t&&(t=10);for(var r,o=Array.from(this.usageStats.values()).sort((function(t,e){return e.usageCount-t.usageCount})).slice(0,t),s=[],a=e(o);!(r=a()).done;){var i=r.value,n=this.registry.getBlock(i.blockId);n&&s.push(this.createCatalogItem(n))}return s},o.recordBlockUsage=function(t){var e=this.usageStats.get(t)||{blockId:t,usageCount:0,lastUsed:0,isFavorite:this.favorites.has(t)};e.usageCount++,e.lastUsed=Date.now(),this.usageStats.set(t,e);var r=this.recentlyUsed.indexOf(t);r>=0&&this.recentlyUsed.splice(r,1),this.recentlyUsed.unshift(t),this.recentlyUsed.length>this.maxRecentItems&&(this.recentlyUsed=this.recentlyUsed.slice(0,this.maxRecentItems)),this.saveUserData()},o.addToFavorites=function(t){if(!this.registry.exists(t))return!1;this.favorites.add(t);var e=this.usageStats.get(t);return e&&(e.isFavorite=!0),this.saveUserData(),!0},o.removeFromFavorites=function(t){var e=this.favorites.delete(t),r=this.usageStats.get(t);return r&&(r.isFavorite=!1),e&&this.saveUserData(),e},o.isFavorite=function(t){return this.favorites.has(t)},o.getBlockStats=function(t){return this.usageStats.get(t)||null},o.createCatalogItem=function(t,e){this.usageStats.get(t.id);return r({},t,{icon:this.registry.getBlockIcon(t.id),description:this.getBlockDescription(t.id),tags:this.getBlockTags(t.id),available:this.isBlockAvailable(t.id),unlocked:this.isBlockUnlocked(t.id)})},o.getBlockDescription=function(t){return{"minecraft:stone":"最基础的建筑材料，坚固耐用。","minecraft:dirt":"种植植物的基础土壤。","minecraft:grass_block":"长满青草的土块，适合建造自然景观。","minecraft:sand":"可以受重力影响下落的方块。","minecraft:cobblestone":"石头的粗糙版本，常用于建筑。","minecraft:oak_log":"橡木原木，可以制作木板。","minecraft:oak_planks":"处理过的木材，建筑的好材料。","minecraft:glass":"透明的建筑材料，可以制作窗户。","minecraft:glowstone":"发光的方块，可以照亮周围。"}[t]||""},o.getBlockTags=function(t){return{"minecraft:stone":["建筑","基础","坚固"],"minecraft:dirt":["自然","种植","土壤"],"minecraft:grass_block":["自然","草地","绿色"],"minecraft:sand":["自然","重力","黄色"],"minecraft:cobblestone":["建筑","石头","粗糙"],"minecraft:oak_log":["木材","自然","原木"],"minecraft:oak_planks":["建筑","木材","处理"],"minecraft:glass":["透明","建筑","玻璃"],"minecraft:glowstone":["光源","发光","照明"],"minecraft:dandelion":["植物","花朵","装饰"],"minecraft:poppy":["植物","花朵","红色"],"minecraft:short_grass":["植物","草","装饰"]}[t]||[]},o.isBlockAvailable=function(t){return!0},o.isBlockUnlocked=function(t){return!0},o.sortBlocks=function(t,e){var r=this;switch(e){case"name":t.sort((function(t,e){return t.displayName.localeCompare(e.displayName)}));break;case"category":t.sort((function(t,e){var o=r.categoryConfig.get(t.category),s=r.categoryConfig.get(e.category),a=o?o.sortOrder:999,i=s?s.sortOrder:999;return a!==i?a-i:t.displayName.localeCompare(e.displayName)}));break;case"recent":t.sort((function(t,e){var o=r.recentlyUsed.indexOf(t.id),s=r.recentlyUsed.indexOf(e.id);return-1===o&&-1===s?0:-1===o?1:-1===s?-1:o-s}));break;case"popular":t.sort((function(t,e){var o=r.usageStats.get(t.id),s=r.usageStats.get(e.id),a=o?o.usageCount:0;return(s?s.usageCount:0)-a}))}},o.loadUserData=function(){try{var t=localStorage.getItem("voxel-block-catalog-data");if(t){var e=JSON.parse(t);e.favorites&&(this.favorites=new Set(e.favorites)),e.recentlyUsed&&(this.recentlyUsed=e.recentlyUsed),e.usageStats&&(this.usageStats=new Map(Object.entries(e.usageStats)))}}catch(t){console.warn("[VoxelBlockCatalog] 加载用户数据失败:",t)}},o.saveUserData=function(){try{var t={favorites:Array.from(this.favorites),recentlyUsed:this.recentlyUsed,usageStats:Object.fromEntries(this.usageStats)};localStorage.setItem("voxel-block-catalog-data",JSON.stringify(t))}catch(t){console.warn("[VoxelBlockCatalog] 保存用户数据失败:",t)}},o.clearUserData=function(){this.favorites.clear(),this.recentlyUsed=[],this.usageStats.clear();try{localStorage.removeItem("voxel-block-catalog-data")}catch(t){console.warn("[VoxelBlockCatalog] 清除用户数据失败:",t)}},o.getCatalogStats=function(){var t=this.getCategories();return{totalBlocks:this.getAllBlocks().length,totalCategories:t.length,favoriteCount:this.favorites.size,recentCount:this.recentlyUsed.length,categoryStats:t.map((function(t){return{category:t.category,displayName:t.displayName,blockCount:t.blocks.length}}))}},t}()),n=t("BlockCatalog",new i);o._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelBlockRegistry.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){r=e.cclegacy}],execute:function(){e({blockExists:function(e){return n.exists(e)},getAllBlocks:function(){return n.getAllBlocks()},getBlock:function(e){return n.getBlock(e)},getBlocksByCategory:function(e){return n.getBlocksByCategory(e)}}),r._RF.push({},"697323/fLhHxImqO6oT/eDh","VoxelBlockRegistry",void 0);var i=e("BlockCategory",function(e){return e.BUILDING="building",e.NATURAL="natural",e.DECORATION="decoration",e.REDSTONE="redstone",e.TRANSPORTATION="transportation",e.MISCELLANEOUS="miscellaneous",e.LIQUID="liquid",e}({})),a=e("BlockRenderType",function(e){return e.CUBE="cube",e.CROSS="cross",e.TRANSPARENT="transparent",e.CUTOUT="cutout",e.LIQUID="liquid",e.EMISSIVE="emissive",e}({})),s=e("VoxelBlockRegistry",function(){function e(){this.blocks=new Map,this.idToString=[],this.stringToId=new Map,this.globalIdCounter=0,this.initialized=!1}e.getInstance=function(){return e.instance||(e.instance=new e),e.instance};var r=e.prototype;return r.initialize=function(){this.initialized||(console.log("[VoxelBlockRegistry] 初始化现代方块注册表..."),this.registerBuiltinBlocks(),this.initialized=!0,console.log("[VoxelBlockRegistry] 初始化完成，注册了 "+this.blocks.size+" 个方块"))},r.registerBuiltinBlocks=function(){this.register({id:"minecraft:air",displayName:"空气",category:i.MISCELLANEOUS,renderType:a.CUBE,properties:{hardness:0,transparent:!0,luminance:0,flammable:!1,solid:!1,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/air"}}),this.register({id:"minecraft:stone",displayName:"石头",category:i.BUILDING,renderType:a.CUBE,properties:{hardness:1.5,transparent:!1,luminance:0,flammable:!1,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/stone"}}),this.register({id:"minecraft:dirt",displayName:"泥土",category:i.NATURAL,renderType:a.CUBE,properties:{hardness:.5,transparent:!1,luminance:0,flammable:!1,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/dirt"}}),this.register({id:"minecraft:grass_block",displayName:"草方块",category:i.NATURAL,renderType:a.CUBE,properties:{hardness:.6,transparent:!1,luminance:0,flammable:!1,solid:!0,waterlogged:!1,gravity:!1},textures:{top:"minecraft:block/grass_block_top",bottom:"minecraft:block/dirt",side:"minecraft:block/grass_block_side"}}),this.register({id:"minecraft:sand",displayName:"沙子",category:i.NATURAL,renderType:a.CUBE,properties:{hardness:.5,transparent:!1,luminance:0,flammable:!1,solid:!0,waterlogged:!1,gravity:!0},textures:{all:"minecraft:block/sand"}}),this.register({id:"minecraft:cobblestone",displayName:"鹅卵石",category:i.BUILDING,renderType:a.CUBE,properties:{hardness:2,transparent:!1,luminance:0,flammable:!1,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/cobblestone"}}),this.register({id:"minecraft:oak_log",displayName:"橡木原木",category:i.NATURAL,renderType:a.CUBE,properties:{hardness:2,transparent:!1,luminance:0,flammable:!0,solid:!0,waterlogged:!1,gravity:!1},textures:{top:"minecraft:block/oak_log_top",bottom:"minecraft:block/oak_log_top",side:"minecraft:block/oak_log"}}),this.register({id:"minecraft:oak_planks",displayName:"橡木木板",category:i.BUILDING,renderType:a.CUBE,properties:{hardness:2,transparent:!1,luminance:0,flammable:!0,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/oak_planks"}}),this.register({id:"minecraft:oak_leaves",displayName:"橡木叶子",category:i.DECORATION,renderType:a.CUTOUT,properties:{hardness:.2,transparent:!0,luminance:0,flammable:!0,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/oak_leaves"}}),this.register({id:"minecraft:glass",displayName:"玻璃",category:i.BUILDING,renderType:a.TRANSPARENT,properties:{hardness:.3,transparent:!0,luminance:0,flammable:!1,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/glass"}}),this.register({id:"minecraft:dandelion",displayName:"蒲公英",category:i.DECORATION,renderType:a.CROSS,properties:{hardness:0,transparent:!0,luminance:0,flammable:!0,solid:!1,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/dandelion"}}),this.register({id:"minecraft:poppy",displayName:"虞粟",category:i.DECORATION,renderType:a.CROSS,properties:{hardness:0,transparent:!0,luminance:0,flammable:!0,solid:!1,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/poppy"}}),this.register({id:"minecraft:short_grass",displayName:"矮草",category:i.DECORATION,renderType:a.CROSS,properties:{hardness:0,transparent:!0,luminance:0,flammable:!0,solid:!1,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/short_grass"}}),this.register({id:"minecraft:glowstone",displayName:"萤石",category:i.BUILDING,renderType:a.EMISSIVE,properties:{hardness:.3,transparent:!1,luminance:15,flammable:!1,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/glowstone"}}),this.register({id:"minecraft:bedrock",displayName:"基岩",category:i.BUILDING,renderType:a.CUBE,properties:{hardness:-1,transparent:!1,luminance:0,flammable:!1,solid:!0,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/bedrock"}}),this.register({id:"minecraft:water",displayName:"水",category:i.LIQUID,renderType:a.LIQUID,properties:{hardness:100,transparent:!0,luminance:0,flammable:!1,solid:!1,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/water_still"}}),this.register({id:"minecraft:torch",displayName:"火把",category:i.DECORATION,renderType:a.CROSS,properties:{hardness:0,transparent:!0,luminance:14,flammable:!1,solid:!1,waterlogged:!1,gravity:!1},textures:{all:"minecraft:block/torch"}})},r.register=function(e){if(this.blocks.has(e.id))return console.warn("[VoxelBlockRegistry] 方块已存在: "+e.id),this.stringToId.get(e.id);var t=this.globalIdCounter++;return this.blocks.set(e.id,e),this.idToString[t]=e.id,this.stringToId.set(e.id,t),console.log("[VoxelBlockRegistry] 注册方块: "+e.id+" -> globalId:"+t),t},r.getBlock=function(e){return this.initialized||this.initialize(),this.blocks.get(e)||null},r.exists=function(e){return this.initialized||this.initialize(),this.blocks.has(e)},r.getAllBlockIds=function(){return this.initialized||this.initialize(),Array.from(this.blocks.keys())},r.getAllBlocks=function(){this.initialized||this.initialize();for(var e,r=[],i=t(this.blocks);!(e=i()).done;){var a=e.value,s=a[0],n=a[1];r.push({id:s,displayName:n.displayName,category:n.category,icon:this.getBlockIcon(s),properties:n.properties})}return r},r.getBlocksByCategory=function(e){return this.getAllBlocks().filter((function(t){return t.category===e}))},r.searchBlocks=function(e){var t=e.toLowerCase();return this.getAllBlocks().filter((function(e){return e.displayName.toLowerCase().includes(t)||e.id.toLowerCase().includes(t)}))},r.getBlockIcon=function(e){var t=this.getBlock(e);return t?t.textures.all||t.textures.top||t.textures.side||"minecraft:block/missing_texture":""},r.getBlockIdByGlobalId=function(e){return this.idToString[e]||"minecraft:air"},r.getGlobalIdByBlockId=function(e){return this.stringToId.get(e)||0},r.getStats=function(){return{totalBlocks:this.blocks.size,categories:this.getCategoryCounts(),renderTypes:this.getRenderTypeCounts()}},r.getCategoryCounts=function(){for(var e,r={},i=t(this.blocks.values());!(e=i()).done;){var a=e.value;r[a.category]=(r[a.category]||0)+1}return r},r.getRenderTypeCounts=function(){for(var e,r={},i=t(this.blocks.values());!(e=i()).done;){var a=e.value;r[a.renderType]=(r[a.renderType]||0)+1}return r},r.clear=function(){this.blocks.clear(),this.idToString=[],this.stringToId.clear(),this.globalIdCounter=0,this.initialized=!1},e}());s.instance=null;var n=e("BlockRegistry",s.getInstance());n.initialize(),r._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelCameraConfig.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var i,n,l;return{setters:[function(e){i=e.extends},function(e){n=e.cclegacy,l=e.Vec3}],execute:function(){n._RF.push({},"6c771WRmH1PTbrrbsfrMFxM","VoxelCameraConfig",void 0);e("VoxelCameraMode",function(e){return e.WALKING="walking",e.FLYING="flying",e}({}));var o=e("DEFAULT_VOXEL_CAMERA_CONFIG",{movement:{walkSpeed:5,flySpeed:20,jumpForce:8,gravity:-20,friction:.9,maxFallSpeed:-30},view:{mouseSensitivity:.1,maxPitchAngle:80,minPitchAngle:-80,fieldOfView:75,viewSmoothing:.1},collision:{enableCollision:!0,collisionBoxSize:new l(.8,1.8,.8),collisionSteps:4,stepHeight:.5,enableWallSliding:!0},input:{enableKeyboardInput:!0,enableMouseInput:!0,invertMouseY:!1,modeToggleKey:"KeyF",jumpKey:"Space",sprintKey:"ShiftLeft"},debugMode:!1});e("VOXEL_CAMERA_PRESETS",{MINECRAFT:i({},o,{movement:{walkSpeed:4.3,flySpeed:15,jumpForce:7.5,gravity:-18,friction:.91,maxFallSpeed:-28}}),FAST:i({},o,{movement:{walkSpeed:8,flySpeed:30,jumpForce:10,gravity:-15,friction:.95,maxFallSpeed:-35}}),PRECISE:i({},o,{movement:{walkSpeed:2,flySpeed:8,jumpForce:6,gravity:-22,friction:.8,maxFallSpeed:-25},view:{mouseSensitivity:.05,maxPitchAngle:90,minPitchAngle:-90,fieldOfView:70,viewSmoothing:.2}})});n._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelCameraController.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelCollisionSystem.ts","./BaseCameraController.ts","./VoxelCameraConfig.ts"],(function(e){var t,o,i,n,s,r,a,l,c,u,h,d,g,f;return{setters:[function(e){t=e.applyDecoratedDescriptor,o=e.inheritsLoose,i=e.initializerDefineProperty,n=e.assertThisInitialized},function(e){s=e.cclegacy,r=e._decorator,a=e.Vec3,l=e.KeyCode,c=e.Quat,u=e.EventMouse},function(e){h=e.VoxelCollisionSystem},function(e){d=e.BaseCameraController},function(e){g=e.VoxelCameraMode,f=e.DEFAULT_VOXEL_CAMERA_CONFIG}],execute:function(){var _,m,y,p,C,v,M;s._RF.push({},"8e74ei2NFVKnr0KVgT8GApQ","VoxelCameraController",void 0);var w=r.ccclass,L=r.property;e("VoxelCameraController",(_=w("VoxelCameraController"),m=L({displayName:"体素相机配置",tooltip:"体素相机的配置参数"}),y=L({type:h,displayName:"碰撞系统",tooltip:"体素碰撞检测系统"}),_((v=t((C=function(e){function t(){for(var t,o=arguments.length,s=new Array(o),r=0;r<o;r++)s[r]=arguments[r];return t=e.call.apply(e,[this].concat(s))||this,i(t,"config",v,n(t)),i(t,"collisionSystem",M,n(t)),t._currentMode=g.WALKING,t._yaw=0,t._pitch=0,t._velocity=new a,t._getBlockAt=null,t}o(t,e);var s=t.prototype;return s.onCameraStart=function(){this.debugLog("体素相机启动，默认模式: "+this._currentMode)},s.onCameraEnable=function(){this.debugLog("体素相机已启用")},s.onCameraDisable=function(){this.debugLog("体素相机已禁用")},s.onCameraUpdate=function(e){this._handleMovement(e),this.updateCameraRotation()},s.onCameraDestroy=function(){this.debugLog("体素相机已销毁")},s.onResetToDefault=function(){this._currentMode=g.WALKING,this._yaw=0,this._pitch=0,this._velocity.set(0,0,0),this.debugLog("体素相机已重置为默认状态")},s.setBlockQueryFunction=function(e){this._getBlockAt=e},s.toggleMode=function(){this._currentMode=this._currentMode===g.WALKING?g.FLYING:g.WALKING,this.debugLog("切换体素相机模式: "+this._currentMode)},s.setMode=function(e){this._currentMode!==e&&(this._currentMode=e,this.debugLog("设置体素相机模式: "+e))},s.getCurrentMode=function(){return this._currentMode},s._handleMovement=function(e){var t=this._currentMode===g.FLYING?this.config.movement.flySpeed:this.config.movement.walkSpeed,o=new a(0,0,0),i=this.getCameraForward(),n=this.getCameraRight(),s=new a(0,1,0);if(this.isKeyPressed(l.KEY_W))if(this._currentMode===g.FLYING)o.add(i);else{var r=new a(i.x,0,i.z).normalize();o.add(r)}if(this.isKeyPressed(l.KEY_S))if(this._currentMode===g.FLYING)o.subtract(i);else{var c=new a(i.x,0,i.z).normalize();o.subtract(c)}if(this.isKeyPressed(l.KEY_A)&&o.subtract(n),this.isKeyPressed(l.KEY_D)&&o.add(n),this._currentMode===g.FLYING&&(this.isKeyPressed(l.SPACE)&&o.add(s),this.isKeyPressed(l.SHIFT_LEFT)&&o.subtract(s)),o.length()>0){o.normalize();var u=o.multiplyScalar(t*e);this._moveWithCollision(u)}},s._moveWithCollision=function(e){var t=this.node.getWorldPosition(),o=t.clone().add(e);if(this._currentMode===g.WALKING&&this.collisionSystem&&this._getBlockAt)if(this.collisionSystem.checkCollision(o,this._getBlockAt)){var i=this._trySeparateAxisMovement(t,e);i&&this.node.setWorldPosition(i)}else this.node.setWorldPosition(o);else this.node.setWorldPosition(o)},s._trySeparateAxisMovement=function(e,t){for(var o=[new a(t.x,0,0),new a(0,t.y,0),new a(0,0,t.z)],i=e.clone(),n=0,s=o;n<s.length;n++){var r=s[n];if(r.length()>0){var l=i.clone().add(r);this.collisionSystem.checkCollision(l,this._getBlockAt)||i.add(r)}}return i.equals(e)?null:i},s.getCameraForward=function(){var e=this.node.getRotation(),t=new a(0,0,-1);return a.transformQuat(t,t,e),t},s.getCameraRight=function(){var e=this.node.getRotation(),t=new a(1,0,0);return a.transformQuat(t,t,e),t},s.updateCameraRotation=function(){var e=c.fromAxisAngle(new c,new a(0,1,0),this._yaw*Math.PI/180),t=c.fromAxisAngle(new c,new a(1,0,0),this._pitch*Math.PI/180),o=e.clone();c.multiply(o,o,t),this.node.setRotation(o)},s.onKeyDown=function(e){this._keyStates.set(e.keyCode,!0),e.keyCode===l.KEY_F&&this.toggleMode()},s.onKeyUp=function(e){this._keyStates.set(e.keyCode,!1)},s.onMouseDown=function(e){e.getButton()===u.BUTTON_LEFT&&(this._mouseDown=!0,this._lastMousePosition=new a(e.getLocationX(),e.getLocationY(),0))},s.onMouseUp=function(e){e.getButton()===u.BUTTON_LEFT&&(this._mouseDown=!1)},s.onMouseMove=function(e){if(this._mouseDown){var t=new a(e.getLocationX(),e.getLocationY(),0),o=t.subtract(this._lastMousePosition);this._yaw-=o.x*this.config.view.mouseSensitivity,this._pitch+=o.y*this.config.view.mouseSensitivity,this._pitch=Math.max(this.config.view.minPitchAngle,Math.min(this.config.view.maxPitchAngle,this._pitch)),this._lastMousePosition=t}},t}(d)).prototype,"config",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f}}),M=t(C.prototype,"collisionSystem",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),p=C))||p));s._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelChunk.ts",["cc","./VoxelMap.ts","./VoxelConfig.ts"],(function(n){var t,u,r;return{setters:[function(n){t=n.cclegacy},function(n){u=n.VoxelMapUtils},function(n){r=n.VoxelConfig}],execute:function(){t._RF.push({},"c8238XVr7xICJYffg/y3JV4","VoxelChunk",void 0);n("VoxelChunkManager",function(){function n(){}return n.createChunk=function(n,t){var o=r.CHUNK_SIZE,e=o-1;return{map:u.allocMap(n*o,0,t*o,e),lights:u.allocMap(n*o,0,t*o,e),p:n,q:t,faces:0,dirty:!0,miny:r.MAX_HEIGHT,maxy:0,node:null}},n.freeChunk=function(n){u.freeMap(n.map),u.freeMap(n.lights),n.node&&(n.node.destroy(),n.node=null),n.faces=0,n.dirty=!1,n.miny=r.MAX_HEIGHT,n.maxy=0},n.copyChunk=function(n,t){u.copyMap(n.map,t.map),u.copyMap(n.lights,t.lights),n.p=t.p,n.q=t.q,n.faces=t.faces,n.dirty=t.dirty,n.miny=t.miny,n.maxy=t.maxy},n.getChunkBlock=function(n,t,r,o){return u.getMap(n.map,t,r,o)},n.setChunkBlock=function(n,t,r,o,e){var i=u.setMap(n.map,t,r,o,e);return i&&(n.dirty=!0,e>0?(n.miny=Math.min(n.miny,r),n.maxy=Math.max(n.maxy,r)):this.updateChunkBounds(n)),i},n.getChunkLight=function(n,t,r,o){return u.getMap(n.lights,t,r,o)},n.setChunkLight=function(n,t,r,o,e){var i=u.setMap(n.lights,t,r,o,e);return i&&(n.dirty=!0),i},n.updateChunkBounds=function(n){var t=r.MAX_HEIGHT,o=0;u.forEachEntry(n.map,(function(n,u,r,e){e>0&&(t=Math.min(t,u),o=Math.max(o,u))})),n.miny=t,n.maxy=o},n.isChunkEmpty=function(n){return u.isEmpty(n.map)},n.getChunkSize=function(n){return u.getSize(n.map)},n.markChunkDirty=function(n){n.dirty=!0},n.isChunkDirty=function(n){return n.dirty},n.clearChunkDirtyFlag=function(n){n.dirty=!1},n.getChunkBounds=function(n){return u.getBounds(n.map)},n.getChunkWorldPosition=function(n){return{x:n.p*r.CHUNK_SIZE,z:n.q*r.CHUNK_SIZE}},n.getChunkCoords=function(n,t){return{p:Math.floor(n/r.CHUNK_SIZE),q:Math.floor(t/r.CHUNK_SIZE)}},n.getLocalCoords=function(n,t,u){var o=r.CHUNK_SIZE;return{x:(n%o+o)%o,y:t,z:(u%o+o)%o}},n.getWorldCoords=function(n,t,u,o){return{x:n.p*r.CHUNK_SIZE+t,y:u,z:n.q*r.CHUNK_SIZE+o}},n.isValidChunkCoord=function(n){var t=r.CHUNK_SIZE;return n>=0&&n<t},n.forEachBlock=function(n,t){u.forEachEntry(n.map,t)},n.getAdjacentChunkCoords=function(n,t){return[{p:n-1,q:t-1},{p:n,q:t-1},{p:n+1,q:t-1},{p:n-1,q:t},{p:n,q:t},{p:n+1,q:t},{p:n-1,q:t+1},{p:n,q:t+1},{p:n+1,q:t+1}]},n.getNeighborChunkCoords=function(n,t){return[{p:n-1,q:t},{p:n+1,q:t},{p:n,q:t-1},{p:n,q:t+1}]},n.calculateChunkDistance=function(n,t,u,r){var o=n-u,e=t-r;return Math.sqrt(o*o+e*e)},n.isChunkInRadius=function(n,t,u,r,o){return this.calculateChunkDistance(n,t,u,r)<=o},n}());t._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelChunkStorage.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelPalette.ts","./VoxelConfig.ts"],(function(t){var e,r,i,o,a;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){r=t.cclegacy},function(t){i=t.ChunkPalette,o=t.PaletteManager},function(t){a=t.VoxelConfig}],execute:function(){var n;r._RF.push({},"3ae90uen3BEOIaHugfgKAiu","VoxelChunkStorage",void 0);var s=t("VoxelChunkStorage",function(){function t(){}return t.createChunk=function(t,e){var r=new i,a={p:t,q:e,palette:r,blocks:r.createStorageArray(this.BLOCKS_PER_CHUNK),lights:new Uint8Array(this.BLOCKS_PER_CHUNK),dirty:!0,meshDirty:!0,faces:0,minY:this.MAX_HEIGHT,maxY:0,blockCount:0,lastAccessTime:Date.now(),isEmpty:!0,isFull:!1,isUniform:!0,uniformBlockId:"minecraft:air"};return this.fillChunk(a,"minecraft:air"),o.registerPalette(r),a},t.freeChunk=function(t){o.unregisterPalette(t.palette),t.node&&(t.node.destroy(),t.node=null),t.blocks=null,t.lights=null,t.palette=null},t.getChunkIndex=function(t,e,r){var i=t&this.CHUNK_SIZE-1,o=r&this.CHUNK_SIZE-1;return Math.max(0,Math.min(e,this.MAX_HEIGHT-1))*(this.CHUNK_SIZE*this.CHUNK_SIZE)+o*this.CHUNK_SIZE+i},t.getChunkCoords=function(t,e){return{p:Math.floor(t/this.CHUNK_SIZE),q:Math.floor(e/this.CHUNK_SIZE)}},t.setBlock=function(t,e,r,i,o){if(r<0||r>=this.MAX_HEIGHT)return!1;var a=this.getChunkIndex(e,r,i),n=t.palette.readFromStorage(t.blocks,a),s=t.palette.getBlockId(n);if(s===o)return!1;var l=t.palette.getOrAddIndex(o),c=t.palette.getStorageType();return this.needStorageUpgrade(t,c)&&this.upgradeStorage(t,c),t.palette.writeToStorage(t.blocks,a,l),this.updateChunkStats(t,s,o,r),t.dirty=!0,t.meshDirty=!0,t.lastAccessTime=Date.now(),!0},t.getBlock=function(t,e,r,i){if(r<0||r>=this.MAX_HEIGHT)return"minecraft:air";if(t.lastAccessTime=Date.now(),t.isUniform&&t.uniformBlockId)return t.uniformBlockId;var o=this.getChunkIndex(e,r,i),a=t.palette.readFromStorage(t.blocks,o);return t.palette.getBlockId(a)},t.fillChunk=function(t,e){var r=t.palette.getOrAddIndex(e);t.isUniform=!0,t.uniformBlockId=e,t.isEmpty="minecraft:air"===e,t.isFull="minecraft:air"!==e;for(var i=0;i<this.BLOCKS_PER_CHUNK;i++)t.palette.writeToStorage(t.blocks,i,r);"minecraft:air"===e?(t.blockCount=0,t.minY=this.MAX_HEIGHT,t.maxY=0):(t.blockCount=this.BLOCKS_PER_CHUNK,t.minY=0,t.maxY=this.MAX_HEIGHT-1),t.dirty=!0,t.meshDirty=!0},t.setBlocks=function(t,r,i){var o=t.palette.getOrAddIndex(i),a=t.palette.getStorageType();this.needStorageUpgrade(t,a)&&this.upgradeStorage(t,a);for(var n,s=!1,l=e(r);!(n=l()).done;){var c=n.value;if(c.y>=0&&c.y<this.MAX_HEIGHT){var u=this.getChunkIndex(c.x,c.y,c.z),h=t.palette.readFromStorage(t.blocks,u);if(h!==o){t.palette.writeToStorage(t.blocks,u,o);var m=t.palette.getBlockId(h);this.updateChunkStats(t,m,i,c.y),s=!0}}}s&&(t.dirty=!0,t.meshDirty=!0,t.lastAccessTime=Date.now())},t.setLight=function(t,e,r,i,o){if(!(r<0||r>=this.MAX_HEIGHT)){var a=this.getChunkIndex(e,r,i);t.lights[a]=Math.max(0,Math.min(255,o)),t.dirty=!0}},t.getLight=function(t,e,r,i){if(r<0||r>=this.MAX_HEIGHT)return 0;var o=this.getChunkIndex(e,r,i);return t.lights[o]},t.needStorageUpgrade=function(t,e){var r=t.blocks.constructor.name;return"uint16"===e&&"Uint16Array"!==r||"uint8"===e&&"Uint8Array"===r&&t.palette.size()>16},t.upgradeStorage=function(t,e){var r=t.blocks;t.blocks=t.palette.createStorageArray(this.BLOCKS_PER_CHUNK);for(var i=0;i<this.BLOCKS_PER_CHUNK;i++){var o=t.palette.readFromStorage(r,i);t.palette.writeToStorage(t.blocks,i,o)}console.log("[VoxelChunkStorage] Chunk("+t.p+","+t.q+") 存储升级到: "+e)},t.updateChunkStats=function(t,e,r,i){"minecraft:air"===e&&"minecraft:air"!==r?t.blockCount++:"minecraft:air"!==e&&"minecraft:air"===r&&t.blockCount--,"minecraft:air"!==r?(t.minY=Math.min(t.minY,i),t.maxY=Math.max(t.maxY,i)):0===t.blockCount&&(t.minY=this.MAX_HEIGHT,t.maxY=0),t.isEmpty=0===t.blockCount,t.isFull=t.blockCount===this.BLOCKS_PER_CHUNK,t.isUniform&&t.uniformBlockId!==r&&(t.isUniform=!1,t.uniformBlockId=void 0)},t.optimizeChunk=function(t){for(var e=new Map,r=0;r<this.BLOCKS_PER_CHUNK;r++){var i=t.palette.readFromStorage(t.blocks,r);e.set(i,(e.get(i)||0)+1)}var o=t.palette.optimize(e);if(o.size>0){for(var a=t.palette.createStorageArray(this.BLOCKS_PER_CHUNK),n=0;n<this.BLOCKS_PER_CHUNK;n++){var s=t.palette.readFromStorage(t.blocks,n),l=o.get(s)||0;t.palette.writeToStorage(a,n,l)}t.blocks=a,t.dirty=!0}},t.getNonAirBlocks=function(t){for(var e=[],r=t.minY;r<=t.maxY;r++)for(var i=0;i<this.CHUNK_SIZE;i++)for(var o=0;o<this.CHUNK_SIZE;o++){var a=this.getBlock(t,o,r,i);"minecraft:air"!==a&&e.push({x:t.p*this.CHUNK_SIZE+o,y:r,z:t.q*this.CHUNK_SIZE+i,blockId:a})}return e},t.getChunkStats=function(t){var e=t.palette.getStats();return{coordinates:{p:t.p,q:t.q},blockCount:t.blockCount,isEmpty:t.isEmpty,isFull:t.isFull,isUniform:t.isUniform,uniformBlockId:t.uniformBlockId,heightRange:{min:t.minY,max:t.maxY},palette:e,memoryUsage:{blocks:t.blocks.byteLength,lights:t.lights.byteLength,total:t.blocks.byteLength+t.lights.byteLength+e.memoryUsage},lastAccess:t.lastAccessTime}},t.cloneChunk=function(t){var e=this.createChunk(t.p,t.q);return e.palette=t.palette.clone(),e.blocks=t.blocks.slice(),e.lights=t.lights.slice(),e.dirty=t.dirty,e.meshDirty=t.meshDirty,e.faces=t.faces,e.minY=t.minY,e.maxY=t.maxY,e.blockCount=t.blockCount,e.isEmpty=t.isEmpty,e.isFull=t.isFull,e.isUniform=t.isUniform,e.uniformBlockId=t.uniformBlockId,e},t}());n=s,s.CHUNK_SIZE=a.CHUNK_SIZE||16,s.MAX_HEIGHT=a.MAX_HEIGHT||256,s.BLOCKS_PER_CHUNK=n.CHUNK_SIZE*n.CHUNK_SIZE*n.MAX_HEIGHT,r._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelCollisionSystem.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelBlock.ts"],(function(e){var i,t,o,n,r,l,a,s,c,u;return{setters:[function(e){i=e.applyDecoratedDescriptor,t=e.inheritsLoose,o=e.initializerDefineProperty,n=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose},function(e){l=e.cclegacy,a=e._decorator,s=e.Vec3,c=e.Component},function(e){u=e.VoxelBlockType}],execute:function(){var h,y,p,f,d;l._RF.push({},"3bcb1Av1itLFLnnHUSjyJq2","VoxelCollisionSystem",void 0);var g=a.ccclass,v=a.property;e("VoxelCollisionSystem",g("VoxelCollisionSystem")((p=i((y=function(e){function i(){for(var i,t=arguments.length,r=new Array(t),l=0;l<t;l++)r[l]=arguments[l];return i=e.call.apply(e,[this].concat(r))||this,o(i,"playerPadding",p,n(i)),o(i,"playerHeight",f,n(i)),o(i,"playerRadius",d,n(i)),i}t(i,e);var l=i.prototype;return l.checkCollision=function(e,i){for(var t,o=this.getCollisionCheckPositions(e),n=r(o);!(t=n()).done;){var l=t.value,a=this.worldToBlockPosition(l),s=i(a.x,a.y,a.z);if(this.isBlockSolid(s))return!0}return!1},l.checkMovementCollision=function(e,i,t){if(!this.checkCollision(i,t))return i;var o=i.clone().subtract(e);return this.trySeparateAxisMovement(e,o,t)||e},l.getCollisionCheckPositions=function(e){for(var i=[],t=(this.playerPadding,this.playerHeight),o=this.playerRadius,n=e.y-.5*t,r=e.y+.5*t,l=0,a=[n,n+.5,e.y,r-.5,r];l<a.length;l++){var c=a[l];i.push(new s(e.x-o,c,e.z-o),new s(e.x+o,c,e.z-o),new s(e.x-o,c,e.z+o),new s(e.x+o,c,e.z+o),new s(e.x,c,e.z-o),new s(e.x,c,e.z+o),new s(e.x-o,c,e.z),new s(e.x+o,c,e.z))}return i},l.trySeparateAxisMovement=function(e,i,t){for(var o=[new s(i.x,0,0),new s(0,i.y,0),new s(0,0,i.z)],n=e.clone(),r=0,l=o;r<l.length;r++){var a=l[r];if(a.length()>.001){var c=n.clone().add(a);this.checkCollision(c,t)||n.add(a)}}return n.equals(e)?null:n},l.worldToBlockPosition=function(e){return new s(Math.floor(e.x),Math.floor(e.y),Math.floor(e.z))},l.isBlockSolid=function(e){return e!==u.EMPTY&&e!==u.CLOUD},l.checkGroundContact=function(e,i){for(var t=0,o=[new s(e.x-this.playerRadius,e.y-.5*this.playerHeight-.1,e.z-this.playerRadius),new s(e.x+this.playerRadius,e.y-.5*this.playerHeight-.1,e.z-this.playerRadius),new s(e.x-this.playerRadius,e.y-.5*this.playerHeight-.1,e.z+this.playerRadius),new s(e.x+this.playerRadius,e.y-.5*this.playerHeight-.1,e.z+this.playerRadius),new s(e.x,e.y-.5*this.playerHeight-.1,e.z)];t<o.length;t++){var n=o[t],r=this.worldToBlockPosition(n),l=i(r.x,r.y,r.z);if(this.isBlockSolid(l))return!0}return!1},l.getCollisionInfo=function(e,i){for(var t,o,n=this,l=[],a=this.getCollisionCheckPositions(e),c=function(){var e=t.value,o=n.worldToBlockPosition(e),r=i(o.x,o.y,o.z);if(n.isBlockSolid(r)){var a=o.x+","+o.y+","+o.z;l.some((function(e){return e.x+","+e.y+","+e.z===a}))||l.push(o)}},u=r(a);!(t=u()).done;)c();if(l.length>0)for(var h,y=1/0,p=r(l);!(h=p()).done;){var f=h.value,d=s.distance(e,f);d<y&&(y=d,o=f)}return{hasCollision:l.length>0,collidingBlocks:l,nearestBlock:o}},i}(c)).prototype,"playerPadding",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.25}}),f=i(y.prototype,"playerHeight",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.8}}),d=i(y.prototype,"playerRadius",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),h=y))||h);l._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelConfig.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelWorldConfig.ts"],(function(E){var _,n,e;return{setters:[function(E){_=E.createClass},function(E){n=E.cclegacy},function(E){e=E.VoxelWorldConfig}],execute:function(){n._RF.push({},"f42057cwh9DFYVHEo2Rj3nX","VoxelConfig",void 0);E("VoxelRenderMode",function(E){return E.MERGED_CHUNK="merged",E.INDIVIDUAL_BLOCK="individual",E}({}));var T=E("VoxelConfig",function(){function E(){}return _(E,null,[{key:"CHUNK_SIZE",get:function(){return e.CHUNK_SIZE}},{key:"MAX_HEIGHT",get:function(){return e.MAX_HEIGHT}},{key:"SEA_LEVEL",get:function(){return e.SEA_LEVEL}},{key:"CREATE_CHUNK_RADIUS",get:function(){return e.CREATE_CHUNK_RADIUS}},{key:"RENDER_CHUNK_RADIUS",get:function(){return e.RENDER_CHUNK_RADIUS}},{key:"DELETE_CHUNK_RADIUS",get:function(){return e.DELETE_CHUNK_RADIUS}},{key:"TERRAIN_NOISE_SCALE",get:function(){return e.TERRAIN_NOISE_SCALE}},{key:"TERRAIN_HEIGHT_SCALE",get:function(){return e.TERRAIN_HEIGHT_SCALE}},{key:"TERRAIN_HEIGHT_OFFSET",get:function(){return e.TERRAIN_HEIGHT_OFFSET}},{key:"SHOW_PLANTS",get:function(){return e.SHOW_PLANTS}},{key:"SHOW_CLOUDS",get:function(){return e.SHOW_CLOUDS}},{key:"SHOW_TREES",get:function(){return e.SHOW_TREES}}]),E}());T.DEBUG=!1,T.MAX_CHUNKS=8192,T.WORKERS=4,T.COMMIT_INTERVAL=5,T.SHOW_LIGHTS=!0,T.DAY_LENGTH=600,T.CLOUD_HEIGHT_MIN=64,T.CLOUD_HEIGHT_MAX=72,T.TREE_HEIGHT_MIN=3,T.TREE_HEIGHT_MAX=7,T.TREE_TRUNK_HEIGHT=7,T.TREE_LEAVES_RADIUS=3,T.TREE_LEAVES_HEIGHT_OFFSET=4,T.PLANT_NOISE_SCALE=.1,T.PLANT_THRESHOLD=.6,T.FLOWER_NOISE_SCALE=.05,T.FLOWER_THRESHOLD=.7,T.TREE_NOISE_SCALE=1,T.TREE_THRESHOLD=.84,T.CLOUD_NOISE_SCALE=.01,T.CLOUD_THRESHOLD=.75,T.LIGHT_DIRECTION={x:-1,y:1,z:-1},T.FOG_DISTANCE_DEFAULT=150,T.FACE_COUNT=6,T.VERTEX_PER_FACE=4,T.TRIANGLE_PER_FACE=2,T.VERTEX_ATTRIBUTES=10,n._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelCuller.ts",["cc"],(function(n){var t;return{setters:[function(n){t=n.cclegacy}],execute:function(){t._RF.push({},"ce3d60tRH1Earu8eY1hPE2M","VoxelCuller",void 0);n("VoxelCuller",function(){function n(){}return n.shouldRenderFace=function(n,t,e){return!0},n.isChunkInFrustum=function(n,t,e){return!0},n.getChunkLOD=function(n,t){return 0},n.isChunkOccluded=function(n,t,e){return!1},n.extractFrustumPlanes=function(n){return[]},n.getDistanceToPlane=function(n,t,e,u,r,c,o){return 1},n.createBatches=function(n){return n.map((function(n){return{blocks:[n]}}))},n.calculateAO=function(n,t,e,u,r){return[1,1,1,1]},n.getAODirections=function(n){return[[],[],[],[]]},n}());t._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelInteractionExample.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelRenderer.ts","./VoxelBlock.ts","./VoxelWorldConfig.ts","./VoxelConfig.ts"],(function(e){var o,n,l,t,r,s,c,i,a,d,g,h,x,u,f,v;return{setters:[function(e){o=e.applyDecoratedDescriptor,n=e.inheritsLoose,l=e.initializerDefineProperty,t=e.assertThisInitialized},function(e){r=e.cclegacy,s=e._decorator,c=e.Camera,i=e.input,a=e.Input,d=e.KeyCode,g=e.Vec3,h=e.Component},function(e){x=e.VoxelRenderer},function(e){u=e.VoxelBlockType},function(e){f=e.VoxelWorldMode},function(e){v=e.VoxelRenderMode}],execute:function(){var k,R,p,y,B,m,T;r._RF.push({},"0ba0aOVDrZJpoiNkS1frpLA","VoxelInteractionExample",void 0);var M=s.ccclass,E=s.property;e("VoxelInteractionExample",(k=M("VoxelInteractionExample"),R=E(c),p=E(x),k((m=o((B=function(e){function o(){for(var o,n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];return o=e.call.apply(e,[this].concat(r))||this,l(o,"camera",m,t(o)),l(o,"voxelRenderer",T,t(o)),o.currentBlockType=u.STONE,o}n(o,e);var r=o.prototype;return r.onLoad=function(){var e=this;this.initializeVoxelSystem(),this.setupEventCallbacks(),this.scheduleOnce((function(){e.testInteractionSystem()}),1)},r.onEnable=function(){i.on(a.EventType.KEY_DOWN,this.onKeyDown,this)},r.onDisable=function(){i.off(a.EventType.KEY_DOWN,this.onKeyDown,this)},r.initializeVoxelSystem=function(){if(this.voxelRenderer){var e=this.voxelRenderer.findSpawnLocation();e.y+=2,this.camera&&this.camera.node.setWorldPosition(e),this.voxelRenderer.generateAroundPosition(e.x,e.z,5),this.createTestBlocks(e),console.log("[VoxelInteractionExample] 体素交互系统初始化完成"),console.log("键位控制:"),console.log("  WASD: 移动"),console.log("  F: 切换步行/飞行模式"),console.log("  1-6: 切换方块类型"),console.log("  R: 切换渲染模式"),console.log("  T: 切换世界模式"),console.log("  G: 重新生成世界"),console.log("  I: 打印调试信息"),console.log("  P: 在前方放置测试方块"),console.log("  O: 检查摄像机位置和前方方块"),console.log("  鼠标左键: 破坏方块"),console.log("  鼠标右键: 放置方块")}else console.error("[VoxelInteractionExample] VoxelRenderer 组件未设置")},r.setupEventCallbacks=function(){var e={onBlockClick:function(e){e.hit&&e.position&&console.log("[交互] 点击方块 位置:("+e.position.x+", "+e.position.y+", "+e.position.z+") 类型:"+e.blockType)},onBlockHover:function(e){},onBlockPlace:function(e,o){console.log("[交互] 放置方块 位置:("+e.x+", "+e.y+", "+e.z+") 类型:"+o)},onBlockBreak:function(e){console.log("[交互] 破坏方块 位置:("+e.x+", "+e.y+", "+e.z+")")},onModeChange:function(e){console.log("[交互] 摄像机模式切换: "+e);var o=e===VoxelCameraMode.FLYING?"飞行模式 (20 units/s)":"步行模式 (5 units/s)";console.log("[交互] 当前速度: "+o)}};this.voxelRenderer.setInteractionEventCallbacks(e)},r.onKeyDown=function(e){switch(e.keyCode){case d.DIGIT_1:this.setBlockType(u.STONE);break;case d.DIGIT_2:this.setBlockType(u.DIRT);break;case d.DIGIT_3:this.setBlockType(u.GRASS);break;case d.DIGIT_4:this.setBlockType(u.WOOD);break;case d.DIGIT_5:this.setBlockType(u.LEAVES);break;case d.DIGIT_6:this.setBlockType(u.GLASS);break;case d.KEY_R:this.toggleRenderMode();break;case d.KEY_T:console.log("toggleWorldMode 太卡了，暂时禁用");break;case d.KEY_G:this.regenerateWorld();break;case d.KEY_I:this.printDebugInfo();break;case d.KEY_P:this.placeTestBlock();break;case d.KEY_O:this.printCameraAndBlocks()}},r.setBlockType=function(e){this.currentBlockType=e,this.voxelRenderer.setSelectedBlockType(e),console.log("[交互] 选择方块类型: "+e)},r.toggleRenderMode=function(){var e=this.voxelRenderer.getCurrentRenderMode(),o=e===v.MERGED_CHUNK?v.INDIVIDUAL_BLOCK:v.MERGED_CHUNK;this.voxelRenderer.setRenderMode(o),console.log("[交互] 渲染模式: "+e+" → "+o)},r.toggleWorldMode=function(){var e,o=this.voxelRenderer.getCurrentWorldMode();switch(o){case f.NORMAL:e=f.SMALL_FLAT;break;case f.SMALL_FLAT:e=f.TINY_DEBUG;break;case f.TINY_DEBUG:e=f.NORMAL;break;default:e=f.NORMAL}this.voxelRenderer.switchWorldMode(e),console.log("[交互] 世界模式: "+o+" → "+e);var n=this.voxelRenderer.findSpawnLocation();n.y+=2,this.camera&&this.camera.node.setWorldPosition(n),this.voxelRenderer.generateAroundPosition(n.x,n.z,3)},r.regenerateWorld=function(){console.log("[交互] 重新生成世界"),this.voxelRenderer.regenerateWorld();var e=this.voxelRenderer.findSpawnLocation();e.y+=2,this.camera&&this.camera.node.setWorldPosition(e)},r.printDebugInfo=function(){console.log("=== 体素交互系统调试信息 ===");var e=this.voxelRenderer.getWorldStatistics();console.log("世界统计:",e);var o=this.voxelRenderer.getRenderModeInfo();console.log(o);var n=this.voxelRenderer.getWorldModeInfo();console.log(n),this.voxelRenderer.getInteractionManager()?(console.log("交互系统状态: 已初始化"),console.log("当前选择的方块类型:",this.currentBlockType)):console.log("交互系统状态: 未初始化"),console.log("VoxelRenderer节点子节点数量:",this.voxelRenderer.node.children.length),console.log("当前渲染模式:",this.voxelRenderer.getCurrentRenderMode()),console.log("当前世界模式:",this.voxelRenderer.getCurrentWorldMode()),console.log("=== 调试信息结束 ===")},r.manualPlaceBlock=function(e,o,n,l){var t=l||this.currentBlockType,r=new g(e,o,n);return this.voxelRenderer.placeBlock(r,t)},r.manualBreakBlock=function(e,o,n){var l=new g(e,o,n);return this.voxelRenderer.breakBlock(l)},r.getBlockAt=function(e,o,n){return this.voxelRenderer.getBlock(e,o,n)},r.getCameraPosition=function(){return this.camera?this.camera.node.getWorldPosition():new g},r.setCameraPosition=function(e,o,n){this.camera&&this.camera.node.setWorldPosition(new g(e,o,n))},r.teleportToSpawn=function(){var e=this.voxelRenderer.findSpawnLocation();e.y+=2,this.setCameraPosition(e.x,e.y,e.z),console.log("[交互] 传送到出生点: ("+e.x+", "+e.y+", "+e.z+")")},r.buildStructure=function(){var e=this.getCameraPosition(),o=Math.floor(e.x)+5,n=Math.floor(e.y),l=Math.floor(e.z);console.log("[交互] 在位置 ("+o+", "+n+", "+l+") 建造小房子");for(var t=0;t<3;t++)for(var r=0;r<3;r++)this.manualPlaceBlock(o+t,n-1,l+r,u.STONE),0!==t&&2!==t&&0!==r&&2!==r||(this.manualPlaceBlock(o+t,n,l+r,u.WOOD),this.manualPlaceBlock(o+t,n+1,l+r,u.WOOD)),this.manualPlaceBlock(o+t,n+2,l+r,u.LEAVES);this.manualBreakBlock(o+1,n,l),console.log("[交互] 房子建造完成！")},r.testInteractionSystem=function(){if(console.log("=== 交互系统测试开始 ==="),this.voxelRenderer){if(!this.voxelRenderer.getInteractionManager())return console.error("[测试] 交互管理器未初始化！"),console.log("[测试] 请确保在VoxelRenderer节点上添加了以下组件:"),console.log("  - VoxelInteractionManager"),console.log("  - VoxelCameraController"),void console.log("  - VoxelCollisionSystem");console.log("[测试] 交互管理器已初始化 ✓"),console.log("[测试] 执行射线投射测试（屏幕中心）...");var e=this.voxelRenderer.performRaycast();console.log("[测试] 射线投射结果:",e);var o=this.getCameraPosition();console.log("[测试] 摄像机位置: ("+o.x.toFixed(2)+", "+o.y.toFixed(2)+", "+o.z.toFixed(2)+")"),console.log("[测试] 检查摄像机周围的方块...");for(var n=0,l=-3;l<=3;l++)for(var t=-3;t<=3;t++)for(var r=-3;r<=3;r++){var s=Math.floor(o.x)+l,c=Math.floor(o.y)+t,i=Math.floor(o.z)+r,a=this.getBlockAt(s,c,i);a!==u.EMPTY&&++n<=10&&console.log("[测试] 发现方块 ("+s+", "+c+", "+i+"): "+a)}console.log("[测试] 在7x7x7范围内发现 "+n+" 个方块"),0===n?(console.warn("[测试] 警告：摄像机周围没有方块！请尝试:"),console.warn("  1. 按T键切换到TINY_DEBUG世界模式"),console.warn("  2. 按G键重新生成世界"),console.warn("  3. 移动摄像机到地面附近")):(console.log("[测试] 交互系统基础功能正常 ✓"),console.log("[测试] 现在可以尝试点击方块进行交互")),console.log("=== 交互系统测试完成 ===")}else console.error("[测试] VoxelRenderer未设置！")},r.createTestBlocks=function(e){console.log("[VoxelInteractionExample] 创建测试方块...");var o=this.voxelRenderer.getCurrentWorldMode(),n=Math.floor(e.x),l=Math.floor(e.z);if(o===f.SMALL_FLAT)console.log("[测试方块] SMALL_FLAT模式 - 在y=1层放置测试方块"),this.voxelRenderer.setBlock(n,1,l-2,u.STONE),console.log("[测试方块] 放置石头方块 ("+n+", 1, "+(l-2)+") 用于点击测试"),this.voxelRenderer.setBlock(n-2,1,l,u.WOOD),this.voxelRenderer.setBlock(n+2,1,l,u.DIRT),this.voxelRenderer.setBlock(n,1,l+2,u.LEAVES),console.log("[测试提示] SMALL_FLAT模式：地面在y=0，测试方块在y=1");else{for(var t=Math.floor(e.y)-3,r=-1;r<=1;r++)for(var s=-1;s<=1;s++)this.voxelRenderer.setBlock(n+r,t,l+s,u.GRASS),console.log("[测试方块] 放置草方块 ("+(n+r)+", "+t+", "+(l+s)+")");this.voxelRenderer.setBlock(n,t+1,l-2,u.STONE),console.log("[测试方块] 放置石头方块 ("+n+", "+(t+1)+", "+(l-2)+") 用于点击测试"),this.voxelRenderer.setBlock(n-2,t+1,l,u.WOOD),this.voxelRenderer.setBlock(n+2,t+1,l,u.DIRT),this.voxelRenderer.setBlock(n,t+1,l+2,u.LEAVES)}console.log("[VoxelInteractionExample] 测试方块创建完成"),console.log("[测试提示] 请朝向前方的石头方块点击鼠标进行测试")},r.placeTestBlock=function(){var e=this.getCameraPosition(),o=Math.floor(e.x),n=Math.floor(e.y)-1,l=Math.floor(e.z)-2;console.log("[测试] 在 ("+o+", "+n+", "+l+") 放置测试方块");var t=this.voxelRenderer.setBlock(o,n,l,u.STONE);console.log("[测试] 放置结果: "+(t?"成功":"失败"))},r.printCameraAndBlocks=function(){var e=this.getCameraPosition();console.log("[调试] 摄像机位置: ("+e.x.toFixed(2)+", "+e.y.toFixed(2)+", "+e.z.toFixed(2)+")"),console.log("[调试] 检查摄像机前方的方块:");for(var o=1;o<=8;o++){var n=Math.floor(e.x),l=Math.floor(e.y),t=Math.floor(e.z)-o,r=this.getBlockAt(n,l,t);r!==u.EMPTY&&console.log("[调试] 距离"+o+": ("+n+", "+l+", "+t+") = "+r)}console.log("[调试] 执行射线投射测试（屏幕中心）...");var s=this.voxelRenderer.performRaycast();console.log("[调试] 射线投射结果:",s)},o}(h)).prototype,"camera",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T=o(B.prototype,"voxelRenderer",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y=B))||y));r._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelInteractionManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelRayCaster.ts","./VoxelCollisionSystem.ts"],(function(e){var t,o,n,r,i,a,l,s,c,u,d,h,f,g,p,m,v,y,M;return{setters:[function(e){t=e.applyDecoratedDescriptor,o=e.inheritsLoose,n=e.initializerDefineProperty,r=e.assertThisInitialized,i=e.createForOfIteratorHelperLoose},function(e){a=e.cclegacy,l=e._decorator,s=e.Camera,c=e.input,u=e.Input,d=e.EventMouse,h=e.Vec3,f=e.Node,g=e.utils,p=e.MeshRenderer,m=e.Material,v=e.Component},function(e){y=e.RaycastAlgorithm},function(e){M=e.VoxelCollisionSystem}],execute:function(){var b,k,x,I,V,w,B,C,R,D,z,N,E,S,_,T,H;a._RF.push({},"ee75fHulKNAnq9Cp+vvMVT1","VoxelInteractionManager",void 0);var W=l.ccclass,O=l.property,L=e("VoxelCameraMode",function(e){return e.WALKING="walking",e.FLYING="flying",e.SPECTATOR="spectator",e}({}));e("VoxelInteractionManager",(b=W("VoxelInteractionManager"),k=O({type:s}),x=O({displayName:"默认相机模式",tooltip:"启动时的默认体素相机模式"}),I=O({type:M}),V=O({tooltip:"启用射线可视化调试"}),w=O({tooltip:"启用击中点标记"}),B=O({tooltip:"调试信息保持时间（秒）"}),b((D=t((R=function(e){function t(){for(var t,o=arguments.length,i=new Array(o),a=0;a<o;a++)i[a]=arguments[a];return t=e.call.apply(e,[this].concat(i))||this,n(t,"camera",D,r(t)),n(t,"defaultVoxelMode",z,r(t)),n(t,"collisionSystem",N,r(t)),n(t,"maxRaycastDistance",E,r(t)),n(t,"selectedBlockId",S,r(t)),n(t,"enableDebugVisualization",_,r(t)),n(t,"enableHitMarkers",T,r(t)),n(t,"debugDisplayTime",H,r(t)),t.world=null,t.events={},t._currentCameraMode=L.WALKING,t.lastHoverResult=null,t.debugRayNodes=[],t.debugMarkerNodes=[],t}o(t,e);var a=t.prototype;return a.onLoad=function(){console.log("[VoxelInteractionManager] 开始初始化..."),this.camera||console.warn("[VoxelInteractionManager] 请在Inspector中设置Camera引用"),this.collisionSystem||(this.collisionSystem=this.getComponent(M)),this._currentCameraMode=this.defaultVoxelMode,console.log("[VoxelInteractionManager] 体素交互管理器初始化完成")},a.onEnable=function(){this._currentCameraMode=this.defaultVoxelMode,console.log("[VoxelInteractionManager] onEnable: 相机模式设置为: "+this._currentCameraMode),this.setupInputHandlers(),this.setupWorld()},a.setupWorld=function(){this.world||console.warn("[VoxelInteractionManager] VoxelWorld未设置，请调用setWorld方法")},a.setWorld=function(e){this.world=e,console.log("[VoxelInteractionManager] 体素世界设置完成")},a.setEvents=function(e){this.events=e,console.log("[VoxelInteractionManager] 事件回调设置完成")},a.initialize=function(e,t){this.setWorld(e),t&&this.setEvents(t)},a.setupInputHandlers=function(){c.on(u.EventType.MOUSE_DOWN,this.onMouseDown,this),c.on(u.EventType.MOUSE_MOVE,this.onMouseMove,this),console.log("[VoxelInteractionManager] 鼠标输入监听器设置完成")},a.onMouseDown=function(e){e.getButton()===d.BUTTON_LEFT?this.handleLeftClick(e):e.getButton()===d.BUTTON_RIGHT&&this.handleRightClick(e)},a.onMouseMove=function(e){if(this.events.onBlockHover){var t=this.performRaycastFromEvent(e);t!==this.lastHoverResult&&(this.events.onBlockHover(t),this.lastHoverResult=t)}},a.handleLeftClick=function(e){var t=this.performRaycastFromEvent(e);if(t&&this.events.onBlockClick&&this.events.onBlockClick(t),t&&this.world){var o=t.position;this.world.setBlock(o.x,o.y,o.z,"minecraft:air"),this.events.onBlockBreak&&this.events.onBlockBreak(o),console.log("[VoxelInteractionManager] 方块已破坏: ("+o.x+", "+o.y+", "+o.z+")")}},a.handleRightClick=function(e){var t=this.performRaycastFromEvent(e);if(t&&this.world){var o=t.normal,n=t.position,r=new h(n.x+o.x,n.y+o.y,n.z+o.z);this.world.setBlock(r.x,r.y,r.z,this.selectedBlockId),this.events.onBlockPlace&&this.events.onBlockPlace(r,this.selectedBlockId),console.log("[VoxelInteractionManager] 方块已放置: ("+r.x+", "+r.y+", "+r.z+") 类型:"+this.selectedBlockId)}},a.performRaycastFromEvent=function(e){if(!this.camera||!this.world)return null;var t=e.getUILocation(),o=t.x,n=t.y;console.log("[VoxelInteractionManager] 射线检测: 屏幕坐标("+o+", "+n+")");var r=this.performWorldRaycast(o,n);return this.enableDebugVisualization&&this.visualizeRaycast(r),r&&console.log("[VoxelInteractionManager] 击中方块: ("+r.position.x+", "+r.position.y+", "+r.position.z+")"),r},a.performRaycast=function(e,t){return this.camera&&this.world?void 0===e||void 0===t?null:this.performWorldRaycast(e,t):null},a.performWorldRaycast=function(e,t){if(!this.camera||!this.world)return null;var o=this.camera.screenPointToRay(e,t);if(!o)return null;var n=this.world.raycast(o.o,o.d,this.maxRaycastDistance);return n.hit&&n.position&&n.normal?{position:n.position,normal:n.normal,blockId:n.blockId||"minecraft:air",distance:n.position.clone().subtract(o.o).length(),rayStart:o.o,rayEnd:o.o.clone().add(o.d.clone().multiplyScalar(this.maxRaycastDistance))}:null},a.visualizeRaycast=function(e){var t=this;if(this.clearDebugNodes(),e){if(this.enableDebugVisualization){var o=this.createDebugRay(e.rayStart,e.rayEnd);o&&this.debugRayNodes.push(o)}if(this.enableHitMarkers){var n=this.createDebugMarker(e.position);n&&this.debugMarkerNodes.push(n)}this.scheduleOnce((function(){t.clearDebugNodes()}),this.debugDisplayTime)}else console.log("[VoxelInteractionManager] 射线未击中任何方块")},a.createDebugRay=function(e,t){try{var o=new f("DebugRay");this.node.addChild(o);var n=h.subtract(new h,t,e),r=n.length();n.normalize();var i=g.primitives.cylinder({radiusTop:.02,radiusBottom:.02,height:r}),a=g.MeshUtils.createMesh(i);if(!a)return null;var l=o.addComponent(p);l.mesh=a;var s=new m;s.initialize({effectName:"builtin-unlit"}),l.material=s;var c=h.lerp(new h,e,t,.5);return o.setWorldPosition(c),o}catch(e){return console.error("[VoxelInteractionManager] 创建调试射线失败:",e),null}},a.createDebugMarker=function(e){try{var t=new f("DebugMarker");this.node.addChild(t);var o=g.primitives.box({width:.2,height:.2,length:.2}),n=g.MeshUtils.createMesh(o);if(!n)return null;var r=t.addComponent(p);r.mesh=n;var i=new m;return i.initialize({effectName:"builtin-unlit"}),r.material=i,t.setWorldPosition(e),t}catch(e){return console.error("[VoxelInteractionManager] 创建调试标记失败:",e),null}},a.clearDebugNodes=function(){for(var e,t=i(this.debugRayNodes);!(e=t()).done;){var o=e.value;o&&o.isValid&&o.destroy()}this.debugRayNodes=[];for(var n,r=i(this.debugMarkerNodes);!(n=r()).done;){var a=n.value;a&&a.isValid&&a.destroy()}this.debugMarkerNodes=[]},a.toggleCameraMode=function(){var e=Object.values(L),t=(e.indexOf(this._currentCameraMode)+1)%e.length;this._currentCameraMode=e[t],console.log("[VoxelInteractionManager] 相机模式切换到: "+this._currentCameraMode),this.events.onModeChange&&this.events.onModeChange(this._currentCameraMode)},a.setCameraMode=function(e){this._currentCameraMode=e,console.log("[VoxelInteractionManager] 相机模式设置为: "+e)},a.getCurrentCameraMode=function(){return this._currentCameraMode},a.placeBlock=function(e,t){if(void 0===t&&(t=this.selectedBlockId),!this.world)return!1;var o=this.world.setBlock(e.x,e.y,e.z,t);return o&&this.events.onBlockPlace&&this.events.onBlockPlace(e,t),o},a.breakBlock=function(e){if(!this.world)return!1;var t=this.world.setBlock(e.x,e.y,e.z,"minecraft:air");return t&&this.events.onBlockBreak&&this.events.onBlockBreak(e),t},a.getLastHoverResult=function(){return this.lastHoverResult},a.getCollisionSystem=function(){return this.collisionSystem},a.getSelectedBlockId=function(){return this.selectedBlockId},a.setSelectedBlockId=function(e){this.selectedBlockId=e,console.log("[VoxelInteractionManager] 选中方块类型: "+e)},a.getRaycastAlgorithm=function(){return y.SIMPLE},a.onDisable=function(){c.off(u.EventType.MOUSE_DOWN,this.onMouseDown,this),c.off(u.EventType.MOUSE_MOVE,this.onMouseMove,this),this.clearDebugNodes(),console.log("[VoxelInteractionManager] 交互管理器已禁用")},a.onDestroy=function(){this.clearDebugNodes(),console.log("[VoxelInteractionManager] 交互管理器已销毁")},t}(v)).prototype,"camera",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),z=t(R.prototype,"defaultVoxelMode",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L.WALKING}}),N=t(R.prototype,"collisionSystem",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E=t(R.prototype,"maxRaycastDistance",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),S=t(R.prototype,"selectedBlockId",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"minecraft:stone"}}),_=t(R.prototype,"enableDebugVisualization",[V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T=t(R.prototype,"enableHitMarkers",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),H=t(R.prototype,"debugDisplayTime",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),C=R))||C));a._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelLightingExample.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelSystem.ts","./VoxelBlock.ts","./VoxelLightingSystem.ts","./VoxelMapUtils.ts"],(function(e){var t,o,n,r,i,a,l,s,c,g,u,h,p,x,m,f,d,v;return{setters:[function(e){t=e.applyDecoratedDescriptor,o=e.inheritsLoose,n=e.initializerDefineProperty,r=e.assertThisInitialized,i=e.createForOfIteratorHelperLoose,a=e.asyncToGenerator,l=e.regeneratorRuntime},function(e){s=e.cclegacy,c=e._decorator,g=e.Vec3,u=e.director,h=e.Component,p=e.Node,x=e.MeshRenderer},function(e){m=e.VoxelSystem},function(e){f=e.BlockRegistry},function(e){d=e.VoxelLightingSystem},function(e){v=e.VoxelMapUtils}],execute:function(){var k,y,L,b,V,w,E,S,M;s._RF.push({},"224065T7G5DbLaTrfb3rYlh","VoxelLightingExample",void 0);var z=c.ccclass,B=c.property;e("VoxelLightingExample",(k=z("VoxelLightingExample"),y=B({displayName:"演示规模",min:3,max:10}),L=B({displayName:"发光方块密度",range:[0,1]}),b=B({displayName:"显示光照调试",type:Boolean}),k((E=t((w=function(e){function t(){for(var t,o=arguments.length,i=new Array(o),a=0;a<o;a++)i[a]=arguments[a];return t=e.call.apply(e,[this].concat(i))||this,n(t,"demoSize",E,r(t)),n(t,"glowingDensity",S,r(t)),n(t,"showLightingDebug",M,r(t)),t.voxelSystem=null,t.demoChunk=null,t.blockNodes=[],t}o(t,e);var s=t.prototype;return s.start=function(){var e=a(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[VoxelLightingExample] 开始初始化发光方块演示..."),e.prev=1,e.next=4,m.quickInitialize();case 4:if(this.voxelSystem=e.sent,this.voxelSystem){e.next=8;break}return console.error("[VoxelLightingExample] 体素系统初始化失败"),e.abrupt("return");case 8:return console.log("[VoxelLightingExample] 体素系统初始化成功"),t=f.getAllBlockIds().length,console.log("[VoxelLightingExample] 方块注册表包含 "+t+" 个方块"),console.log("[VoxelLightingExample] 开始创建演示场景..."),e.next=14,this.createLightingDemo();case 14:console.log("[VoxelLightingExample] 发光方块演示初始化完成"),e.next=21;break;case 17:e.prev=17,e.t0=e.catch(1),console.error("[VoxelLightingExample] 初始化失败:",e.t0),console.error("[VoxelLightingExample] 错误堆栈:",e.t0.stack);case 21:case"end":return e.stop()}}),e,this,[[1,17]])})));return function(){return e.apply(this,arguments)}}(),s.createLightingDemo=function(){var e=a(l().mark((function e(){var t,o,n,r,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("[VoxelLightingExample] 创建光照演示场景..."),e.prev=1,t=[{id:"minecraft:stone",position:new g(0,0,0)},{id:"minecraft:glowstone",position:new g(2,0,0)},{id:"minecraft:stone",position:new g(4,0,0)},{id:"minecraft:glowstone",position:new g(0,0,2)}],console.log("[VoxelLightingExample] 创建 "+t.length+" 个测试方块..."),o=function(e,o,n){for(var r=0,i=t;r<i.length;r++){var a=i[r];if(a.position.x===e&&a.position.y===o&&a.position.z===n)return a.id}return"minecraft:air"},n=0;case 6:if(!(n<t.length)){e.next=16;break}return r=t[n],console.log("[VoxelLightingExample] 创建方块 "+(n+1)+"/"+t.length+": "+r.id+" at ("+r.position.x+", "+r.position.y+", "+r.position.z+")"),(i=f.getLightLevel(r.id))>0&&console.log("[VoxelLightingExample] -> 这是发光方块，光照等级: "+i),e.next=13,this.createBlockNode(r,o);case 13:n++,e.next=6;break;case 16:console.log("[VoxelLightingExample] 方块创建完成，实际创建了 "+this.blockNodes.length+" 个节点"),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(1),console.error("[VoxelLightingExample] 创建演示场景失败:",e.t0),console.error("[VoxelLightingExample] 错误堆栈:",e.t0.stack);case 23:case"end":return e.stop()}}),e,this,[[1,19]])})));return function(){return e.apply(this,arguments)}}(),s.createFullDemo=function(){var e=a(l().mark((function e(){var t,o,n,r,a,s,c,u,h;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(this.demoChunk=this.createDemoChunk(),t=this.generateDemoBlocks(),console.log("[VoxelLightingExample] 生成 "+t.length+" 个方块"),o=new Map,n=i(t);!(r=n()).done;)a=r.value,s=a.position.x+","+a.position.y+","+a.position.z,o.set(s,a.id);c=function(e,t,n){var r=e+","+t+","+n;return o.get(r)||"minecraft:air"},d.initializeChunkLighting(this.demoChunk,c),console.log("[VoxelLightingExample] 开始创建 "+t.length+" 个方块节点..."),u=0;case 9:if(!(u<t.length)){e.next=19;break}if(!(h=t[u]).position.equals(new g(0,0,0))){e.next=13;break}return e.abrupt("continue",16);case 13:return console.log("[VoxelLightingExample] 创建方块 "+(u+1)+"/"+t.length+": "+h.id+" at ("+h.position.x+", "+h.position.y+", "+h.position.z+")"),e.next=16,this.createBlockNode(h,c);case 16:u++,e.next=9;break;case 19:console.log("[VoxelLightingExample] 方块节点创建完成，实际创建了 "+this.blockNodes.length+" 个节点"),this.showLightingDebug&&(d.debugChunkLighting(this.demoChunk),this.logLightingStats(t));case 21:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),s.generateDemoBlocks=function(){for(var e=[],t=0;t<this.demoSize;t++)for(var o=0;o<this.demoSize;o++)e.push({id:"minecraft:stone",position:new g(t,0,o)});var n=this.getAvailableLightSources(),r=Math.floor(this.demoSize*this.demoSize*this.glowingDensity);console.log("[VoxelLightingExample] 添加 "+r+" 个发光方块");for(var i=0;i<r;i++){var a=Math.floor(Math.random()*this.demoSize),l=Math.floor(Math.random()*this.demoSize),s=1+Math.floor(2*Math.random()),c=n[i%n.length];e.push({id:c,position:new g(a,s,l)})}for(var u=Math.floor(this.demoSize*this.demoSize*.2),h=0;h<u;h++){var p=Math.floor(Math.random()*this.demoSize),x=Math.floor(Math.random()*this.demoSize);e.push({id:"minecraft:cobblestone",position:new g(p,1,x)})}return e},s.getAvailableLightSources=function(){var e=f.getAllBlockIds();console.log("[VoxelLightingExample] 总共找到 "+e.length+" 个方块类型:",e);var t=e.filter((function(e){var t=f.getLightLevel(e);return t>0&&console.log("[VoxelLightingExample] 发光方块: "+e+" (等级 "+t+")"),t>0}));return console.log("[VoxelLightingExample] 发现 "+t.length+" 种发光方块:",t),0===t.length?(console.warn("[VoxelLightingExample] 没有找到发光方块，使用默认"),["minecraft:glowstone"]):t},s.createDemoChunk=function(){return{map:v.allocMap(0,0,0,0),lights:v.allocMap(0,0,0,0),p:0,q:0,faces:0,dirty:!1,miny:0,maxy:3}},s.createBlockNode=function(){var e=a(l().mark((function e(t,o){var n,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.voxelSystem.generateBlockMesh(t.id,t.position);case 3:if(n=e.sent){e.next=7;break}return console.warn("[VoxelLightingExample] 无法生成方块网格: "+t.id),e.abrupt("return");case 7:return console.log("[VoxelLightingExample] 成功生成方块网格: "+t.id+", 纹理组数量: "+n.textureGroups.size),e.next=10,this.voxelSystem.createBlockNode(this.node,t.id,t.position);case 10:(r=e.sent)&&this.blockNodes.push(r),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(0),console.error("[VoxelLightingExample] 创建方块节点失败 "+t.id+":",e.t0),console.error("[VoxelLightingExample] 错误堆栈:",e.t0.stack);case 18:case"end":return e.stop()}}),e,this,[[0,14]])})));return function(t,o){return e.apply(this,arguments)}}(),s.createGrassBlockNode=function(){var e=a(l().mark((function e(t,o,n,r){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.warn("[VoxelLightingExample] createGrassBlockNode 已废弃，跳过。"),e.abrupt("return");case 2:case"end":return e.stop()}}),e)})));return function(t,o,n,r){return e.apply(this,arguments)}}(),s.createOverlayBlockNode=function(){var e=a(l().mark((function e(t,o,n){var r,i,a,s,c,g,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(r=new p("OverlayBase")).setParent(t),(i=r.addComponent(x)).mesh=o.base,(a=new p("OverlayTop")).setParent(t),(s=a.addComponent(x)).mesh=o.overlay,!(c=this.voxelSystem.materialFactory)||!c.createOverlayBlockMaterial){e.next=19;break}return e.next=13,c.createOverlayBlockMaterial(n.baseSideTexture,n.overlaySideTexture);case 13:return(g=e.sent)&&(c.setOverlayUniforms(g,[.5,1,.3,1]),s.material=g),e.next=17,this.voxelSystem.createBlockMaterial("minecraft:"+n.baseSideTexture.replace("_side",""));case 17:(u=e.sent)&&(i.material=u);case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(0),console.error("[VoxelLightingExample] 创建 overlay 方块节点失败:",e.t0);case 24:case"end":return e.stop()}}),e,this,[[0,21]])})));return function(t,o,n){return e.apply(this,arguments)}}(),s.createGrassOverlayMaterial=function(){var e=a(l().mark((function e(){var t,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.voxelSystem){e.next=2;break}return e.abrupt("return",null);case 2:if(e.prev=2,!(t=this.voxelSystem.materialFactory)||!t.createOverlayBlockMaterial){e.next=10;break}return e.next=7,t.createOverlayBlockMaterial("grass_block_side","grass_block_side_overlay");case 7:return(o=e.sent)&&t.setOverlayUniforms&&(t.setOverlayUniforms(o,[.5,1,.3,1]),console.log("[VoxelLightingExample] 草方块Overlay材质创建成功")),e.abrupt("return",o);case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),console.error("[VoxelLightingExample] Overlay材质创建失败:",e.t0);case 15:return e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,this,[[2,12]])})));return function(){return e.apply(this,arguments)}}(),s.logLightingStats=function(e){if(this.demoChunk){console.log("[VoxelLightingExample] 光照统计信息:");for(var t=new Map,o=0,n=0;n<this.demoSize;n++)for(var r=0;r<this.demoSize;r++)for(var a=0;a<=3;a++){var l=d.getBlockLight(this.demoChunk,n,a,r);if(l>0){o++;var s=t.get(l)||0;t.set(l,s+1)}}console.log("- 有光照的方块总数: "+o),console.log("- 光照等级分布:");for(var c,g=i(Array.from(t.entries()).sort((function(e,t){return t[0]-e[0]})));!(c=g()).done;){var u=c.value,h=u[0],p=u[1];console.log("  等级 "+h+": "+p+" 个方块")}for(var x,m=new Map,v=i(e);!(x=v()).done;){var k=x.value,y=m.get(k.id)||0;m.set(k.id,y+1)}console.log("- 方块类型分布:");for(var L,b=i(m);!(L=b()).done;){var V=L.value,w=V[0],E=V[1],S=f.getLightLevel(w),M=S>0?" (发光等级: "+S+")":"";console.log("  "+w+": "+E+" 个"+M)}}},s.toggleGlowingBlock=function(){var e=a(l().mark((function e(t,o,n){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.voxelSystem&&this.demoChunk){e.next=2;break}return e.abrupt("return");case 2:console.log("[VoxelLightingExample] 切换位置 ("+t+", "+o+", "+n+") 的发光状态");case 3:case"end":return e.stop()}}),e,this)})));return function(t,o,n){return e.apply(this,arguments)}}(),s.regenerateDemo=function(){var e=a(l().mark((function e(){var t,o,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(console.log("[VoxelLightingExample] 重新生成演示..."),t=i(this.blockNodes);!(o=t()).done;)(n=o.value)&&n.isValid&&n.destroy();return this.blockNodes=[],e.next=5,this.createLightingDemo();case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),s.waitOneFrame=function(){return new Promise((function(e){u.once(u.constructor.EVENT_AFTER_UPDATE,e)}))},s.onDestroy=function(){for(var e,t=i(this.blockNodes);!(e=t()).done;){var o=e.value;o&&o.isValid&&o.destroy()}this.demoChunk&&(v.freeMap(this.demoChunk.lights),v.freeMap(this.demoChunk.map)),console.log("[VoxelLightingExample] 光照演示已清理")},t}(h)).prototype,"demoSize",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),S=t(w.prototype,"glowingDensity",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),M=t(w.prototype,"showLightingDebug",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),V=w))||V));s._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelLightingSystem.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelMapUtils.ts","./VoxelBlock.ts"],(function(t){var e,i,n,o,a;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,n=t.Vec3},function(t){o=t.VoxelMapUtils},function(t){a=t.BlockRegistry}],execute:function(){i._RF.push({},"9c74e1W0UxGy6ZVyN76QM6m","VoxelLightingSystem",void 0);var r=t("VoxelLightingSystem",function(){function t(){}return t.initializeChunkLighting=function(t,e){console.log("[VoxelLightingSystem] 初始化区块光照 ("+t.p+", "+t.q+")");var i=16,n=[];this.clearChunkLighting(t);for(var r=t.p*i;r<(t.p+1)*i;r++)for(var l=t.q*i;l<(t.q+1)*i;l++)for(var g=t.miny;g<=t.maxy;g++){var h=e(r,g,l);if(h&&"minecraft:air"!==h){var s=a.getLightLevel(h);s>0&&(n.push({x:r,y:g,z:l,level:s}),o.setMap(t.lights,r-t.p*i,g,l-t.q*i,s))}}console.log("[VoxelLightingSystem] 找到 "+n.length+" 个光源");for(var c=0,f=n;c<f.length;c++){var u=f[c];this.propagateLight(t,u.x-t.p*i,u.y,u.z-t.q*i,u.level,e,t.p*i,t.q*i)}},t.propagateLight=function(t,i,n,r,l,g,h,s){var c=[],f=new Set;for(c.push({x:i,y:n,z:r,level:l}),f.add(i+","+n+","+r);c.length>0;)for(var u,v=c.shift(),p=v.x,L=v.y,y=v.z,m=v.level,x=e(this.DIRECTIONS);!(u=x()).done;){var M=u.value,V=p+M.x,d=L+M.y,T=y+M.z;if(!(V<0||V>=16||T<0||T>=16)&&!(d<t.miny||d>t.maxy)){var I=V+","+d+","+T;if(!f.has(I)){var k=g(h+V,d,s+T);if(!k||"minecraft:air"===k||a.isTransparent(k)){var S=Math.max(0,m-this.LIGHT_ATTENUATION);if(!(S<=0))o.getMap(t.lights,V,d,T)>=S||(o.setMap(t.lights,V,d,T,S),f.add(I),S>1&&c.push({x:V,y:d,z:T,level:S}))}}}}},t.updateBlockLighting=function(t,e,i,n,r,l,g,h){var s=a.getLightLevel(r);s>0?(o.setMap(t.lights,e,i,n,s),this.propagateLight(t,e,i,n,s,l,g,h)):o.getMap(t.lights,e,i,n)>0&&this.removeLightAndRecalculate(t,e,i,n,l,g,h);t.dirty=!0},t.removeLightAndRecalculate=function(t,e,i,n,o,a,r){console.log("[VoxelLightingSystem] 重新计算区块光照 ("+t.p+", "+t.q+")"),this.initializeChunkLighting(t,o)},t.clearChunkLighting=function(t){for(var e=0;e<16;e++)for(var i=0;i<16;i++)for(var n=t.miny;n<=t.maxy;n++)o.setMap(t.lights,e,n,i,0)},t.getBlockLight=function(t,e,i,n){return o.getMap(t.lights,e,i,n)},t.getInterpolatedLight=function(t,e,i,n,o,a){var r=e-o,l=n-a,g=Math.floor(r),h=Math.floor(i),s=Math.floor(l);return g<0||g>=16||s<0||s>=16||h<t.miny||h>t.maxy?0:this.getBlockLight(t,g,h,s)/this.MAX_LIGHT_LEVEL},t.debugChunkLighting=function(t){console.log("[VoxelLightingSystem] 区块 ("+t.p+", "+t.q+") 光照调试信息:");for(var e=0,i=0,n=0;n<16;n++)for(var a=0;a<16;a++)for(var r=t.miny;r<=t.maxy;r++){var l=o.getMap(t.lights,n,r,a);l>0&&(e++,i=Math.max(i,l))}console.log("  - 有光照的方块: "+e),console.log("  - 最高光照等级: "+i)},t}());r.MAX_LIGHT_LEVEL=15,r.LIGHT_ATTENUATION=1,r.DIRECTIONS=[new n(0,1,0),new n(0,-1,0),new n(1,0,0),new n(-1,0,0),new n(0,0,1),new n(0,0,-1)],i._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelMap.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelConfig.ts"],(function(a){var t,n,e;return{setters:[function(a){t=a.extends},function(a){n=a.cclegacy},function(a){e=a.VoxelConfig}],execute:function(){n._RF.push({},"4ef89C/7odAZYcRmbBmmjTV","VoxelMap",void 0);a("VoxelMapUtils",function(){function a(){}return a.allocMap=function(a,t,n,e){return{dx:a,dy:t,dz:n,mask:e,size:0,data:new Map}},a.freeMap=function(a){a.data.clear(),a.size=0},a.copyMap=function(a,n){a.dx=n.dx,a.dy=n.dy,a.dz=n.dz,a.mask=n.mask,a.size=n.size,a.data.clear(),n.data.forEach((function(n,e){a.data.set(e,t({},n))}))},a.growMap=function(a){var t=this,n=new Map(a.data);a.mask=a.mask<<1|1,a.data.clear(),a.size=0,n.forEach((function(n){t.setMap(a,n.x+a.dx,n.y+a.dy,n.z+a.dz,n.w)}))},a.setMap=function(a,t,n,e,i){var r=t-a.dx,o=n-a.dy,c=e-a.dz,s=o<0||o>=this.getMaxHeight();if(r<0||r>a.mask||s||c<0||c>a.mask)return!1;var d=this.makeKey(r,o,c);return 0===i?a.data.has(d)&&(a.data.delete(d),a.size--):(a.data.has(d)||a.size++,a.data.set(d,{x:r,y:o,z:c,w:i})),!0},a.getMap=function(a,t,n,e){var i=t-a.dx,r=n-a.dy,o=e-a.dz,c=r<0||r>=this.getMaxHeight();if(i<0||i>a.mask||c||o<0||o>a.mask)return 0;var s=this.makeKey(i,r,o),d=a.data.get(s);return d?d.w:0},a.getMaxHeight=function(){return e.MAX_HEIGHT},a.makeKey=function(a,t,n){return a+"_"+t+"_"+n},a.forEachEntry=function(a,t){a.data.forEach((function(n){var e=n.x+a.dx,i=n.y+a.dy,r=n.z+a.dz;t(e,i,r,n.w)}))},a.isEmpty=function(a){return 0===a.size},a.getSize=function(a){return a.size},a.containsEntry=function(a,t,n,e){return 0!==this.getMap(a,t,n,e)},a.clear=function(a){a.data.clear(),a.size=0},a.getBounds=function(a){var t=1/0,n=1/0,e=1/0,i=-1/0,r=-1/0,o=-1/0;return a.data.forEach((function(c){var s=c.x+a.dx,d=c.y+a.dy,u=c.z+a.dz;t=Math.min(t,s),n=Math.min(n,d),e=Math.min(e,u),i=Math.max(i,s),r=Math.max(r,d),o=Math.max(o,u)})),{minX:t,minY:n,minZ:e,maxX:i,maxY:r,maxZ:o}},a}());n._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelMapUtils.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(a){var e,t,r;return{setters:[function(a){e=a.createForOfIteratorHelperLoose,t=a.extends},function(a){r=a.cclegacy}],execute:function(){r._RF.push({},"6b266E1xE9Gl6QV+FuGCl8R","VoxelMapUtils",void 0);a("VoxelMapUtils",function(){function a(){}return a.allocMap=function(a,e,t,r){return{dx:a,dy:e,dz:t,mask:r,size:0,data:new Map}},a.freeMap=function(a){a.data.clear(),a.size=0},a.copyMap=function(a,r){a.dx=r.dx,a.dy=r.dy,a.dz=r.dz,a.mask=r.mask,a.size=r.size,a.data.clear();for(var n,o=e(r.data);!(n=o()).done;){var s=n.value,u=s[0],i=s[1];a.data.set(u,t({},i))}},a.setMap=function(a,e,t,r,n){try{var o=this.getMapKey(e,t,r);if(0===n)return!!a.data.has(o)&&(a.data.delete(o),a.size--,!0);var s=a.data.has(o);return a.data.set(o,{x:e,y:t,z:r,w:n}),s||a.size++,!0}catch(a){return console.error("[VoxelMapUtils] setMap 错误:",a),!1}},a.getMap=function(a,e,t,r){try{var n=this.getMapKey(e,t,r),o=a.data.get(n);return o?o.w:0}catch(a){return console.error("[VoxelMapUtils] getMap 错误:",a),0}},a.hasMap=function(a,e,t,r){var n=this.getMapKey(e,t,r);return a.data.has(n)},a.getMapKey=function(a,e,t){return a+","+e+","+t},a.getAllEntries=function(a){for(var t,r=[],n=e(a.data.values());!(t=n()).done;){var o=t.value;r.push({x:o.x,y:o.y,z:o.z,value:o.w})}return r},a.clearMap=function(a){a.data.clear(),a.size=0},a.getMapStats=function(a){for(var t,r=0,n=Number.MAX_SAFE_INTEGER,o=0,s=e(a.data.values());!(t=s()).done;){var u=t.value;0!==u.w&&(o++,r=Math.max(r,u.w),n=Math.min(n,u.w))}return 0===o&&(n=0),{size:a.size,memoryUsage:4*a.data.size*4,nonZeroEntries:o,maxValue:r,minValue:n}},a.forEachNonZero=function(a,t){for(var r,n=e(a.data.values());!(r=n()).done;){var o=r.value;0!==o.w&&t(o.x,o.y,o.z,o.w)}},a.forEachInRegion=function(a,t,r,n,o,s,u,i){for(var l,c=e(a.data.values());!(l=c()).done;){var d=l.value,v=d.x,f=d.y,p=d.z,M=d.w;v>=t&&v<=o&&f>=r&&f<=s&&p>=n&&p<=u&&i(v,f,p,M)}},a.mergeMap=function(a,r,n){void 0===n&&(n=!0);for(var o,s=e(r.data);!(o=s()).done;){var u=o.value,i=u[0],l=u[1];if(n||!a.data.has(i)){var c=a.data.has(i);a.data.set(i,t({},l)),c||a.size++}}},a}());r._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelMesh.ts",["cc","./VoxelBlock.ts","./VoxelNormalCalculator.ts"],(function(e){var n,t,o,r,i;return{setters:[function(e){n=e.cclegacy,t=e.Vec3},function(e){o=e.VoxelBlockType,r=e.VoxelBlockRegistry},function(e){i=e.VoxelNormalCalculator}],execute:function(){n._RF.push({},"f865bb/pepO77l9O6+G3gOl","VoxelMesh",void 0);e("VoxelMeshGenerator",function(){function e(){}return e.makeCubeFaces=function(e,n,i,s,a,c,u,l,h){var p=this;void 0===s&&(s=o.EMPTY),void 0===a&&(a=o.EMPTY),void 0===c&&(c=o.EMPTY),void 0===u&&(u=o.EMPTY),void 0===l&&(l=o.EMPTY),void 0===h&&(h=o.EMPTY);var f=[],v=[],w=e.x,m=e.y,x=e.z,d=e.size,y=e.blockType,g=.5*d,T=[{name:"top",positions:[new t(w-g,m+g,x-g),new t(w+g,m+g,x-g),new t(w+g,m+g,x+g),new t(w-g,m+g,x+g)],normal:new t(0,1,0),shouldRender:r.isTransparent(c)},{name:"bottom",positions:[new t(w-g,m-g,x+g),new t(w+g,m-g,x+g),new t(w+g,m-g,x-g),new t(w-g,m-g,x-g)],normal:new t(0,-1,0),shouldRender:r.isTransparent(u)},{name:"front",positions:[new t(w-g,m-g,x+g),new t(w-g,m+g,x+g),new t(w+g,m+g,x+g),new t(w+g,m-g,x+g)],normal:new t(0,0,1),shouldRender:r.isTransparent(l)},{name:"back",positions:[new t(w+g,m-g,x-g),new t(w+g,m+g,x-g),new t(w-g,m+g,x-g),new t(w-g,m-g,x-g)],normal:new t(0,0,-1),shouldRender:r.isTransparent(h)},{name:"right",positions:[new t(w+g,m-g,x+g),new t(w+g,m+g,x+g),new t(w+g,m+g,x-g),new t(w+g,m-g,x-g)],normal:new t(1,0,0),shouldRender:r.isTransparent(a)},{name:"left",positions:[new t(w-g,m-g,x-g),new t(w-g,m+g,x-g),new t(w-g,m+g,x+g),new t(w-g,m-g,x+g)],normal:new t(-1,0,0),shouldRender:r.isTransparent(s)}],b=0;return T.forEach((function(e,t){if(e.shouldRender){for(var o=r.getTextureIndex(y,t),s=p.getTextureUVs(o),a=0;a<4;a++){var c={position:e.positions[a],normal:e.normal,uv:s[a],ao:n[t]?n[t][a]:1,light:i[t]?i[t][a]:0};f.push(c)}v.push(b,b+2,b+1,b,b+3,b+2),b+=4}})),{vertices:f,indices:v}},e.getTextureUVs=function(e){var n=1/16,t=3125e-7,o=t,r=.0621875,i=e%16*n,s=(15-Math.floor(e/16))*n;return[{x:i+o,y:s+r},{x:i+r,y:s+r},{x:i+r,y:s+o},{x:i+o,y:s+o}]},e.makeCube=function(e,n){var t=n.ao||Array(6).fill([1,1,1,1]),o=n.light||Array(6).fill([0,0,0,0]);return this.makeCubeFaces(e,t,o)},e.makePlant=function(e,n,o,i,s,a,c,u){void 0===a&&(a=1),void 0===c&&(c=0),void 0===u&&(u=0);for(var l=[],h=[],p=.5*i,f=r.getTextureIndex(s,0),v=this.getTextureUVs(f),w=Math.cos(u),m=Math.sin(u),x=[new t(e-p*w,n-p,o-p*m),new t(e-p*w,n+p,o-p*m),new t(e+p*w,n+p,o+p*m),new t(e+p*w,n-p,o+p*m),new t(e-p*m,n-p,o+p*w),new t(e-p*m,n+p,o+p*w),new t(e+p*m,n+p,o-p*w),new t(e+p*m,n-p,o-p*w)],d=new t(0,0,1),y=0;y<8;y++){var g={position:x[y],normal:d,uv:v[y%4],ao:a,light:c};l.push(g)}return h.push(0,2,1,0,3,2,4,6,5,4,7,6),{vertices:l,indices:h}},e.makeWireframe=function(e,n,o,r){var i=[],s=[],a=.5*r;[new t(e-a,n-a,o-a),new t(e+a,n-a,o-a),new t(e+a,n+a,o-a),new t(e-a,n+a,o-a),new t(e-a,n-a,o+a),new t(e+a,n-a,o+a),new t(e+a,n+a,o+a),new t(e-a,n+a,o+a)].forEach((function(e){var n={position:e,normal:new t(0,1,0),uv:{x:0,y:0},ao:1,light:0};i.push(n)}));return s.push.apply(s,[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),{vertices:i,indices:s}},e.combineMeshes=function(e){var n=[],t=[],o=0;return e.forEach((function(e){n.push.apply(n,e.vertices);var r=e.indices.map((function(e){return e+o}));t.push.apply(t,r),o+=e.vertices.length})),{vertices:n,indices:t}},e.extractPositions=function(e){var n=[];return e.vertices.forEach((function(e){n.push(e.position.x,e.position.y,e.position.z)})),n},e.extractNormals=function(e){var n=[];return e.vertices.forEach((function(e){n.push(e.normal.x,e.normal.y,e.normal.z)})),n},e.extractUVs=function(e){var n=[];return e.vertices.forEach((function(e){n.push(e.uv.x,e.uv.y)})),n},e.createCocosMesh=function(e){var n=this.extractPositions(e),t=this.extractUVs(e);return{positions:n,normals:i.calculateNormals(n,e.indices),uvs:t,indices:e.indices}},e.generateChunkMesh=function(e,n,t,i){var s=this;void 0===t&&(t=0),void 0===i&&(i=0);var a=[];return e.forEach((function(e){if(e.type!==o.EMPTY)if(r.isPlant(e.type)){var c=s.makePlant(e.x-t,e.y,e.z-i,1,e.type);a.push(c)}else{var u={left:n(e.x-1,e.y,e.z),right:n(e.x+1,e.y,e.z),top:n(e.x,e.y+1,e.z),bottom:n(e.x,e.y-1,e.z),front:n(e.x,e.y,e.z+1),back:n(e.x,e.y,e.z-1)},l={left:u.left,right:u.right,top:u.top,bottom:u.bottom,front:u.front,back:u.back,x:e.x-t,y:e.y,z:e.z-i,size:1,blockType:e.type},h={ao:Array(6).fill([1,1,1,1]),light:Array(6).fill([0,0,0,0])},p=s.makeCube(l,h);p.vertices.length>0&&a.push(p)}})),this.combineMeshes(a)},e}());n._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelNoise.ts",["cc"],(function(i){var t;return{setters:[function(i){t=i.cclegacy}],execute:function(){t._RF.push({},"7b6114liwtBb4vIMq64ggvR","VoxelNoise",void 0);var s=i("VoxelNoise",function(){function i(){}return i.ensureInitialized=function(){if(!this._initialized){for(var i=0;i<512;i++)this.perm[i]=this.P[255&i],this.permMod12[i]=this.perm[i]%12;this._initialized=!0}},i.fastFloor=function(i){var t=Math.floor(i);return i<t?t-1:t},i.dot2=function(i,t,s){return i[0]*t+i[1]*s},i.dot3=function(i,t,s,r){return i[0]*t+i[1]*s+i[2]*r},i.simplex2=function(i,t,s,r,e){this.ensureInitialized();for(var h=1,_=1,n=0,o=0,S=0;S<s;S++)o+=this.rawSimplex2(i*_,t*_)*h,n+=h,h*=r,_*=e;return o/n},i.rawSimplex2=function(i,t){this.ensureInitialized();var s,r,e=(i+t)*this.SIMPLEX_SKEW_FACTOR_2D,h=this.fastFloor(i+e),_=this.fastFloor(t+e),n=(h+_)*this.SIMPLEX_UNSKEW_FACTOR_2D,o=i-(h-n),S=t-(_-n);o>S?(s=1,r=0):(s=0,r=1);var E=o-s+this.SIMPLEX_UNSKEW_FACTOR_2D,a=S-r+this.SIMPLEX_UNSKEW_FACTOR_2D,u=o-1+2*this.SIMPLEX_UNSKEW_FACTOR_2D,p=S-1+2*this.SIMPLEX_UNSKEW_FACTOR_2D,M=255&h,m=255&_,R=this.permMod12[M+this.perm[m]],l=this.permMod12[M+s+this.perm[m+r]],A=this.permMod12[M+1+this.perm[m+1]],d=.5-o*o-S*S,D=.5-E*E-a*a,F=.5-u*u-p*p;return 70*((d<0?0:(d*=d)*d*this.dot2(this.GRAD3[R],o,S))+(D<0?0:(D*=D)*D*this.dot2(this.GRAD3[l],E,a))+(F<0?0:(F*=F)*F*this.dot2(this.GRAD3[A],u,p)))},i.simplex3=function(i,t,s,r,e,h){this.ensureInitialized();for(var _=1,n=1,o=0,S=0,E=0;E<r;E++)S+=this.rawSimplex3(i*n,t*n,s*n)*_,o+=_,_*=e,n*=h;return S/o},i.rawSimplex3=function(i,t,s){this.ensureInitialized();var r,e,h,_,n,o,S=(i+t+s)*this.SIMPLEX_SKEW_FACTOR_3D,E=this.fastFloor(i+S),a=this.fastFloor(t+S),u=this.fastFloor(s+S),p=(E+a+u)*this.SIMPLEX_UNSKEW_FACTOR_3D,M=i-(E-p),m=t-(a-p),R=s-(u-p);M>=m?m>=R?(r=1,e=0,h=0,_=1,n=1,o=0):M>=R?(r=1,e=0,h=0,_=1,n=0,o=1):(r=0,e=0,h=1,_=1,n=0,o=1):m<R?(r=0,e=0,h=1,_=0,n=1,o=1):M<R?(r=0,e=1,h=0,_=0,n=1,o=1):(r=0,e=1,h=0,_=1,n=1,o=0);var l=M-r+this.SIMPLEX_UNSKEW_FACTOR_3D,A=m-e+this.SIMPLEX_UNSKEW_FACTOR_3D,d=R-h+this.SIMPLEX_UNSKEW_FACTOR_3D,D=M-_+2*this.SIMPLEX_UNSKEW_FACTOR_3D,F=m-n+2*this.SIMPLEX_UNSKEW_FACTOR_3D,I=R-o+2*this.SIMPLEX_UNSKEW_FACTOR_3D,f=M-1+3*this.SIMPLEX_UNSKEW_FACTOR_3D,P=m-1+3*this.SIMPLEX_UNSKEW_FACTOR_3D,c=R-1+3*this.SIMPLEX_UNSKEW_FACTOR_3D,C=255&E,K=255&a,L=255&u,O=this.permMod12[C+this.perm[K+this.perm[L]]],T=this.permMod12[C+r+this.perm[K+e+this.perm[L+h]]],W=this.permMod12[C+_+this.perm[K+n+this.perm[L+o]]],X=this.permMod12[C+1+this.perm[K+1+this.perm[L+1]]],N=.6-M*M-m*m-R*R,U=.6-l*l-A*A-d*d,v=.6-D*D-F*F-I*I,x=.6-f*f-P*P-c*c;return 32*((N<0?0:(N*=N)*N*this.dot3(this.GRAD3[O],M,m,R))+(U<0?0:(U*=U)*U*this.dot3(this.GRAD3[T],l,A,d))+(v<0?0:(v*=v)*v*this.dot3(this.GRAD3[W],D,F,I))+(x<0?0:(x*=x)*x*this.dot3(this.GRAD3[X],f,P,c)))},i.noise2=function(i,t){return this.ensureInitialized(),this.rawSimplex2(i,t)},i.noise3=function(i,t,s){return this.ensureInitialized(),this.rawSimplex3(i,t,s)},i}());s.SIMPLEX_SKEW_FACTOR_2D=.5*(Math.sqrt(3)-1),s.SIMPLEX_UNSKEW_FACTOR_2D=(3-Math.sqrt(3))/6,s.SIMPLEX_SKEW_FACTOR_3D=1/3,s.SIMPLEX_UNSKEW_FACTOR_3D=1/6,s.GRAD3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],s.P=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],s.perm=new Array(512),s.permMod12=new Array(512),s._initialized=!1,t._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelNormalCalculator.ts",["cc"],(function(r){var n,t;return{setters:[function(r){n=r.cclegacy,t=r.Vec3}],execute:function(){n._RF.push({},"3b040j9+TVL6KizzpRNoXAG","VoxelNormalCalculator",void 0);r("VoxelNormalCalculator",function(){function r(){}return r.calculateNormals=function(r,n){for(var t=new Array(r.length).fill(0),e=0;e<n.length;e+=3){var o=3*n[e],a=3*n[e+1],u=3*n[e+2],c={x:r[o],y:r[o+1],z:r[o+2]},l={x:r[a],y:r[a+1],z:r[a+2]},x={x:r[u],y:r[u+1],z:r[u+2]},y={x:l.x-c.x,y:l.y-c.y,z:l.z-c.z},z={x:x.x-c.x,y:x.y-c.y,z:x.z-c.z},s=this.crossProduct(y,z);t[o]+=s.x,t[o+1]+=s.y,t[o+2]+=s.z,t[a]+=s.x,t[a+1]+=s.y,t[a+2]+=s.z,t[u]+=s.x,t[u+1]+=s.y,t[u+2]+=s.z}for(var f=0;f<t.length;f+=3){var i=t[f],h=t[f+1],v=t[f+2],m=Math.sqrt(i*i+h*h+v*v);m>0?(t[f]=i/m,t[f+1]=h/m,t[f+2]=v/m):(t[f]=0,t[f+1]=1,t[f+2]=0)}return t},r.crossProduct=function(r,n){return{x:r.y*n.z-r.z*n.y,y:r.z*n.x-r.x*n.z,z:r.x*n.y-r.y*n.x}},r.generateCubeNormals=function(r){for(var n=[],e=[new t(0,1,0),new t(0,-1,0),new t(0,0,1),new t(0,0,-1),new t(1,0,0),new t(-1,0,0)],o=0;o<6;o++)for(var a=0;a<4;a++)n.push(e[o]);return n},r.flattenNormals=function(r){var n=[];return r.forEach((function(r){n.push(r.x,r.y,r.z)})),n},r}());n._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelPalette.ts",["cc"],(function(t){var e;return{setters:[function(t){e=t.cclegacy}],execute:function(){e._RF.push({},"3a3ebFntm1DDaT35eU/9zGN","VoxelPalette",void 0);var r=t("ChunkPalette",function(){function t(){this.entries=[],this.indexMap=new Map,this.dirty=!1,this.storageType="uint4",this.addEntry("minecraft:air")}var e=t.prototype;return e.getOrAddIndex=function(t){var e=this.indexMap.get(t);return void 0!==e?e:this.addEntry(t)},e.addEntry=function(t){var e=this.entries.length;return this.entries.push(t),this.indexMap.set(t,e),this.dirty=!0,this.updateStorageType(),e},e.getBlockId=function(t){return t>=0&&t<this.entries.length?this.entries[t]:"minecraft:air"},e.size=function(){return this.entries.length},e.getEntries=function(){return[].concat(this.entries)},e.getStorageType=function(){return this.dirty&&this.updateStorageType(),this.storageType},e.updateStorageType=function(){var t=this.entries.length;this.storageType=t<=16?"uint4":t<=256?"uint8":"uint16",this.dirty=!1},e.getBitsPerEntry=function(){switch(this.getStorageType()){case"uint4":return 4;case"uint8":return 8;case"uint16":return 16;default:return 8}},e.createStorageArray=function(t){switch(this.getStorageType()){case"uint4":return new Uint8Array(Math.ceil(t/2));case"uint8":return new Uint8Array(t);case"uint16":return new Uint16Array(t);default:return new Uint8Array(t)}},e.writeToStorage=function(t,e,r){switch(this.getStorageType()){case"uint4":var n=Math.floor(e/2),i=e%2==1,a=t;a[n]=i?15&a[n]|(15&r)<<4:240&a[n]|15&r;break;case"uint8":case"uint16":t[e]=r}},e.readFromStorage=function(t,e){switch(this.getStorageType()){case"uint4":var r=Math.floor(e/2),n=t;return e%2==1?n[r]>>4&15:15&n[r];case"uint8":case"uint16":return t[e];default:return 0}},e.contains=function(t){return this.indexMap.has(t)},e.getStats=function(){var t=this.entries.length,e=this.getStorageType(),r=1;switch(e){case"uint4":r=.5;break;case"uint8":r=1;break;case"uint16":r=2}var n=64*t+65536*r,i=262144/n;return{entries:t,storageType:e,memoryUsage:Math.round(n),compressionRatio:Math.round(100*i)/100}},e.optimize=function(t){var e=[],r=new Map,n=new Map;e.push("minecraft:air"),r.set("minecraft:air",0),n.set(0,0);for(var i=1,a=1;a<this.entries.length;a++){if((t.get(a)||0)>0){var s=this.entries[a];e.push(s),r.set(s,i),n.set(a,i),i++}}return e.length<this.entries.length&&(this.entries=e,this.indexMap=r,this.dirty=!0,console.log("[ChunkPalette] 优化完成："+this.entries.length+" -> "+e.length+" 条目")),n},e.clone=function(){var e=new t;return e.entries=[].concat(this.entries),e.indexMap=new Map(this.indexMap),e.storageType=this.storageType,e.dirty=this.dirty,e},e.reset=function(){this.entries=["minecraft:air"],this.indexMap.clear(),this.indexMap.set("minecraft:air",0),this.storageType="uint4",this.dirty=!1},e.serialize=function(){return{entries:[].concat(this.entries),storageType:this.getStorageType()}},t.deserialize=function(e){var r=new t;return r.entries=[].concat(e.entries),r.indexMap.clear(),e.entries.forEach((function(t,e){r.indexMap.set(t,e)})),r.storageType=e.storageType,r.dirty=!1,r},t}()),n=t("PaletteManager",function(){function t(){}return t.registerPalette=function(t){this.totalPalettes++,this.totalMemoryUsage+=t.getStats().memoryUsage},t.unregisterPalette=function(t){this.totalPalettes=Math.max(0,this.totalPalettes-1),this.totalMemoryUsage=Math.max(0,this.totalMemoryUsage-t.getStats().memoryUsage)},t.getGlobalStats=function(){return{totalPalettes:this.totalPalettes,totalMemoryUsage:this.totalMemoryUsage,averageMemoryPerPalette:this.totalPalettes>0?Math.round(this.totalMemoryUsage/this.totalPalettes):0}},t.createSingleBlockPalette=function(t){var e=new r;return"minecraft:air"!==t&&e.getOrAddIndex(t),e},t}());n.totalPalettes=0,n.totalMemoryUsage=0,e._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelRayCaster.ts",["cc","./VoxelBlock.ts"],(function(o){var t,e,r;return{setters:[function(o){t=o.cclegacy,e=o.Vec3},function(o){r=o.VoxelBlockType}],execute:function(){t._RF.push({},"32260+2Y2xPLqPZY9YUYmQ+","VoxelRayCaster",void 0);var a=o("RaycastAlgorithm",function(o){return o[o.SIMPLE=0]="SIMPLE",o[o.DDA=1]="DDA",o[o.AMANATIDES_WOO=2]="AMANATIDES_WOO",o}({}));o("VoxelRayCaster",function(){function o(){}o.setAlgorithm=function(t){o.currentAlgorithm=t,console.log("[VoxelRayCaster] 切换到算法: "+a[t])},o.getAlgorithm=function(){return o.currentAlgorithm};var t=o.prototype;return t.raycast=function(t,e,r,l){switch(o.currentAlgorithm){case a.SIMPLE:return this.raycastSimple(t,e,r,l);case a.DDA:return this.raycastDDA(t,e,r,l);case a.AMANATIDES_WOO:return this.raycastAmanatidesWoo(t,e,r,l);default:return console.warn("[VoxelRayCaster] 未知算法类型: "+o.currentAlgorithm+"，使用简单算法"),this.raycastSimple(t,e,r,l)}},t.raycastSimple=function(o,t,a,l){var n=t.clone().normalize(),i=Math.floor(32*a),c=a/i;console.log("[VoxelRayCaster-简单] 开始射线投射: "+i+"步, 步长="+c.toFixed(4));for(var s=0,u=new e(-999,-999,-999),x=0;x<i;x++){var y=o.clone().add(n.clone().multiplyScalar(x*c)),h=this.worldToBlockPosition(y);if(!h.equals(u)){s++,u=h.clone();var A=void 0;if(A=l.getBlockAt?l.getBlockAt(h.x,h.y,h.z):this.getBlockFromMap(h,l.voxelMap),(s<=5||A!==r.EMPTY)&&console.log("[VoxelRayCaster-简单] 检查方块("+h.x+", "+h.y+", "+h.z+") = "+A),A!==r.EMPTY){var g=this.calculateHitFace(y,h),m=this.getFaceNormal(g),f=this.blockToWorldPosition(h);return console.log("[VoxelRayCaster-简单] ✓ 击中方块! 位置:("+h.x+", "+h.y+", "+h.z+"), 面:"+g+", 类型:"+A),{hit:!0,position:h,worldPosition:f,blockType:A,face:g,normal:m}}}}return console.log("[VoxelRayCaster-简单] ✗ 射线投射完成: 检查了"+s+"个方块，未击中任何目标"),{hit:!1}},t.raycastDDA=function(o,t,a,l){var n,i,c,s,u,x,y=t.clone().normalize(),h=Math.floor(o.x),A=Math.floor(o.y),g=Math.floor(o.z),m=Math.abs(1/y.x),f=Math.abs(1/y.y),d=Math.abs(1/y.z);y.x<0?(n=-1,i=(o.x-h)*m):(n=1,i=(h+1-o.x)*m),y.y<0?(c=-1,s=(o.y-A)*f):(c=1,s=(A+1-o.y)*f),y.z<0?(u=-1,x=(o.z-g)*d):(u=1,x=(g+1-o.z)*d),console.log("[VoxelRayCaster-DDA] 开始DDA射线投射: 起点("+o.x.toFixed(2)+", "+o.y.toFixed(2)+", "+o.z.toFixed(2)+")"),console.log("[VoxelRayCaster-DDA] 方向("+y.x.toFixed(2)+", "+y.y.toFixed(2)+", "+y.z.toFixed(2)+")");for(var M=!1,F=0,I=0,T=0;!M&&I<a;){i<s&&i<x?(I=i,i+=m,h+=n,F=0):s<x?(I=s,s+=f,A+=c,F=1):(I=x,x+=d,g+=u,F=2),T++;var v=void 0;if(l.getBlockAt)v=l.getBlockAt(h,A,g);else{var D=new e(h,A,g);v=this.getBlockFromMap(D,l.voxelMap)}if((T<=5||v!==r.EMPTY)&&console.log("[VoxelRayCaster-DDA] 检查方块("+h+", "+A+", "+g+") = "+v+", 距离="+I.toFixed(2)),v!==r.EMPTY){M=!0;var P=I,p=(o.clone().add(y.clone().multiplyScalar(P)),new e(h,A,g)),z=this.calculateHitFaceFromSide(F,n,c,u),V=this.getFaceNormal(z),k=this.blockToWorldPosition(p);return console.log("[VoxelRayCaster-DDA] ✓ 击中方块! 位置:("+h+", "+A+", "+g+"), 面:"+z+", 类型:"+v+", 距离:"+P.toFixed(2)),{hit:!0,position:p,worldPosition:k,blockType:v,face:z,normal:V}}}return console.log("[VoxelRayCaster-DDA] ✗ DDA射线投射完成: 检查了"+T+"个方块，未击中任何目标，最大距离:"+I.toFixed(2)),{hit:!1}},t.raycastAmanatidesWoo=function(o,t,a,l){var n=t.clone().normalize();console.log("[VoxelRayCaster-AW] 开始Amanatides-Woo射线投射: 起点("+o.x.toFixed(2)+", "+o.y.toFixed(2)+", "+o.z.toFixed(2)+")"),console.log("[VoxelRayCaster-AW] 方向("+n.x.toFixed(2)+", "+n.y.toFixed(2)+", "+n.z.toFixed(2)+")");var i,c,s,u,x,y,h=Math.floor(o.x),A=Math.floor(o.y),g=Math.floor(o.z),m=n.x>=0?1:-1,f=n.y>=0?1:-1,d=n.z>=0?1:-1;0===n.x?(i=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY):(i=m>0?(h+1-o.x)/n.x:(o.x-h)/n.x,u=Math.abs(1/n.x)),0===n.y?(c=Number.POSITIVE_INFINITY,x=Number.POSITIVE_INFINITY):(c=f>0?(A+1-o.y)/n.y:(o.y-A)/n.y,x=Math.abs(1/n.y)),0===n.z?(s=Number.POSITIVE_INFINITY,y=Number.POSITIVE_INFINITY):(s=d>0?(g+1-o.z)/n.z:(o.z-g)/n.z,y=Math.abs(1/n.z));for(var M=0,F=0,I=new e(0,1,0);F<a;){M++;var T=void 0;if(l.getBlockAt)T=l.getBlockAt(h,A,g);else{var v=new e(h,A,g);T=this.getBlockFromMap(v,l.voxelMap)}if((M<=5||T!==r.EMPTY)&&console.log("[VoxelRayCaster-AW] 检查方块("+h+", "+A+", "+g+") = "+T+", t="+F.toFixed(3)),T!==r.EMPTY){o.clone().add(n.clone().multiplyScalar(F));var D=new e(h,A,g),P=void 0;i-u<=c-x&&i-u<=s-y?(I=new e(-m,0,0),P=m>0?5:4):c-x<=s-y?(I=new e(0,-f,0),P=f>0?1:0):(I=new e(0,0,-d),P=d>0?3:2);var p=this.blockToWorldPosition(D);return console.log("[VoxelRayCaster-AW] ✓ 击中方块! 位置:("+h+", "+A+", "+g+"), 面:"+P+", 类型:"+T+", t:"+F.toFixed(3)),{hit:!0,position:D,worldPosition:p,blockType:T,face:P,normal:I}}i<c&&i<s?(F=i,i+=u,h+=m):c<s?(F=c,c+=x,A+=f):(F=s,s+=y,g+=d)}return console.log("[VoxelRayCaster-AW] ✗ Amanatides-Woo射线投射完成: 检查了"+M+"个方块，未击中任何目标，最大t:"+F.toFixed(3)),{hit:!1}},t.worldToBlockPosition=function(o){return new e(Math.floor(o.x),Math.floor(o.y),Math.floor(o.z))},t.blockToWorldPosition=function(o){return new e(o.x+.5,o.y+.5,o.z+.5)},t.getBlockFromMap=function(o,t){var e=this.getBlockKey(o.x,o.y,o.z);return t.get(e)||r.EMPTY},t.getBlockKey=function(o,t,e){return o+","+t+","+e},t.calculateHitFaceFromSide=function(o,t,e,r){return 0===o?t>0?5:4:1===o?e>0?1:0:r>0?3:2},t.calculateHitFace=function(o,t){var e=o.clone().subtract(t),r=Math.abs(e.x-.5),a=Math.abs(e.y-.5),l=Math.abs(e.z-.5);return a>r&&a>l?e.y>.5?0:1:l>r?e.z>.5?2:3:e.x>.5?4:5},t.getFaceNormal=function(o){return[new e(0,1,0),new e(0,-1,0),new e(0,0,1),new e(0,0,-1),new e(1,0,0),new e(-1,0,0)][o]||new e(0,1,0)},t.raycastBlocks=function(o,t,e,r){return this.raycast(o,t,e,{voxelMap:new Map,getBlockAt:r})},o.setSimpleAlgorithm=function(){this.setAlgorithm(a.SIMPLE)},o.setDDAAlgorithm=function(){this.setAlgorithm(a.DDA)},o.setAmanatidesWooAlgorithm=function(){this.setAlgorithm(a.AMANATIDES_WOO)},o.getCurrentAlgorithmName=function(){return a[this.currentAlgorithm]},o}()).currentAlgorithm=a.SIMPLE,t._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelRenderer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelMesh.ts","./VoxelChunk.ts","./VoxelWorld.ts","./VoxelConfig.ts","./VoxelWorldConfig.ts","./VoxelInteractionManager.ts"],(function(e){var o,t,n,r,i,a,s,l,c,d,h,u,g,M,f,k,C,R,y,w,p,x,N;return{setters:[function(e){o=e.applyDecoratedDescriptor,t=e.inheritsLoose,n=e.initializerDefineProperty,r=e.assertThisInitialized,i=e.extends},function(e){a=e.cclegacy,s=e._decorator,l=e.Material,c=e.Camera,d=e.Node,h=e.Enum,u=e.utils,g=e.MeshRenderer,M=e.Vec3,f=e.Component},function(e){k=e.VoxelMeshGenerator},function(e){C=e.VoxelChunkManager},function(e){R=e.VoxelWorld},function(e){y=e.VoxelRenderMode,w=e.VoxelConfig},function(e){p=e.VoxelWorldConfig,x=e.VoxelWorldMode},function(e){N=e.VoxelInteractionManager}],execute:function(){var m,v,V,b,E,_,I,S,U,D,z,B,H,K,A;a._RF.push({},"7e05dFRvsNJnpuu6j2kwAih","VoxelRenderer",void 0);var T=s.ccclass,P=s.property;e("VoxelRenderer",(m=T("VoxelRenderer"),v=P(l),V=P(l),b=P(c),E=P(d),_=P({type:h(y),displayName:"渲染模式"}),I=P(N),m((D=o((U=function(e){function o(){for(var o,t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];return o=e.call.apply(e,[this].concat(i))||this,n(o,"blockMaterial",D,r(o)),n(o,"skyMaterial",z,r(o)),n(o,"camera",B,r(o)),n(o,"worldRoot",H,r(o)),n(o,"renderMode",K,r(o)),n(o,"interactionManager",A,r(o)),o.world=null,o.chunkNodes=new Map,o.blockNodes=new Map,o.timer=0,o.daylight=1,o.fogDistance=w.FOG_DISTANCE_DEFAULT,o}t(o,e);var a=o.prototype;return a.onLoad=function(){this.worldRoot||(this.worldRoot=new d("VoxelWorld"),this.node.addChild(this.worldRoot)),this.camera||console.warn("[VoxelRenderer] 请在Inspector中设置Camera引用"),this.world=new R,this.world.initialize().catch((function(e){console.error("[VoxelRenderer] 世界初始化失败:",e)})),this.initializeInteractionSystem()},a.initializeInteractionSystem=function(){var e,o,t=this;if(console.log("[VoxelRenderer] 开始初始化交互系统..."),this.interactionManager||(console.log("[VoxelRenderer] 在节点上查找VoxelInteractionManager组件..."),this.interactionManager=this.getComponent(N)),!this.interactionManager)return console.warn("[VoxelRenderer] 未找到VoxelInteractionManager组件，交互功能将不可用"),void console.warn("[VoxelRenderer] 请在同一节点上添加VoxelInteractionManager、VoxelCameraController、VoxelCollisionSystem组件");console.log("[VoxelRenderer] 找到VoxelInteractionManager组件，设置事件回调...");var n={onBlockClick:function(e){console.log("[VoxelRenderer] 方块点击事件:",e)},onBlockHover:function(e){},onBlockPlace:function(e,o){console.log("[VoxelRenderer] 方块放置事件: 位置("+e.x+", "+e.y+", "+e.z+") 类型:"+o),t.markChunkForUpdate(e)},onBlockBreak:function(e){console.log("[VoxelRenderer] 方块破坏事件: 位置("+e.x+", "+e.y+", "+e.z+")"),t.markChunkForUpdate(e)},onModeChange:function(e){console.log("[VoxelRenderer] 摄像机模式切换事件: "+e)}};if(this.world){this.interactionManager.initialize(this.world,n),console.log("[VoxelRenderer] 交互系统初始化完成");var r=null==(e=(o=this.interactionManager).getCollisionSystem)?void 0:e.call(o);console.log("[VoxelRenderer] 交互系统状态:"),console.log("  - InteractionManager: "+(this.interactionManager?"✓":"✗")),console.log("  - CollisionSystem: "+(r?"✓":"✗")),console.log("  - WorldManager: "+(this.worldManager?"✓":"✗")),console.log("  - Camera: "+(this.camera?"✓":"✗"))}else console.error("[VoxelRenderer] 体素世界未初始化，无法完成交互系统初始化")},a.markChunkForUpdate=function(e){var o=this;if(this.worldManager){var t=C.getChunkCoords(e.x,e.z),n=t.p,r=t.q,i=this.worldManager.getChunk(n,r);if(i)C.markChunkDirty(i),C.getNeighborChunkCoords(n,r).forEach((function(e){var t=e.p,n=e.q,r=o.worldManager.getChunk(t,n);r&&C.markChunkDirty(r)}))}},a.update=function(e){if(this.timer+=e,this.updateShaderUniforms(),this.camera&&this.worldManager){var o=this.camera.node.worldPosition;this.worldManager.updateChunksAroundPlayer(o.x,o.z),this.renderVisibleChunks()}},a.updateShaderUniforms=function(){this.blockMaterial&&(this.blockMaterial.setProperty("timer",this.timer%(2*Math.PI)),this.blockMaterial.setProperty("daylight",this.daylight),this.blockMaterial.setProperty("fogDistance",this.fogDistance),this.blockMaterial.setProperty("ortho",0)),this.skyMaterial&&this.skyMaterial.setProperty("timer",this.timer%(2*Math.PI))},a.renderVisibleChunks=function(){var e=this;if(this.camera&&this.worldManager){var o=this.camera.node.worldPosition,t=this.worldManager.getRenderableChunks(o.x,o.z),n=new Set;t.forEach((function(o){var t=e.getChunkKey(o.p,o.q);n.add(t),C.isChunkDirty(o)&&(e.updateChunkMesh(o),C.clearChunkDirtyFlag(o)),e.ensureChunkNode(o)})),this.removeUnusedChunkNodes(n)}},a.updateChunkMesh=function(e){var o=[];if(C.forEachBlock(e,(function(e,t,n,r){r>0&&o.push({x:e,y:t,z:n,type:r})})),0===o.length)return this.removeChunkNode(e.p,e.q),void this.removeChunkBlockNodes(e.p,e.q);this.renderMode===y.MERGED_CHUNK?this.updateChunkMeshMerged(e,o):this.updateChunkMeshIndividual(e,o)},a.updateChunkMeshMerged=function(e,o){var t=this,n=e.p*w.CHUNK_SIZE,r=e.q*w.CHUNK_SIZE,i=k.generateChunkMesh(o,(function(e,o,n){return t.worldManager?t.worldManager.getBlock(e,o,n):VoxelBlockType.EMPTY}),n,r);if(0!==i.vertices.length){var a=k.createCocosMesh(i),s=u.MeshUtils.createMesh(a),l=this.getOrCreateChunkNode(e).getComponent(g);l&&(l.mesh=s),e.faces=i.indices.length/3,this.removeChunkBlockNodes(e.p,e.q)}else this.removeChunkNode(e.p,e.q)},a.updateChunkMeshIndividual=function(e,o){var t=this,n=function(e,o,n){return t.worldManager?t.worldManager.getBlock(e,o,n):VoxelBlockType.EMPTY};this.removeChunkBlockNodes(e.p,e.q),o.forEach((function(e){var o={left:n(e.x-1,e.y,e.z),right:n(e.x+1,e.y,e.z),top:n(e.x,e.y+1,e.z),bottom:n(e.x,e.y-1,e.z),front:n(e.x,e.y,e.z+1),back:n(e.x,e.y,e.z-1)},r={left:o.left,right:o.right,top:o.top,bottom:o.bottom,front:o.front,back:o.back,x:0,y:0,z:0,size:1,blockType:e.type},i={ao:Array(6).fill([1,1,1,1]),light:Array(6).fill([0,0,0,0])},a=k.makeCube(r,i);if(a.vertices.length>0){var s=k.createCocosMesh(a),l=u.MeshUtils.createMesh(s),c=t.getOrCreateBlockNode(e.x,e.y,e.z,e.type).getComponent(g);c&&(c.mesh=l)}}));var r=0;o.forEach((function(e){var o=t.getBlockKey(e.x,e.y,e.z),n=t.blockNodes.get(o);if(n){var i=n.getComponent(g);if(null!=i&&i.mesh)try{var a=i.mesh.readIndices(0);r+=a?a.length/3:0}catch(e){}}})),e.faces=r},a.ensureChunkNode=function(e){e.node||(e.node=this.getOrCreateChunkNode(e))},a.getOrCreateChunkNode=function(e){var o=this.getChunkKey(e.p,e.q),t=this.chunkNodes.get(o);if(!t){t=new d("Chunk_"+e.p+"_"+e.q),this.worldRoot&&this.worldRoot.addChild(t);var n=C.getChunkWorldPosition(e);t.setPosition(n.x,0,n.z);var r=t.addComponent(g);this.blockMaterial&&(r.material=this.blockMaterial),this.chunkNodes.set(o,t),e.node=t}return t},a.removeChunkNode=function(e,o){var t=this.getChunkKey(e,o),n=this.chunkNodes.get(t);if(n&&n.isValid){try{n.destroy()}catch(e){console.warn("[VoxelRenderer] 移除chunk节点时出错: "+t,e)}this.chunkNodes.delete(t)}},a.removeUnusedChunkNodes=function(e){var o=this,t=[];this.chunkNodes.forEach((function(o,n){e.has(n)||t.push(n)})),t.forEach((function(e){var t=o.chunkNodes.get(e);if(t&&t.isValid){try{t.destroy()}catch(o){console.warn("[VoxelRenderer] 移除未使用chunk节点时出错: "+e,o)}o.chunkNodes.delete(e)}}))},a.getChunkKey=function(e,o){return e+"_"+o},a.getBlockKey=function(e,o,t){return e+"_"+o+"_"+t},a.getOrCreateBlockNode=function(e,o,t,n){var r=this.getBlockKey(e,o,t),i=this.blockNodes.get(r);if(!i||!i.isValid){i&&!i.isValid&&this.blockNodes.delete(r);try{i=new d("Block_"+e+"_"+o+"_"+t+"_"+n);var a=Math.floor(e/w.CHUNK_SIZE),s=Math.floor(t/w.CHUNK_SIZE);this.getOrCreateChunkContainerNode(a,s).addChild(i);var l=e-a*w.CHUNK_SIZE,c=t-s*w.CHUNK_SIZE;i.setPosition(l,o,c);var h=i.addComponent(g);this.blockMaterial&&(h.material=this.blockMaterial),this.blockNodes.set(r,i)}catch(e){throw console.error("[VoxelRenderer] 创建块节点失败: "+r,e),e}}return i},a.getOrCreateChunkContainerNode=function(e,o){var t=this.getChunkKey(e,o),n=this.chunkNodes.get(t);if(!n||!n.isValid){n&&!n.isValid&&this.chunkNodes.delete(t);try{n=new d("ChunkContainer_"+e+"_"+o),this.worldRoot&&this.worldRoot.addChild(n);var r=e*w.CHUNK_SIZE,i=o*w.CHUNK_SIZE;n.setPosition(r,0,i),this.chunkNodes.set(t,n)}catch(e){throw console.error("[VoxelRenderer] 创建chunk容器节点失败: "+t,e),e}}return n},a.removeBlockNode=function(e,o,t){var n=this.getBlockKey(e,o,t),r=this.blockNodes.get(n);if(r&&r.isValid){try{r.destroy()}catch(e){console.warn("[VoxelRenderer] 节点已被销毁或无效: "+n,e)}this.blockNodes.delete(n)}},a.removeChunkBlockNodes=function(e,o){var t=this,n=e*w.CHUNK_SIZE,r=(e+1)*w.CHUNK_SIZE,i=o*w.CHUNK_SIZE,a=(o+1)*w.CHUNK_SIZE,s=[];this.blockNodes.forEach((function(e,o){var t=o.split("_").map(Number),l=t[0],c=t[2];l>=n&&l<r&&c>=i&&c<a&&s.push(o)})),s.forEach((function(e){var o=t.blockNodes.get(e);if(o&&o.isValid){try{o.destroy()}catch(o){console.warn("[VoxelRenderer] 块节点已被销毁或无效: "+e,o)}t.blockNodes.delete(e)}}));var l=this.getChunkKey(e,o),c=this.chunkNodes.get(l);if(c&&c.isValid&&0===c.children.length){try{c.destroy()}catch(e){console.warn("[VoxelRenderer] 区块容器节点已被销毁或无效: "+l,e)}this.chunkNodes.delete(l)}},a.setBlock=function(e,o,t,n){return!!this.worldManager&&this.worldManager.setBlock(e,o,t,n)},a.getBlock=function(e,o,t){return this.worldManager?this.worldManager.getBlock(e,o,t):VoxelBlockType.EMPTY},a.getHeightAt=function(e,o){return this.worldManager?this.worldManager.getHeightAt(e,o):0},a.raycast=function(e,o,t){return void 0===t&&(t=100),this.worldManager?this.worldManager.raycast(e.x,e.y,e.z,o.x,o.y,o.z,t):{hit:!1}},a.setDaylight=function(e){this.daylight=Math.max(0,Math.min(1,e))},a.setFogDistance=function(e){this.fogDistance=Math.max(10,e)},a.setCreateRadius=function(e){this.worldManager&&this.worldManager.setCreateRadius(e)},a.setRenderRadius=function(e){this.worldManager&&this.worldManager.setRenderRadius(e)},a.setDeleteRadius=function(e){this.worldManager&&this.worldManager.setDeleteRadius(e)},a.clearWorld=function(){this.chunkNodes.forEach((function(e,o){if(e&&e.isValid)try{e.destroy()}catch(e){console.warn("[VoxelRenderer] 清理chunk节点时出错: "+o,e)}})),this.chunkNodes.clear(),this.blockNodes.forEach((function(e,o){if(e&&e.isValid)try{e.destroy()}catch(e){console.warn("[VoxelRenderer] 清理block节点时出错: "+o,e)}})),this.blockNodes.clear(),this.worldManager&&this.worldManager.clear()},a.getWorldStatistics=function(){if(!this.worldManager)return{totalChunks:0,loadedChunks:0,renderedChunks:0,renderedBlocks:0,createRadius:0,renderRadius:0,deleteRadius:0,renderMode:this.renderMode};var e=this.worldManager.getStatistics();return i({},e,{renderedChunks:this.chunkNodes.size,renderedBlocks:this.blockNodes.size,renderMode:this.renderMode})},a.generateAroundPosition=function(e,o,t){if(void 0===t&&(t=5),this.worldManager)for(var n=C.getChunkCoords(e,o),r=n.p,i=n.q,a=-t;a<=t;a++)for(var s=-t;s<=t;s++){var l=r+a,c=i+s;this.worldManager.isChunkLoaded(l,c)||this.worldManager.generateChunk(l,c)}},a.findSpawnLocation=function(){if(!this.worldManager)return p.getMode()===x.SMALL_FLAT?new M(0,3,0):new M(0,10,0);var e=this.worldManager.findSpawnLocation();return p.getMode()===x.SMALL_FLAT?new M(e.x,3,e.z):new M(e.x,e.y,e.z)},a.switchWorldMode=function(e){console.log("[VoxelRenderer] 切换世界模式: "+e),p.setMode(e),this.clearWorld(),this.worldManager=new VoxelWorldManager,this.applyWorldModeSettings(e)},a.applyWorldModeSettings=function(e){var o=p.getConfig();switch(e){case x.NORMAL:this.setFogDistance(150),this.worldManager&&(this.worldManager.setCreateRadius(o.CREATE_CHUNK_RADIUS),this.worldManager.setRenderRadius(o.RENDER_CHUNK_RADIUS),this.worldManager.setDeleteRadius(o.DELETE_CHUNK_RADIUS)),console.log("[VoxelRenderer] 标准世界设置: "+o.CHUNK_SIZE+"x"+o.CHUNK_SIZE+"x"+o.MAX_HEIGHT);break;case x.SMALL_FLAT:this.setFogDistance(80),this.worldManager&&(this.worldManager.setCreateRadius(o.CREATE_CHUNK_RADIUS),this.worldManager.setRenderRadius(o.RENDER_CHUNK_RADIUS),this.worldManager.setDeleteRadius(o.DELETE_CHUNK_RADIUS)),console.log("[VoxelRenderer] 小平坦世界设置: "+o.CHUNK_SIZE+"x"+o.CHUNK_SIZE+"x"+o.MAX_HEIGHT);break;case x.TINY_DEBUG:this.setFogDistance(40),this.worldManager&&(this.worldManager.setCreateRadius(o.CREATE_CHUNK_RADIUS),this.worldManager.setRenderRadius(o.RENDER_CHUNK_RADIUS),this.worldManager.setDeleteRadius(o.DELETE_CHUNK_RADIUS)),console.log("[VoxelRenderer] 微调试世界设置: "+o.CHUNK_SIZE+"x"+o.CHUNK_SIZE+"x"+o.MAX_HEIGHT)}console.log("[VoxelRenderer] 世界信息: "+p.getWorldInfo())},a.getCurrentWorldMode=function(){return p.getMode()},a.getWorldModeInfo=function(){return p.getWorldInfo()},a.regenerateWorld=function(){if(console.log("[VoxelRenderer] 重新生成世界"),this.clearWorld(),this.camera&&this.worldManager){var e=this.camera.node.worldPosition;this.generateAroundPosition(e.x,e.z,3)}},a.setRenderMode=function(e){if(this.renderMode!==e){var o=this.renderMode;if(this.renderMode=e,console.log("[VoxelRenderer] 切换渲染模式: "+o+" → "+e),this.worldManager)this.worldManager.getLoadedChunks().forEach((function(e){C.markChunkDirty(e)}))}},a.getCurrentRenderMode=function(){return this.renderMode},a.getRenderModeInfo=function(){var e=this.chunkNodes.size,o=this.blockNodes.size;return"渲染模式: "+this.renderMode+"\nChunk节点数: "+e+"\nBlock节点数: "+o+"\n总节点数: "+(e+o)},a.debugPrintNodeHierarchy=function(){console.log("[VoxelRenderer] 节点层级结构:"),console.log("渲染模式: "+this.renderMode),this.renderMode===y.MERGED_CHUNK?(console.log("合并模式结构: WorldRoot → ChunkNode (with MeshRenderer)"),this.chunkNodes.forEach((function(e,o){var t=e.getComponent(g),n=t&&t.mesh?"✓":"✗";console.log("  └─ Chunk_"+o+" [Mesh: "+n+"]")}))):(console.log("独立模式结构: WorldRoot → ChunkContainer → BlockNode (with MeshRenderer)"),this.chunkNodes.forEach((function(e,o){console.log("  └─ ChunkContainer_"+o+" ("+e.children.length+" blocks)"),e.children.forEach((function(e){var o=e.getComponent(g),t=o&&o.mesh?"✓":"✗";console.log("    └─ "+e.name+" [Mesh: "+t+"]")}))}))),console.log("总计: "+this.chunkNodes.size+" chunk节点, "+this.blockNodes.size+" block节点")},a.debugToggleCullMode=function(){console.log("[VoxelRenderer] 面剔除调试信息:"),console.log("- 顶点索引已调整为顺时针（CW）顺序"),console.log("- effect文件中设置了cullMode: back"),console.log("- 如果面朝向仍有问题，请在Inspector中调整Material设置"),console.log("可选值: front, back, none")},a.debugPrintMeshInfo=function(){console.log("[VoxelRenderer] 网格调试信息:"),console.log("已渲染区块数量: "+this.chunkNodes.size),this.chunkNodes.forEach((function(e,o){var t=e.getComponent(g);if(t&&t.mesh){var n=t.mesh;try{var r=n.readIndices(0),i=r?r.length:0;console.log("区块 "+o+": 三角形="+i/3)}catch(e){console.log("区块 "+o+": 无法读取mesh数据")}}}))},a.getInteractionManager=function(){return this.interactionManager},a.setSelectedBlockType=function(e){this.interactionManager&&this.interactionManager.setSelectedBlockType(e)},a.getSelectedBlockType=function(){return this.interactionManager?this.interactionManager.getSelectedBlockType():null},a.toggleCameraMode=function(){this.interactionManager&&this.interactionManager.toggleCameraMode()},a.setCameraMode=function(e){this.interactionManager&&this.interactionManager.setCameraMode(e)},a.getCurrentCameraMode=function(){return this.interactionManager?this.interactionManager.getCurrentCameraMode():null},a.performRaycast=function(e,o){return this.interactionManager?this.interactionManager.performRaycast(e,o):{hit:!1}},a.placeBlock=function(e,o){return!!this.interactionManager&&this.interactionManager.placeBlock(e,o)},a.breakBlock=function(e){return!!this.interactionManager&&this.interactionManager.breakBlock(e)},a.setInteractionEventCallbacks=function(e){this.interactionManager&&this.interactionManager.setEventCallbacks(e)},a.debugPrintInteractionInfo=function(){if(console.log("[VoxelRenderer] 交互系统调试信息:"),this.interactionManager){var e=this.getCurrentCameraMode(),o=this.getSelectedBlockType(),t=this.interactionManager.getLastHoverResult();if(console.log("摄像机模式: "+e),console.log("选中方块类型: "+o),console.log("悬停结果:",t),this.camera){var n=this.camera.node.getWorldPosition();console.log("摄像机位置: ("+n.x.toFixed(2)+", "+n.y.toFixed(2)+", "+n.z.toFixed(2)+")")}var r=this.performRaycast();console.log("射线投射结果（屏幕中心）:",r)}else console.log("交互管理器: 未初始化")},a.onDestroy=function(){console.log("[VoxelRenderer] 销毁中...");try{this.clearWorld()}catch(e){console.warn("[VoxelRenderer] 销毁时出错:",e)}console.log("[VoxelRenderer] 销毁完成")},o}(f)).prototype,"blockMaterial",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),z=o(U.prototype,"skyMaterial",[V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B=o(U.prototype,"camera",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H=o(U.prototype,"worldRoot",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K=o(U.prototype,"renderMode",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return y.MERGED_CHUNK}}),A=o(U.prototype,"interactionManager",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S=U))||S));a._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelSystem.ts",["./rollupPluginModLoBabelHelpers.js","cc","./BlockParser.ts","./TextureManager.ts","./MaterialFactory.ts","./MeshBuilder.ts","./VoxelBlock.ts","./Web3BlockTypes.ts"],(function(e){var t,r,n,a,o,s,i,c,l,u,h,f,p,b,k;return{setters:[function(e){t=e.createForOfIteratorHelperLoose,r=e.asyncToGenerator,n=e.regeneratorRuntime},function(e){a=e.cclegacy,o=e.MeshRenderer,s=e.Node},function(e){i=e.BlockParser},function(e){c=e.initializeGlobalTextureManager},function(e){l=e.initializeGlobalMaterialFactory},function(e){u=e.MeshBuilder},function(e){h=e.BlockRegistry},function(e){f=e.getAllWeb3BlockIds,p=e.getWeb3TileBlocks,b=e.getWeb3ObjectBlocks,k=e.WEB3_BLOCKS}],execute:function(){e({getVoxelSystem:function(){return x.getInstance()},isVoxelSystemReady:function(){return x.getInstance().getSystemStatus().initialized}}),a._RF.push({},"b439ezAGQRPtLbkah0odxNo","VoxelSystem",void 0);var x=e("VoxelSystem",function(){function e(){this.blockParser=void 0,this.textureManager=void 0,this.materialFactory=void 0,this.blockCache=new Map,this.initialized=!1,this.overlayEnabled=!1,this.rootDir="voxel/resource_pack",this.blockParser=new i({rootDir:this.rootDir,searchRoots:[this.rootDir],defaultNamespace:"minecraft"}),this.textureManager=c(),this.materialFactory=l(this.textureManager)}e.getInstance=function(){return e.instance||(e.instance=new e),e.instance};var a=e.prototype;return a.initialize=function(){var e=r(n().mark((function e(t){return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.initialized){e.next=3;break}return console.log("[VoxelSystem] 系统已初始化"),e.abrupt("return",!0);case 3:return console.log("[VoxelSystem] 开始初始化体素渲染系统..."),e.prev=4,e.next=7,this.textureManager.initialize(this.rootDir);case 7:return h.exists("minecraft:stone")||console.warn("[VoxelSystem] 方块注册表未正确初始化"),this.initialized=!0,console.log("[VoxelSystem] 体素系统初始化完成"),this.logSystemStats(),e.abrupt("return",!0);case 14:return e.prev=14,e.t0=e.catch(4),console.error("[VoxelSystem] 初始化失败:",e.t0),e.abrupt("return",!1);case 18:case"end":return e.stop()}}),e,this,[[4,14]])})));return function(t){return e.apply(this,arguments)}}(),a.generateBlockMesh=function(){var e=r(n().mark((function e(t,r,a){var o,s,i,c,l,h,f,p;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.initialized){e.next=3;break}return console.error("[VoxelSystem] 系统未初始化"),e.abrupt("return",null);case 3:return e.prev=3,e.next=6,this.getBlockData(t);case 6:if(o=e.sent,s={blockPosition:r,blockRotation:a||{x:0,y:o.rotationY||0,z:0},blockId:t},!this.overlayEnabled){e.next=15;break}if(!(i=this.detectOverlayInfo(o))){e.next=15;break}return console.log("[VoxelSystem] 检测到 overlay 方案: "+t+" overlay="+i.overlaySideTexture),c=u.buildOverlayBlockMeshes(o,s),l=c.baseMesh,h=c.overlayMesh,f={vertices:[],indices:[],textureGroups:new Map,hasOverlay:!0,overlayMeshes:{base:l,overlay:h},overlayInfo:i},e.abrupt("return",f);case 15:return p=u.buildMesh(o,s),e.abrupt("return",p);case 19:return e.prev=19,e.t0=e.catch(3),console.error("[VoxelSystem] 生成方块网格失败: "+t,e.t0),e.abrupt("return",null);case 23:case"end":return e.stop()}}),e,this,[[3,19]])})));return function(t,r,n){return e.apply(this,arguments)}}(),a.detectOverlayInfo=function(e){try{for(var r,n=["north","south","east","west"],a=t(e.elements||[]);!(r=a()).done;)for(var o,s,i=r.value,c=function(){var t=s.value;if(-1===n.indexOf(t.dir))return 0;var r=e.textures.find((function(e){return e.key===t.textureKey}));if(!r)return 0;var a=r.name;if(a.includes("_side_overlay")){var o=a;return{v:{baseSideTexture:a.replace("_side_overlay","_side"),overlaySideTexture:o}}}},l=t(i.faces);!(s=l()).done;)if(0!==(o=c())&&o)return o.v;return null}catch(e){return console.warn("[VoxelSystem] detectOverlayInfo 失败，按普通方块处理",e),null}},a.preloadBlockMaterial=function(){var e=r(n().mark((function e(t){var r,a;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.initialized){e.next=3;break}return console.error("[VoxelSystem] 系统未初始化"),e.abrupt("return");case 3:return e.prev=3,(r=h.getBlock(t))&&r.lightLevel,a=this.getBlockMainTexture(t),e.next=9,this.materialFactory.preloadTexture(a);case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(3),console.error("[VoxelSystem] 预加载方块材质失败: "+t,e.t0);case 14:case"end":return e.stop()}}),e,this,[[3,11]])})));return function(t){return e.apply(this,arguments)}}(),a.createBlockMaterial=function(){var e=r(n().mark((function e(t,r){var a,o;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.initialized){e.next=3;break}return console.error("[VoxelSystem] 系统未初始化"),e.abrupt("return",null);case 3:return e.prev=3,a=h.getBlock(t),e.next=7,this.getBlockData(t);case 7:return o=e.sent,e.next=10,this.materialFactory.createBlockMaterial(r,o,a);case 10:return e.abrupt("return",e.sent);case 13:return e.prev=13,e.t0=e.catch(3),console.error("[VoxelSystem] 创建方块材质失败: "+t,e.t0),e.abrupt("return",null);case 17:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(t,r){return e.apply(this,arguments)}}(),a.generateBlockMeshesBatch=function(){var e=r(n().mark((function e(t){var r,a=this;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.map((function(e){return a.generateBlockMesh(e.id,e.position,e.rotation)})),e.next=3,Promise.all(r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a.getBlockMainTexture=function(e){var t=e.trim();return t.startsWith("web3:block/")?t:t.startsWith("web3:")?"web3:block/"+t.substring("web3:".length):t.startsWith("minecraft:block/")?t:t.startsWith("minecraft:")?"minecraft:block/"+(t=t.substring("minecraft:".length)):(t.startsWith("block/")&&(t=t.substring("block/".length)),"minecraft:block/"+t)},a.hasBlock=function(e){return h.exists(e)},a.getBlockDefinition=function(e){return h.getBlock(e)},a.getAllBlockIds=function(){for(var e,r=f(),n=h.getAllBlockIds(),a=[].concat(r),o=t(n);!(e=o()).done;){var s=e.value;-1===a.indexOf(s)&&a.push(s)}return a},a.getWeb3BlockIds=function(){return f()},a.getWeb3TileBlocks=function(){return p()},a.getWeb3ObjectBlocks=function(){return b()},a.getAllWeb3Blocks=function(){return k},a.setOverlayEnabled=function(e){this.overlayEnabled=!!e,console.log("[VoxelSystem] Overlay 功能 "+(this.overlayEnabled?"已开启":"已关闭"))},a.isOverlayEnabled=function(){return this.overlayEnabled},a.getCommonBlockIds=function(){return["minecraft:stone","minecraft:dirt","minecraft:grass_block","minecraft:sand","minecraft:cobblestone","minecraft:oak_log","minecraft:oak_planks","minecraft:oak_leaves","minecraft:glass"]},a.createBlockNode=function(){var e=r(n().mark((function e(r,a,i){var c,l,h,f,p,b,k,x,d,y,v;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.initialized){e.next=4;break}return console.error("[VoxelSystem] 系统未初始化"),e.abrupt("return",null);case 4:return e.next=6,this.getBlockData(a);case 6:return e.sent,e.next=9,this.generateBlockMesh(a,i);case 9:if(c=e.sent){e.next=12;break}return e.abrupt("return",null);case 12:if((l=new s("Block_"+a.replace("minecraft:",""))).position=i,0!==c.textureGroups.size){e.next=18;break}return console.warn("[VoxelSystem] 纹理组为空，取消创建:",a),l.destroy(),e.abrupt("return",null);case 18:h=t(c.textureGroups);case 19:if((f=h()).done){e.next=36;break}if(p=f.value,b=p[0],(k=p[1])&&0!==k.vertices.length){e.next=23;break}return e.abrupt("continue",34);case 23:if(x=new s("SubMesh"),l.addChild(x),d=u.createCocosMesh({vertices:[],indices:[],textureGroups:new Map([[b,k]])},b)){e.next=28;break}return e.abrupt("continue",34);case 28:return(y=x.addComponent(o)).mesh=d,e.next=32,this.createBlockMaterial(a,k.texture);case 32:(v=e.sent)&&(y.material=v);case 34:e.next=19;break;case 36:return r.addChild(l),e.abrupt("return",l);case 40:return e.prev=40,e.t0=e.catch(0),console.error("[VoxelSystem] createBlockNode 失败:",a,e.t0),e.abrupt("return",null);case 44:case"end":return e.stop()}}),e,this,[[0,40]])})));return function(t,r,n){return e.apply(this,arguments)}}(),a.getTextureManager=function(){return this.textureManager},a.getMaterialFactory=function(){return this.materialFactory},a.getBlockParser=function(){return this.blockParser},a.clearCaches=function(){this.materialFactory.clearCache(),this.blockParser.clearCache(),this.blockCache.clear(),console.log("[VoxelSystem] 缓存已清理（纹理缓存保留）")},a.getBlockData=function(){var e=r(n().mark((function e(t){var r;return n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.blockCache.get(t)){e.next=9;break}return e.next=4,this.blockParser.parseBlock(t);case 4:if(r=e.sent){e.next=8;break}return console.warn("[VoxelSystem] 方块解析失败: "+t),e.abrupt("return",null);case 8:this.blockCache.set(t,r);case 9:return e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),a.logSystemStats=function(){if(this.initialized){var e=this.textureManager.getCacheStats(),t=this.materialFactory.getCacheStats(),r=this.blockParser.getCacheStats();console.log("[VoxelSystem] 系统统计:"),console.log("- 方块类型: "+h.getAllBlockIds().length),console.log("- 纹理缓存: "+e.total+" ("+e.loaded+" 已加载)"),console.log("- 材质缓存: "+t.materials),console.log("- 方块缓存: "+this.blockCache.size),console.log("- 解析器缓存: JSON="+r.jsonCache+", 纹理检查="+r.textureCheckCache),console.log("- 内存占用: "+(e.totalMemory/1024/1024).toFixed(2)+" MB")}},a.getSystemStatus=function(){var e=this.initialized?this.textureManager.getCacheStats():{total:0},t=this.initialized?this.materialFactory.getCacheStats():{materials:0};return{initialized:this.initialized,blockCount:h.getAllBlockIds().length,textureCount:e.total,materialCount:t.materials,modelCount:this.blockCache.size}},a.destroy=function(){this.materialFactory&&this.materialFactory.destroy(),this.blockParser&&this.blockParser.clearCache(),this.blockCache.clear(),e.instance=null,this.initialized=!1,console.log("[VoxelSystem] 体素系统已销毁（纹理缓存保留）")},e.quickInitialize=function(){var t=r(n().mark((function t(r){var a,o;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=e.getInstance(),t.next=4,a.initialize(r);case 4:return o=t.sent,t.abrupt("return",o?a:null);case 8:return t.prev=8,t.t0=t.catch(0),console.error("[VoxelSystem] 快速初始化失败:",t.t0),t.abrupt("return",null);case 12:case"end":return t.stop()}}),t,null,[[0,8]])})));return function(e){return t.apply(this,arguments)}}(),e}());x.instance=null,a._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelSystemExample.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelSystem.ts","./MeshBuilder.ts"],(function(e){var t,o,n,l,s,r,i,a,c,h,u,m,p,x,g,f,y,d;return{setters:[function(e){t=e.applyDecoratedDescriptor,o=e.inheritsLoose,n=e.initializerDefineProperty,l=e.assertThisInitialized,s=e.createForOfIteratorHelperLoose,r=e.asyncToGenerator,i=e.regeneratorRuntime},function(e){a=e.cclegacy,c=e._decorator,h=e.Node,u=e.Camera,m=e.Component,p=e.Vec3,x=e.director,g=e.MeshRenderer},function(e){f=e.getVoxelSystem,y=e.VoxelSystem},function(e){d=e.MeshBuilder}],execute:function(){var S,w,v,k,b,V,E,B,z,D,M,T,G,C,_,A,L;e("VoxelSystemTest",void 0),a._RF.push({},"b9aa7A3mfdJBY6gDWD/zp56","VoxelSystemExample",void 0);var I,P=c.ccclass,N=c.property,W=e("VoxelSystemExample",(S=P("VoxelSystemExample"),w=N(h),v=N(u),k=N({tooltip:"世界大小 (N x N)"}),b=N({tooltip:"植物密度 (0.0-1.0，表示植物方块占总方块数的比例)"}),V=N({tooltip:"发光方块密度 (0.0-1.0，表示发光方块占总方块数的比例)"}),E=N({tooltip:"每批处理的方块数量 (影响生成速度和内存使用)"}),B=N({tooltip:"批次间延迟 (毫秒，避免卡顿)"}),S((M=t((D=function(e){function t(){for(var t,o=arguments.length,s=new Array(o),r=0;r<o;r++)s[r]=arguments[r];return t=e.call.apply(e,[this].concat(s))||this,n(t,"containerNode",M,l(t)),n(t,"camera",T,l(t)),n(t,"worldSize",G,l(t)),n(t,"plantDensity",C,l(t)),n(t,"glowingBlockDensity",_,l(t)),n(t,"batchSize",A,l(t)),n(t,"batchDelay",L,l(t)),t.voxelSystem=null,t.testBlocks=[],t}o(t,e);var a=t.prototype;return a.onLoad=function(){var e=r(i().mark((function e(){var t,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[VoxelSystemExample] 开始测试体素系统..."),this.containerNode||(this.containerNode=new h("VoxelContainer"),this.node.addChild(this.containerNode)),this.camera||(o=null==(t=x.getScene())?void 0:t.getComponentInChildren(u),this.camera=o||null,this.camera||console.warn("[VoxelSystemExample] 请在Inspector中设置Camera引用")),e.next=5,this.initializeVoxelSystem();case 5:return e.next=7,this.createTestBlocks();case 7:this.logGlowingBlocksInfo();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.initializeVoxelSystem=function(){var e=r(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[VoxelSystemExample] 初始化体素系统..."),e.prev=1,e.next=4,y.quickInitialize();case 4:if(this.voxelSystem=e.sent,this.voxelSystem){e.next=7;break}throw new Error("体素系统初始化失败");case 7:console.log("[VoxelSystemExample] 体素系统初始化成功"),this.voxelSystem.logSystemStats(),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),console.error("[VoxelSystemExample] 体素系统初始化失败:",e.t0);case 14:case"end":return e.stop()}}),e,this,[[1,11]])})));return function(){return e.apply(this,arguments)}}(),a.createTestBlocks=function(){var e=r(i().mark((function e(){var t,o,n,l=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.voxelSystem){e.next=3;break}return console.error("[VoxelSystemExample] 体素系统未初始化"),e.abrupt("return");case 3:return console.log("[VoxelSystemExample] 创建测试方块..."),this.testBlocks=[{id:"minecraft:stone",position:new p(-4,0,0)},{id:"minecraft:dirt",position:new p(-3,0,0)},{id:"minecraft:grass_block",position:new p(-2,0,0)},{id:"minecraft:sand",position:new p(-1,0,0)},{id:"minecraft:cobblestone",position:new p(0,0,0)},{id:"minecraft:oak_log",position:new p(-4,0,1)},{id:"minecraft:oak_planks",position:new p(-3,0,1)},{id:"minecraft:oak_leaves",position:new p(-2,0,1)},{id:"minecraft:glass",position:new p(-4,0,2)},{id:"minecraft:dandelion",position:new p(-4,0,3)},{id:"minecraft:poppy",position:new p(-3,0,3)},{id:"minecraft:short_grass",position:new p(-2,0,3)},{id:"minecraft:fern",position:new p(-1,0,3)}],t=this.testBlocks.map((function(e){return l.createSingleBlock(e)})),e.next=8,Promise.all(t);case 8:o=e.sent,n=o.filter((function(e){return e})).length,console.log("[VoxelSystemExample] 测试方块创建结果: "+n+"/"+this.testBlocks.length+" 成功"),console.log("[VoxelSystemExample] 成功创建 "+this.testBlocks.length+" 个测试方块");case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.generateLargeWorld=function(){var e=r(i().mark((function e(){var t,o,n,l,s,r,a,c,h,u,m,x,g,f,y,d,S,w,v,k,b,V,E,B,z,D,M,T,G,C,_,A,L,I,P,N,W,R,O,F=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.voxelSystem){e.next=3;break}return console.error("[VoxelSystemExample] 体素系统未初始化"),e.abrupt("return");case 3:for(this.validateConfiguration(),console.log("[VoxelSystemExample] 开始生成"+this.worldSize+"x"+this.worldSize+"体素世界..."),t=Date.now(),this.clearTestBlocks(),o=["minecraft:stone","minecraft:dirt","minecraft:grass_block","minecraft:sand","minecraft:cobblestone","minecraft:oak_log","minecraft:oak_planks","minecraft:oak_leaves","minecraft:glass"],n=["minecraft:dandelion","minecraft:poppy","minecraft:short_grass","minecraft:fern"],console.log("[VoxelSystemExample] 使用 "+o.length+" 种基础方块，"+n.length+" 种植物"),l=[],s=Math.floor(this.worldSize/2),r=-s,a=-s,console.log("[VoxelSystemExample] 世界中心偏移: ("+r+", 0, "+a+")"),console.log("[VoxelSystemExample] 生成y=0层基础方块..."),c=0;c<this.worldSize;c++)for(h=0;h<this.worldSize;h++)u=this.getRandomBlockType(o,c,h),m=c+r,x=h+a,l.push({id:u,position:new p(m,0,x)});for(console.log("[VoxelSystemExample] 生成y=1层植物..."),g=Math.floor(this.worldSize*this.worldSize*this.plantDensity),f=0;f<g;f++)y=Math.floor(Math.random()*this.worldSize),d=Math.floor(Math.random()*this.worldSize),S=n[Math.floor(Math.random()*n.length)],w=y+r,v=d+a,l.push({id:S,position:new p(w,1,v)});if(console.log("[VoxelSystemExample] 生成发光方块..."),(k=this.getAvailableGlowingBlocks()).length>0)for(b=Math.floor(this.worldSize*this.worldSize*this.glowingBlockDensity),console.log("[VoxelSystemExample] 发现 "+k.length+" 种发光方块，将生成 "+b+" 个发光方块"),V=0;V<b;V++)B=Math.floor(Math.random()*this.worldSize),z=Math.floor(Math.random()*this.worldSize),D=2+Math.floor(3*Math.random()),M=k[Math.floor(Math.random()*k.length)],T=B+r,G=z+a,C=(null==(E=this.voxelSystem.getBlockDefinition(M))?void 0:E.lightLevel)||0,console.log("[VoxelSystemExample] 添加发光方块: "+M+" (光照等级: "+C+") at ("+T+", "+D+", "+G+")"),l.push({id:M,position:new p(T,D,G)});else console.warn("[VoxelSystemExample] 没有找到可用的发光方块类型");console.log("[VoxelSystemExample] 总共需要创建 "+l.length+" 个方块"),console.log("[VoxelSystemExample] 基础方块: "+this.worldSize*this.worldSize+" 个"),console.log("[VoxelSystemExample] 植物方块: "+g+" 个"),console.log("[VoxelSystemExample] 发光方块: "+(k.length>0?Math.floor(this.worldSize*this.worldSize*this.glowingBlockDensity):0)+" 个"),_=Math.ceil(l.length/this.batchSize),A=0;case 29:if(!(A<_)){e.next=46;break}return L=A*this.batchSize,I=Math.min(L+this.batchSize,l.length),P=l.slice(L,I),console.log("[VoxelSystemExample] 创建批次 "+(A+1)+"/"+_+" ("+P.length+" 个方块)"),N=P.map((function(e){return F.createSingleBlock(e)})),e.next=37,Promise.all(N);case 37:if(W=e.sent,R=W.filter((function(e){return e})).length,console.log("[VoxelSystemExample] 批次 "+(A+1)+" 创建结果: "+R+"/"+P.length+" 成功"),!(A<_-1)){e.next=43;break}return e.next=43,new Promise((function(e){return setTimeout(e,F.batchDelay)}));case 43:A++,e.next=29;break;case 46:this.testBlocks=l,O=Date.now(),console.log("[VoxelSystemExample] "+this.worldSize+"x"+this.worldSize+"体素世界生成完成！耗时: "+(O-t)+"ms"),this.validateWorldGeneration();case 50:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.logValidatedBlockTypes=function(e){console.log("[VoxelSystemExample] 验证过的方块类型:"),console.log("  基础方块 ("+e.validBlocks.length+"):",e.validBlocks),console.log("  植物方块 ("+e.validPlants.length+"):",e.validPlants),console.log("  发光方块 ("+e.validGlowing.length+"):",e.validGlowing),e.invalidBlocks.length>0&&console.log("  无效方块 ("+e.invalidBlocks.length+"):",e.invalidBlocks.slice(0,5))},a.validateAllBlockTypes=function(){var e=r(i().mark((function e(){var t,o,n,l,r,a,c,h,u,m,p,x,g,f,y;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(console.log("[VoxelSystemExample] 开始验证所有方块类型..."),t=this.getBlockTypes(),o=this.getPlantTypes(),n=this.getGlowingBlockTypes(),l=[],r=[],a=[],c=[],console.log("[VoxelSystemExample] 验证基础方块..."),h=s(t);!(u=h()).done;)m=u.value,this.voxelSystem.hasBlock(m)?l.push(m):c.push(m);for(console.log("[VoxelSystemExample] 验证植物方块..."),p=s(o);!(x=p()).done;)g=x.value,this.voxelSystem.hasBlock(g)?r.push(g):c.push(g);return console.log("[VoxelSystemExample] 跳过发光方块验证 - 暂时注释掉"),console.log("[VoxelSystemExample] 验证结果:"),console.log("  有效基础方块: "+l.length+"/"+t.length),console.log("  有效植物方块: "+r.length+"/"+o.length),console.log("  有效发光方块: "+a.length+"/"+n.length),console.log("  无效方块总数: "+c.length),c.length>0&&console.log("[VoxelSystemExample] 无效方块列表:",c.slice(0,10)),0===l.length&&(console.warn("[VoxelSystemExample] 没有有效的基础方块，使用动态生成"),f=this.voxelSystem.getAllBlockIds(),l.push.apply(l,this.generateDynamicBlockList(f,"basic"))),0===r.length&&(console.warn("[VoxelSystemExample] 没有有效的植物方块，使用动态生成"),y=this.voxelSystem.getAllBlockIds(),r.push.apply(r,this.generateDynamicBlockList(y,"plant"))),0===a.length&&console.warn("[VoxelSystemExample] 没有有效的发光方块，跳过发光方块生成"),e.abrupt("return",{validBlocks:l,validPlants:r,validGlowing:a,invalidBlocks:c});case 23:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.getSafeBlockTypes=function(){var e=this.getBlockTypes(),t=this.voxelSystem.getAllBlockIds(),o=e.filter((function(e){return-1!==t.indexOf(e)}));return console.log("[VoxelSystemExample] 基础方块类型检查: "+o.length+"/"+e.length+" 可用"),0===o.length?(console.warn("[VoxelSystemExample] 没有可用的基础方块类型，使用动态生成列表"),this.generateDynamicBlockList(t,"basic")):o},a.generateDynamicBlockList=function(e,t){console.log("[VoxelSystemExample] 动态生成"+t+"方块列表...");var o=[];switch(t){case"basic":o=["stone","dirt","grass","sand","cobble","gravel"];break;case"plant":o=["grass","flower","fern","bush","dandelion","poppy"];break;case"glowing":o=["torch","glow","lamp","fire","lantern"]}var n=e.filter((function(e){return o.some((function(t){return e.includes(t)}))}));return console.log("[VoxelSystemExample] 动态生成"+t+"方块: "+n.length+" 个"),0===n.length?(console.warn("[VoxelSystemExample] 动态生成失败，使用前几个可用方块"),e.slice(0,5)):n},a.getBlockTypes=function(){return["minecraft:stone","minecraft:dirt","minecraft:grass_block","minecraft:sand","minecraft:cobblestone","minecraft:oak_log","minecraft:oak_planks","minecraft:oak_leaves","minecraft:glass"]},a.getSafePlantTypes=function(){var e=this.getPlantTypes(),t=this.voxelSystem.getAllBlockIds(),o=e.filter((function(e){return-1!==t.indexOf(e)}));return console.log("[VoxelSystemExample] 植物类型检查: "+o.length+"/"+e.length+" 可用"),0===o.length?(console.warn("[VoxelSystemExample] 没有可用的植物类型，使用动态生成列表"),this.generateDynamicBlockList(t,"plant")):o},a.getSafeGlowingBlockTypes=function(){var e=this.getGlowingBlockTypes(),t=this.voxelSystem.getAllBlockIds(),o=e.filter((function(e){return-1!==t.indexOf(e)}));return console.log("[VoxelSystemExample] 发光方块类型检查: "+o.length+"/"+e.length+" 可用"),0===o.length?(console.warn("[VoxelSystemExample] 没有可用的发光方块类型，使用动态生成列表"),this.generateDynamicBlockList(t,"glowing")):o},a.getPlantTypes=function(){return["minecraft:dandelion","minecraft:poppy","minecraft:short_grass","minecraft:fern"]},a.getGlowingBlockTypes=function(){return["minecraft:torch","minecraft:glowstone","minecraft:redstone_lamp"]},a.getAvailableGlowingBlocks=function(){var e=this;if(!this.voxelSystem)return console.warn("[VoxelSystemExample] 体素系统未初始化，返回默认发光方块列表"),this.getGlowingBlockTypes();var t=this.voxelSystem.getAllBlockIds();console.log("[VoxelSystemExample] 扫描 "+t.length+" 个方块类型，查找发光方块...");var o=t.filter((function(t){var o=e.voxelSystem.getBlockDefinition(t),n=o?o.lightLevel:0;return n>0&&(console.log("[VoxelSystemExample] 发现发光方块: "+t+" (光照等级: "+n+")"),!0)}));return console.log("[VoxelSystemExample] 总共发现 "+o.length+" 种发光方块:",o),0===o.length?(console.warn("[VoxelSystemExample] 没有找到发光方块，使用默认列表"),this.getGlowingBlockTypes()):o},a.logGlowingBlocksInfo=function(){var e=this;if(this.voxelSystem){console.log("[VoxelSystemExample] 发光方块详细信息:");var t=this.getAvailableGlowingBlocks();0!==t.length?(console.log("  发现 "+t.length+" 种发光方块:"),t.forEach((function(t,o){var n=e.voxelSystem.getBlockDefinition(t),l=n?n.lightLevel:0;console.log("    "+(o+1)+". "+t+" - 光照等级: "+l)}))):console.log("  没有找到发光方块")}else console.warn("[VoxelSystemExample] 体素系统未初始化")},a.validateWorldGeneration=function(){console.log("[VoxelSystemExample] 验证世界生成结果...");var e=this.testBlocks.filter((function(e){return e.node&&e.node.isValid})).length,t=this.testBlocks.length;console.log("[VoxelSystemExample] 预期方块数: "+t+", 实际创建节点数: "+e),e<t&&console.warn("[VoxelSystemExample] 警告: 有 "+(t-e)+" 个方块创建失败！"),this.checkGroundContinuity(),this.statisticsByLayer()},a.checkGroundContinuity=function(){console.log("[VoxelSystemExample] 检查地面连续性...");var e=this.testBlocks.filter((function(e){return 0===e.position.y&&e.node&&e.node.isValid}));if(console.log("[VoxelSystemExample] y=0层实际方块数: "+e.length),console.log("[VoxelSystemExample] 预期y=0层方块数: "+this.worldSize*this.worldSize),e.length<this.worldSize*this.worldSize){console.warn("[VoxelSystemExample] 警告: y=0层有 "+(this.worldSize*this.worldSize-e.length)+" 个空隙！");var t=new Set;e.forEach((function(e){var o=e.position.x+","+e.position.z;t.add(o)}));for(var o=[],n=0;n<this.worldSize;n++)for(var l=0;l<this.worldSize;l++){var s=n+","+l;t.has(s)||o.push({x:n,z:l})}o.length>0&&console.warn("[VoxelSystemExample] 缺失位置示例:",o.slice(0,10))}else console.log("[VoxelSystemExample] ✓ y=0层地面连续，无空隙")},a.statisticsByLayer=function(){var e=this;console.log("[VoxelSystemExample] 按层统计方块数量:");var t=new Map,o=new Map;this.testBlocks.forEach((function(n){if(n.node&&n.node.isValid){var l,s=n.position.y;t.set(s,(t.get(s)||0)+1);var r=null==(l=e.voxelSystem)?void 0:l.getBlockDefinition(n.id);r&&r.lightLevel>0&&o.set(s,(o.get(s)||0)+1)}})),Array.from(t.entries()).sort((function(e,t){return e[0]-t[0]})).forEach((function(e){var t=e[0],n=e[1],l=o.get(t)||0,s=l>0?" (其中发光方块: "+l+")":"";console.log("[VoxelSystemExample]   y="+t+": "+n+" 个方块"+s)}));var n=Array.from(o.values()).reduce((function(e,t){return e+t}),0);n>0&&console.log("[VoxelSystemExample] 发光方块总计: "+n+" 个")},a.validateConfiguration=function(){(this.worldSize<1||this.worldSize>1e3)&&(console.warn("[VoxelSystemExample] 世界大小 "+this.worldSize+" 超出合理范围，重置为 100"),this.worldSize=100),(this.plantDensity<0||this.plantDensity>1)&&(console.warn("[VoxelSystemExample] 植物密度 "+this.plantDensity+" 超出范围 [0,1]，重置为 0.1"),this.plantDensity=.1),(this.glowingBlockDensity<0||this.glowingBlockDensity>1)&&(console.warn("[VoxelSystemExample] 发光方块密度 "+this.glowingBlockDensity+" 超出范围 [0,1]，重置为 0.05"),this.glowingBlockDensity=.05),(this.batchSize<1||this.batchSize>1e4)&&(console.warn("[VoxelSystemExample] 批次大小 "+this.batchSize+" 超出合理范围，重置为 1000"),this.batchSize=1e3),(this.batchDelay<0||this.batchDelay>1e3)&&(console.warn("[VoxelSystemExample] 批次延迟 "+this.batchDelay+" 超出合理范围，重置为 50"),this.batchDelay=50)},a.getRandomBlockType=function(e,t,o){return e[Math.floor(Math.random()*e.length)]},a.seededRandom=function(e){var t=1e4*Math.sin(e);return t-Math.floor(t)},a.createSingleBlock=function(){var e=r(i().mark((function e(t){var o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.voxelSystem){e.next=3;break}return e.abrupt("return",!1);case 3:return e.next=5,this.voxelSystem.createBlockNode(this.containerNode,t.id,t.position);case 5:if(o=e.sent){e.next=8;break}return e.abrupt("return",!1);case 8:return t.node=o,e.abrupt("return",!0);case 12:return e.prev=12,e.t0=e.catch(0),console.error("[VoxelSystemExample] 创建方块失败: "+t.id+" at ("+t.position.x+", "+t.position.y+", "+t.position.z+")",e.t0),e.abrupt("return",!1);case 16:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(t){return e.apply(this,arguments)}}(),a.createBlockSubMeshes=function(){var e=r(i().mark((function e(t,o,n){var l,r,a,c,u,m,p,x,f,y,S,w,v,k;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o.hasOverlay&&o.overlayMeshes&&o.overlayInfo)){e.next=5;break}return console.log("[VoxelSystemExample] 检测到 overlay 方块，使用双子网格渲染: "+n),e.next=4,this.createOverlayBlock(t,o.overlayMeshes,o.overlayInfo);case 4:return e.abrupt("return",e.sent);case 5:if(l=0,r=0,a=o.textureGroups.size,console.log("[VoxelSystemExample] createBlockSubMeshes: textureGroups数量="+a),0!==a){e.next=12;break}return console.warn("[VoxelSystemExample] 没有纹理组数据: "+n),e.abrupt("return",!1);case 12:c=s(o.textureGroups);case 13:if((u=c()).done){e.next=40;break}if(m=u.value,p=m[0],x=m[1],e.prev=15,console.log("[VoxelSystemExample]   处理纹理组: "+p+", 顶点数="+x.vertices.length),f=new h("SubMesh_"+l),t.addChild(f),y={vertices:[],indices:[],textureGroups:new Map([[p,x]])},S=d.createCocosMesh(y,p)){e.next=24;break}return console.warn("[VoxelSystemExample] 子网格创建失败: "+p),e.abrupt("continue",38);case 24:return console.log("[VoxelSystemExample]   mesh创建成功: "+p),(w=f.addComponent(g)).mesh=S,e.next=29,this.voxelSystem.createBlockMaterial(n);case 29:(v=e.sent)?w.material=v:console.warn("[VoxelSystemExample] 材质创建失败: "+n),l++,r++,e.next=38;break;case 35:e.prev=35,e.t0=e.catch(15),console.error("[VoxelSystemExample] 创建子网格失败: "+p,e.t0);case 38:e.next=13;break;case 40:return(k=r>0)?r<a&&console.warn("[VoxelSystemExample] 部分子网格创建失败: "+n+" ("+r+"/"+a+")"):console.error("[VoxelSystemExample] 所有子网格创建失败: "+n),e.abrupt("return",k);case 43:case"end":return e.stop()}}),e,this,[[15,35]])})));return function(t,o,n){return e.apply(this,arguments)}}(),a.createGrassBlockFromSystem=function(){var e=r(i().mark((function e(t,o,n){var l,s;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("[VoxelSystemExample] 使用体素系统创建草方块: "+n),(l=t.addComponent(g)).mesh=o,e.next=6,this.voxelSystem.createBlockMaterial(n);case 6:return(s=e.sent)&&(l.material=s,console.log("[VoxelSystemExample] 草方块材质设置成功: "+n)),e.abrupt("return",!0);case 11:return e.prev=11,e.t0=e.catch(0),console.error("[VoxelSystemExample] 草方块创建失败: "+n,e.t0),e.abrupt("return",!1);case 15:case"end":return e.stop()}}),e,this,[[0,11]])})));return function(t,o,n){return e.apply(this,arguments)}}(),a.createOverlayBlock=function(){var e=r(i().mark((function e(t,o,n){var l,s;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(l=t.addComponent(g)).mesh=o.base,e.next=5,this.voxelSystem.createBlockMaterial("minecraft:"+n.baseSideTexture.replace("_side",""));case 5:return(s=e.sent)&&(l.material=s),e.abrupt("return",!0);case 10:return e.prev=10,e.t0=e.catch(0),console.error("[VoxelSystemExample] 创建 overlay 方块失败",e.t0),e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(t,o,n){return e.apply(this,arguments)}}(),a.addTestBlock=function(){var e=r(i().mark((function e(t,o){var n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.voxelSystem){e.next=3;break}return console.error("[VoxelSystemExample] 体素系统未初始化"),e.abrupt("return");case 3:return n={id:t,position:o},this.testBlocks.push(n),e.next=7,this.createSingleBlock(n);case 7:case"end":return e.stop()}}),e,this)})));return function(t,o){return e.apply(this,arguments)}}(),a.clearTestBlocks=function(){for(var e,t=s(this.testBlocks);!(e=t()).done;){var o=e.value;o.node&&o.node.isValid&&o.node.destroy()}this.testBlocks=[],console.log("[VoxelSystemExample] 所有测试方块已清除")},a.recreateTestBlocks=function(){var e=r(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.clearTestBlocks(),this.voxelSystem&&this.voxelSystem.clearCaches(),e.next=4,this.createTestBlocks();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.logSystemInfo=function(){if(this.voxelSystem){var e=this.voxelSystem.getSystemStatus();console.log("[VoxelSystemExample] 系统状态:",e);var t=this.voxelSystem.getAllBlockIds();console.log("[VoxelSystemExample] 可用方块 ("+t.length+"):",t),this.analyzeAvailableBlocks(t),this.voxelSystem.logSystemStats()}else console.log("[VoxelSystemExample] 体素系统未初始化")},a.analyzeAvailableBlocks=function(e){console.log("[VoxelSystemExample] 分析可用方块类型...");var t={basic:0,wood:0,ore:0,plant:0,glowing:0,other:0};e.forEach((function(e){e.includes("stone")||e.includes("dirt")||e.includes("sand")||e.includes("grass")||e.includes("cobble")||e.includes("gravel")?t.basic++:e.includes("log")||e.includes("plank")||e.includes("leaves")?t.wood++:e.includes("ore")||e.includes("coal")||e.includes("iron")||e.includes("gold")||e.includes("diamond")||e.includes("emerald")?t.ore++:e.includes("flower")||e.includes("grass")||e.includes("fern")||e.includes("bush")||e.includes("cactus")||e.includes("vine")?t.plant++:e.includes("torch")||e.includes("glow")||e.includes("lamp")||e.includes("fire")||e.includes("lantern")||e.includes("candle")?t.glowing++:t.other++})),console.log("[VoxelSystemExample] 方块类型统计:"),console.log("  基础方块: "+t.basic+" 个"),console.log("  木质方块: "+t.wood+" 个"),console.log("  矿物方块: "+t.ore+" 个"),console.log("  植物方块: "+t.plant+" 个"),console.log("  发光方块: "+t.glowing+" 个"),console.log("  其他方块: "+t.other+" 个")},a.logConfiguration=function(){if(console.log("[VoxelSystemExample] 当前配置:"),console.log("  世界大小: "+this.worldSize+"x"+this.worldSize),console.log("  植物密度: "+this.plantDensity+" ("+Math.floor(this.worldSize*this.worldSize*this.plantDensity)+" 个植物)"),console.log("  发光方块密度: "+this.glowingBlockDensity+" ("+Math.floor(this.worldSize*this.worldSize*this.glowingBlockDensity)+" 个发光方块)"),console.log("  批次大小: "+this.batchSize),console.log("  批次延迟: "+this.batchDelay+"ms"),this.voxelSystem){var e=this.getAvailableGlowingBlocks();console.log("  可用发光方块类型: "+e.length+" 种"),e.length>0&&(console.log("  发光方块列表:",e.slice(0,5)),e.length>5&&console.log("    ... 还有 "+(e.length-5)+" 种"))}console.log("  预计总方块数: "+(this.worldSize*this.worldSize+Math.floor(this.worldSize*this.worldSize*this.plantDensity)+Math.floor(this.worldSize*this.worldSize*this.glowingBlockDensity)))},a.resetConfiguration=function(){this.worldSize=100,this.plantDensity=.1,this.glowingBlockDensity=.05,this.batchSize=1e3,this.batchDelay=50,console.log("[VoxelSystemExample] 配置已重置为默认值")},a.setSmallWorldConfig=function(){this.worldSize=20,this.plantDensity=.2,this.glowingBlockDensity=.1,this.batchSize=100,this.batchDelay=10,console.log("[VoxelSystemExample] 已设置为小世界配置")},a.setLargeWorldConfig=function(){this.worldSize=200,this.plantDensity=.05,this.glowingBlockDensity=.02,this.batchSize=2e3,this.batchDelay=100,console.log("[VoxelSystemExample] 已设置为大世界配置")},a.fixGroundGaps=function(){var e=r(i().mark((function e(){var t,o,n,l,s,r,a,c,h,u,m,x,g,f,y,d,S,w,v,k,b,V=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.voxelSystem){e.next=3;break}return console.error("[VoxelSystemExample] 体素系统未初始化"),e.abrupt("return");case 3:for(console.log("[VoxelSystemExample] 开始修复地面空隙..."),o=new Set,this.testBlocks.forEach((function(e){if(0===e.position.y&&e.node&&e.node.isValid){var t=e.position.x+","+e.position.z;o.add(t)}})),n=[],l=0;l<this.worldSize;l++)for(s=0;s<this.worldSize;s++)r=l+","+s,o.has(r)||n.push({x:l,z:s});if(0!==n.length){e.next=11;break}return console.log("[VoxelSystemExample] 地面无空隙，无需修复"),e.abrupt("return");case 11:for(console.log("[VoxelSystemExample] 发现 "+n.length+" 个空隙，开始补充..."),a=this.getBlockTypes(),c=[],h=0,u=n;h<u.length;h++)m=u[h],x=this.getRandomBlockType(a,m.x,m.z),c.push({id:x,position:new p(m.x,0,m.z)});g=Math.min(100,c.length),f=Math.ceil(c.length/g),y=0;case 18:if(!(y<f)){e.next=35;break}return d=y*g,S=Math.min(d+g,c.length),w=c.slice(d,S),console.log("[VoxelSystemExample] 修复批次 "+(y+1)+"/"+f+" ("+w.length+" 个方块)"),v=w.map((function(e){return V.createSingleBlock(e)})),e.next=26,Promise.all(v);case 26:if(k=e.sent,b=k.filter((function(e){return e})).length,console.log("[VoxelSystemExample] 修复批次 "+(y+1)+" 创建结果: "+b+"/"+w.length+" 成功"),!(y<f-1)){e.next=32;break}return e.next=32,new Promise((function(e){return setTimeout(e,V.batchDelay)}));case 32:y++,e.next=18;break;case 35:(t=this.testBlocks).push.apply(t,c),console.log("[VoxelSystemExample] 地面空隙修复完成，补充了 "+c.length+" 个方块"),this.validateWorldGeneration();case 38:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),a.testBlockType=function(){var e=r(i().mark((function e(t){var o,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.voxelSystem){e.next=3;break}return console.error("[VoxelSystemExample] 体素系统未初始化"),e.abrupt("return");case 3:if(console.log("[VoxelSystemExample] 测试方块类型: "+t),this.voxelSystem.hasBlock(t)){e.next=7;break}return console.error("[VoxelSystemExample] 方块类型不存在: "+t),e.abrupt("return");case 7:return o=this.voxelSystem.getBlockDefinition(t),console.log("[VoxelSystemExample] 方块定义:",o),n=new p(0,2,0),e.next=12,this.addTestBlock(t,n);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),a.onDestroy=function(){this.clearTestBlocks(),this.voxelSystem&&this.voxelSystem.clearCaches()},t}(m)).prototype,"containerNode",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T=t(D.prototype,"camera",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G=t(D.prototype,"worldSize",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),C=t(D.prototype,"plantDensity",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_=t(D.prototype,"glowingBlockDensity",[V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.05}}),A=t(D.prototype,"batchSize",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),L=t(D.prototype,"batchDelay",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),z=D))||z));!function(e){function t(){return(t=r(i().mark((function e(t){var o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.addComponent(W),e.next=4,new Promise((function(e){return setTimeout(e,100)}));case 4:return e.abrupt("return",o);case 7:return e.prev=7,e.t0=e.catch(0),console.error("[VoxelSystemTest] 快速测试失败:",e.t0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function o(){return(o=r(i().mark((function e(t){var o,n,l,s,r;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=f(),n=o.getAllBlockIds(),console.log("[VoxelSystemTest] 开始测试所有方块类型 ("+n.length+" 个)..."),l=0;case 4:if(!(l<n.length)){e.next=15;break}return s=n[l],r=new p(l%10-5,0,Math.floor(l/10)-2),e.next=9,t.addTestBlock(s,r);case 9:if(l%5!=0){e.next=12;break}return e.next=12,new Promise((function(e){return setTimeout(e,10)}));case 12:l++,e.next=4;break;case 15:console.log("[VoxelSystemTest] 所有方块类型测试完成");case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function n(){return(n=r(i().mark((function e(t){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[VoxelSystemTest] 开始生成100x100大型体素世界..."),e.next=3,t.generateLargeWorld();case 3:console.log("[VoxelSystemTest] 100x100大型体素世界生成完成！");case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}e.quickTest=function(e){return t.apply(this,arguments)},e.testAllBlocks=function(e){return o.apply(this,arguments)},e.generateLargeWorld=function(e){return n.apply(this,arguments)}}(I||(I=e("VoxelSystemTest",{}))),a._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelTerrain.ts",["cc","./VoxelNoise.ts","./VoxelConfig.ts","./VoxelBlock.ts","./VoxelWorldConfig.ts"],(function(E){var e,r,L,S,_,t;return{setters:[function(E){e=E.cclegacy},function(E){r=E.VoxelNoise},function(E){L=E.VoxelConfig},function(E){S=E.VoxelBlockType},function(E){_=E.VoxelWorldConfig,t=E.VoxelWorldMode}],execute:function(){e._RF.push({},"a2e3bxkUrBBWKvakHNPBC0R","VoxelTerrain",void 0);E("VoxelTerrain",function(){function E(){}return E.createWorld=function(E,e,r,L){switch(_.getMode()){case t.SMALL_FLAT:case t.TINY_DEBUG:this.createFlatWorld(E,e,r,L);break;case t.NORMAL:default:this.createNormalWorld(E,e,r,L)}},E.createNormalWorld=function(E,e,_,t){for(var a=L.CHUNK_SIZE,o=-1;o<a+1;o++)for(var A=-1;A<a+1;A++){var i=1;(o<0||A<0||o>=a||A>=a)&&(i=-1);var n=E*a+o,T=e*a+A,O=r.simplex2(n*L.TERRAIN_NOISE_SCALE,T*L.TERRAIN_NOISE_SCALE,4,.5,2),f=r.simplex2(-n*L.TERRAIN_NOISE_SCALE,-T*L.TERRAIN_NOISE_SCALE,2,.9,2)*L.TERRAIN_HEIGHT_SCALE+L.TERRAIN_HEIGHT_OFFSET,l=Math.floor(O*f),R=S.GRASS,N=L.SEA_LEVEL;l<=N&&(l=N,R=S.SAND);for(var s=0;s<l;s++)_(n,s,T,R*i,t);R===S.GRASS&&L.SHOW_PLANTS&&this.generatePlants(n,l,T,i,_,t),L.SHOW_TREES&&this.generateTrees(n,l,T,o,A,a,R,_,t)}L.SHOW_CLOUDS&&this.generateClouds(E,e,_,t)},E.createFlatWorld=function(E,e,a,o){var A=L.CHUNK_SIZE;if(_.getMode()===t.SMALL_FLAT)for(var i=-1;i<A+1;i++)for(var n=-1;n<A+1;n++){var T=1;(i<0||n<0||i>=A||n>=A)&&(T=-1);var O=E*A+i,f=e*A+n;if(a(O,0,f,S.GRASS*T,o),L.SHOW_PLANTS&&T>0){var l=r.simplex2(.1*O,.1*f,4,.8,2);if(l>.8)a(O,1,f,(S.YELLOW_FLOWER+Math.floor(3*Math.abs(l))%3)*T,o)}}else for(var R=Math.max(3,L.SEA_LEVEL-1),N=R+1,s=-1;s<A+1;s++)for(var H=-1;H<A+1;H++){var I=1;(s<0||H<0||s>=A||H>=A)&&(I=-1);for(var u=E*A+s,C=e*A+H,c=0;c<R;c++)a(u,c,C,S.STONE*I,o);if(a(u,R,C,S.GRASS*I,o),L.SHOW_PLANTS&&I>0){var v=r.simplex2(.1*u,.1*C,4,.8,2);if(v>.7)a(u,N,C,(S.YELLOW_FLOWER+Math.floor(3*Math.abs(v))%3)*I,o)}}},E.generatePlants=function(E,e,_,t,a,o){if(r.simplex2(-E*L.PLANT_NOISE_SCALE,_*L.PLANT_NOISE_SCALE,4,.8,2)>L.PLANT_THRESHOLD&&a(E,e,_,S.TALL_GRASS*t,o),r.simplex2(E*L.FLOWER_NOISE_SCALE,-_*L.FLOWER_NOISE_SCALE,4,.8,2)>L.FLOWER_THRESHOLD){var A=r.simplex2(.1*E,.1*_,4,.8,2);a(E,e,_,(S.YELLOW_FLOWER+Math.floor(6*A))*t,o)}},E.generateTrees=function(E,e,_,t,a,o,A,i,n){var T=!0;((t-4<0||a-4<0||t+4>=o||a+4>=o)&&(T=!1),T&&A===S.GRASS)&&(r.simplex2(E,_,6,.5,2)>L.TREE_THRESHOLD&&this.generateSingleTree(E,e,_,i,n))},E.generateSingleTree=function(E,e,r,_,t){for(var a=L.TREE_TRUNK_HEIGHT,o=L.TREE_LEAVES_RADIUS,A=e+L.TREE_LEAVES_HEIGHT_OFFSET,i=e+L.TREE_HEIGHT_MIN;i<e+L.TREE_HEIGHT_MAX+1;i++)for(var n=-o;n<=o;n++)for(var T=-o;T<=o;T++){n*n+T*T+(i-A)*(i-A)<11&&_(E+n,i,r+T,S.LEAVES,t)}for(var O=e;O<e+a;O++)_(E,O,r,S.WOOD,t)},E.generateClouds=function(E,e,_,t){for(var a=L.CHUNK_SIZE,o=0;o<a;o++)for(var A=0;A<a;A++)for(var i=E*a+o,n=e*a+A,T=L.CLOUD_HEIGHT_MIN;T<L.CLOUD_HEIGHT_MAX;T++){r.simplex3(i*L.CLOUD_NOISE_SCALE,.1*T,n*L.CLOUD_NOISE_SCALE,8,.5,2)>L.CLOUD_THRESHOLD&&_(i,T,n,S.CLOUD,t)}},E.getHeightAt=function(E,e){var S=_.getMode();if(S===t.SMALL_FLAT)return 1;if(S===t.TINY_DEBUG)return Math.max(3,L.SEA_LEVEL-1)+1;var a=r.simplex2(E*L.TERRAIN_NOISE_SCALE,e*L.TERRAIN_NOISE_SCALE,4,.5,2),o=r.simplex2(-E*L.TERRAIN_NOISE_SCALE,-e*L.TERRAIN_NOISE_SCALE,2,.9,2)*L.TERRAIN_HEIGHT_SCALE+L.TERRAIN_HEIGHT_OFFSET,A=Math.floor(a*o);return A<=L.SEA_LEVEL&&(A=L.SEA_LEVEL),A},E.getBlockTypeAt=function(E,e,a){var o=_.getMode();if(o===t.SMALL_FLAT){if(0===e)return S.GRASS;if(1===e&&L.SHOW_PLANTS){var A=r.simplex2(.1*E,.1*a,4,.8,2);if(A>.8)return S.YELLOW_FLOWER+Math.floor(3*Math.abs(A))%3}return S.EMPTY}if(o===t.TINY_DEBUG){var i=Math.max(3,L.SEA_LEVEL-1),n=i+1;if(e<i)return S.STONE;if(e===i)return S.GRASS;if(e===n&&L.SHOW_PLANTS){var T=r.simplex2(.1*E,.1*a,4,.8,2);if(T>.7)return S.YELLOW_FLOWER+Math.floor(3*Math.abs(T))%3}return S.EMPTY}var O=this.getHeightAt(E,a);if(e<O)return O<=L.SEA_LEVEL?S.SAND:S.GRASS;if(e===O&&O>L.SEA_LEVEL&&L.SHOW_PLANTS){if(r.simplex2(-E*L.PLANT_NOISE_SCALE,a*L.PLANT_NOISE_SCALE,4,.8,2)>L.PLANT_THRESHOLD)return S.TALL_GRASS;if(r.simplex2(E*L.FLOWER_NOISE_SCALE,-a*L.FLOWER_NOISE_SCALE,4,.8,2)>L.FLOWER_THRESHOLD){var f=r.simplex2(.1*E,.1*a,4,.8,2);return S.YELLOW_FLOWER+Math.floor(6*f)}}if(L.SHOW_CLOUDS&&e>=L.CLOUD_HEIGHT_MIN&&e<L.CLOUD_HEIGHT_MAX&&r.simplex3(E*L.CLOUD_NOISE_SCALE,.1*e,a*L.CLOUD_NOISE_SCALE,8,.5,2)>L.CLOUD_THRESHOLD)return S.CLOUD;return S.EMPTY},E.getBiomeAt=function(E,e){var r=this.getHeightAt(E,e);return r<=L.SEA_LEVEL?"ocean":r<L.SEA_LEVEL+10?"beach":r<L.SEA_LEVEL+30?"plains":"hills"},E.isValidSpawnLocation=function(E,e){var r=this.getHeightAt(E,e);return r>L.SEA_LEVEL&&r<L.SEA_LEVEL+20},E}());e._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelTypes.ts",["cc"],(function(){var e;return{setters:[function(t){e=t.cclegacy}],execute:function(){e._RF.push({},"145daXRKLBKV7hKr4yCpn5M","VoxelTypes",void 0),e._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelWorld.ts",["./rollupPluginModLoBabelHelpers.js","cc","./VoxelChunkStorage.ts","./VoxelBlockRegistry.ts","./VoxelSystem.ts","./VoxelConfig.ts"],(function(t){var e,n,o,r,s,a,i,u,h;return{setters:[function(t){e=t.createForOfIteratorHelperLoose,n=t.asyncToGenerator,o=t.regeneratorRuntime},function(t){r=t.cclegacy,s=t.Vec3},function(t){a=t.VoxelChunkStorage},function(t){i=t.BlockRegistry},function(t){u=t.VoxelSystem},function(t){h=t.VoxelConfig}],execute:function(){r._RF.push({},"12118ZRQWpKKYNZoCT3ymAN","VoxelWorld",void 0);t("VoxelWorld",function(){function t(){this.chunks=new Map,this.chunkCount=0,this.loadRadius=h.CREATE_CHUNK_RADIUS||3,this.unloadRadius=h.DELETE_CHUNK_RADIUS||5,this.renderRadius=h.RENDER_CHUNK_RADIUS||4,this.voxelSystem=null,this.stats={cacheHits:0,cacheMisses:0,totalBlockOperations:0},this.terrainGenerator=void 0,console.log("[VoxelWorld] 初始化现代体素世界管理器..."),this.terrainGenerator=new l,this.voxelSystem=u.getInstance()}var r=t.prototype;return r.initialize=function(){var t=n(o().mark((function t(){return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[VoxelWorld] 开始初始化世界..."),i){t.next=3;break}throw new Error("BlockRegistry not initialized");case 3:if(!this.voxelSystem||this.voxelSystem.getSystemStatus().initialized){t.next=6;break}return t.next=6,this.voxelSystem.initialize();case 6:console.log("[VoxelWorld] 世界初始化完成");case 7:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),r.getChunkKey=function(t,e){return t+"_"+e},r.getChunkCoords=function(t,e){return a.getChunkCoords(t,e)},r.getOrCreateChunk=function(t,e,n){var o=this.getChunkKey(t,e),r=this.chunks.get(o);return r?this.stats.cacheHits++:(this.stats.cacheMisses++,r=this.createChunk(t,e,n)),r},r.createChunk=function(t,e,n){var o=a.createChunk(t,e),r=this.getChunkKey(t,e);return this.chunks.set(r,o),this.chunkCount++,!1!==(null==n?void 0:n.generateTerrain)&&this.terrainGenerator.generateTerrain(o),console.log("[VoxelWorld] 创建Chunk("+t+","+e+")，当前总数: "+this.chunkCount),o},r.getChunk=function(t,e){var n=this.getChunkKey(t,e);return this.chunks.get(n)||null},r.unloadChunk=function(t,e){var n=this.getChunkKey(t,e),o=this.chunks.get(n);return!!o&&(a.freeChunk(o),this.chunks.delete(n),this.chunkCount--,console.log("[VoxelWorld] 卸载Chunk("+t+","+e+")，剩余: "+this.chunkCount),!0)},r.setBlock=function(t,e,n,o){if(!this.isValidCoordinate(t,e,n))return console.warn("[VoxelWorld] 无效坐标: ("+t+", "+e+", "+n+")"),!1;if(!i.exists(o))return console.warn("[VoxelWorld] 未知方块ID: "+o),!1;var r=this.getChunkCoords(t,n),s=r.p,u=r.q,h=this.getOrCreateChunk(s,u),l=a.setBlock(h,t,e,n,o);return l&&(this.stats.totalBlockOperations++,this.markNeighborChunksForUpdate(s,u)),l},r.getBlock=function(t,e,n){if(!this.isValidCoordinate(t,e,n))return"minecraft:air";var o=this.getChunkCoords(t,n),r=o.p,s=o.q,i=this.getChunk(r,s);return i?(this.stats.totalBlockOperations++,a.getBlock(i,t,e,n)):this.terrainGenerator.predictBlockAt(t,e,n)},r.setBlocks=function(t){for(var n,o=0,r=new Map,s=e(t);!(n=s()).done;){var u=n.value;if(this.isValidCoordinate(u.x,u.y,u.z)&&i.exists(u.blockId)){var h=this.getChunkCoords(u.x,u.z),l=h.p,c=h.q,d=this.getChunkKey(l,c);r.has(d)||r.set(d,[]),r.get(d).push(u)}}for(var k,f=e(r);!(k=f()).done;){for(var C,v=k.value,g=v[0],p=v[1],m=g.split("_"),x=m[0],y=m[1],R=parseInt(x),M=parseInt(y),b=this.getOrCreateChunk(R,M),V=new Map,B=e(p);!(C=B()).done;){var I=C.value;V.has(I.blockId)||V.set(I.blockId,[]),V.get(I.blockId).push(I)}for(var S,w=e(V);!(S=w()).done;){var W=S.value,N=W[0],q=W[1];a.setBlocks(b,q,N),o+=q.length}this.markNeighborChunksForUpdate(R,M)}return this.stats.totalBlockOperations+=o,o},r.fillRegion=function(t,e,n){if(!i.exists(n))return console.warn("[VoxelWorld] 未知方块ID: "+n),0;for(var o=[],r=t.x;r<=e.x;r++)for(var s=t.y;s<=e.y;s++)for(var a=t.z;a<=e.z;a++)this.isValidCoordinate(r,s,a)&&o.push({x:r,y:s,z:a,blockId:n});return this.setBlocks(o)},r.isValidCoordinate=function(t,e,n){return Number.isInteger(t)&&Number.isInteger(n)&&Number.isInteger(e)&&e>=0&&e<h.MAX_HEIGHT},r.markNeighborChunksForUpdate=function(t,e){for(var n=0,o=[{p:t-1,q:e},{p:t+1,q:e},{p:t,q:e-1},{p:t,q:e+1}];n<o.length;n++){var r=o[n],s=r.p,a=r.q,i=this.getChunk(s,a);i&&(i.meshDirty=!0)}},r.updateChunksAroundPlayer=function(t,e){var n=this.getChunkCoords(t,e),o=n.p,r=n.q;this.unloadDistantChunks(o,r),this.loadNearbyChunks(o,r)},r.unloadDistantChunks=function(t,n){for(var o,r=[],s=e(this.chunks.values());!(o=s()).done;){var a=o.value;Math.max(Math.abs(a.p-t),Math.abs(a.q-n))>this.unloadRadius&&r.push({p:a.p,q:a.q})}for(var i=0,u=r;i<u.length;i++){var h=u[i],l=h.p,c=h.q;this.unloadChunk(l,c)}},r.loadNearbyChunks=function(t,e){for(var n=-this.loadRadius;n<=this.loadRadius;n++)for(var o=-this.loadRadius;o<=this.loadRadius;o++){var r=t+n,s=e+o;Math.max(Math.abs(n),Math.abs(o))<=this.loadRadius&&!this.getChunk(r,s)&&this.getOrCreateChunk(r,s,{generateTerrain:!0})}},r.getRenderableChunks=function(t,n){for(var o,r=this.getChunkCoords(t,n),s=r.p,a=r.q,i=[],u=e(this.chunks.values());!(o=u()).done;){var h=o.value;Math.max(Math.abs(h.p-s),Math.abs(h.q-a))<=this.renderRadius&&!h.isEmpty&&i.push(h)}return i},r.getDirtyChunks=function(){return Array.from(this.chunks.values()).filter((function(t){return t.meshDirty}))},r.raycast=function(t,e,n){void 0===n&&(n=100);for(var o=Math.floor(n/.1),r=e.clone().normalize(),a=0;a<=o;a++){var i=t.clone().add(r.clone().multiplyScalar(.1*a)),u=Math.floor(i.x),h=Math.floor(i.y),l=Math.floor(i.z);if(this.isValidCoordinate(u,h,l)){var c=this.getBlock(u,h,l);if("minecraft:air"!==c){var d=this.calculateBlockNormal(t,new s(u,h,l));return{hit:!0,position:new s(u,h,l),blockId:c,normal:d}}}}return{hit:!1}},r.calculateBlockNormal=function(t,e){var n=t.clone().subtract(e.clone().add(new s(.5,.5,.5))),o=Math.abs(n.x),r=Math.abs(n.y),a=Math.abs(n.z);return o>r&&o>a?new s(n.x>0?1:-1,0,0):r>a?new s(0,n.y>0?1:-1,0):new s(0,0,n.z>0?1:-1)},r.getWorldStats=function(){for(var t,n=0,o=0,r=0,s=e(this.chunks.values());!(t=s()).done;){var i=t.value,u=a.getChunkStats(i);n+=u.blockCount,o+=u.memoryUsage.total,r+=262144}return{loadedChunks:this.chunkCount,totalBlocks:n,memoryUsage:o,compressionRatio:r>0?r/o:1,cacheHits:this.stats.cacheHits,cacheMisses:this.stats.cacheMisses}},r.optimizeWorld=function(){console.log("[VoxelWorld] 开始世界优化...");for(var t,n=0,o=e(this.chunks.values());!(t=o()).done;){var r=t.value;a.optimizeChunk(r),n++}console.log("[VoxelWorld] 优化完成，处理了 "+n+" 个Chunk")},r.clear=function(){for(var t,n=e(this.chunks.values());!(t=n()).done;){var o=t.value;a.freeChunk(o)}this.chunks.clear(),this.chunkCount=0,this.stats.cacheHits=0,this.stats.cacheMisses=0,this.stats.totalBlockOperations=0,console.log("[VoxelWorld] 世界已清理")},r.setLoadRadius=function(t){this.loadRadius=Math.max(1,t)},r.setUnloadRadius=function(t){this.unloadRadius=Math.max(2,t)},r.setRenderRadius=function(t){this.renderRadius=Math.max(1,t)},r.getLoadRadius=function(){return this.loadRadius},r.getUnloadRadius=function(){return this.unloadRadius},r.getRenderRadius=function(){return this.renderRadius},t}());var l=function(){function t(){}var e=t.prototype;return e.generateTerrain=function(t){for(var e=0;e<16;e++)for(var n=0;n<16;n++)for(var o=0;o<64;o++){var r=o<63?"minecraft:stone":"minecraft:grass_block";a.setBlock(t,e,o,n,r)}for(var s=0;s<5;s++){var i=Math.floor(16*Math.random()),u=Math.floor(16*Math.random()),h=Math.random()>.5?"minecraft:dandelion":"minecraft:short_grass";a.setBlock(t,i,64,u,h)}},e.predictBlockAt=function(t,e,n){return e<63?"minecraft:stone":63===e?"minecraft:grass_block":"minecraft:air"},t}();r._RF.pop()}}}));

System.register("chunks:///_virtual/VoxelWorldConfig.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(E){var _,t;return{setters:[function(E){_=E.createClass},function(E){t=E.cclegacy}],execute:function(){t._RF.push({},"9da01v2g/xP1LRXar/wCCn5","VoxelWorldConfig",void 0);var n=E("VoxelWorldMode",function(E){return E.NORMAL="normal",E.SMALL_FLAT="small_flat",E.TINY_DEBUG="tiny_debug",E}({})),e=E("VoxelWorldConfig",function(){function E(){}return E.setMode=function(E){this.mode=E,console.log("[VoxelWorldConfig] 切换到世界模式: "+E)},E.getMode=function(){return this.mode},E.getConfig=function(){var E=this.configurations.get(this.mode);return E||(console.warn("[VoxelWorldConfig] 未知的世界模式: "+this.mode+", 使用默认配置"),this.configurations.get(n.SMALL_FLAT))},E.getWorldInfo=function(){var E=this.getConfig(),_=E.CHUNK_SIZE*E.CHUNK_SIZE*E.MAX_HEIGHT;return"世界模式: "+this.mode+"\n区块大小: "+E.CHUNK_SIZE+"x"+E.CHUNK_SIZE+"x"+E.MAX_HEIGHT+" ("+_+" 方块)\n渲染半径: "+E.RENDER_CHUNK_RADIUS+" 区块\n地形高度: "+E.SEA_LEVEL+" - "+(E.TERRAIN_HEIGHT_OFFSET+E.TERRAIN_HEIGHT_SCALE)},_(E,null,[{key:"CHUNK_SIZE",get:function(){return this.getConfig().CHUNK_SIZE}},{key:"MAX_HEIGHT",get:function(){return this.getConfig().MAX_HEIGHT}},{key:"CREATE_CHUNK_RADIUS",get:function(){return this.getConfig().CREATE_CHUNK_RADIUS}},{key:"RENDER_CHUNK_RADIUS",get:function(){return this.getConfig().RENDER_CHUNK_RADIUS}},{key:"DELETE_CHUNK_RADIUS",get:function(){return this.getConfig().DELETE_CHUNK_RADIUS}},{key:"TERRAIN_HEIGHT_SCALE",get:function(){return this.getConfig().TERRAIN_HEIGHT_SCALE}},{key:"TERRAIN_HEIGHT_OFFSET",get:function(){return this.getConfig().TERRAIN_HEIGHT_OFFSET}},{key:"SEA_LEVEL",get:function(){return this.getConfig().SEA_LEVEL}},{key:"TERRAIN_NOISE_SCALE",get:function(){return this.getConfig().TERRAIN_NOISE_SCALE}},{key:"SHOW_TREES",get:function(){return this.getConfig().SHOW_TREES}},{key:"SHOW_PLANTS",get:function(){return this.getConfig().SHOW_PLANTS}},{key:"SHOW_CLOUDS",get:function(){return this.getConfig().SHOW_CLOUDS}}]),E}());e.mode=n.SMALL_FLAT,e.configurations=new Map([[n.NORMAL,{CHUNK_SIZE:32,MAX_HEIGHT:256,CREATE_CHUNK_RADIUS:10,RENDER_CHUNK_RADIUS:10,DELETE_CHUNK_RADIUS:14,TERRAIN_HEIGHT_SCALE:32,TERRAIN_HEIGHT_OFFSET:16,SEA_LEVEL:12,TERRAIN_NOISE_SCALE:.01,SHOW_TREES:!0,SHOW_PLANTS:!0,SHOW_CLOUDS:!0}],[n.SMALL_FLAT,{CHUNK_SIZE:8,MAX_HEIGHT:32,CREATE_CHUNK_RADIUS:3,RENDER_CHUNK_RADIUS:3,DELETE_CHUNK_RADIUS:5,TERRAIN_HEIGHT_SCALE:4,TERRAIN_HEIGHT_OFFSET:8,SEA_LEVEL:6,TERRAIN_NOISE_SCALE:.02,SHOW_TREES:!1,SHOW_PLANTS:!0,SHOW_CLOUDS:!1}],[n.TINY_DEBUG,{CHUNK_SIZE:4,MAX_HEIGHT:16,CREATE_CHUNK_RADIUS:2,RENDER_CHUNK_RADIUS:2,DELETE_CHUNK_RADIUS:3,TERRAIN_HEIGHT_SCALE:2,TERRAIN_HEIGHT_OFFSET:4,SEA_LEVEL:3,TERRAIN_NOISE_SCALE:.05,SHOW_TREES:!1,SHOW_PLANTS:!1,SHOW_CLOUDS:!1}]]),t._RF.pop()}}}));

System.register("chunks:///_virtual/WalkingPreference.ts",["cc"],(function(T){var e;return{setters:[function(T){e=T.cclegacy}],execute:function(){var r,t,S,n,i;T("createRotorRouterHistory",(function(){return{lastDirection:new Map}})),e._RF.push({},"b9ec48i/eBLg6H4qUX4gWOp","WalkingPreference",void 0);T("WalkingPreference",function(T){return T.ROTOR_ROUTER="rotor_router",T.RIGHT_HAND_RULE="right_hand_rule",T}({}));var O=T("Direction",function(T){return T[T.WEST=0]="WEST",T[T.NORTH=1]="NORTH",T[T.EAST=2]="EAST",T[T.SOUTH=3]="SOUTH",T}({}));T("DirectionNames",((r={})[O.WEST]="W",r[O.NORTH]="N",r[O.EAST]="E",r[O.SOUTH]="S",r)),T("OppositeDirection",((t={})[O.WEST]=O.EAST,t[O.NORTH]=O.SOUTH,t[O.EAST]=O.WEST,t[O.SOUTH]=O.NORTH,t)),T("NextDirectionCW",((S={})[O.WEST]=O.NORTH,S[O.NORTH]=O.EAST,S[O.EAST]=O.SOUTH,S[O.SOUTH]=O.WEST,S)),T("RightTurnDirection",((n={})[O.WEST]=O.NORTH,n[O.NORTH]=O.EAST,n[O.EAST]=O.SOUTH,n[O.SOUTH]=O.WEST,n)),T("LeftTurnDirection",((i={})[O.WEST]=O.SOUTH,i[O.NORTH]=O.WEST,i[O.EAST]=O.NORTH,i[O.SOUTH]=O.EAST,i));T("INVALID_TILE_ID",65535);e._RF.pop()}}}));

System.register("chunks:///_virtual/WalletSigner.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(t){var e,n,r;return{setters:[function(t){e=t.asyncToGenerator,n=t.regeneratorRuntime},function(t){r=t.cclegacy}],execute:function(){r._RF.push({},"70cf3CNvpFLuLgKiliUQeyO","WalletSigner",void 0);t("WalletSigner",function(){function t(t,e,n){this.wallet=t,this.account=e,this.network=n}var r=t.prototype;return r.getAddress=function(){return this.account.address},r.signAndExecuteTransaction=function(){var t=e(n().mark((function t(e,r){var a,s;return n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[WalletSigner] Signing transaction with wallet:",this.wallet.name),(a=this.wallet.features["sui:signAndExecuteTransaction"])&&"function"==typeof a.signAndExecuteTransaction){t.next=4;break}throw new Error("Wallet "+this.wallet.name+" does not support sui:signAndExecuteTransaction");case 4:return t.prev=4,t.next=7,a.signAndExecuteTransaction({transaction:e,account:this.account,chain:"sui:"+this.network,options:{showEffects:!0,showEvents:!0,showObjectChanges:!0}});case 7:return s=t.sent,console.log("[WalletSigner] Transaction executed:",s.digest),t.abrupt("return",s);case 12:throw t.prev=12,t.t0=t.catch(4),console.error("[WalletSigner] Transaction failed:",t.t0),t.t0;case 16:case"end":return t.stop()}}),t,this,[[4,12]])})));return function(e,n){return t.apply(this,arguments)}}(),r.getType=function(){return"wallet"},r.getWalletName=function(){return this.wallet.name},t}());r._RF.pop()}}}));

System.register("chunks:///_virtual/Web3BlockTypes.ts",["cc"],(function(e){var t;return{setters:[function(e){t=e.cclegacy}],execute:function(){e({getAllWeb3BlockIds:function(){return c.map((function(e){return e.id}))},getBuildingSize:function(e){var t=d(e);return(null==t?void 0:t.size)||1},getWeb3BlockByBlockId:d,getWeb3BlockById:function(e){return c.find((function(t){return t.id===e}))},getWeb3BlockByTypeId:function(e){return c.find((function(t){return t.typeId===e}))},getWeb3BuildingBlocks:function(){return c.filter((function(e){return"building"===e.category}))},getWeb3DecorationBlocks:function(){return c.filter((function(e){return"decoration"===e.category}))},getWeb3ObjectBlocks:function(){return c.filter((function(e){return"object"===e.category}))},getWeb3TileBlocks:function(){return c.filter((function(e){return"tile"===e.category}))},isWeb3Building:function(e){if("string"==typeof e){var t=d(e);return!!t&&"building"===t.category}return e>=200&&e<=255},isWeb3Object:function(e){if("string"==typeof e){var t=d(e);return!!t&&"object"===t.category}return e>=100&&e<=199},isWeb3Tile:function(e){if("string"==typeof e){var t=d(e);return!!t&&"tile"===t.category}return e>=0&&e<=99}}),t._RF.push({},"c8534SdraVOBr96YzoI17fK","Web3BlockTypes",void 0);var i=e("Web3TileType",function(e){return e[e.EMPTY_LAND=0]="EMPTY_LAND",e[e.LOTTERY=1]="LOTTERY",e[e.HOSPITAL=2]="HOSPITAL",e[e.CHANCE=3]="CHANCE",e[e.BONUS=4]="BONUS",e[e.FEE=5]="FEE",e[e.CARD=6]="CARD",e[e.NEWS=7]="NEWS",e}({})),n=e("Web3ObjectType",function(e){return e[e.LAND_GOD=100]="LAND_GOD",e[e.WEALTH_GOD=101]="WEALTH_GOD",e[e.FORTUNE_GOD=102]="FORTUNE_GOD",e[e.DOG=103]="DOG",e[e.POVERTY_GOD=104]="POVERTY_GOD",e[e.ROADBLOCK=105]="ROADBLOCK",e[e.BOMB=106]="BOMB",e}({})),o=e("Web3BuildingType",function(e){return e[e.BUILDING_1X1=200]="BUILDING_1X1",e[e.BUILDING_2X2=201]="BUILDING_2X2",e}({})),r=(e("BuildingFunctionType",function(e){return e[e.TEMPLE=301]="TEMPLE",e[e.RESEARCH=302]="RESEARCH",e[e.OIL_COMPANY=303]="OIL_COMPANY",e[e.COMMERCIAL=304]="COMMERCIAL",e[e.HOTEL=305]="HOTEL",e}({})),e("Web3DecorationType",function(e){return e[e.DANDELION=300]="DANDELION",e[e.POPPY=301]="POPPY",e[e.SHORT_GRASS=302]="SHORT_GRASS",e[e.FERN=303]="FERN",e[e.GLOW_LICHEN=304]="GLOW_LICHEN",e[e.GLOW_BERRIES=305]="GLOW_BERRIES",e}({}))),c=e("WEB3_BLOCKS",[{id:"web3:empty_land",name:"空地",category:"tile",typeId:i.EMPTY_LAND,description:"空地块，无法购买"},{id:"web3:lottery",name:"乐透",category:"tile",typeId:i.LOTTERY,description:"乐透格子，触发抽奖"},{id:"web3:hospital",name:"医院",category:"tile",typeId:i.HOSPITAL,description:"停留N回合"},{id:"web3:chance",name:"机会",category:"tile",typeId:i.CHANCE,description:"触发随机事件"},{id:"web3:bonus",name:"奖励",category:"tile",typeId:i.BONUS,description:"获得金钱奖励"},{id:"web3:fee",name:"费用",category:"tile",typeId:i.FEE,description:"支付费用"},{id:"web3:card",name:"卡片",category:"tile",typeId:i.CARD,description:"获得随机卡片"},{id:"web3:news",name:"新闻",category:"tile",typeId:i.NEWS,description:"触发全局新闻事件"},{id:"web3:land_god",name:"土地神",category:"object",typeId:n.LAND_GOD,description:"增益型NPC"},{id:"web3:wealth_god",name:"财神",category:"object",typeId:n.WEALTH_GOD,description:"增益型NPC"},{id:"web3:fortune_god",name:"福神",category:"object",typeId:n.FORTUNE_GOD,description:"增益型NPC"},{id:"web3:dog",name:"狗狗",category:"object",typeId:n.DOG,description:"干扰型NPC"},{id:"web3:poverty_god",name:"穷神",category:"object",typeId:n.POVERTY_GOD,description:"干扰型NPC"},{id:"web3:roadblock",name:"路障",category:"object",typeId:n.ROADBLOCK,description:"阻挡移动的路面物体"},{id:"web3:bomb",name:"炸弹",category:"object",typeId:n.BOMB,description:"爆炸伤害的路面物体"},{id:"web3:building_1x1",name:"小型建筑",category:"building",typeId:o.BUILDING_1X1,description:"1x1的基础建筑（lv0）",size:1},{id:"web3:building_2x2",name:"大型建筑",category:"building",typeId:o.BUILDING_2X2,description:"2x2的基础建筑（lv0）",size:2},{id:"web3:deco_dandelion",name:"蒲公英",category:"decoration",typeId:r.DANDELION,description:"装饰用的蒲公英"},{id:"web3:deco_poppy",name:"虞美人",category:"decoration",typeId:r.POPPY,description:"装饰用的虞美人花"},{id:"web3:deco_short_grass",name:"矮草",category:"decoration",typeId:r.SHORT_GRASS,description:"装饰用的矮草"},{id:"web3:deco_fern",name:"蕨类",category:"decoration",typeId:r.FERN,description:"装饰用的蕨类植物"},{id:"web3:deco_glow_lichen",name:"荧光地衣",category:"decoration",typeId:r.GLOW_LICHEN,description:"装饰用的发光地衣"},{id:"web3:deco_glow_berries",name:"发光浆果",category:"decoration",typeId:r.GLOW_BERRIES,description:"装饰用的发光浆果"}]);function d(e){return c.find((function(t){return t.id===e}))}t._RF.pop()}}}));

(function(r) {
  r('virtual:///prerequisite-imports/main', 'chunks:///_virtual/main'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});