# 体素交互系统移植文档

## 概述

基于对Craft项目的深入研究，我们成功将其核心交互机制移植到Cocos Creator中。本系统完全避免了为每个方块创建物理碰撞器的传统做法，采用数学射线投射和直接哈希查找实现高性能体素交互。

## 核心架构

### 1. 系统组件

```typescript
VoxelInteractionManager          // 交互管理器（总控）
├── VoxelRayCaster              // 射线投射系统
├── VoxelCameraController       // 摄像机控制器  
├── VoxelCollisionSystem        // 碰撞检测系统
└── VoxelWorldManager          // 体素世界管理
```

### 2. 文件结构

```
assets/scripts/voxel/
├── interaction/
│   ├── VoxelInteractionManager.ts    // 交互管理器
│   ├── VoxelRayCaster.ts             // 射线投射
│   ├── VoxelCameraController.ts      // 摄像机控制
│   └── VoxelCollisionSystem.ts       // 碰撞检测
├── examples/
│   └── VoxelInteractionExample.ts    // 完整使用示例
└── render/
    └── VoxelRenderer.ts              // 已集成交互系统
```

## 核心技术方案

### 1. 射线投射系统 (VoxelRayCaster)

**核心创新**: 不使用物理碰撞器，采用数学算法

```typescript
// 关键实现
raycast(origin: Vec3, direction: Vec3, maxDistance: number): VoxelHitResult {
    const steps = Math.floor(maxDistance * 32); // 32步/单位精度
    const stepSize = maxDistance / steps;
    
    for (let i = 0; i < steps; i++) {
        const currentPos = origin + direction * (i * stepSize);
        const blockPos = this.worldToBlockPosition(currentPos);
        const blockType = getBlockAt(blockPos.x, blockPos.y, blockPos.z);
        
        if (blockType !== EMPTY) {
            return { hit: true, position: blockPos, ... };
        }
    }
    return { hit: false };
}
```

**优势**:
- 无需创建数千个碰撞器组件
- O(1)哈希查找，支持无限大世界
- 精确的面向和法线计算

### 2. 摄像机控制系统 (VoxelCameraController)

**完全复刻Craft的移动机制**:

```typescript
// Craft原版速度配置
walkSpeed: number = 5.0;    // 步行 5 units/s
flySpeed: number = 20.0;    // 飞行 20 units/s
```

**功能特性**:
- WASD键移动控制
- 鼠标视角旋转（支持俯仰角限制）
- F键切换步行/飞行模式
- 分轴碰撞处理（可沿墙壁滑动）
- Space/Shift控制飞行模式的上下移动

### 3. 碰撞检测系统 (VoxelCollisionSystem)

**数学AABB碰撞**，无物理引擎依赖:

```typescript
// 玩家包围盒配置
playerPadding: number = 0.25;    // 与Craft保持一致
playerHeight: number = 1.8;
playerRadius: number = 0.3;

// 多点检测确保精确碰撞
private getCollisionCheckPositions(playerPos: Vec3): Vec3[] {
    // 检查玩家周围8个方向 × 5个高度层 = 40个检测点
    // 确保从脚部到头部的完整碰撞检测
}
```

## 使用方法

### 1. 基础设置

在场景中设置以下组件层次：

```
VoxelWorld (Node)
├── VoxelRenderer (Component)
├── VoxelInteractionManager (Component)
├── VoxelCameraController (Component)
└── VoxelCollisionSystem (Component)
```

### 2. 代码集成

```typescript
// 在你的游戏脚本中
@property(VoxelRenderer)
voxelRenderer: VoxelRenderer = null;

protected onLoad() {
    // VoxelRenderer会自动初始化所有交互系统
    const spawnPos = this.voxelRenderer.findSpawnLocation();
    this.camera.node.setWorldPosition(spawnPos);
    
    // 设置事件回调
    const events = {
        onBlockClick: (hit) => console.log('点击方块:', hit),
        onBlockPlace: (pos, type) => console.log('放置方块:', pos, type),
        onBlockBreak: (pos) => console.log('破坏方块:', pos)
    };
    this.voxelRenderer.setInteractionEventCallbacks(events);
}
```

### 3. 键位控制

**移动控制**:
- `WASD`: 移动（步行模式时仅水平移动，飞行模式支持全方向）
- `F`: 切换步行/飞行模式
- `Space/Shift`: 飞行模式下的上升/下降

**方块操作**:
- `鼠标左键`: 破坏方块
- `鼠标右键`: 放置方块
- `1-6`: 切换选中的方块类型

**调试功能**:
- `R`: 切换渲染模式（合并/独立）
- `T`: 切换世界模式
- `G`: 重新生成世界
- `I`: 打印调试信息

### 4. API调用示例

```typescript
// 获取交互管理器
const interaction = this.voxelRenderer.getInteractionManager();

// 手动射线投射
const hitResult = this.voxelRenderer.performRaycast();
if (hitResult.hit) {
    console.log('击中位置:', hitResult.position);
}

// 程序化放置/破坏方块
this.voxelRenderer.placeBlock(new Vec3(10, 5, 10), VoxelBlockType.STONE);
this.voxelRenderer.breakBlock(new Vec3(10, 5, 10));

// 切换摄像机模式
this.voxelRenderer.toggleCameraMode();
```

## 性能特性

### 1. 内存效率

**传统方案 vs 我们的方案**:

```
传统方案: 100万方块 × BoxCollider = 100万组件 (巨大内存开销)
我们方案: 100万方块存储在 Map<string, BlockType> (O(1)查找)
```

### 2. 计算性能

- **射线投射**: 每次查询仅需 32×距离 次哈希查找
- **碰撞检测**: 每帧检查40个点位的哈希查找
- **无物理引擎**: 避免了物理世界的更新开销

### 3. 可扩展性

- 支持无限大世界（仅限制于JavaScript的Map容量）
- Chunk级别的按需加载卸载
- 稀疏存储（只存储非空方块）

## Craft移植对比

### 原版特性完整保留

| 功能 | Craft原版 | Cocos移植版 | 状态 |
|------|----------|-------------|------|
| 射线投射 | 数学算法 | 数学算法 | ✅ 完全一致 |
| 移动速度 | 5/20 units/s | 5/20 units/s | ✅ 完全一致 |
| 碰撞检测 | AABB数学 | AABB数学 | ✅ 完全一致 |
| 玩家包围盒 | 0.25 padding | 0.25 padding | ✅ 完全一致 |
| 飞行模式 | F键切换 | F键切换 | ✅ 完全一致 |
| 方块交互 | 左右键 | 左右键 | ✅ 完全一致 |

### Cocos增强特性

- **双渲染模式**: 支持Chunk合并渲染和独立Block渲染
- **多世界模式**: 标准/小平坦/微调试三种规模
- **完整事件系统**: onBlockClick, onBlockPlace, onBlockBreak等
- **调试工具**: 丰富的运行时调试信息
- **程序化API**: 支持脚本控制的方块操作

## 完整示例

参考 `VoxelInteractionExample.ts` 获取完整的使用示例，包括：

- 完整的键位控制实现
- 事件回调处理
- 程序化方块操作
- 世界模式切换
- 调试信息打印
- 建筑结构自动生成

## 技术亮点

1. **零碰撞器设计**: 完全避免了Unity/Cocos传统的Collider组件开销
2. **数学精度**: 32步/单位的采样精度，确保准确的方块击中检测
3. **内存友好**: 稀疏哈希存储，内存占用与实际方块数量成正比
4. **性能优异**: 支持百万级方块世界的流畅交互
5. **完美移植**: 保持了Craft原版的所有核心交互特性

这套系统为Cocos Creator带来了专业级的体素游戏开发能力，可以作为任何体素类游戏的基础架构使用。